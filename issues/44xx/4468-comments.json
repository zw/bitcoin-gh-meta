[
   {
      "body" : "While syncing with this code from a pair of local peers:\r\n\r\n2014-07-06 04:26:28 UpdateTip: new best=000000001ee1d3053357a374d6d9746e80d56a666f3827c92e80e0d1b3f2f2a1  height=1888  log2_work=42.883429  tx=1917  date=2009-01-26 03:\r\n21:12 progress=0.000023\r\n2014-07-06 04:26:28   nActualTimespan = 942027  before bounds\r\n2014-07-06 04:26:28 GetNextWorkRequired RETARGET\r\n2014-07-06 04:26:28 Params().TargetTimespan() = 1209600    nActualTimespan = 942027\r\n2014-07-06 04:26:28 Before: 1a016164  0000000000000161640000000000000000000000000000000000000000000000\r\n2014-07-06 04:26:28 After:  1a011337  000000000000011337c4f5c28f5c28f5c28f5c28f5c28f5c28f5c28f5c28f5c2\r\n2014-07-06 04:26:28 ERROR: AcceptBlock() : prev block not found\r\n2014-07-06 04:26:28 ERROR: ProcessBlock() : AcceptBlock FAILED\r\n2014-07-06 04:26:28 Misbehaving: 192.168.42.76 (0 -> 10)\r\n2014-07-06 04:26:28 UpdateTip: new best=00000000bf3fc4c4ab6737df907f613b5aa86373d426b5e86a1009030852f129  height=1889  log2_work=42.884193  tx=1918  date=2009-01-26 03:26:22 progress=0.000023\r\n\r\n\r\n(not the Misbehaving)\r\n\r\nAlso, it seems to only be pulling from one so far:\r\n\r\n    {\r\n        \"addr\" : \"192.168.42.76\",\r\n        \"services\" : \"0000000000000001\",\r\n        \"lastsend\" : 1404621016,\r\n        \"lastrecv\" : 1404621016,\r\n        \"bytessent\" : 7131512,\r\n        \"bytesrecv\" : 131870355,\r\n        \"conntime\" : 1404620769,\r\n        \"pingtime\" : 0.07961100,\r\n        \"version\" : 70002,\r\n        \"subver\" : \"/Satoshi:0.9.99/\",\r\n        \"inbound\" : false,\r\n        \"startingheight\" : 309423,\r\n        \"banscore\" : 10,\r\n        \"syncheight\" : 309424,\r\n        \"commonheight\" : 113772,\r\n        \"inflight\" : [\r\n            113773,\r\n            113774,\r\n            113775,\r\n            113776,\r\n            113777,\r\n            113778,\r\n            113779,\r\n            113780,\r\n            113781,\r\n            113782,\r\n            113783,\r\n            113784,\r\n            113785,\r\n            113786,\r\n            113787,\r\n            113788\r\n        ]\r\n    },\r\n    {\r\n        \"addr\" : \"192.168.42.87\",\r\n        \"services\" : \"0000000000000001\",\r\n        \"lastsend\" : 1404621015,\r\n        \"lastrecv\" : 1404621009,\r\n        \"bytessent\" : 1442,\r\n        \"bytesrecv\" : 2342,\r\n        \"conntime\" : 1404620769,\r\n        \"pingtime\" : 0.04079200,\r\n        \"version\" : 70002,\r\n        \"subver\" : \"/Satoshi:0.9.99/\",\r\n        \"inbound\" : false,\r\n        \"startingheight\" : 309423,\r\n        \"banscore\" : 0,\r\n        \"syncheight\" : -1,\r\n        \"commonheight\" : -1,\r\n        \"inflight\" : [\r\n        ]\r\n    }\r\n\r\nIt started pulling from it eventually, perhaps when a block came in?",
      "created_at" : "2014-07-06T04:34:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-48102820",
      "id" : 48102820,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-07-06T04:36:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48102820",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "2014-07-06 04:38:07 Leaving block file 0: CBlockFileInfo(blocks=119950, size=134216038, heights=0...309426, time=2009-01-03...2014-07-06)\r\n2014-07-06 04:38:37 Leaving block file 1: CBlockFileInfo(blocks=11284, size=134206314, heights=119942...131232, time=2011-04-24...2011-06-16)\r\n\r\nThe first range looks wrong. :)",
      "created_at" : "2014-07-06T05:13:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-48103260",
      "id" : 48103260,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-07-06T05:13:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48103260",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "@gmaxwell The 'prev block not found' should be fixed; there is a code path to fetch blocks directly (ignoring the headers-based fetching), in case we're very close to being synced (to avoid an extra roundtrip for newly inv'ed blocks)... but the time comparison used < instead of >.",
      "created_at" : "2014-07-06T07:46:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-48105340",
      "id" : 48105340,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-07-06T07:46:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48105340",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "3hr 46 minute resync over the network here.  I'm a bit confused that the ping time to the two peers I was pulling from was still >10 seconds even when the sync was well into the cpu bound part (for their own part, the peers were fairly low on cpu utilization).",
      "created_at" : "2014-07-06T13:45:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-48112187",
      "id" : 48112187,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-07-06T13:45:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48112187",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "4h21m here, from random peers, and default dbcache.",
      "created_at" : "2014-07-06T15:57:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-48115402",
      "id" : 48115402,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-07-06T15:57:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48115402",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Woohoo!\r\nTesting...\r\n",
      "created_at" : "2014-07-07T05:04:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-48141243",
      "id" : 48141243,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-07-07T05:04:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48141243",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r14581874"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/14581874"
         }
      },
      "body" : "Why wait until a complete block is received before marking it as not stalling? Wouldn't it be better to consider it as not stalling as long as a block is being downloaded (even if it takes a while on a slow connection)?",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-07-07T05:30:12Z",
      "diff_hunk" : "@@ -266,63 +265,36 @@ void FinalizeNode(NodeId nodeid) {\n     LOCK(cs_main);\n     CNodeState *state = State(nodeid);\n \n+    if (state->fSyncStarted)\n+        nSyncStarted--;\n+\n     BOOST_FOREACH(const QueuedBlock& entry, state->vBlocksInFlight)\n         mapBlocksInFlight.erase(entry.hash);\n-    BOOST_FOREACH(const uint256& hash, state->vBlocksToDownload)\n-        mapBlocksToDownload.erase(hash);\n \n     mapNodeState.erase(nodeid);\n }\n \n // Requires cs_main.\n-void MarkBlockAsReceived(const uint256 &hash, NodeId nodeFrom = -1) {\n-    map<uint256, pair<NodeId, list<uint256>::iterator> >::iterator itToDownload = mapBlocksToDownload.find(hash);\n-    if (itToDownload != mapBlocksToDownload.end()) {\n-        CNodeState *state = State(itToDownload->second.first);\n-        state->vBlocksToDownload.erase(itToDownload->second.second);\n-        state->nBlocksToDownload--;\n-        mapBlocksToDownload.erase(itToDownload);\n-    }\n-\n+void MarkBlockAsReceived(const uint256& hash) {\n     map<uint256, pair<NodeId, list<QueuedBlock>::iterator> >::iterator itInFlight = mapBlocksInFlight.find(hash);\n     if (itInFlight != mapBlocksInFlight.end()) {\n         CNodeState *state = State(itInFlight->second.first);\n         state->vBlocksInFlight.erase(itInFlight->second.second);\n         state->nBlocksInFlight--;\n-        if (itInFlight->second.first == nodeFrom)\n-            state->nLastBlockReceive = GetTimeMicros();\n+        state->nStallingSince = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r14581874",
      "id" : 14581874,
      "original_commit_id" : "eb7822c91bc71b1e4f0e6e1b04de76c8eabd65ab",
      "original_position" : 106,
      "path" : "src/main.cpp",
      "position" : 121,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/14581874",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r14581901"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/14581901"
         }
      },
      "body" : "Are you trying to break #4431 ?!",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-07-07T05:32:39Z",
      "diff_hunk" : "@@ -266,63 +265,36 @@ void FinalizeNode(NodeId nodeid) {\n     LOCK(cs_main);\n     CNodeState *state = State(nodeid);\n \n+    if (state->fSyncStarted)\n+        nSyncStarted--;\n+\n     BOOST_FOREACH(const QueuedBlock& entry, state->vBlocksInFlight)\n         mapBlocksInFlight.erase(entry.hash);\n-    BOOST_FOREACH(const uint256& hash, state->vBlocksToDownload)\n-        mapBlocksToDownload.erase(hash);\n \n     mapNodeState.erase(nodeid);\n }\n \n // Requires cs_main.\n-void MarkBlockAsReceived(const uint256 &hash, NodeId nodeFrom = -1) {\n-    map<uint256, pair<NodeId, list<uint256>::iterator> >::iterator itToDownload = mapBlocksToDownload.find(hash);\n-    if (itToDownload != mapBlocksToDownload.end()) {\n-        CNodeState *state = State(itToDownload->second.first);\n-        state->vBlocksToDownload.erase(itToDownload->second.second);\n-        state->nBlocksToDownload--;\n-        mapBlocksToDownload.erase(itToDownload);\n-    }\n-\n+void MarkBlockAsReceived(const uint256& hash) {\n     map<uint256, pair<NodeId, list<QueuedBlock>::iterator> >::iterator itInFlight = mapBlocksInFlight.find(hash);\n     if (itInFlight != mapBlocksInFlight.end()) {\n         CNodeState *state = State(itInFlight->second.first);\n         state->vBlocksInFlight.erase(itInFlight->second.second);\n         state->nBlocksInFlight--;\n-        if (itInFlight->second.first == nodeFrom)\n-            state->nLastBlockReceive = GetTimeMicros();\n+        state->nStallingSince = 0;\n         mapBlocksInFlight.erase(itInFlight);\n     }\n }\n \n // Requires cs_main.\n-bool AddBlockToQueue(NodeId nodeid, const uint256 &hash) {\n-    if (mapBlocksToDownload.count(hash) || mapBlocksInFlight.count(hash))\n-        return false;\n-\n-    CNodeState *state = State(nodeid);\n-    if (state == NULL)\n-        return false;\n-\n-    list<uint256>::iterator it = state->vBlocksToDownload.insert(state->vBlocksToDownload.end(), hash);\n-    state->nBlocksToDownload++;\n-    if (state->nBlocksToDownload > 5000)\n-        Misbehaving(nodeid, 10);\n-    mapBlocksToDownload[hash] = std::make_pair(nodeid, it);\n-    return true;\n-}\n-\n-// Requires cs_main.\n-void MarkBlockAsInFlight(NodeId nodeid, const uint256 &hash) {\n+void MarkBlockAsInFlight(NodeId nodeid, const uint256& hash, CBlockIndex *pindex = NULL) {\n     CNodeState *state = State(nodeid);\n     assert(state != NULL);\n \n     // Make sure it's not listed somewhere already.\n     MarkBlockAsReceived(hash);\n \n-    QueuedBlock newentry = {hash, GetTimeMicros(), state->nBlocksInFlight};\n-    if (state->nBlocksInFlight == 0)\n-        state->nLastBlockReceive = newentry.nTime; // Reset when a first request is sent.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r14581901",
      "id" : 14581901,
      "original_commit_id" : "eb7822c91bc71b1e4f0e6e1b04de76c8eabd65ab",
      "original_position" : 139,
      "path" : "src/main.cpp",
      "position" : 154,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/14581901",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r14582040"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/14582040"
         }
      },
      "body" : "If duplicate blocks aren't requested, then surely if we receive them this should be considered misbehaviour.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-07-07T05:44:57Z",
      "diff_hunk" : "@@ -2624,93 +2672,25 @@ void CBlockIndex::BuildSkip()\n         pskip = pprev->GetAncestor(GetSkipHeight(nHeight));\n }\n \n-void PushGetBlocks(CNode* pnode, CBlockIndex* pindexBegin, uint256 hashEnd)\n-{\n-    AssertLockHeld(cs_main);\n-    // Filter out duplicate requests\n-    if (pindexBegin == pnode->pindexLastGetBlocksBegin && hashEnd == pnode->hashLastGetBlocksEnd)\n-        return;\n-    pnode->pindexLastGetBlocksBegin = pindexBegin;\n-    pnode->hashLastGetBlocksEnd = hashEnd;\n-\n-    pnode->PushMessage(\"getblocks\", chainActive.GetLocator(pindexBegin), hashEnd);\n-}\n-\n bool ProcessBlock(CValidationState &state, CNode* pfrom, CBlock* pblock, CDiskBlockPos *dbp)\n {\n-    // Check for duplicate",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r14582040",
      "id" : 14582040,
      "original_commit_id" : "eb7822c91bc71b1e4f0e6e1b04de76c8eabd65ab",
      "original_position" : 499,
      "path" : "src/main.cpp",
      "position" : 668,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/14582040",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r14582219"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/14582219"
         }
      },
      "body" : "Sipa [already mentioned](https://github.com/bitcoin/bitcoin/pull/4431#issuecomment-48091674) that headers first would render #4431 almost obselete \r\n",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-07-07T06:00:02Z",
      "diff_hunk" : "@@ -266,63 +265,36 @@ void FinalizeNode(NodeId nodeid) {\n     LOCK(cs_main);\n     CNodeState *state = State(nodeid);\n \n+    if (state->fSyncStarted)\n+        nSyncStarted--;\n+\n     BOOST_FOREACH(const QueuedBlock& entry, state->vBlocksInFlight)\n         mapBlocksInFlight.erase(entry.hash);\n-    BOOST_FOREACH(const uint256& hash, state->vBlocksToDownload)\n-        mapBlocksToDownload.erase(hash);\n \n     mapNodeState.erase(nodeid);\n }\n \n // Requires cs_main.\n-void MarkBlockAsReceived(const uint256 &hash, NodeId nodeFrom = -1) {\n-    map<uint256, pair<NodeId, list<uint256>::iterator> >::iterator itToDownload = mapBlocksToDownload.find(hash);\n-    if (itToDownload != mapBlocksToDownload.end()) {\n-        CNodeState *state = State(itToDownload->second.first);\n-        state->vBlocksToDownload.erase(itToDownload->second.second);\n-        state->nBlocksToDownload--;\n-        mapBlocksToDownload.erase(itToDownload);\n-    }\n-\n+void MarkBlockAsReceived(const uint256& hash) {\n     map<uint256, pair<NodeId, list<QueuedBlock>::iterator> >::iterator itInFlight = mapBlocksInFlight.find(hash);\n     if (itInFlight != mapBlocksInFlight.end()) {\n         CNodeState *state = State(itInFlight->second.first);\n         state->vBlocksInFlight.erase(itInFlight->second.second);\n         state->nBlocksInFlight--;\n-        if (itInFlight->second.first == nodeFrom)\n-            state->nLastBlockReceive = GetTimeMicros();\n+        state->nStallingSince = 0;\n         mapBlocksInFlight.erase(itInFlight);\n     }\n }\n \n // Requires cs_main.\n-bool AddBlockToQueue(NodeId nodeid, const uint256 &hash) {\n-    if (mapBlocksToDownload.count(hash) || mapBlocksInFlight.count(hash))\n-        return false;\n-\n-    CNodeState *state = State(nodeid);\n-    if (state == NULL)\n-        return false;\n-\n-    list<uint256>::iterator it = state->vBlocksToDownload.insert(state->vBlocksToDownload.end(), hash);\n-    state->nBlocksToDownload++;\n-    if (state->nBlocksToDownload > 5000)\n-        Misbehaving(nodeid, 10);\n-    mapBlocksToDownload[hash] = std::make_pair(nodeid, it);\n-    return true;\n-}\n-\n-// Requires cs_main.\n-void MarkBlockAsInFlight(NodeId nodeid, const uint256 &hash) {\n+void MarkBlockAsInFlight(NodeId nodeid, const uint256& hash, CBlockIndex *pindex = NULL) {\n     CNodeState *state = State(nodeid);\n     assert(state != NULL);\n \n     // Make sure it's not listed somewhere already.\n     MarkBlockAsReceived(hash);\n \n-    QueuedBlock newentry = {hash, GetTimeMicros(), state->nBlocksInFlight};\n-    if (state->nBlocksInFlight == 0)\n-        state->nLastBlockReceive = newentry.nTime; // Reset when a first request is sent.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r14582219",
      "id" : 14582219,
      "original_commit_id" : "eb7822c91bc71b1e4f0e6e1b04de76c8eabd65ab",
      "original_position" : 139,
      "path" : "src/main.cpp",
      "position" : 154,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/14582219",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=3",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "body" : "Synced in 3:43 here, and with lots of other things running on the same computer.\r\n\r\nI do get this error when running with `-checkblocks=0 -checklevel=4` afterwards (after shutting down with 'stop'):\r\n```\r\n2014-07-07 10:48:02 Verifying last 309612 blocks at level 4\r\n2014-07-07 10:48:03 ERROR: ReadFromDisk : Deserialize or I/O error - CAutoFile::read : end of file\r\n2014-07-07 10:48:03 ERROR: VerifyDB() : *** found bad undo data at 309606, hash=000000000000000013e7146f5a1f63a188935bedc491b8b5bf5ab823f6ec0d9c\r\n```\r\nOh I get the same without any checklevel options. I'll keep this copy of the blocks data and database in case it's interesting for debuging.\r\n",
      "created_at" : "2014-07-07T10:55:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-48164861",
      "id" : 48164861,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-07-07T10:56:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48164861",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r14591774"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/14591774"
         }
      },
      "body" : "yes he did, but it's somewhat annoying when so newly introduced variables are removed by the same author in subsequent pulls. ",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-07-07T11:47:36Z",
      "diff_hunk" : "@@ -266,63 +265,36 @@ void FinalizeNode(NodeId nodeid) {\n     LOCK(cs_main);\n     CNodeState *state = State(nodeid);\n \n+    if (state->fSyncStarted)\n+        nSyncStarted--;\n+\n     BOOST_FOREACH(const QueuedBlock& entry, state->vBlocksInFlight)\n         mapBlocksInFlight.erase(entry.hash);\n-    BOOST_FOREACH(const uint256& hash, state->vBlocksToDownload)\n-        mapBlocksToDownload.erase(hash);\n \n     mapNodeState.erase(nodeid);\n }\n \n // Requires cs_main.\n-void MarkBlockAsReceived(const uint256 &hash, NodeId nodeFrom = -1) {\n-    map<uint256, pair<NodeId, list<uint256>::iterator> >::iterator itToDownload = mapBlocksToDownload.find(hash);\n-    if (itToDownload != mapBlocksToDownload.end()) {\n-        CNodeState *state = State(itToDownload->second.first);\n-        state->vBlocksToDownload.erase(itToDownload->second.second);\n-        state->nBlocksToDownload--;\n-        mapBlocksToDownload.erase(itToDownload);\n-    }\n-\n+void MarkBlockAsReceived(const uint256& hash) {\n     map<uint256, pair<NodeId, list<QueuedBlock>::iterator> >::iterator itInFlight = mapBlocksInFlight.find(hash);\n     if (itInFlight != mapBlocksInFlight.end()) {\n         CNodeState *state = State(itInFlight->second.first);\n         state->vBlocksInFlight.erase(itInFlight->second.second);\n         state->nBlocksInFlight--;\n-        if (itInFlight->second.first == nodeFrom)\n-            state->nLastBlockReceive = GetTimeMicros();\n+        state->nStallingSince = 0;\n         mapBlocksInFlight.erase(itInFlight);\n     }\n }\n \n // Requires cs_main.\n-bool AddBlockToQueue(NodeId nodeid, const uint256 &hash) {\n-    if (mapBlocksToDownload.count(hash) || mapBlocksInFlight.count(hash))\n-        return false;\n-\n-    CNodeState *state = State(nodeid);\n-    if (state == NULL)\n-        return false;\n-\n-    list<uint256>::iterator it = state->vBlocksToDownload.insert(state->vBlocksToDownload.end(), hash);\n-    state->nBlocksToDownload++;\n-    if (state->nBlocksToDownload > 5000)\n-        Misbehaving(nodeid, 10);\n-    mapBlocksToDownload[hash] = std::make_pair(nodeid, it);\n-    return true;\n-}\n-\n-// Requires cs_main.\n-void MarkBlockAsInFlight(NodeId nodeid, const uint256 &hash) {\n+void MarkBlockAsInFlight(NodeId nodeid, const uint256& hash, CBlockIndex *pindex = NULL) {\n     CNodeState *state = State(nodeid);\n     assert(state != NULL);\n \n     // Make sure it's not listed somewhere already.\n     MarkBlockAsReceived(hash);\n \n-    QueuedBlock newentry = {hash, GetTimeMicros(), state->nBlocksInFlight};\n-    if (state->nBlocksInFlight == 0)\n-        state->nLastBlockReceive = newentry.nTime; // Reset when a first request is sent.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r14591774",
      "id" : 14591774,
      "original_commit_id" : "eb7822c91bc71b1e4f0e6e1b04de76c8eabd65ab",
      "original_position" : 139,
      "path" : "src/main.cpp",
      "position" : 154,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/14591774",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r14592784"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/14592784"
         }
      },
      "body" : "We already download every block that peers advertize. In PR changes it to\nfirst ask for headers, and only asks for the block immediately if we're\nclose to being synced. Validating the header first would require an extra\nroundtrip, which can hurt network propagation time.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-07-07T12:22:45Z",
      "diff_hunk" : "@@ -3760,23 +3750,34 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv)\n             bool fAlreadyHave = AlreadyHave(inv);\n             LogPrint(\"net\", \"got inv: %s  %s peer=%d\\n\", inv.ToString(), fAlreadyHave ? \"have\" : \"new\", pfrom->id);\n \n-            if (!fAlreadyHave) {\n-                if (!fImporting && !fReindex) {\n-                    if (inv.type == MSG_BLOCK)\n-                        AddBlockToQueue(pfrom->GetId(), inv.hash);\n-                    else\n-                        pfrom->AskFor(inv);\n-                }\n-            } else if (inv.type == MSG_BLOCK && mapOrphanBlocks.count(inv.hash)) {\n-                PushGetBlocks(pfrom, chainActive.Tip(), GetOrphanRoot(inv.hash));\n-            }\n+            if (!fAlreadyHave && !fImporting && !fReindex && inv.type != MSG_BLOCK)\n+                pfrom->AskFor(inv);\n \n-            if (inv.type == MSG_BLOCK)\n+            if (inv.type == MSG_BLOCK) {\n                 UpdateBlockAvailability(pfrom->GetId(), inv.hash);\n+                if (!fAlreadyHave && !fImporting && !fReindex) {\n+                    // First request the headers preceeding the announced block. In the normal fully-synced\n+                    // case where a new block is announced that succeeds the current tip (no reorganization),\n+                    // there are no such headers.\n+                    // Secondly, and only when we are close to being synced, we request the announced block afterwards,\n+                    // to avoid an extra round-trip. Note that we must *first* ask for the headers, so by the\n+                    // time the block arrives, the header chain leading up to it is already validated. Not\n+                    // doing this will result in the received block being rejected as an orphan.\n+                    pfrom->PushMessage(\"getheaders\", chainActive.GetLocator(pindexBestHeader), inv.hash);\n+                    if (Params().NetworkID() == CBaseChainParams::REGTEST ||\n+                        chainActive.Tip()->GetBlockTime() > GetAdjustedTime() - Params().TargetSpacing() * 20) {\n+                        vToFetch.push_back(inv);\n+                        MarkBlockAsInFlight(pfrom->GetId(), inv.hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r14592784",
      "id" : 14592784,
      "original_commit_id" : "eb7822c91bc71b1e4f0e6e1b04de76c8eabd65ab",
      "original_position" : 677,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/14592784",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r14592852"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/14592852"
         }
      },
      "body" : "We do, for initial sync (see SendMessages). This code is for dealing with\nnewly announced blocks so they can propagate.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-07-07T12:24:54Z",
      "diff_hunk" : "@@ -3760,23 +3750,34 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv)\n             bool fAlreadyHave = AlreadyHave(inv);\n             LogPrint(\"net\", \"got inv: %s  %s peer=%d\\n\", inv.ToString(), fAlreadyHave ? \"have\" : \"new\", pfrom->id);\n \n-            if (!fAlreadyHave) {\n-                if (!fImporting && !fReindex) {\n-                    if (inv.type == MSG_BLOCK)\n-                        AddBlockToQueue(pfrom->GetId(), inv.hash);\n-                    else\n-                        pfrom->AskFor(inv);\n-                }\n-            } else if (inv.type == MSG_BLOCK && mapOrphanBlocks.count(inv.hash)) {\n-                PushGetBlocks(pfrom, chainActive.Tip(), GetOrphanRoot(inv.hash));\n-            }\n+            if (!fAlreadyHave && !fImporting && !fReindex && inv.type != MSG_BLOCK)\n+                pfrom->AskFor(inv);\n \n-            if (inv.type == MSG_BLOCK)\n+            if (inv.type == MSG_BLOCK) {\n                 UpdateBlockAvailability(pfrom->GetId(), inv.hash);\n+                if (!fAlreadyHave && !fImporting && !fReindex) {\n+                    // First request the headers preceeding the announced block. In the normal fully-synced\n+                    // case where a new block is announced that succeeds the current tip (no reorganization),\n+                    // there are no such headers.\n+                    // Secondly, and only when we are close to being synced, we request the announced block afterwards,\n+                    // to avoid an extra round-trip. Note that we must *first* ask for the headers, so by the\n+                    // time the block arrives, the header chain leading up to it is already validated. Not\n+                    // doing this will result in the received block being rejected as an orphan.\n+                    pfrom->PushMessage(\"getheaders\", chainActive.GetLocator(pindexBestHeader), inv.hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r14592852",
      "id" : 14592852,
      "original_commit_id" : "eb7822c91bc71b1e4f0e6e1b04de76c8eabd65ab",
      "original_position" : 673,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/14592852",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r14592881"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/14592881"
         }
      },
      "body" : "We use getheaders instead of getblocks. See SendMessages.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-07-07T12:26:00Z",
      "diff_hunk" : "@@ -2624,93 +2672,25 @@ void CBlockIndex::BuildSkip()\n         pskip = pprev->GetAncestor(GetSkipHeight(nHeight));\n }\n \n-void PushGetBlocks(CNode* pnode, CBlockIndex* pindexBegin, uint256 hashEnd)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r14592881",
      "id" : 14592881,
      "original_commit_id" : "eb7822c91bc71b1e4f0e6e1b04de76c8eabd65ab",
      "original_position" : 485,
      "path" : "src/main.cpp",
      "position" : 654,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/14592881",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r14592939"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/14592939"
         }
      },
      "body" : "It does, under \"// Start block sync\" in SendMessages(). The code you're commenting on is for newly announced blocks. Not that it's relevant to an inv.hash, so it's not something we can do before even hearing something from the peer.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-07-07T12:27:46Z",
      "diff_hunk" : "@@ -3760,23 +3750,34 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv)\n             bool fAlreadyHave = AlreadyHave(inv);\n             LogPrint(\"net\", \"got inv: %s  %s peer=%d\\n\", inv.ToString(), fAlreadyHave ? \"have\" : \"new\", pfrom->id);\n \n-            if (!fAlreadyHave) {\n-                if (!fImporting && !fReindex) {\n-                    if (inv.type == MSG_BLOCK)\n-                        AddBlockToQueue(pfrom->GetId(), inv.hash);\n-                    else\n-                        pfrom->AskFor(inv);\n-                }\n-            } else if (inv.type == MSG_BLOCK && mapOrphanBlocks.count(inv.hash)) {\n-                PushGetBlocks(pfrom, chainActive.Tip(), GetOrphanRoot(inv.hash));\n-            }\n+            if (!fAlreadyHave && !fImporting && !fReindex && inv.type != MSG_BLOCK)\n+                pfrom->AskFor(inv);\n \n-            if (inv.type == MSG_BLOCK)\n+            if (inv.type == MSG_BLOCK) {\n                 UpdateBlockAvailability(pfrom->GetId(), inv.hash);\n+                if (!fAlreadyHave && !fImporting && !fReindex) {\n+                    // First request the headers preceeding the announced block. In the normal fully-synced\n+                    // case where a new block is announced that succeeds the current tip (no reorganization),\n+                    // there are no such headers.\n+                    // Secondly, and only when we are close to being synced, we request the announced block afterwards,\n+                    // to avoid an extra round-trip. Note that we must *first* ask for the headers, so by the\n+                    // time the block arrives, the header chain leading up to it is already validated. Not\n+                    // doing this will result in the received block being rejected as an orphan.\n+                    pfrom->PushMessage(\"getheaders\", chainActive.GetLocator(pindexBestHeader), inv.hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r14592939",
      "id" : 14592939,
      "original_commit_id" : "eb7822c91bc71b1e4f0e6e1b04de76c8eabd65ab",
      "original_position" : 673,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/14592939",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r14592968"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/14592968"
         }
      },
      "body" : "The node / block chain handling code is very much in flux at the moment, you'll have to live with that. I can understand annoyance if it is just some white-space reordering that broke your pull for the zillionth time, but these are difficult and important changes and it's not possible to know everything in advance.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-07-07T12:28:37Z",
      "diff_hunk" : "@@ -266,63 +265,36 @@ void FinalizeNode(NodeId nodeid) {\n     LOCK(cs_main);\n     CNodeState *state = State(nodeid);\n \n+    if (state->fSyncStarted)\n+        nSyncStarted--;\n+\n     BOOST_FOREACH(const QueuedBlock& entry, state->vBlocksInFlight)\n         mapBlocksInFlight.erase(entry.hash);\n-    BOOST_FOREACH(const uint256& hash, state->vBlocksToDownload)\n-        mapBlocksToDownload.erase(hash);\n \n     mapNodeState.erase(nodeid);\n }\n \n // Requires cs_main.\n-void MarkBlockAsReceived(const uint256 &hash, NodeId nodeFrom = -1) {\n-    map<uint256, pair<NodeId, list<uint256>::iterator> >::iterator itToDownload = mapBlocksToDownload.find(hash);\n-    if (itToDownload != mapBlocksToDownload.end()) {\n-        CNodeState *state = State(itToDownload->second.first);\n-        state->vBlocksToDownload.erase(itToDownload->second.second);\n-        state->nBlocksToDownload--;\n-        mapBlocksToDownload.erase(itToDownload);\n-    }\n-\n+void MarkBlockAsReceived(const uint256& hash) {\n     map<uint256, pair<NodeId, list<QueuedBlock>::iterator> >::iterator itInFlight = mapBlocksInFlight.find(hash);\n     if (itInFlight != mapBlocksInFlight.end()) {\n         CNodeState *state = State(itInFlight->second.first);\n         state->vBlocksInFlight.erase(itInFlight->second.second);\n         state->nBlocksInFlight--;\n-        if (itInFlight->second.first == nodeFrom)\n-            state->nLastBlockReceive = GetTimeMicros();\n+        state->nStallingSince = 0;\n         mapBlocksInFlight.erase(itInFlight);\n     }\n }\n \n // Requires cs_main.\n-bool AddBlockToQueue(NodeId nodeid, const uint256 &hash) {\n-    if (mapBlocksToDownload.count(hash) || mapBlocksInFlight.count(hash))\n-        return false;\n-\n-    CNodeState *state = State(nodeid);\n-    if (state == NULL)\n-        return false;\n-\n-    list<uint256>::iterator it = state->vBlocksToDownload.insert(state->vBlocksToDownload.end(), hash);\n-    state->nBlocksToDownload++;\n-    if (state->nBlocksToDownload > 5000)\n-        Misbehaving(nodeid, 10);\n-    mapBlocksToDownload[hash] = std::make_pair(nodeid, it);\n-    return true;\n-}\n-\n-// Requires cs_main.\n-void MarkBlockAsInFlight(NodeId nodeid, const uint256 &hash) {\n+void MarkBlockAsInFlight(NodeId nodeid, const uint256& hash, CBlockIndex *pindex = NULL) {\n     CNodeState *state = State(nodeid);\n     assert(state != NULL);\n \n     // Make sure it's not listed somewhere already.\n     MarkBlockAsReceived(hash);\n \n-    QueuedBlock newentry = {hash, GetTimeMicros(), state->nBlocksInFlight};\n-    if (state->nBlocksInFlight == 0)\n-        state->nLastBlockReceive = newentry.nTime; // Reset when a first request is sent.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r14592968",
      "id" : 14592968,
      "original_commit_id" : "eb7822c91bc71b1e4f0e6e1b04de76c8eabd65ab",
      "original_position" : 139,
      "path" : "src/main.cpp",
      "position" : 154,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/14592968",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r14593038"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/14593038"
         }
      },
      "body" : "I understand, but some temporary code was necessary to get the block\ntracking code into the existing (non headers first) mechanism. I think I\nmentioned that in the PR or commit that introduced it.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-07-07T12:31:16Z",
      "diff_hunk" : "@@ -266,63 +265,36 @@ void FinalizeNode(NodeId nodeid) {\n     LOCK(cs_main);\n     CNodeState *state = State(nodeid);\n \n+    if (state->fSyncStarted)\n+        nSyncStarted--;\n+\n     BOOST_FOREACH(const QueuedBlock& entry, state->vBlocksInFlight)\n         mapBlocksInFlight.erase(entry.hash);\n-    BOOST_FOREACH(const uint256& hash, state->vBlocksToDownload)\n-        mapBlocksToDownload.erase(hash);\n \n     mapNodeState.erase(nodeid);\n }\n \n // Requires cs_main.\n-void MarkBlockAsReceived(const uint256 &hash, NodeId nodeFrom = -1) {\n-    map<uint256, pair<NodeId, list<uint256>::iterator> >::iterator itToDownload = mapBlocksToDownload.find(hash);\n-    if (itToDownload != mapBlocksToDownload.end()) {\n-        CNodeState *state = State(itToDownload->second.first);\n-        state->vBlocksToDownload.erase(itToDownload->second.second);\n-        state->nBlocksToDownload--;\n-        mapBlocksToDownload.erase(itToDownload);\n-    }\n-\n+void MarkBlockAsReceived(const uint256& hash) {\n     map<uint256, pair<NodeId, list<QueuedBlock>::iterator> >::iterator itInFlight = mapBlocksInFlight.find(hash);\n     if (itInFlight != mapBlocksInFlight.end()) {\n         CNodeState *state = State(itInFlight->second.first);\n         state->vBlocksInFlight.erase(itInFlight->second.second);\n         state->nBlocksInFlight--;\n-        if (itInFlight->second.first == nodeFrom)\n-            state->nLastBlockReceive = GetTimeMicros();\n+        state->nStallingSince = 0;\n         mapBlocksInFlight.erase(itInFlight);\n     }\n }\n \n // Requires cs_main.\n-bool AddBlockToQueue(NodeId nodeid, const uint256 &hash) {\n-    if (mapBlocksToDownload.count(hash) || mapBlocksInFlight.count(hash))\n-        return false;\n-\n-    CNodeState *state = State(nodeid);\n-    if (state == NULL)\n-        return false;\n-\n-    list<uint256>::iterator it = state->vBlocksToDownload.insert(state->vBlocksToDownload.end(), hash);\n-    state->nBlocksToDownload++;\n-    if (state->nBlocksToDownload > 5000)\n-        Misbehaving(nodeid, 10);\n-    mapBlocksToDownload[hash] = std::make_pair(nodeid, it);\n-    return true;\n-}\n-\n-// Requires cs_main.\n-void MarkBlockAsInFlight(NodeId nodeid, const uint256 &hash) {\n+void MarkBlockAsInFlight(NodeId nodeid, const uint256& hash, CBlockIndex *pindex = NULL) {\n     CNodeState *state = State(nodeid);\n     assert(state != NULL);\n \n     // Make sure it's not listed somewhere already.\n     MarkBlockAsReceived(hash);\n \n-    QueuedBlock newentry = {hash, GetTimeMicros(), state->nBlocksInFlight};\n-    if (state->nBlocksInFlight == 0)\n-        state->nLastBlockReceive = newentry.nTime; // Reset when a first request is sent.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r14593038",
      "id" : 14593038,
      "original_commit_id" : "eb7822c91bc71b1e4f0e6e1b04de76c8eabd65ab",
      "original_position" : 139,
      "path" : "src/main.cpp",
      "position" : 154,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/14593038",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r14593818"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/14593818"
         }
      },
      "body" : "\"Stalling\" is already a rather strong condition: it means all blocks in\nflight are from a single peer, and we can't ask any peer for other blocks\nbecause they are outside the download window. It does not just mean that\nwe're not receiving anything from this peer, it means we can't download\nanything from anyone because of this peer. The 2 second delay before\nactually connecting is to give us some chance to act on blocks that were\nalready received while we were busy.\n\nThat said, this is certainly not perfect. We'll need some tracking of\npeers' speed and latency to adjust window sizes, for example. I really just\nwant something that reasonably well in now.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-07-07T12:54:31Z",
      "diff_hunk" : "@@ -266,63 +265,36 @@ void FinalizeNode(NodeId nodeid) {\n     LOCK(cs_main);\n     CNodeState *state = State(nodeid);\n \n+    if (state->fSyncStarted)\n+        nSyncStarted--;\n+\n     BOOST_FOREACH(const QueuedBlock& entry, state->vBlocksInFlight)\n         mapBlocksInFlight.erase(entry.hash);\n-    BOOST_FOREACH(const uint256& hash, state->vBlocksToDownload)\n-        mapBlocksToDownload.erase(hash);\n \n     mapNodeState.erase(nodeid);\n }\n \n // Requires cs_main.\n-void MarkBlockAsReceived(const uint256 &hash, NodeId nodeFrom = -1) {\n-    map<uint256, pair<NodeId, list<uint256>::iterator> >::iterator itToDownload = mapBlocksToDownload.find(hash);\n-    if (itToDownload != mapBlocksToDownload.end()) {\n-        CNodeState *state = State(itToDownload->second.first);\n-        state->vBlocksToDownload.erase(itToDownload->second.second);\n-        state->nBlocksToDownload--;\n-        mapBlocksToDownload.erase(itToDownload);\n-    }\n-\n+void MarkBlockAsReceived(const uint256& hash) {\n     map<uint256, pair<NodeId, list<QueuedBlock>::iterator> >::iterator itInFlight = mapBlocksInFlight.find(hash);\n     if (itInFlight != mapBlocksInFlight.end()) {\n         CNodeState *state = State(itInFlight->second.first);\n         state->vBlocksInFlight.erase(itInFlight->second.second);\n         state->nBlocksInFlight--;\n-        if (itInFlight->second.first == nodeFrom)\n-            state->nLastBlockReceive = GetTimeMicros();\n+        state->nStallingSince = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r14593818",
      "id" : 14593818,
      "original_commit_id" : "eb7822c91bc71b1e4f0e6e1b04de76c8eabd65ab",
      "original_position" : 106,
      "path" : "src/main.cpp",
      "position" : 121,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/14593818",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r14593935"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/14593935"
         }
      },
      "body" : "Good catch. I can't check the code now, but if there is no other logic for\npunishing duplicates, that will need fixing.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-07-07T12:57:21Z",
      "diff_hunk" : "@@ -2624,93 +2672,25 @@ void CBlockIndex::BuildSkip()\n         pskip = pprev->GetAncestor(GetSkipHeight(nHeight));\n }\n \n-void PushGetBlocks(CNode* pnode, CBlockIndex* pindexBegin, uint256 hashEnd)\n-{\n-    AssertLockHeld(cs_main);\n-    // Filter out duplicate requests\n-    if (pindexBegin == pnode->pindexLastGetBlocksBegin && hashEnd == pnode->hashLastGetBlocksEnd)\n-        return;\n-    pnode->pindexLastGetBlocksBegin = pindexBegin;\n-    pnode->hashLastGetBlocksEnd = hashEnd;\n-\n-    pnode->PushMessage(\"getblocks\", chainActive.GetLocator(pindexBegin), hashEnd);\n-}\n-\n bool ProcessBlock(CValidationState &state, CNode* pfrom, CBlock* pblock, CDiskBlockPos *dbp)\n {\n-    // Check for duplicate",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r14593935",
      "id" : 14593935,
      "original_commit_id" : "eb7822c91bc71b1e4f0e6e1b04de76c8eabd65ab",
      "original_position" : 499,
      "path" : "src/main.cpp",
      "position" : 668,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/14593935",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r14657727"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/14657727"
         }
      },
      "body" : "Fixed. Made it a level 20 dossable offense (in AcceptBlock, which already has cs_main).",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-07-08T15:03:38Z",
      "diff_hunk" : "@@ -2624,93 +2672,25 @@ void CBlockIndex::BuildSkip()\n         pskip = pprev->GetAncestor(GetSkipHeight(nHeight));\n }\n \n-void PushGetBlocks(CNode* pnode, CBlockIndex* pindexBegin, uint256 hashEnd)\n-{\n-    AssertLockHeld(cs_main);\n-    // Filter out duplicate requests\n-    if (pindexBegin == pnode->pindexLastGetBlocksBegin && hashEnd == pnode->hashLastGetBlocksEnd)\n-        return;\n-    pnode->pindexLastGetBlocksBegin = pindexBegin;\n-    pnode->hashLastGetBlocksEnd = hashEnd;\n-\n-    pnode->PushMessage(\"getblocks\", chainActive.GetLocator(pindexBegin), hashEnd);\n-}\n-\n bool ProcessBlock(CValidationState &state, CNode* pfrom, CBlock* pblock, CDiskBlockPos *dbp)\n {\n-    // Check for duplicate",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r14657727",
      "id" : 14657727,
      "original_commit_id" : "eb7822c91bc71b1e4f0e6e1b04de76c8eabd65ab",
      "original_position" : 499,
      "path" : "src/main.cpp",
      "position" : 668,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/14657727",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Changed the code to use block-first-seen rather than header-first-seen to distinguish between equal-work branches.",
      "created_at" : "2014-07-08T15:04:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-48349716",
      "id" : 48349716,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-07-08T15:04:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48349716",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Rebased on top of #4496 and #4497 (which were already included here).",
      "created_at" : "2014-07-11T15:37:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-48745898",
      "id" : 48745898,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-07-11T15:37:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48745898",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Moved RPC changes to a separate commit (now the actual headers-first commit is a net negative in lines, while adding comments!).",
      "created_at" : "2014-07-11T22:23:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-48789766",
      "id" : 48789766,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-07-11T22:23:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48789766",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Needs rebase.",
      "created_at" : "2014-07-14T13:10:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-48897493",
      "id" : 48897493,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-07-14T13:10:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48897493",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Rebased.",
      "created_at" : "2014-07-14T14:21:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-48905238",
      "id" : 48905238,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-07-14T14:21:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48905238",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "I retried my testing, now with a non-corrupting destination, and found no issues. I tickled it in various ways with -checklevel -checkblocks and it completed fine. ",
      "created_at" : "2014-07-15T06:52:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-48996544",
      "id" : 48996544,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-07-15T06:53:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48996544",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Ok, I have a thought/question. With this pull, won't it effectively mean that the average height of the average node be less than without this pull? I.e. detrimental to the bitcoin network?",
      "created_at" : "2014-07-16T10:34:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-49147984",
      "id" : 49147984,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-07-16T10:34:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/49147984",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "body" : "@rebroad I can't figure out why you'd think that. Once synchronized the heights of all nodes will be the best available to them, and this change makes the system synchronize much faster.",
      "created_at" : "2014-07-16T11:55:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-49154968",
      "id" : 49154968,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-07-16T11:55:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/49154968",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "It's not the headers first aspect that makes them sync faster but rather the use of concurrent block downloads. The getting of headers first and the downloading of blocks that aren't necessarily in the best chain will delay nodes getting up to date.",
      "created_at" : "2014-07-17T10:51:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-49291716",
      "id" : 49291716,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-09-04T08:49:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/49291716",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "body" : "I'm not convinced by your claim @rebroad. Let's look at the evidence here: with this code, new nodes get up to speed *much* faster. With a decent internet connection this is scarcely longer than a -reindex would take. I don't see one single case of a user reporting that this makes a node get up to date slower. ",
      "created_at" : "2014-07-17T11:04:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-49292774",
      "id" : 49292774,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-07-17T11:04:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/49292774",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "@rebroad Part of the whole point is that it can use the headers to determine the best chain (with very high probability only invalidated if the majority hashrate chain is invalidated) _very_ fast, then it only downloads blocks in the best chain.  New blocks at the tip are downloaded like they've always been.",
      "created_at" : "2014-07-17T11:48:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-49296718",
      "id" : 49296718,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-07-17T11:48:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/49296718",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Right, this mostly avoids downloading blocks not on the best chain *unlike* before. No more orphans...\r\n",
      "created_at" : "2014-07-17T11:51:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-49296900",
      "id" : 49296900,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-07-17T11:51:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/49296900",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "In the steady state, headers and blocks are fetched in a single request (unless there is a reorg), so there are no additional roundtrips for getting synchronized. There's an extra 100 bytes or so to get the header...",
      "created_at" : "2014-07-17T14:29:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-49314082",
      "id" : 49314082,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-07-17T14:29:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/49314082",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15274365"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15274365"
         }
      },
      "body" : "What does 'may be failed' mean in this context? The block has valid transactions, but failed the higher checks?",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-07-23T07:27:11Z",
      "diff_hunk" : "@@ -96,8 +90,14 @@ namespace {\n     };\n \n     CBlockIndex *pindexBestInvalid;\n-    // may contain all CBlockIndex*'s that have validness >=BLOCK_VALID_TRANSACTIONS, and must contain those who aren't failed\n+\n+    // The set of all CBlockIndex entries with BLOCK_VALID_TRANSACTIONS or better that are at least\n+    // as good as our current tip. Entries may be failed, though.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15274365",
      "id" : 15274365,
      "original_commit_id" : "5b6b078b275648e88008048134eddcc89cad6ad9",
      "original_position" : 36,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15274365",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15277103"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15277103"
         }
      },
      "body" : "Indeed. Feel free to suggest better wording.\r\n\r\nThe reason is that we don't have a map from blocks to their successors, only backwards. That means that if there's a fork A-B-C and A-B-D-E, and we try to connect E (which fails at B), A-B-D-E are marked failed (and E is removed from setBlockIndexValid), but C isn't marked failed or removed from setBlockIndexValid. This is detected as soon as we do try to connect C.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-07-23T08:48:50Z",
      "diff_hunk" : "@@ -96,8 +90,14 @@ namespace {\n     };\n \n     CBlockIndex *pindexBestInvalid;\n-    // may contain all CBlockIndex*'s that have validness >=BLOCK_VALID_TRANSACTIONS, and must contain those who aren't failed\n+\n+    // The set of all CBlockIndex entries with BLOCK_VALID_TRANSACTIONS or better that are at least\n+    // as good as our current tip. Entries may be failed, though.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15277103",
      "id" : 15277103,
      "original_commit_id" : "5b6b078b275648e88008048134eddcc89cad6ad9",
      "original_position" : 36,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15277103",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15279462"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15279462"
         }
      },
      "body" : "Thanks for explaining, that makes it clear to me. \r\n\r\nI think the wording is fine, but it would be useful to add that explanation in the comment as well.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-07-23T09:51:11Z",
      "diff_hunk" : "@@ -96,8 +90,14 @@ namespace {\n     };\n \n     CBlockIndex *pindexBestInvalid;\n-    // may contain all CBlockIndex*'s that have validness >=BLOCK_VALID_TRANSACTIONS, and must contain those who aren't failed\n+\n+    // The set of all CBlockIndex entries with BLOCK_VALID_TRANSACTIONS or better that are at least\n+    // as good as our current tip. Entries may be failed, though.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15279462",
      "id" : 15279462,
      "original_commit_id" : "5b6b078b275648e88008048134eddcc89cad6ad9",
      "original_position" : 36,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15279462",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15286704"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15286704"
         }
      },
      "body" : "Precondition: vBlocks.empty() ?",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-07-23T13:24:13Z",
      "diff_hunk" : "@@ -363,6 +337,100 @@ void UpdateBlockAvailability(NodeId nodeid, const uint256 &hash) {\n     }\n }\n \n+CBlockIndex* LastCommonAncestor(CBlockIndex* pa, CBlockIndex* pb) {\n+    if (pa == NULL || pb == NULL)\n+        return NULL;\n+\n+    if (pa->nHeight > pb->nHeight) {\n+        pa = pa->GetAncestor(pb->nHeight);\n+    } else if (pb->nHeight > pa->nHeight) {\n+        pb = pb->GetAncestor(pa->nHeight);\n+    }\n+\n+    while (pa != pb && pa && pb) {\n+        pa = pa->pprev;\n+        pb = pb->pprev;\n+    }\n+\n+    if (pa == pb)\n+        return pa;\n+    return NULL;\n+}\n+\n+/** Update pindexLastCommonBlock and return its not-in-flight missing successors. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15286704",
      "id" : 15286704,
      "original_commit_id" : "5b6b078b275648e88008048134eddcc89cad6ad9",
      "original_position" : 185,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15286704",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15287857"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15287857"
         }
      },
      "body" : "Good idea.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-07-23T13:43:44Z",
      "diff_hunk" : "@@ -2210,10 +2250,10 @@ CBlockIndex* AddToBlockIndex(CBlockHeader& block)\n     // Construct new block index object\n     CBlockIndex* pindexNew = new CBlockIndex(block);\n     assert(pindexNew);\n-    {\n-         LOCK(cs_nBlockSequenceId);\n-         pindexNew->nSequenceId = nBlockSequenceId++;\n-    }\n+    // We assign the sequence id to blocks only when the full data is available,\n+    // to avoid miners withholding blocks but broadcasting headers, to get a\n+    // competitive advantage.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15287857",
      "id" : 15287857,
      "original_commit_id" : "5b6b078b275648e88008048134eddcc89cad6ad9",
      "original_position" : 387,
      "path" : "src/main.cpp",
      "position" : 457,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15287857",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15288611"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15288611"
         }
      },
      "body" : "Any specific reason for moving this before checking 'size limits'?\r\n",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-07-23T13:56:46Z",
      "diff_hunk" : "@@ -2372,12 +2431,30 @@ bool CheckBlockHeader(const CBlockHeader& block, CValidationState& state, bool f\n \n bool CheckBlock(const CBlock& block, CValidationState& state, bool fCheckPOW, bool fCheckMerkleRoot)\n {\n-    // These are checks that are independent of context\n-    // that can be verified before saving an orphan block.\n+    // These are checks that are independent of context.\n \n     if (!CheckBlockHeader(block, state, fCheckPOW))\n         return false;\n \n+    // Check merkle root",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15288611",
      "id" : 15288611,
      "original_commit_id" : "5b6b078b275648e88008048134eddcc89cad6ad9",
      "original_position" : 478,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15288611",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15289072"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15289072"
         }
      },
      "body" : "What is the reason for comparing `pindex->pprev->nChainTx` to 0 here? Is this a special value that means 'unlinked block'?\r\n\r\n\r\n",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-07-23T14:04:21Z",
      "diff_hunk" : "@@ -2973,13 +2975,26 @@ bool static LoadBlockIndexDB()\n     {\n         CBlockIndex* pindex = item.second;\n         pindex->nChainWork = (pindex->pprev ? pindex->pprev->nChainWork : 0) + pindex->GetBlockWork();\n-        pindex->nChainTx = (pindex->pprev ? pindex->pprev->nChainTx : 0) + pindex->nTx;\n-        if (pindex->IsValid(BLOCK_VALID_TRANSACTIONS))\n+        if (pindex->nStatus & BLOCK_HAVE_DATA) {\n+            if (pindex->pprev) {\n+                if (pindex->pprev->nChainTx) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15289072",
      "id" : 15289072,
      "original_commit_id" : "5b6b078b275648e88008048134eddcc89cad6ad9",
      "original_position" : 675,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15289072",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15289611"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15289611"
         }
      },
      "body" : "Indeed. There's a comment on BLOCK_VALID_TRANSACTIONS explaining that. I'll add it to nChainTx itself.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-07-23T14:14:59Z",
      "diff_hunk" : "@@ -2973,13 +2975,26 @@ bool static LoadBlockIndexDB()\n     {\n         CBlockIndex* pindex = item.second;\n         pindex->nChainWork = (pindex->pprev ? pindex->pprev->nChainWork : 0) + pindex->GetBlockWork();\n-        pindex->nChainTx = (pindex->pprev ? pindex->pprev->nChainTx : 0) + pindex->nTx;\n-        if (pindex->IsValid(BLOCK_VALID_TRANSACTIONS))\n+        if (pindex->nStatus & BLOCK_HAVE_DATA) {\n+            if (pindex->pprev) {\n+                if (pindex->pprev->nChainTx) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15289611",
      "id" : 15289611,
      "original_commit_id" : "5b6b078b275648e88008048134eddcc89cad6ad9",
      "original_position" : 675,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15289611",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15289634"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15289634"
         }
      },
      "body" : "Yes, see the comment added before the 'size limits' section.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-07-23T14:15:27Z",
      "diff_hunk" : "@@ -2372,12 +2431,30 @@ bool CheckBlockHeader(const CBlockHeader& block, CValidationState& state, bool f\n \n bool CheckBlock(const CBlock& block, CValidationState& state, bool fCheckPOW, bool fCheckMerkleRoot)\n {\n-    // These are checks that are independent of context\n-    // that can be verified before saving an orphan block.\n+    // These are checks that are independent of context.\n \n     if (!CheckBlockHeader(block, state, fCheckPOW))\n         return false;\n \n+    // Check merkle root",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15289634",
      "id" : 15289634,
      "original_commit_id" : "5b6b078b275648e88008048134eddcc89cad6ad9",
      "original_position" : 478,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15289634",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15289715"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15289715"
         }
      },
      "body" : "Is it fine if I change the description to 'append its not-in-flight missing successors to vBlocks'?",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-07-23T14:16:48Z",
      "diff_hunk" : "@@ -363,6 +337,100 @@ void UpdateBlockAvailability(NodeId nodeid, const uint256 &hash) {\n     }\n }\n \n+CBlockIndex* LastCommonAncestor(CBlockIndex* pa, CBlockIndex* pb) {\n+    if (pa == NULL || pb == NULL)\n+        return NULL;\n+\n+    if (pa->nHeight > pb->nHeight) {\n+        pa = pa->GetAncestor(pb->nHeight);\n+    } else if (pb->nHeight > pa->nHeight) {\n+        pb = pb->GetAncestor(pa->nHeight);\n+    }\n+\n+    while (pa != pb && pa && pb) {\n+        pa = pa->pprev;\n+        pb = pb->pprev;\n+    }\n+\n+    if (pa == pb)\n+        return pa;\n+    return NULL;\n+}\n+\n+/** Update pindexLastCommonBlock and return its not-in-flight missing successors. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15289715",
      "id" : 15289715,
      "original_commit_id" : "5b6b078b275648e88008048134eddcc89cad6ad9",
      "original_position" : 185,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15289715",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15289895"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15289895"
         }
      },
      "body" : "Well, you're making the amount of blocks added depend on the current vBlocks.size(), so it appeared to me that you assume you're starting with an empty vector.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-07-23T14:19:43Z",
      "diff_hunk" : "@@ -363,6 +337,100 @@ void UpdateBlockAvailability(NodeId nodeid, const uint256 &hash) {\n     }\n }\n \n+CBlockIndex* LastCommonAncestor(CBlockIndex* pa, CBlockIndex* pb) {\n+    if (pa == NULL || pb == NULL)\n+        return NULL;\n+\n+    if (pa->nHeight > pb->nHeight) {\n+        pa = pa->GetAncestor(pb->nHeight);\n+    } else if (pb->nHeight > pa->nHeight) {\n+        pb = pb->GetAncestor(pa->nHeight);\n+    }\n+\n+    while (pa != pb && pa && pb) {\n+        pa = pa->pprev;\n+        pb = pb->pprev;\n+    }\n+\n+    if (pa == pb)\n+        return pa;\n+    return NULL;\n+}\n+\n+/** Update pindexLastCommonBlock and return its not-in-flight missing successors. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15289895",
      "id" : 15289895,
      "original_commit_id" : "5b6b078b275648e88008048134eddcc89cad6ad9",
      "original_position" : 185,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15289895",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15290176"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15290176"
         }
      },
      "body" : "Update pindexLastCommonBlock and its not-in-flight missing successors to vBlocks, until that vector has at most count entries.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-07-23T14:24:39Z",
      "diff_hunk" : "@@ -363,6 +337,100 @@ void UpdateBlockAvailability(NodeId nodeid, const uint256 &hash) {\n     }\n }\n \n+CBlockIndex* LastCommonAncestor(CBlockIndex* pa, CBlockIndex* pb) {\n+    if (pa == NULL || pb == NULL)\n+        return NULL;\n+\n+    if (pa->nHeight > pb->nHeight) {\n+        pa = pa->GetAncestor(pb->nHeight);\n+    } else if (pb->nHeight > pa->nHeight) {\n+        pb = pb->GetAncestor(pa->nHeight);\n+    }\n+\n+    while (pa != pb && pa && pb) {\n+        pa = pa->pprev;\n+        pb = pb->pprev;\n+    }\n+\n+    if (pa == pb)\n+        return pa;\n+    return NULL;\n+}\n+\n+/** Update pindexLastCommonBlock and return its not-in-flight missing successors. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15290176",
      "id" : 15290176,
      "original_commit_id" : "5b6b078b275648e88008048134eddcc89cad6ad9",
      "original_position" : 185,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15290176",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15290429"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15290429"
         }
      },
      "body" : "OK",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-07-23T14:28:10Z",
      "diff_hunk" : "@@ -363,6 +337,100 @@ void UpdateBlockAvailability(NodeId nodeid, const uint256 &hash) {\n     }\n }\n \n+CBlockIndex* LastCommonAncestor(CBlockIndex* pa, CBlockIndex* pb) {\n+    if (pa == NULL || pb == NULL)\n+        return NULL;\n+\n+    if (pa->nHeight > pb->nHeight) {\n+        pa = pa->GetAncestor(pb->nHeight);\n+    } else if (pb->nHeight > pa->nHeight) {\n+        pb = pb->GetAncestor(pa->nHeight);\n+    }\n+\n+    while (pa != pb && pa && pb) {\n+        pa = pa->pprev;\n+        pb = pb->pprev;\n+    }\n+\n+    if (pa == pb)\n+        return pa;\n+    return NULL;\n+}\n+\n+/** Update pindexLastCommonBlock and return its not-in-flight missing successors. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15290429",
      "id" : 15290429,
      "original_commit_id" : "5b6b078b275648e88008048134eddcc89cad6ad9",
      "original_position" : 185,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15290429",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15293623"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15293623"
         }
      },
      "body" : "Ah, makes sense.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-07-23T15:15:34Z",
      "diff_hunk" : "@@ -2372,12 +2431,30 @@ bool CheckBlockHeader(const CBlockHeader& block, CValidationState& state, bool f\n \n bool CheckBlock(const CBlock& block, CValidationState& state, bool fCheckPOW, bool fCheckMerkleRoot)\n {\n-    // These are checks that are independent of context\n-    // that can be verified before saving an orphan block.\n+    // These are checks that are independent of context.\n \n     if (!CheckBlockHeader(block, state, fCheckPOW))\n         return false;\n \n+    // Check merkle root",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15293623",
      "id" : 15293623,
      "original_commit_id" : "5b6b078b275648e88008048134eddcc89cad6ad9",
      "original_position" : 478,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15293623",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15293777"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15293777"
         }
      },
      "body" : "Right. For a moment I thought this was the case for blocks that are the successor of the genesis block, but nChainTx is inclusive so even the genesis block has nChainTx=1 because of the coinbase transaction.\r\n",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-07-23T15:17:50Z",
      "diff_hunk" : "@@ -2973,13 +2975,26 @@ bool static LoadBlockIndexDB()\n     {\n         CBlockIndex* pindex = item.second;\n         pindex->nChainWork = (pindex->pprev ? pindex->pprev->nChainWork : 0) + pindex->GetBlockWork();\n-        pindex->nChainTx = (pindex->pprev ? pindex->pprev->nChainTx : 0) + pindex->nTx;\n-        if (pindex->IsValid(BLOCK_VALID_TRANSACTIONS))\n+        if (pindex->nStatus & BLOCK_HAVE_DATA) {\n+            if (pindex->pprev) {\n+                if (pindex->pprev->nChainTx) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15293777",
      "id" : 15293777,
      "original_commit_id" : "5b6b078b275648e88008048134eddcc89cad6ad9",
      "original_position" : 675,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15293777",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15298255"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15298255"
         }
      },
      "body" : "Protocol version 31800 was version 0.3.18. It's absolutely reasonable to bump the minimum peer version to that.\r\n",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-07-23T16:24:16Z",
      "diff_hunk" : "@@ -31,8 +31,11 @@ static const int PROTOCOL_VERSION = 70002;\n // intial proto version, to be increased after version/verack negotiation\n static const int INIT_PROTO_VERSION = 209;\n \n+// In this version, 'getheaders' was introduced.\n+static const int GETHEADERS_VERSION = 31800;\n+\n // disconnect from peers older than this proto version\n-static const int MIN_PEER_PROTO_VERSION = 209;\n+static const int MIN_PEER_PROTO_VERSION = GETHEADERS_VERSION;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15298255",
      "id" : 15298255,
      "original_commit_id" : "5b6b078b275648e88008048134eddcc89cad6ad9",
      "original_position" : 9,
      "path" : "src/version.h",
      "position" : 9,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15298255",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Rebased and addressed some comments by @mikehearn and @laanwj.",
      "created_at" : "2014-07-24T01:09:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-49956536",
      "id" : 49956536,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-07-24T01:09:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/49956536",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15331147"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15331147"
         }
      },
      "body" : "NACK rebroad's NACK.  0.3.18 over 3.5 years old, and ACK the change. Any systems actually running that software are no longer in-sync with the blockchain unless configuration modified and have numerous security vulnerabilities. Non-bitcoin core claiming that version number or before is still enforcing an old version of the protocol without modern facilities like ping.  There is no substantial deployment of versions this old any longer: as of today Luke's spider reports _zero_ nodes running code that old. Finally, continuing to support pre-getheader systems is just more cases that would need to be tested.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-07-24T06:04:37Z",
      "diff_hunk" : "@@ -31,8 +31,11 @@ static const int PROTOCOL_VERSION = 70002;\n // intial proto version, to be increased after version/verack negotiation\n static const int INIT_PROTO_VERSION = 209;\n \n+// In this version, 'getheaders' was introduced.\n+static const int GETHEADERS_VERSION = 31800;\n+\n // disconnect from peers older than this proto version\n-static const int MIN_PEER_PROTO_VERSION = 209;\n+static const int MIN_PEER_PROTO_VERSION = GETHEADERS_VERSION;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15331147",
      "id" : 15331147,
      "original_commit_id" : "5b6b078b275648e88008048134eddcc89cad6ad9",
      "original_position" : 9,
      "path" : "src/version.h",
      "position" : 9,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15331147",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15331324"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15331324"
         }
      },
      "body" : "It's better if such old versions just fail to connect to the network, than that they pretend to catch up and fail due to some other reason.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-07-24T06:13:36Z",
      "diff_hunk" : "@@ -31,8 +31,11 @@ static const int PROTOCOL_VERSION = 70002;\n // intial proto version, to be increased after version/verack negotiation\n static const int INIT_PROTO_VERSION = 209;\n \n+// In this version, 'getheaders' was introduced.\n+static const int GETHEADERS_VERSION = 31800;\n+\n // disconnect from peers older than this proto version\n-static const int MIN_PEER_PROTO_VERSION = 209;\n+static const int MIN_PEER_PROTO_VERSION = GETHEADERS_VERSION;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r15331324",
      "id" : 15331324,
      "original_commit_id" : "5b6b078b275648e88008048134eddcc89cad6ad9",
      "original_position" : 9,
      "path" : "src/version.h",
      "position" : 9,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15331324",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Modified the fetch-block selection a bit: the download window does not start one past the current active tip anymore, but at the first block we don't have in common with a particular peer. The previous algorithm would fail to reorg further back than the download window. Also added extra comments and asserts.",
      "created_at" : "2014-07-26T20:10:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-50247109",
      "id" : 50247109,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-07-26T20:10:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/50247109",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Rebased.",
      "created_at" : "2014-08-23T23:55:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-53171126",
      "id" : 53171126,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-08-23T23:55:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/53171126",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r16998214"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/16998214"
         }
      },
      "body" : "Read a few lines before...",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-02T16:25:57Z",
      "diff_hunk" : "@@ -355,6 +327,100 @@ void UpdateBlockAvailability(NodeId nodeid, const uint256 &hash) {\n     }\n }\n \n+/** Find the last common ancestor two blocks have.\n+ *  Both pa and pb must be non-NULL. */\n+CBlockIndex* LastCommonAncestor(CBlockIndex* pa, CBlockIndex* pb) {\n+    if (pa->nHeight > pb->nHeight) {\n+        pa = pa->GetAncestor(pb->nHeight);\n+    } else if (pb->nHeight > pa->nHeight) {\n+        pb = pb->GetAncestor(pa->nHeight);\n+    }\n+\n+    while (pa != pb && pa && pb) {\n+        pa = pa->pprev;\n+        pb = pb->pprev;\n+    }\n+\n+    // Eventually all chain branches meet at the genesis block.\n+    assert(pa == pb);\n+    return pa;\n+}\n+\n+/** Update pindexLastCommonBlock and add not-in-flight missing successors to vBlocks, until it has\n+ *  at most count entries. */\n+void FindNextBlocksToDownload(NodeId nodeid, unsigned int count, std::vector<CBlockIndex*>& vBlocks, NodeId& nodeStaller) {\n+    if (count == 0)\n+        return;\n+\n+    vBlocks.reserve(vBlocks.size() + count);\n+    CNodeState *state = State(nodeid);\n+    assert(state != NULL);\n+\n+    // Make sure pindexBestKnownBlock is up to date, we'll need it.\n+    ProcessBlockAvailability(nodeid);\n+\n+    if (state->pindexBestKnownBlock == NULL || state->pindexBestKnownBlock->nChainWork < chainActive.Tip()->nChainWork) {\n+        // This peer has nothing interesting.\n+        return;\n+    }\n+\n+    if (state->pindexLastCommonBlock == NULL) {\n+        // Bootstrap quickly by guessing a parent of our best tip is the forking point.\n+        // Guessing wrong in either direction is not a problem.\n+        state->pindexLastCommonBlock = chainActive[std::min(state->pindexBestKnownBlock->nHeight, chainActive.Height())];\n+    }\n+\n+    // If the peer reorganized, our previous pindexLastCommonBlock may not be an ancestor\n+    // of their current tip anymore. Go back enough to fix that.\n+    state->pindexLastCommonBlock = LastCommonAncestor(state->pindexLastCommonBlock, state->pindexBestKnownBlock);\n+    if (state->pindexLastCommonBlock == state->pindexBestKnownBlock)\n+        return;\n+\n+    std::vector<CBlockIndex*> vToFetch;\n+    CBlockIndex *pindexWalk = state->pindexLastCommonBlock;\n+    pair<NodeId, list<QueuedBlock>::iterator>* staller = NULL;\n+    while (true) {\n+        // Read up to 128 (or more, if more blocks than that are needed) successors of pindexWalk (towards\n+        // pindexBestKnownBlock) into vToFetch, but never any beyond pindexBestKnownBlock or BLOCK_DOWNLOAD_WINDOW\n+        // beyond our current tip. We fetch 64, because CBlockIndex::GetAncestor may be as expensive as iterating over\n+        // ~100 CBlockIndex* entries anyway.\n+        int nMaxHeight = std::min<int>(state->pindexBestKnownBlock->nHeight, chainActive.Height() + BLOCK_DOWNLOAD_WINDOW);\n+        int nToFetch = std::min(nMaxHeight - pindexWalk->nHeight, std::max<int>(vBlocks.size() - count, 128));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r16998214",
      "id" : 16998214,
      "original_commit_id" : "2525afb58a71924d48bf99ea19cf741f0c6ccf66",
      "original_position" : 218,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/16998214",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r16998495"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/16998495"
         }
      },
      "body" : "What about 6?",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-02T16:31:45Z",
      "diff_hunk" : "@@ -585,12 +593,29 @@ class CBlockFileInfo\n };\n \n enum BlockStatus {\n+    // Unused.\n     BLOCK_VALID_UNKNOWN      =    0,\n-    BLOCK_VALID_HEADER       =    1, // parsed, version ok, hash satisfies claimed PoW, 1 <= vtx count <= max, timestamp not in future\n-    BLOCK_VALID_TREE         =    2, // parent found, difficulty matches, timestamp >= median previous, checkpoint\n-    BLOCK_VALID_TRANSACTIONS =    3, // only first tx is coinbase, 2 <= coinbase input script length <= 100, transactions valid, no duplicate txids, sigops, size, merkle root\n-    BLOCK_VALID_CHAIN        =    4, // outputs do not overspend inputs, no double spends, coinbase output ok, immature coinbase spends, BIP30\n-    BLOCK_VALID_SCRIPTS      =    5, // scripts/signatures ok\n+\n+    // Parsed, version ok, hash satisfies claimed PoW, 1 <= vtx count <= max, timestamp not in future\n+    BLOCK_VALID_HEADER       =    1,\n+\n+    // All parent headers found, difficulty matches, timestamp >= median previous, checkpoint. Implies all parents\n+    // are also at least TREE.\n+    BLOCK_VALID_TREE         =    2,\n+\n+    // Only first tx is coinbase, 2 <= coinbase input script length <= 100, transactions valid, no duplicate txids,\n+    // sigops, size, merkle root. Implies all parents are at least TREE but not necessarily TRANSACTIONS. When all\n+    // parent blocks also have TRANSACTIONS, CBlockIndex::nChainTx will be set.\n+    BLOCK_VALID_TRANSACTIONS =    3,\n+\n+    // Outputs do not overspend inputs, no double spends, coinbase output ok, immature coinbase spends, BIP30.\n+    // Implies all parents are also at least CHAIN.\n+    BLOCK_VALID_CHAIN        =    4,\n+\n+    // Scripts & signatures ok. Implies all parents are also at least SCRIPTS.\n+    BLOCK_VALID_SCRIPTS      =    5,\n+\n+    // All validity bits.\n     BLOCK_VALID_MASK         =    7,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r16998495",
      "id" : 16998495,
      "original_commit_id" : "2525afb58a71924d48bf99ea19cf741f0c6ccf66",
      "original_position" : 100,
      "path" : "src/main.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/16998495",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r16998557"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/16998557"
         }
      },
      "body" : "There is no 6, nor is there a 7.\r\n\r\nMASK is just the boolean OR of the bits used for validity.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-02T16:33:13Z",
      "diff_hunk" : "@@ -585,12 +593,29 @@ class CBlockFileInfo\n };\n \n enum BlockStatus {\n+    // Unused.\n     BLOCK_VALID_UNKNOWN      =    0,\n-    BLOCK_VALID_HEADER       =    1, // parsed, version ok, hash satisfies claimed PoW, 1 <= vtx count <= max, timestamp not in future\n-    BLOCK_VALID_TREE         =    2, // parent found, difficulty matches, timestamp >= median previous, checkpoint\n-    BLOCK_VALID_TRANSACTIONS =    3, // only first tx is coinbase, 2 <= coinbase input script length <= 100, transactions valid, no duplicate txids, sigops, size, merkle root\n-    BLOCK_VALID_CHAIN        =    4, // outputs do not overspend inputs, no double spends, coinbase output ok, immature coinbase spends, BIP30\n-    BLOCK_VALID_SCRIPTS      =    5, // scripts/signatures ok\n+\n+    // Parsed, version ok, hash satisfies claimed PoW, 1 <= vtx count <= max, timestamp not in future\n+    BLOCK_VALID_HEADER       =    1,\n+\n+    // All parent headers found, difficulty matches, timestamp >= median previous, checkpoint. Implies all parents\n+    // are also at least TREE.\n+    BLOCK_VALID_TREE         =    2,\n+\n+    // Only first tx is coinbase, 2 <= coinbase input script length <= 100, transactions valid, no duplicate txids,\n+    // sigops, size, merkle root. Implies all parents are at least TREE but not necessarily TRANSACTIONS. When all\n+    // parent blocks also have TRANSACTIONS, CBlockIndex::nChainTx will be set.\n+    BLOCK_VALID_TRANSACTIONS =    3,\n+\n+    // Outputs do not overspend inputs, no double spends, coinbase output ok, immature coinbase spends, BIP30.\n+    // Implies all parents are also at least CHAIN.\n+    BLOCK_VALID_CHAIN        =    4,\n+\n+    // Scripts & signatures ok. Implies all parents are also at least SCRIPTS.\n+    BLOCK_VALID_SCRIPTS      =    5,\n+\n+    // All validity bits.\n     BLOCK_VALID_MASK         =    7,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r16998557",
      "id" : 16998557,
      "original_commit_id" : "2525afb58a71924d48bf99ea19cf741f0c6ccf66",
      "original_position" : 100,
      "path" : "src/main.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/16998557",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r16999204"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/16999204"
         }
      },
      "body" : "Minor nit, since it got highlighted:  usual preference is for such a mask to be composed of prior constants, rather than a hardcoded number itself.  The exception to this rule is usually if you just want the field to store all 1's (0xffffffff).\r\n\r\nSometimes it's nice to have the constants define the actual bits (\"1U << $n\"), but it depends on the downstream code whether or not that makes downstream code more or less clean.\r\n",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-02T16:45:36Z",
      "diff_hunk" : "@@ -585,12 +593,29 @@ class CBlockFileInfo\n };\n \n enum BlockStatus {\n+    // Unused.\n     BLOCK_VALID_UNKNOWN      =    0,\n-    BLOCK_VALID_HEADER       =    1, // parsed, version ok, hash satisfies claimed PoW, 1 <= vtx count <= max, timestamp not in future\n-    BLOCK_VALID_TREE         =    2, // parent found, difficulty matches, timestamp >= median previous, checkpoint\n-    BLOCK_VALID_TRANSACTIONS =    3, // only first tx is coinbase, 2 <= coinbase input script length <= 100, transactions valid, no duplicate txids, sigops, size, merkle root\n-    BLOCK_VALID_CHAIN        =    4, // outputs do not overspend inputs, no double spends, coinbase output ok, immature coinbase spends, BIP30\n-    BLOCK_VALID_SCRIPTS      =    5, // scripts/signatures ok\n+\n+    // Parsed, version ok, hash satisfies claimed PoW, 1 <= vtx count <= max, timestamp not in future\n+    BLOCK_VALID_HEADER       =    1,\n+\n+    // All parent headers found, difficulty matches, timestamp >= median previous, checkpoint. Implies all parents\n+    // are also at least TREE.\n+    BLOCK_VALID_TREE         =    2,\n+\n+    // Only first tx is coinbase, 2 <= coinbase input script length <= 100, transactions valid, no duplicate txids,\n+    // sigops, size, merkle root. Implies all parents are at least TREE but not necessarily TRANSACTIONS. When all\n+    // parent blocks also have TRANSACTIONS, CBlockIndex::nChainTx will be set.\n+    BLOCK_VALID_TRANSACTIONS =    3,\n+\n+    // Outputs do not overspend inputs, no double spends, coinbase output ok, immature coinbase spends, BIP30.\n+    // Implies all parents are also at least CHAIN.\n+    BLOCK_VALID_CHAIN        =    4,\n+\n+    // Scripts & signatures ok. Implies all parents are also at least SCRIPTS.\n+    BLOCK_VALID_SCRIPTS      =    5,\n+\n+    // All validity bits.\n     BLOCK_VALID_MASK         =    7,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r16999204",
      "id" : 16999204,
      "original_commit_id" : "2525afb58a71924d48bf99ea19cf741f0c6ccf66",
      "original_position" : 100,
      "path" : "src/main.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/16999204",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r16999968"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/16999968"
         }
      },
      "body" : "@jgarzik See #4820.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-02T16:58:15Z",
      "diff_hunk" : "@@ -585,12 +593,29 @@ class CBlockFileInfo\n };\n \n enum BlockStatus {\n+    // Unused.\n     BLOCK_VALID_UNKNOWN      =    0,\n-    BLOCK_VALID_HEADER       =    1, // parsed, version ok, hash satisfies claimed PoW, 1 <= vtx count <= max, timestamp not in future\n-    BLOCK_VALID_TREE         =    2, // parent found, difficulty matches, timestamp >= median previous, checkpoint\n-    BLOCK_VALID_TRANSACTIONS =    3, // only first tx is coinbase, 2 <= coinbase input script length <= 100, transactions valid, no duplicate txids, sigops, size, merkle root\n-    BLOCK_VALID_CHAIN        =    4, // outputs do not overspend inputs, no double spends, coinbase output ok, immature coinbase spends, BIP30\n-    BLOCK_VALID_SCRIPTS      =    5, // scripts/signatures ok\n+\n+    // Parsed, version ok, hash satisfies claimed PoW, 1 <= vtx count <= max, timestamp not in future\n+    BLOCK_VALID_HEADER       =    1,\n+\n+    // All parent headers found, difficulty matches, timestamp >= median previous, checkpoint. Implies all parents\n+    // are also at least TREE.\n+    BLOCK_VALID_TREE         =    2,\n+\n+    // Only first tx is coinbase, 2 <= coinbase input script length <= 100, transactions valid, no duplicate txids,\n+    // sigops, size, merkle root. Implies all parents are at least TREE but not necessarily TRANSACTIONS. When all\n+    // parent blocks also have TRANSACTIONS, CBlockIndex::nChainTx will be set.\n+    BLOCK_VALID_TRANSACTIONS =    3,\n+\n+    // Outputs do not overspend inputs, no double spends, coinbase output ok, immature coinbase spends, BIP30.\n+    // Implies all parents are also at least CHAIN.\n+    BLOCK_VALID_CHAIN        =    4,\n+\n+    // Scripts & signatures ok. Implies all parents are also at least SCRIPTS.\n+    BLOCK_VALID_SCRIPTS      =    5,\n+\n+    // All validity bits.\n     BLOCK_VALID_MASK         =    7,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r16999968",
      "id" : 16999968,
      "original_commit_id" : "2525afb58a71924d48bf99ea19cf741f0c6ccf66",
      "original_position" : 100,
      "path" : "src/main.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/16999968",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17026905"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17026905"
         }
      },
      "body" : "This is an assumption. This will only work if the other node is the default bitcoind with the same MAX_HEADERS_RESULTS. It's entirely possible that other nodes will have a different maximum setting, in which case, the logic here fails.\r\n\r\nMaybe instead it's better to keep requesting until the results come back smaller than the previous results (this way no assumptions need to be made other than the assumption that their MAX is fixed rather than dynamic).\r\n\r\nI'd also suggest only requesting more headers if the headers received so far were for blocks that we didn't already have.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-03T01:09:55Z",
      "diff_hunk" : "@@ -3935,22 +3945,66 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n     }\n \n \n+    else if (strCommand == \"headers\" && !fImporting && !fReindex) // Ignore headers received while importing\n+    {\n+        std::vector<CBlockHeader> headers;\n+\n+        // Bypass the normal CBlock deserialization, as we don't want to risk deserializing 2000 full blocks.\n+        unsigned int nCount = ReadCompactSize(vRecv);\n+        if (nCount > MAX_HEADERS_RESULTS) {\n+            Misbehaving(pfrom->GetId(), 20);\n+            return error(\"headers message size = %u\", nCount);\n+        }\n+        headers.resize(nCount);\n+        for (unsigned int n = 0; n < nCount; n++) {\n+            vRecv >> headers[n];\n+            ReadCompactSize(vRecv); // ignore tx count; assume it is 0.\n+        }\n+\n+        LOCK(cs_main);\n+\n+        if (nCount == 0) {\n+            // Nothing interesting. Stop asking this peers for more headers.\n+            return true;\n+        }\n+\n+        CBlockIndex *pindexLast = NULL;\n+        BOOST_FOREACH(const CBlockHeader& header, headers) {\n+            CValidationState state;\n+            if (pindexLast != NULL && header.hashPrevBlock != pindexLast->GetBlockHash()) {\n+                Misbehaving(pfrom->GetId(), 20);\n+                return error(\"non-continuous headers sequence\");\n+            }\n+            if (!AcceptBlockHeader(header, state, &pindexLast)) {\n+                int nDoS;\n+                if (state.IsInvalid(nDoS)) {\n+                    if (nDoS > 0)\n+                        Misbehaving(pfrom->GetId(), nDoS);\n+                    return error(\"invalid header received\");\n+                }\n+            }\n+        }\n+\n+        if (pindexLast)\n+            UpdateBlockAvailability(pfrom->GetId(), pindexLast->GetBlockHash());\n+\n+        if (nCount == MAX_HEADERS_RESULTS && pindexLast) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17026905",
      "id" : 17026905,
      "original_commit_id" : "2525afb58a71924d48bf99ea19cf741f0c6ccf66",
      "original_position" : 796,
      "path" : "src/main.cpp",
      "position" : 1020,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17026905",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17027096"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17027096"
         }
      },
      "body" : "Do you want to be requesting headers from peers whose advertised block height is lower than our node's? They won't regognize the locator so they'll end up sending everything they have, which would surely be a waste of bandwidth and rarely helpful to our node.\r\n\r\nAlso, might it be better to change the default response to getheaders requests so that this doesn't happen?",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-03T01:17:26Z",
      "diff_hunk" : "@@ -4426,9 +4480,15 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n         state.rejects.clear();\n \n         // Start block sync\n-        if (pto->fStartSync && !fImporting && !fReindex) {\n-            pto->fStartSync = false;\n-            PushGetBlocks(pto, chainActive.Tip(), uint256(0));\n+        if (pindexBestHeader == NULL)\n+            pindexBestHeader = chainActive.Tip();\n+        if (!state.fSyncStarted && !pto->fClient && !pto->fInbound && !fImporting && !fReindex) {\n+            // Only actively request headers from a single peer, unless we're close to today.\n+            if (nSyncStarted == 0 || pindexBestHeader->GetBlockTime() > GetAdjustedTime() - 24 * 60 * 60) {\n+                state.fSyncStarted = true;\n+                nSyncStarted++;\n+                pto->PushMessage(\"getheaders\", chainActive.GetLocator(pindexBestHeader->pprev), uint256(0));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17027096",
      "id" : 17027096,
      "original_commit_id" : "2525afb58a71924d48bf99ea19cf741f0c6ccf66",
      "original_position" : 839,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17027096",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17027183"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17027183"
         }
      },
      "body" : "What happens when I send you a 400,000 header difficulty 1 fork (as an example) before you query someone else? A lower height does not necessarily mean a less preferable chain.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-03T01:20:44Z",
      "diff_hunk" : "@@ -4426,9 +4480,15 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n         state.rejects.clear();\n \n         // Start block sync\n-        if (pto->fStartSync && !fImporting && !fReindex) {\n-            pto->fStartSync = false;\n-            PushGetBlocks(pto, chainActive.Tip(), uint256(0));\n+        if (pindexBestHeader == NULL)\n+            pindexBestHeader = chainActive.Tip();\n+        if (!state.fSyncStarted && !pto->fClient && !pto->fInbound && !fImporting && !fReindex) {\n+            // Only actively request headers from a single peer, unless we're close to today.\n+            if (nSyncStarted == 0 || pindexBestHeader->GetBlockTime() > GetAdjustedTime() - 24 * 60 * 60) {\n+                state.fSyncStarted = true;\n+                nSyncStarted++;\n+                pto->PushMessage(\"getheaders\", chainActive.GetLocator(pindexBestHeader->pprev), uint256(0));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17027183",
      "id" : 17027183,
      "original_commit_id" : "2525afb58a71924d48bf99ea19cf741f0c6ccf66",
      "original_position" : 839,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17027183",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17027597"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17027597"
         }
      },
      "body" : "Because thats how GETHEADERS is defined in the protocol, as the comment notes changing it is an incompatible version change. See: https://en.bitcoin.it/wiki/Network#Messages. There needs to be some limit, or excessive memory consumption or message blocking happens.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-03T01:36:35Z",
      "diff_hunk" : "@@ -67,9 +67,17 @@ static const int MAX_SCRIPTCHECK_THREADS = 16;\n /** -par default (number of script-checking threads, 0 = auto) */\n static const int DEFAULT_SCRIPTCHECK_THREADS = 0;\n /** Number of blocks that can be requested at any given time from a single peer. */\n-static const int MAX_BLOCKS_IN_TRANSIT_PER_PEER = 128;\n-/** Timeout in seconds before considering a block download peer unresponsive. */\n-static const unsigned int BLOCK_DOWNLOAD_TIMEOUT = 60;\n+static const int MAX_BLOCKS_IN_TRANSIT_PER_PEER = 16;\n+/** Timeout in seconds during which a peer must stall block download progress before being disconnected. */\n+static const unsigned int BLOCK_STALLING_TIMEOUT = 2;\n+/** Number of headers sent in one getheaders result. We rely on the assumption that if a peer sends\n+ *  less than this number, we reached their tip. Changing this value is a protocol upgrade. */\n+static const unsigned int MAX_HEADERS_RESULTS = 2000;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17027597",
      "id" : 17027597,
      "original_commit_id" : "2525afb58a71924d48bf99ea19cf741f0c6ccf66",
      "original_position" : 12,
      "path" : "src/main.h",
      "position" : 12,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17027597",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17027628"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17027628"
         }
      },
      "body" : "@gmaxwell a 400000 header difficulty 1 fork would have a higher block height than our node. I'm suggesting we don't request headers from nodes with a lower block height than our node. The logic I'm proposing is in line with the previous logic the code had - i.e. we didn't getblocks from peers that had a lower height.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-03T01:38:30Z",
      "diff_hunk" : "@@ -4426,9 +4480,15 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n         state.rejects.clear();\n \n         // Start block sync\n-        if (pto->fStartSync && !fImporting && !fReindex) {\n-            pto->fStartSync = false;\n-            PushGetBlocks(pto, chainActive.Tip(), uint256(0));\n+        if (pindexBestHeader == NULL)\n+            pindexBestHeader = chainActive.Tip();\n+        if (!state.fSyncStarted && !pto->fClient && !pto->fInbound && !fImporting && !fReindex) {\n+            // Only actively request headers from a single peer, unless we're close to today.\n+            if (nSyncStarted == 0 || pindexBestHeader->GetBlockTime() > GetAdjustedTime() - 24 * 60 * 60) {\n+                state.fSyncStarted = true;\n+                nSyncStarted++;\n+                pto->PushMessage(\"getheaders\", chainActive.GetLocator(pindexBestHeader->pprev), uint256(0));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17027628",
      "id" : 17027628,
      "original_commit_id" : "2525afb58a71924d48bf99ea19cf741f0c6ccf66",
      "original_position" : 839,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17027628",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17027664"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17027664"
         }
      },
      "body" : "I understood what you were suggesting. If we're on the fork with more blocks we would never reorganize off it with your suggestion.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-03T01:40:01Z",
      "diff_hunk" : "@@ -4426,9 +4480,15 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n         state.rejects.clear();\n \n         // Start block sync\n-        if (pto->fStartSync && !fImporting && !fReindex) {\n-            pto->fStartSync = false;\n-            PushGetBlocks(pto, chainActive.Tip(), uint256(0));\n+        if (pindexBestHeader == NULL)\n+            pindexBestHeader = chainActive.Tip();\n+        if (!state.fSyncStarted && !pto->fClient && !pto->fInbound && !fImporting && !fReindex) {\n+            // Only actively request headers from a single peer, unless we're close to today.\n+            if (nSyncStarted == 0 || pindexBestHeader->GetBlockTime() > GetAdjustedTime() - 24 * 60 * 60) {\n+                state.fSyncStarted = true;\n+                nSyncStarted++;\n+                pto->PushMessage(\"getheaders\", chainActive.GetLocator(pindexBestHeader->pprev), uint256(0));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17027664",
      "id" : 17027664,
      "original_commit_id" : "2525afb58a71924d48bf99ea19cf741f0c6ccf66",
      "original_position" : 839,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17027664",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17028675"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17028675"
         }
      },
      "body" : "The protocol is defined in the source code.  Satoshi added getheaders a long time ago.\r\n",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-03T02:26:39Z",
      "diff_hunk" : "@@ -67,9 +67,17 @@ static const int MAX_SCRIPTCHECK_THREADS = 16;\n /** -par default (number of script-checking threads, 0 = auto) */\n static const int DEFAULT_SCRIPTCHECK_THREADS = 0;\n /** Number of blocks that can be requested at any given time from a single peer. */\n-static const int MAX_BLOCKS_IN_TRANSIT_PER_PEER = 128;\n-/** Timeout in seconds before considering a block download peer unresponsive. */\n-static const unsigned int BLOCK_DOWNLOAD_TIMEOUT = 60;\n+static const int MAX_BLOCKS_IN_TRANSIT_PER_PEER = 16;\n+/** Timeout in seconds during which a peer must stall block download progress before being disconnected. */\n+static const unsigned int BLOCK_STALLING_TIMEOUT = 2;\n+/** Number of headers sent in one getheaders result. We rely on the assumption that if a peer sends\n+ *  less than this number, we reached their tip. Changing this value is a protocol upgrade. */\n+static const unsigned int MAX_HEADERS_RESULTS = 2000;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17028675",
      "id" : 17028675,
      "original_commit_id" : "2525afb58a71924d48bf99ea19cf741f0c6ccf66",
      "original_position" : 12,
      "path" : "src/main.h",
      "position" : 12,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17028675",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17028716"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17028716"
         }
      },
      "body" : "The whitepaper just explains the high level concept of the Bitcoin consensus protocol. It describes none of the implementation details, and especially doesn't describe the P2P protocol.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-03T02:28:39Z",
      "diff_hunk" : "@@ -67,9 +67,17 @@ static const int MAX_SCRIPTCHECK_THREADS = 16;\n /** -par default (number of script-checking threads, 0 = auto) */\n static const int DEFAULT_SCRIPTCHECK_THREADS = 0;\n /** Number of blocks that can be requested at any given time from a single peer. */\n-static const int MAX_BLOCKS_IN_TRANSIT_PER_PEER = 128;\n-/** Timeout in seconds before considering a block download peer unresponsive. */\n-static const unsigned int BLOCK_DOWNLOAD_TIMEOUT = 60;\n+static const int MAX_BLOCKS_IN_TRANSIT_PER_PEER = 16;\n+/** Timeout in seconds during which a peer must stall block download progress before being disconnected. */\n+static const unsigned int BLOCK_STALLING_TIMEOUT = 2;\n+/** Number of headers sent in one getheaders result. We rely on the assumption that if a peer sends\n+ *  less than this number, we reached their tip. Changing this value is a protocol upgrade. */\n+static const unsigned int MAX_HEADERS_RESULTS = 2000;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17028716",
      "id" : 17028716,
      "original_commit_id" : "2525afb58a71924d48bf99ea19cf741f0c6ccf66",
      "original_position" : 12,
      "path" : "src/main.h",
      "position" : 12,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17028716",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17095155"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17095155"
         }
      },
      "body" : "Ok, I'm noticing this isn't ideal since using matt's bitcoinj node which sends the block before the node my node requests the block from sends it. Therefore, I'd suggest refining this to only consider it dos if it's not an \"addnode\" node AND we didn't request the block from this node.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-04T04:24:49Z",
      "diff_hunk" : "@@ -2480,6 +2534,10 @@ bool AcceptBlock(CBlock& block, CValidationState& state, CBlockIndex** ppindex,\n     if (!AcceptBlockHeader(block, state, &pindex))\n         return false;\n \n+    if (pindex->nStatus & BLOCK_HAVE_DATA) {\n+        return state.DoS(20, error(\"AcceptBlock() : already have block %d %s\", pindex->nHeight, pindex->GetBlockHash().ToString()), REJECT_DUPLICATE, \"duplicate\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17095155",
      "id" : 17095155,
      "original_commit_id" : "2525afb58a71924d48bf99ea19cf741f0c6ccf66",
      "original_position" : 525,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17095155",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17095164"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17095164"
         }
      },
      "body" : "oh no, you can't currently punish blocks you didn't request, because when a node _finds_ a block itself, it relays it without INVing. (IIRC)\r\n",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-04T04:25:30Z",
      "diff_hunk" : "@@ -2624,93 +2672,25 @@ void CBlockIndex::BuildSkip()\n         pskip = pprev->GetAncestor(GetSkipHeight(nHeight));\n }\n \n-void PushGetBlocks(CNode* pnode, CBlockIndex* pindexBegin, uint256 hashEnd)\n-{\n-    AssertLockHeld(cs_main);\n-    // Filter out duplicate requests\n-    if (pindexBegin == pnode->pindexLastGetBlocksBegin && hashEnd == pnode->hashLastGetBlocksEnd)\n-        return;\n-    pnode->pindexLastGetBlocksBegin = pindexBegin;\n-    pnode->hashLastGetBlocksEnd = hashEnd;\n-\n-    pnode->PushMessage(\"getblocks\", chainActive.GetLocator(pindexBegin), hashEnd);\n-}\n-\n bool ProcessBlock(CValidationState &state, CNode* pfrom, CBlock* pblock, CDiskBlockPos *dbp)\n {\n-    // Check for duplicate",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17095164",
      "id" : 17095164,
      "original_commit_id" : "eb7822c91bc71b1e4f0e6e1b04de76c8eabd65ab",
      "original_position" : 499,
      "path" : "src/main.cpp",
      "position" : 668,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17095164",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "@sipa Regarding this pull breaking re-orgs - why doesn't it, instead of adding out of order blocks to the leveldb, deal with those blocks in the same way it used to do with orphans? (or a temporary database where they are deleted when added to the block index).",
      "created_at" : "2014-09-04T05:07:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-54408046",
      "id" : 54408046,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-09-04T05:07:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54408046",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "body" : "This pull does not break re-orgs. (And as an aside, storing blocks in memory is not acceptable because it may cause very high peak memory usage)",
      "created_at" : "2014-09-04T05:12:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-54408266",
      "id" : 54408266,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-09-04T05:12:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54408266",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "@gmaxwell Sorry, I meant reindexing. Yes, I agree not good to store in memory. I don't know enough about why it breaks reindexing, but I'm assuming a separate database would be the answer (for the out-of-order blocks, which would then be added to the main database in order),.",
      "created_at" : "2014-09-04T07:46:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-54424004",
      "id" : 54424004,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-09-04T07:47:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54424004",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "body" : "Reindexing should just handle out of order blocks exactly as headers first does, no need for a separate database. Reindexing works like a peer feeding us blocks, with headers first it should be made like the headers first process e.g. scan the blocks on disk to learn their headers, add them to the block index, and then connect them as we can.\r\n",
      "created_at" : "2014-09-04T07:52:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-54424950",
      "id" : 54424950,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-09-04T07:52:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54424950",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17101393"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17101393"
         }
      },
      "body" : "That only happens for just-mined blocks - peers shouldn't ever have those already?",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-04T08:39:21Z",
      "diff_hunk" : "@@ -2624,93 +2672,25 @@ void CBlockIndex::BuildSkip()\n         pskip = pprev->GetAncestor(GetSkipHeight(nHeight));\n }\n \n-void PushGetBlocks(CNode* pnode, CBlockIndex* pindexBegin, uint256 hashEnd)\n-{\n-    AssertLockHeld(cs_main);\n-    // Filter out duplicate requests\n-    if (pindexBegin == pnode->pindexLastGetBlocksBegin && hashEnd == pnode->hashLastGetBlocksEnd)\n-        return;\n-    pnode->pindexLastGetBlocksBegin = pindexBegin;\n-    pnode->hashLastGetBlocksEnd = hashEnd;\n-\n-    pnode->PushMessage(\"getblocks\", chainActive.GetLocator(pindexBegin), hashEnd);\n-}\n-\n bool ProcessBlock(CValidationState &state, CNode* pfrom, CBlock* pblock, CDiskBlockPos *dbp)\n {\n-    // Check for duplicate",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17101393",
      "id" : 17101393,
      "original_commit_id" : "eb7822c91bc71b1e4f0e6e1b04de76c8eabd65ab",
      "original_position" : 499,
      "path" : "src/main.cpp",
      "position" : 668,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17101393",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17101446"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17101446"
         }
      },
      "body" : "Making MAX_HEADERS_RESULTS dynamic is possible, but it would be a protocol change. Right now, it is correct w.r.t. other nodes out there.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-04T08:40:57Z",
      "diff_hunk" : "@@ -3935,22 +3945,66 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n     }\n \n \n+    else if (strCommand == \"headers\" && !fImporting && !fReindex) // Ignore headers received while importing\n+    {\n+        std::vector<CBlockHeader> headers;\n+\n+        // Bypass the normal CBlock deserialization, as we don't want to risk deserializing 2000 full blocks.\n+        unsigned int nCount = ReadCompactSize(vRecv);\n+        if (nCount > MAX_HEADERS_RESULTS) {\n+            Misbehaving(pfrom->GetId(), 20);\n+            return error(\"headers message size = %u\", nCount);\n+        }\n+        headers.resize(nCount);\n+        for (unsigned int n = 0; n < nCount; n++) {\n+            vRecv >> headers[n];\n+            ReadCompactSize(vRecv); // ignore tx count; assume it is 0.\n+        }\n+\n+        LOCK(cs_main);\n+\n+        if (nCount == 0) {\n+            // Nothing interesting. Stop asking this peers for more headers.\n+            return true;\n+        }\n+\n+        CBlockIndex *pindexLast = NULL;\n+        BOOST_FOREACH(const CBlockHeader& header, headers) {\n+            CValidationState state;\n+            if (pindexLast != NULL && header.hashPrevBlock != pindexLast->GetBlockHash()) {\n+                Misbehaving(pfrom->GetId(), 20);\n+                return error(\"non-continuous headers sequence\");\n+            }\n+            if (!AcceptBlockHeader(header, state, &pindexLast)) {\n+                int nDoS;\n+                if (state.IsInvalid(nDoS)) {\n+                    if (nDoS > 0)\n+                        Misbehaving(pfrom->GetId(), nDoS);\n+                    return error(\"invalid header received\");\n+                }\n+            }\n+        }\n+\n+        if (pindexLast)\n+            UpdateBlockAvailability(pfrom->GetId(), pindexLast->GetBlockHash());\n+\n+        if (nCount == MAX_HEADERS_RESULTS && pindexLast) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17101446",
      "id" : 17101446,
      "original_commit_id" : "2525afb58a71924d48bf99ea19cf741f0c6ccf66",
      "original_position" : 796,
      "path" : "src/main.cpp",
      "position" : 1020,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17101446",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17101528"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17101528"
         }
      },
      "body" : "@rebroad Locators contain block hashes of exponentially increasing age; it's very unlikely they'll send everything they have. There are certainly possible heuristics to improve this, but making sure it works correctly has priority now.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-04T08:43:14Z",
      "diff_hunk" : "@@ -4426,9 +4480,15 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n         state.rejects.clear();\n \n         // Start block sync\n-        if (pto->fStartSync && !fImporting && !fReindex) {\n-            pto->fStartSync = false;\n-            PushGetBlocks(pto, chainActive.Tip(), uint256(0));\n+        if (pindexBestHeader == NULL)\n+            pindexBestHeader = chainActive.Tip();\n+        if (!state.fSyncStarted && !pto->fClient && !pto->fInbound && !fImporting && !fReindex) {\n+            // Only actively request headers from a single peer, unless we're close to today.\n+            if (nSyncStarted == 0 || pindexBestHeader->GetBlockTime() > GetAdjustedTime() - 24 * 60 * 60) {\n+                state.fSyncStarted = true;\n+                nSyncStarted++;\n+                pto->PushMessage(\"getheaders\", chainActive.GetLocator(pindexBestHeader->pprev), uint256(0));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17101528",
      "id" : 17101528,
      "original_commit_id" : "2525afb58a71924d48bf99ea19cf741f0c6ccf66",
      "original_position" : 839,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17101528",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17101581"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17101581"
         }
      },
      "body" : "I would suggest using the whitelisting mechanism for that.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-04T08:44:57Z",
      "diff_hunk" : "@@ -2480,6 +2534,10 @@ bool AcceptBlock(CBlock& block, CValidationState& state, CBlockIndex** ppindex,\n     if (!AcceptBlockHeader(block, state, &pindex))\n         return false;\n \n+    if (pindex->nStatus & BLOCK_HAVE_DATA) {\n+        return state.DoS(20, error(\"AcceptBlock() : already have block %d %s\", pindex->nHeight, pindex->GetBlockHash().ToString()), REJECT_DUPLICATE, \"duplicate\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17101581",
      "id" : 17101581,
      "original_commit_id" : "2525afb58a71924d48bf99ea19cf741f0c6ccf66",
      "original_position" : 525,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17101581",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17101642"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17101642"
         }
      },
      "body" : "hold on... it won't be possible to receive a duplicate block from a miner, so yes, this would be DoS.\r\n\r\n@gmaxwell can you see what I'm saying here?",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-04T08:46:27Z",
      "diff_hunk" : "@@ -2624,93 +2672,25 @@ void CBlockIndex::BuildSkip()\n         pskip = pprev->GetAncestor(GetSkipHeight(nHeight));\n }\n \n-void PushGetBlocks(CNode* pnode, CBlockIndex* pindexBegin, uint256 hashEnd)\n-{\n-    AssertLockHeld(cs_main);\n-    // Filter out duplicate requests\n-    if (pindexBegin == pnode->pindexLastGetBlocksBegin && hashEnd == pnode->hashLastGetBlocksEnd)\n-        return;\n-    pnode->pindexLastGetBlocksBegin = pindexBegin;\n-    pnode->hashLastGetBlocksEnd = hashEnd;\n-\n-    pnode->PushMessage(\"getblocks\", chainActive.GetLocator(pindexBegin), hashEnd);\n-}\n-\n bool ProcessBlock(CValidationState &state, CNode* pfrom, CBlock* pblock, CDiskBlockPos *dbp)\n {\n-    // Check for duplicate",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17101642",
      "id" : 17101642,
      "original_commit_id" : "eb7822c91bc71b1e4f0e6e1b04de76c8eabd65ab",
      "original_position" : 499,
      "path" : "src/main.cpp",
      "position" : 668,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17101642",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17101860"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17101860"
         }
      },
      "body" : "I'm responding to the comments, not the code if it's only on duplicates and not just non-requested then I think its safe but only if we release note loudly.  Right now I think eloipool users will end up GBT submitting blocks to multiple Bitcoinds which will then aggressively relay.  It's bandwidth wasteful and it shouldn't be permitted. This is a borderline p2p protocol change, I think.\r\n\r\nThough relaynodeclient should do an INV it's local, this is going to add like... 1ms. And it would also let the client better track when it's the software providing the block.  Same with p2pool. Though indeed, whitelisting also covers these cases.\r\n",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-04T08:51:59Z",
      "diff_hunk" : "@@ -2624,93 +2672,25 @@ void CBlockIndex::BuildSkip()\n         pskip = pprev->GetAncestor(GetSkipHeight(nHeight));\n }\n \n-void PushGetBlocks(CNode* pnode, CBlockIndex* pindexBegin, uint256 hashEnd)\n-{\n-    AssertLockHeld(cs_main);\n-    // Filter out duplicate requests\n-    if (pindexBegin == pnode->pindexLastGetBlocksBegin && hashEnd == pnode->hashLastGetBlocksEnd)\n-        return;\n-    pnode->pindexLastGetBlocksBegin = pindexBegin;\n-    pnode->hashLastGetBlocksEnd = hashEnd;\n-\n-    pnode->PushMessage(\"getblocks\", chainActive.GetLocator(pindexBegin), hashEnd);\n-}\n-\n bool ProcessBlock(CValidationState &state, CNode* pfrom, CBlock* pblock, CDiskBlockPos *dbp)\n {\n-    // Check for duplicate",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17101860",
      "id" : 17101860,
      "original_commit_id" : "eb7822c91bc71b1e4f0e6e1b04de76c8eabd65ab",
      "original_position" : 499,
      "path" : "src/main.cpp",
      "position" : 668,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17101860",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17102257"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17102257"
         }
      },
      "body" : "@sipa However, you do still need to make sure not to DoS a node for sending a block that you've requested. So far, this logic isn't in there. This happened to me today when I got the inv from the non-miner, but the miner sent the block directly and it arrived from them first. My node requested the block from the node that sent the inv, and then DoSed it when it received it - it was only doing what it was asked to, so shouldn't have been DoSed.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-04T09:00:22Z",
      "diff_hunk" : "@@ -2624,93 +2672,25 @@ void CBlockIndex::BuildSkip()\n         pskip = pprev->GetAncestor(GetSkipHeight(nHeight));\n }\n \n-void PushGetBlocks(CNode* pnode, CBlockIndex* pindexBegin, uint256 hashEnd)\n-{\n-    AssertLockHeld(cs_main);\n-    // Filter out duplicate requests\n-    if (pindexBegin == pnode->pindexLastGetBlocksBegin && hashEnd == pnode->hashLastGetBlocksEnd)\n-        return;\n-    pnode->pindexLastGetBlocksBegin = pindexBegin;\n-    pnode->hashLastGetBlocksEnd = hashEnd;\n-\n-    pnode->PushMessage(\"getblocks\", chainActive.GetLocator(pindexBegin), hashEnd);\n-}\n-\n bool ProcessBlock(CValidationState &state, CNode* pfrom, CBlock* pblock, CDiskBlockPos *dbp)\n {\n-    // Check for duplicate",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17102257",
      "id" : 17102257,
      "original_commit_id" : "eb7822c91bc71b1e4f0e6e1b04de76c8eabd65ab",
      "original_position" : 499,
      "path" : "src/main.cpp",
      "position" : 668,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17102257",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "body" : "@gmaxwell That's not exactly true. When receiving from network, we always have all the parent headers before processing a block, so it can just be entered into our block tree. When reindexing, that is not the case, and there is actually need for some handling of \"orphan headers\".",
      "created_at" : "2014-09-04T09:02:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-54435516",
      "id" : 54435516,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-09-04T09:02:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54435516",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17102944"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17102944"
         }
      },
      "body" : "@rebroad That's a good point. I'm not sure how to deal with that correctly.\r\n* Making an exception for allowing a duplicate block to be received if we actually requested it is possible, but requires extra logic.\r\n* Not DoS/disconnecting in case of any duplicate is easy, but doesn't really encourage low bandwidth operation.\r\n\r\nPreviously my position was that sending-without-inv was safe in case you know the peer does not have the data yet. Your case is a good counterexample for that, and perhaps the right solution is indeed just to argue for a protocol change that makes sending-without-inv illegal.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-04T09:16:09Z",
      "diff_hunk" : "@@ -2624,93 +2672,25 @@ void CBlockIndex::BuildSkip()\n         pskip = pprev->GetAncestor(GetSkipHeight(nHeight));\n }\n \n-void PushGetBlocks(CNode* pnode, CBlockIndex* pindexBegin, uint256 hashEnd)\n-{\n-    AssertLockHeld(cs_main);\n-    // Filter out duplicate requests\n-    if (pindexBegin == pnode->pindexLastGetBlocksBegin && hashEnd == pnode->hashLastGetBlocksEnd)\n-        return;\n-    pnode->pindexLastGetBlocksBegin = pindexBegin;\n-    pnode->hashLastGetBlocksEnd = hashEnd;\n-\n-    pnode->PushMessage(\"getblocks\", chainActive.GetLocator(pindexBegin), hashEnd);\n-}\n-\n bool ProcessBlock(CValidationState &state, CNode* pfrom, CBlock* pblock, CDiskBlockPos *dbp)\n {\n-    // Check for duplicate",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17102944",
      "id" : 17102944,
      "original_commit_id" : "eb7822c91bc71b1e4f0e6e1b04de76c8eabd65ab",
      "original_position" : 499,
      "path" : "src/main.cpp",
      "position" : 668,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17102944",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17103423"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17103423"
         }
      },
      "body" : "Perhaps define that as of protocol X we'll never do that ourselves anymore, and enforce it. Later minimum support advances past protocol X.  Seems like such a minor change to bother staging",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-04T09:26:23Z",
      "diff_hunk" : "@@ -2624,93 +2672,25 @@ void CBlockIndex::BuildSkip()\n         pskip = pprev->GetAncestor(GetSkipHeight(nHeight));\n }\n \n-void PushGetBlocks(CNode* pnode, CBlockIndex* pindexBegin, uint256 hashEnd)\n-{\n-    AssertLockHeld(cs_main);\n-    // Filter out duplicate requests\n-    if (pindexBegin == pnode->pindexLastGetBlocksBegin && hashEnd == pnode->hashLastGetBlocksEnd)\n-        return;\n-    pnode->pindexLastGetBlocksBegin = pindexBegin;\n-    pnode->hashLastGetBlocksEnd = hashEnd;\n-\n-    pnode->PushMessage(\"getblocks\", chainActive.GetLocator(pindexBegin), hashEnd);\n-}\n-\n bool ProcessBlock(CValidationState &state, CNode* pfrom, CBlock* pblock, CDiskBlockPos *dbp)\n {\n-    // Check for duplicate",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17103423",
      "id" : 17103423,
      "original_commit_id" : "eb7822c91bc71b1e4f0e6e1b04de76c8eabd65ab",
      "original_position" : 499,
      "path" : "src/main.cpp",
      "position" : 668,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17103423",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Rebased and removed the DoS banning for duplicate blocks (but left as a TODO).",
      "created_at" : "2014-09-04T09:49:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-54442972",
      "id" : 54442972,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-09-04T09:49:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54442972",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17106379"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17106379"
         }
      },
      "body" : "@sipa more simply, miners can still send the block without it being requested, as long as they send the \"inv\" just before it (so that nodes don't think they're not receiving the block until it arrives). This way they'll very unlikely get banned since their invs will almost always be received before anyone else's.\r\n\r\nThe code can be changed easily to do what it did before, which is to record which node sent the block and compare if it was the node that it was requested from. Then just change the DoS logic over to the node that sent it unsolicted rather than the node that the block arrived from later.\r\n\r\nThe node that sent me the block without an inv was public.au.relay.mattcorallo.com:8335 - so maybe someone can submit a pull request to his software so that invs are sent immediatley before the block is sent.\r\n\r\n@TheBlueMatt ",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-04T10:45:34Z",
      "diff_hunk" : "@@ -2624,93 +2672,25 @@ void CBlockIndex::BuildSkip()\n         pskip = pprev->GetAncestor(GetSkipHeight(nHeight));\n }\n \n-void PushGetBlocks(CNode* pnode, CBlockIndex* pindexBegin, uint256 hashEnd)\n-{\n-    AssertLockHeld(cs_main);\n-    // Filter out duplicate requests\n-    if (pindexBegin == pnode->pindexLastGetBlocksBegin && hashEnd == pnode->hashLastGetBlocksEnd)\n-        return;\n-    pnode->pindexLastGetBlocksBegin = pindexBegin;\n-    pnode->hashLastGetBlocksEnd = hashEnd;\n-\n-    pnode->PushMessage(\"getblocks\", chainActive.GetLocator(pindexBegin), hashEnd);\n-}\n-\n bool ProcessBlock(CValidationState &state, CNode* pfrom, CBlock* pblock, CDiskBlockPos *dbp)\n {\n-    // Check for duplicate",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17106379",
      "id" : 17106379,
      "original_commit_id" : "eb7822c91bc71b1e4f0e6e1b04de76c8eabd65ab",
      "original_position" : 499,
      "path" : "src/main.cpp",
      "position" : 668,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17106379",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "body" : "@sipa Shall I provide a patch to the duplicate block DoS stuff and submit it as a pull request to this branch?",
      "created_at" : "2014-09-04T10:53:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-54452128",
      "id" : 54452128,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-09-04T10:53:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54452128",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "body" : "The stalled block detection math is wrong I think:-\r\n\r\n2014-09-05 05:52:50 inv (get) block 00000000000000000ecadcd9cfa2f30ae66783aa07b53355f97f1b90a4999694 from peer=95\r\n2014-09-05 05:52:50 received 1 headers from peer=95\r\n2014-09-05 05:52:50 Stall started peer=95\r\n2014-09-05 05:52:53 nNow=1409896373020224 nStallingSince=1409896370957264\r\n2014-09-05 05:52:53 Peer=95 is stalling block download, disconnecting\r\n2014-09-05 05:52:53 disconnecting peer=95\r\n\r\nI added a couple of debug lines. Looks like the 1000000 difference is too small as this equates to about 3 seconds rather than 2 minutes.\r\n\r\nBy the way, why use micros rather than millis?",
      "created_at" : "2014-09-05T06:09:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-54588619",
      "id" : 54588619,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-09-05T06:14:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54588619",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17206129"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17206129"
         }
      },
      "body" : "Also, why send the pprev rather than the latest as the locator?\r\n\r\nI still don't understand why we would want to get only 1 header from up-to-date nodes, but tens of thousands of headers from not-up-to-date nodes...",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-06T01:54:41Z",
      "diff_hunk" : "@@ -4426,9 +4480,15 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n         state.rejects.clear();\n \n         // Start block sync\n-        if (pto->fStartSync && !fImporting && !fReindex) {\n-            pto->fStartSync = false;\n-            PushGetBlocks(pto, chainActive.Tip(), uint256(0));\n+        if (pindexBestHeader == NULL)\n+            pindexBestHeader = chainActive.Tip();\n+        if (!state.fSyncStarted && !pto->fClient && !pto->fInbound && !fImporting && !fReindex) {\n+            // Only actively request headers from a single peer, unless we're close to today.\n+            if (nSyncStarted == 0 || pindexBestHeader->GetBlockTime() > GetAdjustedTime() - 24 * 60 * 60) {\n+                state.fSyncStarted = true;\n+                nSyncStarted++;\n+                pto->PushMessage(\"getheaders\", chainActive.GetLocator(pindexBestHeader->pprev), uint256(0));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17206129",
      "id" : 17206129,
      "original_commit_id" : "2525afb58a71924d48bf99ea19cf741f0c6ccf66",
      "original_position" : 839,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17206129",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "body" : "Found a bug - it getdatas blocks even when the same block has already been received (but not processed). debug.log extract:-\r\n\r\n2014-09-06 05:56:20 inv (get) block 000000000000000002498192998dc2fbe440f3d37282e8e5b3c2ab19873a3ecb from peer=18\r\n2014-09-06 05:56:20 getheaders (319311) 000000000000000002498192998dc2fbe440f3d37282e8e5b3c2ab19873a3ecb to peer=18\r\n2014-09-06 05:56:21 inv (get) block 000000000000000002498192998dc2fbe440f3d37282e8e5b3c2ab19873a3ecb from peer=13\r\n2014-09-06 05:56:21 getheaders (319311) 000000000000000002498192998dc2fbe440f3d37282e8e5b3c2ab19873a3ecb to peer=13\r\n2014-09-06 05:56:21 received 7 headers (319312 to 319318) from peer=18 (startheight:319317)\r\n2014-09-06 05:56:21 Requesting block 0000000000000000164de10a34768067aeaa95a0790472015d928b9bee4caeb8 (319310) peer=18\r\n2014-09-06 05:56:21 Requesting block 00000000000000002720bb210d88b74be81df1eaee857a287cb6adcb027c5ef8 (319311) peer=18\r\n<--snip-->\r\n2014-09-06 05:56:21 Requesting block 000000000000000011165e5ecfd4c7f26cca6c29cce97e0533d047a562ef2888 (319317) peer=18\r\n2014-09-06 05:56:21 inv block 000000000000000002498192998dc2fbe440f3d37282e8e5b3c2ab19873a3ecb (height:319318) from peer=4\r\n2014-09-06 05:56:21 received 7 headers (319312 to 319318) from peer=13 (startheight:319317)\r\n2014-09-06 05:56:22 received block 000000000000000002498192998dc2fbe440f3d37282e8e5b3c2ab19873a3ecb peer=18\r\n2014-09-06 05:56:27 received block 000000000000000002498192998dc2fbe440f3d37282e8e5b3c2ab19873a3ecb peer=13\r\n2014-09-06 05:56:27 ERROR: AcceptBlock() : already have block 319318 000000000000000002498192998dc2fbe440f3d37282e8e5b3c2ab19873a3ecb\r\n2014-09-06 05:56:27 ERROR: ProcessBlock() : AcceptBlock FAILED\r\n2014-09-06 05:56:28 received block 0000000000000000164de10a34768067aeaa95a0790472015d928b9bee4caeb8 peer=18\r\n\r\nCuriously, the getdata block was done without the corresponding \"Requesting block\" logged...",
      "created_at" : "2014-09-06T06:49:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-54704558",
      "id" : 54704558,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-09-06T06:51:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54704558",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "body" : "Another interesting feature is that when a new block inv is seen, it both getheaders the node and getdata's the block in the hope that the headers arrive first. However, if the block arrives before the headers, and the previous block hasn't been fetched yet, it will actually DoS the node the sent the block because it doesn't have the previous block... ",
      "created_at" : "2014-09-06T06:57:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-54704697",
      "id" : 54704697,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-09-06T06:57:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54704697",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17209324"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17209324"
         }
      },
      "body" : "Headers do not contain the number of transactions, and just changing the protocol to also report it along with headers is pretty pointless, as the data is not verifiable.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-06T15:48:30Z",
      "diff_hunk" : "@@ -2297,9 +2347,13 @@ bool AcceptBlockHeader(CBlockHeader& block, CValidationState& state, CBlockIndex\n     BlockMap::iterator miSelf = mapBlockIndex.find(hash);\n     CBlockIndex *pindex = NULL;\n     if (miSelf != mapBlockIndex.end()) {\n+        // Block header is already known.\n         pindex = miSelf->second;\n+        if (ppindex)\n+            *ppindex = pindex;\n         if (pindex->nStatus & BLOCK_FAILED_MASK)\n             return state.Invalid(error(\"AcceptBlock() : block is marked invalid\"), 0, \"duplicate\");\n+        return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17209324",
      "id" : 17209324,
      "original_commit_id" : "185fa1d82387fc4b88b5b3ccf3b637583beae04c",
      "original_position" : 516,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17209324",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "@rebroad You're right to point out that the request of headers + getdata of an inved block simultaneously makes an assumption about the order in which the peer will process them. However, it's a very reasonable assumption to make, as there are already systems that rely on this assumption (though not for block propagation). I would argue that it's already implicitly part of the protocol definition.",
      "created_at" : "2014-09-06T15:53:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-54716169",
      "id" : 54716169,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-09-06T15:53:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54716169",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "@rebroad I fixed the stalling detection (still testing it, now). The older version sometimes triggered when there was just a single block in flight, which is silly. Stalling peer P is now strictly defined as \"we can't download anything from peer Q (!= P), because all blocks in the download window are in flight, and we're waiting for a block from P for the window to move\".\r\n\r\nThe timeout value is correct, however, it's intended to be just 2 seconds (see the comment above the definition, even). This is just to prevent us from disconnecting peers because we haven't had a chance to process anything from them.",
      "created_at" : "2014-09-06T15:58:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-54716321",
      "id" : 54716321,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-09-06T15:58:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54716321",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "@rebroad If a block is _ever_ simultaneously requested multiple times, that's a bug. Looking at the code, I don't see how that would be possible. Both block `getdata` code paths (direct request on inv when caught up, and from sendmessages as part of the normal parallel block fetching) check both whether it's not already marked BLOCK_HAVE_DATA or in mapBlocksInFlight, and the transition between them (in ProcessBlock) happens while holding cs_main.\r\n\r\nPlease report if you see that happen again.",
      "created_at" : "2014-09-06T16:13:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-54716791",
      "id" : 54716791,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-09-06T16:13:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54716791",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Added a commit: removing pow's CheckMinWork, which verified whether an nBits/nTime was possible, without knowing the parents. As we always know all headers before validation, this is no longer necessary.",
      "created_at" : "2014-09-06T19:18:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-54725302",
      "id" : 54725302,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-09-06T19:18:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54725302",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17212803"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17212803"
         }
      },
      "body" : "```\r\nmain.cpp: In function 'void {anonymous}::FindNextBlocksToDownload(NodeId, unsigned int, std::vector<CBlockIndex*>&, NodeId&)':\r\nmain.cpp:407:67: warning: comparison between signed and unsigned integer expressions [-Wsign-compare]\r\n                 if ((int)pindex->nHeight > chainActive.Height() + BLOCK_DOWNLOAD_WINDOW) {\r\n                                                                   ^\r\n```",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-07T03:59:21Z",
      "diff_hunk" : "@@ -355,6 +327,103 @@ void UpdateBlockAvailability(NodeId nodeid, const uint256 &hash) {\n     }\n }\n \n+/** Find the last common ancestor two blocks have.\n+ *  Both pa and pb must be non-NULL. */\n+CBlockIndex* LastCommonAncestor(CBlockIndex* pa, CBlockIndex* pb) {\n+    if (pa->nHeight > pb->nHeight) {\n+        pa = pa->GetAncestor(pb->nHeight);\n+    } else if (pb->nHeight > pa->nHeight) {\n+        pb = pb->GetAncestor(pa->nHeight);\n+    }\n+\n+    while (pa != pb && pa && pb) {\n+        pa = pa->pprev;\n+        pb = pb->pprev;\n+    }\n+\n+    // Eventually all chain branches meet at the genesis block.\n+    assert(pa == pb);\n+    return pa;\n+}\n+\n+/** Update pindexLastCommonBlock and add not-in-flight missing successors to vBlocks, until it has\n+ *  at most count entries. */\n+void FindNextBlocksToDownload(NodeId nodeid, unsigned int count, std::vector<CBlockIndex*>& vBlocks, NodeId& nodeStaller) {\n+    if (count == 0)\n+        return;\n+\n+    vBlocks.reserve(vBlocks.size() + count);\n+    CNodeState *state = State(nodeid);\n+    assert(state != NULL);\n+\n+    // Make sure pindexBestKnownBlock is up to date, we'll need it.\n+    ProcessBlockAvailability(nodeid);\n+\n+    if (state->pindexBestKnownBlock == NULL || state->pindexBestKnownBlock->nChainWork < chainActive.Tip()->nChainWork) {\n+        // This peer has nothing interesting.\n+        return;\n+    }\n+\n+    if (state->pindexLastCommonBlock == NULL) {\n+        // Bootstrap quickly by guessing a parent of our best tip is the forking point.\n+        // Guessing wrong in either direction is not a problem.\n+        state->pindexLastCommonBlock = chainActive[std::min(state->pindexBestKnownBlock->nHeight, chainActive.Height())];\n+    }\n+\n+    // If the peer reorganized, our previous pindexLastCommonBlock may not be an ancestor\n+    // of their current tip anymore. Go back enough to fix that.\n+    state->pindexLastCommonBlock = LastCommonAncestor(state->pindexLastCommonBlock, state->pindexBestKnownBlock);\n+    if (state->pindexLastCommonBlock == state->pindexBestKnownBlock)\n+        return;\n+\n+    std::vector<CBlockIndex*> vToFetch;\n+    CBlockIndex *pindexWalk = state->pindexLastCommonBlock;\n+    // Never fetch further than the best block we know the peer has, or more than BLOCK_DOWNLOAD_WINDOW + 1 beyond our\n+    // current tip. The +1 is so we can detect stalling, namely if we would be able to download that next block if the\n+    // window were 1 larger.\n+    int nMaxHeight = std::min<int>(state->pindexBestKnownBlock->nHeight, chainActive.Height() + BLOCK_DOWNLOAD_WINDOW + 1);\n+    NodeId waitingfor = -1;\n+    while (pindexWalk->nHeight < nMaxHeight) {\n+        // Read up to 128 (or more, if more blocks than that are needed) successors of pindexWalk (towards\n+        // pindexBestKnownBlock) into vToFetch. We fetch 128, because CBlockIndex::GetAncestor may be as expensive\n+        // as iterating over ~100 CBlockIndex* entries anyway.\n+        int nToFetch = std::min(nMaxHeight - pindexWalk->nHeight, std::max<int>(count - vBlocks.size(), 128));\n+        vToFetch.resize(nToFetch);\n+        pindexWalk = state->pindexBestKnownBlock->GetAncestor(pindexWalk->nHeight + nToFetch);\n+        vToFetch[nToFetch - 1] = pindexWalk;\n+        for (unsigned int i = nToFetch - 1; i > 0; i--) {\n+            vToFetch[i - 1] = vToFetch[i]->pprev;\n+        }\n+\n+        // Iterate over those blocks in vToFetch (in forward direction), adding the ones that\n+        // are not yet downloaded and not in flight to vBlocks. In the mean time, update\n+        // pindexLastCommonBlock as long as all ancestors are already downloaded.\n+        BOOST_FOREACH(CBlockIndex* pindex, vToFetch) {\n+            if (pindex->nStatus & BLOCK_HAVE_DATA) {\n+                if (pindex->nChainTx)\n+                    state->pindexLastCommonBlock = pindex;\n+            } else if (mapBlocksInFlight.count(pindex->GetBlockHash()) == 0) {\n+                // The block is not already downloaded, and not yet in flight.\n+                if ((int)pindex->nHeight > chainActive.Height() + BLOCK_DOWNLOAD_WINDOW) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17212803",
      "id" : 17212803,
      "original_commit_id" : "33bdf0da33859e69fa21fc6ed4a1fc4b58d81a15",
      "original_position" : 237,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17212803",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1096010?v=3",
         "events_url" : "https://api.github.com/users/Arnavion/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Arnavion/followers",
         "following_url" : "https://api.github.com/users/Arnavion/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Arnavion/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Arnavion",
         "id" : 1096010,
         "login" : "Arnavion",
         "organizations_url" : "https://api.github.com/users/Arnavion/orgs",
         "received_events_url" : "https://api.github.com/users/Arnavion/received_events",
         "repos_url" : "https://api.github.com/users/Arnavion/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Arnavion/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Arnavion/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Arnavion"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17213621"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17213621"
         }
      },
      "body" : "https://en.bitcoin.it/wiki/Header#Block_Headers says that there is a field for the number of transactions - why isn't this used?",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-07T08:40:12Z",
      "diff_hunk" : "@@ -2297,9 +2347,13 @@ bool AcceptBlockHeader(CBlockHeader& block, CValidationState& state, CBlockIndex\n     BlockMap::iterator miSelf = mapBlockIndex.find(hash);\n     CBlockIndex *pindex = NULL;\n     if (miSelf != mapBlockIndex.end()) {\n+        // Block header is already known.\n         pindex = miSelf->second;\n+        if (ppindex)\n+            *ppindex = pindex;\n         if (pindex->nStatus & BLOCK_FAILED_MASK)\n             return state.Invalid(error(\"AcceptBlock() : block is marked invalid\"), 0, \"duplicate\");\n+        return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17213621",
      "id" : 17213621,
      "original_commit_id" : "185fa1d82387fc4b88b5b3ccf3b637583beae04c",
      "original_position" : 516,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17213621",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17214124"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17214124"
         }
      },
      "body" : "It lists the number of transactions contained within the same message. For\n'headers', this number is always 0. This is because historically,\nCBlockHeader did not exist, and just a CBlock without transactions was sent.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-07T10:58:00Z",
      "diff_hunk" : "@@ -2297,9 +2347,13 @@ bool AcceptBlockHeader(CBlockHeader& block, CValidationState& state, CBlockIndex\n     BlockMap::iterator miSelf = mapBlockIndex.find(hash);\n     CBlockIndex *pindex = NULL;\n     if (miSelf != mapBlockIndex.end()) {\n+        // Block header is already known.\n         pindex = miSelf->second;\n+        if (ppindex)\n+            *ppindex = pindex;\n         if (pindex->nStatus & BLOCK_FAILED_MASK)\n             return state.Invalid(error(\"AcceptBlock() : block is marked invalid\"), 0, \"duplicate\");\n+        return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17214124",
      "id" : 17214124,
      "original_commit_id" : "185fa1d82387fc4b88b5b3ccf3b637583beae04c",
      "original_position" : 516,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17214124",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17214196"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17214196"
         }
      },
      "body" : "we don't need to prevent memory fill due to spam any longer?",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-07T11:18:57Z",
      "diff_hunk" : "@@ -2297,26 +2350,13 @@ bool AcceptBlockHeader(CBlockHeader& block, CValidationState& state, CBlockIndex\n     BlockMap::iterator miSelf = mapBlockIndex.find(hash);\n     CBlockIndex *pindex = NULL;\n     if (miSelf != mapBlockIndex.end()) {\n+        // Block header is already known.\n         pindex = miSelf->second;\n+        if (ppindex)\n+            *ppindex = pindex;\n         if (pindex->nStatus & BLOCK_FAILED_MASK)\n             return state.Invalid(error(\"AcceptBlock() : block is marked invalid\"), 0, \"duplicate\");\n-    }\n-\n-    CBlockIndex* pcheckpoint = Checkpoints::GetLastCheckpoint();\n-    if (pcheckpoint && block.hashPrevBlock != (chainActive.Tip() ? chainActive.Tip()->GetBlockHash() : uint256(0)))\n-    {\n-        // Extra checks to prevent \"fill up memory by spamming with bogus blocks\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17214196",
      "id" : 17214196,
      "original_commit_id" : "33bdf0da33859e69fa21fc6ed4a1fc4b58d81a15",
      "original_position" : 524,
      "path" : "src/main.cpp",
      "position" : 621,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17214196",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17214203"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17214203"
         }
      },
      "body" : "Ah, I think I was thinking headers were more like the things mentioned in https://bitcointalk.org/index.php?topic=145066.0\r\n\r\nWhat happened to the headers described in that article? They sounded like an excellent idea.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-07T11:20:42Z",
      "diff_hunk" : "@@ -2297,26 +2350,13 @@ bool AcceptBlockHeader(CBlockHeader& block, CValidationState& state, CBlockIndex\n     BlockMap::iterator miSelf = mapBlockIndex.find(hash);\n     CBlockIndex *pindex = NULL;\n     if (miSelf != mapBlockIndex.end()) {\n+        // Block header is already known.\n         pindex = miSelf->second;\n+        if (ppindex)\n+            *ppindex = pindex;\n         if (pindex->nStatus & BLOCK_FAILED_MASK)\n             return state.Invalid(error(\"AcceptBlock() : block is marked invalid\"), 0, \"duplicate\");\n-    }\n-\n-    CBlockIndex* pcheckpoint = Checkpoints::GetLastCheckpoint();\n-    if (pcheckpoint && block.hashPrevBlock != (chainActive.Tip() ? chainActive.Tip()->GetBlockHash() : uint256(0)))\n-    {\n-        // Extra checks to prevent \"fill up memory by spamming with bogus blocks\"\n-        int64_t deltaTime = block.GetBlockTime() - pcheckpoint->GetBlockTime();\n-        if (deltaTime < 0)\n-        {\n-            return state.DoS(100, error(\"CheckBlockHeader() : block with timestamp before last checkpoint\"),\n-                             REJECT_CHECKPOINT, \"time-too-old\");\n-        }\n-        if (!CheckMinWork(block.nBits, pcheckpoint->nBits, deltaTime))\n-        {\n-            return state.DoS(100, error(\"CheckBlockHeader() : block with too little proof-of-work\"),\n-                             REJECT_INVALID, \"bad-diffbits\");\n-        }\n+        return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17214203",
      "id" : 17214203,
      "original_commit_id" : "33bdf0da33859e69fa21fc6ed4a1fc4b58d81a15",
      "original_position" : 536,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17214203",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17214227"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17214227"
         }
      },
      "body" : "LogPrint(\"net\", \"received %s peer=%d\\n\", inv.ToString(), pfrom->id); would be shorter :)\r\n\r\nAlso, I notice you sometimes use pfrom->id and sometimes pfrom->GetId() - what's the advantage in the latter one?",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-07T11:29:14Z",
      "diff_hunk" : "@@ -3831,22 +3830,66 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n     }\n \n \n+    else if (strCommand == \"headers\" && !fImporting && !fReindex) // Ignore headers received while importing\n+    {\n+        std::vector<CBlockHeader> headers;\n+\n+        // Bypass the normal CBlock deserialization, as we don't want to risk deserializing 2000 full blocks.\n+        unsigned int nCount = ReadCompactSize(vRecv);\n+        if (nCount > MAX_HEADERS_RESULTS) {\n+            Misbehaving(pfrom->GetId(), 20);\n+            return error(\"headers message size = %u\", nCount);\n+        }\n+        headers.resize(nCount);\n+        for (unsigned int n = 0; n < nCount; n++) {\n+            vRecv >> headers[n];\n+            ReadCompactSize(vRecv); // ignore tx count; assume it is 0.\n+        }\n+\n+        LOCK(cs_main);\n+\n+        if (nCount == 0) {\n+            // Nothing interesting. Stop asking this peers for more headers.\n+            return true;\n+        }\n+\n+        CBlockIndex *pindexLast = NULL;\n+        BOOST_FOREACH(const CBlockHeader& header, headers) {\n+            CValidationState state;\n+            if (pindexLast != NULL && header.hashPrevBlock != pindexLast->GetBlockHash()) {\n+                Misbehaving(pfrom->GetId(), 20);\n+                return error(\"non-continuous headers sequence\");\n+            }\n+            if (!AcceptBlockHeader(header, state, &pindexLast)) {\n+                int nDoS;\n+                if (state.IsInvalid(nDoS)) {\n+                    if (nDoS > 0)\n+                        Misbehaving(pfrom->GetId(), nDoS);\n+                    return error(\"invalid header received\");\n+                }\n+            }\n+        }\n+\n+        if (pindexLast)\n+            UpdateBlockAvailability(pfrom->GetId(), pindexLast->GetBlockHash());\n+\n+        if (nCount == MAX_HEADERS_RESULTS && pindexLast) {\n+            // Headers message had its maximum size; the peer may have more headers.\n+            // TODO: optimize: if pindexLast is an ancestor of chainActive.Tip or pindexBestHeader, continue\n+            // from there instead.\n+            pfrom->PushMessage(\"getheaders\", chainActive.GetLocator(pindexLast), uint256(0));\n+        }\n+    }\n+\n     else if (strCommand == \"block\" && !fImporting && !fReindex) // Ignore blocks received while importing\n     {\n         CBlock block;\n         vRecv >> block;\n \n-        LogPrint(\"net\", \"received block %s peer=%d\\n\", block.GetHash().ToString(), pfrom->id);\n-\n         CInv inv(MSG_BLOCK, block.GetHash());\n-        pfrom->AddInventoryKnown(inv);\n+        LogPrint(\"net\", \"received block %s peer=%d\\n\", inv.hash.ToString(), pfrom->id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17214227",
      "id" : 17214227,
      "original_commit_id" : "33bdf0da33859e69fa21fc6ed4a1fc4b58d81a15",
      "original_position" : 836,
      "path" : "src/main.cpp",
      "position" : 1038,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17214227",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17214243"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17214243"
         }
      },
      "body" : "If false is returned, some error condition should be set in state.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-07T11:33:11Z",
      "diff_hunk" : "@@ -2376,6 +2416,12 @@ bool AcceptBlock(CBlock& block, CValidationState& state, CBlockIndex** ppindex,\n     if (!AcceptBlockHeader(block, state, &pindex))\n         return false;\n \n+    if (pindex->nStatus & BLOCK_HAVE_DATA) {\n+        // TODO: deal better with duplicate blocks.\n+        // return state.DoS(20, error(\"AcceptBlock() : already have block %d %s\", pindex->nHeight, pindex->GetBlockHash().ToString()), REJECT_DUPLICATE, \"duplicate\");\n+        return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17214243",
      "id" : 17214243,
      "original_commit_id" : "33bdf0da33859e69fa21fc6ed4a1fc4b58d81a15",
      "original_position" : 547,
      "path" : "src/main.cpp",
      "position" : 644,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17214243",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17214246"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17214246"
         }
      },
      "body" : "That article describes a novel network protocol. It's not what is implemented.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-07T11:34:08Z",
      "diff_hunk" : "@@ -2297,26 +2350,13 @@ bool AcceptBlockHeader(CBlockHeader& block, CValidationState& state, CBlockIndex\n     BlockMap::iterator miSelf = mapBlockIndex.find(hash);\n     CBlockIndex *pindex = NULL;\n     if (miSelf != mapBlockIndex.end()) {\n+        // Block header is already known.\n         pindex = miSelf->second;\n+        if (ppindex)\n+            *ppindex = pindex;\n         if (pindex->nStatus & BLOCK_FAILED_MASK)\n             return state.Invalid(error(\"AcceptBlock() : block is marked invalid\"), 0, \"duplicate\");\n-    }\n-\n-    CBlockIndex* pcheckpoint = Checkpoints::GetLastCheckpoint();\n-    if (pcheckpoint && block.hashPrevBlock != (chainActive.Tip() ? chainActive.Tip()->GetBlockHash() : uint256(0)))\n-    {\n-        // Extra checks to prevent \"fill up memory by spamming with bogus blocks\"\n-        int64_t deltaTime = block.GetBlockTime() - pcheckpoint->GetBlockTime();\n-        if (deltaTime < 0)\n-        {\n-            return state.DoS(100, error(\"CheckBlockHeader() : block with timestamp before last checkpoint\"),\n-                             REJECT_CHECKPOINT, \"time-too-old\");\n-        }\n-        if (!CheckMinWork(block.nBits, pcheckpoint->nBits, deltaTime))\n-        {\n-            return state.DoS(100, error(\"CheckBlockHeader() : block with too little proof-of-work\"),\n-                             REJECT_INVALID, \"bad-diffbits\");\n-        }\n+        return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17214246",
      "id" : 17214246,
      "original_commit_id" : "33bdf0da33859e69fa21fc6ed4a1fc4b58d81a15",
      "original_position" : 536,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17214246",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17214249"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17214249"
         }
      },
      "body" : "We certainly do, but every case this protects against is now caught in the proof of work check below. Previously, this check was useful, because we wanted to verify whether a block was viable without knowing its parent. In headers-first, we always know all headers before processing a block, so it doesn't add anything anymore.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-07T11:35:45Z",
      "diff_hunk" : "@@ -2297,26 +2350,13 @@ bool AcceptBlockHeader(CBlockHeader& block, CValidationState& state, CBlockIndex\n     BlockMap::iterator miSelf = mapBlockIndex.find(hash);\n     CBlockIndex *pindex = NULL;\n     if (miSelf != mapBlockIndex.end()) {\n+        // Block header is already known.\n         pindex = miSelf->second;\n+        if (ppindex)\n+            *ppindex = pindex;\n         if (pindex->nStatus & BLOCK_FAILED_MASK)\n             return state.Invalid(error(\"AcceptBlock() : block is marked invalid\"), 0, \"duplicate\");\n-    }\n-\n-    CBlockIndex* pcheckpoint = Checkpoints::GetLastCheckpoint();\n-    if (pcheckpoint && block.hashPrevBlock != (chainActive.Tip() ? chainActive.Tip()->GetBlockHash() : uint256(0)))\n-    {\n-        // Extra checks to prevent \"fill up memory by spamming with bogus blocks\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17214249",
      "id" : 17214249,
      "original_commit_id" : "33bdf0da33859e69fa21fc6ed4a1fc4b58d81a15",
      "original_position" : 524,
      "path" : "src/main.cpp",
      "position" : 621,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17214249",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17214250"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17214250"
         }
      },
      "body" : "It was moved up a few lines. There's even a comment about why it was moved.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-07T11:36:29Z",
      "diff_hunk" : "@@ -2262,16 +2330,6 @@ bool CheckBlock(const CBlock& block, CValidationState& state, bool fCheckPOW, bo\n         if (!CheckTransaction(tx, state))\n             return error(\"CheckBlock() : CheckTransaction failed\");\n \n-    // Check for duplicate txids. This is caught by ConnectInputs(),\n-    // but catching it earlier avoids a potential DoS attack:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17214250",
      "id" : 17214250,
      "original_commit_id" : "33bdf0da33859e69fa21fc6ed4a1fc4b58d81a15",
      "original_position" : 477,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17214250",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17214255"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17214255"
         }
      },
      "body" : "@sipa I'm unfamiliar the locators to be honest, but surely it would make more sense to send the getheaders request using a locator that won't be unrecognised, e.g. send the locator corresponding to the block height the we know the node has. It's then far more likely to send us just it's last block header rather than going back to thousands of blocks that we already know of.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-07T11:38:41Z",
      "diff_hunk" : "@@ -4426,9 +4480,15 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n         state.rejects.clear();\n \n         // Start block sync\n-        if (pto->fStartSync && !fImporting && !fReindex) {\n-            pto->fStartSync = false;\n-            PushGetBlocks(pto, chainActive.Tip(), uint256(0));\n+        if (pindexBestHeader == NULL)\n+            pindexBestHeader = chainActive.Tip();\n+        if (!state.fSyncStarted && !pto->fClient && !pto->fInbound && !fImporting && !fReindex) {\n+            // Only actively request headers from a single peer, unless we're close to today.\n+            if (nSyncStarted == 0 || pindexBestHeader->GetBlockTime() > GetAdjustedTime() - 24 * 60 * 60) {\n+                state.fSyncStarted = true;\n+                nSyncStarted++;\n+                pto->PushMessage(\"getheaders\", chainActive.GetLocator(pindexBestHeader->pprev), uint256(0));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17214255",
      "id" : 17214255,
      "original_commit_id" : "2525afb58a71924d48bf99ea19cf741f0c6ccf66",
      "original_position" : 839,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17214255",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17214267"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17214267"
         }
      },
      "body" : "Just good practice in general; you shouldn't be looking at fields of complex data structures. Using a wrapper method means more flexibility about changing the implementation later.\r\n\r\nThen again, it's pretty meaningless if not done consistently.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-07T11:43:25Z",
      "diff_hunk" : "@@ -3831,22 +3830,66 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n     }\n \n \n+    else if (strCommand == \"headers\" && !fImporting && !fReindex) // Ignore headers received while importing\n+    {\n+        std::vector<CBlockHeader> headers;\n+\n+        // Bypass the normal CBlock deserialization, as we don't want to risk deserializing 2000 full blocks.\n+        unsigned int nCount = ReadCompactSize(vRecv);\n+        if (nCount > MAX_HEADERS_RESULTS) {\n+            Misbehaving(pfrom->GetId(), 20);\n+            return error(\"headers message size = %u\", nCount);\n+        }\n+        headers.resize(nCount);\n+        for (unsigned int n = 0; n < nCount; n++) {\n+            vRecv >> headers[n];\n+            ReadCompactSize(vRecv); // ignore tx count; assume it is 0.\n+        }\n+\n+        LOCK(cs_main);\n+\n+        if (nCount == 0) {\n+            // Nothing interesting. Stop asking this peers for more headers.\n+            return true;\n+        }\n+\n+        CBlockIndex *pindexLast = NULL;\n+        BOOST_FOREACH(const CBlockHeader& header, headers) {\n+            CValidationState state;\n+            if (pindexLast != NULL && header.hashPrevBlock != pindexLast->GetBlockHash()) {\n+                Misbehaving(pfrom->GetId(), 20);\n+                return error(\"non-continuous headers sequence\");\n+            }\n+            if (!AcceptBlockHeader(header, state, &pindexLast)) {\n+                int nDoS;\n+                if (state.IsInvalid(nDoS)) {\n+                    if (nDoS > 0)\n+                        Misbehaving(pfrom->GetId(), nDoS);\n+                    return error(\"invalid header received\");\n+                }\n+            }\n+        }\n+\n+        if (pindexLast)\n+            UpdateBlockAvailability(pfrom->GetId(), pindexLast->GetBlockHash());\n+\n+        if (nCount == MAX_HEADERS_RESULTS && pindexLast) {\n+            // Headers message had its maximum size; the peer may have more headers.\n+            // TODO: optimize: if pindexLast is an ancestor of chainActive.Tip or pindexBestHeader, continue\n+            // from there instead.\n+            pfrom->PushMessage(\"getheaders\", chainActive.GetLocator(pindexLast), uint256(0));\n+        }\n+    }\n+\n     else if (strCommand == \"block\" && !fImporting && !fReindex) // Ignore blocks received while importing\n     {\n         CBlock block;\n         vRecv >> block;\n \n-        LogPrint(\"net\", \"received block %s peer=%d\\n\", block.GetHash().ToString(), pfrom->id);\n-\n         CInv inv(MSG_BLOCK, block.GetHash());\n-        pfrom->AddInventoryKnown(inv);\n+        LogPrint(\"net\", \"received block %s peer=%d\\n\", inv.hash.ToString(), pfrom->id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17214267",
      "id" : 17214267,
      "original_commit_id" : "33bdf0da33859e69fa21fc6ed4a1fc4b58d81a15",
      "original_position" : 836,
      "path" : "src/main.cpp",
      "position" : 1038,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17214267",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17214288"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17214288"
         }
      },
      "body" : "That would mean downloading all headers from all peers. Initially, we don't know anything about our peers, and it is exactly _through_ getheaders (and a bit through invs, but that's harder to rely on) that we learn about what the peer knows. Usually, when sending an initial getheaders request to a peer, they already have the majority of headers we want, and using our own best will in the average case result in only a few 100 headers.\r\n\r\n",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-07T11:48:49Z",
      "diff_hunk" : "@@ -4426,9 +4480,15 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n         state.rejects.clear();\n \n         // Start block sync\n-        if (pto->fStartSync && !fImporting && !fReindex) {\n-            pto->fStartSync = false;\n-            PushGetBlocks(pto, chainActive.Tip(), uint256(0));\n+        if (pindexBestHeader == NULL)\n+            pindexBestHeader = chainActive.Tip();\n+        if (!state.fSyncStarted && !pto->fClient && !pto->fInbound && !fImporting && !fReindex) {\n+            // Only actively request headers from a single peer, unless we're close to today.\n+            if (nSyncStarted == 0 || pindexBestHeader->GetBlockTime() > GetAdjustedTime() - 24 * 60 * 60) {\n+                state.fSyncStarted = true;\n+                nSyncStarted++;\n+                pto->PushMessage(\"getheaders\", chainActive.GetLocator(pindexBestHeader->pprev), uint256(0));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17214288",
      "id" : 17214288,
      "original_commit_id" : "2525afb58a71924d48bf99ea19cf741f0c6ccf66",
      "original_position" : 839,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17214288",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17214296"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17214296"
         }
      },
      "body" : "Sending pprev: so that we get some header back as a result in case they are at the same point as us, as we use received headers to update our information about what the peer knows.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-07T11:51:02Z",
      "diff_hunk" : "@@ -4426,9 +4480,15 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n         state.rejects.clear();\n \n         // Start block sync\n-        if (pto->fStartSync && !fImporting && !fReindex) {\n-            pto->fStartSync = false;\n-            PushGetBlocks(pto, chainActive.Tip(), uint256(0));\n+        if (pindexBestHeader == NULL)\n+            pindexBestHeader = chainActive.Tip();\n+        if (!state.fSyncStarted && !pto->fClient && !pto->fInbound && !fImporting && !fReindex) {\n+            // Only actively request headers from a single peer, unless we're close to today.\n+            if (nSyncStarted == 0 || pindexBestHeader->GetBlockTime() > GetAdjustedTime() - 24 * 60 * 60) {\n+                state.fSyncStarted = true;\n+                nSyncStarted++;\n+                pto->PushMessage(\"getheaders\", chainActive.GetLocator(pindexBestHeader->pprev), uint256(0));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17214296",
      "id" : 17214296,
      "original_commit_id" : "2525afb58a71924d48bf99ea19cf741f0c6ccf66",
      "original_position" : 839,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17214296",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17214330"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17214330"
         }
      },
      "body" : "`getheaders`, in a way compatible with how this PR uses it, was added in december 2010 (Bitcoin 0.3.18) by satoshi.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-07T11:59:03Z",
      "diff_hunk" : "@@ -67,9 +67,17 @@ static const int MAX_SCRIPTCHECK_THREADS = 16;\n /** -par default (number of script-checking threads, 0 = auto) */\n static const int DEFAULT_SCRIPTCHECK_THREADS = 0;\n /** Number of blocks that can be requested at any given time from a single peer. */\n-static const int MAX_BLOCKS_IN_TRANSIT_PER_PEER = 128;\n-/** Timeout in seconds before considering a block download peer unresponsive. */\n-static const unsigned int BLOCK_DOWNLOAD_TIMEOUT = 60;\n+static const int MAX_BLOCKS_IN_TRANSIT_PER_PEER = 16;\n+/** Timeout in seconds during which a peer must stall block download progress before being disconnected. */\n+static const unsigned int BLOCK_STALLING_TIMEOUT = 2;\n+/** Number of headers sent in one getheaders result. We rely on the assumption that if a peer sends\n+ *  less than this number, we reached their tip. Changing this value is a protocol upgrade. */\n+static const unsigned int MAX_HEADERS_RESULTS = 2000;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17214330",
      "id" : 17214330,
      "original_commit_id" : "2525afb58a71924d48bf99ea19cf741f0c6ccf66",
      "original_position" : 12,
      "path" : "src/main.h",
      "position" : 12,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17214330",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "@rebroad regarding reindexing: it's not that we're adding blocks to leveldb out of order (they're only applied to the chainstate when being validated, which happens in-order), but they're written to the blk*.dat files in the order they are downloaded (after validating the headers). The current reindexing logic (and that of earlier versions) assumes that the files on disk contain blocks in order, so that breaks it indeed.\r\n\r\nThe reason for presenting this pull request without having the reindexing logic in it: I don't expect it to be hard or controversial to add, but believe that getting comments on the core validation/downloading logic is way more important.\r\n\r\nPerhaps that makes it non-mergable right now, but it's not mergable anyway as long as there is no test infrastructure in place that can deal with it.",
      "created_at" : "2014-09-07T12:34:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-54745422",
      "id" : 54745422,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-09-07T12:36:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54745422",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17215267"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17215267"
         }
      },
      "body" : "What about when a block is sent without a header or inv first?",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-07T15:22:04Z",
      "diff_hunk" : "@@ -2297,26 +2350,13 @@ bool AcceptBlockHeader(CBlockHeader& block, CValidationState& state, CBlockIndex\n     BlockMap::iterator miSelf = mapBlockIndex.find(hash);\n     CBlockIndex *pindex = NULL;\n     if (miSelf != mapBlockIndex.end()) {\n+        // Block header is already known.\n         pindex = miSelf->second;\n+        if (ppindex)\n+            *ppindex = pindex;\n         if (pindex->nStatus & BLOCK_FAILED_MASK)\n             return state.Invalid(error(\"AcceptBlock() : block is marked invalid\"), 0, \"duplicate\");\n-    }\n-\n-    CBlockIndex* pcheckpoint = Checkpoints::GetLastCheckpoint();\n-    if (pcheckpoint && block.hashPrevBlock != (chainActive.Tip() ? chainActive.Tip()->GetBlockHash() : uint256(0)))\n-    {\n-        // Extra checks to prevent \"fill up memory by spamming with bogus blocks\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17215267",
      "id" : 17215267,
      "original_commit_id" : "33bdf0da33859e69fa21fc6ed4a1fc4b58d81a15",
      "original_position" : 524,
      "path" : "src/main.cpp",
      "position" : 621,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17215267",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17215279"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17215279"
         }
      },
      "body" : "If it connects cleanly to the chain we already have, there is no problem. If not, it is discarded. That's the basic idea behind headers-first: we can't accept a block without knowing (the headers of) its ancestors.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-07T15:24:45Z",
      "diff_hunk" : "@@ -2297,26 +2350,13 @@ bool AcceptBlockHeader(CBlockHeader& block, CValidationState& state, CBlockIndex\n     BlockMap::iterator miSelf = mapBlockIndex.find(hash);\n     CBlockIndex *pindex = NULL;\n     if (miSelf != mapBlockIndex.end()) {\n+        // Block header is already known.\n         pindex = miSelf->second;\n+        if (ppindex)\n+            *ppindex = pindex;\n         if (pindex->nStatus & BLOCK_FAILED_MASK)\n             return state.Invalid(error(\"AcceptBlock() : block is marked invalid\"), 0, \"duplicate\");\n-    }\n-\n-    CBlockIndex* pcheckpoint = Checkpoints::GetLastCheckpoint();\n-    if (pcheckpoint && block.hashPrevBlock != (chainActive.Tip() ? chainActive.Tip()->GetBlockHash() : uint256(0)))\n-    {\n-        // Extra checks to prevent \"fill up memory by spamming with bogus blocks\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17215279",
      "id" : 17215279,
      "original_commit_id" : "33bdf0da33859e69fa21fc6ed4a1fc4b58d81a15",
      "original_position" : 524,
      "path" : "src/main.cpp",
      "position" : 621,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17215279",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Automatic sanity-testing: FAILED MERGE, see http://jenkins.bluematt.me/pull-tester/p4468_c248436f60f18bc2ee886c912872a124212d04b9/ for test log.\n\nThis pull does not merge cleanly onto current master\nThis test script verifies pulls every time they are updated. It, however, dies sometimes and fails to test properly.  If you are waiting on a test, please check timestamps to verify that the test.log is moving at http://jenkins.bluematt.me/pull-tester/current/\nContact BlueMatt on freenode if something looks broken.",
      "created_at" : "2014-09-09T23:56:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-55053858",
      "id" : 55053858,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-09-09T23:56:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/55053858",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2110907?v=3",
         "events_url" : "https://api.github.com/users/BitcoinPullTester/events{/privacy}",
         "followers_url" : "https://api.github.com/users/BitcoinPullTester/followers",
         "following_url" : "https://api.github.com/users/BitcoinPullTester/following{/other_user}",
         "gists_url" : "https://api.github.com/users/BitcoinPullTester/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/BitcoinPullTester",
         "id" : 2110907,
         "login" : "BitcoinPullTester",
         "organizations_url" : "https://api.github.com/users/BitcoinPullTester/orgs",
         "received_events_url" : "https://api.github.com/users/BitcoinPullTester/received_events",
         "repos_url" : "https://api.github.com/users/BitcoinPullTester/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/BitcoinPullTester/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/BitcoinPullTester/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/BitcoinPullTester"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17341483"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17341483"
         }
      },
      "body" : "@sipa I'm not sure you're understanding what I'm trying to say. Clearly if a node is at height 295403, it's not going to recognise the locator for block 321032, so why bother sending it a locator we know it won't recognise? Why not sent it the locator for block 295403 instead?",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-10T03:41:07Z",
      "diff_hunk" : "@@ -4426,9 +4480,15 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n         state.rejects.clear();\n \n         // Start block sync\n-        if (pto->fStartSync && !fImporting && !fReindex) {\n-            pto->fStartSync = false;\n-            PushGetBlocks(pto, chainActive.Tip(), uint256(0));\n+        if (pindexBestHeader == NULL)\n+            pindexBestHeader = chainActive.Tip();\n+        if (!state.fSyncStarted && !pto->fClient && !pto->fInbound && !fImporting && !fReindex) {\n+            // Only actively request headers from a single peer, unless we're close to today.\n+            if (nSyncStarted == 0 || pindexBestHeader->GetBlockTime() > GetAdjustedTime() - 24 * 60 * 60) {\n+                state.fSyncStarted = true;\n+                nSyncStarted++;\n+                pto->PushMessage(\"getheaders\", chainActive.GetLocator(pindexBestHeader->pprev), uint256(0));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17341483",
      "id" : 17341483,
      "original_commit_id" : "2525afb58a71924d48bf99ea19cf741f0c6ccf66",
      "original_position" : 839,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17341483",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17341521"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17341521"
         }
      },
      "body" : "Any plans to implement that? What would be the next step? Someone to submit a pull request implementing it?",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-10T03:44:06Z",
      "diff_hunk" : "@@ -2297,26 +2350,13 @@ bool AcceptBlockHeader(CBlockHeader& block, CValidationState& state, CBlockIndex\n     BlockMap::iterator miSelf = mapBlockIndex.find(hash);\n     CBlockIndex *pindex = NULL;\n     if (miSelf != mapBlockIndex.end()) {\n+        // Block header is already known.\n         pindex = miSelf->second;\n+        if (ppindex)\n+            *ppindex = pindex;\n         if (pindex->nStatus & BLOCK_FAILED_MASK)\n             return state.Invalid(error(\"AcceptBlock() : block is marked invalid\"), 0, \"duplicate\");\n-    }\n-\n-    CBlockIndex* pcheckpoint = Checkpoints::GetLastCheckpoint();\n-    if (pcheckpoint && block.hashPrevBlock != (chainActive.Tip() ? chainActive.Tip()->GetBlockHash() : uint256(0)))\n-    {\n-        // Extra checks to prevent \"fill up memory by spamming with bogus blocks\"\n-        int64_t deltaTime = block.GetBlockTime() - pcheckpoint->GetBlockTime();\n-        if (deltaTime < 0)\n-        {\n-            return state.DoS(100, error(\"CheckBlockHeader() : block with timestamp before last checkpoint\"),\n-                             REJECT_CHECKPOINT, \"time-too-old\");\n-        }\n-        if (!CheckMinWork(block.nBits, pcheckpoint->nBits, deltaTime))\n-        {\n-            return state.DoS(100, error(\"CheckBlockHeader() : block with too little proof-of-work\"),\n-                             REJECT_INVALID, \"bad-diffbits\");\n-        }\n+        return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17341521",
      "id" : 17341521,
      "original_commit_id" : "33bdf0da33859e69fa21fc6ed4a1fc4b58d81a15",
      "original_position" : 536,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17341521",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17402997"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17402997"
         }
      },
      "body" : "What if the peer that the \"getheaders\" has been sent to ignores the request? The logic doesn't seem to cater for that and assumes that one \"getheaders\" request to the first node sending the inv will be sufficient. By the peer ignoring the getheaders request, this could cause the requesting node to have to wait until the next mined block before it can request the missing block, and if the same node again sends the first inv, this could cause the node to get stuck behind for quite some time.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-11T03:46:44Z",
      "diff_hunk" : "@@ -3625,23 +3613,34 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n             bool fAlreadyHave = AlreadyHave(inv);\n             LogPrint(\"net\", \"got inv: %s  %s peer=%d\\n\", inv.ToString(), fAlreadyHave ? \"have\" : \"new\", pfrom->id);\n \n-            if (!fAlreadyHave) {\n-                if (!fImporting && !fReindex) {\n-                    if (inv.type == MSG_BLOCK)\n-                        AddBlockToQueue(pfrom->GetId(), inv.hash);\n-                    else\n-                        pfrom->AskFor(inv);\n-                }\n-            } else if (inv.type == MSG_BLOCK && mapOrphanBlocks.count(inv.hash)) {\n-                PushGetBlocks(pfrom, chainActive.Tip(), GetOrphanRoot(inv.hash));\n-            }\n+            if (!fAlreadyHave && !fImporting && !fReindex && inv.type != MSG_BLOCK)\n+                pfrom->AskFor(inv);\n \n-            if (inv.type == MSG_BLOCK)\n+            if (inv.type == MSG_BLOCK) {\n                 UpdateBlockAvailability(pfrom->GetId(), inv.hash);\n+                if (!fAlreadyHave && !fImporting && !fReindex && !mapBlocksInFlight.count(inv.hash)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17402997",
      "id" : 17402997,
      "original_commit_id" : "2692f572795eee4ed80e103b519f3a5b3326d58e",
      "original_position" : 737,
      "path" : "src/main.cpp",
      "position" : 930,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17402997",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17403096"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17403096"
         }
      },
      "body" : "I'd like to submit a patch for this, but I'm not sure how to find the locator for a block just from it's height - could someone help me find an example where this is done please?",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-11T03:51:36Z",
      "diff_hunk" : "@@ -4426,9 +4480,15 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n         state.rejects.clear();\n \n         // Start block sync\n-        if (pto->fStartSync && !fImporting && !fReindex) {\n-            pto->fStartSync = false;\n-            PushGetBlocks(pto, chainActive.Tip(), uint256(0));\n+        if (pindexBestHeader == NULL)\n+            pindexBestHeader = chainActive.Tip();\n+        if (!state.fSyncStarted && !pto->fClient && !pto->fInbound && !fImporting && !fReindex) {\n+            // Only actively request headers from a single peer, unless we're close to today.\n+            if (nSyncStarted == 0 || pindexBestHeader->GetBlockTime() > GetAdjustedTime() - 24 * 60 * 60) {\n+                state.fSyncStarted = true;\n+                nSyncStarted++;\n+                pto->PushMessage(\"getheaders\", chainActive.GetLocator(pindexBestHeader->pprev), uint256(0));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17403096",
      "id" : 17403096,
      "original_commit_id" : "2525afb58a71924d48bf99ea19cf741f0c6ccf66",
      "original_position" : 839,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17403096",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17403125"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17403125"
         }
      },
      "body" : "changing the (int) to (unsigned int) fixes this compile warning.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-11T03:53:21Z",
      "diff_hunk" : "@@ -355,6 +327,103 @@ void UpdateBlockAvailability(NodeId nodeid, const uint256 &hash) {\n     }\n }\n \n+/** Find the last common ancestor two blocks have.\n+ *  Both pa and pb must be non-NULL. */\n+CBlockIndex* LastCommonAncestor(CBlockIndex* pa, CBlockIndex* pb) {\n+    if (pa->nHeight > pb->nHeight) {\n+        pa = pa->GetAncestor(pb->nHeight);\n+    } else if (pb->nHeight > pa->nHeight) {\n+        pb = pb->GetAncestor(pa->nHeight);\n+    }\n+\n+    while (pa != pb && pa && pb) {\n+        pa = pa->pprev;\n+        pb = pb->pprev;\n+    }\n+\n+    // Eventually all chain branches meet at the genesis block.\n+    assert(pa == pb);\n+    return pa;\n+}\n+\n+/** Update pindexLastCommonBlock and add not-in-flight missing successors to vBlocks, until it has\n+ *  at most count entries. */\n+void FindNextBlocksToDownload(NodeId nodeid, unsigned int count, std::vector<CBlockIndex*>& vBlocks, NodeId& nodeStaller) {\n+    if (count == 0)\n+        return;\n+\n+    vBlocks.reserve(vBlocks.size() + count);\n+    CNodeState *state = State(nodeid);\n+    assert(state != NULL);\n+\n+    // Make sure pindexBestKnownBlock is up to date, we'll need it.\n+    ProcessBlockAvailability(nodeid);\n+\n+    if (state->pindexBestKnownBlock == NULL || state->pindexBestKnownBlock->nChainWork < chainActive.Tip()->nChainWork) {\n+        // This peer has nothing interesting.\n+        return;\n+    }\n+\n+    if (state->pindexLastCommonBlock == NULL) {\n+        // Bootstrap quickly by guessing a parent of our best tip is the forking point.\n+        // Guessing wrong in either direction is not a problem.\n+        state->pindexLastCommonBlock = chainActive[std::min(state->pindexBestKnownBlock->nHeight, chainActive.Height())];\n+    }\n+\n+    // If the peer reorganized, our previous pindexLastCommonBlock may not be an ancestor\n+    // of their current tip anymore. Go back enough to fix that.\n+    state->pindexLastCommonBlock = LastCommonAncestor(state->pindexLastCommonBlock, state->pindexBestKnownBlock);\n+    if (state->pindexLastCommonBlock == state->pindexBestKnownBlock)\n+        return;\n+\n+    std::vector<CBlockIndex*> vToFetch;\n+    CBlockIndex *pindexWalk = state->pindexLastCommonBlock;\n+    // Never fetch further than the best block we know the peer has, or more than BLOCK_DOWNLOAD_WINDOW + 1 beyond our\n+    // current tip. The +1 is so we can detect stalling, namely if we would be able to download that next block if the\n+    // window were 1 larger.\n+    int nMaxHeight = std::min<int>(state->pindexBestKnownBlock->nHeight, chainActive.Height() + BLOCK_DOWNLOAD_WINDOW + 1);\n+    NodeId waitingfor = -1;\n+    while (pindexWalk->nHeight < nMaxHeight) {\n+        // Read up to 128 (or more, if more blocks than that are needed) successors of pindexWalk (towards\n+        // pindexBestKnownBlock) into vToFetch. We fetch 128, because CBlockIndex::GetAncestor may be as expensive\n+        // as iterating over ~100 CBlockIndex* entries anyway.\n+        int nToFetch = std::min(nMaxHeight - pindexWalk->nHeight, std::max<int>(count - vBlocks.size(), 128));\n+        vToFetch.resize(nToFetch);\n+        pindexWalk = state->pindexBestKnownBlock->GetAncestor(pindexWalk->nHeight + nToFetch);\n+        vToFetch[nToFetch - 1] = pindexWalk;\n+        for (unsigned int i = nToFetch - 1; i > 0; i--) {\n+            vToFetch[i - 1] = vToFetch[i]->pprev;\n+        }\n+\n+        // Iterate over those blocks in vToFetch (in forward direction), adding the ones that\n+        // are not yet downloaded and not in flight to vBlocks. In the mean time, update\n+        // pindexLastCommonBlock as long as all ancestors are already downloaded.\n+        BOOST_FOREACH(CBlockIndex* pindex, vToFetch) {\n+            if (pindex->nStatus & BLOCK_HAVE_DATA) {\n+                if (pindex->nChainTx)\n+                    state->pindexLastCommonBlock = pindex;\n+            } else if (mapBlocksInFlight.count(pindex->GetBlockHash()) == 0) {\n+                // The block is not already downloaded, and not yet in flight.\n+                if ((int)pindex->nHeight > chainActive.Height() + BLOCK_DOWNLOAD_WINDOW) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17403125",
      "id" : 17403125,
      "original_commit_id" : "33bdf0da33859e69fa21fc6ed4a1fc4b58d81a15",
      "original_position" : 237,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17403125",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17405573"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17405573"
         }
      },
      "body" : "We call AcceptBlockHeader even for blocks received before having received\ntheir header. And the proof of work check further on is stronger than this\none.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-11T06:11:31Z",
      "diff_hunk" : "@@ -2297,26 +2350,13 @@ bool AcceptBlockHeader(CBlockHeader& block, CValidationState& state, CBlockIndex\n     BlockMap::iterator miSelf = mapBlockIndex.find(hash);\n     CBlockIndex *pindex = NULL;\n     if (miSelf != mapBlockIndex.end()) {\n+        // Block header is already known.\n         pindex = miSelf->second;\n+        if (ppindex)\n+            *ppindex = pindex;\n         if (pindex->nStatus & BLOCK_FAILED_MASK)\n             return state.Invalid(error(\"AcceptBlock() : block is marked invalid\"), 0, \"duplicate\");\n-    }\n-\n-    CBlockIndex* pcheckpoint = Checkpoints::GetLastCheckpoint();\n-    if (pcheckpoint && block.hashPrevBlock != (chainActive.Tip() ? chainActive.Tip()->GetBlockHash() : uint256(0)))\n-    {\n-        // Extra checks to prevent \"fill up memory by spamming with bogus blocks\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17405573",
      "id" : 17405573,
      "original_commit_id" : "33bdf0da33859e69fa21fc6ed4a1fc4b58d81a15",
      "original_position" : 524,
      "path" : "src/main.cpp",
      "position" : 621,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17405573",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17405618"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17405618"
         }
      },
      "body" : "Please understand what locators are before commenting further on this. They\nare exactly designed to keep working if either party is ahead from the\nother. And yes, it will be a bit less efficient if there is a difference,\nbut we don't _know_ how far the other peer is. We only know they are at\nleast at 295...; we send the getheaders exactly to find out how much\nfurther they are.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-11T06:13:55Z",
      "diff_hunk" : "@@ -4426,9 +4480,15 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n         state.rejects.clear();\n \n         // Start block sync\n-        if (pto->fStartSync && !fImporting && !fReindex) {\n-            pto->fStartSync = false;\n-            PushGetBlocks(pto, chainActive.Tip(), uint256(0));\n+        if (pindexBestHeader == NULL)\n+            pindexBestHeader = chainActive.Tip();\n+        if (!state.fSyncStarted && !pto->fClient && !pto->fInbound && !fImporting && !fReindex) {\n+            // Only actively request headers from a single peer, unless we're close to today.\n+            if (nSyncStarted == 0 || pindexBestHeader->GetBlockTime() > GetAdjustedTime() - 24 * 60 * 60) {\n+                state.fSyncStarted = true;\n+                nSyncStarted++;\n+                pto->PushMessage(\"getheaders\", chainActive.GetLocator(pindexBestHeader->pprev), uint256(0));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17405618",
      "id" : 17405618,
      "original_commit_id" : "2525afb58a71924d48bf99ea19cf741f0c6ccf66",
      "original_position" : 839,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17405618",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17405739"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17405739"
         }
      },
      "body" : "Yes that is a concern. It's not more a concern than a peer currently\nignoring getblocks however when it is our syncnode. Eventually we'll learn\nfrom other peers what the best headers are, when they announce a new block.\nThis is just to speed things up. It's always a compromise between bandwidth\nand reliability. Sending the request to two peers will make it safer, but\nalso means downloading all headers twice in the worst case...",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-11T06:19:21Z",
      "diff_hunk" : "@@ -3625,23 +3613,34 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n             bool fAlreadyHave = AlreadyHave(inv);\n             LogPrint(\"net\", \"got inv: %s  %s peer=%d\\n\", inv.ToString(), fAlreadyHave ? \"have\" : \"new\", pfrom->id);\n \n-            if (!fAlreadyHave) {\n-                if (!fImporting && !fReindex) {\n-                    if (inv.type == MSG_BLOCK)\n-                        AddBlockToQueue(pfrom->GetId(), inv.hash);\n-                    else\n-                        pfrom->AskFor(inv);\n-                }\n-            } else if (inv.type == MSG_BLOCK && mapOrphanBlocks.count(inv.hash)) {\n-                PushGetBlocks(pfrom, chainActive.Tip(), GetOrphanRoot(inv.hash));\n-            }\n+            if (!fAlreadyHave && !fImporting && !fReindex && inv.type != MSG_BLOCK)\n+                pfrom->AskFor(inv);\n \n-            if (inv.type == MSG_BLOCK)\n+            if (inv.type == MSG_BLOCK) {\n                 UpdateBlockAvailability(pfrom->GetId(), inv.hash);\n+                if (!fAlreadyHave && !fImporting && !fReindex && !mapBlocksInFlight.count(inv.hash)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17405739",
      "id" : 17405739,
      "original_commit_id" : "2692f572795eee4ed80e103b519f3a5b3326d58e",
      "original_position" : 737,
      "path" : "src/main.cpp",
      "position" : 930,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17405739",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17664726"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17664726"
         }
      },
      "body" : "Something seems to be wrong with the stalling logic, judging from my debug.log output:-\r\n\r\n2014-09-17 13:38:05 received block 0000000000000838ff0a36baecd1d4c07807ebc54a59e7e05dd4681839ba2827 (height:191655) peer=103\r\n2014-09-17 13:38:06 Requesting block 00000000000004f2b85c51e890bd7a445d7cbb16469c38447ab557c07eaafdc2 (192679) peer=103\r\n2014-09-17 13:38:07 Stall started peer=103\r\n2014-09-17 13:38:09 Peer=103 is stalling block download, disconnecting\r\n2014-09-17 13:38:09 disconnecting peer=103\r\n",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-09-17T13:57:41Z",
      "diff_hunk" : "@@ -4434,35 +4494,32 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n         if (!vInv.empty())\n             pto->PushMessage(\"inv\", vInv);\n \n-\n-        // Detect stalled peers. Require that blocks are in flight, we haven't\n-        // received a (requested) block in one minute, and that all blocks are\n-        // in flight for over two minutes, since we first had a chance to\n-        // process an incoming block.\n+        // Detect whether we're stalling\n         int64_t nNow = GetTimeMicros();\n-        if (!pto->fDisconnect && state.nBlocksInFlight &&\n-            state.nLastBlockReceive < state.nLastBlockProcess - BLOCK_DOWNLOAD_TIMEOUT*1000000 &&\n-            state.vBlocksInFlight.front().nTime < state.nLastBlockProcess - 2*BLOCK_DOWNLOAD_TIMEOUT*1000000) {\n-            LogPrintf(\"Peer %s is stalling block download, disconnecting\\n\", state.name);\n+        if (!pto->fDisconnect && state.nStallingSince && state.nStallingSince < nNow - 1000000 * BLOCK_STALLING_TIMEOUT) {\n+            LogPrintf(\"Peer=%d is stalling block download, disconnecting\\n\", pto->id);\n             pto->fDisconnect = true;\n         }\n \n-        // Update knowledge of peer's block availability.\n-        ProcessBlockAvailability(pto->GetId());\n-\n         //\n         // Message: getdata (blocks)\n         //\n         vector<CInv> vGetData;\n-        while (!pto->fDisconnect && state.nBlocksToDownload && state.nBlocksInFlight < MAX_BLOCKS_IN_TRANSIT_PER_PEER) {\n-            uint256 hash = state.vBlocksToDownload.front();\n-            vGetData.push_back(CInv(MSG_BLOCK, hash));\n-            MarkBlockAsInFlight(pto->GetId(), hash);\n-            LogPrint(\"net\", \"Requesting block %s peer=%d\\n\", hash.ToString(), pto->id);\n-            if (vGetData.size() >= 1000)\n-            {\n-                pto->PushMessage(\"getdata\", vGetData);\n-                vGetData.clear();\n+        if (!pto->fDisconnect && !pto->fClient && !pto->fInbound && state.nBlocksInFlight < MAX_BLOCKS_IN_TRANSIT_PER_PEER) {\n+            vector<CBlockIndex*> vToDownload;\n+            NodeId staller = -1;\n+            FindNextBlocksToDownload(pto->GetId(), MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.nBlocksInFlight, vToDownload, staller);\n+            BOOST_FOREACH(CBlockIndex *pindex, vToDownload) {\n+                vGetData.push_back(CInv(MSG_BLOCK, pindex->GetBlockHash()));\n+                MarkBlockAsInFlight(pto->GetId(), pindex->GetBlockHash(), pindex);\n+                LogPrint(\"net\", \"Requesting block %s (%d) peer=%d\\n\", pindex->GetBlockHash().ToString(),\n+                    pindex->nHeight, pto->id);\n+            }\n+            if (staller != -1) {\n+                if (State(staller)->nStallingSince == 0) {\n+                    State(staller)->nStallingSince = nNow;\n+                    LogPrint(\"net\", \"Stall started peer=%d\\n\", staller);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r17664726",
      "id" : 17664726,
      "original_commit_id" : "9722e9ed1fbff3a46ce68b655eb788cd2b0406f7",
      "original_position" : 912,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17664726",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "body" : "@sipa Currently, download is stalling using this code because the stall logic is flawed. It is too impatient, and it's asked about 50 nodes so far for the same block and disconnected all of them because none of them could deliver it quickly enough.",
      "created_at" : "2014-09-29T00:27:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-57106150",
      "id" : 57106150,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-09-29T00:28:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/57106150",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "body" : "@rebroad Good to know - that definitely sounds like unintended behavior. I'll have a look at it later, I'm now working on other things.",
      "created_at" : "2014-09-29T03:11:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-57112524",
      "id" : 57112524,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-09-29T03:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/57112524",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "@sipa Let me know if you want a copy of my debug.log",
      "created_at" : "2014-09-30T09:44:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-57289970",
      "id" : 57289970,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-09-30T09:44:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/57289970",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "body" : "Needs rebase",
      "created_at" : "2014-10-01T13:16:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-57460995",
      "id" : 57460995,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-10-01T13:16:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/57460995",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Comparison tool works when run locally, but on Travis it disconnects after the genesis block. @theuni is there any way to look at the log files produced on travis?",
      "created_at" : "2014-10-01T19:40:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-57523153",
      "id" : 57523153,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-10-01T19:40:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/57523153",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Perhaps we can cat debug.log to the log output in Travis, on comparison tool failure?",
      "created_at" : "2014-10-01T19:41:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-57523227",
      "id" : 57523227,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-10-01T19:41:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/57523227",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "See #5025. We have to be careful about dumping too much, because Travis has an output size ceiling.",
      "created_at" : "2014-10-01T20:51:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-57536322",
      "id" : 57536322,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-10-01T20:51:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/57536322",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "NPE in pulltester... @TheBlueMatt ?",
      "created_at" : "2014-10-01T23:00:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-57555439",
      "id" : 57555439,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-10-01T23:00:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/57555439",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "IT'S GREEEEEEEEEEEN!\r\n\r\nThanks a lot for the efforts, @TheBlueMatt!",
      "created_at" : "2014-10-02T01:42:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-57569092",
      "id" : 57569092,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-10-02T01:42:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/57569092",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Moved the comparison tool upgrade to #5027, so this will fail CI again until that is merged.",
      "created_at" : "2014-10-02T02:00:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-57570531",
      "id" : 57570531,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-10-02T02:00:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/57570531",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18321367"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18321367"
         }
      },
      "body" : "Just a niggle, but the naming is a little confusing here - it looks (from the naming) like you're marking it as in flight, although technically the getdata block hasn't even occurred yet at this point. This could cause confusion later on down the line in the same way as the recent AlreadyAskedFor naming confusion did recently.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-10-02T03:50:17Z",
      "diff_hunk" : "@@ -3601,19 +3598,28 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n             bool fAlreadyHave = AlreadyHave(inv);\n             LogPrint(\"net\", \"got inv: %s  %s peer=%d\\n\", inv.ToString(), fAlreadyHave ? \"have\" : \"new\", pfrom->id);\n \n-            if (!fAlreadyHave) {\n-                if (!fImporting && !fReindex) {\n-                    if (inv.type == MSG_BLOCK)\n-                        AddBlockToQueue(pfrom->GetId(), inv.hash);\n-                    else\n-                        pfrom->AskFor(inv);\n-                }\n-            } else if (inv.type == MSG_BLOCK && mapOrphanBlocks.count(inv.hash)) {\n-                PushGetBlocks(pfrom, chainActive.Tip(), GetOrphanRoot(inv.hash));\n-            }\n+            if (!fAlreadyHave && !fImporting && !fReindex && inv.type != MSG_BLOCK)\n+                pfrom->AskFor(inv);\n \n-            if (inv.type == MSG_BLOCK)\n+            if (inv.type == MSG_BLOCK) {\n                 UpdateBlockAvailability(pfrom->GetId(), inv.hash);\n+                if (!fAlreadyHave && !fImporting && !fReindex && !mapBlocksInFlight.count(inv.hash)) {\n+                    // First request the headers preceeding the announced block. In the normal fully-synced\n+                    // case where a new block is announced that succeeds the current tip (no reorganization),\n+                    // there are no such headers.\n+                    // Secondly, and only when we are close to being synced, we request the announced block directly,\n+                    // to avoid an extra round-trip. Note that we must *first* ask for the headers, so by the\n+                    // time the block arrives, the header chain leading up to it is already validated. Not\n+                    // doing this will result in the received block being rejected as an orphan in case it is\n+                    // not a direct successor.\n+                    pfrom->PushMessage(\"getheaders\", chainActive.GetLocator(pindexBestHeader), inv.hash);\n+                    if (chainActive.Tip()->GetBlockTime() > GetAdjustedTime() - Params().TargetSpacing() * 20) {\n+                        vToFetch.push_back(inv);\n+                        MarkBlockAsInFlight(pfrom->GetId(), inv.hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18321367",
      "id" : 18321367,
      "original_commit_id" : "f8c97eeead409a186b56cc39a4e99e3630012c5f",
      "original_position" : 735,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18321367",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "body" : "@rebroad Added a comment that should clarify that.",
      "created_at" : "2014-10-02T04:12:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-57581052",
      "id" : 57581052,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-10-02T04:12:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/57581052",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18331623"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18331623"
         }
      },
      "body" : "Nit: Typo (iff)",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-10-02T10:20:23Z",
      "diff_hunk" : "@@ -103,7 +120,8 @@ class CBlockIndex\n     // Note: in a potential headers-first mode, this number cannot be relied upon\n     unsigned int nTx;\n \n-    // (memory only) Number of transactions in the chain up to and including this block\n+    // (memory only) Number of transactions in the chain up to and including this block.\n+    // This value will be non-zero only iff transactions for this block and all its parents are available.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18331623",
      "id" : 18331623,
      "original_commit_id" : "c6faa4775c1ca884b1742d8fd718c6f577f9ebdc",
      "original_position" : 41,
      "path" : "src/chain.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18331623",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18331631"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18331631"
         }
      },
      "body" : "Nit: Unneded",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-10-02T10:20:42Z",
      "diff_hunk" : "@@ -50,6 +51,7 @@ bool fTxIndex = false;\n bool fIsBareMultisigStd = true;\n unsigned int nCoinCacheSize = 5000;\n \n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18331631",
      "id" : 18331631,
      "original_commit_id" : "c6faa4775c1ca884b1742d8fd718c6f577f9ebdc",
      "original_position" : 12,
      "path" : "src/main.cpp",
      "position" : 12,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18331631",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18331754"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18331754"
         }
      },
      "body" : "Just asking, is it common or good to have these translated?",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-10-02T10:25:07Z",
      "diff_hunk" : "@@ -2072,30 +2116,44 @@ CBlockIndex* AddToBlockIndex(CBlockHeader& block)\n bool ReceivedBlockTransactions(const CBlock &block, CValidationState& state, CBlockIndex *pindexNew, const CDiskBlockPos& pos)\n {\n     pindexNew->nTx = block.vtx.size();\n-    if (pindexNew->pprev) {\n-        // Not the genesis block.\n-        if (pindexNew->pprev->nChainTx) {\n-            // This parent's block's total number transactions is known, so compute outs.\n-            pindexNew->nChainTx = pindexNew->pprev->nChainTx + pindexNew->nTx;\n-        } else {\n-            // The total number of transactions isn't known yet.\n-            // We will compute it when the block is connected.\n-            pindexNew->nChainTx = 0;\n-        }\n-    } else {\n-        // Genesis block.\n-        pindexNew->nChainTx = pindexNew->nTx;\n-    }\n+    pindexNew->nChainTx = 0;\n     pindexNew->nFile = pos.nFile;\n     pindexNew->nDataPos = pos.nPos;\n     pindexNew->nUndoPos = 0;\n     pindexNew->nStatus |= BLOCK_HAVE_DATA;\n+    pindexNew->RaiseValidity(BLOCK_VALID_TRANSACTIONS);\n+    {\n+         LOCK(cs_nBlockSequenceId);\n+         pindexNew->nSequenceId = nBlockSequenceId++;\n+    }\n \n-    if (pindexNew->RaiseValidity(BLOCK_VALID_TRANSACTIONS))\n-        setBlockIndexValid.insert(pindexNew);\n+    if (pindexNew->pprev == NULL || pindexNew->pprev->nChainTx) {\n+        deque<CBlockIndex*> queue;\n+        queue.push_back(pindexNew);\n \n-    if (!pblocktree->WriteBlockIndex(CDiskBlockIndex(pindexNew)))\n-        return state.Abort(_(\"Failed to write block index\"));\n+        // Recursively process any descendant blocks that now may be eligible to be connected.\n+        while (!queue.empty()) {\n+            CBlockIndex *pindex = queue.front();\n+            queue.pop_front();\n+            pindex->nChainTx = (pindex->pprev ? pindex->pprev->nChainTx : 0) + pindex->nTx;\n+            setBlockIndexValid.insert(pindex);\n+            std::pair<std::multimap<CBlockIndex*, CBlockIndex*>::iterator, std::multimap<CBlockIndex*, CBlockIndex*>::iterator> range = mapBlocksUnlinked.equal_range(pindex);\n+            while (range.first != range.second) {\n+                std::multimap<CBlockIndex*, CBlockIndex*>::iterator it = range.first;\n+                queue.push_back(it->second);\n+                range.first++;\n+                mapBlocksUnlinked.erase(it);\n+            }\n+            if (!pblocktree->WriteBlockIndex(CDiskBlockIndex(pindex)))\n+                return state.Abort(_(\"Failed to write block index\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18331754",
      "id" : 18331754,
      "original_commit_id" : "c6faa4775c1ca884b1742d8fd718c6f577f9ebdc",
      "original_position" : 415,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18331754",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18331806"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18331806"
         }
      },
      "body" : "Could be ``if (pindex && pfrom)``?",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-10-02T10:26:56Z",
      "diff_hunk" : "@@ -2461,93 +2515,27 @@ void CBlockIndex::BuildSkip()\n         pskip = pprev->GetAncestor(GetSkipHeight(nHeight));\n }\n \n-void PushGetBlocks(CNode* pnode, CBlockIndex* pindexBegin, uint256 hashEnd)\n-{\n-    AssertLockHeld(cs_main);\n-    // Filter out duplicate requests\n-    if (pindexBegin == pnode->pindexLastGetBlocksBegin && hashEnd == pnode->hashLastGetBlocksEnd)\n-        return;\n-    pnode->pindexLastGetBlocksBegin = pindexBegin;\n-    pnode->hashLastGetBlocksEnd = hashEnd;\n-\n-    pnode->PushMessage(\"getblocks\", chainActive.GetLocator(pindexBegin), hashEnd);\n-}\n-\n bool ProcessBlock(CValidationState &state, CNode* pfrom, CBlock* pblock, CDiskBlockPos *dbp)\n {\n-    // Check for duplicate\n-    uint256 hash = pblock->GetHash();\n-\n-    {\n-    LOCK(cs_main);\n-    if (mapBlockIndex.count(hash))\n-        return state.Invalid(error(\"ProcessBlock() : already have block %d %s\", mapBlockIndex[hash]->nHeight, hash.ToString()), 0, \"duplicate\");\n-    if (mapOrphanBlocks.count(hash))\n-        return state.Invalid(error(\"ProcessBlock() : already have block (orphan) %s\", hash.ToString()), 0, \"duplicate\");\n-\n     // Preliminary checks\n-    if (!CheckBlock(*pblock, state))\n-        return error(\"ProcessBlock() : CheckBlock FAILED\");\n+    bool checked = CheckBlock(*pblock, state);\n \n-    // If we don't already have its previous block (with full data), shunt it off to holding area until we get it\n-    BlockMap::iterator it = mapBlockIndex.find(pblock->hashPrevBlock);\n-    if (pblock->hashPrevBlock != 0 && (it == mapBlockIndex.end() || !(it->second->nStatus & BLOCK_HAVE_DATA)))\n     {\n-        LogPrintf(\"ProcessBlock: ORPHAN BLOCK %lu, prev=%s\\n\", (unsigned long)mapOrphanBlocks.size(), pblock->hashPrevBlock.ToString());\n-\n-        // Accept orphans as long as there is a node to request its parents from\n-        if (pfrom) {\n-            PruneOrphanBlocks();\n-            COrphanBlock* pblock2 = new COrphanBlock();\n-            {\n-                CDataStream ss(SER_DISK, CLIENT_VERSION);\n-                ss << *pblock;\n-                pblock2->vchBlock = std::vector<unsigned char>(ss.begin(), ss.end());\n-            }\n-            pblock2->hashBlock = hash;\n-            pblock2->hashPrev = pblock->hashPrevBlock;\n-            mapOrphanBlocks.insert(make_pair(hash, pblock2));\n-            mapOrphanBlocksByPrev.insert(make_pair(pblock2->hashPrev, pblock2));\n-\n-            // Ask this guy to fill in what we're missing\n-            PushGetBlocks(pfrom, chainActive.Tip(), GetOrphanRoot(hash));\n+        LOCK(cs_main);\n+        MarkBlockAsReceived(pblock->GetHash());\n+        if (!checked) {\n+            return error(\"ProcessBlock() : CheckBlock FAILED\");\n         }\n-        return true;\n-    }\n \n-    // Store to disk\n-    CBlockIndex *pindex = NULL;\n-    bool ret = AcceptBlock(*pblock, state, &pindex, dbp);\n-    if (!ret)\n-        return error(\"ProcessBlock() : AcceptBlock FAILED\");\n-\n-    // Recursively process any orphan blocks that depended on this one\n-    vector<uint256> vWorkQueue;\n-    vWorkQueue.push_back(hash);\n-    for (unsigned int i = 0; i < vWorkQueue.size(); i++)\n-    {\n-        uint256 hashPrev = vWorkQueue[i];\n-        for (multimap<uint256, COrphanBlock*>::iterator mi = mapOrphanBlocksByPrev.lower_bound(hashPrev);\n-             mi != mapOrphanBlocksByPrev.upper_bound(hashPrev);\n-             ++mi)\n-        {\n-            CBlock block;\n-            {\n-                CDataStream ss(mi->second->vchBlock, SER_DISK, CLIENT_VERSION);\n-                ss >> block;\n-            }\n-            block.BuildMerkleTree();\n-            // Use a dummy CValidationState so someone can't setup nodes to counter-DoS based on orphan resolution (that is, feeding people an invalid block based on LegitBlockX in order to get anyone relaying LegitBlockX banned)\n-            CValidationState stateDummy;\n-            CBlockIndex *pindexChild = NULL;\n-            if (AcceptBlock(block, stateDummy, &pindexChild))\n-                vWorkQueue.push_back(mi->second->hashBlock);\n-            mapOrphanBlocks.erase(mi->second->hashBlock);\n-            delete mi->second;\n+        // Store to disk\n+        CBlockIndex *pindex = NULL;\n+        bool ret = AcceptBlock(*pblock, state, &pindex, dbp);\n+        if (pindex) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18331806",
      "id" : 18331806,
      "original_commit_id" : "c6faa4775c1ca884b1742d8fd718c6f577f9ebdc",
      "original_position" : 631,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18331806",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18353322"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18353322"
         }
      },
      "body" : "iff == if and only if",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-10-02T17:23:11Z",
      "diff_hunk" : "@@ -103,7 +120,8 @@ class CBlockIndex\n     // Note: in a potential headers-first mode, this number cannot be relied upon\n     unsigned int nTx;\n \n-    // (memory only) Number of transactions in the chain up to and including this block\n+    // (memory only) Number of transactions in the chain up to and including this block.\n+    // This value will be non-zero only iff transactions for this block and all its parents are available.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18353322",
      "id" : 18353322,
      "original_commit_id" : "c6faa4775c1ca884b1742d8fd718c6f577f9ebdc",
      "original_position" : 41,
      "path" : "src/chain.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18353322",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18357123"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18357123"
         }
      },
      "body" : "Indeed, this crashes if we only have the genesis block otherwise.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-10-02T18:19:27Z",
      "diff_hunk" : "@@ -4326,9 +4383,18 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n         state.rejects.clear();\n \n         // Start block sync\n-        if (pto->fStartSync && !fImporting && !fReindex) {\n-            pto->fStartSync = false;\n-            PushGetBlocks(pto, chainActive.Tip(), uint256(0));\n+        if (pindexBestHeader == NULL)\n+            pindexBestHeader = chainActive.Tip();\n+        bool fFetch = !pto->fInbound || (pindexBestHeader && (state.pindexLastCommonBlock ? state.pindexLastCommonBlock->nHeight : 0) + 144 > pindexBestHeader->nHeight);\n+        if (!state.fSyncStarted && !pto->fClient && fFetch && !fImporting && !fReindex) {\n+            // Only actively request headers from a single peer, unless we're close to today.\n+            if (nSyncStarted == 0 || pindexBestHeader->GetBlockTime() > GetAdjustedTime() - 24 * 60 * 60) {\n+                state.fSyncStarted = true;\n+                nSyncStarted++;\n+                CBlockIndex *pindexStart = pindexBestHeader->pprev ? pindexBestHeader->pprev : pindexBestHeader;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18357123",
      "id" : 18357123,
      "original_commit_id" : "c6faa4775c1ca884b1742d8fd718c6f577f9ebdc",
      "original_position" : 857,
      "path" : "src/main.cpp",
      "position" : 1065,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18357123",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18357152"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18357152"
         }
      },
      "body" : "Indeed; replaced by 'if and only if'.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-10-02T18:19:52Z",
      "diff_hunk" : "@@ -103,7 +120,8 @@ class CBlockIndex\n     // Note: in a potential headers-first mode, this number cannot be relied upon\n     unsigned int nTx;\n \n-    // (memory only) Number of transactions in the chain up to and including this block\n+    // (memory only) Number of transactions in the chain up to and including this block.\n+    // This value will be non-zero only iff transactions for this block and all its parents are available.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18357152",
      "id" : 18357152,
      "original_commit_id" : "c6faa4775c1ca884b1742d8fd718c6f577f9ebdc",
      "original_position" : 41,
      "path" : "src/chain.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18357152",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18357228"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18357228"
         }
      },
      "body" : "Fixed.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-10-02T18:20:43Z",
      "diff_hunk" : "@@ -50,6 +51,7 @@ bool fTxIndex = false;\n bool fIsBareMultisigStd = true;\n unsigned int nCoinCacheSize = 5000;\n \n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18357228",
      "id" : 18357228,
      "original_commit_id" : "c6faa4775c1ca884b1742d8fd718c6f577f9ebdc",
      "original_position" : 12,
      "path" : "src/main.cpp",
      "position" : 12,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18357228",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18357286"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18357286"
         }
      },
      "body" : "I'm just following existing practice in the code here. I have no opinion.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-10-02T18:21:30Z",
      "diff_hunk" : "@@ -2072,30 +2116,44 @@ CBlockIndex* AddToBlockIndex(CBlockHeader& block)\n bool ReceivedBlockTransactions(const CBlock &block, CValidationState& state, CBlockIndex *pindexNew, const CDiskBlockPos& pos)\n {\n     pindexNew->nTx = block.vtx.size();\n-    if (pindexNew->pprev) {\n-        // Not the genesis block.\n-        if (pindexNew->pprev->nChainTx) {\n-            // This parent's block's total number transactions is known, so compute outs.\n-            pindexNew->nChainTx = pindexNew->pprev->nChainTx + pindexNew->nTx;\n-        } else {\n-            // The total number of transactions isn't known yet.\n-            // We will compute it when the block is connected.\n-            pindexNew->nChainTx = 0;\n-        }\n-    } else {\n-        // Genesis block.\n-        pindexNew->nChainTx = pindexNew->nTx;\n-    }\n+    pindexNew->nChainTx = 0;\n     pindexNew->nFile = pos.nFile;\n     pindexNew->nDataPos = pos.nPos;\n     pindexNew->nUndoPos = 0;\n     pindexNew->nStatus |= BLOCK_HAVE_DATA;\n+    pindexNew->RaiseValidity(BLOCK_VALID_TRANSACTIONS);\n+    {\n+         LOCK(cs_nBlockSequenceId);\n+         pindexNew->nSequenceId = nBlockSequenceId++;\n+    }\n \n-    if (pindexNew->RaiseValidity(BLOCK_VALID_TRANSACTIONS))\n-        setBlockIndexValid.insert(pindexNew);\n+    if (pindexNew->pprev == NULL || pindexNew->pprev->nChainTx) {\n+        deque<CBlockIndex*> queue;\n+        queue.push_back(pindexNew);\n \n-    if (!pblocktree->WriteBlockIndex(CDiskBlockIndex(pindexNew)))\n-        return state.Abort(_(\"Failed to write block index\"));\n+        // Recursively process any descendant blocks that now may be eligible to be connected.\n+        while (!queue.empty()) {\n+            CBlockIndex *pindex = queue.front();\n+            queue.pop_front();\n+            pindex->nChainTx = (pindex->pprev ? pindex->pprev->nChainTx : 0) + pindex->nTx;\n+            setBlockIndexValid.insert(pindex);\n+            std::pair<std::multimap<CBlockIndex*, CBlockIndex*>::iterator, std::multimap<CBlockIndex*, CBlockIndex*>::iterator> range = mapBlocksUnlinked.equal_range(pindex);\n+            while (range.first != range.second) {\n+                std::multimap<CBlockIndex*, CBlockIndex*>::iterator it = range.first;\n+                queue.push_back(it->second);\n+                range.first++;\n+                mapBlocksUnlinked.erase(it);\n+            }\n+            if (!pblocktree->WriteBlockIndex(CDiskBlockIndex(pindex)))\n+                return state.Abort(_(\"Failed to write block index\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18357286",
      "id" : 18357286,
      "original_commit_id" : "c6faa4775c1ca884b1742d8fd718c6f577f9ebdc",
      "original_position" : 415,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18357286",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18357440"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18357440"
         }
      },
      "body" : "Fixed.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-10-02T18:23:33Z",
      "diff_hunk" : "@@ -2461,93 +2515,27 @@ void CBlockIndex::BuildSkip()\n         pskip = pprev->GetAncestor(GetSkipHeight(nHeight));\n }\n \n-void PushGetBlocks(CNode* pnode, CBlockIndex* pindexBegin, uint256 hashEnd)\n-{\n-    AssertLockHeld(cs_main);\n-    // Filter out duplicate requests\n-    if (pindexBegin == pnode->pindexLastGetBlocksBegin && hashEnd == pnode->hashLastGetBlocksEnd)\n-        return;\n-    pnode->pindexLastGetBlocksBegin = pindexBegin;\n-    pnode->hashLastGetBlocksEnd = hashEnd;\n-\n-    pnode->PushMessage(\"getblocks\", chainActive.GetLocator(pindexBegin), hashEnd);\n-}\n-\n bool ProcessBlock(CValidationState &state, CNode* pfrom, CBlock* pblock, CDiskBlockPos *dbp)\n {\n-    // Check for duplicate\n-    uint256 hash = pblock->GetHash();\n-\n-    {\n-    LOCK(cs_main);\n-    if (mapBlockIndex.count(hash))\n-        return state.Invalid(error(\"ProcessBlock() : already have block %d %s\", mapBlockIndex[hash]->nHeight, hash.ToString()), 0, \"duplicate\");\n-    if (mapOrphanBlocks.count(hash))\n-        return state.Invalid(error(\"ProcessBlock() : already have block (orphan) %s\", hash.ToString()), 0, \"duplicate\");\n-\n     // Preliminary checks\n-    if (!CheckBlock(*pblock, state))\n-        return error(\"ProcessBlock() : CheckBlock FAILED\");\n+    bool checked = CheckBlock(*pblock, state);\n \n-    // If we don't already have its previous block (with full data), shunt it off to holding area until we get it\n-    BlockMap::iterator it = mapBlockIndex.find(pblock->hashPrevBlock);\n-    if (pblock->hashPrevBlock != 0 && (it == mapBlockIndex.end() || !(it->second->nStatus & BLOCK_HAVE_DATA)))\n     {\n-        LogPrintf(\"ProcessBlock: ORPHAN BLOCK %lu, prev=%s\\n\", (unsigned long)mapOrphanBlocks.size(), pblock->hashPrevBlock.ToString());\n-\n-        // Accept orphans as long as there is a node to request its parents from\n-        if (pfrom) {\n-            PruneOrphanBlocks();\n-            COrphanBlock* pblock2 = new COrphanBlock();\n-            {\n-                CDataStream ss(SER_DISK, CLIENT_VERSION);\n-                ss << *pblock;\n-                pblock2->vchBlock = std::vector<unsigned char>(ss.begin(), ss.end());\n-            }\n-            pblock2->hashBlock = hash;\n-            pblock2->hashPrev = pblock->hashPrevBlock;\n-            mapOrphanBlocks.insert(make_pair(hash, pblock2));\n-            mapOrphanBlocksByPrev.insert(make_pair(pblock2->hashPrev, pblock2));\n-\n-            // Ask this guy to fill in what we're missing\n-            PushGetBlocks(pfrom, chainActive.Tip(), GetOrphanRoot(hash));\n+        LOCK(cs_main);\n+        MarkBlockAsReceived(pblock->GetHash());\n+        if (!checked) {\n+            return error(\"ProcessBlock() : CheckBlock FAILED\");\n         }\n-        return true;\n-    }\n \n-    // Store to disk\n-    CBlockIndex *pindex = NULL;\n-    bool ret = AcceptBlock(*pblock, state, &pindex, dbp);\n-    if (!ret)\n-        return error(\"ProcessBlock() : AcceptBlock FAILED\");\n-\n-    // Recursively process any orphan blocks that depended on this one\n-    vector<uint256> vWorkQueue;\n-    vWorkQueue.push_back(hash);\n-    for (unsigned int i = 0; i < vWorkQueue.size(); i++)\n-    {\n-        uint256 hashPrev = vWorkQueue[i];\n-        for (multimap<uint256, COrphanBlock*>::iterator mi = mapOrphanBlocksByPrev.lower_bound(hashPrev);\n-             mi != mapOrphanBlocksByPrev.upper_bound(hashPrev);\n-             ++mi)\n-        {\n-            CBlock block;\n-            {\n-                CDataStream ss(mi->second->vchBlock, SER_DISK, CLIENT_VERSION);\n-                ss >> block;\n-            }\n-            block.BuildMerkleTree();\n-            // Use a dummy CValidationState so someone can't setup nodes to counter-DoS based on orphan resolution (that is, feeding people an invalid block based on LegitBlockX in order to get anyone relaying LegitBlockX banned)\n-            CValidationState stateDummy;\n-            CBlockIndex *pindexChild = NULL;\n-            if (AcceptBlock(block, stateDummy, &pindexChild))\n-                vWorkQueue.push_back(mi->second->hashBlock);\n-            mapOrphanBlocks.erase(mi->second->hashBlock);\n-            delete mi->second;\n+        // Store to disk\n+        CBlockIndex *pindex = NULL;\n+        bool ret = AcceptBlock(*pblock, state, &pindex, dbp);\n+        if (pindex) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18357440",
      "id" : 18357440,
      "original_commit_id" : "c6faa4775c1ca884b1742d8fd718c6f577f9ebdc",
      "original_position" : 631,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18357440",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18358235"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18358235"
         }
      },
      "body" : "isn't \"if and only if\" more clear?",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-10-02T18:35:02Z",
      "diff_hunk" : "@@ -103,7 +120,8 @@ class CBlockIndex\n     // Note: in a potential headers-first mode, this number cannot be relied upon\n     unsigned int nTx;\n \n-    // (memory only) Number of transactions in the chain up to and including this block\n+    // (memory only) Number of transactions in the chain up to and including this block.\n+    // This value will be non-zero only iff transactions for this block and all its parents are available.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18358235",
      "id" : 18358235,
      "original_commit_id" : "c6faa4775c1ca884b1742d8fd718c6f577f9ebdc",
      "original_position" : 41,
      "path" : "src/chain.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18358235",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18358306"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18358306"
         }
      },
      "body" : "I don't see any reason why we shouldn't internationalize them.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-10-02T18:36:02Z",
      "diff_hunk" : "@@ -2072,30 +2116,44 @@ CBlockIndex* AddToBlockIndex(CBlockHeader& block)\n bool ReceivedBlockTransactions(const CBlock &block, CValidationState& state, CBlockIndex *pindexNew, const CDiskBlockPos& pos)\n {\n     pindexNew->nTx = block.vtx.size();\n-    if (pindexNew->pprev) {\n-        // Not the genesis block.\n-        if (pindexNew->pprev->nChainTx) {\n-            // This parent's block's total number transactions is known, so compute outs.\n-            pindexNew->nChainTx = pindexNew->pprev->nChainTx + pindexNew->nTx;\n-        } else {\n-            // The total number of transactions isn't known yet.\n-            // We will compute it when the block is connected.\n-            pindexNew->nChainTx = 0;\n-        }\n-    } else {\n-        // Genesis block.\n-        pindexNew->nChainTx = pindexNew->nTx;\n-    }\n+    pindexNew->nChainTx = 0;\n     pindexNew->nFile = pos.nFile;\n     pindexNew->nDataPos = pos.nPos;\n     pindexNew->nUndoPos = 0;\n     pindexNew->nStatus |= BLOCK_HAVE_DATA;\n+    pindexNew->RaiseValidity(BLOCK_VALID_TRANSACTIONS);\n+    {\n+         LOCK(cs_nBlockSequenceId);\n+         pindexNew->nSequenceId = nBlockSequenceId++;\n+    }\n \n-    if (pindexNew->RaiseValidity(BLOCK_VALID_TRANSACTIONS))\n-        setBlockIndexValid.insert(pindexNew);\n+    if (pindexNew->pprev == NULL || pindexNew->pprev->nChainTx) {\n+        deque<CBlockIndex*> queue;\n+        queue.push_back(pindexNew);\n \n-    if (!pblocktree->WriteBlockIndex(CDiskBlockIndex(pindexNew)))\n-        return state.Abort(_(\"Failed to write block index\"));\n+        // Recursively process any descendant blocks that now may be eligible to be connected.\n+        while (!queue.empty()) {\n+            CBlockIndex *pindex = queue.front();\n+            queue.pop_front();\n+            pindex->nChainTx = (pindex->pprev ? pindex->pprev->nChainTx : 0) + pindex->nTx;\n+            setBlockIndexValid.insert(pindex);\n+            std::pair<std::multimap<CBlockIndex*, CBlockIndex*>::iterator, std::multimap<CBlockIndex*, CBlockIndex*>::iterator> range = mapBlocksUnlinked.equal_range(pindex);\n+            while (range.first != range.second) {\n+                std::multimap<CBlockIndex*, CBlockIndex*>::iterator it = range.first;\n+                queue.push_back(it->second);\n+                range.first++;\n+                mapBlocksUnlinked.erase(it);\n+            }\n+            if (!pblocktree->WriteBlockIndex(CDiskBlockIndex(pindex)))\n+                return state.Abort(_(\"Failed to write block index\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18358306",
      "id" : 18358306,
      "original_commit_id" : "c6faa4775c1ca884b1742d8fd718c6f577f9ebdc",
      "original_position" : 415,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18358306",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18360789"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18360789"
         }
      },
      "body" : "Internationalization for rare errors makes them unsearchable (on the internet or in the code base).  Internal/rare errors are really not human readable to begin with.   If we're going to do that, we should do it consistently but also assign code numbers for errors.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-10-02T19:17:23Z",
      "diff_hunk" : "@@ -2072,30 +2116,44 @@ CBlockIndex* AddToBlockIndex(CBlockHeader& block)\n bool ReceivedBlockTransactions(const CBlock &block, CValidationState& state, CBlockIndex *pindexNew, const CDiskBlockPos& pos)\n {\n     pindexNew->nTx = block.vtx.size();\n-    if (pindexNew->pprev) {\n-        // Not the genesis block.\n-        if (pindexNew->pprev->nChainTx) {\n-            // This parent's block's total number transactions is known, so compute outs.\n-            pindexNew->nChainTx = pindexNew->pprev->nChainTx + pindexNew->nTx;\n-        } else {\n-            // The total number of transactions isn't known yet.\n-            // We will compute it when the block is connected.\n-            pindexNew->nChainTx = 0;\n-        }\n-    } else {\n-        // Genesis block.\n-        pindexNew->nChainTx = pindexNew->nTx;\n-    }\n+    pindexNew->nChainTx = 0;\n     pindexNew->nFile = pos.nFile;\n     pindexNew->nDataPos = pos.nPos;\n     pindexNew->nUndoPos = 0;\n     pindexNew->nStatus |= BLOCK_HAVE_DATA;\n+    pindexNew->RaiseValidity(BLOCK_VALID_TRANSACTIONS);\n+    {\n+         LOCK(cs_nBlockSequenceId);\n+         pindexNew->nSequenceId = nBlockSequenceId++;\n+    }\n \n-    if (pindexNew->RaiseValidity(BLOCK_VALID_TRANSACTIONS))\n-        setBlockIndexValid.insert(pindexNew);\n+    if (pindexNew->pprev == NULL || pindexNew->pprev->nChainTx) {\n+        deque<CBlockIndex*> queue;\n+        queue.push_back(pindexNew);\n \n-    if (!pblocktree->WriteBlockIndex(CDiskBlockIndex(pindexNew)))\n-        return state.Abort(_(\"Failed to write block index\"));\n+        // Recursively process any descendant blocks that now may be eligible to be connected.\n+        while (!queue.empty()) {\n+            CBlockIndex *pindex = queue.front();\n+            queue.pop_front();\n+            pindex->nChainTx = (pindex->pprev ? pindex->pprev->nChainTx : 0) + pindex->nTx;\n+            setBlockIndexValid.insert(pindex);\n+            std::pair<std::multimap<CBlockIndex*, CBlockIndex*>::iterator, std::multimap<CBlockIndex*, CBlockIndex*>::iterator> range = mapBlocksUnlinked.equal_range(pindex);\n+            while (range.first != range.second) {\n+                std::multimap<CBlockIndex*, CBlockIndex*>::iterator it = range.first;\n+                queue.push_back(it->second);\n+                range.first++;\n+                mapBlocksUnlinked.erase(it);\n+            }\n+            if (!pblocktree->WriteBlockIndex(CDiskBlockIndex(pindex)))\n+                return state.Abort(_(\"Failed to write block index\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18360789",
      "id" : 18360789,
      "original_commit_id" : "c6faa4775c1ca884b1742d8fd718c6f577f9ebdc",
      "original_position" : 415,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18360789",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18361262"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18361262"
         }
      },
      "body" : "Please only use _() in core for messages passed to the GUI! Otherwise translators spend time translating them for no reason at all. Remember that if you run bitcoind, _() is a no-op.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-10-02T19:24:58Z",
      "diff_hunk" : "@@ -2072,30 +2116,44 @@ CBlockIndex* AddToBlockIndex(CBlockHeader& block)\n bool ReceivedBlockTransactions(const CBlock &block, CValidationState& state, CBlockIndex *pindexNew, const CDiskBlockPos& pos)\n {\n     pindexNew->nTx = block.vtx.size();\n-    if (pindexNew->pprev) {\n-        // Not the genesis block.\n-        if (pindexNew->pprev->nChainTx) {\n-            // This parent's block's total number transactions is known, so compute outs.\n-            pindexNew->nChainTx = pindexNew->pprev->nChainTx + pindexNew->nTx;\n-        } else {\n-            // The total number of transactions isn't known yet.\n-            // We will compute it when the block is connected.\n-            pindexNew->nChainTx = 0;\n-        }\n-    } else {\n-        // Genesis block.\n-        pindexNew->nChainTx = pindexNew->nTx;\n-    }\n+    pindexNew->nChainTx = 0;\n     pindexNew->nFile = pos.nFile;\n     pindexNew->nDataPos = pos.nPos;\n     pindexNew->nUndoPos = 0;\n     pindexNew->nStatus |= BLOCK_HAVE_DATA;\n+    pindexNew->RaiseValidity(BLOCK_VALID_TRANSACTIONS);\n+    {\n+         LOCK(cs_nBlockSequenceId);\n+         pindexNew->nSequenceId = nBlockSequenceId++;\n+    }\n \n-    if (pindexNew->RaiseValidity(BLOCK_VALID_TRANSACTIONS))\n-        setBlockIndexValid.insert(pindexNew);\n+    if (pindexNew->pprev == NULL || pindexNew->pprev->nChainTx) {\n+        deque<CBlockIndex*> queue;\n+        queue.push_back(pindexNew);\n \n-    if (!pblocktree->WriteBlockIndex(CDiskBlockIndex(pindexNew)))\n-        return state.Abort(_(\"Failed to write block index\"));\n+        // Recursively process any descendant blocks that now may be eligible to be connected.\n+        while (!queue.empty()) {\n+            CBlockIndex *pindex = queue.front();\n+            queue.pop_front();\n+            pindex->nChainTx = (pindex->pprev ? pindex->pprev->nChainTx : 0) + pindex->nTx;\n+            setBlockIndexValid.insert(pindex);\n+            std::pair<std::multimap<CBlockIndex*, CBlockIndex*>::iterator, std::multimap<CBlockIndex*, CBlockIndex*>::iterator> range = mapBlocksUnlinked.equal_range(pindex);\n+            while (range.first != range.second) {\n+                std::multimap<CBlockIndex*, CBlockIndex*>::iterator it = range.first;\n+                queue.push_back(it->second);\n+                range.first++;\n+                mapBlocksUnlinked.erase(it);\n+            }\n+            if (!pblocktree->WriteBlockIndex(CDiskBlockIndex(pindex)))\n+                return state.Abort(_(\"Failed to write block index\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18361262",
      "id" : 18361262,
      "original_commit_id" : "c6faa4775c1ca884b1742d8fd718c6f577f9ebdc",
      "original_position" : 415,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18361262",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "@sipa I think the current method of downloading sequential blocks from the same node is fundamentally flawed when there are multiple nodes available because the stall/key node is likely to remain the same node for subsequent blocks. Wouldn't it be better to skip blocks so that if the node becomes slow it doesn't slow down the whole window (due to the node at the end of the window remaining the same slow node)?\r\n\r\nRegarding your comment about the stall node - what is the rationale in disconnecting this node? This would just mean that the block being downloaded is partially downloaded and it's just a guess that another node will be any faster. The only rationale I can see to disconnect a node is if the download is stuck, or going quantifiably slower than it could.",
      "created_at" : "2014-10-03T08:43:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-57769876",
      "id" : 57769876,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-10-03T08:43:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/57769876",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "body" : "So great to finally see a green tick! Thanks @TheBlueMatt and @sipa! I say we should move to merge this as soon as possible, as it's clearly an improvement over the current state.\r\n\r\n> it breaks reindexing, which cannot deal with out-of-order blocks on disk yet\r\n\r\nI suppose this is still a blocker?\r\n",
      "created_at" : "2014-10-03T10:29:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-57778479",
      "id" : 57778479,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-10-03T10:29:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/57778479",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Interleaving blocks is an interesting way to improve things. I'm not\r\nagainst that, but at this stage I really just want some form of HF to be merged\r\nas it's so fundamentally better in many ways (independent of the actual\r\ndownload logic improvements). There are various things that could be done,\r\nincluding reducing the window size of slower peers based on how frequently\r\na node comes close to stalling window movement.\r\n\r\nThe reason for disconnecting peers which are found by the stalling logic\r\ndetection is not that they are \"slow\" by some absolute measure. The fact\r\nthat they prevent movement of the window means that they are just (much)\r\nslower than other peers, and at least for me, disconnecting them seems to\r\nvery quickly result in selecting fast peers.",
      "created_at" : "2014-10-03T15:21:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-57810702",
      "id" : 57810702,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-10-03T17:13:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/57810702",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Interleaving is pretty pessimal for IO performance of the senders. I don't think any scheme of interleaving could have more effect than a increase in window size (proportional to the number of peers). Might be interesting to experiment with, but I don't expect it to be a win all considered.",
      "created_at" : "2014-10-03T16:06:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-57816791",
      "id" : 57816791,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-10-03T16:06:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/57816791",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "@laanwj Yeah, I'll work on fixing reindexing soon. I wasn't expecting comparison tool to grow compatible so quickly :)",
      "created_at" : "2014-10-03T16:58:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-57823421",
      "id" : 57823421,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-10-03T16:58:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/57823421",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "@sipa Actually, in some scenarios it would more sense to disconnect all nodes EXCEPT the node currently providing the oldest block (so that the incoming bandwidth isn't being saturated).\r\n\r\nAlso, the code as is seems to have no limit on how many nodes are sync nodes. I'd suggest setting a limit, and then in the situation where the stall node is disconnected (which was providing the oldest block) instead of requesting that from a node that already has many blocks queued (meaning the oldest block won't get downloaded until all the queued blocks are downloaded from that node first) send the request for blocks (oldest block first) to a node that isn't currently serving any blocks - that way the oldest block will appear much sooner.\r\n\r\nIt would also be good to rotate the nodes that have a break from being downloaded from, so that the speeds of all nodes connected to can be determined and later used for the selection (which node to request a block from) logic.",
      "created_at" : "2014-10-04T06:00:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-57895855",
      "id" : 57895855,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-10-04T06:14:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/57895855",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18427863"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18427863"
         }
      },
      "body" : "What happened to the idea of sending a locator that we know the node will have (to avoid it sending thousands of headers we already have)?",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-10-04T06:16:06Z",
      "diff_hunk" : "@@ -4326,9 +4383,18 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n         state.rejects.clear();\n \n         // Start block sync\n-        if (pto->fStartSync && !fImporting && !fReindex) {\n-            pto->fStartSync = false;\n-            PushGetBlocks(pto, chainActive.Tip(), uint256(0));\n+        if (pindexBestHeader == NULL)\n+            pindexBestHeader = chainActive.Tip();\n+        bool fFetch = !pto->fInbound || (pindexBestHeader && (state.pindexLastCommonBlock ? state.pindexLastCommonBlock->nHeight : 0) + 144 > pindexBestHeader->nHeight);\n+        if (!state.fSyncStarted && !pto->fClient && fFetch && !fImporting && !fReindex) {\n+            // Only actively request headers from a single peer, unless we're close to today.\n+            if (nSyncStarted == 0 || pindexBestHeader->GetBlockTime() > GetAdjustedTime() - 24 * 60 * 60) {\n+                state.fSyncStarted = true;\n+                nSyncStarted++;\n+                CBlockIndex *pindexStart = pindexBestHeader->pprev ? pindexBestHeader->pprev : pindexBestHeader;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18427863",
      "id" : 18427863,
      "original_commit_id" : "c6faa4775c1ca884b1742d8fd718c6f577f9ebdc",
      "original_position" : 857,
      "path" : "src/main.cpp",
      "position" : 1065,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18427863",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18427897"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18427897"
         }
      },
      "body" : "@sipa Where can I find out more about locators? I'm still not understanding the virtue of the code as it currently is, compared with sending the locator based on the same height in our chain as the height advertised by the node to which we're sending the getheaders.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-10-04T06:26:50Z",
      "diff_hunk" : "@@ -4426,9 +4480,15 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n         state.rejects.clear();\n \n         // Start block sync\n-        if (pto->fStartSync && !fImporting && !fReindex) {\n-            pto->fStartSync = false;\n-            PushGetBlocks(pto, chainActive.Tip(), uint256(0));\n+        if (pindexBestHeader == NULL)\n+            pindexBestHeader = chainActive.Tip();\n+        if (!state.fSyncStarted && !pto->fClient && !pto->fInbound && !fImporting && !fReindex) {\n+            // Only actively request headers from a single peer, unless we're close to today.\n+            if (nSyncStarted == 0 || pindexBestHeader->GetBlockTime() > GetAdjustedTime() - 24 * 60 * 60) {\n+                state.fSyncStarted = true;\n+                nSyncStarted++;\n+                pto->PushMessage(\"getheaders\", chainActive.GetLocator(pindexBestHeader->pprev), uint256(0));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18427897",
      "id" : 18427897,
      "original_commit_id" : "2525afb58a71924d48bf99ea19cf741f0c6ccf66",
      "original_position" : 839,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18427897",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "body" : "Was mid-review when you rebased, I'm assuming nothing changed in the first commit...in any case, there are some comments on bcf870bf54578d166b5856d8e7978a2072f8a377",
      "created_at" : "2014-10-05T07:40:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-57929026",
      "id" : 57929026,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-10-05T07:40:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/57929026",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "So I stared at this for a while and couldnt come up with anything clearly broken outside of the few small comments above...still, I'm not as farmiliar with that code as I used to be, so I dont feel comfortable ACKing directly.",
      "created_at" : "2014-10-05T07:43:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-57929072",
      "id" : 57929072,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-10-05T07:43:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/57929072",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "So I'm reasonably happy with everything that isnt -reindex on this one, at least for merge, maybe not release.",
      "created_at" : "2014-10-06T19:21:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-58077695",
      "id" : 58077695,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-10-06T19:21:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/58077695",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Included a squashed version of #5057, together with a commit that fixes the skipping of out-of-order blocks on continued reindex.",
      "created_at" : "2014-10-07T19:37:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-58246828",
      "id" : 58246828,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-10-07T19:37:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/58246828",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "It seems with the new changes it is no longer possible to concatenate every blk****.dat file into one big bootstrap.dat (with orphans) and import that. I think that is needless feature loss.",
      "created_at" : "2014-10-07T22:10:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-58271505",
      "id" : 58271505,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-10-07T22:10:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/58271505",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "We could have a feature to export the blocks in the block files to a\nbootstrap.dat... but that is exactly already what the linearize python\nscript does.\n\nAlso, catting the block files together *will* work for the import\nfunctionality in this PR, so it is still internally consistent. Just\nperhaps not with external application that cannot deal with out-of-order\nblocks (but that's what linearize is for).",
      "created_at" : "2014-10-07T22:26:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-58273288",
      "id" : 58273288,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-10-07T22:26:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/58273288",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "The way I read it it can only handle non-linear blocks if dbp is non-NULL, which it only is for -reindex.",
      "created_at" : "2014-10-07T23:51:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-58282048",
      "id" : 58282048,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-10-07T23:51:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/58282048",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "@TheBlueMatt Looks like you're right. That's unfortunate but not a blocker imho.",
      "created_at" : "2014-10-08T01:17:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-58290857",
      "id" : 58290857,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-10-08T01:17:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/58290857",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Well, should be an easy fix so I brought it up.",
      "created_at" : "2014-10-08T01:49:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-58293842",
      "id" : 58293842,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-10-08T01:49:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/58293842",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "AFAICT dbp is essentially useless there, so adding another one pointing to 0 should be doable?",
      "created_at" : "2014-10-08T01:50:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-58293881",
      "id" : 58293881,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-10-08T01:50:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/58293881",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "> It seems with the new changes it is no longer possible to concatenate every blk****.dat file into one big bootstrap.dat (with orphans) and import that.\r\n\r\nI did that intentially. Handling out-of-order blocks in the general case would result in more complicated code than just handling it for reindex. `CDiskBlockPos` only work inside block files, not to outside files.\r\n(the worst case scenario is quite bad! It means being able to handle blocks in *any* order over multiple files with `-loadblock`, with possibly non-relevant blocks interspersed)\r\n\r\nTo make a bootstrap.dat use linearize.py, I updated it in #5051.\r\n\r\nAnyhow - why bother catting to create a disjointed bootstrap.dat at all? If you want to bootstrap a node from an existing blockchain copy the .blk files to your bitcoin/blocks directory and run `-reindex`! Its faster too, no (extra) copying.\r\n",
      "created_at" : "2014-10-08T06:12:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-58314896",
      "id" : 58314896,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-10-08T06:17:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/58314896",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "OK, if its more work you're right its not worth it, I just figured it'd be 0 extra work, so I'm happy if this were merged pending remaining questions.\r\nNote that that is not an ACK, I'd like to see this merged and move forward pending enough ACKs from others, but I dont feel comfortable enough with the block import code to ACK this directly. ",
      "created_at" : "2014-10-08T06:31:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-58316100",
      "id" : 58316100,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-10-08T06:32:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/58316100",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "@rebroad to get back on the initial getheaders request and the locator passed to it.\r\n\r\nCBlockLocators contain a list of hashes the peer may know about, including just the last 11 leading up to the block referred to, and then several that go further and further back. This means that it's always safe to send a locator that is too far ahead - it's just less efficient.\r\n\r\nThe reason for starting with the best header we have, rather than the best we know the peer already has, is because our information about what the peer has may be out of date. In fact, we actually use that getheaders exactly to learn about what they have (that's the reason for querying one back, so we get something back to learn from). If we don't learn through any other means, sending a getheaders with the point we do know about them would result in downloading every single header from every single peer, which would be a significant waste of bandwidth.\r\n\r\nI do have a different proposal, but I'm just suggesting it here, and don't consider it necessary in this pull request: we stop using getheaders to learn about where peers are, and use it only to learn about actual headers ourselves. To compensate, I suggest sending out getblocks for very small sections of headers after learning them ourselves, randomly but infrequently to all peers. The resulting block invs would teach us as much, be more granular and frequent, and be more efficient.",
      "created_at" : "2014-10-08T22:14:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-58436634",
      "id" : 58436634,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-10-08T22:45:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/58436634",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "@sipa If we send the locator for the block at the advertised block height of the node, then we would get no headers back. If we send the pprev of that block, then we would get 1 header back, the latest header that node has. If for some reason the node has obtained new blocks since we connected to it, we might receive 2 headers back. Either way, I'm not sure I understand your logic that would result in every node sending every header.",
      "created_at" : "2014-10-11T06:35:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-58740096",
      "id" : 58740096,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-10-11T06:35:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/58740096",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18739776"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18739776"
         }
      },
      "body" : "This almost always (in my testing) results in slowing down the download of the block chain as almost always the stalling node is currently sending the block we are waiting for, and disconnecting it simply means we'll have to discard the part of the block already downloaded and request it from another node which is no more likely to be any faster.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-10-11T06:37:57Z",
      "diff_hunk" : "@@ -4384,35 +4481,35 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n         if (!vInv.empty())\n             pto->PushMessage(\"inv\", vInv);\n \n-\n-        // Detect stalled peers. Require that blocks are in flight, we haven't\n-        // received a (requested) block in one minute, and that all blocks are\n-        // in flight for over two minutes, since we first had a chance to\n-        // process an incoming block.\n+        // Detect whether we're stalling\n         int64_t nNow = GetTimeMicros();\n-        if (!pto->fDisconnect && state.nBlocksInFlight &&\n-            state.nLastBlockReceive < state.nLastBlockProcess - BLOCK_DOWNLOAD_TIMEOUT*1000000 &&\n-            state.vBlocksInFlight.front().nTime < state.nLastBlockProcess - 2*BLOCK_DOWNLOAD_TIMEOUT*1000000) {\n-            LogPrintf(\"Peer %s is stalling block download, disconnecting\\n\", state.name);\n+        if (!pto->fDisconnect && state.nStallingSince && state.nStallingSince < nNow - 1000000 * BLOCK_STALLING_TIMEOUT) {\n+            // Stalling only triggers when the block download window cannot move. During normal steady state,\n+            // the download window should be much larger than the to-be-downloaded set of blocks, so disconnection\n+            // should only happen during initial block download.\n+            LogPrintf(\"Peer=%d is stalling block download, disconnecting\\n\", pto->id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18739776",
      "id" : 18739776,
      "original_commit_id" : "e45522bf9cb7efbcb4fd774440ed33758d1effec",
      "original_position" : 1082,
      "path" : "src/main.cpp",
      "position" : 1091,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18739776",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "body" : "@rebroad as sipa was saying, your knoweldge of the peer is often out of sync (consider that its by getting blocks/headers from it at all that we learn anything about it).  If we only ask for a block it doesn't have we're just going to end up pulling like we have nothing in common at all, which is very inefficient.",
      "created_at" : "2014-10-11T06:42:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-58740248",
      "id" : 58740248,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-10-11T06:42:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/58740248",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18739800"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18739800"
         }
      },
      "body" : "Yes, that's completely expected. The point is that other peers managed to progress past the whole window, while we're still waiting on this one peer. There is nothing to be gained from keeping it connected, as we're effectively faster by not downloading from them at all.\r\n\r\nYou could argue that we should wait for a short while to give them a chance to finish the block we're currently fetching, but even in that case, it means wasting time not using bandwidth that other peer could be providing us.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-10-11T06:45:51Z",
      "diff_hunk" : "@@ -4384,35 +4481,35 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n         if (!vInv.empty())\n             pto->PushMessage(\"inv\", vInv);\n \n-\n-        // Detect stalled peers. Require that blocks are in flight, we haven't\n-        // received a (requested) block in one minute, and that all blocks are\n-        // in flight for over two minutes, since we first had a chance to\n-        // process an incoming block.\n+        // Detect whether we're stalling\n         int64_t nNow = GetTimeMicros();\n-        if (!pto->fDisconnect && state.nBlocksInFlight &&\n-            state.nLastBlockReceive < state.nLastBlockProcess - BLOCK_DOWNLOAD_TIMEOUT*1000000 &&\n-            state.vBlocksInFlight.front().nTime < state.nLastBlockProcess - 2*BLOCK_DOWNLOAD_TIMEOUT*1000000) {\n-            LogPrintf(\"Peer %s is stalling block download, disconnecting\\n\", state.name);\n+        if (!pto->fDisconnect && state.nStallingSince && state.nStallingSince < nNow - 1000000 * BLOCK_STALLING_TIMEOUT) {\n+            // Stalling only triggers when the block download window cannot move. During normal steady state,\n+            // the download window should be much larger than the to-be-downloaded set of blocks, so disconnection\n+            // should only happen during initial block download.\n+            LogPrintf(\"Peer=%d is stalling block download, disconnecting\\n\", pto->id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18739800",
      "id" : 18739800,
      "original_commit_id" : "e45522bf9cb7efbcb4fd774440ed33758d1effec",
      "original_position" : 1082,
      "path" : "src/main.cpp",
      "position" : 1091,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18739800",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18739801"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18739801"
         }
      },
      "body" : "Almost?  should be always unless the peer is broken. :)   of course, unless its sitting around doing nothing there will be data in flight.   A result is that you should loadbalance onto faster peers, so while there is some discovery overhead here it should be finite.\r\n\r\nFurther optiimzation could make it somewhat more efficient, e.g. preemptively discontinuing requests and then disconnecting peers that get close to but not quite stalling... but that should probably be future work. (It would add a fair amount of complexity)",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-10-11T06:45:57Z",
      "diff_hunk" : "@@ -4384,35 +4481,35 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n         if (!vInv.empty())\n             pto->PushMessage(\"inv\", vInv);\n \n-\n-        // Detect stalled peers. Require that blocks are in flight, we haven't\n-        // received a (requested) block in one minute, and that all blocks are\n-        // in flight for over two minutes, since we first had a chance to\n-        // process an incoming block.\n+        // Detect whether we're stalling\n         int64_t nNow = GetTimeMicros();\n-        if (!pto->fDisconnect && state.nBlocksInFlight &&\n-            state.nLastBlockReceive < state.nLastBlockProcess - BLOCK_DOWNLOAD_TIMEOUT*1000000 &&\n-            state.vBlocksInFlight.front().nTime < state.nLastBlockProcess - 2*BLOCK_DOWNLOAD_TIMEOUT*1000000) {\n-            LogPrintf(\"Peer %s is stalling block download, disconnecting\\n\", state.name);\n+        if (!pto->fDisconnect && state.nStallingSince && state.nStallingSince < nNow - 1000000 * BLOCK_STALLING_TIMEOUT) {\n+            // Stalling only triggers when the block download window cannot move. During normal steady state,\n+            // the download window should be much larger than the to-be-downloaded set of blocks, so disconnection\n+            // should only happen during initial block download.\n+            LogPrintf(\"Peer=%d is stalling block download, disconnecting\\n\", pto->id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18739801",
      "id" : 18739801,
      "original_commit_id" : "e45522bf9cb7efbcb4fd774440ed33758d1effec",
      "original_position" : 1082,
      "path" : "src/main.cpp",
      "position" : 1091,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18739801",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18739949"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18739949"
         }
      },
      "body" : "Before we know what the peer has, doing that would be asking them for _all_ headers which is much worse.",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-10-11T07:20:16Z",
      "diff_hunk" : "@@ -4326,9 +4383,18 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n         state.rejects.clear();\n \n         // Start block sync\n-        if (pto->fStartSync && !fImporting && !fReindex) {\n-            pto->fStartSync = false;\n-            PushGetBlocks(pto, chainActive.Tip(), uint256(0));\n+        if (pindexBestHeader == NULL)\n+            pindexBestHeader = chainActive.Tip();\n+        bool fFetch = !pto->fInbound || (pindexBestHeader && (state.pindexLastCommonBlock ? state.pindexLastCommonBlock->nHeight : 0) + 144 > pindexBestHeader->nHeight);\n+        if (!state.fSyncStarted && !pto->fClient && fFetch && !fImporting && !fReindex) {\n+            // Only actively request headers from a single peer, unless we're close to today.\n+            if (nSyncStarted == 0 || pindexBestHeader->GetBlockTime() > GetAdjustedTime() - 24 * 60 * 60) {\n+                state.fSyncStarted = true;\n+                nSyncStarted++;\n+                CBlockIndex *pindexStart = pindexBestHeader->pprev ? pindexBestHeader->pprev : pindexBestHeader;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18739949",
      "id" : 18739949,
      "original_commit_id" : "c6faa4775c1ca884b1742d8fd718c6f577f9ebdc",
      "original_position" : 857,
      "path" : "src/main.cpp",
      "position" : 1065,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-14T23:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18739949",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "I added a commit that AFAICT should allow >2000 deep reorgs. I tried to enable the reorg test in Travis, but that fails due to >4Mbyte of produced log.",
      "created_at" : "2014-10-14T23:37:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-59135639",
      "id" : 59135639,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-10-14T23:37:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/59135639",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18959019"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18959019"
         }
      },
      "body" : "@sipa The change I am proposing results in nodes sending just one header. ",
      "commit_id" : "e11b2ce4c63b87efa60b163b50d155969ccd7e08",
      "created_at" : "2014-10-16T14:40:26Z",
      "diff_hunk" : "@@ -4326,9 +4383,18 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n         state.rejects.clear();\n \n         // Start block sync\n-        if (pto->fStartSync && !fImporting && !fReindex) {\n-            pto->fStartSync = false;\n-            PushGetBlocks(pto, chainActive.Tip(), uint256(0));\n+        if (pindexBestHeader == NULL)\n+            pindexBestHeader = chainActive.Tip();\n+        bool fFetch = !pto->fInbound || (pindexBestHeader && (state.pindexLastCommonBlock ? state.pindexLastCommonBlock->nHeight : 0) + 144 > pindexBestHeader->nHeight);\n+        if (!state.fSyncStarted && !pto->fClient && fFetch && !fImporting && !fReindex) {\n+            // Only actively request headers from a single peer, unless we're close to today.\n+            if (nSyncStarted == 0 || pindexBestHeader->GetBlockTime() > GetAdjustedTime() - 24 * 60 * 60) {\n+                state.fSyncStarted = true;\n+                nSyncStarted++;\n+                CBlockIndex *pindexStart = pindexBestHeader->pprev ? pindexBestHeader->pprev : pindexBestHeader;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#discussion_r18959019",
      "id" : 18959019,
      "original_commit_id" : "c6faa4775c1ca884b1742d8fd718c6f577f9ebdc",
      "original_position" : 857,
      "path" : "src/main.cpp",
      "position" : 1065,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4468",
      "updated_at" : "2014-10-16T14:40:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/18959019",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "body" : "Tested ACK",
      "created_at" : "2014-10-17T08:48:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-59484837",
      "id" : 59484837,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-10-17T08:48:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/59484837",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Tested ACK.\r\n\r\nI've reviewed this at many points in time and tried many cases (and hit a number of issues which have been fixed).   I expect that it still has some remaining bugs, but our behavior without it is almost uselessly bad in the common case... getting some wider usage (in master) will help shake out issues. We know we're going to have a long cycle of testing in master on this version, so lets get that started.",
      "created_at" : "2014-10-17T08:56:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-59485598",
      "id" : 59485598,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-10-17T08:56:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/59485598",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Seems to function fine on ARMv6.",
      "created_at" : "2014-10-17T09:41:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4468#issuecomment-59490374",
      "id" : 59490374,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4468",
      "updated_at" : "2014-10-17T09:41:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/59490374",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10137?v=3",
         "events_url" : "https://api.github.com/users/ghost/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ghost/followers",
         "following_url" : "https://api.github.com/users/ghost/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ghost/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ghost",
         "id" : 10137,
         "login" : "ghost",
         "organizations_url" : "https://api.github.com/users/ghost/orgs",
         "received_events_url" : "https://api.github.com/users/ghost/received_events",
         "repos_url" : "https://api.github.com/users/ghost/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ghost/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ghost/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ghost"
      }
   }
]
