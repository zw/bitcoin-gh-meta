{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "This is a rather long branch, split up into three PRs, with lots of cleanup and tweaks here and there that evntually gets us CNodeStates which have their own locks, locked before cs_main, which makes nodes not always require cs_main to do simple things like call Misbehaving(). The final result is at https://github.com/TheBlueMatt/bitcoin/tree/2017-06-cnodestateaccessors-3 (and next PR is https://github.com/TheBlueMatt/bitcoin/tree/2017-06-cnodestateaccessors-2).\r\n\r\nThis PR is primarily some small cleanups and the first few commits of #9447 rebased on #10179 and with small tweaks.\r\n\r\nThe result is that we take the lock for the CNodeState for the node we're processing at the top of ProcessMessages/SendMessages, and hold it until the end, passing around an accessor to the CNodeState as we go. This moves towards a few goals: (1) ability to run ProcessMessages() in paralell, (2) move towards a world where ProcessMessage() is a function in CNodeState, which are objects owned by CConnman.\r\n\r\nThis isn't a trivial thing to pull off because of lockorder, which introduces two issues:\r\n * There are a few places we call State() as a result of callbacks from CValidationInterface. Addressed by extending the CValidationInterface threading introduced in #10179 and used for wallet to a few more functions.\r\n * You can't take two State() accessors at once, because then you'd have undefined lockorder. Luckily with the CValidationInterface threading changes gets most of those, but also the first few commits from #9447 are needed (included here rebased and slightly tweaked) as well as two little tweaks to be able to apply DoS score after unlocking the CNodeState of the node we're processing on.\r\n\r\nBy the end DEBUG_LOCKORDER features are added to stricly enforce these potential issues (and I've been testing it a bunch in helgrind, etc).",
   "closed_at" : "2017-08-14T19:05:17Z",
   "closed_by" : {
      "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
      "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
      "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/TheBlueMatt",
      "id" : 649246,
      "login" : "TheBlueMatt",
      "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
      "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
      "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/TheBlueMatt"
   },
   "comments" : 7,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10652/comments",
   "created_at" : "2017-06-22T19:56:05Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10652/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/10652",
   "id" : 237956154,
   "labels" : [
      {
         "color" : "E6F6D6",
         "default" : false,
         "id" : 135961,
         "name" : "Refactoring",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Refactoring"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10652/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "number" : 10652,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/10652.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10652",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/10652.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10652"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "Small step towards demangling cs_main from CNodeState",
   "updated_at" : "2018-01-10T23:43:35Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10652",
   "user" : {
      "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
      "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
      "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/TheBlueMatt",
      "id" : 649246,
      "login" : "TheBlueMatt",
      "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
      "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
      "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/TheBlueMatt"
   }
}
