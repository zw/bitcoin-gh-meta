[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#22976](https://github.com/bitcoin/bitcoin/pull/22976) (scripted-diff: Rename overloaded int GetArg to GetIntArg by ryanofsky)\n* [#22485](https://github.com/bitcoin/bitcoin/pull/22485) (index: doc/log BaseIndex sync behavior with empty datadir by jamesob)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-04-19T03:52:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-822147133",
      "id" : 822147133,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMjE0NzEzMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-26T12:10:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/822147133",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r615556639"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615556639"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This function doesn't use any member of BlockManager, so could be stand-alone? Also, I think you can avoid this check by having the caller pass a `const CBlockIndex& start_block`.",
      "commit_id" : "23fb6feec6c070943e4a6ee94055c9d47b6c8a90",
      "created_at" : "2021-04-19T05:49:00Z",
      "diff_hunk" : "@@ -1335,6 +1334,14 @@ int BlockManager::GetSpendHeight(const CCoinsViewCache& inputs)\n     return pindexPrev->nHeight + 1;\n }\n \n+const CBlockIndex* BlockManager::GetLastPruneBlock(const CBlockIndex* start_block) {\n+    const CBlockIndex* block = start_block;\n+    CHECK_NONFATAL(block);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r615556639",
      "id" : 615556639,
      "line" : 1339,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTU1NjYzOQ==",
      "original_commit_id" : "23fb6feec6c070943e4a6ee94055c9d47b6c8a90",
      "original_line" : 1339,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 14,
      "pull_request_review_id" : 638479069,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T05:49:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615556639",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r632032296"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632032296"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks! I made the changes as suggested.",
      "commit_id" : "7cb32c39c01c95ae7dce65881707db190fe74aa4",
      "created_at" : "2021-05-13T18:55:13Z",
      "diff_hunk" : "@@ -1335,6 +1334,14 @@ int BlockManager::GetSpendHeight(const CCoinsViewCache& inputs)\n     return pindexPrev->nHeight + 1;\n }\n \n+const CBlockIndex* BlockManager::GetLastPruneBlock(const CBlockIndex* start_block) {\n+    const CBlockIndex* block = start_block;\n+    CHECK_NONFATAL(block);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r632032296",
      "id" : 632032296,
      "in_reply_to_id" : 615556639,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjAzMjI5Ng==",
      "original_commit_id" : "23fb6feec6c070943e4a6ee94055c9d47b6c8a90",
      "original_line" : 1339,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 659205588,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-13T18:55:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632032296",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK, I think this is an elegant approach.",
      "created_at" : "2021-05-17T18:27:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-842538559",
      "id" : 842538559,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0MjUzODU1OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-17T18:27:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/842538559",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638228451"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638228451"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 5d23ddf5ff3bd1e5d4f6b85440d9ad0c59bb9994 \"Add prune blockers to BlockManager\"\r\n\r\nSince this has `EXCLUSIVE_LOCKS_REQUIRED`, I think it should also have `AssertLockHeld` in here too.",
      "commit_id" : "11f01efadf8e93f042ebd05d12f1f3bc5bce8178",
      "created_at" : "2021-05-24T19:42:35Z",
      "diff_hunk" : "@@ -3663,6 +3673,10 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(std::string name, const CBlockIndex* block) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638228451",
      "id" : 638228451,
      "line" : 3672,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODIyODQ1MQ==",
      "original_commit_id" : "5d23ddf5ff3bd1e5d4f6b85440d9ad0c59bb9994",
      "original_line" : 3676,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 32,
      "pull_request_review_id" : 667113687,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-24T19:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638228451",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638325082"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638325082"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Right, fixed!",
      "commit_id" : "b5862425806c29fc9628f5c82181658dcea722b3",
      "created_at" : "2021-05-24T22:13:42Z",
      "diff_hunk" : "@@ -3663,6 +3673,10 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(std::string name, const CBlockIndex* block) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638325082",
      "id" : 638325082,
      "in_reply_to_id" : 638228451,
      "line" : 3672,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODMyNTA4Mg==",
      "original_commit_id" : "5d23ddf5ff3bd1e5d4f6b85440d9ad0c59bb9994",
      "original_line" : 3672,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 32,
      "pull_request_review_id" : 667236323,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-24T22:13:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638325082",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638347138"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638347138"
         }
      },
      "author_association" : "MEMBER",
      "body" : "bfe9719e29d7947e2ffa9b510cd078e8a09b5d03\r\n\r\nnit, `GetLastPrunedBlock`?",
      "commit_id" : "b5862425806c29fc9628f5c82181658dcea722b3",
      "created_at" : "2021-05-24T23:11:22Z",
      "diff_hunk" : "@@ -51,6 +51,14 @@ bool IsBlockPruned(const CBlockIndex* pblockindex)\n     return (fHavePruned && !(pblockindex->nStatus & BLOCK_HAVE_DATA) && pblockindex->nTx > 0);\n }\n \n+const CBlockIndex* GetLastPruneBlock(const CBlockIndex& start_block) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638347138",
      "id" : 638347138,
      "line" : 54,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODM0NzEzOA==",
      "original_commit_id" : "bfe9719e29d7947e2ffa9b510cd078e8a09b5d03",
      "original_line" : 54,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 4,
      "pull_request_review_id" : 667264075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-24T23:22:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638347138",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638347828"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638347828"
         }
      },
      "author_association" : "MEMBER",
      "body" : "b5a239390fd1b31c7e6107a2e6c35658a2b4697c\r\n\r\nnit, `const std::string&`.",
      "commit_id" : "b5862425806c29fc9628f5c82181658dcea722b3",
      "created_at" : "2021-05-24T23:13:19Z",
      "diff_hunk" : "@@ -450,6 +450,10 @@ class BlockManager\n      */\n     int GetSpendHeight(const CCoinsViewCache& inputs) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    std::unordered_map<std::string, const CBlockIndex*> m_prune_blockers;\n+\n+    void UpdatePruneBlocker(std::string name, const CBlockIndex* block) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638347828",
      "id" : 638347828,
      "line" : 455,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODM0NzgyOA==",
      "original_commit_id" : "b5a239390fd1b31c7e6107a2e6c35658a2b4697c",
      "original_line" : 455,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 6,
      "pull_request_review_id" : 667264075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-24T23:22:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638347828",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638348578"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638348578"
         }
      },
      "author_association" : "MEMBER",
      "body" : "b5a239390fd1b31c7e6107a2e6c35658a2b4697c\r\n\r\nHow can it be `nullptr`?",
      "commit_id" : "b5862425806c29fc9628f5c82181658dcea722b3",
      "created_at" : "2021-05-24T23:15:37Z",
      "diff_hunk" : "@@ -2041,6 +2041,16 @@ bool CChainState::FlushStateToDisk(\n                last_prune = std::max(1, std::min(last_prune, index.GetSummary().best_block_height));\n             });\n \n+            for (auto const& blocker : m_blockman.m_prune_blockers) {\n+                if (blocker.second) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638348578",
      "id" : 638348578,
      "line" : 2041,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODM0ODU3OA==",
      "original_commit_id" : "b5a239390fd1b31c7e6107a2e6c35658a2b4697c",
      "original_line" : 2045,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 17,
      "pull_request_review_id" : 667264075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-24T23:22:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638348578",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638348949"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638348949"
         }
      },
      "author_association" : "MEMBER",
      "body" : "b5a239390fd1b31c7e6107a2e6c35658a2b4697c\r\n\r\nShould check/assert it only goes forward when updating?",
      "commit_id" : "b5862425806c29fc9628f5c82181658dcea722b3",
      "created_at" : "2021-05-24T23:16:45Z",
      "diff_hunk" : "@@ -3663,6 +3673,11 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(std::string name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638348949",
      "id" : 638348949,
      "line" : 3674,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODM0ODk0OQ==",
      "original_commit_id" : "b5a239390fd1b31c7e6107a2e6c35658a2b4697c",
      "original_line" : 3678,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 34,
      "pull_request_review_id" : 667264075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-24T23:22:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638348949",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638349497"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638349497"
         }
      },
      "author_association" : "MEMBER",
      "body" : "d18677006d3d48ca7654039ea6e267164a2690e0\r\n\r\nnit, use ternary? `block ? block : ::ChainActive().Genesis()`",
      "commit_id" : "b5862425806c29fc9628f5c82181658dcea722b3",
      "created_at" : "2021-05-24T23:18:33Z",
      "diff_hunk" : "@@ -364,3 +364,15 @@ IndexSummary BaseIndex::GetSummary() const\n     summary.best_block_height = m_best_block_index ? m_best_block_index.load()->nHeight : 0;\n     return summary;\n }\n+\n+void BaseIndex::SetBestBlockIndex(const CBlockIndex* block) {\n+    m_best_block_index = block;\n+    if (AllowPrune()) {\n+        LOCK(::cs_main);\n+        if (!block) {\n+            g_chainman.m_blockman.UpdatePruneBlocker(GetName(), ::ChainActive().Genesis());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638349497",
      "id" : 638349497,
      "line" : 373,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODM0OTQ5Nw==",
      "original_commit_id" : "d18677006d3d48ca7654039ea6e267164a2690e0",
      "original_line" : 373,
      "original_position" : 71,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 95,
      "pull_request_review_id" : 667264075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-24T23:22:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638349497",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640188761"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188761"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I am not sure. The way I use it right now it can also go down with reorgs. I am undecided what the right course is. Only going up avoids a potential footgun, with going down it could react to (highly unlikely) deep reorg. If I add this I think I would do it so that setting a lower number is simply a no op:\r\n\r\n```\r\nif (m_prune_blockers[name] < block) m_prune_blockers[name] = block;\r\n```",
      "commit_id" : "50cd98519097e11936e0efbd0bfa3b33d0317423",
      "created_at" : "2021-05-26T23:36:05Z",
      "diff_hunk" : "@@ -3663,6 +3673,11 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(std::string name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640188761",
      "id" : 640188761,
      "in_reply_to_id" : 638348949,
      "line" : 3672,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDE4ODc2MQ==",
      "original_commit_id" : "b5a239390fd1b31c7e6107a2e6c35658a2b4697c",
      "original_line" : 3672,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 36,
      "pull_request_review_id" : 669625747,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-26T23:36:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188761",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640188783"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188783"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done",
      "commit_id" : "50cd98519097e11936e0efbd0bfa3b33d0317423",
      "created_at" : "2021-05-26T23:36:10Z",
      "diff_hunk" : "@@ -364,3 +364,15 @@ IndexSummary BaseIndex::GetSummary() const\n     summary.best_block_height = m_best_block_index ? m_best_block_index.load()->nHeight : 0;\n     return summary;\n }\n+\n+void BaseIndex::SetBestBlockIndex(const CBlockIndex* block) {\n+    m_best_block_index = block;\n+    if (AllowPrune()) {\n+        LOCK(::cs_main);\n+        if (!block) {\n+            g_chainman.m_blockman.UpdatePruneBlocker(GetName(), ::ChainActive().Genesis());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640188783",
      "id" : 640188783,
      "in_reply_to_id" : 638349497,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDE4ODc4Mw==",
      "original_commit_id" : "d18677006d3d48ca7654039ea6e267164a2690e0",
      "original_line" : 373,
      "original_position" : 71,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 669625774,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-26T23:36:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188783",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640188853"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188853"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I guess it should never be `nullptr`. Dropped that if statement.",
      "commit_id" : "50cd98519097e11936e0efbd0bfa3b33d0317423",
      "created_at" : "2021-05-26T23:36:20Z",
      "diff_hunk" : "@@ -2041,6 +2041,16 @@ bool CChainState::FlushStateToDisk(\n                last_prune = std::max(1, std::min(last_prune, index.GetSummary().best_block_height));\n             });\n \n+            for (auto const& blocker : m_blockman.m_prune_blockers) {\n+                if (blocker.second) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640188853",
      "id" : 640188853,
      "in_reply_to_id" : 638348578,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDE4ODg1Mw==",
      "original_commit_id" : "b5a239390fd1b31c7e6107a2e6c35658a2b4697c",
      "original_line" : 2045,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 669625858,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-26T23:36:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188853",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640188945"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188945"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done",
      "commit_id" : "50cd98519097e11936e0efbd0bfa3b33d0317423",
      "created_at" : "2021-05-26T23:36:37Z",
      "diff_hunk" : "@@ -450,6 +450,10 @@ class BlockManager\n      */\n     int GetSpendHeight(const CCoinsViewCache& inputs) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    std::unordered_map<std::string, const CBlockIndex*> m_prune_blockers;\n+\n+    void UpdatePruneBlocker(std::string name, const CBlockIndex* block) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640188945",
      "id" : 640188945,
      "in_reply_to_id" : 638347828,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDE4ODk0NQ==",
      "original_commit_id" : "b5a239390fd1b31c7e6107a2e6c35658a2b4697c",
      "original_line" : 455,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 669625968,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-26T23:36:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188945",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640188998"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188998"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done",
      "commit_id" : "50cd98519097e11936e0efbd0bfa3b33d0317423",
      "created_at" : "2021-05-26T23:36:45Z",
      "diff_hunk" : "@@ -51,6 +51,14 @@ bool IsBlockPruned(const CBlockIndex* pblockindex)\n     return (fHavePruned && !(pblockindex->nStatus & BLOCK_HAVE_DATA) && pblockindex->nTx > 0);\n }\n \n+const CBlockIndex* GetLastPruneBlock(const CBlockIndex& start_block) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640188998",
      "id" : 640188998,
      "in_reply_to_id" : 638347138,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDE4ODk5OA==",
      "original_commit_id" : "bfe9719e29d7947e2ffa9b510cd078e8a09b5d03",
      "original_line" : 54,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 669626026,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-26T23:36:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188998",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Addressed comments by @promag , thank you!\r\n\r\nI also fixed a comment I had overlooked and added a new commit at the end because I realized that we can skip the pruning stuff in `index/base` if the node is not actually pruning. With the new behavior especially this prevents locking `cs_main`. Happy to squash this but I am still checking that this is 100% safe and want to make sure it is looked at separately because it was not included in the existing concept acks.",
      "created_at" : "2021-05-26T23:41:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-849190916",
      "id" : 849190916,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0OTE5MDkxNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-26T23:41:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/849190916",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640190703"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640190703"
         }
      },
      "author_association" : "MEMBER",
      "body" : "But what should happen if the block is already pruned?",
      "commit_id" : "50cd98519097e11936e0efbd0bfa3b33d0317423",
      "created_at" : "2021-05-26T23:41:48Z",
      "diff_hunk" : "@@ -3663,6 +3673,11 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(std::string name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640190703",
      "id" : 640190703,
      "in_reply_to_id" : 638348949,
      "line" : 3672,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDE5MDcwMw==",
      "original_commit_id" : "b5a239390fd1b31c7e6107a2e6c35658a2b4697c",
      "original_line" : 3672,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 36,
      "pull_request_review_id" : 669627925,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-26T23:41:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640190703",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-06-01T12:10:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-852072880",
      "id" : 852072880,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1MjA3Mjg4MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-01T12:10:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/852072880",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r643467366"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/643467366"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hm, that would mean the node would have to restart with `-reindex` anyway, right?",
      "commit_id" : "50cd98519097e11936e0efbd0bfa3b33d0317423",
      "created_at" : "2021-06-01T20:46:34Z",
      "diff_hunk" : "@@ -3663,6 +3673,11 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(std::string name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r643467366",
      "id" : 643467366,
      "in_reply_to_id" : 638348949,
      "line" : 3672,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MzQ2NzM2Ng==",
      "original_commit_id" : "b5a239390fd1b31c7e6107a2e6c35658a2b4697c",
      "original_line" : 3672,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 36,
      "pull_request_review_id" : 673564476,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-01T20:46:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/643467366",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> How about keeping some blocks before the deepest prune blocker?\r\n\r\nInteresting. That should help make it a bit more robust. I added this but set it pretty low for now (10), looking for feedback if it should be higher. I also encapsulated the logic for getting the deepest prune height into it's own function to not have more logic in `FlushStateToDisk`.\r\n\r\nAlso rebased.",
      "created_at" : "2021-06-01T23:17:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-852550603",
      "id" : 852550603,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1MjU1MDYwMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-01T23:17:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/852550603",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r644094388"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644094388"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactor: Introduce GetLastPruneBlock helper function\" (292d508e956bfe5b05e6ee685415063c2a0f04af)\r\n\r\nNote: Here and in the other location below there's no more CHECK_NONFATAL so there would be segfault instead of an exception if the tip was null. Doesn't seem like a problem, but if were for some reason, GetLastPrunedBlock argument could be a pointer instead of a reference and the check could be added there.",
      "commit_id" : "e365e87a72cc49e175b31256a11a6c5b1621d1f2",
      "created_at" : "2021-06-02T15:46:54Z",
      "diff_hunk" : "@@ -1069,12 +1069,9 @@ static RPCHelpMan pruneblockchain()\n     }\n \n     PruneBlockFilesManual(active_chainstate, height);\n-    const CBlockIndex* block = active_chain.Tip();\n-    CHECK_NONFATAL(block);\n-    while (block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA)) {\n-        block = block->pprev;\n-    }\n-    return uint64_t(block->nHeight);\n+    const CBlockIndex* last_block = GetLastPrunedBlock(*active_chain.Tip());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r644094388",
      "id" : 644094388,
      "line" : 1072,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NDA5NDM4OA==",
      "original_commit_id" : "292d508e956bfe5b05e6ee685415063c2a0f04af",
      "original_line" : 1072,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 10,
      "pull_request_review_id" : 674379812,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-02T15:49:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644094388",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r644109721"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644109721"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Add prune blockers to BlockManager\" (9f8d6a9a8f7d113ae12306c72a773830b5725e37)\r\n\r\nWould be good to have a descriptive comment like:\r\n\r\n```c++\r\n//! Map from external index name to most recent block the index can tolerate being pruned.\r\n//!\r\n//! @note Internally, only blocks at height (block->nHeight + PRUNE_BLOCKER_BUFFER) and\r\n//! below will be pruned, but callers should avoid assuming any particular buffer size.\r\n```",
      "commit_id" : "e365e87a72cc49e175b31256a11a6c5b1621d1f2",
      "created_at" : "2021-06-02T16:04:50Z",
      "diff_hunk" : "@@ -494,6 +497,12 @@ class BlockManager\n      */\n     int GetSpendHeight(const CCoinsViewCache& inputs) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    std::unordered_map<std::string, const CBlockIndex*> m_prune_blockers;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r644109721",
      "id" : 644109721,
      "line" : 500,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NDEwOTcyMQ==",
      "original_commit_id" : "9f8d6a9a8f7d113ae12306c72a773830b5725e37",
      "original_line" : 500,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 14,
      "pull_request_review_id" : 674399868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-02T18:11:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644109721",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r644115299"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644115299"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Add prune blockers to BlockManager\" (9f8d6a9a8f7d113ae12306c72a773830b5725e37)\r\n\r\nJust a style suggestion, so feel free to ignore, but usage of this function seems awkward to understand with last_prune being an input and an output parameter. I think FlushStateToDisk would be easier to read with the code in this function just inlined there (which is the only place where it is called).",
      "commit_id" : "e365e87a72cc49e175b31256a11a6c5b1621d1f2",
      "created_at" : "2021-06-02T16:12:07Z",
      "diff_hunk" : "@@ -3792,6 +3794,21 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(const std::string& name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;\n+}\n+\n+void BlockManager::GetLastPruneBlockerHeight(int& last_prune) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r644115299",
      "id" : 644115299,
      "line" : 3798,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NDExNTI5OQ==",
      "original_commit_id" : "9f8d6a9a8f7d113ae12306c72a773830b5725e37",
      "original_line" : 3802,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 33,
      "pull_request_review_id" : 674399868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-02T18:11:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644115299",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r644173288"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644173288"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Add prune blockers to BlockManager\" (9f8d6a9a8f7d113ae12306c72a773830b5725e37):\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/21726#discussion_r643467366\r\n\r\n> Hm, that would mean the node would have to restart with `-reindex` anyway, right?\r\n\r\nIt would be nice to have a test for this case if there isn't one. does seem like like if there was reorg and a block needed by the index was pruned, the index should be responsible for handling the error when the rewind method is called. I guess the index could just disable itself or stop the node at that point.\r\n\r\nBut for this `UpdatePruneBlocker` method, it would seem too strict to never allow a blocker to move backwards, because moving an existing blocker backwards seems no worse of a problem than adding new blocker at a lower minimum height. Maybe it could be useful to have a sanity check here which asserts that whenever a new minimum height is set in the map, that no blocks in the (new_min_height, prev_min_height] range have been pruned. But this doesn't seem strictly necessary either if we are confident that indexes compatible with pruning are able to handle pruned block errors safely when they are syncing or handling reorgs",
      "commit_id" : "e365e87a72cc49e175b31256a11a6c5b1621d1f2",
      "created_at" : "2021-06-02T17:23:40Z",
      "diff_hunk" : "@@ -3663,6 +3673,11 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(std::string name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r644173288",
      "id" : 644173288,
      "in_reply_to_id" : 638348949,
      "line" : 3795,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NDE3MzI4OA==",
      "original_commit_id" : "b5a239390fd1b31c7e6107a2e6c35658a2b4697c",
      "original_line" : 3795,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 30,
      "pull_request_review_id" : 674399868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-02T18:11:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644173288",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r644205509"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644205509"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Add prune blockers to BlockManager\" (9f8d6a9a8f7d113ae12306c72a773830b5725e37):\r\n\r\nWould it make sense to use a log category here `LogPrint(BCLog::PRUNE, ...)` instead of printing unconditionally? Also in the future it could be nice to unify this print with the prints in the FindFilesToPrune functions and print the full pruning status in a consistent way on just one line.",
      "commit_id" : "e365e87a72cc49e175b31256a11a6c5b1621d1f2",
      "created_at" : "2021-06-02T18:06:23Z",
      "diff_hunk" : "@@ -3792,6 +3794,21 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(const std::string& name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;\n+}\n+\n+void BlockManager::GetLastPruneBlockerHeight(int& last_prune) {\n+    for (auto const& blocker : m_prune_blockers) {\n+        const int blocker_height = blocker.second->nHeight + PRUNE_BLOCKER_BUFFER;\n+        last_prune = std::max(1, std::min(last_prune, blocker_height));\n+        if (last_prune == blocker_height) {\n+            LogPrintf(\"%s limited pruning to height %d\\n\", blocker.first, blocker_height);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r644205509",
      "id" : 644205509,
      "line" : 3803,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NDIwNTUwOQ==",
      "original_commit_id" : "9f8d6a9a8f7d113ae12306c72a773830b5725e37",
      "original_line" : 3807,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 38,
      "pull_request_review_id" : 674399868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-02T18:11:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644205509",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r654778191"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/654778191"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n        const int blocker_height = blocker.second->nHeight - PRUNE_BLOCKER_BUFFER;\r\n```\r\nShouldn't we subtract here if we want to keep `PRUNE_BLOCKER_BUFFER` blocks **before** the deepest blocker?\r\n\r\nfrom the logs of a test run:\r\n```\r\nnode1 2021-06-19T12:10:06.022496Z [init] [validation.cpp:3803] [GetLastPruneBlockerHeight] coinstatsindex limited pruning to height 10\r\n...\r\nnode1 2021-06-19T12:10:06.044329Z [coinstatsindex] [index/base.cpp:159] [ThreadSync] Syncing coinstatsindex with block chain from height 0\r\n```\r\nnode1 limited pruning to height 10 before it started syncing from height 0.",
      "commit_id" : "e365e87a72cc49e175b31256a11a6c5b1621d1f2",
      "created_at" : "2021-06-19T10:15:05Z",
      "diff_hunk" : "@@ -3792,6 +3790,21 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(const std::string& name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;\n+}\n+\n+void BlockManager::GetLastPruneBlockerHeight(int& last_prune) {\n+    for (auto const& blocker : m_prune_blockers) {\n+        const int blocker_height = blocker.second->nHeight + PRUNE_BLOCKER_BUFFER;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r654778191",
      "id" : 654778191,
      "line" : 3800,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDc3ODE5MQ==",
      "original_commit_id" : "e365e87a72cc49e175b31256a11a6c5b1621d1f2",
      "original_line" : 3800,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 35,
      "pull_request_review_id" : 687813168,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-19T12:31:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/654778191",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r654789987"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/654789987"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Wouldn't it make more sense to wait for the indexes to sync *after* pruning?\r\nOtherwise it is pretty much guaranteed that the index data at the tip (700) is available after pruning.\r\n\r\nIn general i think it would be good for the test to check for expected prune blocker heights somehow. (not sure if that is possible, i dont know that much about the functional tests)",
      "commit_id" : "e365e87a72cc49e175b31256a11a6c5b1621d1f2",
      "created_at" : "2021-06-19T12:22:15Z",
      "diff_hunk" : "@@ -0,0 +1,117 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test indices in conjunction with prune.\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_greater_than,\n+    assert_raises_rpc_error,\n+)\n+\n+\n+class FeatureIndexPruneTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 3\n+        self.extra_args = [\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-coinstatsindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"]\n+        ]\n+\n+    def sync_index(self, height):\n+        expected_filter = {\n+            'basic block filter index': {'synced': True, 'best_block_height': height},\n+        }\n+        self.wait_until(lambda: self.nodes[0].getindexinfo() == expected_filter)\n+\n+        expected_stats = {\n+            'coinstatsindex': {'synced': True, 'best_block_height': height}\n+        }\n+        self.wait_until(lambda: self.nodes[1].getindexinfo() == expected_stats)\n+\n+        expected = {**expected_filter, **expected_stats}\n+        self.wait_until(lambda: self.nodes[2].getindexinfo() == expected)\n+\n+    def reconnect_nodes(self):\n+        self.connect_nodes(0,1)\n+        self.connect_nodes(0,2)\n+        self.connect_nodes(1,2)\n+        self.connect_nodes(2,1)\n+\n+    def mine_batches(self, n):\n+        for _ in range(n):\n+            self.nodes[0].generate(250)\n+            self.sync_blocks()\n+\n+    def run_test(self):\n+        filter_nodes = [self.nodes[0], self.nodes[2]]\n+        stats_nodes = [self.nodes[1], self.nodes[2]]\n+\n+        self.log.info(\"check if we can access blockfilters and coinstats when pruning is enabled but no blocks are actually pruned\")\n+        self.sync_index(height=200)\n+        tip = self.nodes[0].getbestblockhash()\n+        for node in filter_nodes:\n+            assert_greater_than(len(node.getblockfilter(tip)['filter']), 0)\n+        for node in stats_nodes:\n+            assert(node.gettxoutsetinfo(hash_type=\"muhash\", hash_or_height=tip)['muhash'])\n+\n+        # Mine two batches of blocks to avoid hitting NODE_NETWORK_LIMITED_MIN_BLOCKS disconnection\n+        self.mine_batches(2)\n+        self.sync_index(height=700)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r654789987",
      "id" : 654789987,
      "line" : 62,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDc4OTk4Nw==",
      "original_commit_id" : "e365e87a72cc49e175b31256a11a6c5b1621d1f2",
      "original_line" : 62,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "test/functional/feature_index_prune.py",
      "position" : 62,
      "pull_request_review_id" : 687813168,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-19T12:31:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/654789987",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r659805048"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659805048"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Error building this branch at e365e87a72cc4 rebased to current master at 8cdf91735f2b, looks like it needs updating:\r\n```rake\r\nindex/base.cpp:373:9: error: use of undeclared identifier 'g_chainman'\r\n        g_chainman.m_blockman.UpdatePruneBlocker(GetName(), block ? block : ::ChainActive().Genesis());\r\n        ^\r\nindex/base.cpp:373:79: error: no member named 'ChainActive' in the global namespace\r\n        g_chainman.m_blockman.UpdatePruneBlocker(GetName(), block ? block : ::ChainActive().Genesis());\r\n                                                                            ~~^\r\n2 errors generated.\r\n```\r\n",
      "commit_id" : "e365e87a72cc49e175b31256a11a6c5b1621d1f2",
      "created_at" : "2021-06-28T13:50:49Z",
      "diff_hunk" : "@@ -370,3 +366,11 @@ IndexSummary BaseIndex::GetSummary() const\n     summary.best_block_height = m_best_block_index ? m_best_block_index.load()->nHeight : 0;\n     return summary;\n }\n+\n+void BaseIndex::SetBestBlockIndex(const CBlockIndex* block) {\n+    m_best_block_index = block;\n+    if (AllowPrune() && (fPruneMode || fHavePruned) && !fReindex) {\n+        LOCK(::cs_main);\n+        g_chainman.m_blockman.UpdatePruneBlocker(GetName(), block ? block : ::ChainActive().Genesis());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r659805048",
      "id" : 659805048,
      "line" : 374,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1OTgwNTA0OA==",
      "original_commit_id" : "e365e87a72cc49e175b31256a11a6c5b1621d1f2",
      "original_line" : 374,
      "original_position" : 84,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 84,
      "pull_request_review_id" : 693981880,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-28T13:50:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659805048",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Nudge to update.",
      "created_at" : "2021-07-20T10:15:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-883275390",
      "id" : 883275390,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII5840pbZ-",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-20T10:15:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/883275390",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Removed from high-prio for now due to inactivity, but can be added back",
      "created_at" : "2021-07-20T14:38:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-883447438",
      "id" : 883447438,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII5840qFaO",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-20T14:38:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/883447438",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-07-28T17:10:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-888476972",
      "id" : 888476972,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII58409RUs",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-28T17:10:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/888476972",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702488378"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488378"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "right  thanks, fixed!",
      "commit_id" : "89f0373f998683030d545b0078dea108edd6ccbf",
      "created_at" : "2021-09-05T22:58:17Z",
      "diff_hunk" : "@@ -3792,6 +3790,21 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(const std::string& name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;\n+}\n+\n+void BlockManager::GetLastPruneBlockerHeight(int& last_prune) {\n+    for (auto const& blocker : m_prune_blockers) {\n+        const int blocker_height = blocker.second->nHeight + PRUNE_BLOCKER_BUFFER;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702488378",
      "id" : 702488378,
      "in_reply_to_id" : 654778191,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMjQ4ODM3OA==",
      "original_commit_id" : "e365e87a72cc49e175b31256a11a6c5b1621d1f2",
      "original_line" : 3800,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 746690769,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-05T22:58:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488378",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702488632"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488632"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, I agree, I added a log category. I am leaving unifying for a potential follow-up to not complicate this PR further.",
      "commit_id" : "89f0373f998683030d545b0078dea108edd6ccbf",
      "created_at" : "2021-09-05T23:01:08Z",
      "diff_hunk" : "@@ -3792,6 +3794,21 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(const std::string& name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;\n+}\n+\n+void BlockManager::GetLastPruneBlockerHeight(int& last_prune) {\n+    for (auto const& blocker : m_prune_blockers) {\n+        const int blocker_height = blocker.second->nHeight + PRUNE_BLOCKER_BUFFER;\n+        last_prune = std::max(1, std::min(last_prune, blocker_height));\n+        if (last_prune == blocker_height) {\n+            LogPrintf(\"%s limited pruning to height %d\\n\", blocker.first, blocker_height);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702488632",
      "id" : 702488632,
      "in_reply_to_id" : 644205509,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMjQ4ODYzMg==",
      "original_commit_id" : "9f8d6a9a8f7d113ae12306c72a773830b5725e37",
      "original_line" : 3807,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 746691001,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-05T23:01:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488632",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702488725"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488725"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Added!",
      "commit_id" : "89f0373f998683030d545b0078dea108edd6ccbf",
      "created_at" : "2021-09-05T23:01:39Z",
      "diff_hunk" : "@@ -494,6 +497,12 @@ class BlockManager\n      */\n     int GetSpendHeight(const CCoinsViewCache& inputs) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    std::unordered_map<std::string, const CBlockIndex*> m_prune_blockers;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702488725",
      "id" : 702488725,
      "in_reply_to_id" : 644109721,
      "line" : 497,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMjQ4ODcyNQ==",
      "original_commit_id" : "9f8d6a9a8f7d113ae12306c72a773830b5725e37",
      "original_line" : 497,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 19,
      "pull_request_review_id" : 746691034,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-05T23:01:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488725",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702488743"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488743"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "89f0373f998683030d545b0078dea108edd6ccbf",
      "created_at" : "2021-09-05T23:01:59Z",
      "diff_hunk" : "@@ -3792,6 +3794,21 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(const std::string& name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;\n+}\n+\n+void BlockManager::GetLastPruneBlockerHeight(int& last_prune) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702488743",
      "id" : 702488743,
      "in_reply_to_id" : 644115299,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMjQ4ODc0Mw==",
      "original_commit_id" : "9f8d6a9a8f7d113ae12306c72a773830b5725e37",
      "original_line" : 3802,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 746691065,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-05T23:02:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488743",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702488827"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488827"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks, fixed.",
      "commit_id" : "89f0373f998683030d545b0078dea108edd6ccbf",
      "created_at" : "2021-09-05T23:02:32Z",
      "diff_hunk" : "@@ -370,3 +366,11 @@ IndexSummary BaseIndex::GetSummary() const\n     summary.best_block_height = m_best_block_index ? m_best_block_index.load()->nHeight : 0;\n     return summary;\n }\n+\n+void BaseIndex::SetBestBlockIndex(const CBlockIndex* block) {\n+    m_best_block_index = block;\n+    if (AllowPrune() && (fPruneMode || fHavePruned) && !fReindex) {\n+        LOCK(::cs_main);\n+        g_chainman.m_blockman.UpdatePruneBlocker(GetName(), block ? block : ::ChainActive().Genesis());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702488827",
      "id" : 702488827,
      "in_reply_to_id" : 659805048,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMjQ4ODgyNw==",
      "original_commit_id" : "e365e87a72cc49e175b31256a11a6c5b1621d1f2",
      "original_line" : 374,
      "original_position" : 84,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 746691118,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-05T23:02:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488827",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702489106"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702489106"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> Wouldn't it make more sense to wait for the indexes to sync _after_ pruning?\r\n> Otherwise it is pretty much guaranteed that the index data at the tip (700) is available after pruning.\r\n\r\nYes, that would be good, but unless I am misunderstanding your comment, what we would be testing then is a race condition which would make the test flaky.\r\n\r\n> In general i think it would be good for the test to check for expected prune blocker heights somehow. (not sure if that is possible, i dont know that much about the functional tests)\r\n\r\nyes, I added two sanity checks for the exact prune blocker height by checking the logs\r\n",
      "commit_id" : "89f0373f998683030d545b0078dea108edd6ccbf",
      "created_at" : "2021-09-05T23:05:33Z",
      "diff_hunk" : "@@ -0,0 +1,117 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test indices in conjunction with prune.\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_greater_than,\n+    assert_raises_rpc_error,\n+)\n+\n+\n+class FeatureIndexPruneTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 3\n+        self.extra_args = [\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-coinstatsindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"]\n+        ]\n+\n+    def sync_index(self, height):\n+        expected_filter = {\n+            'basic block filter index': {'synced': True, 'best_block_height': height},\n+        }\n+        self.wait_until(lambda: self.nodes[0].getindexinfo() == expected_filter)\n+\n+        expected_stats = {\n+            'coinstatsindex': {'synced': True, 'best_block_height': height}\n+        }\n+        self.wait_until(lambda: self.nodes[1].getindexinfo() == expected_stats)\n+\n+        expected = {**expected_filter, **expected_stats}\n+        self.wait_until(lambda: self.nodes[2].getindexinfo() == expected)\n+\n+    def reconnect_nodes(self):\n+        self.connect_nodes(0,1)\n+        self.connect_nodes(0,2)\n+        self.connect_nodes(1,2)\n+        self.connect_nodes(2,1)\n+\n+    def mine_batches(self, n):\n+        for _ in range(n):\n+            self.nodes[0].generate(250)\n+            self.sync_blocks()\n+\n+    def run_test(self):\n+        filter_nodes = [self.nodes[0], self.nodes[2]]\n+        stats_nodes = [self.nodes[1], self.nodes[2]]\n+\n+        self.log.info(\"check if we can access blockfilters and coinstats when pruning is enabled but no blocks are actually pruned\")\n+        self.sync_index(height=200)\n+        tip = self.nodes[0].getbestblockhash()\n+        for node in filter_nodes:\n+            assert_greater_than(len(node.getblockfilter(tip)['filter']), 0)\n+        for node in stats_nodes:\n+            assert(node.gettxoutsetinfo(hash_type=\"muhash\", hash_or_height=tip)['muhash'])\n+\n+        # Mine two batches of blocks to avoid hitting NODE_NETWORK_LIMITED_MIN_BLOCKS disconnection\n+        self.mine_batches(2)\n+        self.sync_index(height=700)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702489106",
      "id" : 702489106,
      "in_reply_to_id" : 654789987,
      "line" : 68,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMjQ4OTEwNg==",
      "original_commit_id" : "e365e87a72cc49e175b31256a11a6c5b1621d1f2",
      "original_line" : 68,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "test/functional/feature_index_prune.py",
      "position" : 68,
      "pull_request_review_id" : 746691401,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-05T23:05:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702489106",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702492020"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702492020"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "True, I changed the function to take a pointer and added a CHECK_NONFATAL to be more consistent with the previous code.",
      "commit_id" : "89f0373f998683030d545b0078dea108edd6ccbf",
      "created_at" : "2021-09-05T23:30:04Z",
      "diff_hunk" : "@@ -1069,12 +1069,9 @@ static RPCHelpMan pruneblockchain()\n     }\n \n     PruneBlockFilesManual(active_chainstate, height);\n-    const CBlockIndex* block = active_chain.Tip();\n-    CHECK_NONFATAL(block);\n-    while (block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA)) {\n-        block = block->pprev;\n-    }\n-    return uint64_t(block->nHeight);\n+    const CBlockIndex* last_block = GetLastPrunedBlock(*active_chain.Tip());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702492020",
      "id" : 702492020,
      "in_reply_to_id" : 644094388,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMjQ5MjAyMA==",
      "original_commit_id" : "292d508e956bfe5b05e6ee685415063c2a0f04af",
      "original_line" : 1075,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 746693619,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-05T23:30:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702492020",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702492978"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702492978"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, I added functional tests for the -reindex case.\r\n\r\nI am looking into the sanity check assert idea don't have a clear opinion yet.\r\n\r\n",
      "commit_id" : "89f0373f998683030d545b0078dea108edd6ccbf",
      "created_at" : "2021-09-05T23:37:40Z",
      "diff_hunk" : "@@ -3663,6 +3673,11 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(std::string name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702492978",
      "id" : 702492978,
      "in_reply_to_id" : 638348949,
      "line" : 3662,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMjQ5Mjk3OA==",
      "original_commit_id" : "b5a239390fd1b31c7e6107a2e6c35658a2b4697c",
      "original_line" : 3662,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 37,
      "pull_request_review_id" : 746694375,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-05T23:37:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702492978",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Sorry for the long wait, I should have addressed all the feedback for now and also optimized the test a bit further.",
      "created_at" : "2021-09-05T23:38:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-913247703",
      "id" : 913247703,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII5842bw3X",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-05T23:38:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/913247703",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Sorry for the long wait, I should have addressed all the feedback for now and also optimized the test a bit further.\r\n\r\nThanks for updating this! I want to review it more soon, and it would be great to have feedback also from @jamesob because I think there is or could be some interaction between this and https://github.com/bitcoin/bitcoin/pull/15606#pullrequestreview-692965905:\r\n\r\n>* More straightforward approach to pruning. Instead of having to write special case pruning logic, this could be integrated with [Improve Indices on pruned nodes via prune blockers #21726](https://github.com/bitcoin/bitcoin/pull/21726), and each chainstate could just add to a list of prune blockers (ranges of blocks not allowed to be pruned) and pruning code would not need to be aware of assumeutxo states.",
      "created_at" : "2021-09-07T14:46:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-914368128",
      "id" : 914368128,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII5842gCaA",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-07T14:50:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/914368128",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> it would be great to have feedback also from @jamesob\r\n\r\nYep, will plan to review this in the next few days.",
      "created_at" : "2021-09-07T15:09:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-914391121",
      "id" : 914391121,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII5842gIBR",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-07T15:09:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/914391121",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r705355682"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/705355682"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/21726/commits/2c815adc881fa90f14887e2ec33ccb11ef964387\r\n\r\nNote: ensured `active_chain.Tip()` will not ever be nullptr here because `g_txindex` et al are started in init.cpp after genesis block load.",
      "commit_id" : "983a3552f22678d4466e0faa8e784f25b145a76b",
      "created_at" : "2021-09-09T13:53:02Z",
      "diff_hunk" : "@@ -72,11 +72,7 @@ bool BaseIndex::Init()\n         if (!m_best_block_index) {\n             // index is not built yet\n             // make sure we have all block data back to the genesis\n-            const CBlockIndex* block = active_chain.Tip();\n-            while (block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA)) {\n-                block = block->pprev;\n-            }\n-            prune_violation = block != active_chain.Genesis();\n+            prune_violation = GetLastPrunedBlock(active_chain.Tip()) != active_chain.Genesis();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r705355682",
      "id" : 705355682,
      "line" : 75,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNTM1NTY4Mg==",
      "original_commit_id" : "2c815adc881fa90f14887e2ec33ccb11ef964387",
      "original_line" : 75,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 22,
      "pull_request_review_id" : 750371858,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-09T15:37:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/705355682",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r705377815"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/705377815"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/21726/commits/9c70676aded6e2c9c4719fd5039f27a2c16a54fb\r\n\r\nI'm curious why the method below is marked as requiring cs_main, but this data structure isn't marked as guarded by cs_main - is that intentional?",
      "commit_id" : "983a3552f22678d4466e0faa8e784f25b145a76b",
      "created_at" : "2021-09-09T14:13:57Z",
      "diff_hunk" : "@@ -488,6 +490,16 @@ class BlockManager\n      */\n     int GetSpendHeight(const CCoinsViewCache& inputs) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    /**\n+     * Map from external index name to most recent block the index can tolerate being pruned.\n+     *\n+     * @note Internally, only blocks at height (block->nHeight - PRUNE_BLOCKER_BUFFER) and\n+     * below will be pruned, but callers should avoid assuming any particular buffer size.\n+     */\n+    std::unordered_map<std::string, const CBlockIndex*> m_prune_blockers;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r705377815",
      "id" : 705377815,
      "line" : 499,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNTM3NzgxNQ==",
      "original_commit_id" : "9c70676aded6e2c9c4719fd5039f27a2c16a54fb",
      "original_line" : 499,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 19,
      "pull_request_review_id" : 750371858,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-09T15:37:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/705377815",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r706609540"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706609540"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: make the code match the log statement (`pruneheight` is here still set to 248 while the indices best block is 700)\r\n```suggestion\r\n            assert_greater_than(pruneheight_new, 700)\r\n```\r\n",
      "commit_id" : "983a3552f22678d4466e0faa8e784f25b145a76b",
      "created_at" : "2021-09-11T12:50:40Z",
      "diff_hunk" : "@@ -0,0 +1,130 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test indices in conjunction with prune.\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_greater_than,\n+    assert_raises_rpc_error,\n+    p2p_port,\n+)\n+\n+\n+class FeatureIndexPruneTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-coinstatsindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"],\n+            []\n+        ]\n+\n+    def sync_index(self, height):\n+        expected_filter = {\n+            'basic block filter index': {'synced': True, 'best_block_height': height},\n+        }\n+        self.wait_until(lambda: self.nodes[0].getindexinfo() == expected_filter)\n+\n+        expected_stats = {\n+            'coinstatsindex': {'synced': True, 'best_block_height': height}\n+        }\n+        self.wait_until(lambda: self.nodes[1].getindexinfo() == expected_stats)\n+\n+        expected = {**expected_filter, **expected_stats}\n+        self.wait_until(lambda: self.nodes[2].getindexinfo() == expected)\n+\n+    def reconnect_nodes(self):\n+        self.connect_nodes(0,1)\n+        self.connect_nodes(0,2)\n+        self.connect_nodes(0,3)\n+\n+    def mine_batches(self, n):\n+        for _ in range(n):\n+            self.nodes[0].generate(250)\n+            self.sync_blocks()\n+\n+    def expected_prune_height(self, n):\n+        # Sanity check for correct prune blocker height in logs\n+        for node in self.nodes:\n+            node.assert_debug_log([f'limited pruning to height {n}'])\n+\n+    def run_test(self):\n+        filter_nodes = [self.nodes[0], self.nodes[2]]\n+        stats_nodes = [self.nodes[1], self.nodes[2]]\n+\n+        self.log.info(\"check if we can access blockfilters and coinstats when pruning is enabled but no blocks are actually pruned\")\n+        self.sync_index(height=200)\n+        tip = self.nodes[0].getbestblockhash()\n+        for node in filter_nodes:\n+            assert_greater_than(len(node.getblockfilter(tip)['filter']), 0)\n+        for node in stats_nodes:\n+            assert(node.gettxoutsetinfo(hash_type=\"muhash\", hash_or_height=tip)['muhash'])\n+\n+        # Mine two batches of blocks to avoid hitting NODE_NETWORK_LIMITED_MIN_BLOCKS disconnection\n+        self.mine_batches(2)\n+        self.sync_index(height=700)\n+\n+        self.expected_prune_height(690)\n+\n+        self.log.info(\"prune some blocks\")\n+        for node in self.nodes[:2]:\n+            pruneheight = node.pruneblockchain(400)\n+            assert_equal(pruneheight, 248)\n+\n+        self.log.info(\"check if we can access the tips blockfilter and coinstats when we have pruned some blocks\")\n+        tip = self.nodes[0].getbestblockhash()\n+        for node in filter_nodes:\n+            assert_greater_than(len(node.getblockfilter(tip)['filter']), 0)\n+        for node in stats_nodes:\n+            assert(node.gettxoutsetinfo(hash_type=\"muhash\", hash_or_height=tip)['muhash'])\n+\n+        self.log.info(\"check if we can access the blockfilter and coinstats of a pruned block\")\n+        height_hash = self.nodes[0].getblockhash(2)\n+        for node in filter_nodes:\n+            assert_greater_than(len(node.getblockfilter(height_hash)['filter']), 0)\n+        for node in stats_nodes:\n+            assert(node.gettxoutsetinfo(hash_type=\"muhash\", hash_or_height=height_hash)['muhash'])\n+\n+        self.log.info(\"restart nodes without indices\")\n+        for i in range(3):\n+            self.restart_node(i, extra_args=[\"-fastprune\", \"-prune=1\"])\n+        self.reconnect_nodes()\n+\n+        self.log.info(\"make sure trying to access the indices throws errors\")\n+        for node in filter_nodes:\n+            msg = \"Index is not enabled for filtertype basic\"\n+            assert_raises_rpc_error(-1, msg, node.getblockfilter, height_hash)\n+        for node in stats_nodes:\n+            msg = \"Querying specific block heights requires coinstatsindex\"\n+            assert_raises_rpc_error(-8, msg, node.gettxoutsetinfo, \"muhash\", height_hash)\n+\n+        self.mine_batches(4)\n+\n+        self.log.info(\"prune further than the indices best blocks while the indices are disabled\")\n+        for i in range(3):\n+            pruneheight_new = self.nodes[i].pruneblockchain(1000)\n+            assert_greater_than(pruneheight_new, pruneheight)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r706609540",
      "id" : 706609540,
      "line" : 109,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNjYwOTU0MA==",
      "original_commit_id" : "983a3552f22678d4466e0faa8e784f25b145a76b",
      "original_line" : 109,
      "original_position" : 109,
      "original_start_line" : null,
      "path" : "test/functional/feature_index_prune.py",
      "position" : 109,
      "pull_request_review_id" : 751916636,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-11T15:13:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706609540",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r706623557"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706623557"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I am able to put any value here besides 690 and the test still passes.\r\n\r\nThis is because [`assert_debug_log`](https://github.com/bitcoin/bitcoin/blob/5c0f46ca46e23a161649b5150baa01020dc85e48/test/functional/test_framework/test_node.py#L381) is a generator and meant to be used in combination with `with`:\r\n```python\r\nwith assert_debug_log(...):\r\n  # some other code that prints the (un)expected logs\r\n```\r\n\"At the point where the generator yields, the block nested in the [`with`](https://docs.python.org/3/reference/compound_stmts.html#with) statement is executed. The generator is then resumed after the block is exited. [...]\" from https://docs.python.org/3/library/contextlib.html#contextlib.contextmanager\r\n\r\nSecondly i think that checking the logs to test the prune blocker height won't work here as the expected message is only printed when pruning is attempted (https://github.com/bitcoin/bitcoin/blob/983a3552f22678d4466e0faa8e784f25b145a76b/src/validation.cpp#L2027)\r\n\r\nthe following would work:\r\n```python\r\n self.log.info(\"prune some blocks\")\r\n for node in self.nodes[:2]:\r\n     with node.assert_debug_log(['limited pruning to height 690']):\r\n         pruneheight = node.pruneblockchain(400)\r\n         assert_equal(pruneheight, 248)\r\n```\r\n",
      "commit_id" : "983a3552f22678d4466e0faa8e784f25b145a76b",
      "created_at" : "2021-09-11T15:04:47Z",
      "diff_hunk" : "@@ -0,0 +1,130 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test indices in conjunction with prune.\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_greater_than,\n+    assert_raises_rpc_error,\n+    p2p_port,\n+)\n+\n+\n+class FeatureIndexPruneTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-coinstatsindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"],\n+            []\n+        ]\n+\n+    def sync_index(self, height):\n+        expected_filter = {\n+            'basic block filter index': {'synced': True, 'best_block_height': height},\n+        }\n+        self.wait_until(lambda: self.nodes[0].getindexinfo() == expected_filter)\n+\n+        expected_stats = {\n+            'coinstatsindex': {'synced': True, 'best_block_height': height}\n+        }\n+        self.wait_until(lambda: self.nodes[1].getindexinfo() == expected_stats)\n+\n+        expected = {**expected_filter, **expected_stats}\n+        self.wait_until(lambda: self.nodes[2].getindexinfo() == expected)\n+\n+    def reconnect_nodes(self):\n+        self.connect_nodes(0,1)\n+        self.connect_nodes(0,2)\n+        self.connect_nodes(0,3)\n+\n+    def mine_batches(self, n):\n+        for _ in range(n):\n+            self.nodes[0].generate(250)\n+            self.sync_blocks()\n+\n+    def expected_prune_height(self, n):\n+        # Sanity check for correct prune blocker height in logs\n+        for node in self.nodes:\n+            node.assert_debug_log([f'limited pruning to height {n}'])\n+\n+    def run_test(self):\n+        filter_nodes = [self.nodes[0], self.nodes[2]]\n+        stats_nodes = [self.nodes[1], self.nodes[2]]\n+\n+        self.log.info(\"check if we can access blockfilters and coinstats when pruning is enabled but no blocks are actually pruned\")\n+        self.sync_index(height=200)\n+        tip = self.nodes[0].getbestblockhash()\n+        for node in filter_nodes:\n+            assert_greater_than(len(node.getblockfilter(tip)['filter']), 0)\n+        for node in stats_nodes:\n+            assert(node.gettxoutsetinfo(hash_type=\"muhash\", hash_or_height=tip)['muhash'])\n+\n+        # Mine two batches of blocks to avoid hitting NODE_NETWORK_LIMITED_MIN_BLOCKS disconnection\n+        self.mine_batches(2)\n+        self.sync_index(height=700)\n+\n+        self.expected_prune_height(690)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r706623557",
      "id" : 706623557,
      "line" : 70,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNjYyMzU1Nw==",
      "original_commit_id" : "983a3552f22678d4466e0faa8e784f25b145a76b",
      "original_line" : 70,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "test/functional/feature_index_prune.py",
      "position" : 70,
      "pull_request_review_id" : 751916636,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-11T15:13:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706623557",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r712372589"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/712372589"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactor: Introduce GetLastPruneBlock helper function\" (2c815adc881fa90f14887e2ec33ccb11ef964387)\r\n\r\nThis doesn't seem to actually return the last block that is pruned. It seems to return the next block that has data. So maybe should be called `GetFirstNonPrunedBlock`? It also seems like `pruneblockchain` RPC documentation describes this incorrectly while `getblockchaininfo` describes it correctly.",
      "commit_id" : "983a3552f22678d4466e0faa8e784f25b145a76b",
      "created_at" : "2021-09-20T17:28:51Z",
      "diff_hunk" : "@@ -48,6 +48,9 @@ extern uint64_t nPruneTarget;\n //! Check whether the block associated with this index entry is pruned or not.\n bool IsBlockPruned(const CBlockIndex* pblockindex);\n \n+//! Find the last block that is pruned\n+const CBlockIndex* GetLastPrunedBlock(const CBlockIndex* start_block);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r712372589",
      "id" : 712372589,
      "line" : 52,
      "node_id" : "PRRC_kwDOABII584qdfFt",
      "original_commit_id" : "2c815adc881fa90f14887e2ec33ccb11ef964387",
      "original_line" : 52,
      "original_position" : 5,
      "original_start_line" : 51,
      "path" : "src/node/blockstorage.h",
      "position" : 5,
      "pull_request_review_id" : 758911426,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : 51,
      "start_side" : "RIGHT",
      "updated_at" : "2021-09-20T17:29:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/712372589",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r714341113"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714341113"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not intentional, just an oversight. Fixed!",
      "commit_id" : "2f0ad7fcc5dde3932bd6d0def98873bbe81f19e9",
      "created_at" : "2021-09-22T21:59:31Z",
      "diff_hunk" : "@@ -488,6 +490,16 @@ class BlockManager\n      */\n     int GetSpendHeight(const CCoinsViewCache& inputs) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    /**\n+     * Map from external index name to most recent block the index can tolerate being pruned.\n+     *\n+     * @note Internally, only blocks at height (block->nHeight - PRUNE_BLOCKER_BUFFER) and\n+     * below will be pruned, but callers should avoid assuming any particular buffer size.\n+     */\n+    std::unordered_map<std::string, const CBlockIndex*> m_prune_blockers;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r714341113",
      "id" : 714341113,
      "in_reply_to_id" : 705377815,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qk_r5",
      "original_commit_id" : "9c70676aded6e2c9c4719fd5039f27a2c16a54fb",
      "original_line" : 499,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 761445223,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-22T21:59:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714341113",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r714341348"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714341348"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Makes sense, fixed!",
      "commit_id" : "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
      "created_at" : "2021-09-22T21:59:55Z",
      "diff_hunk" : "@@ -0,0 +1,130 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test indices in conjunction with prune.\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_greater_than,\n+    assert_raises_rpc_error,\n+    p2p_port,\n+)\n+\n+\n+class FeatureIndexPruneTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-coinstatsindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"],\n+            []\n+        ]\n+\n+    def sync_index(self, height):\n+        expected_filter = {\n+            'basic block filter index': {'synced': True, 'best_block_height': height},\n+        }\n+        self.wait_until(lambda: self.nodes[0].getindexinfo() == expected_filter)\n+\n+        expected_stats = {\n+            'coinstatsindex': {'synced': True, 'best_block_height': height}\n+        }\n+        self.wait_until(lambda: self.nodes[1].getindexinfo() == expected_stats)\n+\n+        expected = {**expected_filter, **expected_stats}\n+        self.wait_until(lambda: self.nodes[2].getindexinfo() == expected)\n+\n+    def reconnect_nodes(self):\n+        self.connect_nodes(0,1)\n+        self.connect_nodes(0,2)\n+        self.connect_nodes(0,3)\n+\n+    def mine_batches(self, n):\n+        for _ in range(n):\n+            self.nodes[0].generate(250)\n+            self.sync_blocks()\n+\n+    def expected_prune_height(self, n):\n+        # Sanity check for correct prune blocker height in logs\n+        for node in self.nodes:\n+            node.assert_debug_log([f'limited pruning to height {n}'])\n+\n+    def run_test(self):\n+        filter_nodes = [self.nodes[0], self.nodes[2]]\n+        stats_nodes = [self.nodes[1], self.nodes[2]]\n+\n+        self.log.info(\"check if we can access blockfilters and coinstats when pruning is enabled but no blocks are actually pruned\")\n+        self.sync_index(height=200)\n+        tip = self.nodes[0].getbestblockhash()\n+        for node in filter_nodes:\n+            assert_greater_than(len(node.getblockfilter(tip)['filter']), 0)\n+        for node in stats_nodes:\n+            assert(node.gettxoutsetinfo(hash_type=\"muhash\", hash_or_height=tip)['muhash'])\n+\n+        # Mine two batches of blocks to avoid hitting NODE_NETWORK_LIMITED_MIN_BLOCKS disconnection\n+        self.mine_batches(2)\n+        self.sync_index(height=700)\n+\n+        self.expected_prune_height(690)\n+\n+        self.log.info(\"prune some blocks\")\n+        for node in self.nodes[:2]:\n+            pruneheight = node.pruneblockchain(400)\n+            assert_equal(pruneheight, 248)\n+\n+        self.log.info(\"check if we can access the tips blockfilter and coinstats when we have pruned some blocks\")\n+        tip = self.nodes[0].getbestblockhash()\n+        for node in filter_nodes:\n+            assert_greater_than(len(node.getblockfilter(tip)['filter']), 0)\n+        for node in stats_nodes:\n+            assert(node.gettxoutsetinfo(hash_type=\"muhash\", hash_or_height=tip)['muhash'])\n+\n+        self.log.info(\"check if we can access the blockfilter and coinstats of a pruned block\")\n+        height_hash = self.nodes[0].getblockhash(2)\n+        for node in filter_nodes:\n+            assert_greater_than(len(node.getblockfilter(height_hash)['filter']), 0)\n+        for node in stats_nodes:\n+            assert(node.gettxoutsetinfo(hash_type=\"muhash\", hash_or_height=height_hash)['muhash'])\n+\n+        self.log.info(\"restart nodes without indices\")\n+        for i in range(3):\n+            self.restart_node(i, extra_args=[\"-fastprune\", \"-prune=1\"])\n+        self.reconnect_nodes()\n+\n+        self.log.info(\"make sure trying to access the indices throws errors\")\n+        for node in filter_nodes:\n+            msg = \"Index is not enabled for filtertype basic\"\n+            assert_raises_rpc_error(-1, msg, node.getblockfilter, height_hash)\n+        for node in stats_nodes:\n+            msg = \"Querying specific block heights requires coinstatsindex\"\n+            assert_raises_rpc_error(-8, msg, node.gettxoutsetinfo, \"muhash\", height_hash)\n+\n+        self.mine_batches(4)\n+\n+        self.log.info(\"prune further than the indices best blocks while the indices are disabled\")\n+        for i in range(3):\n+            pruneheight_new = self.nodes[i].pruneblockchain(1000)\n+            assert_greater_than(pruneheight_new, pruneheight)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r714341348",
      "id" : 714341348,
      "in_reply_to_id" : 706609540,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qk_vk",
      "original_commit_id" : "983a3552f22678d4466e0faa8e784f25b145a76b",
      "original_line" : 109,
      "original_position" : 109,
      "original_start_line" : null,
      "path" : "test/functional/feature_index_prune.py",
      "position" : null,
      "pull_request_review_id" : 761445463,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-22T21:59:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714341348",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r714342652"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714342652"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "True, I fixed this and went with with the name `GetFirstStoredBlock` inspired by the docs in `getblockchaininfo`. I also added an extra commit to fix the docs in `pruneblockchain`. I think fixing the docs is the right approach rather than change the behavior but I kept it in the separate commit in case there are different opinions on that.",
      "commit_id" : "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
      "created_at" : "2021-09-22T22:02:39Z",
      "diff_hunk" : "@@ -48,6 +48,9 @@ extern uint64_t nPruneTarget;\n //! Check whether the block associated with this index entry is pruned or not.\n bool IsBlockPruned(const CBlockIndex* pblockindex);\n \n+//! Find the last block that is pruned\n+const CBlockIndex* GetLastPrunedBlock(const CBlockIndex* start_block);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r714342652",
      "id" : 714342652,
      "in_reply_to_id" : 712372589,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qlAD8",
      "original_commit_id" : "2c815adc881fa90f14887e2ec33ccb11ef964387",
      "original_line" : 52,
      "original_position" : 5,
      "original_start_line" : 51,
      "path" : "src/node/blockstorage.h",
      "position" : null,
      "pull_request_review_id" : 761447114,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-09-22T22:02:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714342652",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r714345854"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714345854"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks a lot for the detailed feedback! I fixed this using your suggested approach in the two locations where I wanted to do the check.",
      "commit_id" : "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
      "created_at" : "2021-09-22T22:09:36Z",
      "diff_hunk" : "@@ -0,0 +1,130 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test indices in conjunction with prune.\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_greater_than,\n+    assert_raises_rpc_error,\n+    p2p_port,\n+)\n+\n+\n+class FeatureIndexPruneTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-coinstatsindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"],\n+            []\n+        ]\n+\n+    def sync_index(self, height):\n+        expected_filter = {\n+            'basic block filter index': {'synced': True, 'best_block_height': height},\n+        }\n+        self.wait_until(lambda: self.nodes[0].getindexinfo() == expected_filter)\n+\n+        expected_stats = {\n+            'coinstatsindex': {'synced': True, 'best_block_height': height}\n+        }\n+        self.wait_until(lambda: self.nodes[1].getindexinfo() == expected_stats)\n+\n+        expected = {**expected_filter, **expected_stats}\n+        self.wait_until(lambda: self.nodes[2].getindexinfo() == expected)\n+\n+    def reconnect_nodes(self):\n+        self.connect_nodes(0,1)\n+        self.connect_nodes(0,2)\n+        self.connect_nodes(0,3)\n+\n+    def mine_batches(self, n):\n+        for _ in range(n):\n+            self.nodes[0].generate(250)\n+            self.sync_blocks()\n+\n+    def expected_prune_height(self, n):\n+        # Sanity check for correct prune blocker height in logs\n+        for node in self.nodes:\n+            node.assert_debug_log([f'limited pruning to height {n}'])\n+\n+    def run_test(self):\n+        filter_nodes = [self.nodes[0], self.nodes[2]]\n+        stats_nodes = [self.nodes[1], self.nodes[2]]\n+\n+        self.log.info(\"check if we can access blockfilters and coinstats when pruning is enabled but no blocks are actually pruned\")\n+        self.sync_index(height=200)\n+        tip = self.nodes[0].getbestblockhash()\n+        for node in filter_nodes:\n+            assert_greater_than(len(node.getblockfilter(tip)['filter']), 0)\n+        for node in stats_nodes:\n+            assert(node.gettxoutsetinfo(hash_type=\"muhash\", hash_or_height=tip)['muhash'])\n+\n+        # Mine two batches of blocks to avoid hitting NODE_NETWORK_LIMITED_MIN_BLOCKS disconnection\n+        self.mine_batches(2)\n+        self.sync_index(height=700)\n+\n+        self.expected_prune_height(690)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r714345854",
      "id" : 714345854,
      "in_reply_to_id" : 706623557,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qlA1-",
      "original_commit_id" : "983a3552f22678d4466e0faa8e784f25b145a76b",
      "original_line" : 70,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "test/functional/feature_index_prune.py",
      "position" : null,
      "pull_request_review_id" : 761451347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-22T22:09:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714345854",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r714427353"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714427353"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactor: Introduce GetFirstStoredlock helper function\" (4ebe3a51da88589f23e243045a9e392701dfbbad)\r\n\r\nFunction name is spelled wrong in commit message",
      "commit_id" : "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
      "created_at" : "2021-09-23T02:11:16Z",
      "diff_hunk" : "@@ -48,6 +48,9 @@ extern uint64_t nPruneTarget;\n //! Check whether the block associated with this index entry is pruned or not.\n bool IsBlockPruned(const CBlockIndex* pblockindex);\n \n+//! Find the first block that is not pruned\n+const CBlockIndex* GetFirstStoredBlock(const CBlockIndex* start_block);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r714427353",
      "id" : 714427353,
      "line" : 52,
      "node_id" : "PRRC_kwDOABII584qlUvZ",
      "original_commit_id" : "4ebe3a51da88589f23e243045a9e392701dfbbad",
      "original_line" : 52,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.h",
      "position" : 5,
      "pull_request_review_id" : 761541915,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-23T19:39:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714427353",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r715026559"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715026559"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Index: Use prune blockers for blockfilterindex\" (7db7f26e97665c048b3f614c092899addd658f4f)\r\n\r\nCan we add an assert here:\r\n\r\n```\r\nassert(!fPruneMode || AllowPrune());\r\n```\r\n\r\nI know there is startup code that prevents the indexes which don't support AllowPrune from being enabled at the same time as the prune option, but you could imagine someone adding a new index where AllowPrune is false, and someone forgets to add the startup check. Or if the startup check just happens to be buggy, it would be good to have this check to detect the problem.",
      "commit_id" : "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
      "created_at" : "2021-09-23T17:52:44Z",
      "diff_hunk" : "@@ -369,3 +365,12 @@ IndexSummary BaseIndex::GetSummary() const\n     summary.best_block_height = m_best_block_index ? m_best_block_index.load()->nHeight : 0;\n     return summary;\n }\n+\n+void BaseIndex::SetBestBlockIndex(const CBlockIndex* block) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r715026559",
      "id" : 715026559,
      "line" : 369,
      "node_id" : "PRRC_kwDOABII584qnnB_",
      "original_commit_id" : "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
      "original_line" : 369,
      "original_position" : 80,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 80,
      "pull_request_review_id" : 761541915,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-23T19:39:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715026559",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r715054451"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715054451"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Index: Use prune blockers for blockfilterindex\" (7db7f26e97665c048b3f614c092899addd658f4f)\r\n\r\nI think it would be good if the commit message noted the minor change in behavior here: Previously pruning code would keep the blockfilter index best block and later blocks, and now an extra 10 previous blocks(PRUNE_BLOCKER_BUFFER) will be kept.",
      "commit_id" : "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
      "created_at" : "2021-09-23T18:33:43Z",
      "diff_hunk" : "@@ -1941,12 +1940,9 @@ bool CChainState::FlushStateToDisk(\n         CoinsCacheSizeState cache_state = GetCoinsCacheSizeState();\n         LOCK(cs_LastBlockFile);\n         if (fPruneMode && (fCheckForPruning || nManualPruneHeight > 0) && !fReindex) {\n-            // make sure we don't prune above the blockfilterindexes bestblocks\n+            // make sure we don't prune above any of the prune blockers bestblocks\n             // pruning is height-based\n             int last_prune = m_chain.Height(); // last height we can prune\n-            ForEachBlockFilterIndex([&](BlockFilterIndex& index) {\n-               last_prune = std::max(1, std::min(last_prune, index.GetSummary().best_block_height));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r715054451",
      "id" : 715054451,
      "line" : 1948,
      "node_id" : "PRRC_kwDOABII584qnt1z",
      "original_commit_id" : "7db7f26e97665c048b3f614c092899addd658f4f",
      "original_line" : 1948,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 17,
      "pull_request_review_id" : 761541915,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-23T19:39:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715054451",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r715059159"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715059159"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Index: Skip pruning checks when node is not pruning\" (70b9e4f6abda5d6dd38504d9149ddc79b33961ce)\r\n\r\nWhat is the motivation for this commit? It just seems to be disabling error checking and making the code more complicated and interdependent. Is there a real performance benefit or some other reason to do this?",
      "commit_id" : "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
      "created_at" : "2021-09-23T18:40:49Z",
      "diff_hunk" : "@@ -67,7 +67,7 @@ bool BaseIndex::Init()\n         SetBestBlockIndex(m_chainstate->m_blockman.FindForkInGlobalIndex(active_chain, locator));\n     }\n     m_synced = m_best_block_index.load() == active_chain.Tip();\n-    if (!m_synced) {\n+    if (!m_synced && (fPruneMode || fHavePruned) && !fReindex) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r715059159",
      "id" : 715059159,
      "line" : 70,
      "node_id" : "PRRC_kwDOABII584qnu_X",
      "original_commit_id" : "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
      "original_line" : 70,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 12,
      "pull_request_review_id" : 761541915,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-23T19:39:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715059159",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r715093019"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715093019"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Index: Use prune blockers for blockfilterindex\" (7db7f26e97665c048b3f614c092899addd658f4f)\r\n\r\nI'm seeing a segfault this line starting in the \"Index: Use prune blockers\" commit and continuing up to the \"\"Index: Skip pruning checks\" commit in the `feature_blockfilterindex_prune.py` test because `blocker.second` is null. It would probably be good to not insert null prune blockers or just ignore them.\r\n\r\n```\r\n#0  0x000055555583d8a6 in CChainState::FlushStateToDisk (this=0x555555e46f10, state=..., mode=FlushStateMode::IF_NEEDED, nManualPruneHeight=0) at validation.cpp:1948\r\n#1  0x0000555555849e51 in CChainState::ConnectTip (this=0x555555e46f10, state=..., pindexNew=0x7fffac001000, pblock=..., connectTrace=..., disconnectpool=...) at validation.cpp:2288\r\n#2  0x000055555584f7f2 in CChainState::ActivateBestChainStep (this=0x555555e46f10, state=..., pindexMostWork=0x7fffac001000, pblock=std::shared_ptr<const CBlock> (empty) = {...}, fInvalidFound=@0x7fffa7ffe32f: false, connectTrace=...)\r\n    at validation.cpp:2432\r\n#3  0x000055555584fff8 in CChainState::ActivateBestChain (this=<optimized out>, state=..., pblock=std::shared_ptr<const CBlock> (empty) = {...}) at validation.cpp:2557\r\n#4  0x00005555556c77fd in ThreadImport (chainman=..., vImportFiles=std::vector of length 0, capacity 0, args=...) at node/blockstorage.cpp:555\r\n#5  0x0000555555633850 in operator() (__closure=0x7fffac000b60) at init.cpp:1656\r\n#6  std::__invoke_impl<void, AppInitMain(NodeContext&, interfaces::BlockAndHeaderTipInfo*)::<lambda()>&> (__f=...) at /nix/store/5qjycalzb9sqzvqg65kf5zimqwjabm9g-gcc-10.3.0/include/c++/10.3.0/bits/invoke.h:60\r\n#7  std::__invoke_r<void, AppInitMain(NodeContext&, interfaces::BlockAndHeaderTipInfo*)::<lambda()>&> (__fn=...) at /nix/store/5qjycalzb9sqzvqg65kf5zimqwjabm9g-gcc-10.3.0/include/c++/10.3.0/bits/invoke.h:110\r\n#8  std::_Function_handler<void(), AppInitMain(NodeContext&, interfaces::BlockAndHeaderTipInfo*)::<lambda()> >::_M_invoke(const std::_Any_data &) (__functor=...)\r\n    at /nix/store/5qjycalzb9sqzvqg65kf5zimqwjabm9g-gcc-10.3.0/include/c++/10.3.0/bits/std_function.h:291\r\n#9  0x0000555555b0ef5f in std::function<void ()>::operator()() const (this=0x7fffa7ffeb70) at /nix/store/5qjycalzb9sqzvqg65kf5zimqwjabm9g-gcc-10.3.0/include/c++/10.3.0/bits/std_function.h:622\r\n#10 util::TraceThread(char const*, std::function<void ()>) (thread_name=<optimized out>, thread_func=...) at util/thread.cpp:18\r\n#11 0x000055555563376b in std::__invoke_impl<void, void (*)(char const*, std::function<void()>), char const*, AppInitMain(NodeContext&, interfaces::BlockAndHeaderTipInfo*)::<lambda()> > (\r\n    __f=@0x555555e7f818: 0x555555b0edf0 <util::TraceThread(char const*, std::function<void ()>)>) at /nix/store/5qjycalzb9sqzvqg65kf5zimqwjabm9g-gcc-10.3.0/include/c++/10.3.0/bits/invoke.h:60\r\n#12 std::__invoke<void (*)(char const*, std::function<void()>), char const*, AppInitMain(NodeContext&, interfaces::BlockAndHeaderTipInfo*)::<lambda()> > (__fn=@0x555555e7f818: 0x555555b0edf0 <util::TraceThread(char const*, std::function<void ()>)>)\r\n    at /nix/store/5qjycalzb9sqzvqg65kf5zimqwjabm9g-gcc-10.3.0/include/c++/10.3.0/bits/invoke.h:95\r\n#13 std::thread::_Invoker<std::tuple<void (*)(char const*, std::function<void()>), char const*, AppInitMain(NodeContext&, interfaces::BlockAndHeaderTipInfo*)::<lambda()> > >::_M_invoke<0, 1, 2> (this=0x555555e7f7e8)\r\n    at /nix/store/5qjycalzb9sqzvqg65kf5zimqwjabm9g-gcc-10.3.0/include/c++/10.3.0/thread:264\r\n#14 std::thread::_Invoker<std::tuple<void (*)(char const*, std::function<void()>), char const*, AppInitMain(NodeContext&, interfaces::BlockAndHeaderTipInfo*)::<lambda()> > >::operator() (this=0x555555e7f7e8)\r\n    at /nix/store/5qjycalzb9sqzvqg65kf5zimqwjabm9g-gcc-10.3.0/include/c++/10.3.0/thread:271\r\n#15 std::thread::_State_impl<std::thread::_Invoker<std::tuple<void (*)(char const*, std::function<void()>), char const*, AppInitMain(NodeContext&, interfaces::BlockAndHeaderTipInfo*)::<lambda()> > > >::_M_run(void) (this=0x555555e7f7e0)\r\n    at /nix/store/5qjycalzb9sqzvqg65kf5zimqwjabm9g-gcc-10.3.0/include/c++/10.3.0/thread:215\r\n#16 0x00007ffff7eaaca0 in ?? () from /nix/store/dzaadhn5y56da24635icafv1nrawxm4n-gcc-10.3.0-lib/lib/../lib64/libstdc++.so.6\r\n#17 0x00007ffff7fb1e9e in start_thread () from /nix/store/gk42f59363p82rg2wv2mfy71jn5w4q4c-glibc-2.32-48/lib/libpthread.so.0\r\n#18 0x00007ffff774949f in clone () from /nix/store/gk42f59363p82rg2wv2mfy71jn5w4q4c-glibc-2.32-48/lib/libc.so.6\r\n```",
      "commit_id" : "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
      "created_at" : "2021-09-23T19:31:22Z",
      "diff_hunk" : "@@ -1948,6 +1948,15 @@ bool CChainState::FlushStateToDisk(\n                last_prune = std::max(1, std::min(last_prune, index.GetSummary().best_block_height));\n             });\n \n+            for (auto const& blocker : m_blockman.m_prune_blockers) {\n+                const int blocker_height = blocker.second->nHeight - PRUNE_BLOCKER_BUFFER;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r715093019",
      "id" : 715093019,
      "line" : 1948,
      "node_id" : "PRRC_kwDOABII584qn3Qb",
      "original_commit_id" : "40ec224da2d1e389c6ef148beb27ae4c227b8b2b",
      "original_line" : 1952,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 21,
      "pull_request_review_id" : 761541915,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-23T19:39:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715093019",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-09-27T13:27:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-927875079",
      "id" : 927875079,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII5843TkAH",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-27T13:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/927875079",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r718948137"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718948137"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "fixed",
      "commit_id" : "f6766d436b22ac595f6e13d365d07af37dbc0ebd",
      "created_at" : "2021-09-29T23:18:33Z",
      "diff_hunk" : "@@ -48,6 +48,9 @@ extern uint64_t nPruneTarget;\n //! Check whether the block associated with this index entry is pruned or not.\n bool IsBlockPruned(const CBlockIndex* pblockindex);\n \n+//! Find the first block that is not pruned\n+const CBlockIndex* GetFirstStoredBlock(const CBlockIndex* start_block);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r718948137",
      "id" : 718948137,
      "in_reply_to_id" : 714427353,
      "line" : 52,
      "node_id" : "PRRC_kwDOABII584q2kcp",
      "original_commit_id" : "4ebe3a51da88589f23e243045a9e392701dfbbad",
      "original_line" : 52,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.h",
      "position" : 5,
      "pull_request_review_id" : 767267690,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-29T23:18:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718948137",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r718948229"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718948229"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Added",
      "commit_id" : "f6766d436b22ac595f6e13d365d07af37dbc0ebd",
      "created_at" : "2021-09-29T23:18:46Z",
      "diff_hunk" : "@@ -369,3 +365,12 @@ IndexSummary BaseIndex::GetSummary() const\n     summary.best_block_height = m_best_block_index ? m_best_block_index.load()->nHeight : 0;\n     return summary;\n }\n+\n+void BaseIndex::SetBestBlockIndex(const CBlockIndex* block) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r718948229",
      "id" : 718948229,
      "in_reply_to_id" : 715026559,
      "line" : 369,
      "node_id" : "PRRC_kwDOABII584q2keF",
      "original_commit_id" : "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
      "original_line" : 369,
      "original_position" : 80,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 80,
      "pull_request_review_id" : 767267785,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-29T23:18:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718948229",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r718948310"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718948310"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Added a note in the commit message",
      "commit_id" : "f6766d436b22ac595f6e13d365d07af37dbc0ebd",
      "created_at" : "2021-09-29T23:18:56Z",
      "diff_hunk" : "@@ -1941,12 +1940,9 @@ bool CChainState::FlushStateToDisk(\n         CoinsCacheSizeState cache_state = GetCoinsCacheSizeState();\n         LOCK(cs_LastBlockFile);\n         if (fPruneMode && (fCheckForPruning || nManualPruneHeight > 0) && !fReindex) {\n-            // make sure we don't prune above the blockfilterindexes bestblocks\n+            // make sure we don't prune above any of the prune blockers bestblocks\n             // pruning is height-based\n             int last_prune = m_chain.Height(); // last height we can prune\n-            ForEachBlockFilterIndex([&](BlockFilterIndex& index) {\n-               last_prune = std::max(1, std::min(last_prune, index.GetSummary().best_block_height));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r718948310",
      "id" : 718948310,
      "in_reply_to_id" : 715054451,
      "line" : 1954,
      "node_id" : "PRRC_kwDOABII584q2kfW",
      "original_commit_id" : "7db7f26e97665c048b3f614c092899addd658f4f",
      "original_line" : 1954,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 17,
      "pull_request_review_id" : 767267863,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-29T23:18:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718948310",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r718948387"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718948387"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I did not do performance tests on this change, it will probably not be huge but if we can get it, why not? But my main motivation is that I think that these checks are not necessary unless the conditions hold. I think it makes code easier to understand if sections that are not relevant are skipped explicitly. But I can see how this might be missing a comment for clarity, happy to add that if you agree.",
      "commit_id" : "f6766d436b22ac595f6e13d365d07af37dbc0ebd",
      "created_at" : "2021-09-29T23:19:08Z",
      "diff_hunk" : "@@ -67,7 +67,7 @@ bool BaseIndex::Init()\n         SetBestBlockIndex(m_chainstate->m_blockman.FindForkInGlobalIndex(active_chain, locator));\n     }\n     m_synced = m_best_block_index.load() == active_chain.Tip();\n-    if (!m_synced) {\n+    if (!m_synced && (fPruneMode || fHavePruned) && !fReindex) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r718948387",
      "id" : 718948387,
      "in_reply_to_id" : 715059159,
      "line" : 70,
      "node_id" : "PRRC_kwDOABII584q2kgj",
      "original_commit_id" : "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
      "original_line" : 70,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 12,
      "pull_request_review_id" : 767267957,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-29T23:19:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718948387",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r718949709"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718949709"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Oh, TIL that `Genesis()` can return a `nullptr` and does so initially when reindexing. I never really checked and assumed this couldn't happen since the Genesis block is hardcoded. Well, good to know and this should be fixed now.",
      "commit_id" : "f6766d436b22ac595f6e13d365d07af37dbc0ebd",
      "created_at" : "2021-09-29T23:22:40Z",
      "diff_hunk" : "@@ -1948,6 +1948,15 @@ bool CChainState::FlushStateToDisk(\n                last_prune = std::max(1, std::min(last_prune, index.GetSummary().best_block_height));\n             });\n \n+            for (auto const& blocker : m_blockman.m_prune_blockers) {\n+                const int blocker_height = blocker.second->nHeight - PRUNE_BLOCKER_BUFFER;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r718949709",
      "id" : 718949709,
      "in_reply_to_id" : 715093019,
      "line" : 1954,
      "node_id" : "PRRC_kwDOABII584q2k1N",
      "original_commit_id" : "40ec224da2d1e389c6ef148beb27ae4c227b8b2b",
      "original_line" : 1954,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 21,
      "pull_request_review_id" : 767269509,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-29T23:22:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718949709",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased and addressed @ryanofsky 's comments. Thanks for reviewing!",
      "created_at" : "2021-09-29T23:23:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-930617542",
      "id" : 930617542,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII5843eBjG",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-29T23:23:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/930617542",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r719590304"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719590304"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> I think it makes code easier to understand if sections that are not relevant are skipped explicitly.\r\n\r\nI would love to visit the planet where `if (!m_synced && (fPruneMode || fHavePruned) && !fReindex)` is easier to understand than `if (!m_synced)`. In general I don't think code is easier to read with special cases, and all else equal I wouldn't think that skipping checks would be a great idea even if did make code simpler. But this isn't very important. Would suggest dropping this commit, but it seems fine to keep it or let others weigh in. Thanks at least for splitting this change up nicely so it is easy to understand in sequence.",
      "commit_id" : "f6766d436b22ac595f6e13d365d07af37dbc0ebd",
      "created_at" : "2021-09-30T16:51:01Z",
      "diff_hunk" : "@@ -67,7 +67,7 @@ bool BaseIndex::Init()\n         SetBestBlockIndex(m_chainstate->m_blockman.FindForkInGlobalIndex(active_chain, locator));\n     }\n     m_synced = m_best_block_index.load() == active_chain.Tip();\n-    if (!m_synced) {\n+    if (!m_synced && (fPruneMode || fHavePruned) && !fReindex) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r719590304",
      "id" : 719590304,
      "in_reply_to_id" : 715059159,
      "line" : 70,
      "node_id" : "PRRC_kwDOABII584q5BOg",
      "original_commit_id" : "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
      "original_line" : 70,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 12,
      "pull_request_review_id" : 768112450,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719590304/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-30T17:07:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719590304",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-09-30T20:31:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-931643046",
      "id" : 931643046,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII5843h76m",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/931643046/reactions"
      },
      "updated_at" : "2021-09-30T20:31:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/931643046",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   }
]
