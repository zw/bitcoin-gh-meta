[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [jonatack](https://github.com/bitcoin/bitcoin/pull/27823#pullrequestreview-1482357475), [TheCharlatan](https://github.com/bitcoin/bitcoin/pull/27823#issuecomment-1598781025) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#27861](https://github.com/bitcoin/bitcoin/pull/27861) (kernel: Rm ShutdownRequested and AbortNode from validation code. by TheCharlatan)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-06-04T18:55:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27823#issuecomment-1575673596",
      "id" : 1575673596,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27823",
      "node_id" : "IC_kwDOABII585d6t78",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1575673596/reactions"
      },
      "updated_at" : "2023-06-28T13:23:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1575673596",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1217034392"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1217034392"
         }
      },
      "author_association" : "NONE",
      "body" : "Wouldn't it be better to check for `!=` instead for `>`? If the file is corrupt, then the indices might as well suddenly go down.",
      "commit_id" : "6d853ab639a7ddecf7d934c4d1fb48d29eccc27b",
      "created_at" : "2023-06-04T19:27:22Z",
      "diff_hunk" : "@@ -260,8 +260,11 @@ bool BlockManager::LoadBlockIndex()\n     std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n               CBlockIndexHeightOnlyComparator());\n \n+    CBlockIndex* previous_index{nullptr};\n     for (CBlockIndex* pindex : vSortedByHeight) {\n         if (ShutdownRequested()) return false;\n+        if (previous_index && pindex->nHeight > previous_index->nHeight + 1) return false; // corruption, non-contiguous block indexes",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1217034392",
      "id" : 1217034392,
      "line" : 266,
      "node_id" : "PRRC_kwDOABII585IiniY",
      "original_commit_id" : "fe0006221737023fd66f6fbf37f605670920fe77",
      "original_line" : 266,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 7,
      "pull_request_review_id" : 1461336335,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1217034392/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-04T19:28:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1217034392",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19430475?v=4",
         "events_url" : "https://api.github.com/users/Brotcrunsher/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Brotcrunsher/followers",
         "following_url" : "https://api.github.com/users/Brotcrunsher/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Brotcrunsher/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Brotcrunsher",
         "id" : 19430475,
         "login" : "Brotcrunsher",
         "node_id" : "MDQ6VXNlcjE5NDMwNDc1",
         "organizations_url" : "https://api.github.com/users/Brotcrunsher/orgs",
         "received_events_url" : "https://api.github.com/users/Brotcrunsher/received_events",
         "repos_url" : "https://api.github.com/users/Brotcrunsher/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Brotcrunsher/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Brotcrunsher/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Brotcrunsher"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1217039090"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1217039090"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think that would be incorrect, because there will be multiple indexes for a given height in case of stale blocks / forks.",
      "commit_id" : "6d853ab639a7ddecf7d934c4d1fb48d29eccc27b",
      "created_at" : "2023-06-04T19:32:01Z",
      "diff_hunk" : "@@ -260,8 +260,11 @@ bool BlockManager::LoadBlockIndex()\n     std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n               CBlockIndexHeightOnlyComparator());\n \n+    CBlockIndex* previous_index{nullptr};\n     for (CBlockIndex* pindex : vSortedByHeight) {\n         if (ShutdownRequested()) return false;\n+        if (previous_index && pindex->nHeight > previous_index->nHeight + 1) return false; // corruption, non-contiguous block indexes",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1217039090",
      "id" : 1217039090,
      "in_reply_to_id" : 1217034392,
      "line" : 266,
      "node_id" : "PRRC_kwDOABII585Iiory",
      "original_commit_id" : "fe0006221737023fd66f6fbf37f605670920fe77",
      "original_line" : 266,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 7,
      "pull_request_review_id" : 1461337650,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1217039090/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-04T19:32:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1217039090",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1217039358"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1217039358"
         }
      },
      "author_association" : "NONE",
      "body" : "True!",
      "commit_id" : "6d853ab639a7ddecf7d934c4d1fb48d29eccc27b",
      "created_at" : "2023-06-04T19:32:23Z",
      "diff_hunk" : "@@ -260,8 +260,11 @@ bool BlockManager::LoadBlockIndex()\n     std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n               CBlockIndexHeightOnlyComparator());\n \n+    CBlockIndex* previous_index{nullptr};\n     for (CBlockIndex* pindex : vSortedByHeight) {\n         if (ShutdownRequested()) return false;\n+        if (previous_index && pindex->nHeight > previous_index->nHeight + 1) return false; // corruption, non-contiguous block indexes",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1217039358",
      "id" : 1217039358,
      "in_reply_to_id" : 1217034392,
      "line" : 266,
      "node_id" : "PRRC_kwDOABII585Iiov-",
      "original_commit_id" : "fe0006221737023fd66f6fbf37f605670920fe77",
      "original_line" : 266,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 7,
      "pull_request_review_id" : 1461337678,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1217039358/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-04T19:44:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1217039358",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19430475?v=4",
         "events_url" : "https://api.github.com/users/Brotcrunsher/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Brotcrunsher/followers",
         "following_url" : "https://api.github.com/users/Brotcrunsher/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Brotcrunsher/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Brotcrunsher",
         "id" : 19430475,
         "login" : "Brotcrunsher",
         "node_id" : "MDQ6VXNlcjE5NDMwNDc1",
         "organizations_url" : "https://api.github.com/users/Brotcrunsher/orgs",
         "received_events_url" : "https://api.github.com/users/Brotcrunsher/received_events",
         "repos_url" : "https://api.github.com/users/Brotcrunsher/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Brotcrunsher/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Brotcrunsher/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Brotcrunsher"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Little disclaimer: It's my first Review for Bitcoin Core. So treat my input with care, I might have no clue what I am talking about.\r\n\r\nWhat I don't like about this change is that previously the user at least had a chance of finding out what's wrong, without debugging the code. Now he won't have any info of what went wrong other than \"Error loading block database\", which can have multiple other reasons. Is there a way for us to communicate this better? Maybe a log? Or can we throw here? The sad thing is that the return seems to be intermangled with none error cases like `ShutdownRequested`.",
      "created_at" : "2023-06-04T19:34:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27823#issuecomment-1575685598",
      "id" : 1575685598,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27823",
      "node_id" : "IC_kwDOABII585d6w3e",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1575685598/reactions"
      },
      "updated_at" : "2023-06-04T19:34:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1575685598",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19430475?v=4",
         "events_url" : "https://api.github.com/users/Brotcrunsher/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Brotcrunsher/followers",
         "following_url" : "https://api.github.com/users/Brotcrunsher/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Brotcrunsher/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Brotcrunsher",
         "id" : 19430475,
         "login" : "Brotcrunsher",
         "node_id" : "MDQ6VXNlcjE5NDMwNDc1",
         "organizations_url" : "https://api.github.com/users/Brotcrunsher/orgs",
         "received_events_url" : "https://api.github.com/users/Brotcrunsher/received_events",
         "repos_url" : "https://api.github.com/users/Brotcrunsher/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Brotcrunsher/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Brotcrunsher/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Brotcrunsher"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1218054540"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218054540"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Couldn't `vSortedByHeight` contain blocks from different chains at the same height?",
      "commit_id" : "6d853ab639a7ddecf7d934c4d1fb48d29eccc27b",
      "created_at" : "2023-06-05T13:11:23Z",
      "diff_hunk" : "@@ -260,8 +260,11 @@ bool BlockManager::LoadBlockIndex()\n     std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n               CBlockIndexHeightOnlyComparator());\n \n+    CBlockIndex* previous_index{nullptr};\n     for (CBlockIndex* pindex : vSortedByHeight) {\n         if (ShutdownRequested()) return false;\n+        if (previous_index && pindex->nHeight > previous_index->nHeight + 1) return false; // corruption, non-contiguous block indexes\n+        previous_index = pindex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1218054540",
      "id" : 1218054540,
      "line" : 267,
      "node_id" : "PRRC_kwDOABII585ImgmM",
      "original_commit_id" : "0b8b0e3051bb972a878f1855e7d32822b799e1e1",
      "original_line" : 267,
      "original_position" : 8,
      "original_start_line" : 263,
      "path" : "src/node/blockstorage.cpp",
      "position" : 8,
      "pull_request_review_id" : 1462508209,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218054540/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 263,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-06-05T13:11:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218054540",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1218160139"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218160139"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "What do you mean with \"different chains\"? `vSortedHeight` could contain blocks with the same height x (forks), but I can't see how these could have made it into the block index without having a predecessor of height x - 1 at the time they were added. Also, these shouldn't make the added check fail.\r\n\r\nI do wonder though if it would be possible / more general to directly check that each block of height > 0 has a predecessor in the chain, instead of doing what the PR currently suggests. I'll look into that.",
      "commit_id" : "6d853ab639a7ddecf7d934c4d1fb48d29eccc27b",
      "created_at" : "2023-06-05T14:30:58Z",
      "diff_hunk" : "@@ -260,8 +260,11 @@ bool BlockManager::LoadBlockIndex()\n     std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n               CBlockIndexHeightOnlyComparator());\n \n+    CBlockIndex* previous_index{nullptr};\n     for (CBlockIndex* pindex : vSortedByHeight) {\n         if (ShutdownRequested()) return false;\n+        if (previous_index && pindex->nHeight > previous_index->nHeight + 1) return false; // corruption, non-contiguous block indexes\n+        previous_index = pindex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1218160139",
      "id" : 1218160139,
      "in_reply_to_id" : 1218054540,
      "line" : 267,
      "node_id" : "PRRC_kwDOABII585Im6YL",
      "original_commit_id" : "0b8b0e3051bb972a878f1855e7d32822b799e1e1",
      "original_line" : 267,
      "original_position" : 8,
      "original_start_line" : 263,
      "path" : "src/node/blockstorage.cpp",
      "position" : 8,
      "pull_request_review_id" : 1462689403,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218160139/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 263,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-06-05T14:40:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218160139",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Now he won't have any info of what went wrong other than \"Error loading block database\", which can have multiple other reasons. Is there a way for us to communicate this better? Maybe a log? Or can we throw here?\r\n\r\nThanks! Yes, adding a log seems like a good idea, I'll do that with the next push!",
      "created_at" : "2023-06-05T14:34:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27823#issuecomment-1576922867",
      "id" : 1576922867,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27823",
      "node_id" : "IC_kwDOABII585d_e7z",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1576922867/reactions"
      },
      "updated_at" : "2023-06-05T14:34:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1576922867",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1218214833"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218214833"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> What do you mean with \"different chains\"? `vSortedHeight` could contain blocks with the same height x (forks), but I can't see how these could have made it into the block index without having a predecessor of height x - 1 at the time they were added. Also, these shouldn't make the added check fail.\r\n\r\nyeah ok. nvm. Got confused by the early return (I thought it in the other way around).\r\nThe check will have the previous block at the same height, so `pindex->nHeight > previous_index->nHeight + 1` will be false.\r\n\r\n> I do wonder though if it would be possible / more general to directly check that each block of height > 0 has a predecessor in the chain, instead of doing what the PR currently suggests. I'll look into that.\r\n\r\nWouldn't that be broken if we ever add a parallel headers download process?\r\nWhich IIRC we don't have because they are downloaded from a single peer at time. But if we implement it, we could get orphan block indexes pretty easily.",
      "commit_id" : "6d853ab639a7ddecf7d934c4d1fb48d29eccc27b",
      "created_at" : "2023-06-05T15:09:22Z",
      "diff_hunk" : "@@ -260,8 +260,11 @@ bool BlockManager::LoadBlockIndex()\n     std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n               CBlockIndexHeightOnlyComparator());\n \n+    CBlockIndex* previous_index{nullptr};\n     for (CBlockIndex* pindex : vSortedByHeight) {\n         if (ShutdownRequested()) return false;\n+        if (previous_index && pindex->nHeight > previous_index->nHeight + 1) return false; // corruption, non-contiguous block indexes\n+        previous_index = pindex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1218214833",
      "id" : 1218214833,
      "in_reply_to_id" : 1218054540,
      "line" : 267,
      "node_id" : "PRRC_kwDOABII585InHux",
      "original_commit_id" : "0b8b0e3051bb972a878f1855e7d32822b799e1e1",
      "original_line" : 267,
      "original_position" : 8,
      "original_start_line" : 263,
      "path" : "src/node/blockstorage.cpp",
      "position" : 8,
      "pull_request_review_id" : 1462776690,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218214833/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 263,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-06-05T15:09:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218214833",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1218371741"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218371741"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> Wouldn't that be broken if we ever add a parallel headers download process?\r\n> Which IIRC we don't have because they are downloaded from a single peer at time. But if we implement it, we could get orphan block indexes pretty easily.\r\n\r\nYes, but only we had a very naive parallel headers download process. I would imagine that if we ever parallelized headers download, we'd take care not to accept orphaned block indexes into our main block index (for DoS reasons) but would keep those headers in some kind of intermediate buffer until we can connect them.\r\n\r\n`net_processing` makes sure that we only save headers that we connect ([code](https://github.com/bitcoin/bitcoin/blob/f4a8269dfc144cc918570bdb870aa5143a11c1fe/src/net_processing.cpp#L2871-L2881)).",
      "commit_id" : "5352a981de1cc17e231e7336098bf03d600002ff",
      "created_at" : "2023-06-05T17:22:11Z",
      "diff_hunk" : "@@ -260,8 +260,11 @@ bool BlockManager::LoadBlockIndex()\n     std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n               CBlockIndexHeightOnlyComparator());\n \n+    CBlockIndex* previous_index{nullptr};\n     for (CBlockIndex* pindex : vSortedByHeight) {\n         if (ShutdownRequested()) return false;\n+        if (previous_index && pindex->nHeight > previous_index->nHeight + 1) return false; // corruption, non-contiguous block indexes\n+        previous_index = pindex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1218371741",
      "id" : 1218371741,
      "in_reply_to_id" : 1218054540,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585InuCd",
      "original_commit_id" : "0b8b0e3051bb972a878f1855e7d32822b799e1e1",
      "original_line" : 269,
      "original_position" : 8,
      "original_start_line" : 263,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 1463032349,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218371741/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-06-05T17:22:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218371741",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Added a Log error, and made the commit message more precise.\r\n\r\n\r\n> I do wonder though if it would be possible / more general to directly check that each block of height > 0 has a predecessor in the chain, instead of doing what the PR currently suggests.\r\n\r\nSince the current approach wouldn't catch all possible cases of a non-contiguous block index (but the one encountered in feature_init.py !), still looking to into having a stricter check - opinions welcome!\r\n",
      "created_at" : "2023-06-15T18:53:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27823#issuecomment-1593569559",
      "id" : 1593569559,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27823",
      "node_id" : "IC_kwDOABII585e-_EX",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1593569559/reactions"
      },
      "updated_at" : "2023-06-15T18:53:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1593569559",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1231516688"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231516688"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I've probably confused myself by how I'm checking this, but this doesn't seem to be the error site that is being hit?  The diff below passes.  (Your updated test does indeed fail on master and pass after building this pull, as described in the OP.)\r\n\r\n<details><summary>test diff</summary><p>\r\n\r\n```diff\r\ndiff --git a/test/functional/feature_init.py b/test/functional/feature_init.py\r\nindex 194ba9ed265..38bd3d5db0f 100755\r\n--- a/test/functional/feature_init.py\r\n+++ b/test/functional/feature_init.py\r\n@@ -107,6 +107,12 @@ class InitStressTest(BitcoinTestFramework):\r\n             'blocks/blk*.dat': 'Corrupted block database detected.',\r\n         }\r\n \r\n+        errors_logged = [\r\n+            \"ERROR: LoadBlockIndex: block index is non-contiguous\",\r\n+            \"LevelDB read failure: Corruption: not an sstable (bad magic number)\",\r\n+            \"ReadBlockFromDisk(CBlock&, CBlockIndex*): GetHash() doesn't match index for CBlockIndex\",\r\n+        ]\r\n+\r\n         for file_patt, err_fragment in files_to_delete.items():\r\n             target_files = list(node.chain_path.glob(file_patt))\r\n \r\n@@ -126,6 +132,7 @@ class InitStressTest(BitcoinTestFramework):\r\n             self.stop_node(0)\r\n \r\n         self.log.info(\"Test startup errors after perturbing certain essential files\")\r\n+        i = 0\r\n         for file_patt, err_fragment in files_to_perturb.items():\r\n             shutil.copytree(node.chain_path / \"blocks\", node.chain_path / \"blocks_bak\")\r\n             shutil.copytree(node.chain_path / \"chainstate\", node.chain_path / \"chainstate_bak\")\r\n@@ -139,8 +146,10 @@ class InitStressTest(BitcoinTestFramework):\r\n                     tweaked_contents[50:350] = b'1' * 300\r\n                 with open(target_file, \"wb\") as tf_write:\r\n                     tf_write.write(bytes(tweaked_contents))\r\n\r\n-            start_expecting_error(err_fragment)\r\n+            self.log.info(f\"{i} - {err_fragment} - {errors_logged[i]}\")\r\n+            with node.assert_debug_log([errors_logged[i]]):\r\n+                start_expecting_error(err_fragment)\r\n+            i += 1\r\n \r\n             shutil.rmtree(node.chain_path / \"blocks\")\r\n             shutil.rmtree(node.chain_path / \"chainstate\")\r\n```\r\n</p></details>\r\n",
      "commit_id" : "5352a981de1cc17e231e7336098bf03d600002ff",
      "created_at" : "2023-06-15T20:42:47Z",
      "diff_hunk" : "@@ -260,8 +260,13 @@ bool BlockManager::LoadBlockIndex()\n     std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n               CBlockIndexHeightOnlyComparator());\n \n+    CBlockIndex* previous_index{nullptr};\n     for (CBlockIndex* pindex : vSortedByHeight) {\n         if (ShutdownRequested()) return false;\n+        if (previous_index && pindex->nHeight > previous_index->nHeight + 1) {\n+            return error(\"%s: block index is non-contiguous, index of height %d missing\", __func__, previous_index->nHeight + 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1231516688",
      "id" : 1231516688,
      "line" : 267,
      "node_id" : "PRRC_kwDOABII585JZ3QQ",
      "original_commit_id" : "5352a981de1cc17e231e7336098bf03d600002ff",
      "original_line" : 267,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 8,
      "pull_request_review_id" : 1482357475,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231516688/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-16T01:12:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231516688",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1232345298"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232345298"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> The diff below passes.\r\n\r\nWhere does it pass for you?\r\nI tried to apply the diff too, and for me it passes on this branch and fails after removing 04d533781002be054e6f2493f3ab2389135ceec5 (not because the log message isn't found, but because the bitcoin core crashes with the assert before that).\r\nThat is what I would have expected, since the diff adds an additional check for the added log \"ERROR: LoadBlockIndex: block index is non-contiguous\", which is supposed to be hit as a result of the perturbation of the block files.",
      "commit_id" : "5352a981de1cc17e231e7336098bf03d600002ff",
      "created_at" : "2023-06-16T14:41:16Z",
      "diff_hunk" : "@@ -260,8 +260,13 @@ bool BlockManager::LoadBlockIndex()\n     std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n               CBlockIndexHeightOnlyComparator());\n \n+    CBlockIndex* previous_index{nullptr};\n     for (CBlockIndex* pindex : vSortedByHeight) {\n         if (ShutdownRequested()) return false;\n+        if (previous_index && pindex->nHeight > previous_index->nHeight + 1) {\n+            return error(\"%s: block index is non-contiguous, index of height %d missing\", __func__, previous_index->nHeight + 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1232345298",
      "id" : 1232345298,
      "in_reply_to_id" : 1231516688,
      "line" : 267,
      "node_id" : "PRRC_kwDOABII585JdBjS",
      "original_commit_id" : "5352a981de1cc17e231e7336098bf03d600002ff",
      "original_line" : 267,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 8,
      "pull_request_review_id" : 1483668947,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232345298/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-16T14:42:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232345298",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2023-06-20T13:23:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27823#issuecomment-1598781025",
      "id" : 1598781025,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27823",
      "node_id" : "IC_kwDOABII585fS3Zh",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1598781025/reactions"
      },
      "updated_at" : "2023-06-20T13:23:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1598781025",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Could rebase for CI?",
      "created_at" : "2023-06-28T10:52:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27823#issuecomment-1611186437",
      "id" : 1611186437,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27823",
      "node_id" : "IC_kwDOABII585gCMEF",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1611186437/reactions"
      },
      "updated_at" : "2023-06-28T10:52:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1611186437",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Could rebase for CI?\r\n\r\ndone",
      "created_at" : "2023-06-28T14:44:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27823#issuecomment-1611579553",
      "id" : 1611579553,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27823",
      "node_id" : "IC_kwDOABII585gDsCh",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1611579553/reactions"
      },
      "updated_at" : "2023-06-28T14:44:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1611579553",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-07-06T22:05:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27823#issuecomment-1624368559",
      "id" : 1624368559,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27823",
      "node_id" : "IC_kwDOABII585g0eWv",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1624368559/reactions"
      },
      "updated_at" : "2023-07-06T22:05:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1624368559",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1266974334"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266974334"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In ad66ca1e:\r\n\r\nWhat if the genesis block index is missing?\r\nThe first round of the loop would set `previous_index` to block_index_1. Second one to block_index_2, etc. Making `LoadBlockIndex()` pass?.",
      "commit_id" : "d27b9a2248476439ddab7700327f074005a810d5",
      "created_at" : "2023-07-18T15:46:03Z",
      "diff_hunk" : "@@ -259,8 +259,13 @@ bool BlockManager::LoadBlockIndex()\n     std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n               CBlockIndexHeightOnlyComparator());\n \n+    CBlockIndex* previous_index{nullptr};\n     for (CBlockIndex* pindex : vSortedByHeight) {\n         if (m_interrupt) return false;\n+        if (previous_index && pindex->nHeight > previous_index->nHeight + 1) {\n+            return error(\"%s: block index is non-contiguous, index of height %d missing\", __func__, previous_index->nHeight + 1);\n+        }\n+        previous_index = pindex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1266974334",
      "id" : 1266974334,
      "line" : 268,
      "node_id" : "PRRC_kwDOABII585LhH5-",
      "original_commit_id" : "ad66ca1e475d2546dbbda206465307613108a15d",
      "original_line" : 268,
      "original_position" : 10,
      "original_start_line" : 265,
      "path" : "src/node/blockstorage.cpp",
      "position" : 10,
      "pull_request_review_id" : 1535361885,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266974334/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 265,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-07-18T15:46:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266974334",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1267265463"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267265463"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "That is true, but the specific case of a missing (or incorrect) genesis block index should get caught in an extra check right after, [see here](https://github.com/bitcoin/bitcoin/blob/c6a338b67e8e7848e6f42329a8b0bf3add16ad51/src/node/chainstate.cpp#L69C1-L74).\r\n\r\nThere are other cases that wouldn't be caught with the proposed solution: We could have the valid chain and also some extra block indices that don't connect. \r\nA stricter check would therefore be to require each block index of height `x` (except genesis) to have a predecessor of height `x - 1`. I didn't add it because these kind of extra blocks wouldn't actually hurt anything, plus maybe there are some of these block indices out there because of some bug in some ancient version of core.",
      "commit_id" : "d27b9a2248476439ddab7700327f074005a810d5",
      "created_at" : "2023-07-18T20:16:38Z",
      "diff_hunk" : "@@ -259,8 +259,13 @@ bool BlockManager::LoadBlockIndex()\n     std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n               CBlockIndexHeightOnlyComparator());\n \n+    CBlockIndex* previous_index{nullptr};\n     for (CBlockIndex* pindex : vSortedByHeight) {\n         if (m_interrupt) return false;\n+        if (previous_index && pindex->nHeight > previous_index->nHeight + 1) {\n+            return error(\"%s: block index is non-contiguous, index of height %d missing\", __func__, previous_index->nHeight + 1);\n+        }\n+        previous_index = pindex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1267265463",
      "id" : 1267265463,
      "in_reply_to_id" : 1266974334,
      "line" : 268,
      "node_id" : "PRRC_kwDOABII585LiO-3",
      "original_commit_id" : "ad66ca1e475d2546dbbda206465307613108a15d",
      "original_line" : 268,
      "original_position" : 10,
      "original_start_line" : 265,
      "path" : "src/node/blockstorage.cpp",
      "position" : 10,
      "pull_request_review_id" : 1535841203,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267265463/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 265,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-07-18T20:16:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267265463",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1267289758"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267289758"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe could randomize (or restructure) this a bit in a follow-up. Perturbing different parts of the block content might let us detect and add coverage for different errors.",
      "commit_id" : "d27b9a2248476439ddab7700327f074005a810d5",
      "created_at" : "2023-07-18T20:45:39Z",
      "diff_hunk" : "@@ -124,18 +125,31 @@ def check_clean_start():\n             check_clean_start()\n             self.stop_node(0)\n \n+        self.log.info(\"Test startup errors after perturbing certain essential files\")\n         for file_patt, err_fragment in files_to_perturb.items():\n+            shutil.copytree(node.chain_path / \"blocks\", node.chain_path / \"blocks_bak\")\n+            shutil.copytree(node.chain_path / \"chainstate\", node.chain_path / \"chainstate_bak\")\n             target_files = list(node.chain_path.glob(file_patt))\n \n             for target_file in target_files:\n                 self.log.info(f\"Perturbing file to ensure failure {target_file}\")\n-                with open(target_file, \"rb\") as tf_read, open(target_file, \"wb\") as tf_write:\n+                with open(target_file, \"rb\") as tf_read:\n                     contents = tf_read.read()\n                     tweaked_contents = bytearray(contents)\n-                    tweaked_contents[50:250] = b'1' * 200\n+                    # Since the genesis block is not checked by -checkblocks, the\n+                    # perturbation window must be chosen such that a higher block\n+                    # in blk*.dat is affected.\n+                    tweaked_contents[150:350] = b'1' * 200",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1267289758",
      "id" : 1267289758,
      "line" : 142,
      "node_id" : "PRRC_kwDOABII585LiU6e",
      "original_commit_id" : "d27b9a2248476439ddab7700327f074005a810d5",
      "original_line" : 142,
      "original_position" : 49,
      "original_start_line" : 139,
      "path" : "test/functional/feature_init.py",
      "position" : 49,
      "pull_request_review_id" : 1535880019,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267289758/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 139,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-07-19T13:55:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267289758",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1268112906"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1268112906"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: couldn't this be copied outside of the for-loop only once?",
      "commit_id" : "d27b9a2248476439ddab7700327f074005a810d5",
      "created_at" : "2023-07-19T13:54:01Z",
      "diff_hunk" : "@@ -124,18 +125,31 @@ def check_clean_start():\n             check_clean_start()\n             self.stop_node(0)\n \n+        self.log.info(\"Test startup errors after perturbing certain essential files\")\n         for file_patt, err_fragment in files_to_perturb.items():\n+            shutil.copytree(node.chain_path / \"blocks\", node.chain_path / \"blocks_bak\")\n+            shutil.copytree(node.chain_path / \"chainstate\", node.chain_path / \"chainstate_bak\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1268112906",
      "id" : 1268112906,
      "line" : 131,
      "node_id" : "PRRC_kwDOABII585Lld4K",
      "original_commit_id" : "d27b9a2248476439ddab7700327f074005a810d5",
      "original_line" : 131,
      "original_position" : 36,
      "original_start_line" : 130,
      "path" : "test/functional/feature_init.py",
      "position" : 36,
      "pull_request_review_id" : 1535880019,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1268112906/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 130,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-07-19T13:55:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1268112906",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   }
]
