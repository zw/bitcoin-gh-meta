[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept NACK | [luke-jr](https://github.com/bitcoin/bitcoin/pull/27804#issuecomment-1617016570) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n",
      "created_at" : "2023-06-02T13:02:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27804#issuecomment-1573699855",
      "id" : 1573699855,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27804",
      "node_id" : "IC_kwDOABII585dzMEP",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1573699855/reactions"
      },
      "updated_at" : "2023-07-03T00:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1573699855",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "There are ways to bypass this simple de-duplication(e.g. using different hostnames for the same host) as it relies on string comparison, but it gets us most of the way.\r\n\r\nLooking for approach ACKs.\r\n\r\nI did consider more robust ways of testing for duplicates, but of course we already do this before making a new outbound and that doesn't help the startup race condition this (mostly) resolves.\r\n\r\nAnother option would be to de-duplicate after resolving hostnames, but that seems a bit overkill to me?\r\n\r\n<details>\r\n<summary>Before and after connection summaries</summary>\r\n.  \r\n  \r\nBefore, both nodes have 3 connections. Node 2 exhibits the race and makes two outbound connections to Node 1, one via addnode and one via connect.\r\n\r\n```sh\r\n# Node 1\r\n/home/will/src/bitcoin/src/bitcoin-cli -datadir=/tmp/node1-datadir getpeerinfo | jq '[.[] | {id: .id, addr: .addr, type: .connection_type}]'\r\n[\r\n  {\r\n    \"id\": 0,\r\n    \"addr\": \"127.0.0.1:60216\",\r\n    \"type\": \"inbound\"\r\n  },\r\n  {\r\n    \"id\": 1,\r\n    \"addr\": \"127.0.0.1:60218\",\r\n    \"type\": \"inbound\"\r\n  },\r\n  {\r\n    \"id\": 2,\r\n    \"addr\": \"127.0.0.1:18400\",\r\n    \"type\": \"manual\"\r\n  }\r\n]\r\n\r\n# Node 2\r\n/home/will/src/bitcoin/src/bitcoin-cli -datadir=/tmp/node2-datadir -rpcport=18300 getpeerinfo | jq '[.[] | {id: .id, addr: .addr, type: .connection_type}]'\r\n[\r\n  {\r\n    \"id\": 0,\r\n    \"addr\": \"127.0.0.1:18445\",\r\n    \"type\": \"manual\"\r\n  },\r\n  {\r\n    \"id\": 1,\r\n    \"addr\": \"127.0.0.1:18445\",\r\n    \"type\": \"manual\"\r\n  },\r\n  {\r\n    \"id\": 2,\r\n    \"addr\": \"127.0.0.1:38596\",\r\n    \"type\": \"inbound\"\r\n  }\r\n]\r\n```\r\n\r\nAfter, nodes have the expected two connections.\r\n\r\n```sh\r\n# Node 1\r\n/home/will/src/bitcoin/src/bitcoin-cli -datadir=/tmp/node1-datadir getpeerinfo | jq '[.[] | {id: .id, addr: .addr, type: .connection_type}]'\r\n[\r\n  {\r\n    \"id\": 0,\r\n    \"addr\": \"127.0.0.1:59196\",\r\n    \"type\": \"inbound\"\r\n  },\r\n  {\r\n    \"id\": 1,\r\n    \"addr\": \"127.0.0.1:18400\",\r\n    \"type\": \"manual\"\r\n  }\r\n]\r\n\r\n\r\n# Node 2\r\n/home/will/src/bitcoin/src/bitcoin-cli -datadir=/tmp/node2-datadir -rpcport=18300 getpeerinfo | jq '[.[] | {id: .id, addr: .addr, type: .connection_type}]'\r\n[\r\n  {\r\n    \"id\": 0,\r\n    \"addr\": \"127.0.0.1:18445\",\r\n    \"type\": \"manual\"\r\n  },\r\n  {\r\n    \"id\": 1,\r\n    \"addr\": \"127.0.0.1:51594\",\r\n    \"type\": \"inbound\"\r\n  }\r\n]\r\n```\r\n\r\n</details>",
      "created_at" : "2023-06-02T13:02:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27804#issuecomment-1573700827",
      "id" : 1573700827,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27804",
      "node_id" : "IC_kwDOABII585dzMTb",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1573700827/reactions"
      },
      "updated_at" : "2023-06-09T09:14:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1573700827",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Weak approach NACK. This feels like a hacky workaround for what is ultimately a race condition. Rather we just address the cause of the issue, instead of introducing weird variables (eg, what happens if the `-connect`ion is lost, and the user use the `addnode` RPC right at the correct moment?).",
      "created_at" : "2023-07-03T00:00:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27804#issuecomment-1617016570",
      "id" : 1617016570,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27804",
      "node_id" : "IC_kwDOABII585gYbb6",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1617016570/reactions"
      },
      "updated_at" : "2023-07-03T00:00:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1617016570",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks Luke, I mostly agree (that this is a bit hacky). Implemented here currently is the \"simplest\" (could also read \"dumbest\") fix to the issue, whilst trying to avoid any using more mutexes and possibly introducing new thread safety issues etc.\r\n\r\nAs I see it the root cause is that we use two threads to make outbound connections simultaneously with no way of deduplicating except _after_ the connection is successful and the node is pushed onto `m_nodes`. This allows the race on node connections provided to the two startup options.\r\n\r\nOne alternative could be to introduce a new mutex-guarded datastructure on CConnman to store nodes *while they are being tried* in `OpenNetworkConnection()` (called by both `ThreadOpenConnections()` and `ThreadOpenAddedConnections()`). They can then be removed when the function exits, whether successful or not.\r\n\r\nI implemented the latter using a new RAII helper class in this branch: https://github.com/bitcoin/bitcoin/compare/master...willcl-ark:bitcoin:dedup-added-conns-alt and would be curious if you think this approach is better? It's not totally airtight as I am matching on _either_ `CAddress` _or_ `pszDest` but as the the two types are not mixed between  `ThreadOpenConnections()` adding `-connect` nodes and `ThreadOpenAddedConnections()` adding `-addnode` nodes (both use c strings with an empty `CAddress` object), so matching will work against the startup options at least.\r\n\r\nI think this method would also protect against a theoretical RPC race that you mention, although I find the idea of that occurring quite unlikely.\r\n\r\nPersonally I like the simplicity of the arg list de-duplication, but open to being persuaded in other directions...",
      "created_at" : "2023-07-03T13:18:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27804#issuecomment-1618247262",
      "id" : 1618247262,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27804",
      "node_id" : "IC_kwDOABII585gdH5e",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1618247262/reactions"
      },
      "updated_at" : "2023-07-03T13:18:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1618247262",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   }
]
