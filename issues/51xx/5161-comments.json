[
   {
      "body" : "I've tested this (and variations of it) for a while and I'm happy with it. I think its reasonably simple now and avoids moving much of anything around.\r\n\r\nThe testing I performed was two fold, I ran an instrumented copy that logged its announcements and saw it making both types of announcements.\r\n\r\nI also ran a node behind nat (with a port forward) which hasn't had bitcoin running on it recently without UPNP or other ways of discovering an IP and confirmed that it eventually gained inbound connections.",
      "created_at" : "2014-10-28T22:08:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#issuecomment-60840573",
      "id" : 60840573,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5161",
      "updated_at" : "2014-10-28T22:15:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/60840573",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Can we change the help text on -discover to say something like \"Do not rumor your address except as provided by -localip\"? (and, more broadly, do we really want a flag for this? It is some strange depend-on-my-peer-not-rumoring-my-address benchmark, when we really should just use fListen?)\r\n",
      "created_at" : "2014-10-29T06:13:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#issuecomment-60878774",
      "id" : 60878774,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5161",
      "updated_at" : "2014-10-29T06:13:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/60878774",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19521528"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/19521528"
         }
      },
      "body" : "Because of this we only clear setAddrKnown when we're listening, which I dont think was intended?",
      "commit_id" : "845c86d128fb97d55d125e63653def38729bd2ed",
      "created_at" : "2014-10-29T06:14:03Z",
      "diff_hunk" : "@@ -4344,8 +4350,9 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n \n         // Address refresh broadcast\n         static int64_t nLastRebroadcast;\n-        if (!IsInitialBlockDownload() && (GetTime() - nLastRebroadcast > 24 * 60 * 60))\n+        if (fListen && !IsInitialBlockDownload() && (GetTime() - nLastRebroadcast > 24 * 60 * 60))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19521528",
      "id" : 19521528,
      "original_commit_id" : "9eee4d8b4c952ed182e3c7571205a269663d87f9",
      "original_position" : 45,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161",
      "updated_at" : "2014-11-07T20:14:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/19521528",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19521643"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/19521643"
         }
      },
      "body" : "After this youve cleared the nServices and nTime fields set by GetLocalAddress.",
      "commit_id" : "845c86d128fb97d55d125e63653def38729bd2ed",
      "created_at" : "2014-10-29T06:21:07Z",
      "diff_hunk" : "@@ -3483,7 +3483,13 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n             {\n                 CAddress addr = GetLocalAddress(&pfrom->addr);\n                 if (addr.IsRoutable())\n+                {\n+                    pfrom->PushAddress(addr);\n+                } else if (IsPeerAddrLocalGood(pfrom)) {\n+                    addr = CAddress(pfrom->addrLocal);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19521643",
      "id" : 19521643,
      "original_commit_id" : "9eee4d8b4c952ed182e3c7571205a269663d87f9",
      "original_position" : 33,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161",
      "updated_at" : "2014-11-07T20:14:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/19521643",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19521645"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/19521645"
         }
      },
      "body" : "After this youve cleared the nServices and nTime fields set by GetLocalAddress.",
      "commit_id" : "845c86d128fb97d55d125e63653def38729bd2ed",
      "created_at" : "2014-10-29T06:21:15Z",
      "diff_hunk" : "@@ -204,23 +204,45 @@ bool RecvLine(SOCKET hSocket, string& strLine)\n     }\n }\n \n-// used when scores of local addresses may have changed\n-// pushes better local address to peers\n-void static AdvertizeLocal()\n+int GetnScore(const CService& addr)\n {\n-    LOCK(cs_vNodes);\n-    BOOST_FOREACH(CNode* pnode, vNodes)\n+    LOCK(cs_mapLocalHost);\n+    if (mapLocalHost.count(addr) == 0)\n+        return 0;\n+    return mapLocalHost[addr].nScore;\n+}\n+\n+// Is our peer's addrLocal potentially useful as an external IP source?\n+bool IsPeerAddrLocalGood(CNode *pnode)\n+{\n+    return fDiscover && pnode->addr.IsRoutable() && pnode->addrLocal.IsRoutable() &&\n+           GetListenPort() == Params().GetDefaultPort() &&\n+           !IsLimited(pnode->addrLocal.GetNetwork());\n+}\n+\n+// pushes our own address to a peer\n+bool AdvertizeLocal(CNode *pnode)\n+{\n+    bool ret = false;\n+    if (fListen && pnode->fSuccessfullyConnected)\n     {\n-        if (pnode->fSuccessfullyConnected)\n+        CAddress addrLocal = GetLocalAddress(&pnode->addr);\n+        // If discovery is enabled, sometimes give our peer the address it\n+        // tells us that it sees us as in case it has a better idea of our\n+        // address than we do.\n+        if (IsPeerAddrLocalGood(pnode) && (!addrLocal.IsRoutable() ||\n+             GetRand(GetnScore(addrLocal)>LOCAL_MANUAL?8:2) == 0))\n         {\n-            CAddress addrLocal = GetLocalAddress(&pnode->addr);\n-            if (addrLocal.IsRoutable() && (CService)addrLocal != (CService)pnode->addrLocal)\n-            {\n-                pnode->PushAddress(addrLocal);\n-                pnode->addrLocal = addrLocal;\n-            }\n+            addrLocal = CAddress(pnode->addrLocal);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19521645",
      "id" : 19521645,
      "original_commit_id" : "9eee4d8b4c952ed182e3c7571205a269663d87f9",
      "original_position" : 45,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161",
      "updated_at" : "2014-11-07T20:14:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/19521645",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19522135"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/19522135"
         }
      },
      "body" : "gah. good catch. I added that at the last minute \"oh why bother taking the vnodes lock when we're not going to do anything with it.\"",
      "commit_id" : "845c86d128fb97d55d125e63653def38729bd2ed",
      "created_at" : "2014-10-29T06:49:35Z",
      "diff_hunk" : "@@ -4344,8 +4350,9 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n \n         // Address refresh broadcast\n         static int64_t nLastRebroadcast;\n-        if (!IsInitialBlockDownload() && (GetTime() - nLastRebroadcast > 24 * 60 * 60))\n+        if (fListen && !IsInitialBlockDownload() && (GetTime() - nLastRebroadcast > 24 * 60 * 60))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19522135",
      "id" : 19522135,
      "original_commit_id" : "9eee4d8b4c952ed182e3c7571205a269663d87f9",
      "original_position" : 45,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161",
      "updated_at" : "2014-11-07T20:14:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/19522135",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "> Can we change the help text on -discover to say something like \"Do not rumor your address except as provided by -localip\"? (and, more broadly, do we really want a flag for this? It is some strange depend-on-my-peer-not-rumoring-my-address benchmark, when we really should just use fListen?)\r\n\r\nConsider, when you're listening to torHS you want listen=1 but you certantly don't want discovery of any type. (capturing that, one of the extra changes I made here was making proxy also imply no discovery but it still should be settable).  Beyond hoping that your peers won't disrespect your wishes, it can avoid rumoring incorrect data when your outbound connections don't match your inbound.  (p2pool has no way to control what addresses get rumored and this has broken things for at least a couple people).\r\n  ",
      "created_at" : "2014-10-29T07:21:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#issuecomment-60883023",
      "id" : 60883023,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5161",
      "updated_at" : "2014-10-29T07:21:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/60883023",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "> I think there is some clown out there who is addr messaging for everyone who connects to him\r\n\r\nThere's a number of clients on the network that do absolutely stupid things with the IP address in the handshake and addr messages. One piece of software returns `::1` for everything, another returns a `0.0.0.0`, another makes up random IP addresses for their peers. I don't know what software they are, because two pretend to be a `/Satoshi/` client (Satoshi seems to be the new Mozilla/5.0), and the other returns null for the human readable version name. \r\n\r\nIt's likely not a problem for this patch, just be aware that even the big players are writing horribly broken code that doesn't even attempt to conform to the p2p network the core client does.",
      "created_at" : "2014-10-29T08:09:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#issuecomment-60886639",
      "id" : 60886639,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5161",
      "updated_at" : "2014-10-29T08:16:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/60886639",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10137?v=3",
         "events_url" : "https://api.github.com/users/ghost/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ghost/followers",
         "following_url" : "https://api.github.com/users/ghost/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ghost/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ghost",
         "id" : 10137,
         "login" : "ghost",
         "organizations_url" : "https://api.github.com/users/ghost/orgs",
         "received_events_url" : "https://api.github.com/users/ghost/received_events",
         "repos_url" : "https://api.github.com/users/ghost/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ghost/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ghost/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ghost"
      }
   },
   {
      "body" : "Yea, this patch doesn't assume the peers are non-evil, much less assuming they aren't conventionally broken.  ",
      "created_at" : "2014-10-29T08:16:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#issuecomment-60887226",
      "id" : 60887226,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5161",
      "updated_at" : "2014-10-29T08:16:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/60887226",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "@TheBlueMatt see updates",
      "created_at" : "2014-10-29T20:34:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#issuecomment-60999829",
      "id" : 60999829,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5161",
      "updated_at" : "2014-10-29T20:34:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/60999829",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19574924"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/19574924"
         }
      },
      "body" : "Does AdvertizeLocal still qualify for the previous comment (\"used when scores of local addresses may have changed\")?",
      "commit_id" : "845c86d128fb97d55d125e63653def38729bd2ed",
      "created_at" : "2014-10-29T21:50:38Z",
      "diff_hunk" : "@@ -204,21 +204,42 @@ bool RecvLine(SOCKET hSocket, string& strLine)\n     }\n }\n \n-// used when scores of local addresses may have changed\n-// pushes better local address to peers\n-void static AdvertizeLocal()\n+int GetnScore(const CService& addr)\n {\n-    LOCK(cs_vNodes);\n-    BOOST_FOREACH(CNode* pnode, vNodes)\n+    LOCK(cs_mapLocalHost);\n+    if (mapLocalHost.count(addr) == 0)\n+        return 0;\n+    return mapLocalHost[addr].nScore;\n+}\n+\n+// Is our peer's addrLocal potentially useful as an external IP source?\n+bool IsPeerAddrLocalGood(CNode *pnode)\n+{\n+    return fDiscover && pnode->addr.IsRoutable() && pnode->addrLocal.IsRoutable() &&\n+           GetListenPort() == Params().GetDefaultPort() &&\n+           !IsLimited(pnode->addrLocal.GetNetwork());\n+}\n+\n+// pushes our own address to a peer\n+void AdvertizeLocal(CNode *pnode)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19574924",
      "id" : 19574924,
      "original_commit_id" : "bf0f14f1c995cf7815ccb52cea3d9d9e7b35d74f",
      "original_position" : 26,
      "path" : "src/net.cpp",
      "position" : 48,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161",
      "updated_at" : "2014-11-07T20:14:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/19574924",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/101238?v=3",
         "events_url" : "https://api.github.com/users/kanzure/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kanzure/followers",
         "following_url" : "https://api.github.com/users/kanzure/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kanzure/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kanzure",
         "id" : 101238,
         "login" : "kanzure",
         "organizations_url" : "https://api.github.com/users/kanzure/orgs",
         "received_events_url" : "https://api.github.com/users/kanzure/received_events",
         "repos_url" : "https://api.github.com/users/kanzure/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kanzure/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kanzure/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kanzure"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19576345"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/19576345"
         }
      },
      "body" : "Only indirectly. Previously it invoked readvertisement more frequently, potentially triggered by external events. With this change we only advertise on connect and on a timer... if the scores change it'll influence what we advertise, but no longer directly triggers it.",
      "commit_id" : "845c86d128fb97d55d125e63653def38729bd2ed",
      "created_at" : "2014-10-29T22:16:19Z",
      "diff_hunk" : "@@ -204,21 +204,42 @@ bool RecvLine(SOCKET hSocket, string& strLine)\n     }\n }\n \n-// used when scores of local addresses may have changed\n-// pushes better local address to peers\n-void static AdvertizeLocal()\n+int GetnScore(const CService& addr)\n {\n-    LOCK(cs_vNodes);\n-    BOOST_FOREACH(CNode* pnode, vNodes)\n+    LOCK(cs_mapLocalHost);\n+    if (mapLocalHost.count(addr) == 0)\n+        return 0;\n+    return mapLocalHost[addr].nScore;\n+}\n+\n+// Is our peer's addrLocal potentially useful as an external IP source?\n+bool IsPeerAddrLocalGood(CNode *pnode)\n+{\n+    return fDiscover && pnode->addr.IsRoutable() && pnode->addrLocal.IsRoutable() &&\n+           GetListenPort() == Params().GetDefaultPort() &&\n+           !IsLimited(pnode->addrLocal.GetNetwork());\n+}\n+\n+// pushes our own address to a peer\n+void AdvertizeLocal(CNode *pnode)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19576345",
      "id" : 19576345,
      "original_commit_id" : "bf0f14f1c995cf7815ccb52cea3d9d9e7b35d74f",
      "original_position" : 26,
      "path" : "src/net.cpp",
      "position" : 48,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161",
      "updated_at" : "2014-11-07T20:14:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/19576345",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Does this pull request also resolve issue https://github.com/bitcoin/bitcoin/issues/48 ?",
      "created_at" : "2014-10-30T13:16:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#issuecomment-61089105",
      "id" : 61089105,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5161",
      "updated_at" : "2014-10-30T13:16:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/61089105",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3501598?v=3",
         "events_url" : "https://api.github.com/users/spinza/events{/privacy}",
         "followers_url" : "https://api.github.com/users/spinza/followers",
         "following_url" : "https://api.github.com/users/spinza/following{/other_user}",
         "gists_url" : "https://api.github.com/users/spinza/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/spinza",
         "id" : 3501598,
         "login" : "spinza",
         "organizations_url" : "https://api.github.com/users/spinza/orgs",
         "received_events_url" : "https://api.github.com/users/spinza/received_events",
         "repos_url" : "https://api.github.com/users/spinza/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/spinza/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/spinza/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/spinza"
      }
   },
   {
      "body" : "@spinza the substance of #48 was mostly solved by the prior heartbeating changes. But this will improve the loss of inbound connections after your IP changes.",
      "created_at" : "2014-10-30T17:34:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#issuecomment-61134335",
      "id" : 61134335,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5161",
      "updated_at" : "2014-10-30T17:34:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/61134335",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19803608"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/19803608"
         }
      },
      "body" : "I don't think this rationale fits. Proxies aren't always for privacy. More importantly: is there a reason not to default discover to false always?",
      "commit_id" : "845c86d128fb97d55d125e63653def38729bd2ed",
      "created_at" : "2014-11-04T14:04:43Z",
      "diff_hunk" : "@@ -568,6 +568,9 @@ bool AppInit2(boost::thread_group& threadGroup)\n         // to protect privacy, do not listen by default if a default proxy server is specified\n         if (SoftSetBoolArg(\"-listen\", false))\n             LogPrintf(\"AppInit2 : parameter interaction: -proxy set -> setting -listen=0\\n\");\n+        // to protect privacy, do not discover addresses by default\n+        if (SoftSetBoolArg(\"-discover\", false))\n+            LogPrintf(\"AppInit2 : parameter interaction: -proxy set -> setting -discover=0\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19803608",
      "id" : 19803608,
      "original_commit_id" : "bf0f14f1c995cf7815ccb52cea3d9d9e7b35d74f",
      "original_position" : 6,
      "path" : "src/init.cpp",
      "position" : 6,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161",
      "updated_at" : "2014-11-07T20:14:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/19803608",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19803935"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/19803935"
         }
      },
      "body" : "How about using addr.SetIP(pfrom->addrLocal); here, rather than re-setting nServices/nTime below? (this seems more future-proof if CAddress adds new stuff ever)",
      "commit_id" : "845c86d128fb97d55d125e63653def38729bd2ed",
      "created_at" : "2014-11-04T14:12:07Z",
      "diff_hunk" : "@@ -3483,7 +3483,13 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n             {\n                 CAddress addr = GetLocalAddress(&pfrom->addr);\n                 if (addr.IsRoutable())\n+                {\n+                    pfrom->PushAddress(addr);\n+                } else if (IsPeerAddrLocalGood(pfrom)) {\n+                    addr = CAddress(pfrom->addrLocal);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19803935",
      "id" : 19803935,
      "original_commit_id" : "9eee4d8b4c952ed182e3c7571205a269663d87f9",
      "original_position" : 33,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161",
      "updated_at" : "2014-11-07T20:14:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/19803935",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19804034"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/19804034"
         }
      },
      "body" : "This would be clearer to just say if (!vNodes.empty())",
      "commit_id" : "845c86d128fb97d55d125e63653def38729bd2ed",
      "created_at" : "2014-11-04T14:14:08Z",
      "diff_hunk" : "@@ -4346,24 +4354,22 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n         static int64_t nLastRebroadcast;\n         if (!IsInitialBlockDownload() && (GetTime() - nLastRebroadcast > 24 * 60 * 60))\n         {\n+            bool rebroadcastRun = false;\n             {\n                 LOCK(cs_vNodes);\n                 BOOST_FOREACH(CNode* pnode, vNodes)\n                 {\n+                    rebroadcastRun = true;\n                     // Periodically clear setAddrKnown to allow refresh broadcasts\n                     if (nLastRebroadcast)\n                         pnode->setAddrKnown.clear();\n \n                     // Rebroadcast our address\n-                    if (fListen)\n-                    {\n-                        CAddress addr = GetLocalAddress(&pnode->addr);\n-                        if (addr.IsRoutable())\n-                            pnode->PushAddress(addr);\n-                    }\n+                    AdvertizeLocal(pnode);\n                 }\n             }\n-            nLastRebroadcast = GetTime();\n+            if (rebroadcastRun)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19804034",
      "id" : 19804034,
      "original_commit_id" : "bf0f14f1c995cf7815ccb52cea3d9d9e7b35d74f",
      "original_position" : 67,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161",
      "updated_at" : "2014-11-07T20:14:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/19804034",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19804117"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/19804117"
         }
      },
      "body" : "Is advertise intentionally misspelled?",
      "commit_id" : "845c86d128fb97d55d125e63653def38729bd2ed",
      "created_at" : "2014-11-04T14:15:53Z",
      "diff_hunk" : "@@ -204,21 +204,42 @@ bool RecvLine(SOCKET hSocket, string& strLine)\n     }\n }\n \n-// used when scores of local addresses may have changed\n-// pushes better local address to peers\n-void static AdvertizeLocal()\n+int GetnScore(const CService& addr)\n {\n-    LOCK(cs_vNodes);\n-    BOOST_FOREACH(CNode* pnode, vNodes)\n+    LOCK(cs_mapLocalHost);\n+    if (mapLocalHost.count(addr) == 0)\n+        return 0;\n+    return mapLocalHost[addr].nScore;\n+}\n+\n+// Is our peer's addrLocal potentially useful as an external IP source?\n+bool IsPeerAddrLocalGood(CNode *pnode)\n+{\n+    return fDiscover && pnode->addr.IsRoutable() && pnode->addrLocal.IsRoutable() &&\n+           GetListenPort() == Params().GetDefaultPort() &&\n+           !IsLimited(pnode->addrLocal.GetNetwork());\n+}\n+\n+// pushes our own address to a peer\n+void AdvertizeLocal(CNode *pnode)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19804117",
      "id" : 19804117,
      "original_commit_id" : "bf0f14f1c995cf7815ccb52cea3d9d9e7b35d74f",
      "original_position" : 26,
      "path" : "src/net.cpp",
      "position" : 48,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161",
      "updated_at" : "2014-11-07T20:14:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/19804117",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19823321"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/19823321"
         }
      },
      "body" : "If proxy is set complex things are happening with your networking and discovery is much more likely not useful.\r\n\r\nDefaulting to discover false would break listening for every host behind NAT by default, precisely those users who are least likely to set things right.\r\n\r\nAvoiding it when proxy is set helps minimize unwanted surprises without gratitious breakage (afer all, we already disabling listening in that case).",
      "commit_id" : "845c86d128fb97d55d125e63653def38729bd2ed",
      "created_at" : "2014-11-04T18:21:33Z",
      "diff_hunk" : "@@ -568,6 +568,9 @@ bool AppInit2(boost::thread_group& threadGroup)\n         // to protect privacy, do not listen by default if a default proxy server is specified\n         if (SoftSetBoolArg(\"-listen\", false))\n             LogPrintf(\"AppInit2 : parameter interaction: -proxy set -> setting -listen=0\\n\");\n+        // to protect privacy, do not discover addresses by default\n+        if (SoftSetBoolArg(\"-discover\", false))\n+            LogPrintf(\"AppInit2 : parameter interaction: -proxy set -> setting -discover=0\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19823321",
      "id" : 19823321,
      "original_commit_id" : "bf0f14f1c995cf7815ccb52cea3d9d9e7b35d74f",
      "original_position" : 6,
      "path" : "src/init.cpp",
      "position" : 6,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161",
      "updated_at" : "2014-11-07T20:14:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/19823321",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19823564"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/19823564"
         }
      },
      "body" : "It's not misspelled. advertize is EN_US and that was the name previously.",
      "commit_id" : "845c86d128fb97d55d125e63653def38729bd2ed",
      "created_at" : "2014-11-04T18:24:54Z",
      "diff_hunk" : "@@ -204,21 +204,42 @@ bool RecvLine(SOCKET hSocket, string& strLine)\n     }\n }\n \n-// used when scores of local addresses may have changed\n-// pushes better local address to peers\n-void static AdvertizeLocal()\n+int GetnScore(const CService& addr)\n {\n-    LOCK(cs_vNodes);\n-    BOOST_FOREACH(CNode* pnode, vNodes)\n+    LOCK(cs_mapLocalHost);\n+    if (mapLocalHost.count(addr) == 0)\n+        return 0;\n+    return mapLocalHost[addr].nScore;\n+}\n+\n+// Is our peer's addrLocal potentially useful as an external IP source?\n+bool IsPeerAddrLocalGood(CNode *pnode)\n+{\n+    return fDiscover && pnode->addr.IsRoutable() && pnode->addrLocal.IsRoutable() &&\n+           GetListenPort() == Params().GetDefaultPort() &&\n+           !IsLimited(pnode->addrLocal.GetNetwork());\n+}\n+\n+// pushes our own address to a peer\n+void AdvertizeLocal(CNode *pnode)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19823564",
      "id" : 19823564,
      "original_commit_id" : "bf0f14f1c995cf7815ccb52cea3d9d9e7b35d74f",
      "original_position" : 26,
      "path" : "src/net.cpp",
      "position" : 48,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161",
      "updated_at" : "2014-11-07T20:14:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/19823564",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19825117"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/19825117"
         }
      },
      "body" : "Hm. Originally I'd had more complex logic; skipping it if it didn't successfully broadcast but that interacted poorly with Addrknown clearing, okay, fair enough it can indeed be simplified now.",
      "commit_id" : "845c86d128fb97d55d125e63653def38729bd2ed",
      "created_at" : "2014-11-04T18:46:22Z",
      "diff_hunk" : "@@ -4346,24 +4354,22 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n         static int64_t nLastRebroadcast;\n         if (!IsInitialBlockDownload() && (GetTime() - nLastRebroadcast > 24 * 60 * 60))\n         {\n+            bool rebroadcastRun = false;\n             {\n                 LOCK(cs_vNodes);\n                 BOOST_FOREACH(CNode* pnode, vNodes)\n                 {\n+                    rebroadcastRun = true;\n                     // Periodically clear setAddrKnown to allow refresh broadcasts\n                     if (nLastRebroadcast)\n                         pnode->setAddrKnown.clear();\n \n                     // Rebroadcast our address\n-                    if (fListen)\n-                    {\n-                        CAddress addr = GetLocalAddress(&pnode->addr);\n-                        if (addr.IsRoutable())\n-                            pnode->PushAddress(addr);\n-                    }\n+                    AdvertizeLocal(pnode);\n                 }\n             }\n-            nLastRebroadcast = GetTime();\n+            if (rebroadcastRun)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19825117",
      "id" : 19825117,
      "original_commit_id" : "bf0f14f1c995cf7815ccb52cea3d9d9e7b35d74f",
      "original_position" : 67,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161",
      "updated_at" : "2014-11-07T20:14:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/19825117",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19825459"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/19825459"
         }
      },
      "body" : "This cuts both ways, e.g. extra fields you didn't want kept. But I agree thats better, changed.",
      "commit_id" : "845c86d128fb97d55d125e63653def38729bd2ed",
      "created_at" : "2014-11-04T18:50:59Z",
      "diff_hunk" : "@@ -3483,7 +3483,13 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n             {\n                 CAddress addr = GetLocalAddress(&pfrom->addr);\n                 if (addr.IsRoutable())\n+                {\n+                    pfrom->PushAddress(addr);\n+                } else if (IsPeerAddrLocalGood(pfrom)) {\n+                    addr = CAddress(pfrom->addrLocal);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19825459",
      "id" : 19825459,
      "original_commit_id" : "9eee4d8b4c952ed182e3c7571205a269663d87f9",
      "original_position" : 33,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161",
      "updated_at" : "2014-11-07T20:14:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/19825459",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "@luke-jr updated",
      "created_at" : "2014-11-04T18:51:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#issuecomment-61692994",
      "id" : 61692994,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5161",
      "updated_at" : "2014-11-04T18:51:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/61692994",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19826071"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/19826071"
         }
      },
      "body" : "Weird, I've never seen it spelled with a 'z' even in EN_US, but it appears Google agrees.",
      "commit_id" : "845c86d128fb97d55d125e63653def38729bd2ed",
      "created_at" : "2014-11-04T18:58:52Z",
      "diff_hunk" : "@@ -204,21 +204,42 @@ bool RecvLine(SOCKET hSocket, string& strLine)\n     }\n }\n \n-// used when scores of local addresses may have changed\n-// pushes better local address to peers\n-void static AdvertizeLocal()\n+int GetnScore(const CService& addr)\n {\n-    LOCK(cs_vNodes);\n-    BOOST_FOREACH(CNode* pnode, vNodes)\n+    LOCK(cs_mapLocalHost);\n+    if (mapLocalHost.count(addr) == 0)\n+        return 0;\n+    return mapLocalHost[addr].nScore;\n+}\n+\n+// Is our peer's addrLocal potentially useful as an external IP source?\n+bool IsPeerAddrLocalGood(CNode *pnode)\n+{\n+    return fDiscover && pnode->addr.IsRoutable() && pnode->addrLocal.IsRoutable() &&\n+           GetListenPort() == Params().GetDefaultPort() &&\n+           !IsLimited(pnode->addrLocal.GetNetwork());\n+}\n+\n+// pushes our own address to a peer\n+void AdvertizeLocal(CNode *pnode)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19826071",
      "id" : 19826071,
      "original_commit_id" : "bf0f14f1c995cf7815ccb52cea3d9d9e7b35d74f",
      "original_position" : 26,
      "path" : "src/net.cpp",
      "position" : 48,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161",
      "updated_at" : "2014-11-07T20:14:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/19826071",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "body" : "```\r\n-----BEGIN PGP SIGNED MESSAGE-----\r\nHash: SHA256\r\n\r\nACK commit 5fd28b94e57d14f81bc63717c99e3e7ca7316b75 : Looked over the code, without fully understanding the logic behind it, and tested that the correct external IP does get advertised properly in an IPv4-only behind-NAT-without-UPnP scenario.\r\n-----BEGIN PGP SIGNATURE-----\r\nVersion: GnuPG v2\r\n\r\niQQcBAEBCAAGBQJUWTUnAAoJEL0ClCQh9IifY1wf/R8eYEiWbT4/WbhgpnD1BuKR\r\n2r5GuMoSsTFe5opSJSIl7zpwviY4sdD+itZ7UiDlAjqbXdFeJ5MtmzY5gQA9KoXL\r\nkeWmcsv9hxg7zf2/OntPScMb4X44JtgaQiUZ9DtRpBLT6ZsSIE0BzKO+YYNEYt4K\r\nfAvapwJd++qHbiCEfTBY3Bap4P93A8xyEM/zpfs9Fd805rLj4qzULG4a6Xl+i4s3\r\ndjkKKpTweTiX/auO21loimzzFPLeQ/Vdypd4U3in2MQ7ylSgW81QI0wsoga9BlO4\r\n+RQDRxB7lRa1prqWGg5uQx61M+7kaq93HI18b1MmcWf34XwQ3rdLz/jjuRaawLNt\r\n46mPTfvnyXPlLTxyvP4fOOPUT+JomjcOj2dYqR7iKUQL4S1bYSsPKiDsZOE7XlAt\r\nopAcdSqpU2Zg746cTDb/xREWsgXT5Je0lxhTfTdT1bx9eQHBum23wS2KvTs/UXEn\r\nELNGQ/NfXfSlJIIxxUTBCMRDeBWYU5ycATMg1ABayITbJiCaM5RtyaRduhUdNKJk\r\nxWO7uzz/HbbuIfVOGYJ4mV/x16NFkGQ0ysfZlzBwrxzxxqlzblhcwpY8B8zyx356\r\ncnYKrvR7v20XQHfy1drW4RI7NjMlSIjD7mpSAILyYmEEBi56X+MLV7RjaT1kzuSs\r\nTimyVqekC4H+/afzaKlHpxtok9Tj8C0RMI/JySCtzeKetl3emO9b9C+iYivgdhH8\r\nvH4nYJZKYDjMzGiB1RzMitSE95lV7jDVohAJoGVahSqjMMHWluhx7Or0qJfzQFwz\r\n2FaFnFliHFoo6Mz1fxYS6JuBJ3ZbQ6aSWTg5oTx4LKJQ4YYL/X9OfEZX+ROz1z7q\r\nGaqu6NWN01oNIcdCKI2c0mTGzPdVwOLlbXHMby4DQhBphPEkCEoHfLAGFqY/p8Oz\r\nbkeRXK2IAkrCviVaQXyzCNQygv7q0k9ryDO9DGYQFr4WN2CDhJ0Aawba7enOm2GG\r\nlliUH4vYSm0ZKSeJcuqC2KFyvEpgMjvK/jFySJdj0ji1t98S8CR8bxM4GVrKNjD7\r\nNB6JzGI9QoLevFEe0YcTTz2eVdNZftiqBXyC1fw8c+7o+gBrG+wXKpfWNxGGb+Gu\r\ntjH8zq0EHV04A6gOj+WGvezshvGynfmYQTpHSL8lUrgcr+aoV1RoCww2fBSr1GgV\r\n/vS4DV5LOGxqCAwWWRxiy7x7V1e2na9sBP3oMVdoW2pWajjeFfe7iZRCctM/rt2E\r\n4AZgRh5sgrnJb+o+88EyKRzAkQ1yuj2s2ncIlwRzKEmGZFF6HwMQCWYMy9TaAqzr\r\nYlt8v3AovtokW9tTgkPseGXLWwWtpajerq0VpVojPgF6vxlQ4lA4YY/0JpffXrc=\r\n=Ee+E\r\n-----END PGP SIGNATURE-----\r\n```",
      "created_at" : "2014-11-04T20:21:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#issuecomment-61707412",
      "id" : 61707412,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5161",
      "updated_at" : "2014-11-04T20:21:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/61707412",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "body" : "```\r\n-----BEGIN PGP SIGNED MESSAGE-----\r\nHash: SHA512\r\n\r\nTested ACK 5fd28b94e57d14f81bc63717c99e3e7ca7316b75\r\nI've tested w/ a host behind NAT, upnp=0, discover=1, it advertizes the right IP\r\nAlso tested with discover=0 and no externalip, no advertizing of local addresses happens (as expected)\r\nReviewed the code and the logic makes sense to me\r\n-----BEGIN PGP SIGNATURE-----\r\nVersion: GnuPG v1\r\n\r\niQEcBAEBCgAGBQJUWfrPAAoJEHSBCwEjRsmm0pYH/3BcQvSe93wEyh0AgRnjyQVy\r\nW2qoTeC9orNA6sr709S1xOmgjKbAEgPDXScqAdDnYkYWuL4CuXEjn6lrQ+O/5Vl5\r\nAM9DG6jlrTz7RVkbXt1knPsWNTs7nHAwZWFHWeq2XwrPdQH5QG//EJys8wb6DJ2O\r\n0AsXpqer/GbHOUGusye4tCQSL+kNSD10fMfG581VVXMVzgjc1zMsDm386N5qPjWJ\r\nPMoD7fmqZe5xDiMa2tJZ0tXcNSl10/Iz4jNwO7zZaNQMDDs131YWLcc7Cz7LVTVG\r\nz51kBFy8Wt25+1qhLsjsRs4gmMTxaKuu/6XL0dUtaGwxSDf2Iz2YQ9bPjJaQx50=\r\n=UWK5\r\n-----END PGP SIGNATURE-----\r\n```",
      "created_at" : "2014-11-05T10:25:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#issuecomment-61787009",
      "id" : 61787009,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5161",
      "updated_at" : "2014-11-05T10:25:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/61787009",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Does anyone feel this is waiting on anything else?",
      "created_at" : "2014-11-07T16:45:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#issuecomment-62173258",
      "id" : 62173258,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5161",
      "updated_at" : "2014-11-07T16:45:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/62173258",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r20024028"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/20024028"
         }
      },
      "body" : "Why would the address a peer tells us be not good if we're running on a non-standard port?",
      "commit_id" : "845c86d128fb97d55d125e63653def38729bd2ed",
      "created_at" : "2014-11-07T17:29:59Z",
      "diff_hunk" : "@@ -205,21 +208,39 @@ bool RecvLine(SOCKET hSocket, string& strLine)\n     }\n }\n \n-// used when scores of local addresses may have changed\n-// pushes better local address to peers\n-void static AdvertizeLocal()\n+int GetnScore(const CService& addr)\n {\n-    LOCK(cs_vNodes);\n-    BOOST_FOREACH(CNode* pnode, vNodes)\n+    LOCK(cs_mapLocalHost);\n+    if (mapLocalHost.count(addr) == 0)\n+        return 0;\n+    return mapLocalHost[addr].nScore;\n+}\n+\n+// Is our peer's addrLocal potentially useful as an external IP source?\n+bool IsPeerAddrLocalGood(CNode *pnode)\n+{\n+    return fDiscover && pnode->addr.IsRoutable() && pnode->addrLocal.IsRoutable() &&\n+           GetListenPort() == Params().GetDefaultPort() &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r20024028",
      "id" : 20024028,
      "original_commit_id" : "5fd28b94e57d14f81bc63717c99e3e7ca7316b75",
      "original_position" : 44,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161",
      "updated_at" : "2014-11-07T20:14:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/20024028",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r20024063"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/20024063"
         }
      },
      "body" : "This probably runs much more than needed. Would it make sense to move it into the above if block?",
      "commit_id" : "845c86d128fb97d55d125e63653def38729bd2ed",
      "created_at" : "2014-11-07T17:30:37Z",
      "diff_hunk" : "@@ -4371,24 +4376,18 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n         static int64_t nLastRebroadcast;\n         if (!IsInitialBlockDownload() && (GetTime() - nLastRebroadcast > 24 * 60 * 60))\n         {\n+            LOCK(cs_vNodes);\n+            BOOST_FOREACH(CNode* pnode, vNodes)\n             {\n-                LOCK(cs_vNodes);\n-                BOOST_FOREACH(CNode* pnode, vNodes)\n-                {\n-                    // Periodically clear setAddrKnown to allow refresh broadcasts\n-                    if (nLastRebroadcast)\n-                        pnode->setAddrKnown.clear();\n+                // Periodically clear setAddrKnown to allow refresh broadcasts\n+                if (nLastRebroadcast)\n+                    pnode->setAddrKnown.clear();\n \n-                    // Rebroadcast our address\n-                    if (fListen)\n-                    {\n-                        CAddress addr = GetLocalAddress(&pnode->addr);\n-                        if (addr.IsRoutable())\n-                            pnode->PushAddress(addr);\n-                    }\n-                }\n+                // Rebroadcast our address\n+                AdvertizeLocal(pnode);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r20024063",
      "id" : 20024063,
      "original_commit_id" : "5fd28b94e57d14f81bc63717c99e3e7ca7316b75",
      "original_position" : 65,
      "path" : "src/main.cpp",
      "position" : 65,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161",
      "updated_at" : "2014-11-07T20:14:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/20024063",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r20024145"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/20024145"
         }
      },
      "body" : "Use LOCAL_NONE constant instead?",
      "commit_id" : "845c86d128fb97d55d125e63653def38729bd2ed",
      "created_at" : "2014-11-07T17:31:48Z",
      "diff_hunk" : "@@ -205,21 +208,39 @@ bool RecvLine(SOCKET hSocket, string& strLine)\n     }\n }\n \n-// used when scores of local addresses may have changed\n-// pushes better local address to peers\n-void static AdvertizeLocal()\n+int GetnScore(const CService& addr)\n {\n-    LOCK(cs_vNodes);\n-    BOOST_FOREACH(CNode* pnode, vNodes)\n+    LOCK(cs_mapLocalHost);\n+    if (mapLocalHost.count(addr) == 0)\n+        return 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r20024145",
      "id" : 20024145,
      "original_commit_id" : "5fd28b94e57d14f81bc63717c99e3e7ca7316b75",
      "original_position" : 36,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161",
      "updated_at" : "2014-11-07T20:14:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/20024145",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r20024250"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/20024250"
         }
      },
      "body" : "Coding style nit: a few more spaces please? (I actually misread the > as a -> initially)",
      "commit_id" : "845c86d128fb97d55d125e63653def38729bd2ed",
      "created_at" : "2014-11-07T17:33:36Z",
      "diff_hunk" : "@@ -205,21 +208,39 @@ bool RecvLine(SOCKET hSocket, string& strLine)\n     }\n }\n \n-// used when scores of local addresses may have changed\n-// pushes better local address to peers\n-void static AdvertizeLocal()\n+int GetnScore(const CService& addr)\n {\n-    LOCK(cs_vNodes);\n-    BOOST_FOREACH(CNode* pnode, vNodes)\n+    LOCK(cs_mapLocalHost);\n+    if (mapLocalHost.count(addr) == 0)\n+        return 0;\n+    return mapLocalHost[addr].nScore;\n+}\n+\n+// Is our peer's addrLocal potentially useful as an external IP source?\n+bool IsPeerAddrLocalGood(CNode *pnode)\n+{\n+    return fDiscover && pnode->addr.IsRoutable() && pnode->addrLocal.IsRoutable() &&\n+           GetListenPort() == Params().GetDefaultPort() &&\n+           !IsLimited(pnode->addrLocal.GetNetwork());\n+}\n+\n+// pushes our own address to a peer\n+void AdvertizeLocal(CNode *pnode)\n+{\n+    if (fListen && pnode->fSuccessfullyConnected)\n     {\n-        if (pnode->fSuccessfullyConnected)\n+        CAddress addrLocal = GetLocalAddress(&pnode->addr);\n+        // If discovery is enabled, sometimes give our peer the address it\n+        // tells us that it sees us as in case it has a better idea of our\n+        // address than we do.\n+        if (IsPeerAddrLocalGood(pnode) && (!addrLocal.IsRoutable() ||\n+             GetRand(GetnScore(addrLocal)>LOCAL_MANUAL?8:2) == 0))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r20024250",
      "id" : 20024250,
      "original_commit_id" : "5fd28b94e57d14f81bc63717c99e3e7ca7316b75",
      "original_position" : 59,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161",
      "updated_at" : "2014-11-07T20:14:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/20024250",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "utACK, with a few nits.",
      "created_at" : "2014-11-07T17:34:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#issuecomment-62182327",
      "id" : 62182327,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5161",
      "updated_at" : "2014-11-07T17:34:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/62182327",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r20032191"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/20032191"
         }
      },
      "body" : "The peer can't tell us anything about the port we're listning on, (E.g. you connect out to some peer and they see the source _port_ as some random number).... we're already behind address translation. Seemed more conservative to skip in this case.",
      "commit_id" : "845c86d128fb97d55d125e63653def38729bd2ed",
      "created_at" : "2014-11-07T19:42:10Z",
      "diff_hunk" : "@@ -205,21 +208,39 @@ bool RecvLine(SOCKET hSocket, string& strLine)\n     }\n }\n \n-// used when scores of local addresses may have changed\n-// pushes better local address to peers\n-void static AdvertizeLocal()\n+int GetnScore(const CService& addr)\n {\n-    LOCK(cs_vNodes);\n-    BOOST_FOREACH(CNode* pnode, vNodes)\n+    LOCK(cs_mapLocalHost);\n+    if (mapLocalHost.count(addr) == 0)\n+        return 0;\n+    return mapLocalHost[addr].nScore;\n+}\n+\n+// Is our peer's addrLocal potentially useful as an external IP source?\n+bool IsPeerAddrLocalGood(CNode *pnode)\n+{\n+    return fDiscover && pnode->addr.IsRoutable() && pnode->addrLocal.IsRoutable() &&\n+           GetListenPort() == Params().GetDefaultPort() &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r20032191",
      "id" : 20032191,
      "original_commit_id" : "5fd28b94e57d14f81bc63717c99e3e7ca7316b75",
      "original_position" : 44,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161",
      "updated_at" : "2014-11-07T20:14:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/20032191",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r20032690"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/20032690"
         }
      },
      "body" : "The prior if is always true except the first time through, we do actually want this to fire the first time through. I think? the test that keeps it from running all the time is two blocks up (on the line with the initialblockdownload check).",
      "commit_id" : "845c86d128fb97d55d125e63653def38729bd2ed",
      "created_at" : "2014-11-07T19:49:58Z",
      "diff_hunk" : "@@ -4371,24 +4376,18 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n         static int64_t nLastRebroadcast;\n         if (!IsInitialBlockDownload() && (GetTime() - nLastRebroadcast > 24 * 60 * 60))\n         {\n+            LOCK(cs_vNodes);\n+            BOOST_FOREACH(CNode* pnode, vNodes)\n             {\n-                LOCK(cs_vNodes);\n-                BOOST_FOREACH(CNode* pnode, vNodes)\n-                {\n-                    // Periodically clear setAddrKnown to allow refresh broadcasts\n-                    if (nLastRebroadcast)\n-                        pnode->setAddrKnown.clear();\n+                // Periodically clear setAddrKnown to allow refresh broadcasts\n+                if (nLastRebroadcast)\n+                    pnode->setAddrKnown.clear();\n \n-                    // Rebroadcast our address\n-                    if (fListen)\n-                    {\n-                        CAddress addr = GetLocalAddress(&pnode->addr);\n-                        if (addr.IsRoutable())\n-                            pnode->PushAddress(addr);\n-                    }\n-                }\n+                // Rebroadcast our address\n+                AdvertizeLocal(pnode);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r20032690",
      "id" : 20032690,
      "original_commit_id" : "5fd28b94e57d14f81bc63717c99e3e7ca7316b75",
      "original_position" : 65,
      "path" : "src/main.cpp",
      "position" : 65,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161",
      "updated_at" : "2014-11-07T20:14:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/20032690",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "@sipa  adjusted except for the nLastRebroadcast.  I think you were misreading it there. Can you confirm?\r\n\r\nOn the disabling it when using a non-default port, any of the other ACKers have an opinion?  I think it could go either way. Avoiding running it seemed more conservative to me, but there are cases where if we require the default port it would fail to discover an address that would be useful... when you're behind nat on a non-standard port and managed to map the ports 1:1, and where the old discovery code would have worked. So I've changed it.",
      "created_at" : "2014-11-07T20:15:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#issuecomment-62205211",
      "id" : 62205211,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5161",
      "updated_at" : "2014-11-07T20:15:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/62205211",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r20051653"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/20051653"
         }
      },
      "body" : "After this change do we ever advertize our Tor hidden service address? I've added logging to my test node that listens both on Tor and plainnet, both external addresses appear as SeenLocal\r\n```\r\n2014-11-08 12:56:48 SeenLocal: xx.xx.xx.xx:8333\r\n2014-11-08 12:57:05 SeenLocal: xxx.onion:8333\r\n```\r\nHowever, it always advertizes the IPv4 address\r\n```\r\n2014-11-08 09:15:21 AdvertizeLocal: advertizing address xx.xx.xx.xx:8333\r\n```\r\n(maybe this can be avoided using discover=0, and providing externalips, but I explicitly disabled those to test this code)",
      "commit_id" : "845c86d128fb97d55d125e63653def38729bd2ed",
      "created_at" : "2014-11-08T13:23:25Z",
      "diff_hunk" : "@@ -204,21 +204,42 @@ bool RecvLine(SOCKET hSocket, string& strLine)\n     }\n }\n \n-// used when scores of local addresses may have changed\n-// pushes better local address to peers\n-void static AdvertizeLocal()\n+int GetnScore(const CService& addr)\n {\n-    LOCK(cs_vNodes);\n-    BOOST_FOREACH(CNode* pnode, vNodes)\n+    LOCK(cs_mapLocalHost);\n+    if (mapLocalHost.count(addr) == 0)\n+        return 0;\n+    return mapLocalHost[addr].nScore;\n+}\n+\n+// Is our peer's addrLocal potentially useful as an external IP source?\n+bool IsPeerAddrLocalGood(CNode *pnode)\n+{\n+    return fDiscover && pnode->addr.IsRoutable() && pnode->addrLocal.IsRoutable() &&\n+           GetListenPort() == Params().GetDefaultPort() &&\n+           !IsLimited(pnode->addrLocal.GetNetwork());\n+}\n+\n+// pushes our own address to a peer\n+void AdvertizeLocal(CNode *pnode)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r20051653",
      "id" : 20051653,
      "original_commit_id" : "bf0f14f1c995cf7815ccb52cea3d9d9e7b35d74f",
      "original_position" : 26,
      "path" : "src/net.cpp",
      "position" : 48,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161",
      "updated_at" : "2014-11-08T13:23:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/20051653",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r20051775"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/20051775"
         }
      },
      "body" : "ok",
      "commit_id" : "845c86d128fb97d55d125e63653def38729bd2ed",
      "created_at" : "2014-11-08T13:54:41Z",
      "diff_hunk" : "@@ -4371,24 +4376,18 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n         static int64_t nLastRebroadcast;\n         if (!IsInitialBlockDownload() && (GetTime() - nLastRebroadcast > 24 * 60 * 60))\n         {\n+            LOCK(cs_vNodes);\n+            BOOST_FOREACH(CNode* pnode, vNodes)\n             {\n-                LOCK(cs_vNodes);\n-                BOOST_FOREACH(CNode* pnode, vNodes)\n-                {\n-                    // Periodically clear setAddrKnown to allow refresh broadcasts\n-                    if (nLastRebroadcast)\n-                        pnode->setAddrKnown.clear();\n+                // Periodically clear setAddrKnown to allow refresh broadcasts\n+                if (nLastRebroadcast)\n+                    pnode->setAddrKnown.clear();\n \n-                    // Rebroadcast our address\n-                    if (fListen)\n-                    {\n-                        CAddress addr = GetLocalAddress(&pnode->addr);\n-                        if (addr.IsRoutable())\n-                            pnode->PushAddress(addr);\n-                    }\n-                }\n+                // Rebroadcast our address\n+                AdvertizeLocal(pnode);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r20051775",
      "id" : 20051775,
      "original_commit_id" : "5fd28b94e57d14f81bc63717c99e3e7ca7316b75",
      "original_position" : 65,
      "path" : "src/main.cpp",
      "position" : 65,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161",
      "updated_at" : "2014-11-08T13:54:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/20051775",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r20053219"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/20053219"
         }
      },
      "body" : "The resason you're seen-localing it is becasue peers who already know it are connecting inbound to you.  Since outbound HS peers can never seen your HS address it can't be discovered, and must be configured with externalips.",
      "commit_id" : "845c86d128fb97d55d125e63653def38729bd2ed",
      "created_at" : "2014-11-08T18:21:49Z",
      "diff_hunk" : "@@ -204,21 +204,42 @@ bool RecvLine(SOCKET hSocket, string& strLine)\n     }\n }\n \n-// used when scores of local addresses may have changed\n-// pushes better local address to peers\n-void static AdvertizeLocal()\n+int GetnScore(const CService& addr)\n {\n-    LOCK(cs_vNodes);\n-    BOOST_FOREACH(CNode* pnode, vNodes)\n+    LOCK(cs_mapLocalHost);\n+    if (mapLocalHost.count(addr) == 0)\n+        return 0;\n+    return mapLocalHost[addr].nScore;\n+}\n+\n+// Is our peer's addrLocal potentially useful as an external IP source?\n+bool IsPeerAddrLocalGood(CNode *pnode)\n+{\n+    return fDiscover && pnode->addr.IsRoutable() && pnode->addrLocal.IsRoutable() &&\n+           GetListenPort() == Params().GetDefaultPort() &&\n+           !IsLimited(pnode->addrLocal.GetNetwork());\n+}\n+\n+// pushes our own address to a peer\n+void AdvertizeLocal(CNode *pnode)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r20053219",
      "id" : 20053219,
      "original_commit_id" : "bf0f14f1c995cf7815ccb52cea3d9d9e7b35d74f",
      "original_position" : 26,
      "path" : "src/net.cpp",
      "position" : 48,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161",
      "updated_at" : "2014-11-08T18:21:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/20053219",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r20088383"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/20088383"
         }
      },
      "body" : "OK - so when providing externalips, it will advertise the HS address?",
      "commit_id" : "845c86d128fb97d55d125e63653def38729bd2ed",
      "created_at" : "2014-11-10T15:34:31Z",
      "diff_hunk" : "@@ -204,21 +204,42 @@ bool RecvLine(SOCKET hSocket, string& strLine)\n     }\n }\n \n-// used when scores of local addresses may have changed\n-// pushes better local address to peers\n-void static AdvertizeLocal()\n+int GetnScore(const CService& addr)\n {\n-    LOCK(cs_vNodes);\n-    BOOST_FOREACH(CNode* pnode, vNodes)\n+    LOCK(cs_mapLocalHost);\n+    if (mapLocalHost.count(addr) == 0)\n+        return 0;\n+    return mapLocalHost[addr].nScore;\n+}\n+\n+// Is our peer's addrLocal potentially useful as an external IP source?\n+bool IsPeerAddrLocalGood(CNode *pnode)\n+{\n+    return fDiscover && pnode->addr.IsRoutable() && pnode->addrLocal.IsRoutable() &&\n+           GetListenPort() == Params().GetDefaultPort() &&\n+           !IsLimited(pnode->addrLocal.GetNetwork());\n+}\n+\n+// pushes our own address to a peer\n+void AdvertizeLocal(CNode *pnode)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r20088383",
      "id" : 20088383,
      "original_commit_id" : "bf0f14f1c995cf7815ccb52cea3d9d9e7b35d74f",
      "original_position" : 26,
      "path" : "src/net.cpp",
      "position" : 48,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161",
      "updated_at" : "2014-11-10T15:34:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/20088383",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r20096085"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/20096085"
         }
      },
      "body" : "Yes; for two reasons: one is because externalips disables discover, the other is because if you enable discover it still mosty uses the traditional address source (what it would have used if discover were distabled) if it has one that it thinks is routable.",
      "commit_id" : "845c86d128fb97d55d125e63653def38729bd2ed",
      "created_at" : "2014-11-10T17:12:51Z",
      "diff_hunk" : "@@ -204,21 +204,42 @@ bool RecvLine(SOCKET hSocket, string& strLine)\n     }\n }\n \n-// used when scores of local addresses may have changed\n-// pushes better local address to peers\n-void static AdvertizeLocal()\n+int GetnScore(const CService& addr)\n {\n-    LOCK(cs_vNodes);\n-    BOOST_FOREACH(CNode* pnode, vNodes)\n+    LOCK(cs_mapLocalHost);\n+    if (mapLocalHost.count(addr) == 0)\n+        return 0;\n+    return mapLocalHost[addr].nScore;\n+}\n+\n+// Is our peer's addrLocal potentially useful as an external IP source?\n+bool IsPeerAddrLocalGood(CNode *pnode)\n+{\n+    return fDiscover && pnode->addr.IsRoutable() && pnode->addrLocal.IsRoutable() &&\n+           GetListenPort() == Params().GetDefaultPort() &&\n+           !IsLimited(pnode->addrLocal.GetNetwork());\n+}\n+\n+// pushes our own address to a peer\n+void AdvertizeLocal(CNode *pnode)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#discussion_r20096085",
      "id" : 20096085,
      "original_commit_id" : "bf0f14f1c995cf7815ccb52cea3d9d9e7b35d74f",
      "original_position" : 26,
      "path" : "src/net.cpp",
      "position" : 48,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5161",
      "updated_at" : "2014-11-10T17:12:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/20096085",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "@gmaxwell I'd say it's still useful to be able to discover external IP changes even if not using the default port. Throughout the code, bitcoind assumes that it knows the port where it's listening on.\r\n\r\nThe edge case here would be a) behind NAT b) manually forwarded port c) external port is different from internal port. But in that case `bitcoind` has no way of discovering what the external port is for advertising, so this code won't make a difference. I don't think we can handle that case at all right now (even `-externalip` can't take a port).\r\n",
      "created_at" : "2014-11-11T06:31:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#issuecomment-62507903",
      "id" : 62507903,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5161",
      "updated_at" : "2014-11-11T06:33:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/62507903",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "@laanwj Okay, great. (I did change it so that it doesn't require the default port anymore).",
      "created_at" : "2014-11-11T09:10:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5161#issuecomment-62520318",
      "id" : 62520318,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5161",
      "updated_at" : "2014-11-11T09:10:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/62520318",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   }
]
