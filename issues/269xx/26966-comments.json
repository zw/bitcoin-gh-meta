[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/26966).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [w0xlt](https://github.com/bitcoin/bitcoin/pull/26966#pullrequestreview-1275543891), [TheCharlatan](https://github.com/bitcoin/bitcoin/pull/26966#pullrequestreview-1749211886) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#28983](https://github.com/bitcoin/bitcoin/pull/28983) (Stratum v2 Template Provider (take 2) by Sjors)\n* [#28956](https://github.com/bitcoin/bitcoin/pull/28956) (Nuke adjusted time (attempt 2) by dergoegge)\n* [#28955](https://github.com/bitcoin/bitcoin/pull/28955) (index: block filters sync, reduce disk read operations by caching last header by furszy)\n* [#28051](https://github.com/bitcoin/bitcoin/pull/28051) (Get rid of shutdown.cpp/shutdown.h, use SignalInterrupt directly by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-01-25T13:36:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#issuecomment-1403631860",
      "id" : 1403631860,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26966",
      "node_id" : "IC_kwDOABII585Tqbj0",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1403631860/reactions"
      },
      "updated_at" : "2023-12-05T05:05:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1403631860",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Cool, will take it for a spin...",
      "created_at" : "2023-01-26T14:38:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#issuecomment-1405102999",
      "id" : 1405102999,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26966",
      "node_id" : "IC_kwDOABII585TwCuX",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1405102999/reactions"
      },
      "updated_at" : "2023-01-26T14:38:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1405102999",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Cool @Sjors, just pushed a small update. Found a little bug.\r\n\r\nGoing to add an important note to the PR description (because otherwise testing results will vary a lot):\r\n\r\nAs the access to the block data on disk is protected by `cs_main`, this new feature runs substantially\r\nfaster when the node is not in IBD.\r\n(where \"substantially\" here means full index sync, with 5 workers, in less than 20 minutes in my computer).",
      "created_at" : "2023-01-28T15:18:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#issuecomment-1407420783",
      "id" : 1407420783,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26966",
      "node_id" : "IC_kwDOABII585T44lv",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1407420783/reactions"
      },
      "updated_at" : "2023-01-28T15:18:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1407420783",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> It's probably much easier suggested than done, but did you attempt to implement parallelization in a more general way so that other indices could benefit from it as well?\r\n\r\nYeah, that is part of the plan. I started with the block filter index because it requires an special treatment that `txindex` parallelization does not require (block/undo data reading and block filters creation can be parallelized but writing must be done sequentially due the need to link filter headers to their predecessors to create the filters-chain on disk).\r\n\r\nMy idea was to start reviewing this one, so the process gets as clean as possible, and then move forward with the generalization step. It's usually more natural to abstract processes when the specific cases are well-defined.",
      "created_at" : "2023-01-30T13:37:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#issuecomment-1408645764",
      "id" : 1408645764,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26966",
      "node_id" : "IC_kwDOABII585T9jqE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1408645764/reactions"
      },
      "updated_at" : "2023-01-30T13:37:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1408645764",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Building the index on (AMD Ryzen 7950X, blocks stored on SSD):\r\n* master @ fe86616bb4ad0c4296d34299bc2e2f0fca1fe936: 35'15\" (mostly 1 alternating CPU thread)\r\n* this PR (rebased)\r\n  * n=8: 5'20\" (uses about 8 of 32 CPU threads as expected)\r\n  * n=32: 4'26\" (pleasantly close to 100% CPU usage with a dip every 10 seconds, but it drops to only 1 CPU in the last minute or two)\r\n  \r\nI made sure to not load any wallets and disabled other indexes.\r\n\r\nI didn't test if the index was correct.\r\n\r\nI wonder if, for users without this index, it would be faster to generate the index, rescan the wallet and then delete it again. Combined with #26951 you would only have to generate filters up to the age of the wallet (IIUC, cc @pstratem).\r\n\r\nNote to self for future benchmarks: `-txindex` takes 1:07'14\", `-coinstatsindex` takes 3.5 hours.",
      "created_at" : "2023-02-07T13:47:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#issuecomment-1420800151",
      "id" : 1420800151,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26966",
      "node_id" : "IC_kwDOABII585Ur7CX",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 1,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1420800151/reactions"
      },
      "updated_at" : "2023-02-07T18:47:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1420800151",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Great results @Sjors!.\r\n\r\nCould also give it a run rebased on top #27006.\r\nOn master, the index initial sync is slower when the node is in IBD because the index thread has to compete for access to block data on disk through `cs_main` acquisition.\r\n\r\n> I didn't test if the index was correct.\r\n\r\nThe PR contain a test verifying it.\r\n\r\n----------------------------------------------\r\n\r\nSide note:\r\nI'm working on generalizing the parallelization flow so other indexes, like the txindex and #26951 can make use of it too.",
      "created_at" : "2023-02-07T14:18:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#issuecomment-1420850865",
      "id" : 1420850865,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26966",
      "node_id" : "IC_kwDOABII585UsHax",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1420850865/reactions"
      },
      "updated_at" : "2023-02-07T14:27:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1420850865",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-02-17T23:32:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#issuecomment-1435394565",
      "id" : 1435394565,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26966",
      "node_id" : "IC_kwDOABII585VjmIF",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1435394565/reactions"
      },
      "updated_at" : "2023-02-17T23:32:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1435394565",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "PR updated, most of it implementation has changed.\r\n\r\nThe news are:\r\n1) Decreased ThreadSync `cs_main` lock contention.\r\n2) Removed `CBlockIndex` access from the child indexes internals.\r\n3) Implemented generic workers pool.\r\n4) Introduced a last header cache for the Block Filter index. Avoiding disk reads on every new processed block.\r\n5) Enabled parallel sync on the tx index.\r\n\r\nImportant Note:\r\nThe introduced workers pool spawned by the `-indexworkers` init arg is shared among all the enabled indexes that support parallel sync.\r\n\r\nThe implementation uses `std::any` mainly to simplify the patch-set, the base class template form of it requires a larger set of changes.\r\n\r\nSide note: in a first glance and without going too far over the coinstats index implementation, I would say that it could also be parallelized. But will leave it for a follow-up to not continue expanding the PR size.\r\n\r\nFuture (doesn't need to be included here, just mentioning so the path is clear):\r\nI'm working on decoupling the initial sync logic into a separate structure, so indexes subscribe to events instead of reading blocks from disk by themselves.",
      "created_at" : "2023-02-28T12:40:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#issuecomment-1448113513",
      "id" : 1448113513,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26966",
      "node_id" : "IC_kwDOABII585WUHVp",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1448113513/reactions"
      },
      "updated_at" : "2023-02-28T12:40:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1448113513",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-05-11T10:29:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#issuecomment-1543743831",
      "id" : 1543743831,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26966",
      "node_id" : "IC_kwDOABII585cA6lX",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1543743831/reactions"
      },
      "updated_at" : "2023-05-11T10:29:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1543743831",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-06-30T11:24:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#issuecomment-1614516340",
      "id" : 1614516340,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26966",
      "node_id" : "IC_kwDOABII585gO5B0",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1614516340/reactions"
      },
      "updated_at" : "2023-06-30T11:24:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1614516340",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-07-06T22:10:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#issuecomment-1624375049",
      "id" : 1624375049,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26966",
      "node_id" : "IC_kwDOABII585g0f8J",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1624375049/reactions"
      },
      "updated_at" : "2023-07-06T22:10:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1624375049",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Could mark as draft while CI is red?",
      "created_at" : "2023-09-04T20:34:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#issuecomment-1705682424",
      "id" : 1705682424,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26966",
      "node_id" : "IC_kwDOABII585lqqX4",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1705682424/reactions"
      },
      "updated_at" : "2023-09-04T20:34:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1705682424",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "It looks like tsan failed, but there is no log, when there should be a log. Maybe it was accidentally removed by https://github.com/bitcoin/bitcoin/pull/27667 ?",
      "created_at" : "2023-09-06T05:47:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#issuecomment-1707706393",
      "id" : 1707706393,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26966",
      "node_id" : "IC_kwDOABII585lyYgZ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1707706393/reactions"
      },
      "updated_at" : "2023-09-06T05:47:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1707706393",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-09-12T10:33:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#issuecomment-1715469618",
      "id" : 1715469618,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26966",
      "node_id" : "IC_kwDOABII585mP_0y",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1715469618/reactions"
      },
      "updated_at" : "2023-09-12T10:33:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1715469618",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-10-02T21:55:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#issuecomment-1743825774",
      "id" : 1743825774,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26966",
      "node_id" : "IC_kwDOABII585n8Ktu",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1743825774/reactions"
      },
      "updated_at" : "2023-10-02T21:55:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1743825774",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "CI is still red. Also, how would this work with AU?",
      "created_at" : "2023-10-25T09:16:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#issuecomment-1778849023",
      "id" : 1778849023,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26966",
      "node_id" : "IC_kwDOABII585qBxT_",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1778849023/reactions"
      },
      "updated_at" : "2023-10-25T09:16:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1778849023",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Could also give it a run rebased on top #27006.\r\n\r\nThat PR currently does not cleanly cherry-pick on top of this PR, not can I (trivially) rebase this PR on top top of it. Happy to try if you can make a branch.\r\n\r\nI just tried it again, deleting the blockfilterindex and rebuilding it. My impression is that it's going slower than before and I'm not seeing much CPU activity.\r\n\r\nI also noticed the shutdown takes a very long time, with the indexer (?) threads sticking around for many minutes:\r\n\r\n<img width=\"760\" alt=\"SchermÂ­afbeelding 2023-11-07 om 21 16 24\" src=\"https://github.com/bitcoin/bitcoin/assets/10217/909e8257-44e9-4c9c-8744-1876a9c41a9b\">\r\n",
      "created_at" : "2023-11-07T11:09:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#issuecomment-1798294413",
      "id" : 1798294413,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26966",
      "node_id" : "IC_kwDOABII585rL8uN",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1798294413/reactions"
      },
      "updated_at" : "2023-11-07T12:18:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1798294413",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26966#discussion_r1404328365"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26966"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1404328365"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "NIt: Might take this opportunity to add the <uint256.h> header?",
      "commit_id" : "373b0bb077296624b7aeb5108673ae8f8b00b20d",
      "created_at" : "2023-11-24T12:58:03Z",
      "diff_hunk" : "@@ -42,6 +42,9 @@ class BlockFilterIndex final : public BaseIndex\n     /** cache of block hash to filter header, to avoid disk access when responding to getcfcheckpt. */\n     std::unordered_map<uint256, uint256, FilterHeaderHasher> m_headers_cache GUARDED_BY(m_cs_headers_cache);\n \n+    // Last computed header to avoid disk reads at every new block.\n+    uint256 last_header{};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#discussion_r1404328365",
      "id" : 1404328365,
      "line" : 46,
      "node_id" : "PRRC_kwDOABII585TtFmt",
      "original_commit_id" : "003f076a150c1237e4b9b212265d4665a32dcb5c",
      "original_line" : 46,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.h",
      "position" : 5,
      "pull_request_review_id" : 1747911419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26966",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1404328365/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-25T12:53:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1404328365",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26966#discussion_r1404459012"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26966"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1404459012"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "NIt: `// In case it hasn't been stoppped.`",
      "commit_id" : "373b0bb077296624b7aeb5108673ae8f8b00b20d",
      "created_at" : "2023-11-24T15:18:11Z",
      "diff_hunk" : "@@ -0,0 +1,124 @@\n+// Copyright (c) 2023-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or https://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_THREADPOOL_H\n+#define BITCOIN_UTIL_THREADPOOL_H\n+\n+#include <sync.h>\n+#include <util/string.h>\n+#include <util/threadnames.h>\n+\n+#include <condition_variable>\n+#include <future>\n+#include <queue>\n+#include <thread>\n+\n+class ThreadPool {\n+\n+private:\n+    Mutex cs_work_queue;\n+    std::queue<std::function<void()>> m_work_queue GUARDED_BY(cs_work_queue);\n+    std::condition_variable m_condition;\n+    // Stop indicator\n+    std::atomic<bool> m_stop{false};\n+    // Worker threads\n+    std::vector<std::thread> m_workers;\n+\n+    void WorkerThread(const std::string& thread_name) EXCLUSIVE_LOCKS_REQUIRED(!cs_work_queue)\n+    {\n+        util::ThreadRename(std::string{thread_name});\n+        WAIT_LOCK(cs_work_queue, wait_lock);\n+        while (!m_stop.load()) {\n+            std::function<void()> task;\n+            {\n+                // Wait for the task or until the stop flag is set\n+                m_condition.wait(wait_lock,[&]() EXCLUSIVE_LOCKS_REQUIRED(cs_work_queue) { return m_stop.load() || !m_work_queue.empty(); });\n+\n+                // If stopped, exit worker.\n+                if (m_stop.load() && m_work_queue.empty()) {\n+                    return;\n+                }\n+\n+                // Pop the task\n+                task = std::move(m_work_queue.front());\n+                m_work_queue.pop();\n+            }\n+\n+            // Execute the task without the lock\n+            WITH_REVERSE_LOCK(wait_lock, task());\n+        }\n+    }\n+\n+public:\n+    ThreadPool() {}\n+\n+    ~ThreadPool()\n+    {\n+        Stop(); // In case it hasn't being stopped.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#discussion_r1404459012",
      "id" : 1404459012,
      "line" : 58,
      "node_id" : "PRRC_kwDOABII585TtlgE",
      "original_commit_id" : "46e74257f22ea35f21b522c5b01c8cc99e4d5482",
      "original_line" : 58,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "src/util/threadpool.h",
      "position" : 58,
      "pull_request_review_id" : 1747911419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26966",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1404459012/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-25T12:53:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1404459012",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26966#discussion_r1404460151"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26966"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1404460151"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Nit: Adjust copyright date.",
      "commit_id" : "373b0bb077296624b7aeb5108673ae8f8b00b20d",
      "created_at" : "2023-11-24T15:19:04Z",
      "diff_hunk" : "@@ -0,0 +1,158 @@\n+// Copyright (c) 2012-2022 The Bitcoin Core developers",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#discussion_r1404460151",
      "id" : 1404460151,
      "line" : 1,
      "node_id" : "PRRC_kwDOABII585Ttlx3",
      "original_commit_id" : "46e74257f22ea35f21b522c5b01c8cc99e4d5482",
      "original_line" : 1,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/test/threadpool_tests.cpp",
      "position" : 1,
      "pull_request_review_id" : 1747911419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26966",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1404460151/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-25T12:53:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1404460151",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26966#discussion_r1404471253"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26966"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1404471253"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If I run IWYU locally, it reports the following headers as missing:\r\n```\r\n#include <cstddef>            // for size_t\r\n#include <algorithm>           // for max\r\n#include <atomic>              // for atomic\r\n#include <functional>          // for function\r\n#include <memory>              // for make_shared\r\n#include <stdexcept>           // for runtime_error\r\n#include <utility>             // for move, swap\r\n#include <vector>              // for vector\r\n```",
      "commit_id" : "373b0bb077296624b7aeb5108673ae8f8b00b20d",
      "created_at" : "2023-11-24T15:32:09Z",
      "diff_hunk" : "@@ -0,0 +1,124 @@\n+// Copyright (c) 2023-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or https://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_THREADPOOL_H\n+#define BITCOIN_UTIL_THREADPOOL_H\n+\n+#include <sync.h>\n+#include <util/string.h>\n+#include <util/threadnames.h>\n+\n+#include <condition_variable>\n+#include <future>\n+#include <queue>\n+#include <thread>\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#discussion_r1404471253",
      "id" : 1404471253,
      "line" : 16,
      "node_id" : "PRRC_kwDOABII585TtofV",
      "original_commit_id" : "46e74257f22ea35f21b522c5b01c8cc99e4d5482",
      "original_line" : 16,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/util/threadpool.h",
      "position" : 16,
      "pull_request_review_id" : 1747911419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26966",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1404471253/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-25T12:53:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1404471253",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26966#discussion_r1404663869"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26966"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1404663869"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Just a comment: It would be nice if we could re-use the `CThreadInterrupt` interface here, but I don't think it's easily possible.",
      "commit_id" : "373b0bb077296624b7aeb5108673ae8f8b00b20d",
      "created_at" : "2023-11-24T22:37:07Z",
      "diff_hunk" : "@@ -0,0 +1,124 @@\n+// Copyright (c) 2023-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or https://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_THREADPOOL_H\n+#define BITCOIN_UTIL_THREADPOOL_H\n+\n+#include <sync.h>\n+#include <util/string.h>\n+#include <util/threadnames.h>\n+\n+#include <condition_variable>\n+#include <future>\n+#include <queue>\n+#include <thread>\n+\n+class ThreadPool {\n+\n+private:\n+    Mutex cs_work_queue;\n+    std::queue<std::function<void()>> m_work_queue GUARDED_BY(cs_work_queue);\n+    std::condition_variable m_condition;\n+    // Stop indicator\n+    std::atomic<bool> m_stop{false};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#discussion_r1404663869",
      "id" : 1404663869,
      "line" : 24,
      "node_id" : "PRRC_kwDOABII585TuXg9",
      "original_commit_id" : "46e74257f22ea35f21b522c5b01c8cc99e4d5482",
      "original_line" : 24,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/util/threadpool.h",
      "position" : 24,
      "pull_request_review_id" : 1747911419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26966",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1404663869/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-25T12:53:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1404663869",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26966#discussion_r1404664671"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26966"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1404664671"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why is this added?",
      "commit_id" : "373b0bb077296624b7aeb5108673ae8f8b00b20d",
      "created_at" : "2023-11-24T22:41:50Z",
      "diff_hunk" : "@@ -0,0 +1,124 @@\n+// Copyright (c) 2023-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or https://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_THREADPOOL_H\n+#define BITCOIN_UTIL_THREADPOOL_H\n+\n+#include <sync.h>\n+#include <util/string.h>\n+#include <util/threadnames.h>\n+\n+#include <condition_variable>\n+#include <future>\n+#include <queue>\n+#include <thread>\n+\n+class ThreadPool {\n+\n+private:\n+    Mutex cs_work_queue;\n+    std::queue<std::function<void()>> m_work_queue GUARDED_BY(cs_work_queue);\n+    std::condition_variable m_condition;\n+    // Stop indicator\n+    std::atomic<bool> m_stop{false};\n+    // Worker threads\n+    std::vector<std::thread> m_workers;\n+\n+    void WorkerThread(const std::string& thread_name) EXCLUSIVE_LOCKS_REQUIRED(!cs_work_queue)\n+    {\n+        util::ThreadRename(std::string{thread_name});\n+        WAIT_LOCK(cs_work_queue, wait_lock);\n+        while (!m_stop.load()) {\n+            std::function<void()> task;\n+            {\n+                // Wait for the task or until the stop flag is set\n+                m_condition.wait(wait_lock,[&]() EXCLUSIVE_LOCKS_REQUIRED(cs_work_queue) { return m_stop.load() || !m_work_queue.empty(); });\n+\n+                // If stopped, exit worker.\n+                if (m_stop.load() && m_work_queue.empty()) {\n+                    return;\n+                }\n+\n+                // Pop the task\n+                task = std::move(m_work_queue.front());\n+                m_work_queue.pop();\n+            }\n+\n+            // Execute the task without the lock\n+            WITH_REVERSE_LOCK(wait_lock, task());\n+        }\n+    }\n+\n+public:\n+    ThreadPool() {}\n+\n+    ~ThreadPool()\n+    {\n+        Stop(); // In case it hasn't being stopped.\n+    }\n+\n+    void Start(int num_workers)\n+    {\n+        if (!m_workers.empty()) throw std::runtime_error(\"Thread pool already started\");\n+\n+        // Create the workers\n+        for (int i=0; i<num_workers; i++) {\n+            m_workers.emplace_back(&ThreadPool::WorkerThread, this, \"threadpool_worker_\" + ToString(i));\n+        }\n+    }\n+\n+    void Stop()\n+    {\n+        // Notify workers and join them.\n+        m_stop = true;\n+        m_condition.notify_all();\n+        for (auto& worker : m_workers) {\n+            worker.join();\n+        }\n+        m_workers.clear();\n+        m_stop = false;\n+    }\n+\n+    template<class T> EXCLUSIVE_LOCKS_REQUIRED(!cs_work_queue)\n+    auto Submit(T task) -> std::future<decltype(task())>\n+    {\n+        auto ptr_task = std::make_shared<std::packaged_task<decltype(task()) ()>>(std::move(task));\n+        std::future<decltype(task())> future = ptr_task->get_future();\n+        {\n+            LOCK(cs_work_queue);\n+            m_work_queue.emplace([=]() {\n+                (*ptr_task)();\n+            });\n+        }\n+        m_condition.notify_one();\n+        return future;\n+    }\n+\n+    // Synchronous processing\n+    void ProcessTask() EXCLUSIVE_LOCKS_REQUIRED(!cs_work_queue)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#discussion_r1404664671",
      "id" : 1404664671,
      "line" : 99,
      "node_id" : "PRRC_kwDOABII585TuXtf",
      "original_commit_id" : "46e74257f22ea35f21b522c5b01c8cc99e4d5482",
      "original_line" : 99,
      "original_position" : 99,
      "original_start_line" : null,
      "path" : "src/util/threadpool.h",
      "position" : 99,
      "pull_request_review_id" : 1747911419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26966",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1404664671/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-25T12:53:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1404664671",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26966#discussion_r1404871876"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26966"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1404871876"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't think it would be necessary for the tasks themselves, since you already demonstrate in the tests how to retrieve exceptions, but I think some kind of exception handling and infomation logging similar to the one of `util::TraceThread` would still be nice. Did you choose not to use `TraceThread` on purpose?",
      "commit_id" : "373b0bb077296624b7aeb5108673ae8f8b00b20d",
      "created_at" : "2023-11-25T12:37:05Z",
      "diff_hunk" : "@@ -0,0 +1,124 @@\n+// Copyright (c) 2023-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or https://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_THREADPOOL_H\n+#define BITCOIN_UTIL_THREADPOOL_H\n+\n+#include <sync.h>\n+#include <util/string.h>\n+#include <util/threadnames.h>\n+\n+#include <condition_variable>\n+#include <future>\n+#include <queue>\n+#include <thread>\n+\n+class ThreadPool {\n+\n+private:\n+    Mutex cs_work_queue;\n+    std::queue<std::function<void()>> m_work_queue GUARDED_BY(cs_work_queue);\n+    std::condition_variable m_condition;\n+    // Stop indicator\n+    std::atomic<bool> m_stop{false};\n+    // Worker threads\n+    std::vector<std::thread> m_workers;\n+\n+    void WorkerThread(const std::string& thread_name) EXCLUSIVE_LOCKS_REQUIRED(!cs_work_queue)\n+    {\n+        util::ThreadRename(std::string{thread_name});\n+        WAIT_LOCK(cs_work_queue, wait_lock);\n+        while (!m_stop.load()) {\n+            std::function<void()> task;\n+            {\n+                // Wait for the task or until the stop flag is set\n+                m_condition.wait(wait_lock,[&]() EXCLUSIVE_LOCKS_REQUIRED(cs_work_queue) { return m_stop.load() || !m_work_queue.empty(); });\n+\n+                // If stopped, exit worker.\n+                if (m_stop.load() && m_work_queue.empty()) {\n+                    return;\n+                }\n+\n+                // Pop the task\n+                task = std::move(m_work_queue.front());\n+                m_work_queue.pop();\n+            }\n+\n+            // Execute the task without the lock\n+            WITH_REVERSE_LOCK(wait_lock, task());\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#discussion_r1404871876",
      "id" : 1404871876,
      "line" : 50,
      "node_id" : "PRRC_kwDOABII585TvKTE",
      "original_commit_id" : "46e74257f22ea35f21b522c5b01c8cc99e4d5482",
      "original_line" : 50,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/util/threadpool.h",
      "position" : 50,
      "pull_request_review_id" : 1747911419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26966",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1404871876/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-25T12:53:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1404871876",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26966#discussion_r1404873978"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26966"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1404873978"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Could use this test to stress test the pool a bit with more tasks?",
      "commit_id" : "373b0bb077296624b7aeb5108673ae8f8b00b20d",
      "created_at" : "2023-11-25T12:44:25Z",
      "diff_hunk" : "@@ -0,0 +1,158 @@\n+// Copyright (c) 2012-2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <util/threadpool.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_AUTO_TEST_SUITE(threadpool_tests)\n+\n+BOOST_AUTO_TEST_CASE(threadpool_basic)\n+{\n+    // Test Cases\n+    // 1) Submit tasks and verify completion.\n+    // 2) Maintain all threads busy except one.\n+    // 3) Wait for work to finish.\n+    // 4) Wait for result object.\n+    // 5) The task throws an exception, catch must be done in the consumer side.\n+    // 6) Busy workers, help them by processing tasks from outside.\n+\n+    // Test case 1, submit tasks and verify completion.\n+    {\n+        int num_workers = 3;\n+        int num_tasks = 50;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#discussion_r1404873978",
      "id" : 1404873978,
      "line" : 24,
      "node_id" : "PRRC_kwDOABII585TvKz6",
      "original_commit_id" : "46e74257f22ea35f21b522c5b01c8cc99e4d5482",
      "original_line" : 24,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/test/threadpool_tests.cpp",
      "position" : 24,
      "pull_request_review_id" : 1747911419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26966",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1404873978/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-25T12:53:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1404873978",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26966#discussion_r1404874302"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26966"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1404874302"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think a test where each task is assigned slightly different data would be nice. Something like:\r\n```c++\r\n+        std::atomic<int> par_sum{0};\r\n+        for (int i = 0; i < num_tasks; i++) {\r\n+            threadPool.Submit([&par_sum,i]() {\r\n+                par_sum += i;\r\n             });\r\n         }\r\n+        int sync_sum{0};\r\n+        for (int i = 0; i < num_tasks; i++) {\r\n+            sync_sum += i;\r\n+        }\r\n```",
      "commit_id" : "373b0bb077296624b7aeb5108673ae8f8b00b20d",
      "created_at" : "2023-11-25T12:45:50Z",
      "diff_hunk" : "@@ -0,0 +1,158 @@\n+// Copyright (c) 2012-2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <util/threadpool.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_AUTO_TEST_SUITE(threadpool_tests)\n+\n+BOOST_AUTO_TEST_CASE(threadpool_basic)\n+{\n+    // Test Cases\n+    // 1) Submit tasks and verify completion.\n+    // 2) Maintain all threads busy except one.\n+    // 3) Wait for work to finish.\n+    // 4) Wait for result object.\n+    // 5) The task throws an exception, catch must be done in the consumer side.\n+    // 6) Busy workers, help them by processing tasks from outside.\n+\n+    // Test case 1, submit tasks and verify completion.\n+    {\n+        int num_workers = 3;\n+        int num_tasks = 50;\n+\n+        ThreadPool threadPool;\n+        threadPool.Start(num_workers);\n+        std::atomic<int> counter = 0;\n+        for (int i=0; i<num_tasks; i++) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#discussion_r1404874302",
      "id" : 1404874302,
      "line" : 29,
      "node_id" : "PRRC_kwDOABII585TvK4-",
      "original_commit_id" : "46e74257f22ea35f21b522c5b01c8cc99e4d5482",
      "original_line" : 29,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/test/threadpool_tests.cpp",
      "position" : 29,
      "pull_request_review_id" : 1747911419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26966",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1404874302/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-25T12:53:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1404874302",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "This all looks pretty promising. I left some feedback before continuing with the latter half of the PR.",
      "created_at" : "2023-11-25T12:54:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#issuecomment-1826301507",
      "id" : 1826301507,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26966",
      "node_id" : "IC_kwDOABII585s2yZD",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1826301507/reactions"
      },
      "updated_at" : "2023-11-25T12:54:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1826301507",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26966#discussion_r1405161198"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26966"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1405161198"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`static constexpr int16_t INDEX_WORKERS_COUNT{0}` (and similarly below)?",
      "commit_id" : "373b0bb077296624b7aeb5108673ae8f8b00b20d",
      "created_at" : "2023-11-25T16:22:29Z",
      "diff_hunk" : "@@ -16,13 +16,17 @@ class CBlock;\n class CBlockIndex;\n class Chainstate;\n class ChainstateManager;\n+class ThreadPool;\n namespace interfaces {\n class Chain;\n } // namespace interfaces\n namespace Consensus {\n     struct Params;\n }\n \n+/** Number of concurrent jobs during the initial sync process */\n+const int16_t INDEX_WORKERS_COUNT = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#discussion_r1405161198",
      "id" : 1405161198,
      "line" : 29,
      "node_id" : "PRRC_kwDOABII585TwQ7u",
      "original_commit_id" : "7b2d4d471ae251d4c22184dda26b73993a65eff8",
      "original_line" : 28,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/index/base.h",
      "position" : 20,
      "pull_request_review_id" : 1749211886,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26966",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1405161198/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-25T23:01:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1405161198",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26966#discussion_r1405168955"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26966"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1405168955"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit 7b2d4d471ae251d4c22184dda26b73993a65eff8: Could the `AllowParallelSync` method be moved to this commit?",
      "commit_id" : "373b0bb077296624b7aeb5108673ae8f8b00b20d",
      "created_at" : "2023-11-25T16:46:03Z",
      "diff_hunk" : "@@ -1966,7 +1970,21 @@ bool StartIndexBackgroundSync(NodeContext& node)\n         }\n     }\n \n+    std::shared_ptr<ThreadPool> thread_pool;\n+    if (node.args->IsArgSet(\"-indexworkers\")) {\n+        int index_workers = node.args->GetIntArg(\"-indexworkers\", INDEX_WORKERS_COUNT);\n+        if (index_workers < 0 || index_workers > 100) return InitError(_(\"Invalid -indexworkers arg\"));\n+\n+        thread_pool = std::make_shared<ThreadPool>();\n+        thread_pool->Start(index_workers);\n+    }\n+\n     // Start threads\n-    for (auto index : node.indexes) if (!index->StartBackgroundSync()) return false;\n+    for (auto index : node.indexes) {\n+        // todo: Only provide thread pool to indexes that supports parallel sync",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#discussion_r1405168955",
      "id" : 1405168955,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585TwS07",
      "original_commit_id" : "7b2d4d471ae251d4c22184dda26b73993a65eff8",
      "original_line" : 1984,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 1749211886,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26966",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1405168955/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-25T23:01:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1405168955",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26966#discussion_r1405180029"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26966"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1405180029"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Make `max_blocks_to_sync`, `tip_height`, and `remaining_blocks` `const`.",
      "commit_id" : "373b0bb077296624b7aeb5108673ae8f8b00b20d",
      "created_at" : "2023-11-25T17:25:51Z",
      "diff_hunk" : "@@ -205,9 +217,53 @@ void BaseIndex::ThreadSync()\n                            __func__, GetName());\n                 return;\n             }\n-            pindex = pindex_next;\n \n+            // By default, parallel sync disabled\n+            int work_chunk = 1;\n+            int workers_count = 0;\n+            std::vector<std::future<std::vector<std::any>>> futures;\n+            const CBlockIndex* it_start = pindex_next;\n+\n+            if (parallel_sync_enabled) {\n+                int max_blocks_to_sync = m_tasks_per_worker * m_thread_pool->WorkersCount() + m_tasks_per_worker; // extra 'm_tasks_per_worker' due the active-wait.\n+                int tip_height = WITH_LOCK(cs_main, return m_chainstate->m_chain.Height());\n+                int remaining_blocks = tip_height - pindex_next->nHeight;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#discussion_r1405180029",
      "id" : 1405180029,
      "line" : 230,
      "node_id" : "PRRC_kwDOABII585TwVh9",
      "original_commit_id" : "727be9d500c081309042c256dc02166acb6d4774",
      "original_line" : 230,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 113,
      "pull_request_review_id" : 1749211886,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26966",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1405180029/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-25T23:01:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1405180029",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26966#discussion_r1405180661"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26966"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1405180661"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Nitty nit: Keep the order of `workers_count` and `work_chunk` consistent?",
      "commit_id" : "373b0bb077296624b7aeb5108673ae8f8b00b20d",
      "created_at" : "2023-11-25T17:28:24Z",
      "diff_hunk" : "@@ -205,9 +217,53 @@ void BaseIndex::ThreadSync()\n                            __func__, GetName());\n                 return;\n             }\n-            pindex = pindex_next;\n \n+            // By default, parallel sync disabled\n+            int work_chunk = 1;\n+            int workers_count = 0;\n+            std::vector<std::future<std::vector<std::any>>> futures;\n+            const CBlockIndex* it_start = pindex_next;\n+\n+            if (parallel_sync_enabled) {\n+                int max_blocks_to_sync = m_tasks_per_worker * m_thread_pool->WorkersCount() + m_tasks_per_worker; // extra 'm_tasks_per_worker' due the active-wait.\n+                int tip_height = WITH_LOCK(cs_main, return m_chainstate->m_chain.Height());\n+                int remaining_blocks = tip_height - pindex_next->nHeight;\n+                work_chunk = remaining_blocks > max_blocks_to_sync ? m_tasks_per_worker : remaining_blocks / (m_thread_pool->WorkersCount() + 1);\n+                workers_count = m_thread_pool->WorkersCount();\n+                if (work_chunk == 0) { // disable parallel sync if we are close to the tip\n+                    workers_count = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#discussion_r1405180661",
      "id" : 1405180661,
      "line" : 234,
      "node_id" : "PRRC_kwDOABII585TwVr1",
      "original_commit_id" : "727be9d500c081309042c256dc02166acb6d4774",
      "original_line" : 234,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 117,
      "pull_request_review_id" : 1749211886,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26966",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1405180661/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-25T23:01:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1405180661",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26966#discussion_r1405250581"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26966"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1405250581"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Would `so we also process blocks in this thread until all workers finish.` be more accurate?",
      "commit_id" : "373b0bb077296624b7aeb5108673ae8f8b00b20d",
      "created_at" : "2023-11-25T22:38:59Z",
      "diff_hunk" : "@@ -205,9 +217,53 @@ void BaseIndex::ThreadSync()\n                            __func__, GetName());\n                 return;\n             }\n-            pindex = pindex_next;\n \n+            // By default, parallel sync disabled\n+            int work_chunk = 1;\n+            int workers_count = 0;\n+            std::vector<std::future<std::vector<std::any>>> futures;\n+            const CBlockIndex* it_start = pindex_next;\n+\n+            if (parallel_sync_enabled) {\n+                int max_blocks_to_sync = m_tasks_per_worker * m_thread_pool->WorkersCount() + m_tasks_per_worker; // extra 'm_tasks_per_worker' due the active-wait.\n+                int tip_height = WITH_LOCK(cs_main, return m_chainstate->m_chain.Height());\n+                int remaining_blocks = tip_height - pindex_next->nHeight;\n+                work_chunk = remaining_blocks > max_blocks_to_sync ? m_tasks_per_worker : remaining_blocks / (m_thread_pool->WorkersCount() + 1);\n+                workers_count = m_thread_pool->WorkersCount();\n+                if (work_chunk == 0) { // disable parallel sync if we are close to the tip\n+                    workers_count = 0;\n+                    work_chunk = 1;\n+                }\n+\n+                for (int i = 0; i < workers_count; i++) {\n+                    const CBlockIndex* it_end =  WITH_LOCK(::cs_main, return m_chainstate->m_chain[it_start->nHeight + work_chunk - 1]);\n+                    // Async process\n+                    futures.emplace_back(m_thread_pool->Submit(std::bind(&BaseIndex::ProcessBlocks, this, it_start, it_end)));\n+                    // Update iterator\n+                    it_start = WITH_LOCK(::cs_main, return NextSyncBlock(it_end, m_chainstate->m_chain));\n+                }\n+            }\n \n+            // If we have only one block to process, run it directly.\n+            // Otherwise, this is an active-wait, so we process blocks until all workers finish.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#discussion_r1405250581",
      "id" : 1405250581,
      "line" : 248,
      "node_id" : "PRRC_kwDOABII585TwmwV",
      "original_commit_id" : "727be9d500c081309042c256dc02166acb6d4774",
      "original_line" : 248,
      "original_position" : 84,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 136,
      "pull_request_review_id" : 1749211886,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26966",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1405250581/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-25T23:01:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1405250581",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26966#discussion_r1405253107"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26966"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1405253107"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit de69506c090f530f34d78478db39898bd4e2cbba: I think the test introduction should be squashed into the following commit, or do you want to demonstrate something here first?",
      "commit_id" : "373b0bb077296624b7aeb5108673ae8f8b00b20d",
      "created_at" : "2023-11-25T22:52:11Z",
      "diff_hunk" : "@@ -14,6 +14,7 @@\n #include <test/util/blockfilter.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#discussion_r1405253107",
      "id" : 1405253107,
      "line" : 14,
      "node_id" : "PRRC_kwDOABII585TwnXz",
      "original_commit_id" : "de69506c090f530f34d78478db39898bd4e2cbba",
      "original_line" : 14,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/test/blockfilter_index_tests.cpp",
      "position" : 1,
      "pull_request_review_id" : 1749211886,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26966",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1405253107/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-25T23:01:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1405253107",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26966#discussion_r1405426732"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26966"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1405426732"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Since the constructor and `Start` are always called in succession in this patch set, you could make `ThreadPool` more RAII styled if the `Start` method were removed and instead placed in the constructor. Could also make sense to do the same with the destructor and `Stop`.",
      "commit_id" : "373b0bb077296624b7aeb5108673ae8f8b00b20d",
      "created_at" : "2023-11-26T16:08:46Z",
      "diff_hunk" : "@@ -1966,7 +1970,20 @@ bool StartIndexBackgroundSync(NodeContext& node)\n         }\n     }\n \n+    std::shared_ptr<ThreadPool> thread_pool;\n+    if (node.args->IsArgSet(\"-indexworkers\")) {\n+        int index_workers = node.args->GetIntArg(\"-indexworkers\", INDEX_WORKERS_COUNT);\n+        if (index_workers < 0 || index_workers > 100) return InitError(_(\"Invalid -indexworkers arg\"));\n+\n+        thread_pool = std::make_shared<ThreadPool>();\n+        thread_pool->Start(index_workers);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#discussion_r1405426732",
      "id" : 1405426732,
      "line" : 1979,
      "node_id" : "PRRC_kwDOABII585TxRws",
      "original_commit_id" : "373b0bb077296624b7aeb5108673ae8f8b00b20d",
      "original_line" : 1979,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 35,
      "pull_request_review_id" : 1749369732,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26966",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1405426732/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-26T16:08:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1405426732",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-12-14T21:54:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26966#issuecomment-1856718084",
      "id" : 1856718084,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26966",
      "node_id" : "IC_kwDOABII585uq0UE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1856718084/reactions"
      },
      "updated_at" : "2023-12-14T21:54:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1856718084",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   }
]
