[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "In my testing of #24858, I have not experienced what I think this issue describes. Is this issue stale and closable, or have I misunderstood? For example, in my debug.log, I see the \"initial getheaders\" message in the same second as the \"loadblk thread exit\" and there is no intervening block inv.\r\n\r\n```\r\n2022-04-18T10:26:25Z loadblk thread exit\r\n2022-04-18T10:26:25Z UpdatedBlockTip: new block hash=000000000000453154dc06cf8a4d0caba8247de3999e6501a441dfba0129df33 fork block hash=0000000000000208f44ba18047fddd3aeaed7faf28bd5493609596f9e2a8e1cd (in I\r\nBD=true)\r\n2022-04-18T10:26:25Z BlockConnected: block hash=0000000000001cf475ca2791a37145307500b752d7ea8d57d513a4d77cf7c7eb block height=119962\r\n2022-04-18T10:26:25Z UpdatedBlockTip: new block hash=0000000000001cf475ca2791a37145307500b752d7ea8d57d513a4d77cf7c7eb fork block hash=000000000000453154dc06cf8a4d0caba8247de3999e6501a441dfba0129df33 (in I\r\nBD=true)\r\n2022-04-18T10:26:25Z BlockConnected: block hash=00000000000001a831ab6fbd4fa8c1bb98f1f07f0ceb1c5c1a8a2b4c8b567e8b block height=119963\r\n2022-04-18T10:26:25Z UpdatedBlockTip: new block hash=00000000000001a831ab6fbd4fa8c1bb98f1f07f0ceb1c5c1a8a2b4c8b567e8b fork block hash=0000000000001cf475ca2791a37145307500b752d7ea8d57d513a4d77cf7c7eb (in I\r\nBD=true)\r\n2022-04-18T10:26:25Z BlockConnected: block hash=00000000000064ac7c1b57c1d3b4fd3a3aeb2f26c96c2dde853eef230a271048 block height=119964\r\n2022-04-18T10:26:25Z UpdatedBlockTip: new block hash=00000000000064ac7c1b57c1d3b4fd3a3aeb2f26c96c2dde853eef230a271048 fork block hash=00000000000001a831ab6fbd4fa8c1bb98f1f07f0ceb1c5c1a8a2b4c8b567e8b (in I\r\nBD=true)\r\n2022-04-18T10:26:25Z initial getheaders (119963) to peer=14 (startheight:732408)\r\n2022-04-18T10:26:25Z sending getheaders (933 bytes) peer=14\r\n2022-04-18T10:26:25Z sending ping (8 bytes) peer=0\r\n2022-04-18T10:26:25Z received: ping (8 bytes) peer=0\r\n2022-04-18T10:26:25Z sending pong (8 bytes) peer=0\r\n2022-04-18T10:26:25Z received: pong (8 bytes) peer=0\r\n2022-04-18T10:26:27Z received: headers (162003 bytes) peer=14\r\n2022-04-18T10:26:27Z Synchronizing blockheaders, height: 121963 (~17.47%)\r\n2022-04-18T10:26:27Z more getheaders (121963) to end to peer=14 (startheight:732408)\r\n2022-04-18T10:26:27Z sending getheaders (933 bytes) peer=14\r\n2022-04-18T10:26:28Z received: headers (162003 bytes) peer=14\r\n2022-04-18T10:26:28Z Synchronizing blockheaders, height: 123963 (~17.74%)\r\n2022-04-18T10:26:28Z more getheaders (123963) to end to peer=14 (startheight:732408)\r\n```",
      "created_at" : "2022-04-18T11:52:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8239#issuecomment-1101341303",
      "id" : 1101341303,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8239",
      "node_id" : "IC_kwDOABII585BpSJ3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1101341303/reactions"
      },
      "updated_at" : "2022-04-18T11:52:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1101341303",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> height=119964\r\n\r\nI haven't looked at this at all, but the sync logic might differ for blocks less heavy than the minimum chain work?",
      "created_at" : "2022-04-18T13:39:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8239#issuecomment-1101416827",
      "id" : 1101416827,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8239",
      "node_id" : "IC_kwDOABII585Bpkl7",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1101416827/reactions"
      },
      "updated_at" : "2022-04-18T13:39:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1101416827",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "It doesn't appear to be as of what's in master right now: https://github.com/bitcoin/bitcoin/blob/master/src/net_processing.cpp#L4672-L4701\r\n\r\nIt is gated by `fImporting` which is released in `ThreadImport` shortly before the log message `loadblk thread exit` is made.\r\nI think this issue is probably stale unless there is something subtle that I am not picking up on.",
      "created_at" : "2022-04-18T14:09:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8239#issuecomment-1101437605",
      "id" : 1101437605,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8239",
      "node_id" : "IC_kwDOABII585Bppql",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1101437605/reactions"
      },
      "updated_at" : "2022-04-18T14:09:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1101437605",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I also seem unable to reproduce this behaviour on master at 7f2019755d, but I didn't check on mainnet with a long chain (and high chain work as suggested by Marco), instead I stopped a regtest node (a) in GDB while it was reindexing and generated new blocks on a second already-connected node (b), before continuing with the reindex.\r\n\r\nThe headers were received on node (a) before the reindex had completed, which then sent `getheaders` and synced to the new tip, without recieving any further block invs:\r\n\r\n<details>\r\n<summary>Details</summary>\r\n\r\n```log\r\n2023-06-05T12:24:02Z loadblk thread start\r\n[Switching to Thread 0x7fffacff96c0 (LWP 505309)]\r\n\r\nThread 23 \"b-loadblk\" hit Breakpoint 1, node::ThreadImport (chainman=..., vImportFiles=std::vector of length 0, capacity 0, mempool_path=...) at node/blockstorage.cpp:880\r\n# reindex blocks up to 240, current tip\r\n...\r\n2023-06-05T12:24:10Z [validation:debug] Saw new header hash=6643009b0170e505bdab690f221ab16dc9544733fe7a049983b9ac8c4d59498b height=237\r\n2023-06-05T12:24:10Z [validation:debug] Saw new header hash=331dd8d6194c44104bcd848251f27a60f97822f461cf15ef0cc1ef87b34a209c height=238\r\n2023-06-05T12:24:10Z [validation:debug] Saw new header hash=2ed8cf4999897a0c99bb4f38b8d365c0901fc9799c3ac4a4eb8ee3d6ce14fc5d height=239\r\n2023-06-05T12:24:10Z [validation:debug] Saw new header hash=55d43ad6e0525a44eac9cfc4492565428c5bca38b626404ac17c1a9ee21511d9 height=240\r\n\r\n# node receives new block inv while reindex in progress\r\n...\r\n2023-06-05T12:26:21Z [net] sending ping (8 bytes) peer=0\r\n2023-06-05T12:26:21Z [lock] Enter: lock contention m_events_mutex, random.cpp:355 started\r\n2023-06-05T12:26:21Z [lock] Enter: lock contention m_events_mutex, random.cpp:355 completed (1Î¼s)\r\n2023-06-05T12:26:21Z [lock] Enter: lock contention m_nodes_mutex, net.cpp:1111 started\r\n2023-06-05T12:26:21Z [lock] Enter: lock contention m_nodes_mutex, net.cpp:1111 completed (1Î¼s)\r\n2023-06-05T12:26:21Z [net] received: ping (8 bytes) peer=0\r\n2023-06-05T12:26:21Z [net] sending pong (8 bytes) peer=0\r\n2023-06-05T12:26:21Z [lock] Enter: lock contention pnode->cs_vSend, net.cpp:1234 started\r\n2023-06-05T12:26:21Z [lock] Enter: lock contention pnode->cs_vSend, net.cpp:1234 completed (6Î¼s)\r\n2023-06-05T12:26:21Z [net] received: inv (37 bytes) peer=0\r\n2023-06-05T12:26:21Z [net] got inv: block 7a57bd5ce9153d85a71240c74b01869a696e921bbafe6bf0a1ef4f06f16694f7  new peer=0\r\n\r\n# reindexing finished\r\n...\r\n2023-06-05T12:26:37Z [leveldb] WriteBatch memory usage: db=index, before=0.0MiB, after=0.0MiB\r\n2023-06-05T12:26:37Z Reindexing finished\r\n\r\n# After reindexing we send `getheaders` and recieve back the new header hash\r\n...\r\n2023-06-05T12:26:37Z loadblk thread exit\r\n...\r\n2023-06-05T12:26:37Z [validation] BlockConnected: block hash=55d43ad6e0525a44eac9cfc4492565428c5bca38b626404ac17c1a9ee21511d9 block height=240\r\n2023-06-05T12:26:37Z [validation] UpdatedBlockTip: new block hash=55d43ad6e0525a44eac9cfc4492565428c5bca38b626404ac17c1a9ee21511d9 fork block hash=2ed8cf4999897a0c99bb4f38b8d365c0901fc9799c3ac4a4eb8ee3d6ce14fc5d (in IBD=true)\r\n2023-06-05T12:26:37Z [net] sending getheaders (645 bytes) peer=0\r\n2023-06-05T12:26:37Z [net] initial getheaders (239) to peer=0 (startheight:240)\r\n2023-06-05T12:26:37Z Leaving InitialBlockDownload (latching to false)\r\n2023-06-05T12:26:37Z [net] sending feefilter (8 bytes) peer=0\r\n2023-06-05T12:26:37Z [net] received: headers (8263 bytes) peer=0\r\n2023-06-05T12:26:37Z Saw new header hash=7a57bd5ce9153d85a71240c74b01869a696e921bbafe6bf0a1ef4f06f16694f7 height=241\r\n\r\n\r\n# request the header & block\r\n...\r\n2023-06-05T12:26:37Z [net] sending sendheaders (0 bytes) peer=0\r\n2023-06-05T12:26:37Z [net] Requesting block 7a57bd5ce9153d85a71240c74b01869a696e921bbafe6bf0a1ef4f06f16694f7 (241) peer=0\r\n\r\n# and connect it\r\n...\r\n2023-06-05T12:26:37Z [net] received block 7a57bd5ce9153d85a71240c74b01869a696e921bbafe6bf0a1ef4f06f16694f7 peer=0\r\n2023-06-05T12:26:37Z [validation] NewPoWValidBlock: block hash=7a57bd5ce9153d85a71240c74b01869a696e921bbafe6bf0a1ef4f06f16694f7\r\n2023-06-05T12:26:37Z [bench]   - Using cached block\r\n2023-06-05T12:26:37Z [bench]   - Load block from disk: 0.02ms\r\n2023-06-05T12:26:37Z [bench]     - Sanity checks: 0.00ms [0.00s (0.01ms/blk)]\r\n2023-06-05T12:26:37Z [bench]     - Fork checks: 0.04ms [0.01s (0.03ms/blk)]\r\n2023-06-05T12:26:37Z [bench]       - Connect 1 transactions: 0.03ms (0.030ms/tx, 0.000ms/txin) [0.01s (0.02ms/blk)]\r\n2023-06-05T12:26:37Z [bench]     - Verify 0 txins: 0.06ms (0.000ms/txin) [0.01s (0.04ms/blk)]\r\n2023-06-05T12:26:37Z [bench]     - Write undo data: 0.04ms [0.01s (0.03ms/blk)]\r\n2023-06-05T12:26:37Z [bench]     - Index writing: 0.01ms [0.00s (0.01ms/blk)]\r\n2023-06-05T12:26:37Z [validation] BlockChecked: block hash=7a57bd5ce9153d85a71240c74b01869a696e921bbafe6bf0a1ef4f06f16694f7 state=Valid\r\n2023-06-05T12:26:37Z [bench]   - Connect total: 0.22ms [0.05s (0.19ms/blk)]\r\n2023-06-05T12:26:37Z [bench]   - Flush: 0.03ms [0.01s (0.03ms/blk)]\r\n2023-06-05T12:26:37Z [bench]   - Writing chainstate: 0.02ms [0.00s (0.02ms/blk)]\r\n2023-06-05T12:26:37Z [estimatefee] Blockpolicy estimates updated by 0 of 0 block txs, since last block 0 of 0 tracked, mempool map size 0, max target 0 from current\r\n2023-06-05T12:26:37Z UpdateTip: new best=7a57bd5ce9153d85a71240c74b01869a696e921bbafe6bf0a1ef4f06f16694f7 height=241 version=0x30000000 log2_work=8.918863 tx=242 date='2023-06-05T12:26:13Z' progress=1.000000 cache=0.3MiB(241txo)\r\n2023-06-05T12:26:37Z [bench]   - Connect postprocess: 0.32ms [0.01s (0.04ms/blk)]\r\n2023-06-05T12:26:37Z [bench] - Connect block: 0.61ms [0.08s (0.31ms/blk)]\r\n2023-06-05T12:26:37Z [mempool] Checking mempool with 0 transactions and 0 inputs\r\n2023-06-05T12:26:37Z [validation] Enqueuing BlockConnected: block hash=7a57bd5ce9153d85a71240c74b01869a696e921bbafe6bf0a1ef4f06f16694f7 block height=241\r\n2023-06-05T12:26:37Z [validation] Enqueuing UpdatedBlockTip: new block hash=7a57bd5ce9153d85a71240c74b01869a696e921bbafe6bf0a1ef4f06f16694f7 fork block hash=55d43ad6e0525a44eac9cfc4492565428c5bca38b626404ac17c1a9ee21511d9 (in IBD=false)\r\n2023-06-05T12:26:37Z [validation] BlockConnected: block hash=7a57bd5ce9153d85a71240c74b01869a696e921bbafe6bf0a1ef4f06f16694f7 block height=241\r\n```\r\n\r\n</details>\r\n\r\nPerhaps this testing method is circumventing the behaviour described in OP, but otherwise it appears that it could only be an issue in the case that no new block is found during the entire `-reindex` process, which seems unlikely?",
      "created_at" : "2023-06-05T14:21:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8239#issuecomment-1576902123",
      "id" : 1576902123,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8239",
      "node_id" : "IC_kwDOABII585d_Z3r",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1576902123/reactions"
      },
      "updated_at" : "2023-06-05T14:21:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1576902123",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   }
]
