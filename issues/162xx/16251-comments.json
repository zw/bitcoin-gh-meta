[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#16798](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16798.html) (Refactor rawtransaction_util's SignTransaction to separate prevtx parsing by achow101)\n* [#16546](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16546.html) ([WIP] External signer support - Wallet Box edition by Sjors)\n* [#16528](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16528.html) ([WIP] Native Descriptor Wallets (take 2) by achow101)\n* [#16341](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16341.html) (Introduce ScriptPubKeyMan interface and use it for key and script management (aka wallet boxes) by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-06-20T12:50:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16251#issuecomment-504012990",
      "id" : 504012990,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16251",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwNDAxMjk5MA==",
      "updated_at" : "2019-09-04T22:56:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/504012990",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "With this patch, partial signature error message looks like:\r\n\r\n    \"error\": \"CHECK(MULTI)SIG failing with non-zero signature (possibly need more signatures)\"\r\n\r\ninstead of:\r\n\r\n    \"error\": \"Signature must be zero for failed CHECK(MULTI)SIG operation\"\r\n\r\nMismatching scripts give a new error of either:\r\n\r\n    error code: -3\r\n    error message:\r\n    redeemScript/witnessScript does not match scriptPubKey\r\n\r\nor\r\n\r\n    error code: -3\r\n    error message:\r\n    redeemScript does not correspond to witnessScript\r\n\r\ninstead of an apparently successful operation (but unchanged rawtx) with embedded error of:\r\n\r\n    \"error\": \"Witness program was passed an empty witness\"\r\n\r\n",
      "created_at" : "2019-06-20T12:51:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16251#issuecomment-504013209",
      "id" : 504013209,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16251",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwNDAxMzIwOQ==",
      "updated_at" : "2019-06-20T12:51:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/504013209",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16251#discussion_r300003466"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16251"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/300003466"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I feel like this has already been merged",
      "commit_id" : "b5e9bd9d6b225ef033d8d9eeed8bd89d0bf0ea6e",
      "created_at" : "2019-07-03T14:55:49Z",
      "diff_hunk" : "@@ -221,6 +221,9 @@ UniValue SignTransaction(CMutableTransaction& mtx, const UniValue& prevTxsUnival\n                     // Automatically also add the P2WSH wrapped version of the script (to deal with P2SH-P2WSH).\n                     keystore->AddCScript(GetScriptForWitness(witnessScript));\n                 }\n+                if (rs.isNull() && ws.isNull()) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"Missing redeemScript/witnessScript\");\n+                }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16251#discussion_r300003466",
      "id" : 300003466,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMDAwMzQ2Ng==",
      "original_commit_id" : "01174596e69568c434198a86f54cb9ea6740e6c2",
      "original_position" : 6,
      "path" : "src/rpc/rawtransaction_util.cpp",
      "position" : 32,
      "pull_request_review_id" : 257546873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16251",
      "updated_at" : "2019-09-07T10:20:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/300003466",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16251#discussion_r300007679"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16251"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/300007679"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, I just rebased it (` ajtowns force-pushed the ajtowns:201906-signrawerror branch from 073a2f8 to f7e4676`) but github's not picking up the new HEAD?",
      "commit_id" : "b5e9bd9d6b225ef033d8d9eeed8bd89d0bf0ea6e",
      "created_at" : "2019-07-03T15:03:23Z",
      "diff_hunk" : "@@ -221,6 +221,9 @@ UniValue SignTransaction(CMutableTransaction& mtx, const UniValue& prevTxsUnival\n                     // Automatically also add the P2WSH wrapped version of the script (to deal with P2SH-P2WSH).\n                     keystore->AddCScript(GetScriptForWitness(witnessScript));\n                 }\n+                if (rs.isNull() && ws.isNull()) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"Missing redeemScript/witnessScript\");\n+                }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16251#discussion_r300007679",
      "id" : 300007679,
      "in_reply_to_id" : 300003466,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMDAwNzY3OQ==",
      "original_commit_id" : "01174596e69568c434198a86f54cb9ea6740e6c2",
      "original_position" : 6,
      "path" : "src/rpc/rawtransaction_util.cpp",
      "position" : 32,
      "pull_request_review_id" : 257552247,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16251",
      "updated_at" : "2019-09-07T10:20:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/300007679",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16251#discussion_r300009913"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16251"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/300009913"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It is well known for GitHub to show outdated branches in the web view (see also https://github.com/bitcoin/bitcoin/issues/15847#issuecomment-484871831)\r\n\r\n\r\nI guess you have to force push twice?",
      "commit_id" : "b5e9bd9d6b225ef033d8d9eeed8bd89d0bf0ea6e",
      "created_at" : "2019-07-03T15:07:22Z",
      "diff_hunk" : "@@ -221,6 +221,9 @@ UniValue SignTransaction(CMutableTransaction& mtx, const UniValue& prevTxsUnival\n                     // Automatically also add the P2WSH wrapped version of the script (to deal with P2SH-P2WSH).\n                     keystore->AddCScript(GetScriptForWitness(witnessScript));\n                 }\n+                if (rs.isNull() && ws.isNull()) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"Missing redeemScript/witnessScript\");\n+                }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16251#discussion_r300009913",
      "id" : 300009913,
      "in_reply_to_id" : 300003466,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMDAwOTkxMw==",
      "original_commit_id" : "01174596e69568c434198a86f54cb9ea6740e6c2",
      "original_position" : 6,
      "path" : "src/rpc/rawtransaction_util.cpp",
      "position" : 32,
      "pull_request_review_id" : 257555008,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16251",
      "updated_at" : "2019-09-07T10:20:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/300009913",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16251#discussion_r300011443"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16251"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/300011443"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Looks like it's doing the right thing now (I pushed a dummy commit and force-pushed it out of existence). You should be seeing f7e4676591c9027a6fe4dd1ebc9e1ed35b27574f as HEAD.",
      "commit_id" : "b5e9bd9d6b225ef033d8d9eeed8bd89d0bf0ea6e",
      "created_at" : "2019-07-03T15:10:10Z",
      "diff_hunk" : "@@ -221,6 +221,9 @@ UniValue SignTransaction(CMutableTransaction& mtx, const UniValue& prevTxsUnival\n                     // Automatically also add the P2WSH wrapped version of the script (to deal with P2SH-P2WSH).\n                     keystore->AddCScript(GetScriptForWitness(witnessScript));\n                 }\n+                if (rs.isNull() && ws.isNull()) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"Missing redeemScript/witnessScript\");\n+                }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16251#discussion_r300011443",
      "id" : 300011443,
      "in_reply_to_id" : 300003466,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMDAxMTQ0Mw==",
      "original_commit_id" : "01174596e69568c434198a86f54cb9ea6740e6c2",
      "original_position" : 6,
      "path" : "src/rpc/rawtransaction_util.cpp",
      "position" : 32,
      "pull_request_review_id" : 257556880,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16251",
      "updated_at" : "2019-09-07T10:20:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/300011443",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK, looks right to me after an initial read",
      "created_at" : "2019-07-30T08:57:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16251#issuecomment-516330802",
      "id" : 516330802,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16251",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxNjMzMDgwMg==",
      "updated_at" : "2019-07-30T08:57:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/516330802",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/3211283?v=4",
         "events_url" : "https://api.github.com/users/meshcollider/events{/privacy}",
         "followers_url" : "https://api.github.com/users/meshcollider/followers",
         "following_url" : "https://api.github.com/users/meshcollider/following{/other_user}",
         "gists_url" : "https://api.github.com/users/meshcollider/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/meshcollider",
         "id" : 3211283,
         "login" : "meshcollider",
         "node_id" : "MDQ6VXNlcjMyMTEyODM=",
         "organizations_url" : "https://api.github.com/users/meshcollider/orgs",
         "received_events_url" : "https://api.github.com/users/meshcollider/received_events",
         "repos_url" : "https://api.github.com/users/meshcollider/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/meshcollider/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/meshcollider/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/meshcollider"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-09-07T01:12:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16251#issuecomment-529058321",
      "id" : 529058321,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16251",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyOTA1ODMyMQ==",
      "updated_at" : "2019-09-07T01:12:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/529058321",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16251#discussion_r322263307"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16251"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/322263307"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: extra newline",
      "commit_id" : "b5e9bd9d6b225ef033d8d9eeed8bd89d0bf0ea6e",
      "created_at" : "2019-09-09T14:10:07Z",
      "diff_hunk" : "@@ -196,32 +196,73 @@ void ParsePrevouts(const UniValue& prevTxsUnival, FillableSigningProvider* keyst\n             }\n \n             // if redeemScript and private keys were given, add redeemScript to the keystore so it can be signed\n-            if (keystore && (scriptPubKey.IsPayToScriptHash() || scriptPubKey.IsPayToWitnessScriptHash())) {\n+            const bool is_p2sh = scriptPubKey.IsPayToScriptHash();\n+            const bool is_p2wsh = scriptPubKey.IsPayToWitnessScriptHash();\n+            if (keystore && (is_p2sh || is_p2wsh)) {\n                 RPCTypeCheckObj(prevOut,\n                     {\n                         {\"redeemScript\", UniValueType(UniValue::VSTR)},\n                         {\"witnessScript\", UniValueType(UniValue::VSTR)},\n                     }, true);\n                 UniValue rs = find_value(prevOut, \"redeemScript\");\n-                if (!rs.isNull()) {\n-                    std::vector<unsigned char> rsData(ParseHexV(rs, \"redeemScript\"));\n-                    CScript redeemScript(rsData.begin(), rsData.end());\n-                    keystore->AddCScript(redeemScript);\n-                    // Automatically also add the P2WSH wrapped version of the script (to deal with P2SH-P2WSH).\n-                    // This is only for compatibility, it is encouraged to use the explicit witnessScript field instead.\n-                    keystore->AddCScript(GetScriptForWitness(redeemScript));\n-                }\n                 UniValue ws = find_value(prevOut, \"witnessScript\");\n-                if (!ws.isNull()) {\n-                    std::vector<unsigned char> wsData(ParseHexV(ws, \"witnessScript\"));\n-                    CScript witnessScript(wsData.begin(), wsData.end());\n-                    keystore->AddCScript(witnessScript);\n-                    // Automatically also add the P2WSH wrapped version of the script (to deal with P2SH-P2WSH).\n-                    keystore->AddCScript(GetScriptForWitness(witnessScript));\n-                }\n                 if (rs.isNull() && ws.isNull()) {\n                     throw JSONRPCError(RPC_INVALID_PARAMETER, \"Missing redeemScript/witnessScript\");\n                 }\n+\n+                // work from witnessScript when possible\n+                std::vector<unsigned char> scriptData(!ws.isNull() ? ParseHexV(ws, \"witnessScript\") : ParseHexV(rs, \"redeemScript\"));\n+                CScript script(scriptData.begin(), scriptData.end());\n+                keystore->AddCScript(script);\n+                // Automatically also add the P2WSH wrapped version of the script (to deal with P2SH-P2WSH).\n+                // This is done for redeemScript only for compatibility, it is encouraged to use the explicit witnessScript field instead.\n+                CScript witnessScript{GetScriptForWitness(script)};\n+                keystore->AddCScript(witnessScript);\n+\n+                if (is_p2sh) {\n+                    const CTxDestination p2sh{ScriptHash(script)};\n+                    const CTxDestination p2sh_p2wsh{ScriptHash(witnessScript)};\n+                    if (scriptPubKey == GetScriptForDestination(p2sh)) {\n+                        // traditional p2sh; arguably an error if\n+                        // we got here with rs.IsNull(), because\n+                        // that means the p2sh script was specified\n+                        // via witnessScript param, but for now\n+                        // we'll just quietly accept it\n+                    } else if (scriptPubKey == GetScriptForDestination(p2sh_p2wsh)) {\n+                        // p2wsh encoded as p2sh; ideally the witness\n+                        // script was specified in the witnessScript\n+                        // param, but also support specifying it via\n+                        // redeemScript param for backwards compat\n+                        // (in which case ws.IsNull() == true)\n+                    } else {\n+                        // otherwise, can't generate scriptPubKey from\n+                        // either script, so we got unusable parameters\n+                        throw JSONRPCError(RPC_INVALID_PARAMETER, \"redeemScript/witnessScript does not match scriptPubKey\");\n+                    }\n+                } else if (is_p2wsh) {\n+                    const CTxDestination p2wsh{WitnessV0ScriptHash(script)};\n+                    // plain p2wsh; could throw an error if script\n+                    // was specified by redeemScript rather than\n+                    // witnessScript (ie, ws.IsNull() == true), but\n+                    // accept it for backwards compat\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16251#discussion_r322263307",
      "id" : 322263307,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMyMjI2MzMwNw==",
      "original_commit_id" : "a4b351a6c6d3da00c5fb94c51af027ace7051bb4",
      "original_position" : 69,
      "path" : "src/rpc/rawtransaction_util.cpp",
      "position" : 69,
      "pull_request_review_id" : 285534858,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16251",
      "updated_at" : "2019-09-09T14:15:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/322263307",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16251#discussion_r322265375"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16251"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/322265375"
         }
      },
      "author_association" : "MEMBER",
      "body" : "this is the witness output script aka script with version number and witness program, not `witnessScript`, right?",
      "commit_id" : "b5e9bd9d6b225ef033d8d9eeed8bd89d0bf0ea6e",
      "created_at" : "2019-09-09T14:13:49Z",
      "diff_hunk" : "@@ -196,32 +196,73 @@ void ParsePrevouts(const UniValue& prevTxsUnival, FillableSigningProvider* keyst\n             }\n \n             // if redeemScript and private keys were given, add redeemScript to the keystore so it can be signed\n-            if (keystore && (scriptPubKey.IsPayToScriptHash() || scriptPubKey.IsPayToWitnessScriptHash())) {\n+            const bool is_p2sh = scriptPubKey.IsPayToScriptHash();\n+            const bool is_p2wsh = scriptPubKey.IsPayToWitnessScriptHash();\n+            if (keystore && (is_p2sh || is_p2wsh)) {\n                 RPCTypeCheckObj(prevOut,\n                     {\n                         {\"redeemScript\", UniValueType(UniValue::VSTR)},\n                         {\"witnessScript\", UniValueType(UniValue::VSTR)},\n                     }, true);\n                 UniValue rs = find_value(prevOut, \"redeemScript\");\n-                if (!rs.isNull()) {\n-                    std::vector<unsigned char> rsData(ParseHexV(rs, \"redeemScript\"));\n-                    CScript redeemScript(rsData.begin(), rsData.end());\n-                    keystore->AddCScript(redeemScript);\n-                    // Automatically also add the P2WSH wrapped version of the script (to deal with P2SH-P2WSH).\n-                    // This is only for compatibility, it is encouraged to use the explicit witnessScript field instead.\n-                    keystore->AddCScript(GetScriptForWitness(redeemScript));\n-                }\n                 UniValue ws = find_value(prevOut, \"witnessScript\");\n-                if (!ws.isNull()) {\n-                    std::vector<unsigned char> wsData(ParseHexV(ws, \"witnessScript\"));\n-                    CScript witnessScript(wsData.begin(), wsData.end());\n-                    keystore->AddCScript(witnessScript);\n-                    // Automatically also add the P2WSH wrapped version of the script (to deal with P2SH-P2WSH).\n-                    keystore->AddCScript(GetScriptForWitness(witnessScript));\n-                }\n                 if (rs.isNull() && ws.isNull()) {\n                     throw JSONRPCError(RPC_INVALID_PARAMETER, \"Missing redeemScript/witnessScript\");\n                 }\n+\n+                // work from witnessScript when possible\n+                std::vector<unsigned char> scriptData(!ws.isNull() ? ParseHexV(ws, \"witnessScript\") : ParseHexV(rs, \"redeemScript\"));\n+                CScript script(scriptData.begin(), scriptData.end());\n+                keystore->AddCScript(script);\n+                // Automatically also add the P2WSH wrapped version of the script (to deal with P2SH-P2WSH).\n+                // This is done for redeemScript only for compatibility, it is encouraged to use the explicit witnessScript field instead.\n+                CScript witnessScript{GetScriptForWitness(script)};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16251#discussion_r322265375",
      "id" : 322265375,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMyMjI2NTM3NQ==",
      "original_commit_id" : "a4b351a6c6d3da00c5fb94c51af027ace7051bb4",
      "original_position" : 40,
      "path" : "src/rpc/rawtransaction_util.cpp",
      "position" : 40,
      "pull_request_review_id" : 285534858,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16251",
      "updated_at" : "2019-09-09T14:15:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/322265375",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   }
]
