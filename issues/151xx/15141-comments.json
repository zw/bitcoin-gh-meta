[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#15681](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15681.html) ([mempool] Allow one extra single-ancestor transaction per package by TheBlueMatt)\n* [#15606](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15606.html) ([experimental] UTXO snapshots by jamesob)\n* [#15505](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15505.html) ([p2p] Request NOTFOUND transactions immediately from other outbound peers, when possible by sdaftuar)\n* [#15253](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15253.html) (Net: Consistently log outgoing INV messages by Empact)\n* [#13868](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/13868.html) (Remove unused fScriptChecks parameter from CheckInputs by Empact)\n* [#13525](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/13525.html) (Report reason inputs are nonstandard from AreInputsStandard by Empact)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-01-10T18:31:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-453203439",
      "id" : 453203439,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15141",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ1MzIwMzQzOQ==",
      "updated_at" : "2019-04-27T07:08:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/453203439",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2019-01-10T18:34:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-453204363",
      "id" : 453204363,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15141",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ1MzIwNDM2Mw==",
      "updated_at" : "2019-01-10T18:34:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/453204363",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r247050770"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/247050770"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Very small nit: `if (!message.empty()) {` instead? :-)",
      "commit_id" : "94874ddfdf4ae9c4b10f3f91d5e3280e2c24c371",
      "created_at" : "2019-01-11T09:30:13Z",
      "diff_hunk" : "@@ -816,6 +816,91 @@ void Misbehaving(NodeId pnode, int howmuch, const std::string& message) EXCLUSIV\n         LogPrint(BCLog::NET, \"%s: %s peer=%d (%d -> %d)%s\\n\", __func__, state->name, pnode, state->nMisbehavior-howmuch, state->nMisbehavior, message_prefixed);\n }\n \n+/**\n+ * Returns true if the given validation state result may result in us banning/disconnecting a peer\n+ * which provided such an object. This is used to determine whether to relay transactions to\n+ * whitelisted peers, preventing us from relaying things which would result in them disconnecting\n+ * us.\n+ */\n+static bool MayResultInDisconnect(const CValidationState& state, bool via_compact_block) {\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        return false;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        // Blocks (or headers) invalid for one of the above reasons may not be\n+        // knowable to a high-bandwidth compact block peer, prior to relay.\n+        // Headers that are invalid for reasons that should be known prior to\n+        // block validation -- such as bad proof of work, too-early-time, or\n+        // building off an invalid or missing block -- are punished regardless\n+        // (see below).\n+        return !via_compact_block;\n+    case ValidationInvalidReason::BLOCK_INVALID_HEADER:\n+    case ValidationInvalidReason::BLOCK_CHECKPOINT:\n+    case ValidationInvalidReason::BLOCK_INVALID_PREV:\n+    case ValidationInvalidReason::BLOCK_MISSING_PREV:\n+        return true;\n+    // Conflicting (but not necessarily invalid) data or different policy:\n+    case ValidationInvalidReason::RECENT_CONSENSUS_CHANGE:\n+    case ValidationInvalidReason::BLOCK_BAD_TIME:\n+    case ValidationInvalidReason::TX_NOT_STANDARD:\n+    case ValidationInvalidReason::TX_MISSING_INPUTS:\n+    case ValidationInvalidReason::TX_WITNESS_MUTATED:\n+    case ValidationInvalidReason::TX_CONFLICT:\n+    case ValidationInvalidReason::TX_MEMPOOL_POLICY:\n+        return false;\n+    }\n+    return false;\n+}\n+\n+//! Returns true if the peer was punished (probably disconnected)\n+static bool MaybePunishNode(NodeId nodeid, const CValidationState& state, bool via_compact_block, const std::string& message = \"\") {\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        break;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        if (!via_compact_block) {\n+            LOCK(cs_main);\n+            Misbehaving(nodeid, 100, message);\n+            return true;\n+        }\n+        break;\n+    case ValidationInvalidReason::BLOCK_INVALID_HEADER:\n+    case ValidationInvalidReason::BLOCK_CHECKPOINT:\n+    case ValidationInvalidReason::BLOCK_INVALID_PREV:\n+        {\n+            LOCK(cs_main);\n+            Misbehaving(nodeid, 100, message);\n+        }\n+        return true;\n+    // Conflicting (but not necessarily invalid) data or different policy:\n+    case ValidationInvalidReason::BLOCK_MISSING_PREV:\n+        {\n+            // TODO: Handle this much more gracefully (10 DoS points is super arbitrary)\n+            LOCK(cs_main);\n+            Misbehaving(nodeid, 10, message);\n+        }\n+        return true;\n+    case ValidationInvalidReason::RECENT_CONSENSUS_CHANGE:\n+    case ValidationInvalidReason::BLOCK_BAD_TIME:\n+    case ValidationInvalidReason::TX_NOT_STANDARD:\n+    case ValidationInvalidReason::TX_MISSING_INPUTS:\n+    case ValidationInvalidReason::TX_WITNESS_MUTATED:\n+    case ValidationInvalidReason::TX_CONFLICT:\n+    case ValidationInvalidReason::TX_MEMPOOL_POLICY:\n+        break;\n+    }\n+    if (message != \"\") {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r247050770",
      "id" : 247050770,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0NzA1MDc3MA==",
      "original_commit_id" : "94874ddfdf4ae9c4b10f3f91d5e3280e2c24c371",
      "original_position" : 83,
      "path" : "src/net_processing.cpp",
      "position" : 83,
      "pull_request_review_id" : 191577024,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-01-11T09:30:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/247050770",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK; I'll review for changes in behavior for specific validation reasons later.",
      "created_at" : "2019-01-11T18:17:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-453608761",
      "id" : 453608761,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15141",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ1MzYwODc2MQ==",
      "updated_at" : "2019-01-11T18:17:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/453608761",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2019-01-14T14:23:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-454021358",
      "id" : 454021358,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15141",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ1NDAyMTM1OA==",
      "updated_at" : "2019-01-14T14:23:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/454021358",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r247634533"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/247634533"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: change to `m_reason` and avoid all the non-shadowing naming tricks below (`reasonIn` and `_reason`)",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-01-14T19:52:06Z",
      "diff_hunk" : "@@ -30,32 +74,24 @@ class CValidationState {\n         MODE_INVALID, //!< network rule violation (DoS value may be set)\n         MODE_ERROR,   //!< run-time error\n     } mode;\n-    int nDoS;\n+    ValidationInvalidReason reason;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r247634533",
      "id" : 247634533,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0NzYzNDUzMw==",
      "original_commit_id" : "94874ddfdf4ae9c4b10f3f91d5e3280e2c24c371",
      "original_position" : 56,
      "path" : "src/consensus/validation.h",
      "position" : null,
      "pull_request_review_id" : 192332892,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/247634533",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r247638591"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/247638591"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: s/conflicts with a tx in the chain/conflicts with a confirmed transaction. Same comment below for \"exists in the mempool or on chain\"",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-01-14T20:03:52Z",
      "diff_hunk" : "@@ -22,6 +22,50 @@ static const unsigned char REJECT_NONSTANDARD = 0x40;\n static const unsigned char REJECT_INSUFFICIENTFEE = 0x42;\n static const unsigned char REJECT_CHECKPOINT = 0x43;\n \n+/** A \"reason\" why something was invalid, suitable for determining whether the\n+  * provider of the object should be banned/ignored/disconnected/etc.\n+  * These are much more granular than the rejection codes, which may be more\n+  * useful for some other use-cases.\n+  */\n+enum class ValidationInvalidReason {\n+    // txn and blocks:\n+    NONE,                    //!< not actually invalid\n+    CONSENSUS,               //!< invalid by consensus rules (excluding any below reasons)\n+    /**\n+     * Invalid by a change to consensus rules more recent than SegWit.\n+     * Currently unused as there are no such consensus rule changes, and any download\n+     * sources realistically need to support SegWit in order to provide useful data,\n+     * so differentiating between always-invalid and invalid-by-pre-SegWit-soft-fork\n+     * is uninteresting.\n+     */\n+    RECENT_CONSENSUS_CHANGE,\n+    CACHED_INVALID,          //!< this object was cached as being invalid, but we don't know why\n+    // Only blocks (or headers):\n+    BLOCK_INVALID_HEADER,    //!< invalid proof of work or time too old\n+    BLOCK_MUTATED,           //!< the block's data didn't match the data committed to by the PoW\n+    BLOCK_MISSING_PREV,      //!< We don't have the previous block the checked one is built on\n+    BLOCK_INVALID_PREV,      //!< A block this one builds on is invalid\n+    BLOCK_BAD_TIME,          //!< block timestamp was > 2 hours in the future (or our clock is bad)\n+    BLOCK_CHECKPOINT,        //!< the block failed to meet one of our checkpoints\n+    // Only loose txn:\n+    TX_NOT_STANDARD,          //!< didn't meet our local policy rules\n+    TX_MISSING_INPUTS,        //!< a transaction was missing some of its inputs (or its inputs were spent at < coinbase maturity height)\n+    /**\n+     * Transaction might be missing a witness, have a witness prior to SegWit\n+     * activation, or witness may have been malleated (which includes\n+     * non-standard witnesses).\n+     */\n+    TX_WITNESS_MUTATED,\n+    /**\n+     * Tx already in mempool or conflicts with a tx in the chain",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r247638591",
      "id" : 247638591,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0NzYzODU5MQ==",
      "original_commit_id" : "94874ddfdf4ae9c4b10f3f91d5e3280e2c24c371",
      "original_position" : 39,
      "path" : "src/consensus/validation.h",
      "position" : 40,
      "pull_request_review_id" : 192332892,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/247638591",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r247678436"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/247678436"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This seems entirely obvious and not requiring a comment to me, which makes me think there's some subtlety I've missed. Is this just saying that if we receive a block with witness data, it should be valid-according-to-BIP141?\r\n\r\nPedantic nit: I'd also avoid talking about 'data-providers' in validation.cpp. After this PR, validation should be unconcerned with data-providers and only be validating blocks based on the block data.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-01-14T22:09:50Z",
      "diff_hunk" : "@@ -3333,7 +3341,9 @@ static bool ContextualCheckBlock(const CBlock& block, CValidationState& state, c\n     // the block hash, so we couldn't mark the block as permanently\n     // failed).\n     if (GetBlockWeight(block) > MAX_BLOCK_WEIGHT) {\n-        return state.DoS(100, false, REJECT_INVALID, \"bad-blk-weight\", false, strprintf(\"%s : weight limit failed\", __func__));\n+        // We can call this a consensus failure as any data-providers who provided",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r247678436",
      "id" : 247678436,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0NzY3ODQzNg==",
      "original_commit_id" : "94874ddfdf4ae9c4b10f3f91d5e3280e2c24c371",
      "original_position" : 494,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 192332892,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/247678436",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r247688022"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/247688022"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It's unclear to me whether peers should always be punished for `BLOCK_INVALID_PREV`. For example, if the previous block was invalid because of `RECENT_CONSENSUS_CHANGE` and the peer wasn't punished, should it be punished for relaying this descendant block?\r\n\r\nShould compact block peers be punished for relaying the block if its parent is invalid? My reading of https://github.com/bitcoin/bips/blob/master/bip-0152.mediawiki#pre-validation-relay-and-consistency-considerations is that the answer is no.\r\n\r\nSame question for `MaybePunishNode()` below.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-01-14T22:42:35Z",
      "diff_hunk" : "@@ -816,6 +816,91 @@ void Misbehaving(NodeId pnode, int howmuch, const std::string& message) EXCLUSIV\n         LogPrint(BCLog::NET, \"%s: %s peer=%d (%d -> %d)%s\\n\", __func__, state->name, pnode, state->nMisbehavior-howmuch, state->nMisbehavior, message_prefixed);\n }\n \n+/**\n+ * Returns true if the given validation state result may result in us banning/disconnecting a peer\n+ * which provided such an object. This is used to determine whether to relay transactions to\n+ * whitelisted peers, preventing us from relaying things which would result in them disconnecting\n+ * us.\n+ */\n+static bool MayResultInDisconnect(const CValidationState& state, bool via_compact_block) {\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        return false;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        // Blocks (or headers) invalid for one of the above reasons may not be\n+        // knowable to a high-bandwidth compact block peer, prior to relay.\n+        // Headers that are invalid for reasons that should be known prior to\n+        // block validation -- such as bad proof of work, too-early-time, or\n+        // building off an invalid or missing block -- are punished regardless\n+        // (see below).\n+        return !via_compact_block;\n+    case ValidationInvalidReason::BLOCK_INVALID_HEADER:\n+    case ValidationInvalidReason::BLOCK_CHECKPOINT:\n+    case ValidationInvalidReason::BLOCK_INVALID_PREV:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r247688022",
      "id" : 247688022,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0NzY4ODAyMg==",
      "original_commit_id" : "94874ddfdf4ae9c4b10f3f91d5e3280e2c24c371",
      "original_position" : 27,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 192332892,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/247688022",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r247736063"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/247736063"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I believe this comment is contrasting a CONSENSUS failure from a RECENT_CONSENSUS_CHANGE -- I think in @TheBlueMatt's original PR he had some validation failures marked as RECENT_CONSENSUS_CHANGE, but eventually we decided to switch them all out (and reserve RECENT_CONSENSUS_CHANGE as something we might do in the future).\r\n\r\nI think I agree with you philosophically that validation ought not be very concerned with 'data providers', but I think the ValidationReasons interface is also driven by the needs of net_processing, so sometimes we may need to explain reasons that maybe don't make sense in a totally neutral validation library because our application requires it.  RECENT_CONSENSUS_CHANGE is one such possible example (though we're not using it in this PR and I am not sure we ever will); the BLOCK_INVALID_HEADER enum I added is another (net_processing needs to be able to distinguish some headers failures from others, in order to maintain the current ban behavior).\r\n\r\nAnyway I'll update this comment to be clearer.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-01-15T01:23:21Z",
      "diff_hunk" : "@@ -3333,7 +3341,9 @@ static bool ContextualCheckBlock(const CBlock& block, CValidationState& state, c\n     // the block hash, so we couldn't mark the block as permanently\n     // failed).\n     if (GetBlockWeight(block) > MAX_BLOCK_WEIGHT) {\n-        return state.DoS(100, false, REJECT_INVALID, \"bad-blk-weight\", false, strprintf(\"%s : weight limit failed\", __func__));\n+        // We can call this a consensus failure as any data-providers who provided",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r247736063",
      "id" : 247736063,
      "in_reply_to_id" : 247678436,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0NzczNjA2Mw==",
      "original_commit_id" : "94874ddfdf4ae9c4b10f3f91d5e3280e2c24c371",
      "original_position" : 494,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 192453150,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/247736063",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r247737022"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/247737022"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Self-review: I think adding this line here may be a bug.  At any rate, there is a serious confusion between the hacky punish_invalid bool in the existing code and the introduction of MaybePunishNode in this PR that ought to be cleaned up.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-01-15T01:29:26Z",
      "diff_hunk" : "@@ -1453,6 +1529,7 @@ bool static ProcessHeadersMessage(CNode *pfrom, CConnman *connman, const std::ve\n                 // etc), and not just the duplicate-invalid case.\n                 pfrom->fDisconnect = true;\n             }\n+            MaybePunishNode(pfrom->GetId(), state, /*via_compact_block*/ false, \"invalid header received\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r247737022",
      "id" : 247737022,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0NzczNzAyMg==",
      "original_commit_id" : "94874ddfdf4ae9c4b10f3f91d5e3280e2c24c371",
      "original_position" : 131,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 192454315,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/247737022",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r247768943"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/247768943"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this comment is justifying upgrading the (at the time recent) segwit test from a RECENT_CONSENSUS_CHANGE to just CONSENSUS_CHANGE, the reason being that either you've got an old client that didn't provide segwit data -- in which case this test won't trigger because the `bad-blk-length` test will already have failed -- or it is providing segwit data but doing it wrong, in which case there's no reason to use the more forgiving `RECENT` version. So I think just dropping the comment (now that segwit isn't recent) is fine, fwiw.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-01-15T05:31:44Z",
      "diff_hunk" : "@@ -3333,7 +3341,9 @@ static bool ContextualCheckBlock(const CBlock& block, CValidationState& state, c\n     // the block hash, so we couldn't mark the block as permanently\n     // failed).\n     if (GetBlockWeight(block) > MAX_BLOCK_WEIGHT) {\n-        return state.DoS(100, false, REJECT_INVALID, \"bad-blk-weight\", false, strprintf(\"%s : weight limit failed\", __func__));\n+        // We can call this a consensus failure as any data-providers who provided",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r247768943",
      "id" : 247768943,
      "in_reply_to_id" : 247678436,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0Nzc2ODk0Mw==",
      "original_commit_id" : "94874ddfdf4ae9c4b10f3f91d5e3280e2c24c371",
      "original_position" : 494,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 192491512,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/247768943",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r247771578"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/247771578"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If miners have mostly upgraded then building on top of a `RECENT_CONSENSUS_CHANGE` block should be rare enough for this not to be a huge problem.\r\n\r\nIf not, and we want to cope with a moderately controversial consensus upgrade, then we probably want to track whether blocks failed due to `RECENT_CONSENSUS_CHANGE` and mark their children as also failing due to `RECENT_CONSENSUS_CHANGE` (after checking PoW at least). Working all that out doesn't seem necessary for this patchset to me though.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-01-15T05:56:37Z",
      "diff_hunk" : "@@ -816,6 +816,91 @@ void Misbehaving(NodeId pnode, int howmuch, const std::string& message) EXCLUSIV\n         LogPrint(BCLog::NET, \"%s: %s peer=%d (%d -> %d)%s\\n\", __func__, state->name, pnode, state->nMisbehavior-howmuch, state->nMisbehavior, message_prefixed);\n }\n \n+/**\n+ * Returns true if the given validation state result may result in us banning/disconnecting a peer\n+ * which provided such an object. This is used to determine whether to relay transactions to\n+ * whitelisted peers, preventing us from relaying things which would result in them disconnecting\n+ * us.\n+ */\n+static bool MayResultInDisconnect(const CValidationState& state, bool via_compact_block) {\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        return false;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        // Blocks (or headers) invalid for one of the above reasons may not be\n+        // knowable to a high-bandwidth compact block peer, prior to relay.\n+        // Headers that are invalid for reasons that should be known prior to\n+        // block validation -- such as bad proof of work, too-early-time, or\n+        // building off an invalid or missing block -- are punished regardless\n+        // (see below).\n+        return !via_compact_block;\n+    case ValidationInvalidReason::BLOCK_INVALID_HEADER:\n+    case ValidationInvalidReason::BLOCK_CHECKPOINT:\n+    case ValidationInvalidReason::BLOCK_INVALID_PREV:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r247771578",
      "id" : 247771578,
      "in_reply_to_id" : 247688022,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0Nzc3MTU3OA==",
      "original_commit_id" : "94874ddfdf4ae9c4b10f3f91d5e3280e2c24c371",
      "original_position" : 27,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 192494788,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/247771578",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r247772868"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/247772868"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Maybe having `inline bool CorruptionPossible() const { return reason == BLOCK_MUTATED; }` would make for nicer code elsewhere?",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-01-15T06:07:14Z",
      "diff_hunk" : "@@ -117,14 +107,7 @@ class CValidationState {\n     bool IsError() const {\n         return mode == MODE_ERROR;\n     }\n-    bool CorruptionPossible() const {\n-        return corruptionPossible;\n-    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r247772868",
      "id" : 247772868,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0Nzc3Mjg2OA==",
      "original_commit_id" : "6ee2c4551d055dd3c7bf28ed4bde7c566d75dfef",
      "original_position" : 42,
      "path" : "src/consensus/validation.h",
      "position" : 131,
      "pull_request_review_id" : 192495960,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/247772868",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r247881222"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/247881222"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This change isn't a clean refactor -- `!state.CorruptionPossible()` would have returned false after this, but its replacement in this commit (ie, `state.GetReason() != BLOCK_MUTATED`) will return true. I think this is okay though, since `CorruptionPossible()` is only checked for block updates, and this just deals with mempool tx's, and the uses of `state.CorruptionPossible()` that this would have effected were already changed to `state.GetReason() != TX_WITNESS_MUTATED` in an earlier commit. ",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-01-15T12:57:07Z",
      "diff_hunk" : "@@ -889,7 +889,6 @@ static bool AcceptToMemoryPoolWorker(const CChainParams& chainparams, CTxMemPool\n                 // Only the witness is missing, so the transaction itself may be fine.\n                 state.Invalid(ValidationInvalidReason::TX_WITNESS_MUTATED, false,\n                           state.GetRejectCode(), state.GetRejectReason(), state.GetDebugMessage());\n-                state.SetCorruptionPossible();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r247881222",
      "id" : 247881222,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0Nzg4MTIyMg==",
      "original_commit_id" : "6ee2c4551d055dd3c7bf28ed4bde7c566d75dfef",
      "original_position" : 4,
      "path" : "src/validation.cpp",
      "position" : 180,
      "pull_request_review_id" : 192495960,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/247881222",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r247908811"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/247908811"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Seems like this change could be squashed into \"Remove references to CValidationState's DoS and CorruptionPossible\" ?",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-01-15T14:18:58Z",
      "diff_hunk" : "@@ -203,7 +203,7 @@ ReadStatus PartiallyDownloadedBlock::FillBlock(CBlock& block, const std::vector<\n         // but that is expensive, and CheckBlock caches a block's\n         // \"checked-status\" (in the CBlock?). CBlock should be able to\n         // check its own merkle root and cache that check.\n-        if (state.CorruptionPossible())\n+        if (state.GetReason() == ValidationInvalidReason::BLOCK_MUTATED)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r247908811",
      "id" : 247908811,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0NzkwODgxMQ==",
      "original_commit_id" : "963699d1316f6b14c98a4624f766393379db85e1",
      "original_position" : 5,
      "path" : "src/blockencodings.cpp",
      "position" : 5,
      "pull_request_review_id" : 192495960,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/247908811",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r247920759"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/247920759"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This replaces the `Misbehaving(.., \"invalid header received\");` from earlier; shouldn't be introducing a bug (unless the move to below the `if` introduces one)?",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-01-15T14:48:25Z",
      "diff_hunk" : "@@ -1453,6 +1529,7 @@ bool static ProcessHeadersMessage(CNode *pfrom, CConnman *connman, const std::ve\n                 // etc), and not just the duplicate-invalid case.\n                 pfrom->fDisconnect = true;\n             }\n+            MaybePunishNode(pfrom->GetId(), state, /*via_compact_block*/ false, \"invalid header received\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r247920759",
      "id" : 247920759,
      "in_reply_to_id" : 247737022,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0NzkyMDc1OQ==",
      "original_commit_id" : "94874ddfdf4ae9c4b10f3f91d5e3280e2c24c371",
      "original_position" : 131,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 192682212,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/247920759",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r247998223"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/247998223"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I believe there is an unintended behavior change here -- previously, \"duplicate invalid\" headers were not assigned DoS points.  We added a bunch of logic (just above this line of code) to punish outbound peers for providing invalid headers.\r\n\r\nAfter the rewrite in this PR, CACHED_INVALID is a bannable offense from any peer (other than in HB compact block relay).\r\n\r\nI'll rework this...",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-01-15T17:54:52Z",
      "diff_hunk" : "@@ -1453,6 +1529,7 @@ bool static ProcessHeadersMessage(CNode *pfrom, CConnman *connman, const std::ve\n                 // etc), and not just the duplicate-invalid case.\n                 pfrom->fDisconnect = true;\n             }\n+            MaybePunishNode(pfrom->GetId(), state, /*via_compact_block*/ false, \"invalid header received\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r247998223",
      "id" : 247998223,
      "in_reply_to_id" : 247737022,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0Nzk5ODIyMw==",
      "original_commit_id" : "94874ddfdf4ae9c4b10f3f91d5e3280e2c24c371",
      "original_position" : 131,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 192781251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/247998223",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r248002976"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/248002976"
         }
      },
      "author_association" : "MEMBER",
      "body" : "With respect to the issue you're bringing up, I believe the behavior in this PR matches existing behavior, in which case I'd prefer to defer improvement to a future PR.  If I'm missing some way that we've made things different or worse though let me know.\r\n\r\nAs for BIP 152:\r\n\r\n>A node MUST NOT send a cmpctblock message without having validated that the header properly commits to each transaction in the block, and properly builds on top of the existing, fully-validated chain with a valid proof-of-work either as a part of the current most-work valid chain, or building directly on top of it. A node MAY send a cmpctblock before validating that each transaction in the block validly spends existing UTXO set entries.\r\n",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-01-15T18:07:57Z",
      "diff_hunk" : "@@ -816,6 +816,91 @@ void Misbehaving(NodeId pnode, int howmuch, const std::string& message) EXCLUSIV\n         LogPrint(BCLog::NET, \"%s: %s peer=%d (%d -> %d)%s\\n\", __func__, state->name, pnode, state->nMisbehavior-howmuch, state->nMisbehavior, message_prefixed);\n }\n \n+/**\n+ * Returns true if the given validation state result may result in us banning/disconnecting a peer\n+ * which provided such an object. This is used to determine whether to relay transactions to\n+ * whitelisted peers, preventing us from relaying things which would result in them disconnecting\n+ * us.\n+ */\n+static bool MayResultInDisconnect(const CValidationState& state, bool via_compact_block) {\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        return false;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        // Blocks (or headers) invalid for one of the above reasons may not be\n+        // knowable to a high-bandwidth compact block peer, prior to relay.\n+        // Headers that are invalid for reasons that should be known prior to\n+        // block validation -- such as bad proof of work, too-early-time, or\n+        // building off an invalid or missing block -- are punished regardless\n+        // (see below).\n+        return !via_compact_block;\n+    case ValidationInvalidReason::BLOCK_INVALID_HEADER:\n+    case ValidationInvalidReason::BLOCK_CHECKPOINT:\n+    case ValidationInvalidReason::BLOCK_INVALID_PREV:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r248002976",
      "id" : 248002976,
      "in_reply_to_id" : 247688022,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0ODAwMjk3Ng==",
      "original_commit_id" : "94874ddfdf4ae9c4b10f3f91d5e3280e2c24c371",
      "original_position" : 27,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 192787164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/248002976",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r248032542"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/248032542"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Add useful-for-dos \"reason\" field to CValidationState\" (a5415e85caaf2f5a77d6bae9574bb6d21139ee34)\r\n\r\nNote: word-diff is useful here to review new function arguments:\r\n\r\n```bash\r\ngit log -p -n1 -U0 --word-diff-regex=. a5415e85caaf2f5a77d6bae9574bb6d21139ee34\r\n```",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-01-15T19:30:40Z",
      "diff_hunk" : "@@ -160,24 +160,24 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state, bool fChe\n {\n     // Basic checks that don't depend on any context\n     if (tx.vin.empty())\n-        return state.DoS(10, false, REJECT_INVALID, \"bad-txns-vin-empty\");\n+        return state.DoS(10, ValidationInvalidReason::CONSENSUS, false, REJECT_INVALID, \"bad-txns-vin-empty\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r248032542",
      "id" : 248032542,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0ODAzMjU0Mg==",
      "original_commit_id" : "a5415e85caaf2f5a77d6bae9574bb6d21139ee34",
      "original_position" : 5,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : null,
      "pull_request_review_id" : 192824459,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/248032542",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r248034524"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/248034524"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Add useful-for-dos \"reason\" field to CValidationState\" (a5415e85caaf2f5a77d6bae9574bb6d21139ee34):\r\n\r\nWhy remove this comment?",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-01-15T19:36:28Z",
      "diff_hunk" : "@@ -716,27 +716,22 @@ static bool AcceptToMemoryPoolWorker(const CChainParams& chainparams, CTxMemPool\n                               fSpendsCoinbase, nSigOpsCost, lp);\n         unsigned int nSize = entry.GetTxSize();\n \n-        // Check that the transaction doesn't have an excessive number of",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r248034524",
      "id" : 248034524,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0ODAzNDUyNA==",
      "original_commit_id" : "a5415e85caaf2f5a77d6bae9574bb6d21139ee34",
      "original_position" : 79,
      "path" : "src/validation.cpp",
      "position" : 79,
      "pull_request_review_id" : 192824459,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/248034524",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r248036953"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/248036953"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Add useful-for-dos \"reason\" field to CValidationState\" (a5415e85caaf2f5a77d6bae9574bb6d21139ee34)\r\n\r\nThis seems like it is doubling the state.nDoS level, in addition to updating the reason enum:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/a5415e85caaf2f5a77d6bae9574bb6d21139ee34/src/consensus/validation.h#L96\r\n\r\nWould suggest replacing this change something more straightforward like `state.UpdateReason(ValidationInvalidReason::CONSENSUS)`",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-01-15T19:44:08Z",
      "diff_hunk" : "@@ -1988,11 +1988,17 @@ bool CChainState::ConnectBlock(const CBlock& block, CValidationState& state, CBl\n         {\n             CAmount txfee = 0;\n             if (!Consensus::CheckTxInputs(tx, state, view, pindex->nHeight, txfee)) {\n+                if (state.GetReason() == ValidationInvalidReason::TX_MISSING_INPUTS) {\n+                    // CheckTxInputs may return MISSING_INPUTS but we can't return that, as\n+                    // it's not defined for a block, so we reset the reason flag to CONSENSUS here.\n+                    state.DoS(state.GetDoS(), ValidationInvalidReason::CONSENSUS, false,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r248036953",
      "id" : 248036953,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0ODAzNjk1Mw==",
      "original_commit_id" : "a5415e85caaf2f5a77d6bae9574bb6d21139ee34",
      "original_position" : 232,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 192824459,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/248036953",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r248037437"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/248037437"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Add useful-for-dos \"reason\" field to CValidationState\" (a5415e85caaf2f5a77d6bae9574bb6d21139ee34)\r\n\r\nExtra space on this line",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-01-15T19:45:33Z",
      "diff_hunk" : "@@ -2016,17 +2022,29 @@ bool CChainState::ConnectBlock(const CBlock& block, CValidationState& state, CBl\n         // * witness (when witness enabled in flags and excludes coinbase)\n         nSigOpsCost += GetTransactionSigOpCost(tx, view, flags);\n         if (nSigOpsCost > MAX_BLOCK_SIGOPS_COST)\n-            return state.DoS(100, error(\"ConnectBlock(): too many sigops\"),\n+            return state.DoS(100, ValidationInvalidReason::CONSENSUS, error(\"ConnectBlock(): too many sigops\"),\n                              REJECT_INVALID, \"bad-blk-sigops\");\n \n         txdata.emplace_back(tx);\n         if (!tx.IsCoinBase())\n         {\n             std::vector<CScriptCheck> vChecks;\n             bool fCacheResults = fJustCheck; /* Don't cache results if we're actually connecting blocks (still consult the cache, though) */\n-            if (!CheckInputs(tx, state, view, fScriptChecks, flags, fCacheResults, fCacheResults, txdata[i], nScriptCheckThreads ? &vChecks : nullptr))\n+            if (!CheckInputs(tx, state, view, fScriptChecks, flags, fCacheResults, fCacheResults, txdata[i], nScriptCheckThreads ? &vChecks : nullptr)) {\n+                if (state.GetReason() == ValidationInvalidReason::TX_NOT_STANDARD) {\n+                    // CheckInputs may return NOT_STANDARD for extra flags we passed,\n+                    // but we can't return that, as it's not defined for a block, so\n+                    // we reset the reason flag to CONSENSUS here.\n+                    // (note that this may not be the case until we add additional\n+                    // soft-fork flags to our script flags, in which case we  need to",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r248037437",
      "id" : 248037437,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0ODAzNzQzNw==",
      "original_commit_id" : "a5415e85caaf2f5a77d6bae9574bb6d21139ee34",
      "original_position" : 273,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 192824459,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/248037437",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r248038062"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/248038062"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Add useful-for-dos \"reason\" field to CValidationState\" (a5415e85caaf2f5a77d6bae9574bb6d21139ee34)\r\n\r\nThis also seems to double state.nDoS.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-01-15T19:47:21Z",
      "diff_hunk" : "@@ -2016,17 +2022,29 @@ bool CChainState::ConnectBlock(const CBlock& block, CValidationState& state, CBl\n         // * witness (when witness enabled in flags and excludes coinbase)\n         nSigOpsCost += GetTransactionSigOpCost(tx, view, flags);\n         if (nSigOpsCost > MAX_BLOCK_SIGOPS_COST)\n-            return state.DoS(100, error(\"ConnectBlock(): too many sigops\"),\n+            return state.DoS(100, ValidationInvalidReason::CONSENSUS, error(\"ConnectBlock(): too many sigops\"),\n                              REJECT_INVALID, \"bad-blk-sigops\");\n \n         txdata.emplace_back(tx);\n         if (!tx.IsCoinBase())\n         {\n             std::vector<CScriptCheck> vChecks;\n             bool fCacheResults = fJustCheck; /* Don't cache results if we're actually connecting blocks (still consult the cache, though) */\n-            if (!CheckInputs(tx, state, view, fScriptChecks, flags, fCacheResults, fCacheResults, txdata[i], nScriptCheckThreads ? &vChecks : nullptr))\n+            if (!CheckInputs(tx, state, view, fScriptChecks, flags, fCacheResults, fCacheResults, txdata[i], nScriptCheckThreads ? &vChecks : nullptr)) {\n+                if (state.GetReason() == ValidationInvalidReason::TX_NOT_STANDARD) {\n+                    // CheckInputs may return NOT_STANDARD for extra flags we passed,\n+                    // but we can't return that, as it's not defined for a block, so\n+                    // we reset the reason flag to CONSENSUS here.\n+                    // (note that this may not be the case until we add additional\n+                    // soft-fork flags to our script flags, in which case we  need to\n+                    // be careful to differentiate RECENT_CONSENSUS_CHANGE and\n+                    // CONSENSUS)\n+                    state.DoS(state.GetDoS(), ValidationInvalidReason::CONSENSUS, false,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r248038062",
      "id" : 248038062,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0ODAzODA2Mg==",
      "original_commit_id" : "a5415e85caaf2f5a77d6bae9574bb6d21139ee34",
      "original_position" : 276,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 192824459,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/248038062",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r248039678"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/248039678"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Add useful-for-dos \"reason\" field to CValidationState\" (a5415e85caaf2f5a77d6bae9574bb6d21139ee34)\r\n\r\nIs there a check for the requirement that MISSING_INPUTS is not used for a block? I would expect to see an assert(reason != MISSING_INPUTS) or assert(ValidForBlock(reason)) or something like that somewhere.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-01-15T19:52:30Z",
      "diff_hunk" : "@@ -1988,11 +1988,17 @@ bool CChainState::ConnectBlock(const CBlock& block, CValidationState& state, CBl\n         {\n             CAmount txfee = 0;\n             if (!Consensus::CheckTxInputs(tx, state, view, pindex->nHeight, txfee)) {\n+                if (state.GetReason() == ValidationInvalidReason::TX_MISSING_INPUTS) {\n+                    // CheckTxInputs may return MISSING_INPUTS but we can't return that, as\n+                    // it's not defined for a block, so we reset the reason flag to CONSENSUS here.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r248039678",
      "id" : 248039678,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0ODAzOTY3OA==",
      "original_commit_id" : "a5415e85caaf2f5a77d6bae9574bb6d21139ee34",
      "original_position" : 231,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 192824459,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/248039678",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r248041505"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/248041505"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Add useful-for-dos \"reason\" field to CValidationState\" (a5415e85caaf2f5a77d6bae9574bb6d21139ee34)\r\n\r\nNote: I guess this line used to set state.corruptionPossible = false but no longer does.\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/cebe910718ae4f099f292736192a4e725ad02b94/src/consensus/validation.h#L54-L58\r\n\r\nNew way seems better.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-01-15T19:57:17Z",
      "diff_hunk" : "@@ -3106,28 +3124,30 @@ bool CheckBlock(const CBlock& block, CValidationState& state, const Consensus::P\n \n     // Size limits\n     if (block.vtx.empty() || block.vtx.size() * WITNESS_SCALE_FACTOR > MAX_BLOCK_WEIGHT || ::GetSerializeSize(block, PROTOCOL_VERSION | SERIALIZE_TRANSACTION_NO_WITNESS) * WITNESS_SCALE_FACTOR > MAX_BLOCK_WEIGHT)\n-        return state.DoS(100, false, REJECT_INVALID, \"bad-blk-length\", false, \"size limits failed\");\n+        return state.DoS(100, ValidationInvalidReason::CONSENSUS, false, REJECT_INVALID, \"bad-blk-length\", false, \"size limits failed\");\n \n     // First transaction must be coinbase, the rest must not be\n     if (block.vtx.empty() || !block.vtx[0]->IsCoinBase())\n-        return state.DoS(100, false, REJECT_INVALID, \"bad-cb-missing\", false, \"first tx is not coinbase\");\n+        return state.DoS(100, ValidationInvalidReason::CONSENSUS, false, REJECT_INVALID, \"bad-cb-missing\", false, \"first tx is not coinbase\");\n     for (unsigned int i = 1; i < block.vtx.size(); i++)\n         if (block.vtx[i]->IsCoinBase())\n-            return state.DoS(100, false, REJECT_INVALID, \"bad-cb-multiple\", false, \"more than one coinbase\");\n+            return state.DoS(100, ValidationInvalidReason::CONSENSUS, false, REJECT_INVALID, \"bad-cb-multiple\", false, \"more than one coinbase\");\n \n     // Check transactions\n-    for (const auto& tx : block.vtx)\n-        if (!CheckTransaction(*tx, state, true))\n-            return state.Invalid(false, state.GetRejectCode(), state.GetRejectReason(),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r248041505",
      "id" : 248041505,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0ODA0MTUwNQ==",
      "original_commit_id" : "a5415e85caaf2f5a77d6bae9574bb6d21139ee34",
      "original_position" : 345,
      "path" : "src/validation.cpp",
      "position" : 403,
      "pull_request_review_id" : 192824459,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/248041505",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r248048711"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/248048711"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Use state reason field to check for collisions in cmpctblocks\" (963699d1316f6b14c98a4624f766393379db85e1)\r\n\r\nSince the `mapBlockSource` bool is now being passed as `!via_compact_block`, it seems like the field description should mention something about setting it based on whether the source was a compact or full block:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/6bdc4491e06433eb380ca3b8bc3e7c15f06aee8b/src/net_processing.cpp#L104-L105",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-01-15T20:21:21Z",
      "diff_hunk" : "@@ -1077,14 +1077,12 @@ void PeerLogicValidation::BlockChecked(const CBlock& block, const CValidationSta\n     const uint256 hash(block.GetHash());\n     std::map<uint256, std::pair<NodeId, bool>>::iterator it = mapBlockSource.find(hash);\n \n-    int nDoS = 0;\n-    if (state.IsInvalid(nDoS)) {\n+    if (state.IsInvalid()) {\n         // Don't send reject message with code 0 or an internal reject code.\n         if (it != mapBlockSource.end() && State(it->second.first) && state.GetRejectCode() > 0 && state.GetRejectCode() < REJECT_INTERNAL) {\n             CBlockReject reject = {(unsigned char)state.GetRejectCode(), state.GetRejectReason().substr(0, MAX_REJECT_MESSAGE_LENGTH), hash};\n             State(it->second.first)->rejects.push_back(reject);\n-            if (nDoS > 0 && it->second.second)\n-                Misbehaving(it->second.first, nDoS);\n+            MaybePunishNode(/*nodeid=*/ it->second.first, state, /*via_compact_block=*/ !it->second.second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r248048711",
      "id" : 248048711,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0ODA0ODcxMQ==",
      "original_commit_id" : "6bdc4491e06433eb380ca3b8bc3e7c15f06aee8b",
      "original_position" : 13,
      "path" : "src/net_processing.cpp",
      "position" : 131,
      "pull_request_review_id" : 192824459,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/248048711",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r249039245"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/249039245"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "We checked `state.IsInvalid()` a couple of lines earlier, so this addition is redundant.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-01-18T13:19:59Z",
      "diff_hunk" : "@@ -53,9 +53,8 @@ BOOST_FIXTURE_TEST_CASE(tx_mempool_reject_coinbase, TestChain100Setup)\n     BOOST_CHECK(state.IsInvalid());\n     BOOST_CHECK_EQUAL(state.GetRejectReason(), \"coinbase\");\n \n-    int nDoS;\n-    BOOST_CHECK_EQUAL(state.IsInvalid(nDoS), true);\n-    BOOST_CHECK_EQUAL(nDoS, 100);\n+    BOOST_CHECK_EQUAL(state.IsInvalid(), true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r249039245",
      "id" : 249039245,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0OTAzOTI0NQ==",
      "original_commit_id" : "a642744cc55816e3d816231fbe9352685ea72edb",
      "original_position" : 7,
      "path" : "src/test/txvalidation_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 194090637,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/249039245",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Started reviewing this, but IMO, the way this PR is structured makes it difficult to verify that it doesn't unintentionally change behavior.\r\n\r\nFWIW, I've had a go at redoing the patchset to try to make the (potential) functionality changes more clear: https://github.com/ajtowns/bitcoin/commits/201901-dosreasons\r\n\r\nThis has (I think) all the behaviour changes first:\r\n\r\n    d9451de0d0 drop obsolete comment\r\n    acdb469525 [refactor] stateDummy -> orphan_state\r\n    5cd7a4d338 [refactor] Use maybepunish etc\r\n    0d1d471eac [refactor] drop IsInvalid(nDoSOut)\r\n    a0776a5d8a set nDoS rather than bumping it\r\n    e0cff4e133 Clean up banning levels\r\n\r\nbefore introducing the new reason field, along with checks that the implied DoS value for each reason matches the actual DoS values presented/used:\r\n\r\n    89e8dea284 [refactor] Add useful-for-dos \"reason\" field to CValidationState\r\n\r\nwhich then allows dropping the instance variables:\r\n\r\n    27089e55be [refactor] Drop redundant nDoS, corruptionPossible, SetCorruptionPossible\r\n\r\nThen the code is changed to use reasons directly:\r\n\r\n    15d9023106 LookupBlockIndex -> CACHED_INVALID\r\n    519fb78934 CorruptionPossible -> TX_WITNESS_MUTATED\r\n    221d17f332 CorruptionPossible -> BLOCK_MUTATED\r\n    32747d0746 [refactor] Use Reasons directly instead of DoS codes\r\n\r\nAnd the now obsolete DoS/etc stuff is dropped:\r\n\r\n    4d110a59c6 [refactor] Prep for scripted-diff by removing some \\ns which annoy sed.\r\n    9a89a47257 scripted-diff: Remove DoS calls to CValidationState\r\n    327591b016 [refactor] Drop unused state.DoS(), state.GetDoS(), state.CorruptionPossible()\r\n\r\nThat leaves a couple more things:\r\n\r\n    94cf0deffb [refactor] Update some comments in validation.cpp as we arent doing DoS there\r\n    04c6b24a66 [refactor] swap if/else order\r\n    96f0ee075d remaining commits vs 94874ddfdf4ae9c4b10f3f91d5e3280e2c24c371\r\n\r\nbut finally ends up with the same code as this PR (minus the latest commit anyway).\r\n\r\nAnyway I think this approach might be easier to review? It could also allow splitting the PR into two -- one making the changes to DoS behaviour but not changing the way DoS works; followed by a second PR that actually adds the Reasons and refactors but doesn't change behaviour.\r\n\r\n(Proof of concept only: bunches of these commits should probably be combined, commit messages need improvement, and I think I lost a bunch of authorship info)\r\n\r\nEDIT: \r\n\r\nI've added an extra commit prior to the DoS->Invalid refactor, namely \"5b15205883 Allow use of state.Invalid() for all reasons\" that avoids assertions that Invalid() is only used for DoS-level-0 problems failing.\r\n\r\nThat just leaves one test failure in the intermediate commits; feature_block.py fails after the changing the DoS levels but before adding the \"reason\" code. I think this is due to lowering `bad-txns-inputs-missingorspent` from 100 to 0 with the tests still expecting a disconnect when that happens in a block. Adding the reasons fixes this because that includes code to update that problem from 0/TX_MISSING_INPUTS to 100/CONSENSUS when it affects a block rather than a loose transaction. (And similarly, the tests are adujsted to expect disconnects due to premature coinbase spends, but that functionality only occurs as part of the 0/TX to 100/CONS step)",
      "created_at" : "2019-01-18T13:42:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-455549857",
      "id" : 455549857,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15141",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ1NTU0OTg1Nw==",
      "updated_at" : "2019-01-21T13:19:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/455549857",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks all for the review so far!\r\n\r\nI'd started taking a stab at rewriting this; I'll continue with my approach to see how it ends up but @ajtowns thank you for your help -- @ryanofsky if you have any thoughts on @ajtowns's rework please let me know, happy to adapt his breakdown and include here if that approach looks good.",
      "created_at" : "2019-01-18T14:46:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-455570076",
      "id" : 455570076,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15141",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ1NTU3MDA3Ng==",
      "updated_at" : "2019-01-18T14:46:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/455570076",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> @ryanofsky if you have any thoughts on @ajtowns's rework please let me know\r\n\r\nTook a quick look, and I think ajtowns's refactor is great. It's a slightly different approach than I suggested in that the 32747d0746d91a8f63e39cedfb232f8c36b33bc6 commit which starts using reason codes is done all at once instead of incrementally as reasons are added, so it requires a little bit of grepping to verify, but this is easy to do and I think it's a huge improvement.\r\n\r\nI think it would be best to use ajtown's branch here, unless you've done a lot of work on your own already or see problems I'm missing.",
      "created_at" : "2019-01-18T15:12:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-455578840",
      "id" : 455578840,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15141",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ1NTU3ODg0MA==",
      "updated_at" : "2019-01-18T15:12:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/455578840",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK, I will take a closer look once the code is updated per comments above I guess.",
      "created_at" : "2019-01-21T19:16:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-456175021",
      "id" : 456175021,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15141",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ1NjE3NTAyMQ==",
      "updated_at" : "2019-01-21T19:16:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/456175021",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I have redone this along the lines of @ajtowns branch, and cleaned up each commit (I think!) so that each one should be logically correct, pass tests, etc.\r\n\r\nI've saved the original version of this PR here: https://github.com/sdaftuar/bitcoin/commits/15141.original\r\n\r\nThe diff between the two is pretty small (just some formatting changes that were getting tedious to resolve, and I removed a couple lines that some reviewers had commented on as being unnecessary):\r\n\r\n```\r\ndiff --git a/src/consensus/tx_verify.cpp b/src/consensus/tx_verify.cpp\r\nindex fb04c1c0abf..a7b31ff7c56 100644\r\n--- a/src/consensus/tx_verify.cpp\r\n+++ b/src/consensus/tx_verify.cpp\r\n@@ -221,8 +221,7 @@ bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, c\r\n \r\n         // If prev is coinbase, check that it's matured\r\n         if (coin.IsCoinBase() && nSpendHeight - coin.nHeight < COINBASE_MATURITY) {\r\n-            return state.Invalid(ValidationInvalidReason::TX_MISSING_INPUTS, false,\r\n-                REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\r\n+            return state.Invalid(ValidationInvalidReason::TX_MISSING_INPUTS, false, REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\r\n                 strprintf(\"tried to spend coinbase at depth %d\", nSpendHeight - coin.nHeight));\r\n         }\r\n \r\ndiff --git a/src/consensus/validation.h b/src/consensus/validation.h\r\nindex daf8b9b87cc..09a5630a4f3 100644\r\n--- a/src/consensus/validation.h\r\n+++ b/src/consensus/validation.h\r\n@@ -81,8 +81,8 @@ private:\r\n public:\r\n     CValidationState() : mode(MODE_VALID), reason(ValidationInvalidReason::NONE), chRejectCode(0) {}\r\n     bool Invalid(ValidationInvalidReason reasonIn, bool ret = false,\r\n-             unsigned int chRejectCodeIn=0, const std::string &strRejectReasonIn=\"\",\r\n-             const std::string &strDebugMessageIn=\"\") {\r\n+            unsigned int chRejectCodeIn=0, const std::string &strRejectReasonIn=\"\",\r\n+            const std::string &strDebugMessageIn=\"\") {\r\n         reason = reasonIn;\r\n         chRejectCode = chRejectCodeIn;\r\n         strRejectReason = strRejectReasonIn;\r\ndiff --git a/src/test/txvalidation_tests.cpp b/src/test/txvalidation_tests.cpp\r\nindex 00fd7fef12a..aa30129361f 100644\r\n--- a/src/test/txvalidation_tests.cpp\r\n+++ b/src/test/txvalidation_tests.cpp\r\n@@ -52,8 +52,6 @@ BOOST_FIXTURE_TEST_CASE(tx_mempool_reject_coinbase, TestChain100Setup)\r\n     // Check that the validation state reflects the unsuccessful attempt.\r\n     BOOST_CHECK(state.IsInvalid());\r\n     BOOST_CHECK_EQUAL(state.GetRejectReason(), \"coinbase\");\r\n-\r\n-    BOOST_CHECK_EQUAL(state.IsInvalid(), true);\r\n     BOOST_CHECK(state.GetReason() == ValidationInvalidReason::CONSENSUS);\r\n }\r\n \r\ndiff --git a/src/validation.cpp b/src/validation.cpp\r\nindex e1f562ffbfd..20759bf96e7 100644\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -888,7 +888,7 @@ static bool AcceptToMemoryPoolWorker(const CChainParams& chainparams, CTxMemPool\r\n                 !CheckInputs(tx, stateDummy, view, true, scriptVerifyFlags & ~SCRIPT_VERIFY_CLEANSTACK, true, false, txdata)) {\r\n                 // Only the witness is missing, so the transaction itself may be fine.\r\n                 state.Invalid(ValidationInvalidReason::TX_WITNESS_MUTATED, false,\r\n-                          state.GetRejectCode(), state.GetRejectReason(), state.GetDebugMessage());\r\n+                        state.GetRejectCode(), state.GetRejectReason(), state.GetDebugMessage());\r\n             }\r\n             return false; // state filled in by CheckInputs\r\n         }\r\n@@ -1980,7 +1980,7 @@ bool CChainState::ConnectBlock(const CBlock& block, CValidationState& state, CBl\r\n                     // CheckTxInputs may return MISSING_INPUTS but we can't return that, as\r\n                     // it's not defined for a block, so we reset the reason flag to CONSENSUS here.\r\n                     state.Invalid(ValidationInvalidReason::CONSENSUS, false,\r\n-                              state.GetRejectCode(), state.GetRejectReason(), state.GetDebugMessage());\r\n+                            state.GetRejectCode(), state.GetRejectReason(), state.GetDebugMessage());\r\n                 }\r\n                 return error(\"%s: Consensus::CheckTxInputs: %s, %s\", __func__, tx.GetHash().ToString(), FormatStateMessage(state));\r\n             }\r\n@@ -3341,8 +3341,6 @@ static bool ContextualCheckBlock(const CBlock& block, CValidationState& state, c\r\n     // the block hash, so we couldn't mark the block as permanently\r\n     // failed).\r\n     if (GetBlockWeight(block) > MAX_BLOCK_WEIGHT) {\r\n-        // We can call this a consensus failure as any data-providers who provided\r\n-        // us with witness data can be expected to support SegWit validation.\r\n         return state.Invalid(ValidationInvalidReason::CONSENSUS, false, REJECT_INVALID, \"bad-blk-weight\", strprintf(\"%s : weight limit failed\", __func__));\r\n     }\r\n```\r\n\r\nAlso if this version is not actually easier to review I'm happy to go back to the original or try another approach.",
      "created_at" : "2019-01-24T18:26:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-457304487",
      "id" : 457304487,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15141",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ1NzMwNDQ4Nw==",
      "updated_at" : "2019-01-24T18:26:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/457304487",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r250800408"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/250800408"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Check transactions just logs a message\" (94c2cdb88049af5283a7c1f52ea6e52ac2946686)\r\n\r\nCould you update the commit message to say whether this commit changes behavior at all, and what the motivation is? At first glance it seems like this probably doesn't change behavior, and the only motivation is to simplify code. But I could easily be missing something.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-01-24T22:22:42Z",
      "diff_hunk" : "@@ -3116,10 +3116,12 @@ bool CheckBlock(const CBlock& block, CValidationState& state, const Consensus::P\n             return state.DoS(100, false, REJECT_INVALID, \"bad-cb-multiple\", false, \"more than one coinbase\");\n \n     // Check transactions\n-    for (const auto& tx : block.vtx)\n-        if (!CheckTransaction(*tx, state, true))\n-            return state.Invalid(false, state.GetRejectCode(), state.GetRejectReason(),\n-                                 strprintf(\"Transaction check failed (tx hash %s) %s\", tx->GetHash().ToString(), state.GetDebugMessage()));\n+    for (const auto& tx : block.vtx) {\n+        if (!CheckTransaction(*tx, state, true)) {\n+            LogPrintf(\"Transaction check failed (tx hash %s) %s\\n\", tx->GetHash().ToString(), state.GetDebugMessage());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r250800408",
      "id" : 250800408,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1MDgwMDQwOA==",
      "original_commit_id" : "94c2cdb88049af5283a7c1f52ea6e52ac2946686",
      "original_position" : 10,
      "path" : "src/validation.cpp",
      "position" : 407,
      "pull_request_review_id" : 196279133,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/250800408",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r250802869"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/250802869"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[refactor] Use maybepunish etc\" (8226bed4191a50129ac6fdbcb8fad5e1c6b7cacd)\r\n\r\nNote: This acquires lock recursively in `PeerLogicValidation::BlockChecked`. Seems fine, but just wanted to note it wasn't happening before.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-01-24T22:31:03Z",
      "diff_hunk" : "@@ -816,6 +816,23 @@ void Misbehaving(NodeId pnode, int howmuch, const std::string& message) EXCLUSIV\n         LogPrint(BCLog::NET, \"%s: %s peer=%d (%d -> %d)%s\\n\", __func__, state->name, pnode, state->nMisbehavior-howmuch, state->nMisbehavior, message_prefixed);\n }\n \n+static bool MayResultInDisconnect(const CValidationState& state, bool via_compact_block) {\n+    return (state.GetDoS() > 0);\n+}\n+\n+static bool MaybePunishNode(NodeId nodeid, const CValidationState& state, bool via_compact_block, const std::string& message = \"\") {\n+    int nDoS = state.GetDoS();\n+    if (nDoS > 0 && !via_compact_block) {\n+         LOCK(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r250802869",
      "id" : 250802869,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1MDgwMjg2OQ==",
      "original_commit_id" : "8226bed4191a50129ac6fdbcb8fad5e1c6b7cacd",
      "original_position" : 11,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 196279133,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/250802869",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r250807170"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/250807170"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[refactor] Update some comments in validation.cpp as we arent doing DoS there\" (e534b0b78bec49750421b5f52012b857df197e24)\r\n\r\nWhy remove this comment entirely?",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-01-24T22:46:54Z",
      "diff_hunk" : "@@ -1414,21 +1414,16 @@ bool CheckInputs(const CTransaction& tx, CValidationState &state, const CCoinsVi\n                         // Check whether the failure was caused by a\n                         // non-mandatory script verification check, such as\n                         // non-standard DER encodings or non-null dummy\n-                        // arguments; if so, don't trigger DoS protection to\n-                        // avoid splitting the network between upgraded and\n-                        // non-upgraded nodes.\n+                        // arguments; if so, ensure we return NOT_STANDARD\n+                        // instead of CONSENSUS to avoid downstream users\n+                        // splitting the network between upgraded and\n+                        // non-upgraded nodes by banning CONSENSUS-failing\n+                        // data providers.\n                         CScriptCheck check2(coin.out, tx, i,\n                                 flags & ~STANDARD_NOT_MANDATORY_VERIFY_FLAGS, cacheSigStore, &txdata);\n                         if (check2())\n                             return state.Invalid(ValidationInvalidReason::TX_NOT_STANDARD, false, REJECT_NONSTANDARD, strprintf(\"non-mandatory-script-verify-flag (%s)\", ScriptErrorString(check.GetScriptError())));\n                     }\n-                    // Failures of other flags indicate a transaction that is\n-                    // invalid in new blocks, e.g. an invalid P2SH. We DoS ban\n-                    // such nodes as they are not following the protocol. That\n-                    // said during an upgrade careful thought should be taken\n-                    // as to the correct behavior - we may want to continue\n-                    // peering with non-upgraded nodes even after soft-fork\n-                    // super-majority signaling has occurred.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r250807170",
      "id" : 250807170,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1MDgwNzE3MA==",
      "original_commit_id" : "e534b0b78bec49750421b5f52012b857df197e24",
      "original_position" : 23,
      "path" : "src/validation.cpp",
      "position" : 240,
      "pull_request_review_id" : 196279133,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/250807170",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r251920734"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/251920734"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-01-29T16:50:51Z",
      "diff_hunk" : "@@ -3116,10 +3116,12 @@ bool CheckBlock(const CBlock& block, CValidationState& state, const Consensus::P\n             return state.DoS(100, false, REJECT_INVALID, \"bad-cb-multiple\", false, \"more than one coinbase\");\n \n     // Check transactions\n-    for (const auto& tx : block.vtx)\n-        if (!CheckTransaction(*tx, state, true))\n-            return state.Invalid(false, state.GetRejectCode(), state.GetRejectReason(),\n-                                 strprintf(\"Transaction check failed (tx hash %s) %s\", tx->GetHash().ToString(), state.GetDebugMessage()));\n+    for (const auto& tx : block.vtx) {\n+        if (!CheckTransaction(*tx, state, true)) {\n+            LogPrintf(\"Transaction check failed (tx hash %s) %s\\n\", tx->GetHash().ToString(), state.GetDebugMessage());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r251920734",
      "id" : 251920734,
      "in_reply_to_id" : 250800408,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1MTkyMDczNA==",
      "original_commit_id" : "94c2cdb88049af5283a7c1f52ea6e52ac2946686",
      "original_position" : 10,
      "path" : "src/validation.cpp",
      "position" : 407,
      "pull_request_review_id" : 197664334,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/251920734",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r251920815"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/251920815"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Updated with a new comment.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-01-29T16:51:03Z",
      "diff_hunk" : "@@ -1414,21 +1414,16 @@ bool CheckInputs(const CTransaction& tx, CValidationState &state, const CCoinsVi\n                         // Check whether the failure was caused by a\n                         // non-mandatory script verification check, such as\n                         // non-standard DER encodings or non-null dummy\n-                        // arguments; if so, don't trigger DoS protection to\n-                        // avoid splitting the network between upgraded and\n-                        // non-upgraded nodes.\n+                        // arguments; if so, ensure we return NOT_STANDARD\n+                        // instead of CONSENSUS to avoid downstream users\n+                        // splitting the network between upgraded and\n+                        // non-upgraded nodes by banning CONSENSUS-failing\n+                        // data providers.\n                         CScriptCheck check2(coin.out, tx, i,\n                                 flags & ~STANDARD_NOT_MANDATORY_VERIFY_FLAGS, cacheSigStore, &txdata);\n                         if (check2())\n                             return state.Invalid(ValidationInvalidReason::TX_NOT_STANDARD, false, REJECT_NONSTANDARD, strprintf(\"non-mandatory-script-verify-flag (%s)\", ScriptErrorString(check.GetScriptError())));\n                     }\n-                    // Failures of other flags indicate a transaction that is\n-                    // invalid in new blocks, e.g. an invalid P2SH. We DoS ban\n-                    // such nodes as they are not following the protocol. That\n-                    // said during an upgrade careful thought should be taken\n-                    // as to the correct behavior - we may want to continue\n-                    // peering with non-upgraded nodes even after soft-fork\n-                    // super-majority signaling has occurred.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r251920815",
      "id" : 251920815,
      "in_reply_to_id" : 250807170,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1MTkyMDgxNQ==",
      "original_commit_id" : "e534b0b78bec49750421b5f52012b857df197e24",
      "original_position" : 23,
      "path" : "src/validation.cpp",
      "position" : 240,
      "pull_request_review_id" : 197664436,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/251920815",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I addressed @ryanofsky's comments so far (which rewrote the git history, since one of the commit messages changed, so I also squashed in a comment change as well).  Previous version of this PR is now here: https://github.com/sdaftuar/bitcoin/commits/15141.1.",
      "created_at" : "2019-01-29T16:52:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-458617310",
      "id" : 458617310,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15141",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ1ODYxNzMxMA==",
      "updated_at" : "2019-01-29T16:52:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/458617310",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r252851518"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/252851518"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed in latest commit.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-01-31T21:40:20Z",
      "diff_hunk" : "@@ -30,32 +74,24 @@ class CValidationState {\n         MODE_INVALID, //!< network rule violation (DoS value may be set)\n         MODE_ERROR,   //!< run-time error\n     } mode;\n-    int nDoS;\n+    ValidationInvalidReason reason;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r252851518",
      "id" : 252851518,
      "in_reply_to_id" : 247634533,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1Mjg1MTUxOA==",
      "original_commit_id" : "94874ddfdf4ae9c4b10f3f91d5e3280e2c24c371",
      "original_position" : 56,
      "path" : "src/consensus/validation.h",
      "position" : null,
      "pull_request_review_id" : 198828305,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/252851518",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r252851556"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/252851556"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't really think \"confirmed transaction\" is any clearer than \"tx in the chain\" -- if anything, the latter seems more specific to me, as \"confirmed\" is a concept that only makes sense in the context of the chain that you're on, which \"tx in the chain\" is more explicit about.\r\n\r\nI'm going to leave this comment intact, pending other opinions.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-01-31T21:40:29Z",
      "diff_hunk" : "@@ -22,6 +22,50 @@ static const unsigned char REJECT_NONSTANDARD = 0x40;\n static const unsigned char REJECT_INSUFFICIENTFEE = 0x42;\n static const unsigned char REJECT_CHECKPOINT = 0x43;\n \n+/** A \"reason\" why something was invalid, suitable for determining whether the\n+  * provider of the object should be banned/ignored/disconnected/etc.\n+  * These are much more granular than the rejection codes, which may be more\n+  * useful for some other use-cases.\n+  */\n+enum class ValidationInvalidReason {\n+    // txn and blocks:\n+    NONE,                    //!< not actually invalid\n+    CONSENSUS,               //!< invalid by consensus rules (excluding any below reasons)\n+    /**\n+     * Invalid by a change to consensus rules more recent than SegWit.\n+     * Currently unused as there are no such consensus rule changes, and any download\n+     * sources realistically need to support SegWit in order to provide useful data,\n+     * so differentiating between always-invalid and invalid-by-pre-SegWit-soft-fork\n+     * is uninteresting.\n+     */\n+    RECENT_CONSENSUS_CHANGE,\n+    CACHED_INVALID,          //!< this object was cached as being invalid, but we don't know why\n+    // Only blocks (or headers):\n+    BLOCK_INVALID_HEADER,    //!< invalid proof of work or time too old\n+    BLOCK_MUTATED,           //!< the block's data didn't match the data committed to by the PoW\n+    BLOCK_MISSING_PREV,      //!< We don't have the previous block the checked one is built on\n+    BLOCK_INVALID_PREV,      //!< A block this one builds on is invalid\n+    BLOCK_BAD_TIME,          //!< block timestamp was > 2 hours in the future (or our clock is bad)\n+    BLOCK_CHECKPOINT,        //!< the block failed to meet one of our checkpoints\n+    // Only loose txn:\n+    TX_NOT_STANDARD,          //!< didn't meet our local policy rules\n+    TX_MISSING_INPUTS,        //!< a transaction was missing some of its inputs (or its inputs were spent at < coinbase maturity height)\n+    /**\n+     * Transaction might be missing a witness, have a witness prior to SegWit\n+     * activation, or witness may have been malleated (which includes\n+     * non-standard witnesses).\n+     */\n+    TX_WITNESS_MUTATED,\n+    /**\n+     * Tx already in mempool or conflicts with a tx in the chain",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r252851556",
      "id" : 252851556,
      "in_reply_to_id" : 247638591,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1Mjg1MTU1Ng==",
      "original_commit_id" : "94874ddfdf4ae9c4b10f3f91d5e3280e2c24c371",
      "original_position" : 39,
      "path" : "src/consensus/validation.h",
      "position" : 40,
      "pull_request_review_id" : 198828356,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/252851556",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This needs a simple rebase, but can I get concept ACK/NACK from more reviewers on whether the reworked form of this PR (which broke things up into many more commits) is preferable compared to the original formulation? ",
      "created_at" : "2019-02-08T17:57:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-461890129",
      "id" : 461890129,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15141",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ2MTg5MDEyOQ==",
      "updated_at" : "2019-02-08T17:57:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/461890129",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I haven't reviewed the last few commits yet (only up to \"[refactor] Use Reasons directly instead of DoS codes\"), but so far the structure is very clear. Concept ACK on that.",
      "created_at" : "2019-02-08T18:43:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-461903853",
      "id" : 461903853,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15141",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ2MTkwMzg1Mw==",
      "updated_at" : "2019-02-08T18:43:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/461903853",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks @sipa.  Rebased.  Prior version is here: [15141.2](https://github.com/sdaftuar/bitcoin/commits/15141.2)",
      "created_at" : "2019-02-08T19:31:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-461919044",
      "id" : 461919044,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15141",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ2MTkxOTA0NA==",
      "updated_at" : "2019-02-08T19:43:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/461919044",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "One overall comment: it seems there is a subset of `ValidationInvalidReason`s that are valid for transactions, and another subset that is valid for blocks. Perhaps it's useful to have functions to test whether one belongs to those sets, and invoke those functions in assertions after validation returns in their respective contexts. That seems a bit more future-proof than just having comments of the form \"CheckTxInputs may return MISSING_INPUTS but we can't return that\". It would make me also a bit more comfortable with changes to checks from `CorruptionPossible()` to testing for a specific invalidity reason (assuming we know `TX_WITNESS_MUTATED` in the only tx-valid corruptionpossible one, and `BLOCK_MUTATED` the only block-valid corruptionpossible one).",
      "created_at" : "2019-02-08T20:19:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-461933821",
      "id" : 461933821,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15141",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ2MTkzMzgyMQ==",
      "updated_at" : "2019-02-08T20:19:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/461933821",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255232967"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/255232967"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think the current wording is fine.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-02-08T20:56:59Z",
      "diff_hunk" : "@@ -22,6 +22,50 @@ static const unsigned char REJECT_NONSTANDARD = 0x40;\n static const unsigned char REJECT_INSUFFICIENTFEE = 0x42;\n static const unsigned char REJECT_CHECKPOINT = 0x43;\n \n+/** A \"reason\" why something was invalid, suitable for determining whether the\n+  * provider of the object should be banned/ignored/disconnected/etc.\n+  * These are much more granular than the rejection codes, which may be more\n+  * useful for some other use-cases.\n+  */\n+enum class ValidationInvalidReason {\n+    // txn and blocks:\n+    NONE,                    //!< not actually invalid\n+    CONSENSUS,               //!< invalid by consensus rules (excluding any below reasons)\n+    /**\n+     * Invalid by a change to consensus rules more recent than SegWit.\n+     * Currently unused as there are no such consensus rule changes, and any download\n+     * sources realistically need to support SegWit in order to provide useful data,\n+     * so differentiating between always-invalid and invalid-by-pre-SegWit-soft-fork\n+     * is uninteresting.\n+     */\n+    RECENT_CONSENSUS_CHANGE,\n+    CACHED_INVALID,          //!< this object was cached as being invalid, but we don't know why\n+    // Only blocks (or headers):\n+    BLOCK_INVALID_HEADER,    //!< invalid proof of work or time too old\n+    BLOCK_MUTATED,           //!< the block's data didn't match the data committed to by the PoW\n+    BLOCK_MISSING_PREV,      //!< We don't have the previous block the checked one is built on\n+    BLOCK_INVALID_PREV,      //!< A block this one builds on is invalid\n+    BLOCK_BAD_TIME,          //!< block timestamp was > 2 hours in the future (or our clock is bad)\n+    BLOCK_CHECKPOINT,        //!< the block failed to meet one of our checkpoints\n+    // Only loose txn:\n+    TX_NOT_STANDARD,          //!< didn't meet our local policy rules\n+    TX_MISSING_INPUTS,        //!< a transaction was missing some of its inputs (or its inputs were spent at < coinbase maturity height)\n+    /**\n+     * Transaction might be missing a witness, have a witness prior to SegWit\n+     * activation, or witness may have been malleated (which includes\n+     * non-standard witnesses).\n+     */\n+    TX_WITNESS_MUTATED,\n+    /**\n+     * Tx already in mempool or conflicts with a tx in the chain",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255232967",
      "id" : 255232967,
      "in_reply_to_id" : 247638591,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1NTIzMjk2Nw==",
      "original_commit_id" : "94874ddfdf4ae9c4b10f3f91d5e3280e2c24c371",
      "original_position" : 39,
      "path" : "src/consensus/validation.h",
      "position" : 40,
      "pull_request_review_id" : 201781962,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/255232967",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255233378"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/255233378"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nit: you can use `name(std::move(addrNameIn))` here to avoid a copy.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-02-08T20:58:36Z",
      "diff_hunk" : "@@ -349,7 +349,16 @@ struct CNodeState {\n \n     TxDownloadState m_tx_download;\n \n-    CNodeState(CAddress addrIn, std::string addrNameIn) : address(addrIn), name(addrNameIn) {\n+    //! Whether this peer is an inbound connection\n+    bool m_is_inbound;\n+\n+    //! Whether this peer is a manual connection\n+    bool m_is_manual_connection;\n+\n+    CNodeState(CAddress addrIn, std::string addrNameIn, bool is_inbound, bool is_manual) :\n+        address(addrIn), name(addrNameIn), m_is_inbound(is_inbound),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255233378",
      "id" : 255233378,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1NTIzMzM3OA==",
      "original_commit_id" : "7682566acd7b04aee9425772823e77f230268ad8",
      "original_position" : 12,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 201781962,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/255233378",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255235104"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/255235104"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The comment says \"disconnect\", but the DoS score will also cause a ban here. Is that intentional? (it seems it's retaining existing behavior, so I assume it is).",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-02-08T21:05:05Z",
      "diff_hunk" : "@@ -947,6 +956,106 @@ void Misbehaving(NodeId pnode, int howmuch, const std::string& message) EXCLUSIV\n         LogPrint(BCLog::NET, \"%s: %s peer=%d (%d -> %d)%s\\n\", __func__, state->name, pnode, state->nMisbehavior-howmuch, state->nMisbehavior, message_prefixed);\n }\n \n+/**\n+ * Returns true if the given validation state result may result in us banning/disconnecting a peer\n+ * which provided such an object. This is used to determine whether to relay transactions to\n+ * whitelisted peers, preventing us from relaying things which would result in them disconnecting\n+ * us.\n+ */\n+static bool MayResultInDisconnect(const CValidationState& state, bool via_compact_block) {\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        return false;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        // Blocks (or headers) invalid for one of the above reasons may not be\n+        // knowable to a high-bandwidth compact block peer, prior to relay.\n+        // Headers that are invalid for reasons that should be known prior to\n+        // block validation -- such as bad proof of work, too-early-time, or\n+        // building off an invalid or missing block -- are punished regardless\n+        // (see below).\n+        return !via_compact_block;\n+    case ValidationInvalidReason::BLOCK_INVALID_HEADER:\n+    case ValidationInvalidReason::BLOCK_CHECKPOINT:\n+    case ValidationInvalidReason::BLOCK_INVALID_PREV:\n+    case ValidationInvalidReason::BLOCK_MISSING_PREV:\n+        return true;\n+    // Conflicting (but not necessarily invalid) data or different policy:\n+    case ValidationInvalidReason::RECENT_CONSENSUS_CHANGE:\n+    case ValidationInvalidReason::BLOCK_BAD_TIME:\n+    case ValidationInvalidReason::TX_NOT_STANDARD:\n+    case ValidationInvalidReason::TX_MISSING_INPUTS:\n+    case ValidationInvalidReason::TX_WITNESS_MUTATED:\n+    case ValidationInvalidReason::TX_CONFLICT:\n+    case ValidationInvalidReason::TX_MEMPOOL_POLICY:\n+        return false;\n+    }\n+    return false;\n+}\n+\n+//! Returns true if the peer was punished (probably disconnected)\n+static bool MaybePunishNode(NodeId nodeid, const CValidationState& state, bool via_compact_block, const std::string& message = \"\") {\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        break;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+        if (!via_compact_block) {\n+            LOCK(cs_main);\n+            Misbehaving(nodeid, 100, message);\n+            return true;\n+        }\n+        break;\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        {\n+            LOCK(cs_main);\n+            CNodeState *node_state = State(nodeid);\n+            if (node_state == nullptr) {\n+                break;\n+            }\n+\n+            // Disconnect outbound (but not inbound) peers if on an invalid chain.\n+            // Exempt HB compact block peers and manual connections.\n+            if (!via_compact_block && !node_state->m_is_inbound && !node_state->m_is_manual_connection) {\n+                Misbehaving(nodeid, 100, message);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255235104",
      "id" : 255235104,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1NTIzNTEwNA==",
      "original_commit_id" : "7682566acd7b04aee9425772823e77f230268ad8",
      "original_position" : 95,
      "path" : "src/net_processing.cpp",
      "position" : 78,
      "pull_request_review_id" : 201781962,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/255235104",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255342147"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/255342147"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is actually a behavior change from existing behavior, but hopefully a relatively harmless one.  Here's the relevant snippet from master:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/2945492424934fa360f86b116184ee8e34f19d0a/src/net_processing.cpp#L1552-L1585\r\n\r\nIt's a bit hard to decipher because of the multiple layers going on here, but basically `punish_duplicate_invalid` is only set to true for outbound and non-manual peers relaying us headers outside of HB compact block mode, and `nDoS` is set to 0 for the cached-invalid case:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/2945492424934fa360f86b116184ee8e34f19d0a/src/validation.cpp#L3341-L3357\r\n\r\nSo this does indeed result in a ban rather than just a disconnect for an outbound peer that announces an invalid header.  If there's no reason that this is materially worse than other ban behaviors that exist, then I think I'd prefer to stick with this behavior change for now, and try to improve ban-behavior globally after this PR (which should become much easier, now that banning is contained to one place in the code in a more understandable way).\r\n\r\nI can update the comment though to make this clearer.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-02-10T15:28:09Z",
      "diff_hunk" : "@@ -947,6 +956,106 @@ void Misbehaving(NodeId pnode, int howmuch, const std::string& message) EXCLUSIV\n         LogPrint(BCLog::NET, \"%s: %s peer=%d (%d -> %d)%s\\n\", __func__, state->name, pnode, state->nMisbehavior-howmuch, state->nMisbehavior, message_prefixed);\n }\n \n+/**\n+ * Returns true if the given validation state result may result in us banning/disconnecting a peer\n+ * which provided such an object. This is used to determine whether to relay transactions to\n+ * whitelisted peers, preventing us from relaying things which would result in them disconnecting\n+ * us.\n+ */\n+static bool MayResultInDisconnect(const CValidationState& state, bool via_compact_block) {\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        return false;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        // Blocks (or headers) invalid for one of the above reasons may not be\n+        // knowable to a high-bandwidth compact block peer, prior to relay.\n+        // Headers that are invalid for reasons that should be known prior to\n+        // block validation -- such as bad proof of work, too-early-time, or\n+        // building off an invalid or missing block -- are punished regardless\n+        // (see below).\n+        return !via_compact_block;\n+    case ValidationInvalidReason::BLOCK_INVALID_HEADER:\n+    case ValidationInvalidReason::BLOCK_CHECKPOINT:\n+    case ValidationInvalidReason::BLOCK_INVALID_PREV:\n+    case ValidationInvalidReason::BLOCK_MISSING_PREV:\n+        return true;\n+    // Conflicting (but not necessarily invalid) data or different policy:\n+    case ValidationInvalidReason::RECENT_CONSENSUS_CHANGE:\n+    case ValidationInvalidReason::BLOCK_BAD_TIME:\n+    case ValidationInvalidReason::TX_NOT_STANDARD:\n+    case ValidationInvalidReason::TX_MISSING_INPUTS:\n+    case ValidationInvalidReason::TX_WITNESS_MUTATED:\n+    case ValidationInvalidReason::TX_CONFLICT:\n+    case ValidationInvalidReason::TX_MEMPOOL_POLICY:\n+        return false;\n+    }\n+    return false;\n+}\n+\n+//! Returns true if the peer was punished (probably disconnected)\n+static bool MaybePunishNode(NodeId nodeid, const CValidationState& state, bool via_compact_block, const std::string& message = \"\") {\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        break;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+        if (!via_compact_block) {\n+            LOCK(cs_main);\n+            Misbehaving(nodeid, 100, message);\n+            return true;\n+        }\n+        break;\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        {\n+            LOCK(cs_main);\n+            CNodeState *node_state = State(nodeid);\n+            if (node_state == nullptr) {\n+                break;\n+            }\n+\n+            // Disconnect outbound (but not inbound) peers if on an invalid chain.\n+            // Exempt HB compact block peers and manual connections.\n+            if (!via_compact_block && !node_state->m_is_inbound && !node_state->m_is_manual_connection) {\n+                Misbehaving(nodeid, 100, message);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255342147",
      "id" : 255342147,
      "in_reply_to_id" : 255235104,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1NTM0MjE0Nw==",
      "original_commit_id" : "7682566acd7b04aee9425772823e77f230268ad8",
      "original_position" : 95,
      "path" : "src/net_processing.cpp",
      "position" : 78,
      "pull_request_review_id" : 201908267,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/255342147",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255688905"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/255688905"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Clean up banning levels\" (96cedc8d0c0e3ad279bc2223a7fc3185b17ebde5)\r\n\r\nNote: this is \"Txn with empty vin/vout or null prevouts move from 10 DoS points to 100\"",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-02-11T20:55:41Z",
      "diff_hunk" : "@@ -160,9 +160,9 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state, bool fChe\n {\n     // Basic checks that don't depend on any context\n     if (tx.vin.empty())\n-        return state.DoS(10, false, REJECT_INVALID, \"bad-txns-vin-empty\");\n+        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-vin-empty\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255688905",
      "id" : 255688905,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1NTY4ODkwNQ==",
      "original_commit_id" : "96cedc8d0c0e3ad279bc2223a7fc3185b17ebde5",
      "original_position" : 5,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : null,
      "pull_request_review_id" : 202332478,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/255688905",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255688944"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/255688944"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Clean up banning levels\" (96cedc8d0c0e3ad279bc2223a7fc3185b17ebde5)\r\n\r\nNote: this is \"Txn with empty vin/vout or null prevouts move from 10 DoS points to 100\"",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-02-11T20:55:46Z",
      "diff_hunk" : "@@ -160,9 +160,9 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state, bool fChe\n {\n     // Basic checks that don't depend on any context\n     if (tx.vin.empty())\n-        return state.DoS(10, false, REJECT_INVALID, \"bad-txns-vin-empty\");\n+        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-vin-empty\");\n     if (tx.vout.empty())\n-        return state.DoS(10, false, REJECT_INVALID, \"bad-txns-vout-empty\");\n+        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-vout-empty\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255688944",
      "id" : 255688944,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1NTY4ODk0NA==",
      "original_commit_id" : "96cedc8d0c0e3ad279bc2223a7fc3185b17ebde5",
      "original_position" : 8,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : null,
      "pull_request_review_id" : 202332478,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/255688944",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255689044"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/255689044"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Clean up banning levels\" (96cedc8d0c0e3ad279bc2223a7fc3185b17ebde5)\r\n\r\nNote: this is \"Txn with empty vin/vout or null prevouts move from 10 DoS points to 100\"",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-02-11T20:56:02Z",
      "diff_hunk" : "@@ -199,7 +199,7 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state, bool fChe\n     {\n         for (const auto& txin : tx.vin)\n             if (txin.prevout.IsNull())\n-                return state.DoS(10, false, REJECT_INVALID, \"bad-txns-prevout-null\");\n+                return state.DoS(100, false, REJECT_INVALID, \"bad-txns-prevout-null\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255689044",
      "id" : 255689044,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1NTY4OTA0NA==",
      "original_commit_id" : "96cedc8d0c0e3ad279bc2223a7fc3185b17ebde5",
      "original_position" : 17,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : null,
      "pull_request_review_id" : 202332478,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/255689044",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255689172"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/255689172"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Clean up banning levels\" (96cedc8d0c0e3ad279bc2223a7fc3185b17ebde5)\r\n\r\nNote: this is \"Inclusion of a premature coinbase spend now results in a ban\"",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-02-11T20:56:24Z",
      "diff_hunk" : "@@ -221,8 +221,8 @@ bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, c\n \n         // If prev is coinbase, check that it's matured\n         if (coin.IsCoinBase() && nSpendHeight - coin.nHeight < COINBASE_MATURITY) {\n-            return state.Invalid(false,\n-                REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\n+            return state.DoS(100, false,\n+                REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\", false,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255689172",
      "id" : 255689172,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1NTY4OTE3Mg==",
      "original_commit_id" : "96cedc8d0c0e3ad279bc2223a7fc3185b17ebde5",
      "original_position" : 28,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : null,
      "pull_request_review_id" : 202332478,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/255689172",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255689323"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/255689323"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Clean up banning levels\" (96cedc8d0c0e3ad279bc2223a7fc3185b17ebde5)\r\n\r\nNote: this is \"Loose transactions with a dependency loop now result in a ban instead of 10 DoS points\"",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-02-11T20:56:51Z",
      "diff_hunk" : "@@ -763,7 +763,7 @@ static bool AcceptToMemoryPoolWorker(const CChainParams& chainparams, CTxMemPool\n             const uint256 &hashAncestor = ancestorIt->GetTx().GetHash();\n             if (setConflicts.count(hashAncestor))\n             {\n-                return state.DoS(10, false,\n+                return state.DoS(100, false,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255689323",
      "id" : 255689323,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1NTY4OTMyMw==",
      "original_commit_id" : "96cedc8d0c0e3ad279bc2223a7fc3185b17ebde5",
      "original_position" : 5,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 202332478,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/255689323",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255689428"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/255689428"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Clean up banning levels\" (96cedc8d0c0e3ad279bc2223a7fc3185b17ebde5)\r\n\r\nNote: this is \"Proof of work failure moves from 50 DoS points to a ban\"",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-02-11T20:57:10Z",
      "diff_hunk" : "@@ -3061,7 +3061,7 @@ static bool CheckBlockHeader(const CBlockHeader& block, CValidationState& state,\n {\n     // Check proof of work matches claimed amount\n     if (fCheckPOW && !CheckProofOfWork(block.GetHash(), block.nBits, consensusParams))\n-        return state.DoS(50, false, REJECT_INVALID, \"high-hash\", false, \"proof of work failed\");\n+        return state.DoS(100, false, REJECT_INVALID, \"high-hash\", false, \"proof of work failed\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255689428",
      "id" : 255689428,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1NTY4OTQyOA==",
      "original_commit_id" : "96cedc8d0c0e3ad279bc2223a7fc3185b17ebde5",
      "original_position" : 14,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 202332478,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/255689428",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255689613"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/255689613"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Clean up banning levels\" (96cedc8d0c0e3ad279bc2223a7fc3185b17ebde5)\r\n\r\nNote: this is \"Blocks with timestamps under MTP now result in a ban\"",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-02-11T20:57:39Z",
      "diff_hunk" : "@@ -3230,7 +3230,7 @@ static bool ContextualCheckBlockHeader(const CBlockHeader& block, CValidationSta\n \n     // Check timestamp against prev\n     if (block.GetBlockTime() <= pindexPrev->GetMedianTimePast())\n-        return state.Invalid(false, REJECT_INVALID, \"time-too-old\", \"block's timestamp is too early\");\n+        return state.DoS(100, false, REJECT_INVALID, \"time-too-old\", false, \"block's timestamp is too early\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255689613",
      "id" : 255689613,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1NTY4OTYxMw==",
      "original_commit_id" : "96cedc8d0c0e3ad279bc2223a7fc3185b17ebde5",
      "original_position" : 23,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 202332478,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/255689613",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255689820"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/255689820"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Clean up banning levels\" (96cedc8d0c0e3ad279bc2223a7fc3185b17ebde5)\r\n\r\nNote: this is \"Any pre-segwit soft-fork errors (ie all soft-fork errors) now result in a ban\"",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-02-11T20:58:17Z",
      "diff_hunk" : "@@ -3241,7 +3241,7 @@ static bool ContextualCheckBlockHeader(const CBlockHeader& block, CValidationSta\n     if((block.nVersion < 2 && nHeight >= consensusParams.BIP34Height) ||\n        (block.nVersion < 3 && nHeight >= consensusParams.BIP66Height) ||\n        (block.nVersion < 4 && nHeight >= consensusParams.BIP65Height))\n-            return state.Invalid(false, REJECT_OBSOLETE, strprintf(\"bad-version(0x%08x)\", block.nVersion),\n+            return state.DoS(100, false, REJECT_OBSOLETE, strprintf(\"bad-version(0x%08x)\", block.nVersion), false,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255689820",
      "id" : 255689820,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1NTY4OTgyMA==",
      "original_commit_id" : "96cedc8d0c0e3ad279bc2223a7fc3185b17ebde5",
      "original_position" : 32,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 202332478,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/255689820",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255690104"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/255690104"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Clean up banning levels\" (96cedc8d0c0e3ad279bc2223a7fc3185b17ebde5)\r\n\r\nNote: this is \"Inclusion of non-final transactions in a block now results in a ban\"",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-02-11T20:59:01Z",
      "diff_hunk" : "@@ -3271,7 +3271,7 @@ static bool ContextualCheckBlock(const CBlock& block, CValidationState& state, c\n     // Check that all transactions are finalized\n     for (const auto& tx : block.vtx) {\n         if (!IsFinalTx(*tx, nHeight, nLockTimeCutoff)) {\n-            return state.DoS(10, false, REJECT_INVALID, \"bad-txns-nonfinal\", false, \"non-final transaction\");\n+            return state.DoS(100, false, REJECT_INVALID, \"bad-txns-nonfinal\", false, \"non-final transaction\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255690104",
      "id" : 255690104,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1NTY5MDEwNA==",
      "original_commit_id" : "96cedc8d0c0e3ad279bc2223a7fc3185b17ebde5",
      "original_position" : 41,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 202332478,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/255690104",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255696468"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/255696468"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[refactor] Add useful-for-dos \"reason\" field to CValidationState\" (ac3873e2a92457995f7e5a9e5fc24352af360c6b)\r\n\r\nPassing state.GetDoS() instead of 0 might make it clearer behavior isn't changing.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-02-11T21:17:58Z",
      "diff_hunk" : "@@ -901,7 +901,8 @@ static bool AcceptToMemoryPoolWorker(const CChainParams& chainparams, CTxMemPool\n             if (!tx.HasWitness() && CheckInputs(tx, stateDummy, view, true, scriptVerifyFlags & ~(SCRIPT_VERIFY_WITNESS | SCRIPT_VERIFY_CLEANSTACK), true, false, txdata) &&\n                 !CheckInputs(tx, stateDummy, view, true, scriptVerifyFlags & ~SCRIPT_VERIFY_CLEANSTACK, true, false, txdata)) {\n                 // Only the witness is missing, so the transaction itself may be fine.\n-                state.SetCorruptionPossible();\n+                state.DoS(0, ValidationInvalidReason::TX_WITNESS_MUTATED, false,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255696468",
      "id" : 255696468,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1NTY5NjQ2OA==",
      "original_commit_id" : "ac3873e2a92457995f7e5a9e5fc24352af360c6b",
      "original_position" : 169,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 202332478,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/255696468",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255702109"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/255702109"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"TX_MISSING_INPUTS now has a DoS score of 0\" (bee1d4f5e29c8c447ac47a608240b38216750072)\r\n\r\nNot sure, but it seems like it might be nice to have a comment here saying TX_MISSING_INPUTS reason will change to CONSENSUS if the transaction is included in a block, and lead to a higher dos score in that case.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-02-11T21:33:17Z",
      "diff_hunk" : "@@ -137,14 +137,14 @@ class CValidationState {\n         case ValidationInvalidReason::BLOCK_INVALID_HEADER:\n         case ValidationInvalidReason::BLOCK_CHECKPOINT:\n         case ValidationInvalidReason::BLOCK_INVALID_PREV:\n-        case ValidationInvalidReason::TX_MISSING_INPUTS:\n             return 100;\n         case ValidationInvalidReason::BLOCK_MISSING_PREV:\n             return 10;\n         case ValidationInvalidReason::CACHED_INVALID:\n         case ValidationInvalidReason::RECENT_CONSENSUS_CHANGE:\n         case ValidationInvalidReason::BLOCK_BAD_TIME:\n         case ValidationInvalidReason::TX_NOT_STANDARD:\n+        case ValidationInvalidReason::TX_MISSING_INPUTS:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255702109",
      "id" : 255702109,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1NTcwMjEwOQ==",
      "original_commit_id" : "bee1d4f5e29c8c447ac47a608240b38216750072",
      "original_position" : 12,
      "path" : "src/consensus/validation.h",
      "position" : null,
      "pull_request_review_id" : 202332478,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/255702109",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255708805"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/255708805"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"LookupBlockIndex -> CACHED_INVALID\" (c558ebaa6d02154eaf762a28d2a7e954acee0661)\r\n\r\nNote: behavior should be unchanged here because ProcessNewBlockHeaders calls AcceptBlockHeader which sets CACHED_INVALID if a header is already known and has BLOCK_FAILED_MASK is set. If the first invalid header is invalid for a different reason the check shouldn't trigger either before or after this change.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-02-11T21:52:40Z",
      "diff_hunk" : "@@ -1558,7 +1558,7 @@ bool static ProcessHeadersMessage(CNode *pfrom, CConnman *connman, const std::ve\n     CBlockHeader first_invalid_header;\n     if (!ProcessNewBlockHeaders(headers, state, chainparams, &pindexLast, &first_invalid_header)) {\n         if (state.IsInvalid()) {\n-            if (punish_duplicate_invalid && LookupBlockIndex(first_invalid_header.GetHash())) {\n+            if (punish_duplicate_invalid && state.GetReason() == ValidationInvalidReason::CACHED_INVALID) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255708805",
      "id" : 255708805,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1NTcwODgwNQ==",
      "original_commit_id" : "c558ebaa6d02154eaf762a28d2a7e954acee0661",
      "original_position" : 5,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 202332478,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/255708805",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255712280"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/255712280"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255235104\r\n\r\nNote: Thread pertains to commit \"Fix handling of invalid headers\" (9dd6fc18658b36b63b9f264676ac484879597b83)\r\n",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-02-11T22:02:20Z",
      "diff_hunk" : "@@ -947,6 +956,106 @@ void Misbehaving(NodeId pnode, int howmuch, const std::string& message) EXCLUSIV\n         LogPrint(BCLog::NET, \"%s: %s peer=%d (%d -> %d)%s\\n\", __func__, state->name, pnode, state->nMisbehavior-howmuch, state->nMisbehavior, message_prefixed);\n }\n \n+/**\n+ * Returns true if the given validation state result may result in us banning/disconnecting a peer\n+ * which provided such an object. This is used to determine whether to relay transactions to\n+ * whitelisted peers, preventing us from relaying things which would result in them disconnecting\n+ * us.\n+ */\n+static bool MayResultInDisconnect(const CValidationState& state, bool via_compact_block) {\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        return false;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        // Blocks (or headers) invalid for one of the above reasons may not be\n+        // knowable to a high-bandwidth compact block peer, prior to relay.\n+        // Headers that are invalid for reasons that should be known prior to\n+        // block validation -- such as bad proof of work, too-early-time, or\n+        // building off an invalid or missing block -- are punished regardless\n+        // (see below).\n+        return !via_compact_block;\n+    case ValidationInvalidReason::BLOCK_INVALID_HEADER:\n+    case ValidationInvalidReason::BLOCK_CHECKPOINT:\n+    case ValidationInvalidReason::BLOCK_INVALID_PREV:\n+    case ValidationInvalidReason::BLOCK_MISSING_PREV:\n+        return true;\n+    // Conflicting (but not necessarily invalid) data or different policy:\n+    case ValidationInvalidReason::RECENT_CONSENSUS_CHANGE:\n+    case ValidationInvalidReason::BLOCK_BAD_TIME:\n+    case ValidationInvalidReason::TX_NOT_STANDARD:\n+    case ValidationInvalidReason::TX_MISSING_INPUTS:\n+    case ValidationInvalidReason::TX_WITNESS_MUTATED:\n+    case ValidationInvalidReason::TX_CONFLICT:\n+    case ValidationInvalidReason::TX_MEMPOOL_POLICY:\n+        return false;\n+    }\n+    return false;\n+}\n+\n+//! Returns true if the peer was punished (probably disconnected)\n+static bool MaybePunishNode(NodeId nodeid, const CValidationState& state, bool via_compact_block, const std::string& message = \"\") {\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        break;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+        if (!via_compact_block) {\n+            LOCK(cs_main);\n+            Misbehaving(nodeid, 100, message);\n+            return true;\n+        }\n+        break;\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        {\n+            LOCK(cs_main);\n+            CNodeState *node_state = State(nodeid);\n+            if (node_state == nullptr) {\n+                break;\n+            }\n+\n+            // Disconnect outbound (but not inbound) peers if on an invalid chain.\n+            // Exempt HB compact block peers and manual connections.\n+            if (!via_compact_block && !node_state->m_is_inbound && !node_state->m_is_manual_connection) {\n+                Misbehaving(nodeid, 100, message);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255712280",
      "id" : 255712280,
      "in_reply_to_id" : 255235104,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1NTcxMjI4MA==",
      "original_commit_id" : "7682566acd7b04aee9425772823e77f230268ad8",
      "original_position" : 95,
      "path" : "src/net_processing.cpp",
      "position" : 78,
      "pull_request_review_id" : 202332478,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/255712280",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r256052181"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/256052181"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[refactor] Use Reasons directly instead of DoS codes\" (346699322ca820c5d95c255386df3ce1fb1f3d11)\r\n\r\nWould be good to add a comment here saying that if this function is changed, then the MayResultInDisconnect function above should also be updated.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-02-12T17:02:16Z",
      "diff_hunk" : "@@ -947,17 +947,86 @@ void Misbehaving(NodeId pnode, int howmuch, const std::string& message) EXCLUSIV\n         LogPrint(BCLog::NET, \"%s: %s peer=%d (%d -> %d)%s\\n\", __func__, state->name, pnode, state->nMisbehavior-howmuch, state->nMisbehavior, message_prefixed);\n }\n \n+/**\n+ * Returns true if the given validation state result may result in us banning/disconnecting a peer\n+ * which provided such an object. This is used to determine whether to relay transactions to\n+ * whitelisted peers, preventing us from relaying things which would result in them disconnecting\n+ * us.\n+ */\n static bool MayResultInDisconnect(const CValidationState& state, bool via_compact_block) {\n-    assert(!via_compact_block);\n-    return (state.GetDoS() > 0);\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        return false;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        // Blocks (or headers) invalid for one of the above reasons may not be\n+        // knowable to a high-bandwidth compact block peer, prior to relay.\n+        // Headers that are invalid for reasons that should be known prior to\n+        // block validation -- such as bad proof of work, too-early-time, or\n+        // building off an invalid or missing block -- are punished regardless\n+        // (see below).\n+        return !via_compact_block;\n+    case ValidationInvalidReason::BLOCK_INVALID_HEADER:\n+    case ValidationInvalidReason::BLOCK_CHECKPOINT:\n+    case ValidationInvalidReason::BLOCK_INVALID_PREV:\n+    case ValidationInvalidReason::BLOCK_MISSING_PREV:\n+        return true;\n+    // Conflicting (but not necessarily invalid) data or different policy:\n+    case ValidationInvalidReason::RECENT_CONSENSUS_CHANGE:\n+    case ValidationInvalidReason::BLOCK_BAD_TIME:\n+    case ValidationInvalidReason::TX_NOT_STANDARD:\n+    case ValidationInvalidReason::TX_MISSING_INPUTS:\n+    case ValidationInvalidReason::TX_WITNESS_MUTATED:\n+    case ValidationInvalidReason::TX_CONFLICT:\n+    case ValidationInvalidReason::TX_MEMPOOL_POLICY:\n+        return false;\n+    }\n+    return false;\n }\n \n+//! Returns true if the peer was punished (probably disconnected)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r256052181",
      "id" : 256052181,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1NjA1MjE4MQ==",
      "original_commit_id" : "346699322ca820c5d95c255386df3ce1fb1f3d11",
      "original_position" : 45,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 202790593,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/256052181",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r256054235"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/256054235"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[refactor] Use Reasons directly instead of DoS codes\" (346699322ca820c5d95c255386df3ce1fb1f3d11)\r\n\r\nThis change seems like a step backwards to me. It seems cleaner and less error prone to keep MaybePunishNode and MayResultInDisconnect both implemented in terms of the same nice `GetDoSForReason` function added in ac3873e2a92457995f7e5a9e5fc24352af360c6b (renamed to `GetDos` in 6e3332a76f227b6dd6068513807934fd1b3d936b), than to duplicate the logic between these two functions and duplicate LOCK/Misbehaving stuff within this function.\r\n\r\nI would drop this commit entirely. The only parts of it that seem worth keeping are the added function comments, and these would make more sense as part of 4159f7ca7b449195f0e8a3f67a4045409c703e9d which adds the functions. Keeping GetDos would also reduce the churn in this PR and simplify the later 8e4590e522d4903d970cdaafb95e4fdfccf792fb commit.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-02-12T17:07:07Z",
      "diff_hunk" : "@@ -947,17 +947,86 @@ void Misbehaving(NodeId pnode, int howmuch, const std::string& message) EXCLUSIV\n         LogPrint(BCLog::NET, \"%s: %s peer=%d (%d -> %d)%s\\n\", __func__, state->name, pnode, state->nMisbehavior-howmuch, state->nMisbehavior, message_prefixed);\n }\n \n+/**\n+ * Returns true if the given validation state result may result in us banning/disconnecting a peer\n+ * which provided such an object. This is used to determine whether to relay transactions to\n+ * whitelisted peers, preventing us from relaying things which would result in them disconnecting\n+ * us.\n+ */\n static bool MayResultInDisconnect(const CValidationState& state, bool via_compact_block) {\n-    assert(!via_compact_block);\n-    return (state.GetDoS() > 0);\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        return false;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        // Blocks (or headers) invalid for one of the above reasons may not be\n+        // knowable to a high-bandwidth compact block peer, prior to relay.\n+        // Headers that are invalid for reasons that should be known prior to\n+        // block validation -- such as bad proof of work, too-early-time, or\n+        // building off an invalid or missing block -- are punished regardless\n+        // (see below).\n+        return !via_compact_block;\n+    case ValidationInvalidReason::BLOCK_INVALID_HEADER:\n+    case ValidationInvalidReason::BLOCK_CHECKPOINT:\n+    case ValidationInvalidReason::BLOCK_INVALID_PREV:\n+    case ValidationInvalidReason::BLOCK_MISSING_PREV:\n+        return true;\n+    // Conflicting (but not necessarily invalid) data or different policy:\n+    case ValidationInvalidReason::RECENT_CONSENSUS_CHANGE:\n+    case ValidationInvalidReason::BLOCK_BAD_TIME:\n+    case ValidationInvalidReason::TX_NOT_STANDARD:\n+    case ValidationInvalidReason::TX_MISSING_INPUTS:\n+    case ValidationInvalidReason::TX_WITNESS_MUTATED:\n+    case ValidationInvalidReason::TX_CONFLICT:\n+    case ValidationInvalidReason::TX_MEMPOOL_POLICY:\n+        return false;\n+    }\n+    return false;\n }\n \n+//! Returns true if the peer was punished (probably disconnected)\n static bool MaybePunishNode(NodeId nodeid, const CValidationState& state, bool via_compact_block, const std::string& message = \"\") {\n-    int nDoS = state.GetDoS();\n-    if (nDoS > 0 && !via_compact_block) {\n-         LOCK(cs_main);\n-         Misbehaving(nodeid, nDoS, message);\n-         return true;\n+    switch (state.GetReason()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r256054235",
      "id" : 256054235,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1NjA1NDIzNQ==",
      "original_commit_id" : "346699322ca820c5d95c255386df3ce1fb1f3d11",
      "original_position" : 52,
      "path" : "src/net_processing.cpp",
      "position" : 55,
      "pull_request_review_id" : 202790593,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/256054235",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r256061290"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/256061290"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[refactor] Use Reasons directly instead of DoS codes\" (346699322ca820c5d95c255386df3ce1fb1f3d11)\r\n\r\nIt would be clearer to write \"may result in a peer banning/disconnecting us\" than \"may result in us banning/disconnecting a peer.\" Otherwise the next sentence makes less sense, and the overall comment is confusing about how the function is used.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-02-12T17:24:15Z",
      "diff_hunk" : "@@ -947,17 +947,86 @@ void Misbehaving(NodeId pnode, int howmuch, const std::string& message) EXCLUSIV\n         LogPrint(BCLog::NET, \"%s: %s peer=%d (%d -> %d)%s\\n\", __func__, state->name, pnode, state->nMisbehavior-howmuch, state->nMisbehavior, message_prefixed);\n }\n \n+/**\n+ * Returns true if the given validation state result may result in us banning/disconnecting a peer",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r256061290",
      "id" : 256061290,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1NjA2MTI5MA==",
      "original_commit_id" : "346699322ca820c5d95c255386df3ce1fb1f3d11",
      "original_position" : 5,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 202790593,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/256061290",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r256077494"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/256077494"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/15141#discussion_r247737022\r\n\r\n> I'll rework this...\r\n\r\nThis is resolved now?",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-02-12T18:03:59Z",
      "diff_hunk" : "@@ -1453,6 +1529,7 @@ bool static ProcessHeadersMessage(CNode *pfrom, CConnman *connman, const std::ve\n                 // etc), and not just the duplicate-invalid case.\n                 pfrom->fDisconnect = true;\n             }\n+            MaybePunishNode(pfrom->GetId(), state, /*via_compact_block*/ false, \"invalid header received\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r256077494",
      "id" : 256077494,
      "in_reply_to_id" : 247737022,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1NjA3NzQ5NA==",
      "original_commit_id" : "94874ddfdf4ae9c4b10f3f91d5e3280e2c24c371",
      "original_position" : 131,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 202790593,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/256077494",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r256081557"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/256081557"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[refactor] Use Reasons directly instead of DoS codes\" (346699322ca820c5d95c255386df3ce1fb1f3d11)\r\n\r\nNote: \"elsewhere\" refers to the CACHED_INVALID check in ProcessHeadersMessage added in earlier commit \"LookupBlockIndex -> CACHED_INVALID\" (c558ebaa6d02154eaf762a28d2a7e954acee0661).\r\n\r\nI would suggest clarifying this, but this is all replaced in the next commit \"Fix handling of invalid headers\" (9dd6fc18658b36b63b9f264676ac484879597b83), so it doesn't matter much.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-02-12T18:14:47Z",
      "diff_hunk" : "@@ -947,17 +947,86 @@ void Misbehaving(NodeId pnode, int howmuch, const std::string& message) EXCLUSIV\n         LogPrint(BCLog::NET, \"%s: %s peer=%d (%d -> %d)%s\\n\", __func__, state->name, pnode, state->nMisbehavior-howmuch, state->nMisbehavior, message_prefixed);\n }\n \n+/**\n+ * Returns true if the given validation state result may result in us banning/disconnecting a peer\n+ * which provided such an object. This is used to determine whether to relay transactions to\n+ * whitelisted peers, preventing us from relaying things which would result in them disconnecting\n+ * us.\n+ */\n static bool MayResultInDisconnect(const CValidationState& state, bool via_compact_block) {\n-    assert(!via_compact_block);\n-    return (state.GetDoS() > 0);\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        return false;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        // Blocks (or headers) invalid for one of the above reasons may not be\n+        // knowable to a high-bandwidth compact block peer, prior to relay.\n+        // Headers that are invalid for reasons that should be known prior to\n+        // block validation -- such as bad proof of work, too-early-time, or\n+        // building off an invalid or missing block -- are punished regardless\n+        // (see below).\n+        return !via_compact_block;\n+    case ValidationInvalidReason::BLOCK_INVALID_HEADER:\n+    case ValidationInvalidReason::BLOCK_CHECKPOINT:\n+    case ValidationInvalidReason::BLOCK_INVALID_PREV:\n+    case ValidationInvalidReason::BLOCK_MISSING_PREV:\n+        return true;\n+    // Conflicting (but not necessarily invalid) data or different policy:\n+    case ValidationInvalidReason::RECENT_CONSENSUS_CHANGE:\n+    case ValidationInvalidReason::BLOCK_BAD_TIME:\n+    case ValidationInvalidReason::TX_NOT_STANDARD:\n+    case ValidationInvalidReason::TX_MISSING_INPUTS:\n+    case ValidationInvalidReason::TX_WITNESS_MUTATED:\n+    case ValidationInvalidReason::TX_CONFLICT:\n+    case ValidationInvalidReason::TX_MEMPOOL_POLICY:\n+        return false;\n+    }\n+    return false;\n }\n \n+//! Returns true if the peer was punished (probably disconnected)\n static bool MaybePunishNode(NodeId nodeid, const CValidationState& state, bool via_compact_block, const std::string& message = \"\") {\n-    int nDoS = state.GetDoS();\n-    if (nDoS > 0 && !via_compact_block) {\n-         LOCK(cs_main);\n-         Misbehaving(nodeid, nDoS, message);\n-         return true;\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        break;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+        if (!via_compact_block) {\n+            LOCK(cs_main);\n+            Misbehaving(nodeid, 100, message);\n+            return true;\n+        }\n+        break;\n+    // Handled elsewhere for now",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r256081557",
      "id" : 256081557,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1NjA4MTU1Nw==",
      "original_commit_id" : "346699322ca820c5d95c255386df3ce1fb1f3d11",
      "original_position" : 64,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 202790593,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/256081557",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r256089801"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/256089801"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Fix handling of invalid headers\" (9dd6fc18658b36b63b9f264676ac484879597b83)\r\n\r\nIt would be nice to keep more of this comment, like the high-level goal of freeing outbound slots, and other parts if they are still accurate. It might also be good to keep a TODO about how we could \"improve ban-behavior\" here as mentioned in https://github.com/bitcoin/bitcoin/pull/15141#discussion_r255342147",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-02-12T18:35:29Z",
      "diff_hunk" : "@@ -1627,41 +1649,7 @@ bool static ProcessHeadersMessage(CNode *pfrom, CConnman *connman, const std::ve\n     CBlockHeader first_invalid_header;\n     if (!ProcessNewBlockHeaders(headers, state, chainparams, &pindexLast, &first_invalid_header)) {\n         if (state.IsInvalid()) {\n-            if (punish_duplicate_invalid && state.GetReason() == ValidationInvalidReason::CACHED_INVALID) {\n-                // Goal: don't allow outbound peers to use up our outbound",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r256089801",
      "id" : 256089801,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1NjA4OTgwMQ==",
      "original_commit_id" : "9dd6fc18658b36b63b9f264676ac484879597b83",
      "original_position" : 66,
      "path" : "src/net_processing.cpp",
      "position" : 157,
      "pull_request_review_id" : 202790593,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/256089801",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r256091126"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/256091126"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[refactor] Use Reasons directly instead of DoS codes\" (346699322ca820c5d95c255386df3ce1fb1f3d11)\r\n\r\nIs calling Misbehaving here when via_compact_block is true a change in behavior? Same question below for the BLOCK_MISSING_PREV case.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-02-12T18:38:32Z",
      "diff_hunk" : "@@ -947,17 +947,86 @@ void Misbehaving(NodeId pnode, int howmuch, const std::string& message) EXCLUSIV\n         LogPrint(BCLog::NET, \"%s: %s peer=%d (%d -> %d)%s\\n\", __func__, state->name, pnode, state->nMisbehavior-howmuch, state->nMisbehavior, message_prefixed);\n }\n \n+/**\n+ * Returns true if the given validation state result may result in us banning/disconnecting a peer\n+ * which provided such an object. This is used to determine whether to relay transactions to\n+ * whitelisted peers, preventing us from relaying things which would result in them disconnecting\n+ * us.\n+ */\n static bool MayResultInDisconnect(const CValidationState& state, bool via_compact_block) {\n-    assert(!via_compact_block);\n-    return (state.GetDoS() > 0);\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        return false;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        // Blocks (or headers) invalid for one of the above reasons may not be\n+        // knowable to a high-bandwidth compact block peer, prior to relay.\n+        // Headers that are invalid for reasons that should be known prior to\n+        // block validation -- such as bad proof of work, too-early-time, or\n+        // building off an invalid or missing block -- are punished regardless\n+        // (see below).\n+        return !via_compact_block;\n+    case ValidationInvalidReason::BLOCK_INVALID_HEADER:\n+    case ValidationInvalidReason::BLOCK_CHECKPOINT:\n+    case ValidationInvalidReason::BLOCK_INVALID_PREV:\n+    case ValidationInvalidReason::BLOCK_MISSING_PREV:\n+        return true;\n+    // Conflicting (but not necessarily invalid) data or different policy:\n+    case ValidationInvalidReason::RECENT_CONSENSUS_CHANGE:\n+    case ValidationInvalidReason::BLOCK_BAD_TIME:\n+    case ValidationInvalidReason::TX_NOT_STANDARD:\n+    case ValidationInvalidReason::TX_MISSING_INPUTS:\n+    case ValidationInvalidReason::TX_WITNESS_MUTATED:\n+    case ValidationInvalidReason::TX_CONFLICT:\n+    case ValidationInvalidReason::TX_MEMPOOL_POLICY:\n+        return false;\n+    }\n+    return false;\n }\n \n+//! Returns true if the peer was punished (probably disconnected)\n static bool MaybePunishNode(NodeId nodeid, const CValidationState& state, bool via_compact_block, const std::string& message = \"\") {\n-    int nDoS = state.GetDoS();\n-    if (nDoS > 0 && !via_compact_block) {\n-         LOCK(cs_main);\n-         Misbehaving(nodeid, nDoS, message);\n-         return true;\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        break;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+        if (!via_compact_block) {\n+            LOCK(cs_main);\n+            Misbehaving(nodeid, 100, message);\n+            return true;\n+        }\n+        break;\n+    // Handled elsewhere for now\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        break;\n+    case ValidationInvalidReason::BLOCK_INVALID_HEADER:\n+    case ValidationInvalidReason::BLOCK_CHECKPOINT:\n+    case ValidationInvalidReason::BLOCK_INVALID_PREV:\n+        {\n+            LOCK(cs_main);\n+            Misbehaving(nodeid, 100, message);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r256091126",
      "id" : 256091126,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1NjA5MTEyNg==",
      "original_commit_id" : "346699322ca820c5d95c255386df3ce1fb1f3d11",
      "original_position" : 72,
      "path" : "src/net_processing.cpp",
      "position" : 88,
      "pull_request_review_id" : 202790593,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/256091126",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r256093250"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/256093250"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[refactor] Use Reasons directly instead of DoS codes\" (346699322ca820c5d95c255386df3ce1fb1f3d11)\r\n\r\nIs returning true here a change in behavior? (via_compact_block is currently always false where this function is called)",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-02-12T18:43:46Z",
      "diff_hunk" : "@@ -947,17 +947,86 @@ void Misbehaving(NodeId pnode, int howmuch, const std::string& message) EXCLUSIV\n         LogPrint(BCLog::NET, \"%s: %s peer=%d (%d -> %d)%s\\n\", __func__, state->name, pnode, state->nMisbehavior-howmuch, state->nMisbehavior, message_prefixed);\n }\n \n+/**\n+ * Returns true if the given validation state result may result in us banning/disconnecting a peer\n+ * which provided such an object. This is used to determine whether to relay transactions to\n+ * whitelisted peers, preventing us from relaying things which would result in them disconnecting\n+ * us.\n+ */\n static bool MayResultInDisconnect(const CValidationState& state, bool via_compact_block) {\n-    assert(!via_compact_block);\n-    return (state.GetDoS() > 0);\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        return false;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        // Blocks (or headers) invalid for one of the above reasons may not be\n+        // knowable to a high-bandwidth compact block peer, prior to relay.\n+        // Headers that are invalid for reasons that should be known prior to\n+        // block validation -- such as bad proof of work, too-early-time, or\n+        // building off an invalid or missing block -- are punished regardless\n+        // (see below).\n+        return !via_compact_block;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r256093250",
      "id" : 256093250,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1NjA5MzI1MA==",
      "original_commit_id" : "346699322ca820c5d95c255386df3ce1fb1f3d11",
      "original_position" : 26,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 202790593,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/256093250",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r259070431"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/259070431"
         }
      },
      "author_association" : "MEMBER",
      "body" : "So this is only used for transaction relay, but this function is written to be more generic...  Perhaps I should limit the scope of this function to make it clear that transaction invalidity reasons are the only thing we would ask about?",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-02-21T19:01:49Z",
      "diff_hunk" : "@@ -947,17 +947,86 @@ void Misbehaving(NodeId pnode, int howmuch, const std::string& message) EXCLUSIV\n         LogPrint(BCLog::NET, \"%s: %s peer=%d (%d -> %d)%s\\n\", __func__, state->name, pnode, state->nMisbehavior-howmuch, state->nMisbehavior, message_prefixed);\n }\n \n+/**\n+ * Returns true if the given validation state result may result in us banning/disconnecting a peer\n+ * which provided such an object. This is used to determine whether to relay transactions to\n+ * whitelisted peers, preventing us from relaying things which would result in them disconnecting\n+ * us.\n+ */\n static bool MayResultInDisconnect(const CValidationState& state, bool via_compact_block) {\n-    assert(!via_compact_block);\n-    return (state.GetDoS() > 0);\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        return false;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        // Blocks (or headers) invalid for one of the above reasons may not be\n+        // knowable to a high-bandwidth compact block peer, prior to relay.\n+        // Headers that are invalid for reasons that should be known prior to\n+        // block validation -- such as bad proof of work, too-early-time, or\n+        // building off an invalid or missing block -- are punished regardless\n+        // (see below).\n+        return !via_compact_block;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r259070431",
      "id" : 259070431,
      "in_reply_to_id" : 256093250,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1OTA3MDQzMQ==",
      "original_commit_id" : "346699322ca820c5d95c255386df3ce1fb1f3d11",
      "original_position" : 26,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 206484611,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/259070431",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r259077758"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/259077758"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This appears to be correct to me. Obviously should update the comment to note this.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-02-21T19:21:02Z",
      "diff_hunk" : "@@ -947,6 +956,106 @@ void Misbehaving(NodeId pnode, int howmuch, const std::string& message) EXCLUSIV\n         LogPrint(BCLog::NET, \"%s: %s peer=%d (%d -> %d)%s\\n\", __func__, state->name, pnode, state->nMisbehavior-howmuch, state->nMisbehavior, message_prefixed);\n }\n \n+/**\n+ * Returns true if the given validation state result may result in us banning/disconnecting a peer\n+ * which provided such an object. This is used to determine whether to relay transactions to\n+ * whitelisted peers, preventing us from relaying things which would result in them disconnecting\n+ * us.\n+ */\n+static bool MayResultInDisconnect(const CValidationState& state, bool via_compact_block) {\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        return false;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        // Blocks (or headers) invalid for one of the above reasons may not be\n+        // knowable to a high-bandwidth compact block peer, prior to relay.\n+        // Headers that are invalid for reasons that should be known prior to\n+        // block validation -- such as bad proof of work, too-early-time, or\n+        // building off an invalid or missing block -- are punished regardless\n+        // (see below).\n+        return !via_compact_block;\n+    case ValidationInvalidReason::BLOCK_INVALID_HEADER:\n+    case ValidationInvalidReason::BLOCK_CHECKPOINT:\n+    case ValidationInvalidReason::BLOCK_INVALID_PREV:\n+    case ValidationInvalidReason::BLOCK_MISSING_PREV:\n+        return true;\n+    // Conflicting (but not necessarily invalid) data or different policy:\n+    case ValidationInvalidReason::RECENT_CONSENSUS_CHANGE:\n+    case ValidationInvalidReason::BLOCK_BAD_TIME:\n+    case ValidationInvalidReason::TX_NOT_STANDARD:\n+    case ValidationInvalidReason::TX_MISSING_INPUTS:\n+    case ValidationInvalidReason::TX_WITNESS_MUTATED:\n+    case ValidationInvalidReason::TX_CONFLICT:\n+    case ValidationInvalidReason::TX_MEMPOOL_POLICY:\n+        return false;\n+    }\n+    return false;\n+}\n+\n+//! Returns true if the peer was punished (probably disconnected)\n+static bool MaybePunishNode(NodeId nodeid, const CValidationState& state, bool via_compact_block, const std::string& message = \"\") {\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        break;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+        if (!via_compact_block) {\n+            LOCK(cs_main);\n+            Misbehaving(nodeid, 100, message);\n+            return true;\n+        }\n+        break;\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        {\n+            LOCK(cs_main);\n+            CNodeState *node_state = State(nodeid);\n+            if (node_state == nullptr) {\n+                break;\n+            }\n+\n+            // Disconnect outbound (but not inbound) peers if on an invalid chain.\n+            // Exempt HB compact block peers and manual connections.\n+            if (!via_compact_block && !node_state->m_is_inbound && !node_state->m_is_manual_connection) {\n+                Misbehaving(nodeid, 100, message);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r259077758",
      "id" : 259077758,
      "in_reply_to_id" : 255235104,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1OTA3Nzc1OA==",
      "original_commit_id" : "7682566acd7b04aee9425772823e77f230268ad8",
      "original_position" : 95,
      "path" : "src/net_processing.cpp",
      "position" : 78,
      "pull_request_review_id" : 206493873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/259077758",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r259101986"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/259101986"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Regarding BLOCK_INVALID_PREV, see above:\r\n\r\nhttps://github.com/bitcoin/bitcoin/pull/15141/files/3048533275227e67ce22931c6360513bddbd1767..346699322ca820c5d95c255386df3ce1fb1f3d11#r248002976\r\n\r\nFor the MISSING_PREV case, this is somewhat confusing but I don't think it's possible for via_compact_block to be true in that case, because we will send the peer a getheaders message if we receive a compact block announcement that doesn't connect, and not process the compact block in that case.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-02-21T20:28:31Z",
      "diff_hunk" : "@@ -947,17 +947,86 @@ void Misbehaving(NodeId pnode, int howmuch, const std::string& message) EXCLUSIV\n         LogPrint(BCLog::NET, \"%s: %s peer=%d (%d -> %d)%s\\n\", __func__, state->name, pnode, state->nMisbehavior-howmuch, state->nMisbehavior, message_prefixed);\n }\n \n+/**\n+ * Returns true if the given validation state result may result in us banning/disconnecting a peer\n+ * which provided such an object. This is used to determine whether to relay transactions to\n+ * whitelisted peers, preventing us from relaying things which would result in them disconnecting\n+ * us.\n+ */\n static bool MayResultInDisconnect(const CValidationState& state, bool via_compact_block) {\n-    assert(!via_compact_block);\n-    return (state.GetDoS() > 0);\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        return false;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        // Blocks (or headers) invalid for one of the above reasons may not be\n+        // knowable to a high-bandwidth compact block peer, prior to relay.\n+        // Headers that are invalid for reasons that should be known prior to\n+        // block validation -- such as bad proof of work, too-early-time, or\n+        // building off an invalid or missing block -- are punished regardless\n+        // (see below).\n+        return !via_compact_block;\n+    case ValidationInvalidReason::BLOCK_INVALID_HEADER:\n+    case ValidationInvalidReason::BLOCK_CHECKPOINT:\n+    case ValidationInvalidReason::BLOCK_INVALID_PREV:\n+    case ValidationInvalidReason::BLOCK_MISSING_PREV:\n+        return true;\n+    // Conflicting (but not necessarily invalid) data or different policy:\n+    case ValidationInvalidReason::RECENT_CONSENSUS_CHANGE:\n+    case ValidationInvalidReason::BLOCK_BAD_TIME:\n+    case ValidationInvalidReason::TX_NOT_STANDARD:\n+    case ValidationInvalidReason::TX_MISSING_INPUTS:\n+    case ValidationInvalidReason::TX_WITNESS_MUTATED:\n+    case ValidationInvalidReason::TX_CONFLICT:\n+    case ValidationInvalidReason::TX_MEMPOOL_POLICY:\n+        return false;\n+    }\n+    return false;\n }\n \n+//! Returns true if the peer was punished (probably disconnected)\n static bool MaybePunishNode(NodeId nodeid, const CValidationState& state, bool via_compact_block, const std::string& message = \"\") {\n-    int nDoS = state.GetDoS();\n-    if (nDoS > 0 && !via_compact_block) {\n-         LOCK(cs_main);\n-         Misbehaving(nodeid, nDoS, message);\n-         return true;\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        break;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+        if (!via_compact_block) {\n+            LOCK(cs_main);\n+            Misbehaving(nodeid, 100, message);\n+            return true;\n+        }\n+        break;\n+    // Handled elsewhere for now\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        break;\n+    case ValidationInvalidReason::BLOCK_INVALID_HEADER:\n+    case ValidationInvalidReason::BLOCK_CHECKPOINT:\n+    case ValidationInvalidReason::BLOCK_INVALID_PREV:\n+        {\n+            LOCK(cs_main);\n+            Misbehaving(nodeid, 100, message);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r259101986",
      "id" : 259101986,
      "in_reply_to_id" : 256091126,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1OTEwMTk4Ng==",
      "original_commit_id" : "346699322ca820c5d95c255386df3ce1fb1f3d11",
      "original_position" : 72,
      "path" : "src/net_processing.cpp",
      "position" : 88,
      "pull_request_review_id" : 206524394,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/259101986",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r261833651"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/261833651"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-02T16:58:25Z",
      "diff_hunk" : "@@ -349,7 +349,16 @@ struct CNodeState {\n \n     TxDownloadState m_tx_download;\n \n-    CNodeState(CAddress addrIn, std::string addrNameIn) : address(addrIn), name(addrNameIn) {\n+    //! Whether this peer is an inbound connection\n+    bool m_is_inbound;\n+\n+    //! Whether this peer is a manual connection\n+    bool m_is_manual_connection;\n+\n+    CNodeState(CAddress addrIn, std::string addrNameIn, bool is_inbound, bool is_manual) :\n+        address(addrIn), name(addrNameIn), m_is_inbound(is_inbound),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r261833651",
      "id" : 261833651,
      "in_reply_to_id" : 255233378,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MTgzMzY1MQ==",
      "original_commit_id" : "7682566acd7b04aee9425772823e77f230268ad8",
      "original_position" : 12,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 209875001,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/261833651",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r261833755"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/261833755"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed comment in latest commit.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-02T17:01:39Z",
      "diff_hunk" : "@@ -947,6 +956,106 @@ void Misbehaving(NodeId pnode, int howmuch, const std::string& message) EXCLUSIV\n         LogPrint(BCLog::NET, \"%s: %s peer=%d (%d -> %d)%s\\n\", __func__, state->name, pnode, state->nMisbehavior-howmuch, state->nMisbehavior, message_prefixed);\n }\n \n+/**\n+ * Returns true if the given validation state result may result in us banning/disconnecting a peer\n+ * which provided such an object. This is used to determine whether to relay transactions to\n+ * whitelisted peers, preventing us from relaying things which would result in them disconnecting\n+ * us.\n+ */\n+static bool MayResultInDisconnect(const CValidationState& state, bool via_compact_block) {\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        return false;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        // Blocks (or headers) invalid for one of the above reasons may not be\n+        // knowable to a high-bandwidth compact block peer, prior to relay.\n+        // Headers that are invalid for reasons that should be known prior to\n+        // block validation -- such as bad proof of work, too-early-time, or\n+        // building off an invalid or missing block -- are punished regardless\n+        // (see below).\n+        return !via_compact_block;\n+    case ValidationInvalidReason::BLOCK_INVALID_HEADER:\n+    case ValidationInvalidReason::BLOCK_CHECKPOINT:\n+    case ValidationInvalidReason::BLOCK_INVALID_PREV:\n+    case ValidationInvalidReason::BLOCK_MISSING_PREV:\n+        return true;\n+    // Conflicting (but not necessarily invalid) data or different policy:\n+    case ValidationInvalidReason::RECENT_CONSENSUS_CHANGE:\n+    case ValidationInvalidReason::BLOCK_BAD_TIME:\n+    case ValidationInvalidReason::TX_NOT_STANDARD:\n+    case ValidationInvalidReason::TX_MISSING_INPUTS:\n+    case ValidationInvalidReason::TX_WITNESS_MUTATED:\n+    case ValidationInvalidReason::TX_CONFLICT:\n+    case ValidationInvalidReason::TX_MEMPOOL_POLICY:\n+        return false;\n+    }\n+    return false;\n+}\n+\n+//! Returns true if the peer was punished (probably disconnected)\n+static bool MaybePunishNode(NodeId nodeid, const CValidationState& state, bool via_compact_block, const std::string& message = \"\") {\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        break;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+        if (!via_compact_block) {\n+            LOCK(cs_main);\n+            Misbehaving(nodeid, 100, message);\n+            return true;\n+        }\n+        break;\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        {\n+            LOCK(cs_main);\n+            CNodeState *node_state = State(nodeid);\n+            if (node_state == nullptr) {\n+                break;\n+            }\n+\n+            // Disconnect outbound (but not inbound) peers if on an invalid chain.\n+            // Exempt HB compact block peers and manual connections.\n+            if (!via_compact_block && !node_state->m_is_inbound && !node_state->m_is_manual_connection) {\n+                Misbehaving(nodeid, 100, message);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r261833755",
      "id" : 261833755,
      "in_reply_to_id" : 255235104,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MTgzMzc1NQ==",
      "original_commit_id" : "7682566acd7b04aee9425772823e77f230268ad8",
      "original_position" : 95,
      "path" : "src/net_processing.cpp",
      "position" : 78,
      "pull_request_review_id" : 209875107,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/261833755",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r261834407"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/261834407"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The goal of this work was to make net_processing aware of the actual reasons for validation failures, rather than just deal with opaque numbers instructing it to do something.\r\n\r\nIn the future, I'd like to make it so that we use more context to decide how to punish a peer.  One example is to differentiate inbound and outbound peer misbehaviors.  Another potential example is if we'd treat RECENT_CONSENSUS_CHANGE failures differently (ie after the next consensus change is implemented), and perhaps again we'd want to treat some peers differently than others.\r\n\r\nI do think that the `MayResultInDisconnect` logic was not very useful, and in the latest version I've vastly simplified things to reflect that we only use this for deciding whether to relay transactions from whitelisted peers.  So there should be much less code duplication now.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-02T17:19:31Z",
      "diff_hunk" : "@@ -947,17 +947,86 @@ void Misbehaving(NodeId pnode, int howmuch, const std::string& message) EXCLUSIV\n         LogPrint(BCLog::NET, \"%s: %s peer=%d (%d -> %d)%s\\n\", __func__, state->name, pnode, state->nMisbehavior-howmuch, state->nMisbehavior, message_prefixed);\n }\n \n+/**\n+ * Returns true if the given validation state result may result in us banning/disconnecting a peer\n+ * which provided such an object. This is used to determine whether to relay transactions to\n+ * whitelisted peers, preventing us from relaying things which would result in them disconnecting\n+ * us.\n+ */\n static bool MayResultInDisconnect(const CValidationState& state, bool via_compact_block) {\n-    assert(!via_compact_block);\n-    return (state.GetDoS() > 0);\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        return false;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        // Blocks (or headers) invalid for one of the above reasons may not be\n+        // knowable to a high-bandwidth compact block peer, prior to relay.\n+        // Headers that are invalid for reasons that should be known prior to\n+        // block validation -- such as bad proof of work, too-early-time, or\n+        // building off an invalid or missing block -- are punished regardless\n+        // (see below).\n+        return !via_compact_block;\n+    case ValidationInvalidReason::BLOCK_INVALID_HEADER:\n+    case ValidationInvalidReason::BLOCK_CHECKPOINT:\n+    case ValidationInvalidReason::BLOCK_INVALID_PREV:\n+    case ValidationInvalidReason::BLOCK_MISSING_PREV:\n+        return true;\n+    // Conflicting (but not necessarily invalid) data or different policy:\n+    case ValidationInvalidReason::RECENT_CONSENSUS_CHANGE:\n+    case ValidationInvalidReason::BLOCK_BAD_TIME:\n+    case ValidationInvalidReason::TX_NOT_STANDARD:\n+    case ValidationInvalidReason::TX_MISSING_INPUTS:\n+    case ValidationInvalidReason::TX_WITNESS_MUTATED:\n+    case ValidationInvalidReason::TX_CONFLICT:\n+    case ValidationInvalidReason::TX_MEMPOOL_POLICY:\n+        return false;\n+    }\n+    return false;\n }\n \n+//! Returns true if the peer was punished (probably disconnected)\n static bool MaybePunishNode(NodeId nodeid, const CValidationState& state, bool via_compact_block, const std::string& message = \"\") {\n-    int nDoS = state.GetDoS();\n-    if (nDoS > 0 && !via_compact_block) {\n-         LOCK(cs_main);\n-         Misbehaving(nodeid, nDoS, message);\n-         return true;\n+    switch (state.GetReason()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r261834407",
      "id" : 261834407,
      "in_reply_to_id" : 256054235,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MTgzNDQwNw==",
      "original_commit_id" : "346699322ca820c5d95c255386df3ce1fb1f3d11",
      "original_position" : 52,
      "path" : "src/net_processing.cpp",
      "position" : 55,
      "pull_request_review_id" : 209875773,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/261834407",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r261834566"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/261834566"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this PR is basically what that TODO is referring to!",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-02T17:24:53Z",
      "diff_hunk" : "@@ -1627,41 +1649,7 @@ bool static ProcessHeadersMessage(CNode *pfrom, CConnman *connman, const std::ve\n     CBlockHeader first_invalid_header;\n     if (!ProcessNewBlockHeaders(headers, state, chainparams, &pindexLast, &first_invalid_header)) {\n         if (state.IsInvalid()) {\n-            if (punish_duplicate_invalid && state.GetReason() == ValidationInvalidReason::CACHED_INVALID) {\n-                // Goal: don't allow outbound peers to use up our outbound",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r261834566",
      "id" : 261834566,
      "in_reply_to_id" : 256089801,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MTgzNDU2Ng==",
      "original_commit_id" : "9dd6fc18658b36b63b9f264676ac484879597b83",
      "original_position" : 66,
      "path" : "src/net_processing.cpp",
      "position" : 157,
      "pull_request_review_id" : 209875960,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/261834566",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r261834593"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/261834593"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Cleaned up in the latest version.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-02T17:26:01Z",
      "diff_hunk" : "@@ -947,17 +947,86 @@ void Misbehaving(NodeId pnode, int howmuch, const std::string& message) EXCLUSIV\n         LogPrint(BCLog::NET, \"%s: %s peer=%d (%d -> %d)%s\\n\", __func__, state->name, pnode, state->nMisbehavior-howmuch, state->nMisbehavior, message_prefixed);\n }\n \n+/**\n+ * Returns true if the given validation state result may result in us banning/disconnecting a peer\n+ * which provided such an object. This is used to determine whether to relay transactions to\n+ * whitelisted peers, preventing us from relaying things which would result in them disconnecting\n+ * us.\n+ */\n static bool MayResultInDisconnect(const CValidationState& state, bool via_compact_block) {\n-    assert(!via_compact_block);\n-    return (state.GetDoS() > 0);\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        return false;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        // Blocks (or headers) invalid for one of the above reasons may not be\n+        // knowable to a high-bandwidth compact block peer, prior to relay.\n+        // Headers that are invalid for reasons that should be known prior to\n+        // block validation -- such as bad proof of work, too-early-time, or\n+        // building off an invalid or missing block -- are punished regardless\n+        // (see below).\n+        return !via_compact_block;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r261834593",
      "id" : 261834593,
      "in_reply_to_id" : 256093250,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MTgzNDU5Mw==",
      "original_commit_id" : "346699322ca820c5d95c255386df3ce1fb1f3d11",
      "original_position" : 26,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 209875991,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/261834593",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r261834665"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/261834665"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is this still relevant after the latest changes?",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-02T17:27:59Z",
      "diff_hunk" : "@@ -947,17 +947,86 @@ void Misbehaving(NodeId pnode, int howmuch, const std::string& message) EXCLUSIV\n         LogPrint(BCLog::NET, \"%s: %s peer=%d (%d -> %d)%s\\n\", __func__, state->name, pnode, state->nMisbehavior-howmuch, state->nMisbehavior, message_prefixed);\n }\n \n+/**\n+ * Returns true if the given validation state result may result in us banning/disconnecting a peer\n+ * which provided such an object. This is used to determine whether to relay transactions to\n+ * whitelisted peers, preventing us from relaying things which would result in them disconnecting\n+ * us.\n+ */\n static bool MayResultInDisconnect(const CValidationState& state, bool via_compact_block) {\n-    assert(!via_compact_block);\n-    return (state.GetDoS() > 0);\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        return false;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        // Blocks (or headers) invalid for one of the above reasons may not be\n+        // knowable to a high-bandwidth compact block peer, prior to relay.\n+        // Headers that are invalid for reasons that should be known prior to\n+        // block validation -- such as bad proof of work, too-early-time, or\n+        // building off an invalid or missing block -- are punished regardless\n+        // (see below).\n+        return !via_compact_block;\n+    case ValidationInvalidReason::BLOCK_INVALID_HEADER:\n+    case ValidationInvalidReason::BLOCK_CHECKPOINT:\n+    case ValidationInvalidReason::BLOCK_INVALID_PREV:\n+    case ValidationInvalidReason::BLOCK_MISSING_PREV:\n+        return true;\n+    // Conflicting (but not necessarily invalid) data or different policy:\n+    case ValidationInvalidReason::RECENT_CONSENSUS_CHANGE:\n+    case ValidationInvalidReason::BLOCK_BAD_TIME:\n+    case ValidationInvalidReason::TX_NOT_STANDARD:\n+    case ValidationInvalidReason::TX_MISSING_INPUTS:\n+    case ValidationInvalidReason::TX_WITNESS_MUTATED:\n+    case ValidationInvalidReason::TX_CONFLICT:\n+    case ValidationInvalidReason::TX_MEMPOOL_POLICY:\n+        return false;\n+    }\n+    return false;\n }\n \n+//! Returns true if the peer was punished (probably disconnected)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r261834665",
      "id" : 261834665,
      "in_reply_to_id" : 256052181,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MTgzNDY2NQ==",
      "original_commit_id" : "346699322ca820c5d95c255386df3ce1fb1f3d11",
      "original_position" : 45,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 209876065,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/261834665",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I believe I addressed all of @sipa's comments.  I think I've addressed all the substantive comments from @ryanofsky, with the exception of moving around code between commits.  If reviewers would like to see the code moved to more accurately reflect each commit message, I can try, but I'd prefer to do something like that just before merge and have reviewers do a last verify that the overall diff is the same after the git history gets rewritten.",
      "created_at" : "2019-03-02T17:31:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-468941434",
      "id" : 468941434,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15141",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ2ODk0MTQzNA==",
      "updated_at" : "2019-03-02T17:31:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/468941434",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262350926"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262350926"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe this is covered already, but why is premature coinbase using `TX_MISSING_INPUTS` as the reason? It's not really missing.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-05T05:21:43Z",
      "diff_hunk" : "@@ -221,28 +221,27 @@ bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, c\n \n         // If prev is coinbase, check that it's matured\n         if (coin.IsCoinBase() && nSpendHeight - coin.nHeight < COINBASE_MATURITY) {\n-            return state.Invalid(false,\n-                REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\n+            return state.Invalid(ValidationInvalidReason::TX_MISSING_INPUTS, false, REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262350926",
      "id" : 262350926,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MjM1MDkyNg==",
      "original_commit_id" : "beb6a373bdfa91166c8872909ccce31c5b0d72a3",
      "original_position" : 70,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : null,
      "pull_request_review_id" : 210497110,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262350926",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "node_id" : "MDQ6VXNlcjI1MDIyNA==",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262351517"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262351517"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I understand if you don't wanna bother this late in the process, but it really seems like `ValidationResult` or `ValidationOutcome` would have been easier on the eyes, where this would be `SUCCESSFUL` or something.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-05T05:25:37Z",
      "diff_hunk" : "@@ -22,6 +22,76 @@ static const unsigned char REJECT_NONSTANDARD = 0x40;\n static const unsigned char REJECT_INSUFFICIENTFEE = 0x42;\n static const unsigned char REJECT_CHECKPOINT = 0x43;\n \n+/** A \"reason\" why something was invalid, suitable for determining whether the\n+  * provider of the object should be banned/ignored/disconnected/etc.\n+  * These are much more granular than the rejection codes, which may be more\n+  * useful for some other use-cases.\n+  */\n+enum class ValidationInvalidReason {\n+    // txn and blocks:\n+    NONE,                    //!< not actually invalid",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262351517",
      "id" : 262351517,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MjM1MTUxNw==",
      "original_commit_id" : "beb6a373bdfa91166c8872909ccce31c5b0d72a3",
      "original_position" : 11,
      "path" : "src/consensus/validation.h",
      "position" : 11,
      "pull_request_review_id" : 210497110,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262351517",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "node_id" : "MDQ6VXNlcjI1MDIyNA==",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262352042"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262352042"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Any particular reason why this isn't just `CNodeState(.., const std::string& addrNameIn, ...) : ..., name(addrNameIn)`?",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-05T05:29:13Z",
      "diff_hunk" : "@@ -349,7 +349,16 @@ struct CNodeState {\n \n     TxDownloadState m_tx_download;\n \n-    CNodeState(CAddress addrIn, std::string addrNameIn) : address(addrIn), name(addrNameIn) {\n+    //! Whether this peer is an inbound connection\n+    bool m_is_inbound;\n+\n+    //! Whether this peer is a manual connection\n+    bool m_is_manual_connection;\n+\n+    CNodeState(CAddress addrIn, std::string addrNameIn, bool is_inbound, bool is_manual) :\n+        address(addrIn), name(std::move(addrNameIn)), m_is_inbound(is_inbound),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262352042",
      "id" : 262352042,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MjM1MjA0Mg==",
      "original_commit_id" : "beb6a373bdfa91166c8872909ccce31c5b0d72a3",
      "original_position" : 12,
      "path" : "src/net_processing.cpp",
      "position" : 12,
      "pull_request_review_id" : 210497110,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262352042",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "node_id" : "MDQ6VXNlcjI1MDIyNA==",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262353524"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262353524"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You could shrink diff a few lines if you felt like it:\r\n```C++\r\nif (!state.IsInvalid() || !TxRelayMayResultInDisconnect(state)) {\r\n    LogPrintf(\"Force relaying tx %s from whitelisted peer=%d\\n\", tx.GetHash().ToString(), pfrom->GetId());\r\n    RelayTransaction(tx, connman);\r\n} else {\r\n    LogPrintf(\"Not relaying invalid transaction %s from whitelisted peer=%d (%s)\\n\", tx.GetHash().ToString(), pfrom->GetId(), FormatStateMessage(state));\r\n}\r\n```",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-05T05:39:18Z",
      "diff_hunk" : "@@ -2480,12 +2521,11 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 // Never relay transactions that we would assign a non-zero DoS\n                 // score for, as we expect peers to do the same with us in that\n                 // case.\n-                int nDoS = 0;\n-                if (!state.IsInvalid(nDoS) || nDoS == 0) {\n+                if (state.IsInvalid() && TxRelayMayResultInDisconnect(state)) {\n+                    LogPrintf(\"Not relaying invalid transaction %s from whitelisted peer=%d (%s)\\n\", tx.GetHash().ToString(), pfrom->GetId(), FormatStateMessage(state));\n+                } else {\n                     LogPrintf(\"Force relaying tx %s from whitelisted peer=%d\\n\", tx.GetHash().ToString(), pfrom->GetId());\n                     RelayTransaction(tx, connman);\n-                } else {\n-                    LogPrintf(\"Not relaying invalid transaction %s from whitelisted peer=%d (%s)\\n\", tx.GetHash().ToString(), pfrom->GetId(), FormatStateMessage(state));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262353524",
      "id" : 262353524,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MjM1MzUyNA==",
      "original_commit_id" : "beb6a373bdfa91166c8872909ccce31c5b0d72a3",
      "original_position" : 253,
      "path" : "src/net_processing.cpp",
      "position" : 265,
      "pull_request_review_id" : 210497110,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262353524",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "node_id" : "MDQ6VXNlcjI1MDIyNA==",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262354030"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262354030"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nit: you use `/*paramname=*/ value` above, but `/*paramname*/ value` here.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-05T05:42:37Z",
      "diff_hunk" : "@@ -2520,9 +2559,7 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 connman->PushMessage(pfrom, msgMaker.Make(NetMsgType::REJECT, strCommand, (unsigned char)state.GetRejectCode(),\n                                    state.GetRejectReason().substr(0, MAX_REJECT_MESSAGE_LENGTH), inv.hash));\n             }\n-            if (nDoS > 0) {\n-                Misbehaving(pfrom->GetId(), nDoS);\n-            }\n+            MaybePunishNode(pfrom->GetId(), state, /*via_compact_block*/ false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262354030",
      "id" : 262354030,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MjM1NDAzMA==",
      "original_commit_id" : "beb6a373bdfa91166c8872909ccce31c5b0d72a3",
      "original_position" : 274,
      "path" : "src/net_processing.cpp",
      "position" : 286,
      "pull_request_review_id" : 210497110,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262354030",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "node_id" : "MDQ6VXNlcjI1MDIyNA==",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262354087"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262354087"
         }
      },
      "author_association" : "MEMBER",
      "body" : "And here (`p=` vs `p`).",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-05T05:43:00Z",
      "diff_hunk" : "@@ -2552,14 +2589,8 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n         const CBlockIndex *pindex = nullptr;\n         CValidationState state;\n         if (!ProcessNewBlockHeaders({cmpctblock.header}, state, chainparams, &pindex)) {\n-            int nDoS;\n-            if (state.IsInvalid(nDoS)) {\n-                if (nDoS > 0) {\n-                    LOCK(cs_main);\n-                    Misbehaving(pfrom->GetId(), nDoS, strprintf(\"Peer %d sent us invalid header via cmpctblock\\n\", pfrom->GetId()));\n-                } else {\n-                    LogPrint(BCLog::NET, \"Peer %d sent us invalid header via cmpctblock\\n\", pfrom->GetId());\n-                }\n+            if (state.IsInvalid()) {\n+                MaybePunishNode(pfrom->GetId(), state, /*via_compact_block*/ true, \"invalid header via cmpctblock\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262354087",
      "id" : 262354087,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MjM1NDA4Nw==",
      "original_commit_id" : "beb6a373bdfa91166c8872909ccce31c5b0d72a3",
      "original_position" : 291,
      "path" : "src/net_processing.cpp",
      "position" : 303,
      "pull_request_review_id" : 210497110,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262354087",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "node_id" : "MDQ6VXNlcjI1MDIyNA==",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262354509"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262354509"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good question.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-05T05:45:14Z",
      "diff_hunk" : "@@ -716,27 +716,22 @@ static bool AcceptToMemoryPoolWorker(const CChainParams& chainparams, CTxMemPool\n                               fSpendsCoinbase, nSigOpsCost, lp);\n         unsigned int nSize = entry.GetTxSize();\n \n-        // Check that the transaction doesn't have an excessive number of",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262354509",
      "id" : 262354509,
      "in_reply_to_id" : 248034524,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MjM1NDUwOQ==",
      "original_commit_id" : "a5415e85caaf2f5a77d6bae9574bb6d21139ee34",
      "original_position" : 79,
      "path" : "src/validation.cpp",
      "position" : 79,
      "pull_request_review_id" : 210497110,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262354509",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "node_id" : "MDQ6VXNlcjI1MDIyNA==",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262355138"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262355138"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Still extra space as @ryanofsky pointed out.\r\n```suggestion\r\n                    // soft-fork flags to our script flags, in which case we need to\r\n```",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-05T05:49:48Z",
      "diff_hunk" : "@@ -2015,17 +2020,29 @@ bool CChainState::ConnectBlock(const CBlock& block, CValidationState& state, CBl\n         // * witness (when witness enabled in flags and excludes coinbase)\n         nSigOpsCost += GetTransactionSigOpCost(tx, view, flags);\n         if (nSigOpsCost > MAX_BLOCK_SIGOPS_COST)\n-            return state.DoS(100, error(\"ConnectBlock(): too many sigops\"),\n+            return state.Invalid(ValidationInvalidReason::CONSENSUS, error(\"ConnectBlock(): too many sigops\"),\n                              REJECT_INVALID, \"bad-blk-sigops\");\n \n         txdata.emplace_back(tx);\n         if (!tx.IsCoinBase())\n         {\n             std::vector<CScriptCheck> vChecks;\n             bool fCacheResults = fJustCheck; /* Don't cache results if we're actually connecting blocks (still consult the cache, though) */\n-            if (!CheckInputs(tx, state, view, fScriptChecks, flags, fCacheResults, fCacheResults, txdata[i], nScriptCheckThreads ? &vChecks : nullptr))\n+            if (!CheckInputs(tx, state, view, fScriptChecks, flags, fCacheResults, fCacheResults, txdata[i], nScriptCheckThreads ? &vChecks : nullptr)) {\n+                if (state.GetReason() == ValidationInvalidReason::TX_NOT_STANDARD) {\n+                    // CheckInputs may return NOT_STANDARD for extra flags we passed,\n+                    // but we can't return that, as it's not defined for a block, so\n+                    // we reset the reason flag to CONSENSUS here.\n+                    // (note that this may not be the case until we add additional\n+                    // soft-fork flags to our script flags, in which case we  need to",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262355138",
      "id" : 262355138,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MjM1NTEzOA==",
      "original_commit_id" : "beb6a373bdfa91166c8872909ccce31c5b0d72a3",
      "original_position" : 322,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 210497110,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262355138",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "node_id" : "MDQ6VXNlcjI1MDIyNA==",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262361186"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262361186"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Should update the comment here too probably -- s/assign a non-zero DoS score for/disconnect a peer/.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-05T06:25:35Z",
      "diff_hunk" : "@@ -2480,12 +2521,11 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 // Never relay transactions that we would assign a non-zero DoS\n                 // score for, as we expect peers to do the same with us in that\n                 // case.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262361186",
      "id" : 262361186,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MjM2MTE4Ng==",
      "original_commit_id" : "beb6a373bdfa91166c8872909ccce31c5b0d72a3",
      "original_position" : 244,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 210509673,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262361186",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262361315"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262361315"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, swapping the order here messes up the following fixup! commits too.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-05T06:26:15Z",
      "diff_hunk" : "@@ -2480,12 +2521,11 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 // Never relay transactions that we would assign a non-zero DoS\n                 // score for, as we expect peers to do the same with us in that\n                 // case.\n-                int nDoS = 0;\n-                if (!state.IsInvalid(nDoS) || nDoS == 0) {\n+                if (state.IsInvalid() && TxRelayMayResultInDisconnect(state)) {\n+                    LogPrintf(\"Not relaying invalid transaction %s from whitelisted peer=%d (%s)\\n\", tx.GetHash().ToString(), pfrom->GetId(), FormatStateMessage(state));\n+                } else {\n                     LogPrintf(\"Force relaying tx %s from whitelisted peer=%d\\n\", tx.GetHash().ToString(), pfrom->GetId());\n                     RelayTransaction(tx, connman);\n-                } else {\n-                    LogPrintf(\"Not relaying invalid transaction %s from whitelisted peer=%d (%s)\\n\", tx.GetHash().ToString(), pfrom->GetId(), FormatStateMessage(state));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262361315",
      "id" : 262361315,
      "in_reply_to_id" : 262353524,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MjM2MTMxNQ==",
      "original_commit_id" : "beb6a373bdfa91166c8872909ccce31c5b0d72a3",
      "original_position" : 253,
      "path" : "src/net_processing.cpp",
      "position" : 265,
      "pull_request_review_id" : 210509673,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262361315",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262387412"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262387412"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In either case, the transaction may be valid sometime later, but isn't valid now and isn't valid in a block, so they're not very distinct.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-05T08:20:09Z",
      "diff_hunk" : "@@ -221,28 +221,27 @@ bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, c\n \n         // If prev is coinbase, check that it's matured\n         if (coin.IsCoinBase() && nSpendHeight - coin.nHeight < COINBASE_MATURITY) {\n-            return state.Invalid(false,\n-                REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\n+            return state.Invalid(ValidationInvalidReason::TX_MISSING_INPUTS, false, REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262387412",
      "id" : 262387412,
      "in_reply_to_id" : 262350926,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MjM4NzQxMg==",
      "original_commit_id" : "beb6a373bdfa91166c8872909ccce31c5b0d72a3",
      "original_position" : 70,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : null,
      "pull_request_review_id" : 210541818,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262387412",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262390249"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262390249"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`TX_INPUTS_UNAVAILABLE`?",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-05T08:29:08Z",
      "diff_hunk" : "@@ -221,28 +221,27 @@ bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, c\n \n         // If prev is coinbase, check that it's matured\n         if (coin.IsCoinBase() && nSpendHeight - coin.nHeight < COINBASE_MATURITY) {\n-            return state.Invalid(false,\n-                REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\n+            return state.Invalid(ValidationInvalidReason::TX_MISSING_INPUTS, false, REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262390249",
      "id" : 262390249,
      "in_reply_to_id" : 262350926,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MjM5MDI0OQ==",
      "original_commit_id" : "beb6a373bdfa91166c8872909ccce31c5b0d72a3",
      "original_position" : 70,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : null,
      "pull_request_review_id" : 210545291,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262390249",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "node_id" : "MDQ6VXNlcjI1MDIyNA==",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262641531"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262641531"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/15141#discussion_r256054235\r\n\r\nThanks, this makes sense and the simplification fixes all the parts I didn't like.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-05T18:53:20Z",
      "diff_hunk" : "@@ -947,17 +947,86 @@ void Misbehaving(NodeId pnode, int howmuch, const std::string& message) EXCLUSIV\n         LogPrint(BCLog::NET, \"%s: %s peer=%d (%d -> %d)%s\\n\", __func__, state->name, pnode, state->nMisbehavior-howmuch, state->nMisbehavior, message_prefixed);\n }\n \n+/**\n+ * Returns true if the given validation state result may result in us banning/disconnecting a peer\n+ * which provided such an object. This is used to determine whether to relay transactions to\n+ * whitelisted peers, preventing us from relaying things which would result in them disconnecting\n+ * us.\n+ */\n static bool MayResultInDisconnect(const CValidationState& state, bool via_compact_block) {\n-    assert(!via_compact_block);\n-    return (state.GetDoS() > 0);\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        return false;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        // Blocks (or headers) invalid for one of the above reasons may not be\n+        // knowable to a high-bandwidth compact block peer, prior to relay.\n+        // Headers that are invalid for reasons that should be known prior to\n+        // block validation -- such as bad proof of work, too-early-time, or\n+        // building off an invalid or missing block -- are punished regardless\n+        // (see below).\n+        return !via_compact_block;\n+    case ValidationInvalidReason::BLOCK_INVALID_HEADER:\n+    case ValidationInvalidReason::BLOCK_CHECKPOINT:\n+    case ValidationInvalidReason::BLOCK_INVALID_PREV:\n+    case ValidationInvalidReason::BLOCK_MISSING_PREV:\n+        return true;\n+    // Conflicting (but not necessarily invalid) data or different policy:\n+    case ValidationInvalidReason::RECENT_CONSENSUS_CHANGE:\n+    case ValidationInvalidReason::BLOCK_BAD_TIME:\n+    case ValidationInvalidReason::TX_NOT_STANDARD:\n+    case ValidationInvalidReason::TX_MISSING_INPUTS:\n+    case ValidationInvalidReason::TX_WITNESS_MUTATED:\n+    case ValidationInvalidReason::TX_CONFLICT:\n+    case ValidationInvalidReason::TX_MEMPOOL_POLICY:\n+        return false;\n+    }\n+    return false;\n }\n \n+//! Returns true if the peer was punished (probably disconnected)\n static bool MaybePunishNode(NodeId nodeid, const CValidationState& state, bool via_compact_block, const std::string& message = \"\") {\n-    int nDoS = state.GetDoS();\n-    if (nDoS > 0 && !via_compact_block) {\n-         LOCK(cs_main);\n-         Misbehaving(nodeid, nDoS, message);\n-         return true;\n+    switch (state.GetReason()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262641531",
      "id" : 262641531,
      "in_reply_to_id" : 256054235,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MjY0MTUzMQ==",
      "original_commit_id" : "346699322ca820c5d95c255386df3ce1fb1f3d11",
      "original_position" : 52,
      "path" : "src/net_processing.cpp",
      "position" : 55,
      "pull_request_review_id" : 210859157,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262641531",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262641592"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262641592"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/15141#discussion_r256052181\r\n\r\n> Is this still relevant after the latest changes?\r\n\r\nNot important. Maybe you could say a comment would be more helpful now that the functions don't look related. But it's not a big deal if there's no reminder to check sending behavior when you change receiving behavior.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-05T18:53:29Z",
      "diff_hunk" : "@@ -947,17 +947,86 @@ void Misbehaving(NodeId pnode, int howmuch, const std::string& message) EXCLUSIV\n         LogPrint(BCLog::NET, \"%s: %s peer=%d (%d -> %d)%s\\n\", __func__, state->name, pnode, state->nMisbehavior-howmuch, state->nMisbehavior, message_prefixed);\n }\n \n+/**\n+ * Returns true if the given validation state result may result in us banning/disconnecting a peer\n+ * which provided such an object. This is used to determine whether to relay transactions to\n+ * whitelisted peers, preventing us from relaying things which would result in them disconnecting\n+ * us.\n+ */\n static bool MayResultInDisconnect(const CValidationState& state, bool via_compact_block) {\n-    assert(!via_compact_block);\n-    return (state.GetDoS() > 0);\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        return false;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        // Blocks (or headers) invalid for one of the above reasons may not be\n+        // knowable to a high-bandwidth compact block peer, prior to relay.\n+        // Headers that are invalid for reasons that should be known prior to\n+        // block validation -- such as bad proof of work, too-early-time, or\n+        // building off an invalid or missing block -- are punished regardless\n+        // (see below).\n+        return !via_compact_block;\n+    case ValidationInvalidReason::BLOCK_INVALID_HEADER:\n+    case ValidationInvalidReason::BLOCK_CHECKPOINT:\n+    case ValidationInvalidReason::BLOCK_INVALID_PREV:\n+    case ValidationInvalidReason::BLOCK_MISSING_PREV:\n+        return true;\n+    // Conflicting (but not necessarily invalid) data or different policy:\n+    case ValidationInvalidReason::RECENT_CONSENSUS_CHANGE:\n+    case ValidationInvalidReason::BLOCK_BAD_TIME:\n+    case ValidationInvalidReason::TX_NOT_STANDARD:\n+    case ValidationInvalidReason::TX_MISSING_INPUTS:\n+    case ValidationInvalidReason::TX_WITNESS_MUTATED:\n+    case ValidationInvalidReason::TX_CONFLICT:\n+    case ValidationInvalidReason::TX_MEMPOOL_POLICY:\n+        return false;\n+    }\n+    return false;\n }\n \n+//! Returns true if the peer was punished (probably disconnected)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262641592",
      "id" : 262641592,
      "in_reply_to_id" : 256052181,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MjY0MTU5Mg==",
      "original_commit_id" : "346699322ca820c5d95c255386df3ce1fb1f3d11",
      "original_position" : 45,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 210859157,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262641592",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262642581"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262642581"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/15141#discussion_r256091126\r\n\r\nThanks, looks like these cases are really not possible given `assert(IsTransactionReason)` in the new code.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-05T18:55:54Z",
      "diff_hunk" : "@@ -947,17 +947,86 @@ void Misbehaving(NodeId pnode, int howmuch, const std::string& message) EXCLUSIV\n         LogPrint(BCLog::NET, \"%s: %s peer=%d (%d -> %d)%s\\n\", __func__, state->name, pnode, state->nMisbehavior-howmuch, state->nMisbehavior, message_prefixed);\n }\n \n+/**\n+ * Returns true if the given validation state result may result in us banning/disconnecting a peer\n+ * which provided such an object. This is used to determine whether to relay transactions to\n+ * whitelisted peers, preventing us from relaying things which would result in them disconnecting\n+ * us.\n+ */\n static bool MayResultInDisconnect(const CValidationState& state, bool via_compact_block) {\n-    assert(!via_compact_block);\n-    return (state.GetDoS() > 0);\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        return false;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        // Blocks (or headers) invalid for one of the above reasons may not be\n+        // knowable to a high-bandwidth compact block peer, prior to relay.\n+        // Headers that are invalid for reasons that should be known prior to\n+        // block validation -- such as bad proof of work, too-early-time, or\n+        // building off an invalid or missing block -- are punished regardless\n+        // (see below).\n+        return !via_compact_block;\n+    case ValidationInvalidReason::BLOCK_INVALID_HEADER:\n+    case ValidationInvalidReason::BLOCK_CHECKPOINT:\n+    case ValidationInvalidReason::BLOCK_INVALID_PREV:\n+    case ValidationInvalidReason::BLOCK_MISSING_PREV:\n+        return true;\n+    // Conflicting (but not necessarily invalid) data or different policy:\n+    case ValidationInvalidReason::RECENT_CONSENSUS_CHANGE:\n+    case ValidationInvalidReason::BLOCK_BAD_TIME:\n+    case ValidationInvalidReason::TX_NOT_STANDARD:\n+    case ValidationInvalidReason::TX_MISSING_INPUTS:\n+    case ValidationInvalidReason::TX_WITNESS_MUTATED:\n+    case ValidationInvalidReason::TX_CONFLICT:\n+    case ValidationInvalidReason::TX_MEMPOOL_POLICY:\n+        return false;\n+    }\n+    return false;\n }\n \n+//! Returns true if the peer was punished (probably disconnected)\n static bool MaybePunishNode(NodeId nodeid, const CValidationState& state, bool via_compact_block, const std::string& message = \"\") {\n-    int nDoS = state.GetDoS();\n-    if (nDoS > 0 && !via_compact_block) {\n-         LOCK(cs_main);\n-         Misbehaving(nodeid, nDoS, message);\n-         return true;\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        break;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+        if (!via_compact_block) {\n+            LOCK(cs_main);\n+            Misbehaving(nodeid, 100, message);\n+            return true;\n+        }\n+        break;\n+    // Handled elsewhere for now\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        break;\n+    case ValidationInvalidReason::BLOCK_INVALID_HEADER:\n+    case ValidationInvalidReason::BLOCK_CHECKPOINT:\n+    case ValidationInvalidReason::BLOCK_INVALID_PREV:\n+        {\n+            LOCK(cs_main);\n+            Misbehaving(nodeid, 100, message);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262642581",
      "id" : 262642581,
      "in_reply_to_id" : 256091126,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MjY0MjU4MQ==",
      "original_commit_id" : "346699322ca820c5d95c255386df3ce1fb1f3d11",
      "original_position" : 72,
      "path" : "src/net_processing.cpp",
      "position" : 88,
      "pull_request_review_id" : 210859157,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262642581",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262645915"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262645915"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262352042\r\n\r\n> Any particular reason why this isn't just CNodeState(.., const std::string& addrNameIn, ...) : ..., name(addrNameIn)?\r\n\r\nThis would be worse because you can't move from a const reference and there would be an unnecessary copy.\r\n\r\nIf a function is inserting an argument into a data structure, it's good practice for it to take the argument by value or by rvalue reference instead of by const reference, to avoid pointless copying.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-05T19:04:16Z",
      "diff_hunk" : "@@ -349,7 +349,16 @@ struct CNodeState {\n \n     TxDownloadState m_tx_download;\n \n-    CNodeState(CAddress addrIn, std::string addrNameIn) : address(addrIn), name(addrNameIn) {\n+    //! Whether this peer is an inbound connection\n+    bool m_is_inbound;\n+\n+    //! Whether this peer is a manual connection\n+    bool m_is_manual_connection;\n+\n+    CNodeState(CAddress addrIn, std::string addrNameIn, bool is_inbound, bool is_manual) :\n+        address(addrIn), name(std::move(addrNameIn)), m_is_inbound(is_inbound),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262645915",
      "id" : 262645915,
      "in_reply_to_id" : 262352042,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MjY0NTkxNQ==",
      "original_commit_id" : "beb6a373bdfa91166c8872909ccce31c5b0d72a3",
      "original_position" : 12,
      "path" : "src/net_processing.cpp",
      "position" : 12,
      "pull_request_review_id" : 210859157,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262645915",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262657469"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262657469"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/15141#discussion_r250800408\r\n\r\n> Done\r\n\r\nThanks, new commit is \"Remove redundant state.Invalid() call after CheckTransaction()\" (59ff8e67c2c62ec11d76d3d1b54dc4829363ad5e)",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-05T19:35:11Z",
      "diff_hunk" : "@@ -3116,10 +3116,12 @@ bool CheckBlock(const CBlock& block, CValidationState& state, const Consensus::P\n             return state.DoS(100, false, REJECT_INVALID, \"bad-cb-multiple\", false, \"more than one coinbase\");\n \n     // Check transactions\n-    for (const auto& tx : block.vtx)\n-        if (!CheckTransaction(*tx, state, true))\n-            return state.Invalid(false, state.GetRejectCode(), state.GetRejectReason(),\n-                                 strprintf(\"Transaction check failed (tx hash %s) %s\", tx->GetHash().ToString(), state.GetDebugMessage()));\n+    for (const auto& tx : block.vtx) {\n+        if (!CheckTransaction(*tx, state, true)) {\n+            LogPrintf(\"Transaction check failed (tx hash %s) %s\\n\", tx->GetHash().ToString(), state.GetDebugMessage());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262657469",
      "id" : 262657469,
      "in_reply_to_id" : 250800408,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MjY1NzQ2OQ==",
      "original_commit_id" : "94c2cdb88049af5283a7c1f52ea6e52ac2946686",
      "original_position" : 10,
      "path" : "src/validation.cpp",
      "position" : 407,
      "pull_request_review_id" : 210859157,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262657469",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262658155"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262658155"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/15141#discussion_r250807170\r\n\r\n> Updated with a new comment.\r\n\r\nThanks, new commit is \"[refactor] Update some comments in validation.cpp as we arent doing DoS there\" (9b7978efe3d127fa7833d6561a9d053c6820dc1b)\r\n",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-05T19:36:51Z",
      "diff_hunk" : "@@ -1414,21 +1414,16 @@ bool CheckInputs(const CTransaction& tx, CValidationState &state, const CCoinsVi\n                         // Check whether the failure was caused by a\n                         // non-mandatory script verification check, such as\n                         // non-standard DER encodings or non-null dummy\n-                        // arguments; if so, don't trigger DoS protection to\n-                        // avoid splitting the network between upgraded and\n-                        // non-upgraded nodes.\n+                        // arguments; if so, ensure we return NOT_STANDARD\n+                        // instead of CONSENSUS to avoid downstream users\n+                        // splitting the network between upgraded and\n+                        // non-upgraded nodes by banning CONSENSUS-failing\n+                        // data providers.\n                         CScriptCheck check2(coin.out, tx, i,\n                                 flags & ~STANDARD_NOT_MANDATORY_VERIFY_FLAGS, cacheSigStore, &txdata);\n                         if (check2())\n                             return state.Invalid(ValidationInvalidReason::TX_NOT_STANDARD, false, REJECT_NONSTANDARD, strprintf(\"non-mandatory-script-verify-flag (%s)\", ScriptErrorString(check.GetScriptError())));\n                     }\n-                    // Failures of other flags indicate a transaction that is\n-                    // invalid in new blocks, e.g. an invalid P2SH. We DoS ban\n-                    // such nodes as they are not following the protocol. That\n-                    // said during an upgrade careful thought should be taken\n-                    // as to the correct behavior - we may want to continue\n-                    // peering with non-upgraded nodes even after soft-fork\n-                    // super-majority signaling has occurred.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262658155",
      "id" : 262658155,
      "in_reply_to_id" : 250807170,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MjY1ODE1NQ==",
      "original_commit_id" : "e534b0b78bec49750421b5f52012b857df197e24",
      "original_position" : 23,
      "path" : "src/validation.cpp",
      "position" : 240,
      "pull_request_review_id" : 210859157,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262658155",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262658711"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262658711"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/15141#discussion_r256061290\r\n\r\n> It would be clearer to write\r\n\r\nStill might be nice to make this change",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-05T19:38:11Z",
      "diff_hunk" : "@@ -947,17 +947,86 @@ void Misbehaving(NodeId pnode, int howmuch, const std::string& message) EXCLUSIV\n         LogPrint(BCLog::NET, \"%s: %s peer=%d (%d -> %d)%s\\n\", __func__, state->name, pnode, state->nMisbehavior-howmuch, state->nMisbehavior, message_prefixed);\n }\n \n+/**\n+ * Returns true if the given validation state result may result in us banning/disconnecting a peer",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262658711",
      "id" : 262658711,
      "in_reply_to_id" : 256061290,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MjY1ODcxMQ==",
      "original_commit_id" : "346699322ca820c5d95c255386df3ce1fb1f3d11",
      "original_position" : 5,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 210859157,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262658711",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262776609"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262776609"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I am pretty sure there will be no copying if the input is discardable, except for `-O0`, but I could be mistaken.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-06T03:02:45Z",
      "diff_hunk" : "@@ -349,7 +349,16 @@ struct CNodeState {\n \n     TxDownloadState m_tx_download;\n \n-    CNodeState(CAddress addrIn, std::string addrNameIn) : address(addrIn), name(addrNameIn) {\n+    //! Whether this peer is an inbound connection\n+    bool m_is_inbound;\n+\n+    //! Whether this peer is a manual connection\n+    bool m_is_manual_connection;\n+\n+    CNodeState(CAddress addrIn, std::string addrNameIn, bool is_inbound, bool is_manual) :\n+        address(addrIn), name(std::move(addrNameIn)), m_is_inbound(is_inbound),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262776609",
      "id" : 262776609,
      "in_reply_to_id" : 262352042,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2Mjc3NjYwOQ==",
      "original_commit_id" : "beb6a373bdfa91166c8872909ccce31c5b0d72a3",
      "original_position" : 12,
      "path" : "src/net_processing.cpp",
      "position" : 12,
      "pull_request_review_id" : 211025248,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262776609",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "node_id" : "MDQ6VXNlcjI1MDIyNA==",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262788735"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262788735"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Initializing the member either has to copy or move, and you can't move from a const object, so the copy constructor will be called. If you are referring to `-O0` it sounds like you are thinking about [copy elision](https://en.cppreference.com/w/cpp/language/copy_elision), but that doesn't apply here for member initialization.\r\n\r\nSimple advice is to use `const&` for an argument that you want to copy from, `&&` for an argument that you want to move from, and pass by value when you want to give the caller a choice of whether to copy or move.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-06T04:32:46Z",
      "diff_hunk" : "@@ -349,7 +349,16 @@ struct CNodeState {\n \n     TxDownloadState m_tx_download;\n \n-    CNodeState(CAddress addrIn, std::string addrNameIn) : address(addrIn), name(addrNameIn) {\n+    //! Whether this peer is an inbound connection\n+    bool m_is_inbound;\n+\n+    //! Whether this peer is a manual connection\n+    bool m_is_manual_connection;\n+\n+    CNodeState(CAddress addrIn, std::string addrNameIn, bool is_inbound, bool is_manual) :\n+        address(addrIn), name(std::move(addrNameIn)), m_is_inbound(is_inbound),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262788735",
      "id" : 262788735,
      "in_reply_to_id" : 262352042,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2Mjc4ODczNQ==",
      "original_commit_id" : "beb6a373bdfa91166c8872909ccce31c5b0d72a3",
      "original_position" : 12,
      "path" : "src/net_processing.cpp",
      "position" : 12,
      "pull_request_review_id" : 211040132,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262788735",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262790206"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262790206"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I see. But we are doing `const type& var` all over the place elsewhere. This is in fact why I wondered about the \"derivation from the standard\" here. (A simple search for `const std::string&` gives 799 results.)",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-06T04:44:51Z",
      "diff_hunk" : "@@ -349,7 +349,16 @@ struct CNodeState {\n \n     TxDownloadState m_tx_download;\n \n-    CNodeState(CAddress addrIn, std::string addrNameIn) : address(addrIn), name(addrNameIn) {\n+    //! Whether this peer is an inbound connection\n+    bool m_is_inbound;\n+\n+    //! Whether this peer is a manual connection\n+    bool m_is_manual_connection;\n+\n+    CNodeState(CAddress addrIn, std::string addrNameIn, bool is_inbound, bool is_manual) :\n+        address(addrIn), name(std::move(addrNameIn)), m_is_inbound(is_inbound),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262790206",
      "id" : 262790206,
      "in_reply_to_id" : 262352042,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2Mjc5MDIwNg==",
      "original_commit_id" : "beb6a373bdfa91166c8872909ccce31c5b0d72a3",
      "original_position" : 12,
      "path" : "src/net_processing.cpp",
      "position" : 12,
      "pull_request_review_id" : 211042030,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262790206",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "node_id" : "MDQ6VXNlcjI1MDIyNA==",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262803346"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262803346"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Passing a string by reference doesn't need a copy. Using it to initialize a member does.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-06T06:15:13Z",
      "diff_hunk" : "@@ -349,7 +349,16 @@ struct CNodeState {\n \n     TxDownloadState m_tx_download;\n \n-    CNodeState(CAddress addrIn, std::string addrNameIn) : address(addrIn), name(addrNameIn) {\n+    //! Whether this peer is an inbound connection\n+    bool m_is_inbound;\n+\n+    //! Whether this peer is a manual connection\n+    bool m_is_manual_connection;\n+\n+    CNodeState(CAddress addrIn, std::string addrNameIn, bool is_inbound, bool is_manual) :\n+        address(addrIn), name(std::move(addrNameIn)), m_is_inbound(is_inbound),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262803346",
      "id" : 262803346,
      "in_reply_to_id" : 262352042,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MjgwMzM0Ng==",
      "original_commit_id" : "beb6a373bdfa91166c8872909ccce31c5b0d72a3",
      "original_position" : 12,
      "path" : "src/net_processing.cpp",
      "position" : 12,
      "pull_request_review_id" : 211058136,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262803346",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262814934"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262814934"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Interesting. Sorry for clogging up the PR.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-06T07:13:13Z",
      "diff_hunk" : "@@ -349,7 +349,16 @@ struct CNodeState {\n \n     TxDownloadState m_tx_download;\n \n-    CNodeState(CAddress addrIn, std::string addrNameIn) : address(addrIn), name(addrNameIn) {\n+    //! Whether this peer is an inbound connection\n+    bool m_is_inbound;\n+\n+    //! Whether this peer is a manual connection\n+    bool m_is_manual_connection;\n+\n+    CNodeState(CAddress addrIn, std::string addrNameIn, bool is_inbound, bool is_manual) :\n+        address(addrIn), name(std::move(addrNameIn)), m_is_inbound(is_inbound),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262814934",
      "id" : 262814934,
      "in_reply_to_id" : 262352042,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MjgxNDkzNA==",
      "original_commit_id" : "beb6a373bdfa91166c8872909ccce31c5b0d72a3",
      "original_position" : 12,
      "path" : "src/net_processing.cpp",
      "position" : 12,
      "pull_request_review_id" : 211071495,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262814934",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "node_id" : "MDQ6VXNlcjI1MDIyNA==",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262903651"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262903651"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/15141#discussion_r261834407\r\n\r\nPossibly consider adding this helpful context information to the PR description.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-06T11:37:09Z",
      "diff_hunk" : "@@ -947,17 +947,86 @@ void Misbehaving(NodeId pnode, int howmuch, const std::string& message) EXCLUSIV\n         LogPrint(BCLog::NET, \"%s: %s peer=%d (%d -> %d)%s\\n\", __func__, state->name, pnode, state->nMisbehavior-howmuch, state->nMisbehavior, message_prefixed);\n }\n \n+/**\n+ * Returns true if the given validation state result may result in us banning/disconnecting a peer\n+ * which provided such an object. This is used to determine whether to relay transactions to\n+ * whitelisted peers, preventing us from relaying things which would result in them disconnecting\n+ * us.\n+ */\n static bool MayResultInDisconnect(const CValidationState& state, bool via_compact_block) {\n-    assert(!via_compact_block);\n-    return (state.GetDoS() > 0);\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        return false;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        // Blocks (or headers) invalid for one of the above reasons may not be\n+        // knowable to a high-bandwidth compact block peer, prior to relay.\n+        // Headers that are invalid for reasons that should be known prior to\n+        // block validation -- such as bad proof of work, too-early-time, or\n+        // building off an invalid or missing block -- are punished regardless\n+        // (see below).\n+        return !via_compact_block;\n+    case ValidationInvalidReason::BLOCK_INVALID_HEADER:\n+    case ValidationInvalidReason::BLOCK_CHECKPOINT:\n+    case ValidationInvalidReason::BLOCK_INVALID_PREV:\n+    case ValidationInvalidReason::BLOCK_MISSING_PREV:\n+        return true;\n+    // Conflicting (but not necessarily invalid) data or different policy:\n+    case ValidationInvalidReason::RECENT_CONSENSUS_CHANGE:\n+    case ValidationInvalidReason::BLOCK_BAD_TIME:\n+    case ValidationInvalidReason::TX_NOT_STANDARD:\n+    case ValidationInvalidReason::TX_MISSING_INPUTS:\n+    case ValidationInvalidReason::TX_WITNESS_MUTATED:\n+    case ValidationInvalidReason::TX_CONFLICT:\n+    case ValidationInvalidReason::TX_MEMPOOL_POLICY:\n+        return false;\n+    }\n+    return false;\n }\n \n+//! Returns true if the peer was punished (probably disconnected)\n static bool MaybePunishNode(NodeId nodeid, const CValidationState& state, bool via_compact_block, const std::string& message = \"\") {\n-    int nDoS = state.GetDoS();\n-    if (nDoS > 0 && !via_compact_block) {\n-         LOCK(cs_main);\n-         Misbehaving(nodeid, nDoS, message);\n-         return true;\n+    switch (state.GetReason()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262903651",
      "id" : 262903651,
      "in_reply_to_id" : 256054235,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MjkwMzY1MQ==",
      "original_commit_id" : "346699322ca820c5d95c255386df3ce1fb1f3d11",
      "original_position" : 52,
      "path" : "src/net_processing.cpp",
      "position" : 55,
      "pull_request_review_id" : 211181978,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262903651",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262939693"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262939693"
         }
      },
      "author_association" : "MEMBER",
      "body" : "So if I understand this correctly:\r\n* `state.Invalid()` just calls `state.DoS() with `level=0` and `corruptionIn=false` (default).\r\n* `CheckTransaction()` can currently fail in various ways, calling:\r\n  * `state.DoS` with:\r\n    * `level` 10 or 100: _why isn't this higher level a problem?_\r\n    * `corruptionIn` not specified (so defaults to `false`)",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-06T13:28:19Z",
      "diff_hunk" : "@@ -3106,28 +3124,30 @@ bool CheckBlock(const CBlock& block, CValidationState& state, const Consensus::P\n \n     // Size limits\n     if (block.vtx.empty() || block.vtx.size() * WITNESS_SCALE_FACTOR > MAX_BLOCK_WEIGHT || ::GetSerializeSize(block, PROTOCOL_VERSION | SERIALIZE_TRANSACTION_NO_WITNESS) * WITNESS_SCALE_FACTOR > MAX_BLOCK_WEIGHT)\n-        return state.DoS(100, false, REJECT_INVALID, \"bad-blk-length\", false, \"size limits failed\");\n+        return state.DoS(100, ValidationInvalidReason::CONSENSUS, false, REJECT_INVALID, \"bad-blk-length\", false, \"size limits failed\");\n \n     // First transaction must be coinbase, the rest must not be\n     if (block.vtx.empty() || !block.vtx[0]->IsCoinBase())\n-        return state.DoS(100, false, REJECT_INVALID, \"bad-cb-missing\", false, \"first tx is not coinbase\");\n+        return state.DoS(100, ValidationInvalidReason::CONSENSUS, false, REJECT_INVALID, \"bad-cb-missing\", false, \"first tx is not coinbase\");\n     for (unsigned int i = 1; i < block.vtx.size(); i++)\n         if (block.vtx[i]->IsCoinBase())\n-            return state.DoS(100, false, REJECT_INVALID, \"bad-cb-multiple\", false, \"more than one coinbase\");\n+            return state.DoS(100, ValidationInvalidReason::CONSENSUS, false, REJECT_INVALID, \"bad-cb-multiple\", false, \"more than one coinbase\");\n \n     // Check transactions\n-    for (const auto& tx : block.vtx)\n-        if (!CheckTransaction(*tx, state, true))\n-            return state.Invalid(false, state.GetRejectCode(), state.GetRejectReason(),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262939693",
      "id" : 262939693,
      "in_reply_to_id" : 248041505,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MjkzOTY5Mw==",
      "original_commit_id" : "a5415e85caaf2f5a77d6bae9574bb6d21139ee34",
      "original_position" : 345,
      "path" : "src/validation.cpp",
      "position" : 403,
      "pull_request_review_id" : 211228187,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262939693",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262943213"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262943213"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Note that `MAX_BLOCK_SIGOPS` has been renamed / replaced by `MAX_STANDARD_TX_SIGOPS_COST` as part of SegWit in 2b1f6f9ccf36f1e0a2c9d99154e1642f796d7c2b. In addition to this comment, `MAX_BLOCK_SIGOPS` is also still mentioned in the function test framework. But that doesn't explain why the comment can be removed.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-06T13:37:44Z",
      "diff_hunk" : "@@ -716,27 +716,22 @@ static bool AcceptToMemoryPoolWorker(const CChainParams& chainparams, CTxMemPool\n                               fSpendsCoinbase, nSigOpsCost, lp);\n         unsigned int nSize = entry.GetTxSize();\n \n-        // Check that the transaction doesn't have an excessive number of",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262943213",
      "id" : 262943213,
      "in_reply_to_id" : 248034524,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2Mjk0MzIxMw==",
      "original_commit_id" : "a5415e85caaf2f5a77d6bae9574bb6d21139ee34",
      "original_position" : 79,
      "path" : "src/validation.cpp",
      "position" : 79,
      "pull_request_review_id" : 211228187,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262943213",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262946088"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262946088"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not sure about what to change here, but it's helpful to clarify the role of whitelisting peers better.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-06T13:44:57Z",
      "diff_hunk" : "@@ -947,17 +947,86 @@ void Misbehaving(NodeId pnode, int howmuch, const std::string& message) EXCLUSIV\n         LogPrint(BCLog::NET, \"%s: %s peer=%d (%d -> %d)%s\\n\", __func__, state->name, pnode, state->nMisbehavior-howmuch, state->nMisbehavior, message_prefixed);\n }\n \n+/**\n+ * Returns true if the given validation state result may result in us banning/disconnecting a peer",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262946088",
      "id" : 262946088,
      "in_reply_to_id" : 256061290,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2Mjk0NjA4OA==",
      "original_commit_id" : "346699322ca820c5d95c255386df3ce1fb1f3d11",
      "original_position" : 5,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 211228187,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262946088",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262963047"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262963047"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What was the original idea behind bumping this? Was it to continue validating and perhaps find additional errors before giving up, to see if the originating peer needs stronger punishment?",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-06T14:27:05Z",
      "diff_hunk" : "@@ -45,9 +45,9 @@ class CValidationState {\n         strRejectReason = strRejectReasonIn;\n         corruptionPossible = corruptionIn;\n         strDebugMessage = strDebugMessageIn;\n+        nDoS = level;\n         if (mode == MODE_ERROR)\n             return ret;\n-        nDoS += level;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262963047",
      "id" : 262963047,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2Mjk2MzA0Nw==",
      "original_commit_id" : "858bae6104ba7d16a637920d7802bb4be4c64994",
      "original_position" : 7,
      "path" : "src/consensus/validation.h",
      "position" : 106,
      "pull_request_review_id" : 211228187,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/262963047",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r263416581"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/263416581"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'd prefer to rename this in a future PR, since that would be a simple change and I don't want to hold up the structural improvements here.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-07T14:52:53Z",
      "diff_hunk" : "@@ -22,6 +22,76 @@ static const unsigned char REJECT_NONSTANDARD = 0x40;\n static const unsigned char REJECT_INSUFFICIENTFEE = 0x42;\n static const unsigned char REJECT_CHECKPOINT = 0x43;\n \n+/** A \"reason\" why something was invalid, suitable for determining whether the\n+  * provider of the object should be banned/ignored/disconnected/etc.\n+  * These are much more granular than the rejection codes, which may be more\n+  * useful for some other use-cases.\n+  */\n+enum class ValidationInvalidReason {\n+    // txn and blocks:\n+    NONE,                    //!< not actually invalid",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r263416581",
      "id" : 263416581,
      "in_reply_to_id" : 262351517,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MzQxNjU4MQ==",
      "original_commit_id" : "beb6a373bdfa91166c8872909ccce31c5b0d72a3",
      "original_position" : 11,
      "path" : "src/consensus/validation.h",
      "position" : 11,
      "pull_request_review_id" : 211825674,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/263416581",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r263421860"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/263421860"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> level 10 or 100: why isn't this higher level a problem?\r\n\r\n@sjors I don't understand your question -- can you rephrase?",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-07T15:04:20Z",
      "diff_hunk" : "@@ -3106,28 +3124,30 @@ bool CheckBlock(const CBlock& block, CValidationState& state, const Consensus::P\n \n     // Size limits\n     if (block.vtx.empty() || block.vtx.size() * WITNESS_SCALE_FACTOR > MAX_BLOCK_WEIGHT || ::GetSerializeSize(block, PROTOCOL_VERSION | SERIALIZE_TRANSACTION_NO_WITNESS) * WITNESS_SCALE_FACTOR > MAX_BLOCK_WEIGHT)\n-        return state.DoS(100, false, REJECT_INVALID, \"bad-blk-length\", false, \"size limits failed\");\n+        return state.DoS(100, ValidationInvalidReason::CONSENSUS, false, REJECT_INVALID, \"bad-blk-length\", false, \"size limits failed\");\n \n     // First transaction must be coinbase, the rest must not be\n     if (block.vtx.empty() || !block.vtx[0]->IsCoinBase())\n-        return state.DoS(100, false, REJECT_INVALID, \"bad-cb-missing\", false, \"first tx is not coinbase\");\n+        return state.DoS(100, ValidationInvalidReason::CONSENSUS, false, REJECT_INVALID, \"bad-cb-missing\", false, \"first tx is not coinbase\");\n     for (unsigned int i = 1; i < block.vtx.size(); i++)\n         if (block.vtx[i]->IsCoinBase())\n-            return state.DoS(100, false, REJECT_INVALID, \"bad-cb-multiple\", false, \"more than one coinbase\");\n+            return state.DoS(100, ValidationInvalidReason::CONSENSUS, false, REJECT_INVALID, \"bad-cb-multiple\", false, \"more than one coinbase\");\n \n     // Check transactions\n-    for (const auto& tx : block.vtx)\n-        if (!CheckTransaction(*tx, state, true))\n-            return state.Invalid(false, state.GetRejectCode(), state.GetRejectReason(),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r263421860",
      "id" : 263421860,
      "in_reply_to_id" : 248041505,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MzQyMTg2MA==",
      "original_commit_id" : "a5415e85caaf2f5a77d6bae9574bb6d21139ee34",
      "original_position" : 345,
      "path" : "src/validation.cpp",
      "position" : 403,
      "pull_request_review_id" : 211832547,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/263421860",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r263427652"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/263427652"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this comment is not very helpful. It was originally added in #4150, and in the review on that PR people complained that the phrasing in this comment is confusing (\"invalid rather than merely non-standard\" - huh?).\r\n\r\nIf reviewers prefer it, then I can just improve this comment rather than delete it -- it just seems to me like the code reads just fine on its own.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-07T15:16:14Z",
      "diff_hunk" : "@@ -716,27 +716,22 @@ static bool AcceptToMemoryPoolWorker(const CChainParams& chainparams, CTxMemPool\n                               fSpendsCoinbase, nSigOpsCost, lp);\n         unsigned int nSize = entry.GetTxSize();\n \n-        // Check that the transaction doesn't have an excessive number of",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r263427652",
      "id" : 263427652,
      "in_reply_to_id" : 248034524,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MzQyNzY1Mg==",
      "original_commit_id" : "a5415e85caaf2f5a77d6bae9574bb6d21139ee34",
      "original_position" : 79,
      "path" : "src/validation.cpp",
      "position" : 79,
      "pull_request_review_id" : 211839911,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/263427652",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r263529316"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/263529316"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-07T19:18:39Z",
      "diff_hunk" : "@@ -947,17 +947,86 @@ void Misbehaving(NodeId pnode, int howmuch, const std::string& message) EXCLUSIV\n         LogPrint(BCLog::NET, \"%s: %s peer=%d (%d -> %d)%s\\n\", __func__, state->name, pnode, state->nMisbehavior-howmuch, state->nMisbehavior, message_prefixed);\n }\n \n+/**\n+ * Returns true if the given validation state result may result in us banning/disconnecting a peer\n+ * which provided such an object. This is used to determine whether to relay transactions to\n+ * whitelisted peers, preventing us from relaying things which would result in them disconnecting\n+ * us.\n+ */\n static bool MayResultInDisconnect(const CValidationState& state, bool via_compact_block) {\n-    assert(!via_compact_block);\n-    return (state.GetDoS() > 0);\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        return false;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        // Blocks (or headers) invalid for one of the above reasons may not be\n+        // knowable to a high-bandwidth compact block peer, prior to relay.\n+        // Headers that are invalid for reasons that should be known prior to\n+        // block validation -- such as bad proof of work, too-early-time, or\n+        // building off an invalid or missing block -- are punished regardless\n+        // (see below).\n+        return !via_compact_block;\n+    case ValidationInvalidReason::BLOCK_INVALID_HEADER:\n+    case ValidationInvalidReason::BLOCK_CHECKPOINT:\n+    case ValidationInvalidReason::BLOCK_INVALID_PREV:\n+    case ValidationInvalidReason::BLOCK_MISSING_PREV:\n+        return true;\n+    // Conflicting (but not necessarily invalid) data or different policy:\n+    case ValidationInvalidReason::RECENT_CONSENSUS_CHANGE:\n+    case ValidationInvalidReason::BLOCK_BAD_TIME:\n+    case ValidationInvalidReason::TX_NOT_STANDARD:\n+    case ValidationInvalidReason::TX_MISSING_INPUTS:\n+    case ValidationInvalidReason::TX_WITNESS_MUTATED:\n+    case ValidationInvalidReason::TX_CONFLICT:\n+    case ValidationInvalidReason::TX_MEMPOOL_POLICY:\n+        return false;\n+    }\n+    return false;\n }\n \n+//! Returns true if the peer was punished (probably disconnected)\n static bool MaybePunishNode(NodeId nodeid, const CValidationState& state, bool via_compact_block, const std::string& message = \"\") {\n-    int nDoS = state.GetDoS();\n-    if (nDoS > 0 && !via_compact_block) {\n-         LOCK(cs_main);\n-         Misbehaving(nodeid, nDoS, message);\n-         return true;\n+    switch (state.GetReason()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r263529316",
      "id" : 263529316,
      "in_reply_to_id" : 256054235,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MzUyOTMxNg==",
      "original_commit_id" : "346699322ca820c5d95c255386df3ce1fb1f3d11",
      "original_position" : 52,
      "path" : "src/net_processing.cpp",
      "position" : 55,
      "pull_request_review_id" : 211971214,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/263529316",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r263530223"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/263530223"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done in latest commit.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-07T19:21:11Z",
      "diff_hunk" : "@@ -947,17 +947,86 @@ void Misbehaving(NodeId pnode, int howmuch, const std::string& message) EXCLUSIV\n         LogPrint(BCLog::NET, \"%s: %s peer=%d (%d -> %d)%s\\n\", __func__, state->name, pnode, state->nMisbehavior-howmuch, state->nMisbehavior, message_prefixed);\n }\n \n+/**\n+ * Returns true if the given validation state result may result in us banning/disconnecting a peer",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r263530223",
      "id" : 263530223,
      "in_reply_to_id" : 256061290,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MzUzMDIyMw==",
      "original_commit_id" : "346699322ca820c5d95c255386df3ce1fb1f3d11",
      "original_position" : 5,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 211972366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/263530223",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r263530270"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/263530270"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-07T19:21:21Z",
      "diff_hunk" : "@@ -947,17 +947,86 @@ void Misbehaving(NodeId pnode, int howmuch, const std::string& message) EXCLUSIV\n         LogPrint(BCLog::NET, \"%s: %s peer=%d (%d -> %d)%s\\n\", __func__, state->name, pnode, state->nMisbehavior-howmuch, state->nMisbehavior, message_prefixed);\n }\n \n+/**\n+ * Returns true if the given validation state result may result in us banning/disconnecting a peer\n+ * which provided such an object. This is used to determine whether to relay transactions to\n+ * whitelisted peers, preventing us from relaying things which would result in them disconnecting\n+ * us.\n+ */\n static bool MayResultInDisconnect(const CValidationState& state, bool via_compact_block) {\n-    assert(!via_compact_block);\n-    return (state.GetDoS() > 0);\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        return false;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        // Blocks (or headers) invalid for one of the above reasons may not be\n+        // knowable to a high-bandwidth compact block peer, prior to relay.\n+        // Headers that are invalid for reasons that should be known prior to\n+        // block validation -- such as bad proof of work, too-early-time, or\n+        // building off an invalid or missing block -- are punished regardless\n+        // (see below).\n+        return !via_compact_block;\n+    case ValidationInvalidReason::BLOCK_INVALID_HEADER:\n+    case ValidationInvalidReason::BLOCK_CHECKPOINT:\n+    case ValidationInvalidReason::BLOCK_INVALID_PREV:\n+    case ValidationInvalidReason::BLOCK_MISSING_PREV:\n+        return true;\n+    // Conflicting (but not necessarily invalid) data or different policy:\n+    case ValidationInvalidReason::RECENT_CONSENSUS_CHANGE:\n+    case ValidationInvalidReason::BLOCK_BAD_TIME:\n+    case ValidationInvalidReason::TX_NOT_STANDARD:\n+    case ValidationInvalidReason::TX_MISSING_INPUTS:\n+    case ValidationInvalidReason::TX_WITNESS_MUTATED:\n+    case ValidationInvalidReason::TX_CONFLICT:\n+    case ValidationInvalidReason::TX_MEMPOOL_POLICY:\n+        return false;\n+    }\n+    return false;\n }\n \n+//! Returns true if the peer was punished (probably disconnected)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r263530270",
      "id" : 263530270,
      "in_reply_to_id" : 256052181,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MzUzMDI3MA==",
      "original_commit_id" : "346699322ca820c5d95c255386df3ce1fb1f3d11",
      "original_position" : 45,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 211972436,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/263530270",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r263531494"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/263531494"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah I was just going to skip this because it gets rewritten in a later commit.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-07T19:24:46Z",
      "diff_hunk" : "@@ -947,17 +947,86 @@ void Misbehaving(NodeId pnode, int howmuch, const std::string& message) EXCLUSIV\n         LogPrint(BCLog::NET, \"%s: %s peer=%d (%d -> %d)%s\\n\", __func__, state->name, pnode, state->nMisbehavior-howmuch, state->nMisbehavior, message_prefixed);\n }\n \n+/**\n+ * Returns true if the given validation state result may result in us banning/disconnecting a peer\n+ * which provided such an object. This is used to determine whether to relay transactions to\n+ * whitelisted peers, preventing us from relaying things which would result in them disconnecting\n+ * us.\n+ */\n static bool MayResultInDisconnect(const CValidationState& state, bool via_compact_block) {\n-    assert(!via_compact_block);\n-    return (state.GetDoS() > 0);\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        return false;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+    case ValidationInvalidReason::CACHED_INVALID:\n+        // Blocks (or headers) invalid for one of the above reasons may not be\n+        // knowable to a high-bandwidth compact block peer, prior to relay.\n+        // Headers that are invalid for reasons that should be known prior to\n+        // block validation -- such as bad proof of work, too-early-time, or\n+        // building off an invalid or missing block -- are punished regardless\n+        // (see below).\n+        return !via_compact_block;\n+    case ValidationInvalidReason::BLOCK_INVALID_HEADER:\n+    case ValidationInvalidReason::BLOCK_CHECKPOINT:\n+    case ValidationInvalidReason::BLOCK_INVALID_PREV:\n+    case ValidationInvalidReason::BLOCK_MISSING_PREV:\n+        return true;\n+    // Conflicting (but not necessarily invalid) data or different policy:\n+    case ValidationInvalidReason::RECENT_CONSENSUS_CHANGE:\n+    case ValidationInvalidReason::BLOCK_BAD_TIME:\n+    case ValidationInvalidReason::TX_NOT_STANDARD:\n+    case ValidationInvalidReason::TX_MISSING_INPUTS:\n+    case ValidationInvalidReason::TX_WITNESS_MUTATED:\n+    case ValidationInvalidReason::TX_CONFLICT:\n+    case ValidationInvalidReason::TX_MEMPOOL_POLICY:\n+        return false;\n+    }\n+    return false;\n }\n \n+//! Returns true if the peer was punished (probably disconnected)\n static bool MaybePunishNode(NodeId nodeid, const CValidationState& state, bool via_compact_block, const std::string& message = \"\") {\n-    int nDoS = state.GetDoS();\n-    if (nDoS > 0 && !via_compact_block) {\n-         LOCK(cs_main);\n-         Misbehaving(nodeid, nDoS, message);\n-         return true;\n+    switch (state.GetReason()) {\n+    case ValidationInvalidReason::NONE:\n+        break;\n+    // The node is providing invalid data:\n+    case ValidationInvalidReason::CONSENSUS:\n+    case ValidationInvalidReason::BLOCK_MUTATED:\n+        if (!via_compact_block) {\n+            LOCK(cs_main);\n+            Misbehaving(nodeid, 100, message);\n+            return true;\n+        }\n+        break;\n+    // Handled elsewhere for now",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r263531494",
      "id" : 263531494,
      "in_reply_to_id" : 256081557,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MzUzMTQ5NA==",
      "original_commit_id" : "346699322ca820c5d95c255386df3ce1fb1f3d11",
      "original_position" : 64,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 211974022,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/263531494",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r263531733"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/263531733"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done in latest commit.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-07T19:25:25Z",
      "diff_hunk" : "@@ -2480,12 +2521,11 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 // Never relay transactions that we would assign a non-zero DoS\n                 // score for, as we expect peers to do the same with us in that\n                 // case.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r263531733",
      "id" : 263531733,
      "in_reply_to_id" : 262361186,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MzUzMTczMw==",
      "original_commit_id" : "beb6a373bdfa91166c8872909ccce31c5b0d72a3",
      "original_position" : 244,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 211974301,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/263531733",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r263531931"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/263531931"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not going to bother with these minor style nits, we can clean these up later if anyone cares to.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-07T19:26:04Z",
      "diff_hunk" : "@@ -2520,9 +2559,7 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 connman->PushMessage(pfrom, msgMaker.Make(NetMsgType::REJECT, strCommand, (unsigned char)state.GetRejectCode(),\n                                    state.GetRejectReason().substr(0, MAX_REJECT_MESSAGE_LENGTH), inv.hash));\n             }\n-            if (nDoS > 0) {\n-                Misbehaving(pfrom->GetId(), nDoS);\n-            }\n+            MaybePunishNode(pfrom->GetId(), state, /*via_compact_block*/ false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r263531931",
      "id" : 263531931,
      "in_reply_to_id" : 262354030,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MzUzMTkzMQ==",
      "original_commit_id" : "beb6a373bdfa91166c8872909ccce31c5b0d72a3",
      "original_position" : 274,
      "path" : "src/net_processing.cpp",
      "position" : 286,
      "pull_request_review_id" : 211974573,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/263531931",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r263534436"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/263534436"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't know the history here, but that seems like a reasonable guess.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-07T19:32:53Z",
      "diff_hunk" : "@@ -45,9 +45,9 @@ class CValidationState {\n         strRejectReason = strRejectReasonIn;\n         corruptionPossible = corruptionIn;\n         strDebugMessage = strDebugMessageIn;\n+        nDoS = level;\n         if (mode == MODE_ERROR)\n             return ret;\n-        nDoS += level;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r263534436",
      "id" : 263534436,
      "in_reply_to_id" : 262963047,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MzUzNDQzNg==",
      "original_commit_id" : "858bae6104ba7d16a637920d7802bb4be4c64994",
      "original_position" : 7,
      "path" : "src/consensus/validation.h",
      "position" : 106,
      "pull_request_review_id" : 211977880,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/263534436",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r263536180"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/263536180"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Also I think most of the information in this comment is needed because the logic is much more complex before this PR than after.  After this PR, it's very easy to see how we handle different kinds of invalid blocks/headers, and so less verbose explanations are needed about the reasoning.  I shrunk this comment down to:\r\n```\r\n            // Disconnect outbound (but not inbound) peers if on an invalid chain.\r\n```\r\nwhich I think captures all that we're trying to do.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-07T19:37:34Z",
      "diff_hunk" : "@@ -1627,41 +1649,7 @@ bool static ProcessHeadersMessage(CNode *pfrom, CConnman *connman, const std::ve\n     CBlockHeader first_invalid_header;\n     if (!ProcessNewBlockHeaders(headers, state, chainparams, &pindexLast, &first_invalid_header)) {\n         if (state.IsInvalid()) {\n-            if (punish_duplicate_invalid && state.GetReason() == ValidationInvalidReason::CACHED_INVALID) {\n-                // Goal: don't allow outbound peers to use up our outbound",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r263536180",
      "id" : 263536180,
      "in_reply_to_id" : 256089801,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MzUzNjE4MA==",
      "original_commit_id" : "9dd6fc18658b36b63b9f264676ac484879597b83",
      "original_position" : 66,
      "path" : "src/net_processing.cpp",
      "position" : 157,
      "pull_request_review_id" : 211980074,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/263536180",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r263541233"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/263541233"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I created a new TX_PREMATURE_COINBASE for this in the latest commit.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-03-07T19:51:40Z",
      "diff_hunk" : "@@ -221,28 +221,27 @@ bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, c\n \n         // If prev is coinbase, check that it's matured\n         if (coin.IsCoinBase() && nSpendHeight - coin.nHeight < COINBASE_MATURITY) {\n-            return state.Invalid(false,\n-                REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\n+            return state.Invalid(ValidationInvalidReason::TX_MISSING_INPUTS, false, REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r263541233",
      "id" : 263541233,
      "in_reply_to_id" : 262350926,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI2MzU0MTIzMw==",
      "original_commit_id" : "beb6a373bdfa91166c8872909ccce31c5b0d72a3",
      "original_position" : 70,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : null,
      "pull_request_review_id" : 211986578,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/263541233",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Squashed the history down.  Unsquashed version is [15141.4](https://github.com/sdaftuar/bitcoin/commits/15141.4).",
      "created_at" : "2019-03-07T20:15:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-470677054",
      "id" : 470677054,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15141",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3MDY3NzA1NA==",
      "updated_at" : "2019-03-07T20:15:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/470677054",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ryanofsky there's still a few `====` commits that need to go.",
      "created_at" : "2019-03-09T08:31:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-471158025",
      "id" : 471158025,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15141",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3MTE1ODAyNQ==",
      "updated_at" : "2019-03-09T08:31:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/471158025",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@sjors Removed the empty commits from the PR.  Old version is here: https://github.com/sdaftuar/bitcoin/commits/15141.6",
      "created_at" : "2019-03-09T16:32:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-471198250",
      "id" : 471198250,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15141",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3MTE5ODI1MA==",
      "updated_at" : "2019-03-09T16:32:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/471198250",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I wonder who else is still planning to review this PR. @sipa, @jnewbery, @kallewoof, @sjors, @ajtowns all reviewed previous versions. @TheBlueMatt wrote the original version and discussed it recently offline. @naumenkogs wrote that he intends to review. Is there anyone else? It seems like if some subset of the people who already reviewed this rereviewed it, it could be ready to merge.",
      "created_at" : "2019-03-28T16:56:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-477682421",
      "id" : 477682421,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15141",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3NzY4MjQyMQ==",
      "updated_at" : "2019-03-28T16:56:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/477682421",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'm going to take a read through at some point (probably tomorrow), but that definitely shouldn't hang up a merge if the reviewers mentioned above have signed off.",
      "created_at" : "2019-03-30T03:01:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-478200330",
      "id" : 478200330,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15141",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3ODIwMDMzMA==",
      "updated_at" : "2019-03-30T03:01:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/478200330",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "utACK daf23bf0b9791cb6a1515e3764d1f645e1181859\r\n\r\nI think it would have made sense to split this PR after \"Clean up banning levels\", so utACK 96cedc8d0c0e3ad279bc2223a7fc3185b17ebde5 as well, fwiw. I guess it's probably better to just get reviews for the whole thing at this point though.",
      "created_at" : "2019-04-01T07:54:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-478474586",
      "id" : 478474586,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15141",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3ODQ3NDU4Ng==",
      "updated_at" : "2019-04-01T07:54:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/478474586",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r270755296"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/270755296"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`MAX_BLOCK_SIGOPS` is replaced by `MAX_BLOCK_SIGOPS_COST` (which is just multiplied by the witness scale factor of 4) as part of segwit. `MAX_STANDARD_TX_SIGOPS_COST` is just a separate rule at the relay/mempool level saying \"you have to use at least 5 tx's to hit the sigop limit\".\r\n\r\nI agree that the comment's just confusing given how we understand \"invalid\" (breaks consensus rules) vs \"non-standard\" (not interesting for mempool/relay, but not too strongly punished either).",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-01T08:11:40Z",
      "diff_hunk" : "@@ -716,27 +716,22 @@ static bool AcceptToMemoryPoolWorker(const CChainParams& chainparams, CTxMemPool\n                               fSpendsCoinbase, nSigOpsCost, lp);\n         unsigned int nSize = entry.GetTxSize();\n \n-        // Check that the transaction doesn't have an excessive number of",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r270755296",
      "id" : 270755296,
      "in_reply_to_id" : 248034524,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MDc1NTI5Ng==",
      "original_commit_id" : "a5415e85caaf2f5a77d6bae9574bb6d21139ee34",
      "original_position" : 79,
      "path" : "src/validation.cpp",
      "position" : 79,
      "pull_request_review_id" : 220970659,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/270755296",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r270783503"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/270783503"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If I understand correctly: the higher level (ie, changing the 10's to 100's in 96cedc8d0c0e3ad279bc2223a7fc3185b17ebde5 - the \"clean up banning levels\" commit) isn't a problem because these failures are all consensus ones, so any reasonable implementation shouldn't be making them. (Except for immature coinbase and missing inputs at the mempool level which are downgraded elsewhere)",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-01T09:29:07Z",
      "diff_hunk" : "@@ -3106,28 +3124,30 @@ bool CheckBlock(const CBlock& block, CValidationState& state, const Consensus::P\n \n     // Size limits\n     if (block.vtx.empty() || block.vtx.size() * WITNESS_SCALE_FACTOR > MAX_BLOCK_WEIGHT || ::GetSerializeSize(block, PROTOCOL_VERSION | SERIALIZE_TRANSACTION_NO_WITNESS) * WITNESS_SCALE_FACTOR > MAX_BLOCK_WEIGHT)\n-        return state.DoS(100, false, REJECT_INVALID, \"bad-blk-length\", false, \"size limits failed\");\n+        return state.DoS(100, ValidationInvalidReason::CONSENSUS, false, REJECT_INVALID, \"bad-blk-length\", false, \"size limits failed\");\n \n     // First transaction must be coinbase, the rest must not be\n     if (block.vtx.empty() || !block.vtx[0]->IsCoinBase())\n-        return state.DoS(100, false, REJECT_INVALID, \"bad-cb-missing\", false, \"first tx is not coinbase\");\n+        return state.DoS(100, ValidationInvalidReason::CONSENSUS, false, REJECT_INVALID, \"bad-cb-missing\", false, \"first tx is not coinbase\");\n     for (unsigned int i = 1; i < block.vtx.size(); i++)\n         if (block.vtx[i]->IsCoinBase())\n-            return state.DoS(100, false, REJECT_INVALID, \"bad-cb-multiple\", false, \"more than one coinbase\");\n+            return state.DoS(100, ValidationInvalidReason::CONSENSUS, false, REJECT_INVALID, \"bad-cb-multiple\", false, \"more than one coinbase\");\n \n     // Check transactions\n-    for (const auto& tx : block.vtx)\n-        if (!CheckTransaction(*tx, state, true))\n-            return state.Invalid(false, state.GetRejectCode(), state.GetRejectReason(),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r270783503",
      "id" : 270783503,
      "in_reply_to_id" : 248041505,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MDc4MzUwMw==",
      "original_commit_id" : "a5415e85caaf2f5a77d6bae9574bb6d21139ee34",
      "original_position" : 345,
      "path" : "src/validation.cpp",
      "position" : 403,
      "pull_request_review_id" : 221006144,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/270783503",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-04-01T15:56:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-478638474",
      "id" : 478638474,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15141",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3ODYzODQ3NA==",
      "updated_at" : "2019-04-01T15:56:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/478638474",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r271039747"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271039747"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This seems fluffy - I suspect we'd want to call out specific changes if we were to actually do something like this.\r\nI guess there's value in having it here as a conceptual placeholder, but I'd be surprised if this symbol ever actually got used.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-01T20:34:34Z",
      "diff_hunk" : "@@ -22,6 +22,50 @@ static const unsigned char REJECT_NONSTANDARD = 0x40;\n static const unsigned char REJECT_INSUFFICIENTFEE = 0x42;\n static const unsigned char REJECT_CHECKPOINT = 0x43;\n \n+/** A \"reason\" why something was invalid, suitable for determining whether the\n+  * provider of the object should be banned/ignored/disconnected/etc.\n+  * These are much more granular than the rejection codes, which may be more\n+  * useful for some other use-cases.\n+  */\n+enum class ValidationInvalidReason {\n+    // txn and blocks:\n+    NONE,                    //!< not actually invalid\n+    CONSENSUS,               //!< invalid by consensus rules (excluding any below reasons)\n+    /**\n+     * Invalid by a change to consensus rules more recent than SegWit.\n+     * Currently unused as there are no such consensus rule changes, and any download\n+     * sources realistically need to support SegWit in order to provide useful data,\n+     * so differentiating between always-invalid and invalid-by-pre-SegWit-soft-fork\n+     * is uninteresting.\n+     */\n+    RECENT_CONSENSUS_CHANGE,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r271039747",
      "id" : 271039747,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTAzOTc0Nw==",
      "original_commit_id" : "ef099b059a28c7f661719f2e023a7284c2aa3823",
      "original_position" : 20,
      "path" : "src/consensus/validation.h",
      "position" : 20,
      "pull_request_review_id" : 221308675,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271039747",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r271040842"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271040842"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nice.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-01T20:37:44Z",
      "diff_hunk" : "@@ -72,12 +120,40 @@ class CValidationState {\n         return mode == MODE_ERROR;\n     }\n     bool CorruptionPossible() const {\n+        assert(corruptionPossible == (reason == ValidationInvalidReason::BLOCK_MUTATED || reason == ValidationInvalidReason::TX_WITNESS_MUTATED));\n         return corruptionPossible;\n     }\n     void SetCorruptionPossible() {\n         corruptionPossible = true;\n+        assert(corruptionPossible == (reason == ValidationInvalidReason::BLOCK_MUTATED || reason == ValidationInvalidReason::TX_WITNESS_MUTATED));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r271040842",
      "id" : 271040842,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTA0MDg0Mg==",
      "original_commit_id" : "ef099b059a28c7f661719f2e023a7284c2aa3823",
      "original_position" : 100,
      "path" : "src/consensus/validation.h",
      "position" : null,
      "pull_request_review_id" : 221308675,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271040842",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r271044827"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271044827"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I know this is behavior we're inheriting, but I find it kind of weird that too many sigops in a transaction is considered a standardness issue (score 0), but too many sigops in a block is consensus violation (ban). I guess conceptually it's not as bad to try to broadcast a transaction that has too many sigops vs. a PoW'd block, but I'm curious if there's a specific reason for the inconsistency beyond that. Again, sort of an academic question outside the scope of this PR.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-01T20:48:37Z",
      "diff_hunk" : "@@ -3123,7 +3145,7 @@ bool CheckBlock(const CBlock& block, CValidationState& state, const Consensus::P\n         nSigOps += GetLegacySigOpCount(*tx);\n     }\n     if (nSigOps * WITNESS_SCALE_FACTOR > MAX_BLOCK_SIGOPS_COST)\n-        return state.DoS(100, false, REJECT_INVALID, \"bad-blk-sigops\", false, \"out-of-bounds SigOpCount\");\n+        return state.DoS(100, ValidationInvalidReason::CONSENSUS, false, REJECT_INVALID, \"bad-blk-sigops\", false, \"out-of-bounds SigOpCount\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r271044827",
      "id" : 271044827,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTA0NDgyNw==",
      "original_commit_id" : "ef099b059a28c7f661719f2e023a7284c2aa3823",
      "original_position" : 344,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 221308675,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271044827",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r271653942"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271653942"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Happy to remove if others agree since that was my preference as well, but I left this in because Matt preferred it when we originally discussed this on his PR.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-03T09:28:21Z",
      "diff_hunk" : "@@ -22,6 +22,50 @@ static const unsigned char REJECT_NONSTANDARD = 0x40;\n static const unsigned char REJECT_INSUFFICIENTFEE = 0x42;\n static const unsigned char REJECT_CHECKPOINT = 0x43;\n \n+/** A \"reason\" why something was invalid, suitable for determining whether the\n+  * provider of the object should be banned/ignored/disconnected/etc.\n+  * These are much more granular than the rejection codes, which may be more\n+  * useful for some other use-cases.\n+  */\n+enum class ValidationInvalidReason {\n+    // txn and blocks:\n+    NONE,                    //!< not actually invalid\n+    CONSENSUS,               //!< invalid by consensus rules (excluding any below reasons)\n+    /**\n+     * Invalid by a change to consensus rules more recent than SegWit.\n+     * Currently unused as there are no such consensus rule changes, and any download\n+     * sources realistically need to support SegWit in order to provide useful data,\n+     * so differentiating between always-invalid and invalid-by-pre-SegWit-soft-fork\n+     * is uninteresting.\n+     */\n+    RECENT_CONSENSUS_CHANGE,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r271653942",
      "id" : 271653942,
      "in_reply_to_id" : 271039747,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTY1Mzk0Mg==",
      "original_commit_id" : "ef099b059a28c7f661719f2e023a7284c2aa3823",
      "original_position" : 20,
      "path" : "src/consensus/validation.h",
      "position" : 20,
      "pull_request_review_id" : 222096674,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271653942",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased.  Old version is here: https://github.com/sdaftuar/bitcoin/commits/15141.7",
      "created_at" : "2019-04-03T09:29:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-479413048",
      "id" : 479413048,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15141",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3OTQxMzA0OA==",
      "updated_at" : "2019-04-03T09:29:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/479413048",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "reACK daf674e55a4efbf6031af8389de2537ed32b4bcc based on a review of [the interdiff](https://gist.github.com/jamesob/26a9a2fcdad52097ea4e2d891adb2f99).",
      "created_at" : "2019-04-03T15:16:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-479533964",
      "id" : 479533964,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15141",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3OTUzMzk2NA==",
      "updated_at" : "2019-04-03T15:16:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/479533964",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r271798923"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271798923"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It's not hurting anything; I'd rather have this merged and remove it later.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-03T15:25:16Z",
      "diff_hunk" : "@@ -22,6 +22,50 @@ static const unsigned char REJECT_NONSTANDARD = 0x40;\n static const unsigned char REJECT_INSUFFICIENTFEE = 0x42;\n static const unsigned char REJECT_CHECKPOINT = 0x43;\n \n+/** A \"reason\" why something was invalid, suitable for determining whether the\n+  * provider of the object should be banned/ignored/disconnected/etc.\n+  * These are much more granular than the rejection codes, which may be more\n+  * useful for some other use-cases.\n+  */\n+enum class ValidationInvalidReason {\n+    // txn and blocks:\n+    NONE,                    //!< not actually invalid\n+    CONSENSUS,               //!< invalid by consensus rules (excluding any below reasons)\n+    /**\n+     * Invalid by a change to consensus rules more recent than SegWit.\n+     * Currently unused as there are no such consensus rule changes, and any download\n+     * sources realistically need to support SegWit in order to provide useful data,\n+     * so differentiating between always-invalid and invalid-by-pre-SegWit-soft-fork\n+     * is uninteresting.\n+     */\n+    RECENT_CONSENSUS_CHANGE,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r271798923",
      "id" : 271798923,
      "in_reply_to_id" : 271039747,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTc5ODkyMw==",
      "original_commit_id" : "ef099b059a28c7f661719f2e023a7284c2aa3823",
      "original_position" : 20,
      "path" : "src/consensus/validation.h",
      "position" : 20,
      "pull_request_review_id" : 222283602,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271798923",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r273244827"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273244827"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Can you amend the commit message to indicate *why* the \"obsolete comment\" is obsolete?",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-08T21:24:23Z",
      "diff_hunk" : "@@ -729,11 +729,6 @@ static bool AcceptToMemoryPoolWorker(const CChainParams& chainparams, CTxMemPool\n                               fSpendsCoinbase, nSigOpsCost, lp);\n         unsigned int nSize = entry.GetTxSize();\n \n-        // Check that the transaction doesn't have an excessive number of\n-        // sigops, making it impossible to mine. Since the coinbase transaction\n-        // itself can contain sigops MAX_STANDARD_TX_SIGOPS is less than\n-        // MAX_BLOCK_SIGOPS; we still consider this an invalid rather than\n-        // merely non-standard transaction.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r273244827",
      "id" : 273244827,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MzI0NDgyNw==",
      "original_commit_id" : "daf8a2e3d9b1f01b18e8e50fcbf83dc0de48a279",
      "original_position" : 8,
      "path" : "src/validation.cpp",
      "position" : 83,
      "pull_request_review_id" : 224092954,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273244827",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r273247912"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273247912"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "\"Use maybepunish\" needs a real commitmessage. Wtf is a \"maybepunish\" and why are we using it?",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-08T21:34:09Z",
      "diff_hunk" : "@@ -960,6 +960,23 @@ void Misbehaving(NodeId pnode, int howmuch, const std::string& message) EXCLUSIV\n         LogPrint(BCLog::NET, \"%s: %s peer=%d (%d -> %d)%s\\n\", __func__, state->name, pnode, state->nMisbehavior-howmuch, state->nMisbehavior, message_prefixed);\n }\n \n+static bool MayResultInDisconnect(const CValidationState& state, bool via_compact_block) {\n+    return (state.GetDoS() > 0);\n+}\n+\n+static bool MaybePunishNode(NodeId nodeid, const CValidationState& state, bool via_compact_block, const std::string& message = \"\") {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r273247912",
      "id" : 273247912,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MzI0NzkxMg==",
      "original_commit_id" : "daf17f580fdd8f5ae1f8cfd940f848437d4fadc4",
      "original_position" : 8,
      "path" : "src/net_processing.cpp",
      "position" : 54,
      "pull_request_review_id" : 224092954,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273247912",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r273627490"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273627490"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In \"use maybepunish\" - this is a major behavior change. After this commit sending an invalid header via compact block no longer gets a ban when it previously did.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-09T17:54:28Z",
      "diff_hunk" : "@@ -2578,14 +2583,8 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n         const CBlockIndex *pindex = nullptr;\n         CValidationState state;\n         if (!ProcessNewBlockHeaders({cmpctblock.header}, state, chainparams, &pindex)) {\n-            int nDoS;\n-            if (state.IsInvalid(nDoS)) {\n-                if (nDoS > 0) {\n-                    LOCK(cs_main);\n-                    Misbehaving(pfrom->GetId(), nDoS, strprintf(\"Peer %d sent us invalid header via cmpctblock\\n\", pfrom->GetId()));\n-                } else {\n-                    LogPrint(BCLog::NET, \"Peer %d sent us invalid header via cmpctblock\\n\", pfrom->GetId());\n-                }\n+            if (state.IsInvalid()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r273627490",
      "id" : 273627490,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MzYyNzQ5MA==",
      "original_commit_id" : "daf17f580fdd8f5ae1f8cfd940f848437d4fadc4",
      "original_position" : 124,
      "path" : "src/net_processing.cpp",
      "position" : 302,
      "pull_request_review_id" : 224092954,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273627490",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r273628371"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273628371"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Can you just drop this commit? Its really nontrivial to review and, by the end, is unused anyway.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-09T17:56:33Z",
      "diff_hunk" : "@@ -45,9 +45,9 @@ class CValidationState {\n         strRejectReason = strRejectReasonIn;\n         corruptionPossible = corruptionIn;\n         strDebugMessage = strDebugMessageIn;\n+        nDoS = level;\n         if (mode == MODE_ERROR)\n             return ret;\n-        nDoS += level;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r273628371",
      "id" : 273628371,
      "in_reply_to_id" : 262963047,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MzYyODM3MQ==",
      "original_commit_id" : "858bae6104ba7d16a637920d7802bb4be4c64994",
      "original_position" : 7,
      "path" : "src/consensus/validation.h",
      "position" : 106,
      "pull_request_review_id" : 224092954,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273628371",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r273635618"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273635618"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This now results in banning peers when they relay us mempool transactions when we aren't yet fully synced. I dont think this is acceptable. Also, you add this here and then have a commit dedicated to removing it later, all to make intermediate assert()s pass, when you could just change the above DoS score...",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-09T18:14:34Z",
      "diff_hunk" : "@@ -221,8 +221,8 @@ bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, c\n \n         // If prev is coinbase, check that it's matured\n         if (coin.IsCoinBase() && nSpendHeight - coin.nHeight < COINBASE_MATURITY) {\n-            return state.Invalid(false,\n-                REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\n+            return state.DoS(100, false,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r273635618",
      "id" : 273635618,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MzYzNTYxOA==",
      "original_commit_id" : "daf35b19b3841fe93dfd717b7c233ff293b61503",
      "original_position" : 27,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : null,
      "pull_request_review_id" : 224092954,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273635618",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r273651943"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273651943"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Both of these asserts are useless - we remove the value later in the same PR - please enforce this using the scripted-diff or just remove them - they only serve to confuse reviewers.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-09T18:53:06Z",
      "diff_hunk" : "@@ -30,31 +74,35 @@ class CValidationState {\n         MODE_INVALID, //!< network rule violation (DoS value may be set)\n         MODE_ERROR,   //!< run-time error\n     } mode;\n+    ValidationInvalidReason reason;\n     int nDoS;\n     std::string strRejectReason;\n     unsigned int chRejectCode;\n     bool corruptionPossible;\n     std::string strDebugMessage;\n public:\n-    CValidationState() : mode(MODE_VALID), nDoS(0), chRejectCode(0), corruptionPossible(false) {}\n-    bool DoS(int level, bool ret = false,\n+    CValidationState() : mode(MODE_VALID), reason(ValidationInvalidReason::NONE), nDoS(0), chRejectCode(0), corruptionPossible(false) {}\n+    bool DoS(int level, ValidationInvalidReason reasonIn, bool ret = false,\n              unsigned int chRejectCodeIn=0, const std::string &strRejectReasonIn=\"\",\n              bool corruptionIn=false,\n              const std::string &strDebugMessageIn=\"\") {\n+        reason = reasonIn;\n         chRejectCode = chRejectCodeIn;\n         strRejectReason = strRejectReasonIn;\n         corruptionPossible = corruptionIn;\n         strDebugMessage = strDebugMessageIn;\n         nDoS = level;\n+        assert(nDoS == GetDoSForReason());\n+        assert(corruptionPossible == (reason == ValidationInvalidReason::BLOCK_MUTATED || reason == ValidationInvalidReason::TX_WITNESS_MUTATED));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r273651943",
      "id" : 273651943,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MzY1MTk0Mw==",
      "original_commit_id" : "daf2ece95a26a4487da7239d2522a7c8f65f7720",
      "original_position" : 76,
      "path" : "src/consensus/validation.h",
      "position" : null,
      "pull_request_review_id" : 224092954,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273651943",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r273653409"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273653409"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is nonsense, why is it in consensus code, and why is it removed later? It just makes review harder.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-09T18:56:54Z",
      "diff_hunk" : "@@ -72,12 +120,40 @@ class CValidationState {\n         return mode == MODE_ERROR;\n     }\n     bool CorruptionPossible() const {\n+        assert(corruptionPossible == (reason == ValidationInvalidReason::BLOCK_MUTATED || reason == ValidationInvalidReason::TX_WITNESS_MUTATED));\n         return corruptionPossible;\n     }\n     void SetCorruptionPossible() {\n         corruptionPossible = true;\n+        assert(corruptionPossible == (reason == ValidationInvalidReason::BLOCK_MUTATED || reason == ValidationInvalidReason::TX_WITNESS_MUTATED));\n     }\n     int GetDoS(void) const { return nDoS; }\n+    int GetDoSForReason() const {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r273653409",
      "id" : 273653409,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MzY1MzQwOQ==",
      "original_commit_id" : "daf2ece95a26a4487da7239d2522a7c8f65f7720",
      "original_position" : 103,
      "path" : "src/consensus/validation.h",
      "position" : null,
      "pull_request_review_id" : 224092954,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273653409",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r273654298"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273654298"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "what? The compiler will warn you if you are missing an entry, instead of adding an assert which only warns at runtime?",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-09T18:59:12Z",
      "diff_hunk" : "@@ -72,12 +120,40 @@ class CValidationState {\n         return mode == MODE_ERROR;\n     }\n     bool CorruptionPossible() const {\n+        assert(corruptionPossible == (reason == ValidationInvalidReason::BLOCK_MUTATED || reason == ValidationInvalidReason::TX_WITNESS_MUTATED));\n         return corruptionPossible;\n     }\n     void SetCorruptionPossible() {\n         corruptionPossible = true;\n+        assert(corruptionPossible == (reason == ValidationInvalidReason::BLOCK_MUTATED || reason == ValidationInvalidReason::TX_WITNESS_MUTATED));\n     }\n     int GetDoS(void) const { return nDoS; }\n+    int GetDoSForReason() const {\n+        switch (reason) {\n+        case ValidationInvalidReason::NONE:\n+            return 0;\n+        case ValidationInvalidReason::CONSENSUS:\n+        case ValidationInvalidReason::BLOCK_MUTATED:\n+        case ValidationInvalidReason::BLOCK_INVALID_HEADER:\n+        case ValidationInvalidReason::BLOCK_CHECKPOINT:\n+        case ValidationInvalidReason::BLOCK_INVALID_PREV:\n+        case ValidationInvalidReason::TX_MISSING_INPUTS:\n+            return 100;\n+        case ValidationInvalidReason::BLOCK_MISSING_PREV:\n+            return 10;\n+        case ValidationInvalidReason::CACHED_INVALID:\n+        case ValidationInvalidReason::RECENT_CONSENSUS_CHANGE:\n+        case ValidationInvalidReason::BLOCK_BAD_TIME:\n+        case ValidationInvalidReason::TX_NOT_STANDARD:\n+        case ValidationInvalidReason::TX_WITNESS_MUTATED:\n+        case ValidationInvalidReason::TX_CONFLICT:\n+        case ValidationInvalidReason::TX_MEMPOOL_POLICY:\n+            return 0;\n+        default:\n+            assert(false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r273654298",
      "id" : 273654298,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MzY1NDI5OA==",
      "original_commit_id" : "daf2ece95a26a4487da7239d2522a7c8f65f7720",
      "original_position" : 125,
      "path" : "src/consensus/validation.h",
      "position" : null,
      "pull_request_review_id" : 224092954,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273654298",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r273654487"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273654487"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Huh?! Just remove the parameter, then.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-09T18:59:42Z",
      "diff_hunk" : "@@ -961,10 +961,13 @@ void Misbehaving(NodeId pnode, int howmuch, const std::string& message) EXCLUSIV\n }\n \n static bool MayResultInDisconnect(const CValidationState& state, bool via_compact_block) {\n+    assert(!via_compact_block);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r273654487",
      "id" : 273654487,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MzY1NDQ4Nw==",
      "original_commit_id" : "daf2ece95a26a4487da7239d2522a7c8f65f7720",
      "original_position" : 4,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 224092954,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273654487",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r273662210"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273662210"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Still this. Also, the grammar here is confusing - what may not be the case until we add new flags? I think you meant \"note that this may not be the case *after* we add additional flags\"",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-09T19:21:34Z",
      "diff_hunk" : "@@ -2015,17 +2020,29 @@ bool CChainState::ConnectBlock(const CBlock& block, CValidationState& state, CBl\n         // * witness (when witness enabled in flags and excludes coinbase)\n         nSigOpsCost += GetTransactionSigOpCost(tx, view, flags);\n         if (nSigOpsCost > MAX_BLOCK_SIGOPS_COST)\n-            return state.DoS(100, error(\"ConnectBlock(): too many sigops\"),\n+            return state.Invalid(ValidationInvalidReason::CONSENSUS, error(\"ConnectBlock(): too many sigops\"),\n                              REJECT_INVALID, \"bad-blk-sigops\");\n \n         txdata.emplace_back(tx);\n         if (!tx.IsCoinBase())\n         {\n             std::vector<CScriptCheck> vChecks;\n             bool fCacheResults = fJustCheck; /* Don't cache results if we're actually connecting blocks (still consult the cache, though) */\n-            if (!CheckInputs(tx, state, view, fScriptChecks, flags, fCacheResults, fCacheResults, txdata[i], nScriptCheckThreads ? &vChecks : nullptr))\n+            if (!CheckInputs(tx, state, view, fScriptChecks, flags, fCacheResults, fCacheResults, txdata[i], nScriptCheckThreads ? &vChecks : nullptr)) {\n+                if (state.GetReason() == ValidationInvalidReason::TX_NOT_STANDARD) {\n+                    // CheckInputs may return NOT_STANDARD for extra flags we passed,\n+                    // but we can't return that, as it's not defined for a block, so\n+                    // we reset the reason flag to CONSENSUS here.\n+                    // (note that this may not be the case until we add additional\n+                    // soft-fork flags to our script flags, in which case we  need to",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r273662210",
      "id" : 273662210,
      "in_reply_to_id" : 262355138,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MzY2MjIxMA==",
      "original_commit_id" : "beb6a373bdfa91166c8872909ccce31c5b0d72a3",
      "original_position" : 322,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 224092954,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273662210",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r273662927"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273662927"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This name is somewhat more generic than it needs to be - maybe call it BLOCK_TIME_FUTURE.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-09T19:23:35Z",
      "diff_hunk" : "@@ -22,6 +22,50 @@ static const unsigned char REJECT_NONSTANDARD = 0x40;\n static const unsigned char REJECT_INSUFFICIENTFEE = 0x42;\n static const unsigned char REJECT_CHECKPOINT = 0x43;\n \n+/** A \"reason\" why something was invalid, suitable for determining whether the\n+  * provider of the object should be banned/ignored/disconnected/etc.\n+  * These are much more granular than the rejection codes, which may be more\n+  * useful for some other use-cases.\n+  */\n+enum class ValidationInvalidReason {\n+    // txn and blocks:\n+    NONE,                    //!< not actually invalid\n+    CONSENSUS,               //!< invalid by consensus rules (excluding any below reasons)\n+    /**\n+     * Invalid by a change to consensus rules more recent than SegWit.\n+     * Currently unused as there are no such consensus rule changes, and any download\n+     * sources realistically need to support SegWit in order to provide useful data,\n+     * so differentiating between always-invalid and invalid-by-pre-SegWit-soft-fork\n+     * is uninteresting.\n+     */\n+    RECENT_CONSENSUS_CHANGE,\n+    // Only blocks (or headers):\n+    CACHED_INVALID,          //!< this object was cached as being invalid, but we don't know why\n+    BLOCK_INVALID_HEADER,    //!< invalid proof of work or time too old\n+    BLOCK_MUTATED,           //!< the block's data didn't match the data committed to by the PoW\n+    BLOCK_MISSING_PREV,      //!< We don't have the previous block the checked one is built on\n+    BLOCK_INVALID_PREV,      //!< A block this one builds on is invalid\n+    BLOCK_BAD_TIME,          //!< block timestamp was > 2 hours in the future (or our clock is bad)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r273662927",
      "id" : 273662927,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MzY2MjkyNw==",
      "original_commit_id" : "daf2ece95a26a4487da7239d2522a7c8f65f7720",
      "original_position" : 27,
      "path" : "src/consensus/validation.h",
      "position" : null,
      "pull_request_review_id" : 224092954,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273662927",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r273663169"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273663169"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why is this CONSENSUS and not BLOCK_INVALID_HEADER?",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-09T19:24:16Z",
      "diff_hunk" : "@@ -3219,23 +3241,23 @@ static bool ContextualCheckBlockHeader(const CBlockHeader& block, CValidationSta\n         // MapBlockIndex.\n         CBlockIndex* pcheckpoint = Checkpoints::GetLastCheckpoint(params.Checkpoints());\n         if (pcheckpoint && nHeight < pcheckpoint->nHeight)\n-            return state.DoS(100, error(\"%s: forked chain older than last checkpoint (height %d)\", __func__, nHeight), REJECT_CHECKPOINT, \"bad-fork-prior-to-checkpoint\");\n+            return state.DoS(100, ValidationInvalidReason::BLOCK_CHECKPOINT, error(\"%s: forked chain older than last checkpoint (height %d)\", __func__, nHeight), REJECT_CHECKPOINT, \"bad-fork-prior-to-checkpoint\");\n     }\n \n     // Check timestamp against prev\n     if (block.GetBlockTime() <= pindexPrev->GetMedianTimePast())\n-        return state.DoS(100, false, REJECT_INVALID, \"time-too-old\", false, \"block's timestamp is too early\");\n+        return state.DoS(100, ValidationInvalidReason::BLOCK_INVALID_HEADER, false, REJECT_INVALID, \"time-too-old\", false, \"block's timestamp is too early\");\n \n     // Check timestamp\n     if (block.GetBlockTime() > nAdjustedTime + MAX_FUTURE_BLOCK_TIME)\n-        return state.Invalid(false, REJECT_INVALID, \"time-too-new\", \"block timestamp too far in the future\");\n+        return state.Invalid(ValidationInvalidReason::BLOCK_BAD_TIME, false, REJECT_INVALID, \"time-too-new\", \"block timestamp too far in the future\");\n \n     // Reject outdated version blocks when 95% (75% on testnet) of the network has upgraded:\n     // check for version 2, 3 and 4 upgrades\n     if((block.nVersion < 2 && nHeight >= consensusParams.BIP34Height) ||\n        (block.nVersion < 3 && nHeight >= consensusParams.BIP66Height) ||\n        (block.nVersion < 4 && nHeight >= consensusParams.BIP65Height))\n-            return state.DoS(100, false, REJECT_OBSOLETE, strprintf(\"bad-version(0x%08x)\", block.nVersion), false,\n+            return state.DoS(100, ValidationInvalidReason::CONSENSUS, false, REJECT_OBSOLETE, strprintf(\"bad-version(0x%08x)\", block.nVersion), false,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r273663169",
      "id" : 273663169,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MzY2MzE2OQ==",
      "original_commit_id" : "daf2ece95a26a4487da7239d2522a7c8f65f7720",
      "original_position" : 381,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 224092954,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273663169",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r273666745"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273666745"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Can you squash \"nit: reason -> m_reason\"? Please don't add full commits that just address nits. Ignoring the nit is also perfectly valid.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-09T19:34:40Z",
      "diff_hunk" : "@@ -74,16 +74,16 @@ class CValidationState {\n         MODE_INVALID, //!< network rule violation (DoS value may be set)\n         MODE_ERROR,   //!< run-time error\n     } mode;\n-    ValidationInvalidReason reason;\n+    ValidationInvalidReason m_reason;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r273666745",
      "id" : 273666745,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MzY2Njc0NQ==",
      "original_commit_id" : "dafd6200ae7a6dc336ac2120da9221e129e8f9b6",
      "original_position" : 5,
      "path" : "src/consensus/validation.h",
      "position" : 84,
      "pull_request_review_id" : 224092954,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273666745",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r273667031"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273667031"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Oof this really sucks. To avoid delaying this PR I think this is fine, but we *really* need to just switch to two different ValidationState classes for Transactions and Blocks.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-09T19:35:31Z",
      "diff_hunk" : "@@ -66,6 +66,32 @@ enum class ValidationInvalidReason {\n     TX_MEMPOOL_POLICY,        //!< violated mempool's fee/size/descendant/RBF/etc limits\n };\n \n+inline bool IsTransactionReason(ValidationInvalidReason r)\n+{\n+    return r == ValidationInvalidReason::NONE ||\n+           r == ValidationInvalidReason::CONSENSUS ||\n+           r == ValidationInvalidReason::RECENT_CONSENSUS_CHANGE ||\n+           r == ValidationInvalidReason::TX_NOT_STANDARD ||\n+           r == ValidationInvalidReason::TX_MISSING_INPUTS ||\n+           r == ValidationInvalidReason::TX_WITNESS_MUTATED ||\n+           r == ValidationInvalidReason::TX_CONFLICT ||\n+           r == ValidationInvalidReason::TX_MEMPOOL_POLICY;\n+}\n+\n+inline bool IsBlockReason(ValidationInvalidReason r)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r273667031",
      "id" : 273667031,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MzY2NzAzMQ==",
      "original_commit_id" : "dafbf9e9087aacd3498e1be5e444e516c22ef89c",
      "original_position" : 16,
      "path" : "src/consensus/validation.h",
      "position" : 62,
      "pull_request_review_id" : 224092954,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273667031",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-04-10T14:20:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-481711339",
      "id" : 481711339,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15141",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MTcxMTMzOQ==",
      "updated_at" : "2019-04-10T14:20:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/481711339",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've fully reviewed everything up to _Clean up banning levels_ (daf35b19b3841fe93dfd717b7c233ff293b61503) and quickly looked at the rest of the commits. I agree with @TheBlueMatt that some of the intermediate commits introduce behaviour changes and should be changed or squashed.\r\n\r\nI have a branch here https://github.com/jnewbery/bitcoin/tree/2019_04_clean_up_banning that rebases everything up to _Clean up banning levels_ on master, fixes a bunch of nits, expands comments and maintains existing p2p behaviour (except in the last commit which updates DoS scores). I think to make progress on this, we could open that as a separate PR as suggested by AJ here: https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-478474586. @sdaftuar I'm happy to open the PR if that helps you.",
      "created_at" : "2019-04-10T20:54:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-481861456",
      "id" : 481861456,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15141",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MTg2MTQ1Ng==",
      "updated_at" : "2019-04-10T20:54:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/481861456",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r274450461"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274450461"
         }
      },
      "author_association" : "MEMBER",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/15141#discussion_r262963047\r\n\r\nThis needs to be done in this early commit so that the second half of this PR is refactor-only. Once we move to invalid-reason based punishment, calling `Invalid()` on a `CValidationState` object  sets the reason and doesn't 'increment' it.\r\n\r\nI think this commit should stay, possible squashed with the following commit (_Clean up banning levels_) but with an expanded git commit log explaining why the change is being made and highlighting what reviewers should check to satisfy themselves that this isn't a behaviour change (that `DoS()` is never called more than once on the same object).",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-11T14:25:20Z",
      "diff_hunk" : "@@ -45,9 +45,9 @@ class CValidationState {\n         strRejectReason = strRejectReasonIn;\n         corruptionPossible = corruptionIn;\n         strDebugMessage = strDebugMessageIn;\n+        nDoS = level;\n         if (mode == MODE_ERROR)\n             return ret;\n-        nDoS += level;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r274450461",
      "id" : 274450461,
      "in_reply_to_id" : 262963047,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NDQ1MDQ2MQ==",
      "original_commit_id" : "858bae6104ba7d16a637920d7802bb4be4c64994",
      "original_position" : 7,
      "path" : "src/consensus/validation.h",
      "position" : 106,
      "pull_request_review_id" : 225570662,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274450461",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Old version of this pr is here: [15141.9](https://github.com/sdaftuar/bitcoin/commits/15141.9)\r\n\r\nI took that version and incorporated many of the comments and bugfixes Matt suggested, along with a few improvements from John, and a bunch of fixes to commit messages/authorship attribution/etc here: [15141.10](https://github.com/sdaftuar/bitcoin/commits/15141.10)\r\n\r\nHere's a diff of 15141.9 and 15141.10, which may be of some value to prior reviewers:\r\n```diff\r\ndiff --git a/src/net_processing.cpp b/src/net_processing.cpp\r\nindex d8cb564378e..b074cead4fd 100644\r\n--- a/src/net_processing.cpp\r\n+++ b/src/net_processing.cpp\r\n@@ -980,8 +980,18 @@ static bool TxRelayMayResultInDisconnect(const CValidationState& state)\r\n     return state.GetReason() == ValidationInvalidReason::CONSENSUS;\r\n }\r\n \r\n-//! Returns true if the peer was punished (probably disconnected)\r\n-//! Changes here may need to be reflected in TxRelayMayResultInDisconnect().\r\n+/**\r\n+ * Potentially ban a node based on the contents of a CValidationState object\r\n+ *\r\n+ * @param[in] via_compact_block: this bool is passed in because net_processing should\r\n+ * punish peers differently depending on whether the data was provided in a compact\r\n+ * block message or not. If the compact block had a valid header, but contained invalid\r\n+ * txs, the peer should not be punished. See BIP 152.\r\n+ *\r\n+ * @return Returns true if the peer was punished (probably disconnected)\r\n+ *\r\n+ * Changes here may need to be reflected in TxRelayMayResultInDisconnect().\r\n+ */\r\n static bool MaybePunishNode(NodeId nodeid, const CValidationState& state, bool via_compact_block, const std::string& message = \"\") {\r\n     switch (state.GetReason()) {\r\n     case ValidationInvalidReason::NONE:\r\n```\r\n\r\nFinally, I rebased all that back onto master and have pushed that here. (I think the rebase is easiest to verify by doing a merge with master, rather than re-doing the rebase -- it was pretty tedious since many commits touched the same conflicted files.)\r\n",
      "created_at" : "2019-04-11T18:37:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-482246149",
      "id" : 482246149,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15141",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MjI0NjE0OQ==",
      "updated_at" : "2019-04-13T20:16:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/482246149",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r274577540"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274577540"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done in latest version.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-11T18:38:07Z",
      "diff_hunk" : "@@ -729,11 +729,6 @@ static bool AcceptToMemoryPoolWorker(const CChainParams& chainparams, CTxMemPool\n                               fSpendsCoinbase, nSigOpsCost, lp);\n         unsigned int nSize = entry.GetTxSize();\n \n-        // Check that the transaction doesn't have an excessive number of\n-        // sigops, making it impossible to mine. Since the coinbase transaction\n-        // itself can contain sigops MAX_STANDARD_TX_SIGOPS is less than\n-        // MAX_BLOCK_SIGOPS; we still consider this an invalid rather than\n-        // merely non-standard transaction.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r274577540",
      "id" : 274577540,
      "in_reply_to_id" : 273244827,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NDU3NzU0MA==",
      "original_commit_id" : "daf8a2e3d9b1f01b18e8e50fcbf83dc0de48a279",
      "original_position" : 8,
      "path" : "src/validation.cpp",
      "position" : 83,
      "pull_request_review_id" : 225717133,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274577540",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r274577574"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274577574"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done in latest version.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-11T18:38:13Z",
      "diff_hunk" : "@@ -960,6 +960,23 @@ void Misbehaving(NodeId pnode, int howmuch, const std::string& message) EXCLUSIV\n         LogPrint(BCLog::NET, \"%s: %s peer=%d (%d -> %d)%s\\n\", __func__, state->name, pnode, state->nMisbehavior-howmuch, state->nMisbehavior, message_prefixed);\n }\n \n+static bool MayResultInDisconnect(const CValidationState& state, bool via_compact_block) {\n+    return (state.GetDoS() > 0);\n+}\n+\n+static bool MaybePunishNode(NodeId nodeid, const CValidationState& state, bool via_compact_block, const std::string& message = \"\") {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r274577574",
      "id" : 274577574,
      "in_reply_to_id" : 273247912,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NDU3NzU3NA==",
      "original_commit_id" : "daf17f580fdd8f5ae1f8cfd940f848437d4fadc4",
      "original_position" : 8,
      "path" : "src/net_processing.cpp",
      "position" : 54,
      "pull_request_review_id" : 225717173,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274577574",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r274577634"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274577634"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-11T18:38:22Z",
      "diff_hunk" : "@@ -2578,14 +2583,8 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n         const CBlockIndex *pindex = nullptr;\n         CValidationState state;\n         if (!ProcessNewBlockHeaders({cmpctblock.header}, state, chainparams, &pindex)) {\n-            int nDoS;\n-            if (state.IsInvalid(nDoS)) {\n-                if (nDoS > 0) {\n-                    LOCK(cs_main);\n-                    Misbehaving(pfrom->GetId(), nDoS, strprintf(\"Peer %d sent us invalid header via cmpctblock\\n\", pfrom->GetId()));\n-                } else {\n-                    LogPrint(BCLog::NET, \"Peer %d sent us invalid header via cmpctblock\\n\", pfrom->GetId());\n-                }\n+            if (state.IsInvalid()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r274577634",
      "id" : 274577634,
      "in_reply_to_id" : 273627490,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NDU3NzYzNA==",
      "original_commit_id" : "daf17f580fdd8f5ae1f8cfd940f848437d4fadc4",
      "original_position" : 124,
      "path" : "src/net_processing.cpp",
      "position" : 302,
      "pull_request_review_id" : 225717252,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274577634",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r274577714"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274577714"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed the banning brokenness.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-11T18:38:32Z",
      "diff_hunk" : "@@ -221,8 +221,8 @@ bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, c\n \n         // If prev is coinbase, check that it's matured\n         if (coin.IsCoinBase() && nSpendHeight - coin.nHeight < COINBASE_MATURITY) {\n-            return state.Invalid(false,\n-                REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\n+            return state.DoS(100, false,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r274577714",
      "id" : 274577714,
      "in_reply_to_id" : 273635618,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NDU3NzcxNA==",
      "original_commit_id" : "daf35b19b3841fe93dfd717b7c233ff293b61503",
      "original_position" : 27,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : null,
      "pull_request_review_id" : 225717327,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274577714",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r274577833"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274577833"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-11T18:38:53Z",
      "diff_hunk" : "@@ -74,16 +74,16 @@ class CValidationState {\n         MODE_INVALID, //!< network rule violation (DoS value may be set)\n         MODE_ERROR,   //!< run-time error\n     } mode;\n-    ValidationInvalidReason reason;\n+    ValidationInvalidReason m_reason;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r274577833",
      "id" : 274577833,
      "in_reply_to_id" : 273666745,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NDU3NzgzMw==",
      "original_commit_id" : "dafd6200ae7a6dc336ac2120da9221e129e8f9b6",
      "original_position" : 5,
      "path" : "src/consensus/validation.h",
      "position" : 84,
      "pull_request_review_id" : 225717488,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274577833",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r275136052"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/275136052"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@TheBlueMatt On further thought, I think this commit still introduces a bug in compact block headers handling, which is fixed later in this PR -- a duplicate-invalid header delivered by a compact block peer would cause that peer to get disconnected.  Will fix.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-13T23:45:19Z",
      "diff_hunk" : "@@ -2574,14 +2589,16 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n         const CBlockIndex *pindex = nullptr;\n         CValidationState state;\n         if (!ProcessNewBlockHeaders({cmpctblock.header}, state, chainparams, &pindex)) {\n-            int nDoS;\n-            if (state.IsInvalid(nDoS)) {\n-                if (nDoS > 0) {\n-                    LOCK(cs_main);\n-                    Misbehaving(pfrom->GetId(), nDoS, strprintf(\"Peer %d sent us invalid header via cmpctblock\\n\", pfrom->GetId()));\n-                } else {\n-                    LogPrint(BCLog::NET, \"Peer %d sent us invalid header via cmpctblock\\n\", pfrom->GetId());\n-                }\n+            if (state.IsInvalid()) {\n+                // We should punish compact block peers that give us an invalid\n+                // header (other than a \"duplicate-invalid\" one, see\n+                // ProcessHeadersMessage), so set via_compact_block to false\n+                // here.\n+                // TODO: when we switch from DoS scores to reasons that\n+                // tx/blocks are invalid, this call should set\n+                // via_compact_block to true, since MaybePunishNode will have\n+                // sufficient information to act correctly.\n+                MaybePunishNode(pfrom->GetId(), state, /*via_compact_block*/ false, \"invalid header via cmpctblock\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r275136052",
      "id" : 275136052,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NTEzNjA1Mg==",
      "original_commit_id" : "83fc55eb4120e879353cf1f77fe1a167c3f044aa",
      "original_position" : 156,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 226373247,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/275136052",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Just pushed up a new version that fixes a bug in an intermediate commit. (Final code was unchanged as the bug was already fixed in a later commit.)  Old version was [15141.11](https://github.com/sdaftuar/bitcoin/commits/15141.11).",
      "created_at" : "2019-04-14T12:15:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-482961641",
      "id" : 482961641,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15141",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4Mjk2MTY0MQ==",
      "updated_at" : "2019-04-14T12:15:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/482961641",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rewrote the history one more time to incorporate the rest of Matt's feedback (other than squashing some of the intermediate commits).  Old version is here: [15141.12](https://github.com/sdaftuar/bitcoin/commits/15141.12)\r\n\r\nAlso, @jnewbery pointed out somewhere (I seem to have lost the link to the comment) that reviewers should take note that DoS scores would accumulate, while the switch to Reason enums eliminates that potential accumulation, so reviewers should carefully check that the behavior changes that result are only the ones claimed in the PR.  I'll repeat that here to make sure everyone is aware of this (but I don't think it's necessary to repeat this in a commit message or in a comment in an intermediate commit).\r\n\r\nPlease re-review.  While the commit history has been rewritten to fix several bugs, the overall diff of what has been previously ACK'ed by some reviewers to the current version is still pretty small (modulo the rebase to master that happened in between).",
      "created_at" : "2019-04-15T15:07:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-483291375",
      "id" : 483291375,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15141",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MzI5MTM3NQ==",
      "updated_at" : "2019-04-15T15:07:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/483291375",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r275559383"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/275559383"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree that this is confusing. IMO, even better than passing in `state.GetDoS() to state.DoS()` would be:\r\n\r\n```\r\nstate.Invalid(ValidationInvalidReason::TX_WITNESS_MUTATED, false, state.GetRejectCode(), state.GetRejectReason(), state.GetDebugMessage());\r\nstate.SetCorruptionPossible();\r\n```",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-15T21:53:43Z",
      "diff_hunk" : "@@ -901,7 +901,8 @@ static bool AcceptToMemoryPoolWorker(const CChainParams& chainparams, CTxMemPool\n             if (!tx.HasWitness() && CheckInputs(tx, stateDummy, view, true, scriptVerifyFlags & ~(SCRIPT_VERIFY_WITNESS | SCRIPT_VERIFY_CLEANSTACK), true, false, txdata) &&\n                 !CheckInputs(tx, stateDummy, view, true, scriptVerifyFlags & ~SCRIPT_VERIFY_CLEANSTACK, true, false, txdata)) {\n                 // Only the witness is missing, so the transaction itself may be fine.\n-                state.SetCorruptionPossible();\n+                state.DoS(0, ValidationInvalidReason::TX_WITNESS_MUTATED, false,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r275559383",
      "id" : 275559383,
      "in_reply_to_id" : 255696468,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NTU1OTM4Mw==",
      "original_commit_id" : "ac3873e2a92457995f7e5a9e5fc24352af360c6b",
      "original_position" : 169,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 226899227,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/275559383",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think it's worth updating the git commit log in 088336aa3cab566a6418fb2e88824bdf668b8458 (_[refactor] Add useful-for-dos \"reason\" field to CValidationState_) to say that previously, blocks which had a transaction that failed a non-p2sh pre-segwit softfork would not result in a ban, but now will. I also think that you should remove the `[refactor]` tag for a commit which isn't a pure refactor and changes p2p behaviour.\r\n\r\n> Also, @jnewbery pointed out somewhere (I seem to have lost the link to the comment) that reviewers should take note that DoS scores would accumulate, while the switch to Reason enums eliminates that potential accumulation, so reviewers should carefully check that the behavior changes that result are only the ones claimed in the PR. I'll repeat that here to make sure everyone is aware of this (but I don't think it's necessary to repeat this in a commit message or in a comment in an intermediate commit).\r\n\r\ngit commit logs are basically free (there's almost no downside to being more verbose in them) and I often look at old commit logs for motivation/justification for changes. If you do change your mind and decide to include a justification in the commit, then the commit log from my branch was:\r\n\r\n```\r\nThis PR also introduces a subtle change in the way nDoS is set on\r\nCValidationState objects. Instead of incrementing the nDoS score when\r\nDoS() is called, the nDoS is set to the new value. This would\r\npotentially be a behavior change if DoS() were called more than once on\r\nthe same CValidationState object. To verify that this is not a behavior\r\nchange, check that DoS() is never called more than once on the same\r\nCValidationState object.\r\n```\r\n\r\nIf you wanted to make that change *really* easy to review, you could change the commit order so that all calls to `state.DoS(0...` are changed to `state.Invalid(...` before that commit. That means that the only call to `state.DoS(...` where the `nDoS` isn't 100 is the 'missing inputs' failure. Reviewers would only need to verify that the `CValidationState` set there hasn't already been set before, since calling `state.DoS(100, ...` has the same effect before and after that commit. (I'm not saying you should do that now, but it might aid other reviewers to see that that is equivalent to the final state of this PR).",
      "created_at" : "2019-04-15T22:03:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-483435610",
      "id" : 483435610,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15141",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MzQzNTYxMA==",
      "updated_at" : "2019-04-15T22:03:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/483435610",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r275642921"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/275642921"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "FWIW, I had a go at this. See https://github.com/ajtowns/bitcoin/commits/201904-dos-rework-sep\r\n\r\nI think it works okay, but splitting the type sure hits a lot of lines, see: https://github.com/ajtowns/bitcoin/commit/74bf5c12672d7eee877230d31b308c696fe83904 which is the commit that just splits the type. It's followed by the rest of this PR rebased on top of it, but with ValidationInvalidReason renamed to [Block|Tx]ValidationResult (since I'm touching every reference to that class anyway), and TX_PREMATURE_SPEND brought in initially rather than as a later commit.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-16T06:19:52Z",
      "diff_hunk" : "@@ -66,6 +66,32 @@ enum class ValidationInvalidReason {\n     TX_MEMPOOL_POLICY,        //!< violated mempool's fee/size/descendant/RBF/etc limits\n };\n \n+inline bool IsTransactionReason(ValidationInvalidReason r)\n+{\n+    return r == ValidationInvalidReason::NONE ||\n+           r == ValidationInvalidReason::CONSENSUS ||\n+           r == ValidationInvalidReason::RECENT_CONSENSUS_CHANGE ||\n+           r == ValidationInvalidReason::TX_NOT_STANDARD ||\n+           r == ValidationInvalidReason::TX_MISSING_INPUTS ||\n+           r == ValidationInvalidReason::TX_WITNESS_MUTATED ||\n+           r == ValidationInvalidReason::TX_CONFLICT ||\n+           r == ValidationInvalidReason::TX_MEMPOOL_POLICY;\n+}\n+\n+inline bool IsBlockReason(ValidationInvalidReason r)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r275642921",
      "id" : 275642921,
      "in_reply_to_id" : 273667031,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NTY0MjkyMQ==",
      "original_commit_id" : "dafbf9e9087aacd3498e1be5e444e516c22ef89c",
      "original_position" : 16,
      "path" : "src/consensus/validation.h",
      "position" : 62,
      "pull_request_review_id" : 227000975,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/275642921",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r275831887"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/275831887"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nice work @ajtowns, but I think @sdaftuar might have a meltdown if we try to rebase this PR on any additional changes at this point. It seems to me that splitting `CValidationState` into separate classes for Tx and Block can be done in a follow-up PR to this. I'll commit to reviewing that follow-up PR if you open it after this is merged.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-16T14:37:02Z",
      "diff_hunk" : "@@ -66,6 +66,32 @@ enum class ValidationInvalidReason {\n     TX_MEMPOOL_POLICY,        //!< violated mempool's fee/size/descendant/RBF/etc limits\n };\n \n+inline bool IsTransactionReason(ValidationInvalidReason r)\n+{\n+    return r == ValidationInvalidReason::NONE ||\n+           r == ValidationInvalidReason::CONSENSUS ||\n+           r == ValidationInvalidReason::RECENT_CONSENSUS_CHANGE ||\n+           r == ValidationInvalidReason::TX_NOT_STANDARD ||\n+           r == ValidationInvalidReason::TX_MISSING_INPUTS ||\n+           r == ValidationInvalidReason::TX_WITNESS_MUTATED ||\n+           r == ValidationInvalidReason::TX_CONFLICT ||\n+           r == ValidationInvalidReason::TX_MEMPOOL_POLICY;\n+}\n+\n+inline bool IsBlockReason(ValidationInvalidReason r)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r275831887",
      "id" : 275831887,
      "in_reply_to_id" : 273667031,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NTgzMTg4Nw==",
      "original_commit_id" : "dafbf9e9087aacd3498e1be5e444e516c22ef89c",
      "original_position" : 16,
      "path" : "src/consensus/validation.h",
      "position" : 62,
      "pull_request_review_id" : 227238169,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/275831887",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I think it's worth updating the git commit log in 088336a ([refactor] Add useful-for-dos \"reason\" field to CValidationState) to say that previously, blocks which had a transaction that failed a non-p2sh pre-segwit softfork would not result in a ban, but now will. I also think that you should remove the [refactor] tag for a commit which isn't a pure refactor and changes p2p behaviour.\r\n\r\nThis behavior change (where a node running with `-par=1` would potentially not ban for a block with invalid scripts, to now always banning regardless of whether `-par=1` or not) being present in that refactor commit was an oversight; I've moved it to its own commit.\r\n\r\nPrior version of the code is here: [15141.13](https://github.com/sdaftuar/bitcoin/commits/15141.13).  Once again there should be no diff in the final code.\r\n\r\nRegarding this:\r\n```This PR also introduces a subtle change in the way nDoS is set on\r\nCValidationState objects. Instead of incrementing the nDoS score when\r\nDoS() is called, the nDoS is set to the new value.\r\n```\r\nI actually dropped the commit (at Matt's request) where nDoS would not be incremented, so that the `assert()`'s that @ajtowns had suggested (comparing the DoS score to the reason enum) should be an effective reminder to the reviewer that incrementing is not taking place.\r\n\r\n",
      "created_at" : "2019-04-16T17:08:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-483762083",
      "id" : 483762083,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15141",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4Mzc2MjA4Mw==",
      "updated_at" : "2019-04-16T17:11:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/483762083",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r275943030"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/275943030"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: This should be \"not invalid or not yet tested for validity\"",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-16T18:49:33Z",
      "diff_hunk" : "@@ -22,6 +22,78 @@ static const unsigned char REJECT_NONSTANDARD = 0x40;\n static const unsigned char REJECT_INSUFFICIENTFEE = 0x42;\n static const unsigned char REJECT_CHECKPOINT = 0x43;\n \n+/** A \"reason\" why something was invalid, suitable for determining whether the\n+  * provider of the object should be banned/ignored/disconnected/etc.\n+  * These are much more granular than the rejection codes, which may be more\n+  * useful for some other use-cases.\n+  */\n+enum class ValidationInvalidReason {\n+    // txn and blocks:\n+    NONE,                    //!< not actually invalid",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r275943030",
      "id" : 275943030,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NTk0MzAzMA==",
      "original_commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "original_position" : 11,
      "path" : "src/consensus/validation.h",
      "position" : 11,
      "pull_request_review_id" : 227380925,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T19:41:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/275943030",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r275943653"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/275943653"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: I think this TODO should be next to the `TX_MISSING_INPUTS` line",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-16T18:51:18Z",
      "diff_hunk" : "@@ -22,6 +22,78 @@ static const unsigned char REJECT_NONSTANDARD = 0x40;\n static const unsigned char REJECT_INSUFFICIENTFEE = 0x42;\n static const unsigned char REJECT_CHECKPOINT = 0x43;\n \n+/** A \"reason\" why something was invalid, suitable for determining whether the\n+  * provider of the object should be banned/ignored/disconnected/etc.\n+  * These are much more granular than the rejection codes, which may be more\n+  * useful for some other use-cases.\n+  */\n+enum class ValidationInvalidReason {\n+    // txn and blocks:\n+    NONE,                    //!< not actually invalid\n+    CONSENSUS,               //!< invalid by consensus rules (excluding any below reasons)\n+    /**\n+     * Invalid by a change to consensus rules more recent than SegWit.\n+     * Currently unused as there are no such consensus rule changes, and any download\n+     * sources realistically need to support SegWit in order to provide useful data,\n+     * so differentiating between always-invalid and invalid-by-pre-SegWit-soft-fork\n+     * is uninteresting.\n+     */\n+    RECENT_CONSENSUS_CHANGE,\n+    // Only blocks (or headers):\n+    CACHED_INVALID,          //!< this object was cached as being invalid, but we don't know why\n+    BLOCK_INVALID_HEADER,    //!< invalid proof of work or time too old\n+    BLOCK_MUTATED,           //!< the block's data didn't match the data committed to by the PoW\n+    BLOCK_MISSING_PREV,      //!< We don't have the previous block the checked one is built on\n+    BLOCK_INVALID_PREV,      //!< A block this one builds on is invalid\n+    BLOCK_TIME_FUTURE,          //!< block timestamp was > 2 hours in the future (or our clock is bad)\n+    BLOCK_CHECKPOINT,        //!< the block failed to meet one of our checkpoints\n+    // Only loose txn:\n+    TX_NOT_STANDARD,          //!< didn't meet our local policy rules\n+    TX_MISSING_INPUTS,        //!< a transaction was missing some of its inputs\n+    TX_PREMATURE_SPEND,       //!< transaction spends a coinbase too early, or violates locktime/sequence locks\n+    /**\n+     * Transaction might be missing a witness, have a witness prior to SegWit\n+     * activation, or witness may have been malleated (which includes\n+     * non-standard witnesses).\n+     */\n+    TX_WITNESS_MUTATED,\n+    /**\n+     * Tx already in mempool or conflicts with a tx in the chain\n+     * (if it conflicts with another tx in mempool, we use MEMPOOL_POLICY as it failed to reach the RBF threshold)\n+     * TODO: Currently this is only used if the transaction already exists in the mempool or on chain,\n+     * TODO: ATMP's fMissingInputs and a valid CValidationState being used to indicate missing inputs",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r275943653",
      "id" : 275943653,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NTk0MzY1Mw==",
      "original_commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "original_position" : 43,
      "path" : "src/consensus/validation.h",
      "position" : 43,
      "pull_request_review_id" : 227380925,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T19:41:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/275943653",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r275947067"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/275947067"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: this seems like the wrong reason (although `nAbsurdFee` is only used by the wallet so it doesn't really matter. I also think that ATMP shouldn't take an `nAbsurdFee` parameter - see #15810)",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-16T19:00:39Z",
      "diff_hunk" : "@@ -721,27 +721,22 @@ static bool AcceptToMemoryPoolWorker(const CChainParams& chainparams, CTxMemPool\n                               fSpendsCoinbase, nSigOpsCost, lp);\n         unsigned int nSize = entry.GetTxSize();\n \n-        // Check that the transaction doesn't have an excessive number of\n-        // sigops, making it impossible to mine. Since the coinbase transaction\n-        // itself can contain sigops MAX_STANDARD_TX_SIGOPS is less than\n-        // MAX_BLOCK_SIGOPS; we still consider this an invalid rather than\n-        // merely non-standard transaction.\n         if (nSigOpsCost > MAX_STANDARD_TX_SIGOPS_COST)\n-            return state.DoS(0, false, REJECT_NONSTANDARD, \"bad-txns-too-many-sigops\", false,\n+            return state.Invalid(ValidationInvalidReason::TX_NOT_STANDARD, false, REJECT_NONSTANDARD, \"bad-txns-too-many-sigops\",\n                 strprintf(\"%d\", nSigOpsCost));\n \n         CAmount mempoolRejectFee = pool.GetMinFee(gArgs.GetArg(\"-maxmempool\", DEFAULT_MAX_MEMPOOL_SIZE) * 1000000).GetFee(nSize);\n         if (!bypass_limits && mempoolRejectFee > 0 && nModifiedFees < mempoolRejectFee) {\n-            return state.DoS(0, false, REJECT_INSUFFICIENTFEE, \"mempool min fee not met\", false, strprintf(\"%d < %d\", nModifiedFees, mempoolRejectFee));\n+            return state.Invalid(ValidationInvalidReason::TX_MEMPOOL_POLICY, false, REJECT_INSUFFICIENTFEE, \"mempool min fee not met\", strprintf(\"%d < %d\", nModifiedFees, mempoolRejectFee));\n         }\n \n         // No transactions are allowed below minRelayTxFee except from disconnected blocks\n         if (!bypass_limits && nModifiedFees < ::minRelayTxFee.GetFee(nSize)) {\n-            return state.DoS(0, false, REJECT_INSUFFICIENTFEE, \"min relay fee not met\", false, strprintf(\"%d < %d\", nModifiedFees, ::minRelayTxFee.GetFee(nSize)));\n+            return state.Invalid(ValidationInvalidReason::TX_MEMPOOL_POLICY, false, REJECT_INSUFFICIENTFEE, \"min relay fee not met\", strprintf(\"%d < %d\", nModifiedFees, ::minRelayTxFee.GetFee(nSize)));\n         }\n \n         if (nAbsurdFee && nFees > nAbsurdFee)\n-            return state.Invalid(false,\n+            return state.Invalid(ValidationInvalidReason::TX_NOT_STANDARD, false,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r275947067",
      "id" : 275947067,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NTk0NzA2Nw==",
      "original_commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "original_position" : 103,
      "path" : "src/validation.cpp",
      "position" : 103,
      "pull_request_review_id" : 227380925,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T19:41:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/275947067",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r275954338"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/275954338"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: change \"we don't know why\" to \"we didn't store the reason why\"",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-16T19:21:39Z",
      "diff_hunk" : "@@ -22,6 +22,78 @@ static const unsigned char REJECT_NONSTANDARD = 0x40;\n static const unsigned char REJECT_INSUFFICIENTFEE = 0x42;\n static const unsigned char REJECT_CHECKPOINT = 0x43;\n \n+/** A \"reason\" why something was invalid, suitable for determining whether the\n+  * provider of the object should be banned/ignored/disconnected/etc.\n+  * These are much more granular than the rejection codes, which may be more\n+  * useful for some other use-cases.\n+  */\n+enum class ValidationInvalidReason {\n+    // txn and blocks:\n+    NONE,                    //!< not actually invalid\n+    CONSENSUS,               //!< invalid by consensus rules (excluding any below reasons)\n+    /**\n+     * Invalid by a change to consensus rules more recent than SegWit.\n+     * Currently unused as there are no such consensus rule changes, and any download\n+     * sources realistically need to support SegWit in order to provide useful data,\n+     * so differentiating between always-invalid and invalid-by-pre-SegWit-soft-fork\n+     * is uninteresting.\n+     */\n+    RECENT_CONSENSUS_CHANGE,\n+    // Only blocks (or headers):\n+    CACHED_INVALID,          //!< this object was cached as being invalid, but we don't know why",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r275954338",
      "id" : 275954338,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NTk1NDMzOA==",
      "original_commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "original_position" : 22,
      "path" : "src/consensus/validation.h",
      "position" : 22,
      "pull_request_review_id" : 227380925,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T19:41:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/275954338",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r275958549"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/275958549"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: drop the `first_invalid_header` argument. It defaults to `nullptr` and your no longer using the returned value.\r\n\r\nFollow-up: remove the `first_invalid` argument from `ProcessNewBlockHeaders()` since none of the callers now use it.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-16T19:33:58Z",
      "diff_hunk" : "@@ -1551,48 +1642,8 @@ bool static ProcessHeadersMessage(CNode *pfrom, CConnman *connman, const std::ve\n     CValidationState state;\n     CBlockHeader first_invalid_header;\n     if (!ProcessNewBlockHeaders(headers, state, chainparams, &pindexLast, &first_invalid_header)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r275958549",
      "id" : 275958549,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NTk1ODU0OQ==",
      "original_commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "original_position" : 147,
      "path" : "src/net_processing.cpp",
      "position" : 147,
      "pull_request_review_id" : 227380925,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-16T19:41:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/275958549",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ajtowns @TheBlueMatt - you've both more-or-less ACKed a branch that reaches basically the same final state as this current branch. Are you able to reACK?",
      "created_at" : "2019-04-16T22:07:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-483862207",
      "id" : 483862207,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15141",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4Mzg2MjIwNw==",
      "updated_at" : "2019-04-16T22:07:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/483862207",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r278697544"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/278697544"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Noting for later reference:\r\n\r\nDefinitely not worth changing in this PR now given # of acks, but this can probably be cleaned up in a later PR to just give each category of error a unique prefix (e.g, make all TX_* have MSByte set to 3 and all BLOCK_* have MSB set to 2 and general set to 1) or something.\r\n\r\n```\r\nenum class ValidationInvalidReason : uint64_t {\r\n  IS_GENERAL REASON =1 << 56,\r\n  // ....\r\n  IS_BLOCK_REASON = 2 << 56\r\n // ....\r\n  IS_TX_REASON = 3 << 56\r\n}\r\n```\r\n\r\nThen these checks clean up to:\r\n\r\n```\r\nIS_TX_REASON & r || IS_GENERAL_REASON & r\r\n```\r\n\r\nThe downside is depending on the enum grouping order, but then this makes it easier to later modify the code to split these enums into different classes (while preserving offsets), and then make the general wrapper functions take the correct type of enum.",
      "commit_id" : "fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-25T19:27:03Z",
      "diff_hunk" : "@@ -66,6 +66,32 @@ enum class ValidationInvalidReason {\n     TX_MEMPOOL_POLICY,        //!< violated mempool's fee/size/descendant/RBF/etc limits\n };\n \n+inline bool IsTransactionReason(ValidationInvalidReason r)\n+{\n+    return r == ValidationInvalidReason::NONE ||\n+           r == ValidationInvalidReason::CONSENSUS ||\n+           r == ValidationInvalidReason::RECENT_CONSENSUS_CHANGE ||\n+           r == ValidationInvalidReason::TX_NOT_STANDARD ||\n+           r == ValidationInvalidReason::TX_MISSING_INPUTS ||\n+           r == ValidationInvalidReason::TX_WITNESS_MUTATED ||\n+           r == ValidationInvalidReason::TX_CONFLICT ||\n+           r == ValidationInvalidReason::TX_MEMPOOL_POLICY;\n+}\n+\n+inline bool IsBlockReason(ValidationInvalidReason r)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#discussion_r278697544",
      "id" : 278697544,
      "in_reply_to_id" : 273667031,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3ODY5NzU0NA==",
      "original_commit_id" : "dafbf9e9087aacd3498e1be5e444e516c22ef89c",
      "original_position" : 16,
      "path" : "src/consensus/validation.h",
      "position" : 62,
      "pull_request_review_id" : 230840415,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15141",
      "updated_at" : "2019-04-25T19:27:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/278697544",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK that this seems ok -- haven't had a chance to re-go through commit by commit and make sure the behavioral changes are solid, but they seem sensible.\r\n\r\nNoting that merging this would make it possible to reboot the work in https://github.com/bitcoin/bitcoin/pull/11523 if there's positive sentiment for it.",
      "created_at" : "2019-04-25T19:37:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-486810161",
      "id" : 486810161,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15141",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4NjgxMDE2MQ==",
      "updated_at" : "2019-04-25T19:37:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/486810161",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "utACK fdd7683c558984a96dd556e2c93dde156b85a75f",
      "created_at" : "2019-04-26T19:55:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15141#issuecomment-487181380",
      "id" : 487181380,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15141",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4NzE4MTM4MA==",
      "updated_at" : "2019-04-26T19:55:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/487181380",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   }
]
