{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "NONE",
   "body" : "The problem:\r\nSometimes, usually after Internet connection disturbances, it is impossible to stop bitcoin-qt or daemon.\r\n\r\nI'm expecting:\r\nThat on close command bitcoin-qt in GUI or daemon mode will finish it's operation in reasonable time and the database will contain the last synchronized blocks and is ready to continue the operation from it's current state.\r\n\r\nActual behavior:\r\nQt-interface is hanging on \"Bitcoin Core is shutting down\" window, daemon just remains as a process. None CPU or I/O load is created when the process stalls. None reads/writes to the storage, none percents of CPU load. Have confirmed by looking at htop and iotop terminals.\r\nBitcoin Core will running normally after WAN connection change or temporary problems. Newer peers are connected both way, the traffic is OK, all seems OK. But it will not stop operation normally any more. Only one way to stop is to send SIGQUIT to the process.\r\nThe worst thing is the loose of last Bitcoin Core session data. For example, if Bitcoin Core was running two weeks and was failed to stop correctly, at the next start it will continue only from two weeks ago state. The blocks need to be rescanned form HDD again. This taking rather long time.\r\nAfter shutdown problem it may be impossible to perform shutdown even if there were none problems with WAN. I had to restart the client several times to get normal close. After it closed correctly, Bitcoin Core operating normally and shutting down normally.\r\nHere is a log from unsuccessful shutdown:\r\n`2019-08-17T21:13:34Z GUI: requestShutdown : Requesting shutdown\r\n2019-08-17T21:13:34Z GUI: shutdown : Running Shutdown in thread\r\n2019-08-17T21:13:34Z Interrupting HTTP server\r\n2019-08-17T21:13:34Z Interrupting HTTP RPC server\r\n2019-08-17T21:13:34Z Interrupting RPC\r\n2019-08-17T21:13:34Z Shutdown: In progress...\r\n2019-08-17T21:13:34Z Stopping HTTP RPC server\r\n2019-08-17T21:13:34Z addcon thread exit\r\n2019-08-17T21:13:34Z opencon thread exit\r\n2019-08-17T21:13:34Z Stopping RPC\r\n2019-08-17T21:13:34Z Stopping HTTP server\r\n2019-08-17T21:13:34Z Stopped HTTP server\r\n2019-08-17T21:13:34Z BerkeleyEnvironment::Flush: [/media/nikolaypo/bitcoindb] Flush(false)\r\n2019-08-17T21:13:34Z BerkeleyEnvironment::Flush: Flushing wallet.dat (refcount = 0)...\r\n2019-08-17T21:13:34Z BerkeleyEnvironment::Flush: wallet.dat checkpoint\r\n2019-08-17T21:13:34Z BerkeleyEnvironment::Flush: wallet.dat detach\r\n2019-08-17T21:13:34Z net thread exit\r\n2019-08-17T21:13:34Z msghand thread exit\r\n2019-08-17T21:13:34Z BerkeleyEnvironment::Flush: wallet.dat closed\r\n2019-08-17T21:13:34Z BerkeleyEnvironment::Flush: Flush(false) took              86ms\r\n2019-08-17T21:13:34Z BerkeleyEnvironment::Flush: [/media/nikolaypo/bitcoindb] Flush(false)\r\n2019-08-17T21:13:34Z BerkeleyEnvironment::Flush: Flush(false) took               0ms\r\n2019-08-17T21:27:43Z Flushed 66639 addresses to peers.dat  656ms\r\n2019-08-17T21:42:44Z Flushed 66639 addresses to peers.dat  635ms\r\n2019-08-17T21:50:27Z Potential stale tip detected, will try using extra outbound peer (last tip update: 2260 seconds ago)\r\n2019-08-17T21:50:27Z net: setting try another outbound peer=true\r\n2019-08-17T21:57:44Z Flushed 66639 addresses to peers.dat  622ms\r\n2019-08-17T22:00:57Z Potential stale tip detected, will try using extra outbound peer (last tip update: 2890 seconds ago)\r\n2019-08-17T22:00:57Z net: setting try another outbound peer=true\r\n2019-08-17T22:11:27Z Potential stale tip detected, will try using extra outbound peer (last tip update: 3520 seconds ago)\r\n2019-08-17T22:11:27Z net: setting try another outbound peer=true\r\n2019-08-17T22:12:45Z Flushed 66639 addresses to peers.dat  605ms\r\n2019-08-17T22:21:57Z Potential stale tip detected, will try using extra outbound peer (last tip update: 4150 seconds ago)\r\n2019-08-17T22:21:57Z net: setting try another outbound peer=true\r\n2019-08-17T22:58:17Z `\r\nAgain, when the client hangs, it does not producing CPU or storage load.\r\n\r\nReproduction:\r\nKeep Bitcoin Core running normally. Then change WAN IP on upstream router by restarting PPTP interface. Let the client run some more to confirm normal behavior before stopping. Then try to close bitcoin-qt or send stop command to the daemon.\r\n\r\nSometimes the problem is not manifesting itself. But with about 10-30% of WAN connection disturbances or reconnects leads to impossibility of correct shutting down.\r\n\r\nHave tried v0.18.0 and v0.18.1, have tried amd64 and arm architectures. Have tried GCC 6.3 and GCC 9.1.0 compilers. The problem persisting with different builds and on different machines. All sources was from bitcoin project on github.com, the place were I'm leaving this issue description. I have not tested pre-compiled versions.\r\n\r\n1) Intel Core2Duo, Debian 9 Linux, amd64. 2) Rockchip  RK3399, Armbian Linux, aarch64-linux-gnu. With both machines I have used the same USB 3.0/SATA adapter with the same 3TB Seagate (rotating) HDD. EXT4.\r\n\r\nI had to rescan the database three times because of hardware failures, two times after a power loss, one time after USB interface sudden disconnection. May be there are the problems with blocks but fsck with -P parameter doesn't found an errors.\r\n\r\nAs for me, I need more feedback from Bitcoin Core client in case of problems and more robustness. One time I had a problem with one chainstate file corruption on the media I had to rescan the data base again from block zero. It is a pity that single file corruption cannot be recovered automatically without spending a lot of IO operations and CPU power for rescanning.\r\n\r\nThank you for your attention!\r\n\r\nNikolay",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 0,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16642/comments",
   "created_at" : "2019-08-17T23:24:46Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16642/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/16642",
   "id" : 481935673,
   "labels" : [],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16642/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDU6SXNzdWU0ODE5MzU2NzM=",
   "number" : 16642,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "title" : "Unable to stop bitcoin-qt. Potential stale tip detected in a loop.",
   "updated_at" : "2019-08-17T23:30:28Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16642",
   "user" : {
      "avatar_url" : "https://avatars2.githubusercontent.com/u/54221205?v=4",
      "events_url" : "https://api.github.com/users/Nikolay-Po/events{/privacy}",
      "followers_url" : "https://api.github.com/users/Nikolay-Po/followers",
      "following_url" : "https://api.github.com/users/Nikolay-Po/following{/other_user}",
      "gists_url" : "https://api.github.com/users/Nikolay-Po/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/Nikolay-Po",
      "id" : 54221205,
      "login" : "Nikolay-Po",
      "node_id" : "MDQ6VXNlcjU0MjIxMjA1",
      "organizations_url" : "https://api.github.com/users/Nikolay-Po/orgs",
      "received_events_url" : "https://api.github.com/users/Nikolay-Po/received_events",
      "repos_url" : "https://api.github.com/users/Nikolay-Po/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/Nikolay-Po/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/Nikolay-Po/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/Nikolay-Po"
   }
}
