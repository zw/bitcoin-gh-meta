{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "NONE",
   "body" : "With Bitcoin core v23 (Qt versin on Windows, or with the daemon from commandline), the IBD process can stall indefinitely after receiving a large block:\r\n```\r\n2022-08-07T13:24:50Z [net.cpp:3043] [CNode] Added connection to 104.248.143.83:8333 peer=0\r\n2022-08-07T13:24:50Z [net.cpp:3060] [PushMessage] sending version (102 bytes) peer=0\r\n2022-08-07T13:24:50Z [net_processing.cpp:1146] [PushNodeVersion] send version message: version 70016, blocks=239242, them=104.248.143.83:8333, txrelay=1, peer=0\r\n2022-08-07T13:24:50Z [net_processing.cpp:2558] [ProcessMessage] received: version (102 bytes) peer=0\r\n2022-08-07T13:24:50Z [net.cpp:3060] [PushMessage] sending verack (0 bytes) peer=0\r\n2022-08-07T13:24:50Z [net.cpp:3060] [PushMessage] sending getaddr (0 bytes) peer=0\r\n2022-08-07T13:24:50Z [net_processing.cpp:2754] [ProcessMessage] receive version message: /Satoshi:0.20.1/: version 70015, blocks=748403, us=104.248.143.83:8333, txrelay=1, peer=0, peeraddr=104.248.143.83:8333\r\n2022-08-07T13:24:50Z [timedata.cpp:57] [AddTimeData] added time data, samples 2, offset -1 (+0 minutes)\r\n2022-08-07T13:24:50Z [net_processing.cpp:2558] [ProcessMessage] received: verack (0 bytes) peer=0\r\n2022-08-07T13:24:50Z [net_processing.cpp:2797] [ProcessMessage] New outbound peer connected: version: 70015, blocks=748403, peer=0, peeraddr=104.248.143.83:8333 (manual)\r\n2022-08-07T13:24:50Z [net.cpp:3060] [PushMessage] sending sendheaders (0 bytes) peer=0\r\n2022-08-07T13:24:50Z [net.cpp:3060] [PushMessage] sending sendcmpct (9 bytes) peer=0\r\n2022-08-07T13:24:50Z [net.cpp:3060] [PushMessage] sending sendcmpct (9 bytes) peer=0\r\n2022-08-07T13:24:50Z [net.cpp:3060] [PushMessage] sending ping (8 bytes) peer=0\r\n2022-08-07T13:24:50Z [net_processing.cpp:4650] [SendMessages] initial getheaders (319216) to peer=0 (startheight:748403)\r\n2022-08-07T13:24:50Z [net.cpp:3060] [PushMessage] sending getheaders (997 bytes) peer=0\r\n2022-08-07T13:24:50Z [net.cpp:3060] [PushMessage] sending feefilter (8 bytes) peer=0\r\n2022-08-07T13:24:50Z [net_processing.cpp:2558] [ProcessMessage] received: sendheaders (0 bytes) peer=0\r\n2022-08-07T13:24:50Z [net_processing.cpp:2558] [ProcessMessage] received: sendcmpct (9 bytes) peer=0\r\n2022-08-07T13:24:50Z [net_processing.cpp:2558] [ProcessMessage] received: sendcmpct (9 bytes) peer=0\r\n2022-08-07T13:24:50Z [net_processing.cpp:2558] [ProcessMessage] received: ping (8 bytes) peer=0\r\n2022-08-07T13:24:50Z [net.cpp:3060] [PushMessage] sending pong (8 bytes) peer=0\r\n2022-08-07T13:24:50Z [net_processing.cpp:2558] [ProcessMessage] received: getheaders (1029 bytes) peer=0\r\n2022-08-07T13:24:50Z [net_processing.cpp:3223] [ProcessMessage] Ignoring getheaders from peer=0 because node is in initial block download\r\n2022-08-07T13:24:50Z [net_processing.cpp:2558] [ProcessMessage] received: feefilter (8 bytes) peer=0\r\n2022-08-07T13:24:50Z [net_processing.cpp:4051] [ProcessMessage] received: feefilter of 0.00001000 BTC/kvB from peer=0\r\n2022-08-07T13:24:50Z [net_processing.cpp:2558] [ProcessMessage] received: pong (8 bytes) peer=0\r\n2022-08-07T13:24:50Z [net_processing.cpp:2558] [ProcessMessage] received: headers (162003 bytes) peer=0\r\n```\r\nThen any other attemps to connect to other peers (or accept incoming connections) stalls permanently (we can waitfior hours: no network activity, no disk activity, but some thread uses 100% of a CPU core, probably in a tight loop generated by a deadlock and infinite attemps to recover from it).\r\n\r\nIf we try to shutdown, al most all databases thread are closed, the RPC services are closed, But the conenction manager remains locked for about ~15 minutes, not doing anything.\r\n\r\nIn fact the received headers are not even starting to be parse until AFTER these ~15 minutes. At which time we see that in logs:\r\n(note: I've enabled ```logtimestamps=1```, ```logsourcelocations=1``` and ```logthreadnames=1``` in bitcoin.conf to have more traceable traces; and run it with ```debug=all```).\r\n\r\nIt seems that a lock is kept somewhere in \"net_processing.cpp\" after the ProcessMessage() exists with \"Ignoring getheaders from peer=0 because node is in initial block download\"\r\n\r\nOnly when we shut down the node we see instantly:\r\n```\r\n2022-08-07T13:26:17Z [qt/bitcoin.cpp:207] [DebugMessageHandler] GUI: requestShutdown : Requesting shutdown\r\n2022-08-07T13:26:17Z [rpc/server.cpp:302] [operator()] Interrupting RPC\r\n2022-08-07T13:26:17Z [rpc/server.cpp:314] [operator()] Stopping RPC\r\n2022-08-07T13:26:17Z [init.cpp:371] [OnRPCStopped] RPC stopped.\r\n2022-08-07T13:26:17Z [qt/bitcoin.cpp:207] [DebugMessageHandler] GUI: Running Shutdown in thread\r\n2022-08-07T13:26:17Z [httpserver.cpp:436] [InterruptHTTPServer] Interrupting HTTP server\r\n2022-08-07T13:26:17Z [httprpc.cpp:312] [InterruptHTTPRPC] Interrupting HTTP RPC server\r\n2022-08-07T13:26:17Z [init.cpp:205] [Shutdown] Shutdown: In progress...\r\n2022-08-07T13:26:17Z [httprpc.cpp:317] [StopHTTPRPC] Stopping HTTP RPC server\r\n2022-08-07T13:26:17Z [httpserver.cpp:657] [UnregisterHTTPHandler] Unregistering HTTP handler for / (exactmatch 1)\r\n2022-08-07T13:26:17Z [httpserver.cpp:657] [UnregisterHTTPHandler] Unregistering HTTP handler for /wallet/ (exactmatch 0)\r\n2022-08-07T13:26:17Z [httpserver.cpp:448] [StopHTTPServer] Stopping HTTP server\r\n2022-08-07T13:26:17Z [httpserver.cpp:450] [StopHTTPServer] Waiting for HTTP worker threads to exit\r\n2022-08-07T13:26:17Z [util/thread.cpp:19] [TraceThread] opencon thread exit\r\n2022-08-07T13:26:17Z [util/thread.cpp:19] [TraceThread] dnsseed thread exit\r\n2022-08-07T13:26:17Z [util/thread.cpp:19] [TraceThread] addcon thread exit\r\n2022-08-07T13:26:17Z [httpserver.cpp:291] [ThreadHTTP] Exited http event loop\r\n2022-08-07T13:26:17Z [httpserver.cpp:463] [StopHTTPServer] Waiting for HTTP event thread to exit\r\n2022-08-07T13:26:17Z [httpserver.cpp:475] [StopHTTPServer] Stopped HTTP server\r\n2022-08-07T13:26:17Z [mapport.cpp:210] [ProcessUpnp] UPNP_DeletePortMapping() returned: 0\r\n2022-08-07T13:26:17Z [util/thread.cpp:19] [TraceThread] mapport thread exit\r\n```\r\nAnd then we wait for about 15-20 minutes to finally see this: the received block headers are processed, an attempt for sending another requests for headers is emitted, but all peers are finally disconnected (because we were shutting down), and all remaining data in moemory is flushed to disk and the node finally exits correctly.\r\n\r\n```\r\n2022-08-07T13:43:47Z [validation.cpp:3606] [ProcessNewBlockHeaders] Synchronizing blockheaders, height: 321216 (~43.64%)\r\n2022-08-07T13:43:47Z [net_processing.cpp:2198] [ProcessHeadersMessage] more getheaders (321216) to end to peer=0 (startheight:748403)\r\n2022-08-07T13:43:47Z [net.cpp:1262] [CreateNodeFromAcceptedSocket] connection from [2604:d500:4:1::2]:63949 accepted\r\n2022-08-07T13:43:47Z [util/thread.cpp:19] [TraceThread] net thread exit\r\n2022-08-07T13:43:47Z [net.cpp:3060] [PushMessage] sending getheaders (997 bytes) peer=0\r\n2022-08-07T13:43:47Z [dbwrapper.cpp:198] [WriteBatch] WriteBatch memory usage: db=txindex, before=0.0MiB, after=0.0MiB\r\n2022-08-07T13:43:47Z [util/thread.cpp:19] [TraceThread] msghand thread exit\r\n2022-08-07T13:43:47Z [dbwrapper.cpp:198] [WriteBatch] WriteBatch memory usage: db=txindex, before=0.0MiB, after=0.0MiB\r\n2022-08-07T13:43:47Z [util/thread.cpp:19] [TraceThread] txindex thread exit\r\n2022-08-07T13:43:47Z [random.cpp:520] [SeedPeriodic] Feeding 1009016 bytes of dynamic environment data into RNG\r\n2022-08-07T13:43:47Z [net.cpp:1846] [DumpAddresses] Flushed 6626 addresses to peers.dat  701ms\r\n2022-08-07T13:43:47Z [net.cpp:567] [CloseSocketDisconnect] disconnecting peer=0\r\n2022-08-07T13:43:47Z [net_processing.cpp:1282] [FinalizeNode] Cleared nodestate for peer=0\r\n2022-08-07T13:43:47Z [net.cpp:567] [CloseSocketDisconnect] disconnecting peer=1\r\n2022-08-07T13:43:47Z [net_processing.cpp:1282] [FinalizeNode] Cleared nodestate for peer=1\r\n2022-08-07T13:43:47Z [net.cpp:1846] [DumpAddresses] Flushed 6626 addresses to peers.dat  15ms\r\n2022-08-07T13:43:47Z [util/thread.cpp:19] [TraceThread] scheduler thread exit\r\n2022-08-07T13:43:47Z [validation.cpp:4644] [DumpMempool] Writing 0 unbroadcast transactions to disk.\r\n2022-08-07T13:43:47Z [validation.cpp:4654] [DumpMempool] Dumped mempool: 0s to copy, 0.036892s to dump\r\n2022-08-07T13:43:47Z [policy/fees.cpp:998] [FlushUnconfirmed] Recorded 0 unconfirmed txs from mempool in 0s\r\n2022-08-07T13:43:47Z [logging/timer.h:57] [Log] FlushStateToDisk: write block and undo data to disk started\r\n2022-08-07T13:43:48Z [logging/timer.h:57] [Log] FlushStateToDisk: write block and undo data to disk completed (38.02ms)\r\n2022-08-07T13:43:48Z [logging/timer.h:57] [Log] FlushStateToDisk: write block index to disk started\r\n2022-08-07T13:43:48Z [dbwrapper.cpp:198] [WriteBatch] WriteBatch memory usage: db=index, before=0.0MiB, after=0.3MiB\r\n2022-08-07T13:43:48Z [logging/timer.h:57] [Log] FlushStateToDisk: write block index to disk completed (36.98ms)\r\n2022-08-07T13:43:48Z [logging/timer.h:57] [Log] FlushStateToDisk: write coins cache to disk (0 coins, 0kB) started\r\n2022-08-07T13:43:48Z [txdb.cpp:161] [BatchWrite] Writing final batch of 0.00 MiB\r\n2022-08-07T13:43:48Z [dbwrapper.cpp:198] [WriteBatch] WriteBatch memory usage: db=chainstate, before=0.0MiB, after=0.0MiB\r\n2022-08-07T13:43:48Z [txdb.cpp:163] [BatchWrite] Committed 0 changed transaction outputs (out of 0) to coin database...\r\n2022-08-07T13:43:48Z [logging/timer.h:57] [Log] FlushStateToDisk: write coins cache to disk (0 coins, 0kB) completed (0.00ms)\r\n2022-08-07T13:43:48Z [validationinterface.cpp:243] [ChainStateFlushed] Enqueuing ChainStateFlushed: block hash=000000000000012a873661c59cd6301ace5a9108786284693eb0e35038713f4d\r\n2022-08-07T13:43:48Z [validationinterface.cpp:243] [operator()] ChainStateFlushed: block hash=000000000000012a873661c59cd6301ace5a9108786284693eb0e35038713f4d\r\n2022-08-07T13:43:48Z [dbwrapper.cpp:198] [WriteBatch] WriteBatch memory usage: db=db, before=0.0MiB, after=0.0MiB\r\n2022-08-07T13:43:48Z [dbwrapper.cpp:198] [WriteBatch] WriteBatch memory usage: db=db, before=0.0MiB, after=0.0MiB\r\n2022-08-07T13:43:48Z [logging/timer.h:57] [Log] FlushStateToDisk: write block and undo data to disk started\r\n2022-08-07T13:43:48Z [logging/timer.h:57] [Log] FlushStateToDisk: write block and undo data to disk completed (31.27ms)\r\n2022-08-07T13:43:48Z [logging/timer.h:57] [Log] FlushStateToDisk: write block index to disk started\r\n2022-08-07T13:43:48Z [dbwrapper.cpp:198] [WriteBatch] WriteBatch memory usage: db=index, before=0.3MiB, after=0.3MiB\r\n2022-08-07T13:43:48Z [logging/timer.h:57] [Log] FlushStateToDisk: write block index to disk completed (15.63ms)\r\n2022-08-07T13:43:48Z [logging/timer.h:57] [Log] FlushStateToDisk: write coins cache to disk (0 coins, 0kB) started\r\n2022-08-07T13:43:48Z [txdb.cpp:161] [BatchWrite] Writing final batch of 0.00 MiB\r\n2022-08-07T13:43:48Z [dbwrapper.cpp:198] [WriteBatch] WriteBatch memory usage: db=chainstate, before=0.0MiB, after=0.0MiB\r\n2022-08-07T13:43:48Z [txdb.cpp:163] [BatchWrite] Committed 0 changed transaction outputs (out of 0) to coin database...\r\n2022-08-07T13:43:48Z [logging/timer.h:57] [Log] FlushStateToDisk: write coins cache to disk (0 coins, 0kB) completed (0.00ms)\r\n2022-08-07T13:43:48Z [validationinterface.cpp:243] [ChainStateFlushed] Enqueuing ChainStateFlushed: block hash=000000000000012a873661c59cd6301ace5a9108786284693eb0e35038713f4d\r\n2022-08-07T13:43:48Z [init.cpp:322] [Shutdown] Shutdown: done\r\n2022-08-07T13:43:48Z [qt/bitcoin.cpp:207] [DebugMessageHandler] GUI: Shutdown finished\r\n2022-08-07T13:43:48Z [qt/bitcoin.cpp:207] [DebugMessageHandler] GUI: ~InitExecutor : Stopping thread\r\n2022-08-07T13:43:48Z [qt/bitcoin.cpp:207] [DebugMessageHandler] GUI: ~InitExecutor : Stopped thread\r\n```\r\n\r\nIf we relaunch the node, it loads all data successfully, connects to a new peer=0 and requests another set of headers, then stalls again exactly as above, and we have to shutdown and wait 15-20 minutes exactly the same way as above.\r\n\r\n**Expected behavior**\r\n\r\nIBD should not stall.\r\n\r\n**System information**\r\n\r\nBitcoin v23 for Windows (from https://bitcoincore.org/en/download/, extracted from the ZIP file, because the current EXE installer does not run on a Windows system enforcing ASLT)\r\n\r\n<!-- What type of machine are you observing the error on (OS/CPU and disk type)? -->\r\nWindows 11 x64 (Intel Core i7), 32 GB RAM\r\n\r\n",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 2,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25800/comments",
   "created_at" : "2022-08-07T13:41:15Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25800/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/25800",
   "id" : 1331019559,
   "labels" : [
      {
         "color" : "FBBAAB",
         "default" : false,
         "description" : null,
         "id" : 64585,
         "name" : "Bug",
         "node_id" : "MDU6TGFiZWw2NDU4NQ==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25800/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "I_kwDOABII585PVb8n",
   "number" : 25800,
   "performed_via_github_app" : null,
   "reactions" : {
      "+1" : 0,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 0,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25800/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "state_reason" : null,
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25800/timeline",
   "title" : "IBD stalls permanently with Bitcoin core v23 after \"ignoring getheaders from peer=0 because node is in initial block download\"",
   "updated_at" : "2022-08-07T13:59:52Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25800",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/1387035?v=4",
      "events_url" : "https://api.github.com/users/verdy-p/events{/privacy}",
      "followers_url" : "https://api.github.com/users/verdy-p/followers",
      "following_url" : "https://api.github.com/users/verdy-p/following{/other_user}",
      "gists_url" : "https://api.github.com/users/verdy-p/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/verdy-p",
      "id" : 1387035,
      "login" : "verdy-p",
      "node_id" : "MDQ6VXNlcjEzODcwMzU=",
      "organizations_url" : "https://api.github.com/users/verdy-p/orgs",
      "received_events_url" : "https://api.github.com/users/verdy-p/received_events",
      "repos_url" : "https://api.github.com/users/verdy-p/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/verdy-p/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/verdy-p/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/verdy-p"
   }
}
