[
   {
      "author_association" : "MEMBER",
      "body" : "> If `/etc/bitcoin` does not exist when the systemd script is run for the first time then the directory gets created...\r\n\r\nProviding `-conf=/etc/bitcoin/bitcoin.conf` option in `ExecStart=/usr/bin/bitcoind` line of `bitcoind.service` file assumes setting up `/etc/bitcoin/bitcoin.conf` _before_ `bitcoind` service get started.\r\n\r\n> The 0710 permissions will/may prevent a non-root user from being able to list the directory...\r\n\r\nIt looks good from the security point of view. Why is this an issue?",
      "created_at" : "2019-05-11T06:59:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15995#issuecomment-491485934",
      "id" : 491485934,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15995",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5MTQ4NTkzNA==",
      "updated_at" : "2019-05-11T06:59:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/491485934",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> It looks good from the security point of view. Why is this an issue?\r\n\r\nIt's now happened to me a couple of times where I've installed the service script and overlooked creating the config file. I then check the log messages realise it's missing and copy it into the `/etc/bitcoin` directory. This is where the problem occurs. Restarting the bitcoin service will continue to fail because the permissions on `/etc/bitcoin` are incorrect.\r\n\r\n> 2019-05-11T07:25:52Z\r\n>\r\n> ************************\r\n> EXCEPTION: N5boost10filesystem16filesystem_errorE\r\n> boost::filesystem::status: Permission denied: \"/etc/bitcoin/bitcoin.conf\"\r\n> bitcoin in AppInit()\r\n\r\nTo fix the problem the ownership of `/etc/bitcoin` has to be changed to the user the service is running as. Unlike the `StateDirectory` directory the ownership of the `ConfigurationDirectoryMode`  does not get updated automatically by systemd, from the [systemd reference]:(https://www.freedesktop.org/software/systemd/man/systemd.exec.html#ConfigurationDirectory=):\r\n\r\n> Except in case of ConfigurationDirectory=, the innermost specified directories will be owned by the user and group specified in User= and Group=. If the specified directories already exist and their owning user or group do not match the configured ones, all files and directories below the specified directories as well as the directories themselves will have their file ownership recursively changed to match what is configured.\r\n\r\nAnother possible fix would be to remove the `ConfigurationDirectoryMode` directory from the script. That way at least the service script won't create it with incorrect permissions and it will be left up to the user to do so as they see fit, most likely with themselves as the owner.\r\n\r\n\r\n\r\n",
      "created_at" : "2019-05-11T07:39:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15995#issuecomment-491488447",
      "id" : 491488447,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15995",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5MTQ4ODQ0Nw==",
      "updated_at" : "2019-05-11T07:39:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/491488447",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/197660?v=4",
         "events_url" : "https://api.github.com/users/sipsorcery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipsorcery/followers",
         "following_url" : "https://api.github.com/users/sipsorcery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipsorcery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipsorcery",
         "id" : 197660,
         "login" : "sipsorcery",
         "node_id" : "MDQ6VXNlcjE5NzY2MA==",
         "organizations_url" : "https://api.github.com/users/sipsorcery/orgs",
         "received_events_url" : "https://api.github.com/users/sipsorcery/received_events",
         "repos_url" : "https://api.github.com/users/sipsorcery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipsorcery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipsorcery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipsorcery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@sipsorcery \r\n> It's now happened to me a couple of times where I've installed the service script and overlooked creating the config file.\r\n\r\nIMO, there is nothing to fix in the software ;)",
      "created_at" : "2019-05-11T07:56:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15995#issuecomment-491489563",
      "id" : 491489563,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15995",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5MTQ4OTU2Mw==",
      "updated_at" : "2019-05-11T07:56:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/491489563",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> IMO, there is nothing to fix in the software ;)\r\n\r\nPoint taken and not disputed ;). Wish I could get my memory banks serviced. I keep cleaning them with alcohol but it just seems to make it worse :(.\r\n\r\nFor any other interested parties the choices I see are:\r\n\r\n1. Leave as is and let users manually work out they need to set the ownership correctly on `/etc/bitcoin`. Once the ownership is set appropriately having systemd apply permissions on 0710 to the directory seems a good choice,\r\n\r\n2. As per this PR set the permissions on `/etc/bitcoin` to 0755 and remove the need for users to set manually set the ownership of `/etc/bitcoin/`.\r\n\r\nAs a point of reference on my ubuntu system most configuration directories including `/etc/ssh`, `/etc/systemd` and `/etc/tor` have 0755 permissions and are owned by root.\r\n\r\n\r\n\r\n",
      "created_at" : "2019-05-11T08:31:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15995#issuecomment-491491651",
      "id" : 491491651,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15995",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5MTQ5MTY1MQ==",
      "updated_at" : "2019-05-11T08:31:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/491491651",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/197660?v=4",
         "events_url" : "https://api.github.com/users/sipsorcery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipsorcery/followers",
         "following_url" : "https://api.github.com/users/sipsorcery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipsorcery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipsorcery",
         "id" : 197660,
         "login" : "sipsorcery",
         "node_id" : "MDQ6VXNlcjE5NzY2MA==",
         "organizations_url" : "https://api.github.com/users/sipsorcery/orgs",
         "received_events_url" : "https://api.github.com/users/sipsorcery/received_events",
         "repos_url" : "https://api.github.com/users/sipsorcery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipsorcery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipsorcery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipsorcery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'm not convinced that this is a good idea. `bitcoin.conf` can contain secrets such as RPC account user/passwords, so restricting its permissions to `root` and whatever the `uid`/`gid` is that the service runs under makes sense.\r\n(at least by default! of course admins can decide to weaken these permissions in specific cases)",
      "created_at" : "2019-07-04T12:45:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15995#issuecomment-508469900",
      "id" : 508469900,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15995",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwODQ2OTkwMA==",
      "updated_at" : "2019-07-04T12:45:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/508469900",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@laanwj the PR doesn't affect the permissions on the bitcoin.conf file. It affects the permissions that systemd will set on the `/etc/bitcoin` directory IF it does not exist. If the `bitcoin.conf` file has restricted read permissions they are not affected.",
      "created_at" : "2019-07-04T12:54:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15995#issuecomment-508472630",
      "id" : 508472630,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15995",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwODQ3MjYzMA==",
      "updated_at" : "2019-07-04T12:54:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/508472630",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/197660?v=4",
         "events_url" : "https://api.github.com/users/sipsorcery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipsorcery/followers",
         "following_url" : "https://api.github.com/users/sipsorcery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipsorcery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipsorcery",
         "id" : 197660,
         "login" : "sipsorcery",
         "node_id" : "MDQ6VXNlcjE5NzY2MA==",
         "organizations_url" : "https://api.github.com/users/sipsorcery/orgs",
         "received_events_url" : "https://api.github.com/users/sipsorcery/received_events",
         "repos_url" : "https://api.github.com/users/sipsorcery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipsorcery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipsorcery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipsorcery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept NACK.\r\n\r\nRationale:\r\n1. If the `/etc/bitcoin` directory was created by `systemd` with `root` ownership and `0755` permissions, the just created `bitcoin.conf` file (e.g., `touch /etc/bitcoin/bitcoin.conf`) will acquire the same permissions. It means `bitcoin.conf` will be readable for all users.\r\n\r\n2. This PR looks like a bad trade-off between first-time setup convenience for long-term security.\r\n\r\n3. [The best practice](https://github.com/bitcoin/bitcoin/blob/master/doc/init.md) is:\r\n> The configuration file, PID directory (if applicable) and data directory should all be owned by the bitcoin user and group. It is advised for security reasons to make the configuration file and data directory only readable by the bitcoin user and group. Access to bitcoin-cli and other bitcoind rpc clients can then be controlled by group membership.\r\n\r\n@sipsorcery \r\n> the PR doesn't affect the permissions on the bitcoin.conf file.\r\n\r\nYes, it does. It affects the permissions on the `bitcoin.conf` file indirectly as described above.",
      "created_at" : "2019-07-05T18:26:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15995#issuecomment-508833930",
      "id" : 508833930,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15995",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwODgzMzkzMA==",
      "updated_at" : "2019-07-05T18:26:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/508833930",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Ok I'll accept that the proposed solution is not ideal and close this PR. \r\n\r\nIn my defense I will point out that my goal was to avoid future users of the sample systemd `bitcoind.service` script receiving the error below.  I reasoned that if I, as a someone with a bit of programmer experience under my belt, was having difficulties then so would others that tried to use the script. That could certainly be a wrong assumption.\r\n\r\nThis is the error that occurs if I take the same steps I've use to set up dozens of systemd services on Ubuntu.\r\n\r\n````\r\n~$ tail /var/lib/bitcoind/debug.log -f\r\n2019-07-05T18:43:54Z Using data directory /var/lib/bitcoind\r\n2019-07-05T18:43:54Z\r\n\r\n************************\r\nEXCEPTION: N5boost10filesystem16filesystem_errorE\r\nboost::filesystem::status: Permission denied: \"/etc/bitcoin/bitcoin.conf\"\r\nbitcoin in AppInit()\r\n\r\n2019-07-05T18:43:54Z Shutdown: In progress...\r\n2019-07-05T18:43:54Z Shutdown: done\r\n````\r\n\r\n@hebasto You are right*. \r\n*Unless the `bitcoin.conf` file already exists with the correct ownership. From the systemd [manual](https://www.freedesktop.org/software/systemd/man/systemd.exec.html#ConfigurationDirectory=):\r\n\r\n> Except in case of ConfigurationDirectory=, the innermost specified directories will be owned by the user and group specified in User= and Group=. If the specified directories already exist and their owning user or group do not match the configured ones, all files and directories below the specified directories as well as the directories themselves will have their file ownership recursively changed to match what is configured. As an optimization, if the specified directories are already owned by the right user and group, files and directories below of them are left as-is, even if they do not match what is requested. The innermost specified directories will have their access mode adjusted to the what is specified in RuntimeDirectoryMode=, StateDirectoryMode=, CacheDirectoryMode=, LogsDirectoryMode= and ConfigurationDirectoryMode=.\r\n\r\nThere's too much beer to drink to worry about `710 || 755` :).\r\n",
      "created_at" : "2019-07-05T19:11:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15995#issuecomment-508842263",
      "id" : 508842263,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15995",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwODg0MjI2Mw==",
      "updated_at" : "2019-07-05T19:11:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/508842263",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/197660?v=4",
         "events_url" : "https://api.github.com/users/sipsorcery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipsorcery/followers",
         "following_url" : "https://api.github.com/users/sipsorcery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipsorcery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipsorcery",
         "id" : 197660,
         "login" : "sipsorcery",
         "node_id" : "MDQ6VXNlcjE5NzY2MA==",
         "organizations_url" : "https://api.github.com/users/sipsorcery/orgs",
         "received_events_url" : "https://api.github.com/users/sipsorcery/received_events",
         "repos_url" : "https://api.github.com/users/sipsorcery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipsorcery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipsorcery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipsorcery"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Just stumbled across this same issue and contributed my own fix with `711` (rather than `755`). On the one hand I see the problem with having the config file world-readable due to RPC secrets; on the other hand, if one wants to run with the default settings and doesn't care about putting a `bitcoin.conf` in `/etc/bitcoin` the current systemd service file simply creates the the directory with the wrong permissions. I think @ryanofsky's `chgrp` suggestion is the best of both worlds, will experiment with that and update my PR if it works.",
      "created_at" : "2019-08-06T12:01:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15995#issuecomment-518639415",
      "id" : 518639415,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15995",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxODYzOTQxNQ==",
      "updated_at" : "2019-08-06T12:01:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/518639415",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/37372069?v=4",
         "events_url" : "https://api.github.com/users/setpill/events{/privacy}",
         "followers_url" : "https://api.github.com/users/setpill/followers",
         "following_url" : "https://api.github.com/users/setpill/following{/other_user}",
         "gists_url" : "https://api.github.com/users/setpill/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/setpill",
         "id" : 37372069,
         "login" : "setpill",
         "node_id" : "MDQ6VXNlcjM3MzcyMDY5",
         "organizations_url" : "https://api.github.com/users/setpill/orgs",
         "received_events_url" : "https://api.github.com/users/setpill/received_events",
         "repos_url" : "https://api.github.com/users/setpill/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/setpill/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/setpill/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/setpill"
      }
   }
]
