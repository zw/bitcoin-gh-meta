{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "This is an experimental refactor I wrote to help myself understand script validation logic better. I'm not strongly advocating for it as it touches consensus and I haven't thoroughly verified it is identical, but I felt it was much clearer than the existing logic, so was worth sharing.\r\n\r\nEssentially, the current VerifyScript logic processes all scripts down the same control flow path. This makes the code a bit hard to reason about as the logic for enabling features (e.g., segwit, p2sh, p2sh segwit) is all interleaved cleverly. Furthermore, the use of the stack between execution to communicate conditions for checks (e.g., clearstack) is confusing. In order for me to understand what it was doing and be convinced it is correct, I felt I should re-write it to be less clever in several small steps. This PR is the result of de-clevering this code.\r\n\r\nIn this PR I:\r\n1) duplicate the entire verification logic for the main Script templates we know about.\r\n2) Simplify the logic substantially for several types of script.\r\n3) Get rid of swapping the stack copy and just running p2sh on a copy of the stack\r\n4) Because we know the exact side effects of a SegWit program, we are able to avoid executing the segwit script at all and directly run the segwit program. (We could do the same trick for P2SH, but it is a bigger refactor).\r\n5) Moved assertions about flag combinations to be unconditional\r\n6) Made a few checks into asserts where we know (based on script type) it will never fail\r\n\r\nThe code could be further simplified with a bit more duplication (currently the classic script verification code is used in multiple modes), but at current I think it is a nice balance between repetition and clarity.\r\n\r\nIn the future if new flags are introduced, they should hopefully only be affecting witness programs and not scripts. If this logic needed to be amended, it should be (IMO) easier to patch this version of the function than the current one.\r\n\r\nI haven't benchmarked, but skipping a few extra EvaluateScripts for segwit probably doesn't hurt.\r\n\r\nThe Diff for this PR kinda sucks, I recommend just looking at the files side-by-side.",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 9,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15969/comments",
   "created_at" : "2019-05-07T01:06:11Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15969/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/15969",
   "id" : 440979032,
   "labels" : [
      {
         "color" : "ebd775",
         "default" : false,
         "id" : 64584,
         "name" : "Brainstorming",
         "node_id" : "MDU6TGFiZWw2NDU4NA==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Brainstorming"
      },
      {
         "color" : "6060aa",
         "default" : false,
         "id" : 118379652,
         "name" : "Validation",
         "node_id" : "MDU6TGFiZWwxMTgzNzk2NTI=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Validation"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15969/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDExOlB1bGxSZXF1ZXN0Mjc2NDA2MTE2",
   "number" : 15969,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/15969.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15969",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/15969.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15969"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "title" : "Refactor: explicit VerifyScript control flow based on pattern matching",
   "updated_at" : "2019-05-14T19:07:17Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15969",
   "user" : {
      "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
      "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
      "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
      "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
      "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/JeremyRubin",
      "id" : 886523,
      "login" : "JeremyRubin",
      "node_id" : "MDQ6VXNlcjg4NjUyMw==",
      "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
      "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
      "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/JeremyRubin"
   }
}
