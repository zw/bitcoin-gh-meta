{
   "assignee" : null,
   "body" : "From the forum: https://bitcointalk.org/index.php?topic=34642.0\r\n\r\nThis is in the latest version in Git.  This is not in the released client.\r\n\r\nCreating a new key can freeze the client.  It appears to be much more frequent when there are blocks and transactions to download.\r\n\r\nI've been digging in the code to try and find the cause, and I think this is the reason:\r\n\r\nCAddressBookDialog::OnButtonNew grabs the cs_vMasterKey, then calls pwalletMain->GetOrReuseKeyFromPool()\r\nGetOrReuseKeyFromPool() calls ReserveKeyFromKeyPool() which attempts to grab cs_main\r\n\r\nMeanwhile..\r\n\r\nProcessMessages grabs cs_main and then calls ProcessMessage\r\nProcessMessage() calls SyncWithWallets, either directly when receiving \"tx\" or indirectly when receiving a block (via ProcessBlock -> AcceptBlock -> AddToBlockIndex -> SetBestChain -> ConnectBlock -> SyncWithWallets)\r\nSyncWithWallets calls AddToWalletIfInvolvingMe\r\nAddToWalletIfInvolvingMe calls CWallet::IsMine, which calls the global ::IsMine\r\nIsMine(const CKeyStore &keystore, const CScript& scriptPubKey) then calls keystore.GetPubKey\r\nCCryptoKeyStore::GetPubKey then grabs cs_vMasterKey\r\n\r\nDeadlock.\r\n\r\nMost of the critical sections protect something small well-defined, though I'm not quite sure what cs_main is supposed to be protecting.\r\n\r\nI would generate a pull request, except that \r\n1. I have an ugly hack but not a good fix.  I'm not sure what the final strategy is going to be on wallet encryption, and whether the public keys are going to be encrypted too.\r\n2. I am new to git and I am not yet skilled at rebasing commits to include only the changes I want.",
   "closed_at" : "2011-09-01T18:59:35Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
      "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
      "followers_url" : "https://api.github.com/users/gavinandresen/followers",
      "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
      "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/gavinandresen",
      "id" : 331997,
      "login" : "gavinandresen",
      "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
      "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
      "repos_url" : "https://api.github.com/users/gavinandresen/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/gavinandresen"
   },
   "comments" : 7,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/453/comments",
   "created_at" : "2011-08-05T16:31:22Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/453/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/453",
   "id" : 1352221,
   "labels" : [
      {
         "color" : "FBBAAB",
         "name" : "Bug",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/453/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "number" : 453,
   "state" : "closed",
   "title" : "Deadlock in key generation due to CCryptoKeyStore",
   "updated_at" : "2011-09-01T18:59:35Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/453",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
      "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
      "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/TheBlueMatt",
      "id" : 649246,
      "login" : "TheBlueMatt",
      "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
      "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
      "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/TheBlueMatt"
   }
}
