{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "edited: This PR has been squashed with a few revisions from the initial PR. The unsquashed version is still available here https://github.com/bitcoin/bitcoin/compare/master...JeremyRubin:cuckoocache-pull-request-not-squashed. The PR message has also been updated to reflect the current squashed version more closely.\n# Summary\n\nThis PR replaces the boost::unordered_set in sigcache with CuckooCache::cache.\n# Benefits\n- Better memory utilization (no pointers/linked lists/stored hashes)\n- Lock Free concurrent reads and erases\n- Lazy Deletion of entries (potentially beneficial in case of re-orgs)\n- Low cache thrashing -- a standard lookup and erase should only require ~9 cache lines (Hash 0..Hash 7, and erase flag)\n- Allocation free design\n- Insert guaranteed to terminate\n- Generations smartly delete older entries before newer ones\n# Design\n\nThe CuckooCache uses a design similar to a [Cuckoo Hash Table](https://en.wikipedia.org/wiki/Cuckoo_hashing). Each key inserted has a hash function 0 through hash function 7 (h0..h7).\n- Lookup(k) is a matter of examining location h0(k)..h7(k).\n- Insert(k) first sees if h0(k)..h7(k) is empty, and insets to one if so. If not, insert swaps k with the key at one more than the last hash location (so it goes in a cycle through h0..h7) and attempts to insert the swapped out key at it's other location, repeating (up to a limit) if necessary. At that limit, the last entry is dropped. Insert also checks a heuristic (described below) to age a generation before trying to insert.\n- Delete(k) first does a Lookup(k), then marks the corresponding bit in an std::atomic<uint8_t> as set as a relaxed atomic operation.\n\nMore information about the synchronization specification is in the code documentation.\n## Generation Heuristic\n\nA bit vector is used to track if the element belongs to the current or prior generation. Once the number of the current generation's non-deleted elements exceeds ~45%, the generation is retired. The previously retired generation is marked deleted. Because the cache deletes lazily, these entries are still present but are more likely to be overwritten than elements in the currently retired generation. Generations are scanned to see if they should be retired using a heuristic of how many inserts would need to occur since the last scan to exceed the generation size.\n\nThere is a slight (1-bit per entry) memory overhead to this approach. This does not negatively impact this cache because the trade off is worth it for intelligently deleting older entries. Only one bit is used for simplicity, as we get three represented states (deleted, old, current). Using more generations (lets say, 1 more bit) would allow for more granular freeing of only the oldest quarter and not half per scan. This has advantages, but also an additional memory cost and two generations was sufficient for this use case.\n# Simulation\n\nThese simulation results are slightly outdated, @morcos will chime in below with some updated figures. It should be better/the same as below.\n~~This can overall be seen as a 40% improvement on validation times over master on a 16 core machine simulated over a month. The simulation methodology sends relayed transactions and blocks to the node in the order they were received historically. On 4 and 1 core simulations, the improvement is not significant (but no worse). Our tests didn't really hit hard saturation on the cache, which suggests that the megabytes allocated to the cache could be reduced.~~\n# Testing\n\nThe PR includes a test suite which checks a few key properties:\n1. Check that values not inserted are never readable\n2. Check that a reasonable hit rate is achieved\n3. Check that erased elements are inserted on reasonably well rather than replacing fresh contents\n4. Test that (3) holds when erases are in parallel.\n# Future Work\n\nThere are future optimizations which may be able to bring some of the advantages seen with 16 cores to 4 and 1 cores, but this PR is focused on a minimal complexity patch with a demonstrable improvement over main as a base for future work in this direction.\n\nThere are also a few cleanup related items (such as cache initialization) which are not done in this patch to make it a minimal code change. These can be fixed in a later PR if this is accepted.\n# Acknowledgements\n\nThanks to @morcos, @sdaftuar, and @TheBlueMatt for their assistance and review on this patch.\n",
   "closed_at" : "2016-12-15T02:14:18Z",
   "closed_by" : {
      "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
      "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
      "followers_url" : "https://api.github.com/users/sipa/followers",
      "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/sipa",
      "id" : 548488,
      "login" : "sipa",
      "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
      "organizations_url" : "https://api.github.com/users/sipa/orgs",
      "received_events_url" : "https://api.github.com/users/sipa/received_events",
      "repos_url" : "https://api.github.com/users/sipa/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/sipa"
   },
   "comments" : 22,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8895/comments",
   "created_at" : "2016-10-05T21:51:18Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8895/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/8895",
   "id" : 181275275,
   "labels" : [
      {
         "color" : "981023",
         "default" : false,
         "id" : 326918230,
         "name" : "Resource usage",
         "node_id" : "MDU6TGFiZWwzMjY5MTgyMzA=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Resource%20usage"
      },
      {
         "color" : "6060aa",
         "default" : false,
         "id" : 118379652,
         "name" : "Validation",
         "node_id" : "MDU6TGFiZWwxMTgzNzk2NTI=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Validation"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8895/labels{/name}",
   "locked" : false,
   "milestone" : {
      "closed_at" : "2017-03-08T16:39:44Z",
      "closed_issues" : 156,
      "created_at" : "2016-06-13T14:18:51Z",
      "creator" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      },
      "description" : "",
      "due_on" : null,
      "html_url" : "https://github.com/bitcoin/bitcoin/milestone/21",
      "id" : 1823680,
      "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/milestones/21/labels",
      "node_id" : "MDk6TWlsZXN0b25lMTgyMzY4MA==",
      "number" : 21,
      "open_issues" : 0,
      "state" : "closed",
      "title" : "0.14.0",
      "updated_at" : "2017-03-08T16:39:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/milestones/21"
   },
   "node_id" : "MDExOlB1bGxSZXF1ZXN0ODgxNjQxNzQ=",
   "number" : 8895,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/8895.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8895",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/8895.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8895"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "Better SigCache Implementation",
   "updated_at" : "2016-12-15T02:14:18Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8895",
   "user" : {
      "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
      "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
      "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
      "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
      "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/JeremyRubin",
      "id" : 886523,
      "login" : "JeremyRubin",
      "node_id" : "MDQ6VXNlcjg4NjUyMw==",
      "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
      "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
      "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/JeremyRubin"
   }
}
