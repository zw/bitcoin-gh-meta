{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "NONE",
   "body" : "<!-- This issue tracker is only for technical issues related to Bitcoin Core.\r\n\r\nGeneral bitcoin questions and/or support requests are best directed to the Bitcoin StackExchange at https://bitcoin.stackexchange.com.\r\n\r\nFor reporting security issues, please read instructions at https://bitcoincore.org/en/contact/.\r\n\r\nIf the node is \"stuck\" during sync or giving \"block checksum mismatch\" errors, please ensure your hardware is stable by running memtest and observe CPU temperature with a load-test tool such as linpack before creating an issue! -->\r\n\r\n<!-- Describe the issue -->\r\nbitcoin-0.16.0 (pre-compiled, downloaded from bitcoin.org)\r\nDebian Stretch\r\n<!--- What behavior did you expect? -->\r\nFollowing https://github.com/bitcoin/bitcoin/blob/master/doc/tor.md I face a couple of issues:\r\n\r\nFirst, here's my current understanding: Tor offers **two ways** of being controlled on Linux.\r\n1. `TCP Control Port` (by default 127.0.0.1:9051 but disabled)\r\n2. `Control Socket` which is Unix Domain Socket (by default `/run/tor/control` on Debian)\r\n\r\nBy reading the Bitcoin Core Tor documentation, it sounds like the 2nd (newer) way is supported:\r\n> Starting with Tor version 0.2.7.1 it is possible, through Tor's control socket API, to create and destroy 'ephemeral' hidden services programmatically. Bitcoin Core has been updated to make use of this.\r\n\r\nThat's what I'm trying to achieve. `Tor Control Port (TCP)` is disabled by default on Debian anyway, but `Tor Control Socket` is enabled. Here are the respective sections from the config files:\r\n\r\n**/etc/bitcoin/bitcoin.conf**\r\n```\r\n# [debug]\r\ndebug=tor\r\n\r\n# [network]\r\n# Accept incoming connections from peers.   \r\nlisten=1\r\n# connect to peers via Tor.\r\nonlynet=onion\r\n# Connect through <ip:port> SOCKS5 proxy.   \r\nproxy=127.0.0.1:9050\r\n```\r\n**/usr/share/tor/tor-service-defaults-torrc**\r\n```\r\nUser debian-tor\r\n\r\nControlSocket /var/run/tor/control GroupWritable RelaxDirModeCheck\r\nControlSocketsGroupWritable 1\r\nSocksPort unix:/var/run/tor/socks WorldWritable\r\nSocksPort 9050\r\n\r\nCookieAuthentication 1\r\nCookieAuthFileGroupReadable 1\r\nCookieAuthFile /var/run/tor/control.authcookie\r\n```\r\n\r\nHowever, I get the following error in `~/.bitcoin/debug.log`:\r\n```\r\ntor: Error connecting to Tor control socket\r\ntor: Not connected to Tor control port 127.0.0.1:9051, trying to reconnect\r\n```\r\nThe second error is expected, because Tor control port is disabled. But the first error is unexpected.\r\nIt's not a file permision issue, because I added the user who runs `bitcoind` to the group `debian-tor`:\r\n```\r\n$ ls -la /run/tor/\r\ntotal 8\r\ndrwxr-sr-x  2 debian-tor debian-tor 100 ---  - --:-- .\r\ndrwxr-xr-x 20 root       root       760 ---  - --:-- ..\r\nsrw-rw----  1 debian-tor debian-tor   0 ---  - --:-- control\r\n-rw-rw----  1 debian-tor debian-tor  32 ---  - --:-- control.authcookie\r\n-rw-r--r--  1 debian-tor debian-tor   5 ---  - --:-- tor.pid\r\n\r\n$ cat /etc/group | grep bitcoind\r\ndebian-tor:x:114:bitcoind\r\n\r\nps aux | grep bitcoind\r\nbitcoind  ----  ---  --- ------ ----- ?        Rsl  --:--   --:-- /usr/local/bin/bitcoind -daemon -conf=/etc/bitcoin/bitcoin.conf -pid=/run/bitcoind/bitcoind.pid -rpccookiefile=/run/bitcoind/authcookie\r\n```\r\n\r\nI also tried to explictly tell bitcoind the path to the control socket by adding `torcontrol=/run/tor/control` as a config option:\r\n```\r\n# [debug]\r\ndebug=tor\r\n\r\n# [network]\r\n# Accept incoming connections from peers.   \r\nlisten=1\r\n# connect to peers via Tor.\r\nonlynet=onion\r\ntorcontrol=/run/tor/control\r\n```\r\n\r\nHowever, this results the following error:\r\n```\r\ntor: Error parsing socket address /run/tor/control\r\ntor: Initiating connection to Tor control port /run/tor/control failed\r\n```\r\nSo obviously, the `torcontrol` option only allows to specify the `TCP Tor control port`. How does `bitcoind` know the path to the `Tor control socket`? Is there an undocumented config option to set it? Is it hard coded? Or is the documentation just ambiguous and it isn't supported yet?\r\n\r\nFinal issue with the documentation is:\r\n> For cookie authentication the user running bitcoind must have write access to the CookieAuthFile specified in Tor configuration.\r\n\r\nWhy `write access`??? `Read access` should be sufficient! It's just the cookie file.\r\n\r\n<!--- What was the actual behavior (provide screenshots if the issue is GUI-related)? -->\r\n\r\n<!--- How reliably can you reproduce the issue, what are the steps to do so? -->\r\n\r\n<!-- What version of Bitcoin Core are you using, where did you get it (website, self-compiled, etc)? -->\r\n\r\n<!-- What type of machine are you observing the error on (OS/CPU and disk type)? -->\r\n\r\n<!-- Any extra information that might be useful in the debugging process. -->\r\n<!--- This is normally the contents of a `debug.log` or `config.log` file. Raw text or a link to a pastebin type site are preferred. -->\r\n",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 0,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13397/comments",
   "created_at" : "2018-06-05T14:10:48Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13397/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/13397",
   "id" : 329474789,
   "labels" : [],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13397/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDU6SXNzdWUzMjk0NzQ3ODk=",
   "number" : 13397,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "title" : "tor: Error connecting to Tor control socket",
   "updated_at" : "2018-06-05T14:10:48Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13397",
   "user" : {
      "avatar_url" : "https://avatars0.githubusercontent.com/u/30443750?v=4",
      "events_url" : "https://api.github.com/users/pruflyos/events{/privacy}",
      "followers_url" : "https://api.github.com/users/pruflyos/followers",
      "following_url" : "https://api.github.com/users/pruflyos/following{/other_user}",
      "gists_url" : "https://api.github.com/users/pruflyos/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/pruflyos",
      "id" : 30443750,
      "login" : "pruflyos",
      "node_id" : "MDQ6VXNlcjMwNDQzNzUw",
      "organizations_url" : "https://api.github.com/users/pruflyos/orgs",
      "received_events_url" : "https://api.github.com/users/pruflyos/received_events",
      "repos_url" : "https://api.github.com/users/pruflyos/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/pruflyos/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/pruflyos/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/pruflyos"
   }
}
