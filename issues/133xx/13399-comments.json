[
   {
      "author_association" : "NONE",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->Note to reviewers: This pull request conflicts with the following ones:\n\n* #13098 (Skip tx-rehashing on historic blocks by MarcoFalke)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2018-06-05T17:23:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13399#issuecomment-394792508",
      "id" : 394792508,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13399",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDM5NDc5MjUwOA==",
      "updated_at" : "2018-07-13T19:38:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/394792508",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Your OP is empty - can you provide rationale what this is to be used for?",
      "created_at" : "2018-06-05T17:27:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13399#issuecomment-394793982",
      "id" : 394793982,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13399",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDM5NDc5Mzk4Mg==",
      "updated_at" : "2018-06-05T17:27:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/394793982",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I asked for this as a part of my BetterHash mining protocol work, however I've also wanted this at several points in order to be able to implement chain-sync logic outside of bitcoind over RPC. You'd need this or something like it to do headers-first sync in such a system.",
      "created_at" : "2018-06-05T17:31:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13399#issuecomment-394794918",
      "id" : 394794918,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13399",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDM5NDc5NDkxOA==",
      "updated_at" : "2018-06-05T17:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/394794918",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13399#discussion_r193158690"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13399"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/193158690"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Commit \"rpc: Expose ProcessNewBlockHeaders\"\r\n\r\nThis should be in commit \"doc: Rewrite some validation doc to be machine-readable:\".",
      "commit_id" : "fa7d7dd34cbd180ec9587c640078dfb7bf2ead04",
      "created_at" : "2018-06-05T17:34:35Z",
      "diff_hunk" : "@@ -234,7 +234,6 @@ static const uint64_t MIN_DISK_SPACE_FOR_BLOCK_FILES = 550 * 1024 * 1024;\n  * (and possibly also) BlockChecked will have been called.\n  *\n  *\n- *",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13399#discussion_r193158690",
      "id" : 193158690,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE5MzE1ODY5MA==",
      "original_commit_id" : "1c4268a500061f22499656deecaef12ff37719ef",
      "original_position" : 4,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 126074219,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13399",
      "updated_at" : "2018-07-11T15:57:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/193158690",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13399#discussion_r193158756"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13399"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/193158756"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Commit \"rpc: Expose ProcessNewBlockHeaders\"\r\n\r\nThis should be in commit \"doc: Rewrite some validation doc to be machine-readable:\".",
      "commit_id" : "fa7d7dd34cbd180ec9587c640078dfb7bf2ead04",
      "created_at" : "2018-06-05T17:34:50Z",
      "diff_hunk" : "@@ -245,8 +244,6 @@ bool ProcessNewBlock(const CChainParams& chainparams, const std::shared_ptr<cons\n /**\n  * Process incoming block headers.\n  *\n- *",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13399#discussion_r193158756",
      "id" : 193158756,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE5MzE1ODc1Ng==",
      "original_commit_id" : "1c4268a500061f22499656deecaef12ff37719ef",
      "original_position" : 12,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 126074219,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13399",
      "updated_at" : "2018-07-11T15:57:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/193158756",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13399#discussion_r193159384"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13399"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/193159384"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could be removed?",
      "commit_id" : "fa7d7dd34cbd180ec9587c640078dfb7bf2ead04",
      "created_at" : "2018-06-05T17:36:59Z",
      "diff_hunk" : "@@ -232,28 +232,25 @@ static const uint64_t MIN_DISK_SPACE_FOR_BLOCK_FILES = 550 * 1024 * 1024;\n  *\n  * Note that we guarantee that either the proof-of-work is valid on pblock, or\n  * (and possibly also) BlockChecked will have been called.\n- * \n- * Call without cs_main held.\n+ *",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13399#discussion_r193159384",
      "id" : 193159384,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE5MzE1OTM4NA==",
      "original_commit_id" : "7f619acaf04a88837029b709b740d107c0149241",
      "original_position" : 6,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 126074219,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13399",
      "updated_at" : "2018-07-11T15:57:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/193159384",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13399#discussion_r194330173"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13399"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/194330173"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit, could include the previous hash.",
      "commit_id" : "fa7d7dd34cbd180ec9587c640078dfb7bf2ead04",
      "created_at" : "2018-06-11T08:45:32Z",
      "diff_hunk" : "@@ -131,5 +141,61 @@ def run_test(self):\n         bad_block.hashPrevBlock = 123\n         assert_template(node, bad_block, 'inconclusive-not-best-prevblk')\n \n+        self.log.info('submitheader tests')\n+        assert_raises_rpc_error(-22, 'Block header decode failed', lambda: node.submitheader(hexdata='xx' * 80))\n+        assert_raises_rpc_error(-22, 'Block header decode failed', lambda: node.submitheader(hexdata='ff' * 78))\n+        assert_raises_rpc_error(-25, 'Must submit previous header', lambda: node.submitheader(hexdata='ff' * 80))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13399#discussion_r194330173",
      "id" : 194330173,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE5NDMzMDE3Mw==",
      "original_commit_id" : "2595028d97fc08ea0d27c3133c44d63f3e8bbc0f",
      "original_position" : 39,
      "path" : "test/functional/mining_basic.py",
      "position" : 36,
      "pull_request_review_id" : 127478873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13399",
      "updated_at" : "2018-07-11T15:57:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/194330173",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13399#discussion_r194331921"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13399"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/194331921"
         }
      },
      "author_association" : "MEMBER",
      "body" : "These verifications are done in `ProcessNewBlockHeaders` -> `CChainState::AcceptBlockHeader`. Could use `ProcessNewBlockHeaders` return value.",
      "commit_id" : "fa7d7dd34cbd180ec9587c640078dfb7bf2ead04",
      "created_at" : "2018-06-11T08:51:42Z",
      "diff_hunk" : "@@ -751,20 +748,51 @@ static UniValue submitblock(const JSONRPCRequest& request)\n \n     submitblock_StateCatcher sc(block.GetHash());\n     RegisterValidationInterface(&sc);\n-    bool fAccepted = ProcessNewBlock(Params(), blockptr, true, nullptr);\n+    ProcessNewBlock(Params(), blockptr, true, nullptr);\n     UnregisterValidationInterface(&sc);\n-    if (fBlockPresent) {\n-        if (fAccepted && !sc.found) {\n-            return \"duplicate-inconclusive\";\n-        }\n-        return \"duplicate\";\n-    }\n     if (!sc.found) {\n         return \"inconclusive\";\n     }\n     return BIP22ValidationResult(sc.state);\n }\n \n+static UniValue submitheader(const JSONRPCRequest& request)\n+{\n+    if (request.fHelp || request.params.size() != 1) {\n+        throw std::runtime_error(\n+            \"submitheader \\\"hexdata\\\"\\n\"\n+            \"\\nDecode the given hexdata as a header and submit it as a candidate chain tip if valid.\"\n+            \"\\nThrows when the header is invalid.\\n\"\n+            \"\\nArguments\\n\"\n+            \"1. \\\"hexdata\\\"        (string, required) the hex-encoded block header data\\n\"\n+            \"\\nResult:\\n\"\n+            \"None\"\n+            \"\\nExamples:\\n\" +\n+            HelpExampleCli(\"submitheader\", \"\\\"aabbcc\\\"\") +\n+            HelpExampleRpc(\"submitheader\", \"\\\"aabbcc\\\"\"));\n+    }\n+\n+    CBlockHeader h;\n+    if (!DecodeHexBlockHeader(h, request.params[0].get_str())) {\n+        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"Block header decode failed\");\n+    }\n+    {\n+        LOCK(cs_main);\n+        if (LookupBlockIndex(h.GetHash())) return NullUniValue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13399#discussion_r194331921",
      "id" : 194331921,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE5NDMzMTkyMQ==",
      "original_commit_id" : "2595028d97fc08ea0d27c3133c44d63f3e8bbc0f",
      "original_position" : 74,
      "path" : "src/rpc/mining.cpp",
      "position" : null,
      "pull_request_review_id" : 127478873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13399",
      "updated_at" : "2018-07-11T15:57:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/194331921",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13399#discussion_r194332068"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13399"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/194332068"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Since the lock is released above, there is a point where the block can be processed in between.",
      "commit_id" : "fa7d7dd34cbd180ec9587c640078dfb7bf2ead04",
      "created_at" : "2018-06-11T08:52:06Z",
      "diff_hunk" : "@@ -751,20 +748,51 @@ static UniValue submitblock(const JSONRPCRequest& request)\n \n     submitblock_StateCatcher sc(block.GetHash());\n     RegisterValidationInterface(&sc);\n-    bool fAccepted = ProcessNewBlock(Params(), blockptr, true, nullptr);\n+    ProcessNewBlock(Params(), blockptr, true, nullptr);\n     UnregisterValidationInterface(&sc);\n-    if (fBlockPresent) {\n-        if (fAccepted && !sc.found) {\n-            return \"duplicate-inconclusive\";\n-        }\n-        return \"duplicate\";\n-    }\n     if (!sc.found) {\n         return \"inconclusive\";\n     }\n     return BIP22ValidationResult(sc.state);\n }\n \n+static UniValue submitheader(const JSONRPCRequest& request)\n+{\n+    if (request.fHelp || request.params.size() != 1) {\n+        throw std::runtime_error(\n+            \"submitheader \\\"hexdata\\\"\\n\"\n+            \"\\nDecode the given hexdata as a header and submit it as a candidate chain tip if valid.\"\n+            \"\\nThrows when the header is invalid.\\n\"\n+            \"\\nArguments\\n\"\n+            \"1. \\\"hexdata\\\"        (string, required) the hex-encoded block header data\\n\"\n+            \"\\nResult:\\n\"\n+            \"None\"\n+            \"\\nExamples:\\n\" +\n+            HelpExampleCli(\"submitheader\", \"\\\"aabbcc\\\"\") +\n+            HelpExampleRpc(\"submitheader\", \"\\\"aabbcc\\\"\"));\n+    }\n+\n+    CBlockHeader h;\n+    if (!DecodeHexBlockHeader(h, request.params[0].get_str())) {\n+        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"Block header decode failed\");\n+    }\n+    {\n+        LOCK(cs_main);\n+        if (LookupBlockIndex(h.GetHash())) return NullUniValue;\n+        if (!LookupBlockIndex(h.hashPrevBlock)) {\n+            throw JSONRPCError(RPC_VERIFY_ERROR, \"Must submit previous header (\" + h.hashPrevBlock.GetHex() + \") first\");\n+        }\n+    }\n+\n+    CValidationState state;\n+    ProcessNewBlockHeaders({h}, state, Params(), /* ppindex */ nullptr, /* first_invalid */ nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13399#discussion_r194332068",
      "id" : 194332068,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE5NDMzMjA2OA==",
      "original_commit_id" : "2595028d97fc08ea0d27c3133c44d63f3e8bbc0f",
      "original_position" : 81,
      "path" : "src/rpc/mining.cpp",
      "position" : 48,
      "pull_request_review_id" : 127478873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13399",
      "updated_at" : "2018-07-11T15:57:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/194332068",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13399#discussion_r194429120"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13399"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/194429120"
         }
      },
      "author_association" : "MEMBER",
      "body" : "supernit: you remove this text in commit _doc: Rewrite some validation doc to be machine-readable_, and then remove the lines in commit _rpc: Expose ProcessNewBlockHeaders_. Just remove the lines in the first commit.\r\n\r\nSame for `ProcessNewBlockHeaders` comment below.",
      "commit_id" : "fa7d7dd34cbd180ec9587c640078dfb7bf2ead04",
      "created_at" : "2018-06-11T14:42:15Z",
      "diff_hunk" : "@@ -232,28 +232,24 @@ static const uint64_t MIN_DISK_SPACE_FOR_BLOCK_FILES = 550 * 1024 * 1024;\n  *\n  * Note that we guarantee that either the proof-of-work is valid on pblock, or\n  * (and possibly also) BlockChecked will have been called.\n- * ",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13399#discussion_r194429120",
      "id" : 194429120,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE5NDQyOTEyMA==",
      "original_commit_id" : "2595028d97fc08ea0d27c3133c44d63f3e8bbc0f",
      "original_position" : 4,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 127599009,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13399",
      "updated_at" : "2018-07-11T15:57:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/194429120",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13399#discussion_r194429410"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13399"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/194429410"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can just use:\r\n\r\n```python\r\nfrom test_framework.util import (\r\n    assert_equal,\r\n    assert_raises_rpc_error,\r\n    bytes_to_hex_str as b2x,\r\n+)\r\n```",
      "commit_id" : "fa7d7dd34cbd180ec9587c640078dfb7bf2ead04",
      "created_at" : "2018-06-11T14:43:00Z",
      "diff_hunk" : "@@ -9,16 +9,26 @@\n - submitblock\"\"\"\n \n import copy\n-from binascii import b2a_hex\n from decimal import Decimal\n \n from test_framework.blocktools import create_coinbase\n-from test_framework.mininode import CBlock\n+from test_framework.messages import (\n+    CBlock,\n+    CBlockHeader,\n+)\n+from test_framework.mininode import (\n+    P2PDataStore,\n+    network_thread_start,\n+)\n from test_framework.test_framework import BitcoinTestFramework\n-from test_framework.util import assert_equal, assert_raises_rpc_error\n+from test_framework.util import (\n+    assert_equal,\n+    assert_raises_rpc_error,\n+    bytes_to_hex_str,\n+)\n+\n+b2x = bytes_to_hex_str",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13399#discussion_r194429410",
      "id" : 194429410,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE5NDQyOTQxMA==",
      "original_commit_id" : "2595028d97fc08ea0d27c3133c44d63f3e8bbc0f",
      "original_position" : 25,
      "path" : "test/functional/mining_basic.py",
      "position" : null,
      "pull_request_review_id" : 127599009,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13399",
      "updated_at" : "2018-07-11T15:57:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/194429410",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13399#discussion_r194433216"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13399"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/194433216"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Normal way we do this is:\r\n\r\n```python\r\n        assert_raises_rpc_error(-25, 'bad-prevblk', node.submitheader, b2x(CBlockHeader(bad_block2).serialize()))\r\n```\r\n\r\nAny reason you've chosen to use a lambda?",
      "commit_id" : "fa7d7dd34cbd180ec9587c640078dfb7bf2ead04",
      "created_at" : "2018-06-11T14:53:15Z",
      "diff_hunk" : "@@ -131,5 +141,61 @@ def run_test(self):\n         bad_block.hashPrevBlock = 123\n         assert_template(node, bad_block, 'inconclusive-not-best-prevblk')\n \n+        self.log.info('submitheader tests')\n+        assert_raises_rpc_error(-22, 'Block header decode failed', lambda: node.submitheader(hexdata='xx' * 80))\n+        assert_raises_rpc_error(-22, 'Block header decode failed', lambda: node.submitheader(hexdata='ff' * 78))\n+        assert_raises_rpc_error(-25, 'Must submit previous header', lambda: node.submitheader(hexdata='ff' * 80))\n+\n+        block.solve()\n+\n+        def chain_tip(b_hash, *, status='headers-only', branchlen=1):\n+            return {'hash': b_hash, 'height': 202, 'branchlen': branchlen, 'status': status}\n+\n+        assert chain_tip(block.hash) not in node.getchaintips()\n+        node.submitheader(hexdata=b2x(block.serialize()))\n+        assert chain_tip(block.hash) in node.getchaintips()\n+        node.submitheader(hexdata=b2x(CBlockHeader(block).serialize()))  # Noop\n+        assert chain_tip(block.hash) in node.getchaintips()\n+\n+        bad_block = copy.deepcopy(block)\n+        bad_block.hashMerkleRoot += 2\n+        bad_block.solve()\n+        assert chain_tip(bad_block.hash) not in node.getchaintips()\n+        node.submitheader(hexdata=b2x(CBlockHeader(bad_block).serialize()))\n+        assert chain_tip(bad_block.hash) in node.getchaintips()\n+        # Should still reject invalid blocks, even if we have the header:\n+        assert_equal(node.submitblock(hexdata=b2x(bad_block.serialize())), 'bad-txnmrklroot')\n+        assert chain_tip(bad_block.hash) in node.getchaintips()\n+        # We know the header for this invalid block, so should just return early without error:\n+        node.submitheader(hexdata=b2x(CBlockHeader(bad_block).serialize()))\n+        assert chain_tip(bad_block.hash) in node.getchaintips()\n+\n+        bad_block = copy.deepcopy(block)\n+        bad_block.vtx[0].nLockTime = 2**32 - 1\n+        bad_block.vtx[0].rehash()\n+        bad_block.hashMerkleRoot = bad_block.calc_merkle_root()\n+        bad_block.solve()\n+        assert_equal(node.submitblock(hexdata=b2x(bad_block.serialize())), 'bad-txns-nonfinal')\n+        # Build a \"good\" block on top of the submitted bad block\n+        bad_block2 = copy.deepcopy(block)\n+        bad_block2.hashPrevBlock = bad_block.sha256\n+        bad_block2.solve()\n+        assert_raises_rpc_error(-25, 'bad-prevblk', lambda: node.submitheader(hexdata=b2x(CBlockHeader(bad_block2).serialize())))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13399#discussion_r194433216",
      "id" : 194433216,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE5NDQzMzIxNg==",
      "original_commit_id" : "2595028d97fc08ea0d27c3133c44d63f3e8bbc0f",
      "original_position" : 75,
      "path" : "test/functional/mining_basic.py",
      "position" : null,
      "pull_request_review_id" : 127599009,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13399",
      "updated_at" : "2018-07-11T15:57:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/194433216",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13399#discussion_r194442961"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13399"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/194442961"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think it'd be slightly nicer to have a return value passed to the user, if only to differentiate between whether the header was already in the block index or if it newly added to the block index.",
      "commit_id" : "fa7d7dd34cbd180ec9587c640078dfb7bf2ead04",
      "created_at" : "2018-06-11T15:19:02Z",
      "diff_hunk" : "@@ -751,20 +748,51 @@ static UniValue submitblock(const JSONRPCRequest& request)\n \n     submitblock_StateCatcher sc(block.GetHash());\n     RegisterValidationInterface(&sc);\n-    bool fAccepted = ProcessNewBlock(Params(), blockptr, true, nullptr);\n+    ProcessNewBlock(Params(), blockptr, true, nullptr);\n     UnregisterValidationInterface(&sc);\n-    if (fBlockPresent) {\n-        if (fAccepted && !sc.found) {\n-            return \"duplicate-inconclusive\";\n-        }\n-        return \"duplicate\";\n-    }\n     if (!sc.found) {\n         return \"inconclusive\";\n     }\n     return BIP22ValidationResult(sc.state);\n }\n \n+static UniValue submitheader(const JSONRPCRequest& request)\n+{\n+    if (request.fHelp || request.params.size() != 1) {\n+        throw std::runtime_error(\n+            \"submitheader \\\"hexdata\\\"\\n\"\n+            \"\\nDecode the given hexdata as a header and submit it as a candidate chain tip if valid.\"\n+            \"\\nThrows when the header is invalid.\\n\"\n+            \"\\nArguments\\n\"\n+            \"1. \\\"hexdata\\\"        (string, required) the hex-encoded block header data\\n\"\n+            \"\\nResult:\\n\"\n+            \"None\"\n+            \"\\nExamples:\\n\" +\n+            HelpExampleCli(\"submitheader\", \"\\\"aabbcc\\\"\") +\n+            HelpExampleRpc(\"submitheader\", \"\\\"aabbcc\\\"\"));\n+    }\n+\n+    CBlockHeader h;\n+    if (!DecodeHexBlockHeader(h, request.params[0].get_str())) {\n+        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"Block header decode failed\");\n+    }\n+    {\n+        LOCK(cs_main);\n+        if (LookupBlockIndex(h.GetHash())) return NullUniValue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13399#discussion_r194442961",
      "id" : 194442961,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE5NDQ0Mjk2MQ==",
      "original_commit_id" : "2595028d97fc08ea0d27c3133c44d63f3e8bbc0f",
      "original_position" : 74,
      "path" : "src/rpc/mining.cpp",
      "position" : null,
      "pull_request_review_id" : 127599009,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13399",
      "updated_at" : "2018-07-11T15:57:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/194442961",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13399#discussion_r194446317"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13399"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/194446317"
         }
      },
      "author_association" : "MEMBER",
      "body" : "perhaps test submitting a block header that isn't the most-work tip (ie a fork from some earlier block)",
      "commit_id" : "fa7d7dd34cbd180ec9587c640078dfb7bf2ead04",
      "created_at" : "2018-06-11T15:28:34Z",
      "diff_hunk" : "@@ -131,5 +141,61 @@ def run_test(self):\n         bad_block.hashPrevBlock = 123\n         assert_template(node, bad_block, 'inconclusive-not-best-prevblk')\n \n+        self.log.info('submitheader tests')\n+        assert_raises_rpc_error(-22, 'Block header decode failed', lambda: node.submitheader(hexdata='xx' * 80))\n+        assert_raises_rpc_error(-22, 'Block header decode failed', lambda: node.submitheader(hexdata='ff' * 78))\n+        assert_raises_rpc_error(-25, 'Must submit previous header', lambda: node.submitheader(hexdata='ff' * 80))\n+\n+        block.solve()\n+\n+        def chain_tip(b_hash, *, status='headers-only', branchlen=1):\n+            return {'hash': b_hash, 'height': 202, 'branchlen': branchlen, 'status': status}\n+\n+        assert chain_tip(block.hash) not in node.getchaintips()\n+        node.submitheader(hexdata=b2x(block.serialize()))\n+        assert chain_tip(block.hash) in node.getchaintips()\n+        node.submitheader(hexdata=b2x(CBlockHeader(block).serialize()))  # Noop\n+        assert chain_tip(block.hash) in node.getchaintips()\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13399#discussion_r194446317",
      "id" : 194446317,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE5NDQ0NjMxNw==",
      "original_commit_id" : "2595028d97fc08ea0d27c3133c44d63f3e8bbc0f",
      "original_position" : 51,
      "path" : "test/functional/mining_basic.py",
      "position" : 48,
      "pull_request_review_id" : 127599009,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13399",
      "updated_at" : "2018-07-11T15:57:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/194446317",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13399#discussion_r194451644"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13399"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/194451644"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I prefer to use named arguments",
      "commit_id" : "fa7d7dd34cbd180ec9587c640078dfb7bf2ead04",
      "created_at" : "2018-06-11T15:43:44Z",
      "diff_hunk" : "@@ -131,5 +141,61 @@ def run_test(self):\n         bad_block.hashPrevBlock = 123\n         assert_template(node, bad_block, 'inconclusive-not-best-prevblk')\n \n+        self.log.info('submitheader tests')\n+        assert_raises_rpc_error(-22, 'Block header decode failed', lambda: node.submitheader(hexdata='xx' * 80))\n+        assert_raises_rpc_error(-22, 'Block header decode failed', lambda: node.submitheader(hexdata='ff' * 78))\n+        assert_raises_rpc_error(-25, 'Must submit previous header', lambda: node.submitheader(hexdata='ff' * 80))\n+\n+        block.solve()\n+\n+        def chain_tip(b_hash, *, status='headers-only', branchlen=1):\n+            return {'hash': b_hash, 'height': 202, 'branchlen': branchlen, 'status': status}\n+\n+        assert chain_tip(block.hash) not in node.getchaintips()\n+        node.submitheader(hexdata=b2x(block.serialize()))\n+        assert chain_tip(block.hash) in node.getchaintips()\n+        node.submitheader(hexdata=b2x(CBlockHeader(block).serialize()))  # Noop\n+        assert chain_tip(block.hash) in node.getchaintips()\n+\n+        bad_block = copy.deepcopy(block)\n+        bad_block.hashMerkleRoot += 2\n+        bad_block.solve()\n+        assert chain_tip(bad_block.hash) not in node.getchaintips()\n+        node.submitheader(hexdata=b2x(CBlockHeader(bad_block).serialize()))\n+        assert chain_tip(bad_block.hash) in node.getchaintips()\n+        # Should still reject invalid blocks, even if we have the header:\n+        assert_equal(node.submitblock(hexdata=b2x(bad_block.serialize())), 'bad-txnmrklroot')\n+        assert chain_tip(bad_block.hash) in node.getchaintips()\n+        # We know the header for this invalid block, so should just return early without error:\n+        node.submitheader(hexdata=b2x(CBlockHeader(bad_block).serialize()))\n+        assert chain_tip(bad_block.hash) in node.getchaintips()\n+\n+        bad_block = copy.deepcopy(block)\n+        bad_block.vtx[0].nLockTime = 2**32 - 1\n+        bad_block.vtx[0].rehash()\n+        bad_block.hashMerkleRoot = bad_block.calc_merkle_root()\n+        bad_block.solve()\n+        assert_equal(node.submitblock(hexdata=b2x(bad_block.serialize())), 'bad-txns-nonfinal')\n+        # Build a \"good\" block on top of the submitted bad block\n+        bad_block2 = copy.deepcopy(block)\n+        bad_block2.hashPrevBlock = bad_block.sha256\n+        bad_block2.solve()\n+        assert_raises_rpc_error(-25, 'bad-prevblk', lambda: node.submitheader(hexdata=b2x(CBlockHeader(bad_block2).serialize())))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13399#discussion_r194451644",
      "id" : 194451644,
      "in_reply_to_id" : 194433216,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE5NDQ1MTY0NA==",
      "original_commit_id" : "2595028d97fc08ea0d27c3133c44d63f3e8bbc0f",
      "original_position" : 75,
      "path" : "test/functional/mining_basic.py",
      "position" : null,
      "pull_request_review_id" : 127626362,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13399",
      "updated_at" : "2018-07-11T15:57:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/194451644",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13399#discussion_r194454637"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13399"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/194454637"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This should work:\r\n```python\r\nassert_raises_rpc_error(-25, 'bad-prevblk', node.submitheader, hexdata=b2x(CBlockHeader(bad_block2).serialize()))\r\n```\r\n",
      "commit_id" : "fa7d7dd34cbd180ec9587c640078dfb7bf2ead04",
      "created_at" : "2018-06-11T15:52:32Z",
      "diff_hunk" : "@@ -131,5 +141,61 @@ def run_test(self):\n         bad_block.hashPrevBlock = 123\n         assert_template(node, bad_block, 'inconclusive-not-best-prevblk')\n \n+        self.log.info('submitheader tests')\n+        assert_raises_rpc_error(-22, 'Block header decode failed', lambda: node.submitheader(hexdata='xx' * 80))\n+        assert_raises_rpc_error(-22, 'Block header decode failed', lambda: node.submitheader(hexdata='ff' * 78))\n+        assert_raises_rpc_error(-25, 'Must submit previous header', lambda: node.submitheader(hexdata='ff' * 80))\n+\n+        block.solve()\n+\n+        def chain_tip(b_hash, *, status='headers-only', branchlen=1):\n+            return {'hash': b_hash, 'height': 202, 'branchlen': branchlen, 'status': status}\n+\n+        assert chain_tip(block.hash) not in node.getchaintips()\n+        node.submitheader(hexdata=b2x(block.serialize()))\n+        assert chain_tip(block.hash) in node.getchaintips()\n+        node.submitheader(hexdata=b2x(CBlockHeader(block).serialize()))  # Noop\n+        assert chain_tip(block.hash) in node.getchaintips()\n+\n+        bad_block = copy.deepcopy(block)\n+        bad_block.hashMerkleRoot += 2\n+        bad_block.solve()\n+        assert chain_tip(bad_block.hash) not in node.getchaintips()\n+        node.submitheader(hexdata=b2x(CBlockHeader(bad_block).serialize()))\n+        assert chain_tip(bad_block.hash) in node.getchaintips()\n+        # Should still reject invalid blocks, even if we have the header:\n+        assert_equal(node.submitblock(hexdata=b2x(bad_block.serialize())), 'bad-txnmrklroot')\n+        assert chain_tip(bad_block.hash) in node.getchaintips()\n+        # We know the header for this invalid block, so should just return early without error:\n+        node.submitheader(hexdata=b2x(CBlockHeader(bad_block).serialize()))\n+        assert chain_tip(bad_block.hash) in node.getchaintips()\n+\n+        bad_block = copy.deepcopy(block)\n+        bad_block.vtx[0].nLockTime = 2**32 - 1\n+        bad_block.vtx[0].rehash()\n+        bad_block.hashMerkleRoot = bad_block.calc_merkle_root()\n+        bad_block.solve()\n+        assert_equal(node.submitblock(hexdata=b2x(bad_block.serialize())), 'bad-txns-nonfinal')\n+        # Build a \"good\" block on top of the submitted bad block\n+        bad_block2 = copy.deepcopy(block)\n+        bad_block2.hashPrevBlock = bad_block.sha256\n+        bad_block2.solve()\n+        assert_raises_rpc_error(-25, 'bad-prevblk', lambda: node.submitheader(hexdata=b2x(CBlockHeader(bad_block2).serialize())))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13399#discussion_r194454637",
      "id" : 194454637,
      "in_reply_to_id" : 194433216,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE5NDQ1NDYzNw==",
      "original_commit_id" : "2595028d97fc08ea0d27c3133c44d63f3e8bbc0f",
      "original_position" : 75,
      "path" : "test/functional/mining_basic.py",
      "position" : null,
      "pull_request_review_id" : 127630048,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13399",
      "updated_at" : "2018-07-11T15:57:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/194454637",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13399#discussion_r194455315"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13399"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/194455315"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@jnewbery do you see a use case for that?",
      "commit_id" : "fa7d7dd34cbd180ec9587c640078dfb7bf2ead04",
      "created_at" : "2018-06-11T15:54:47Z",
      "diff_hunk" : "@@ -751,20 +748,51 @@ static UniValue submitblock(const JSONRPCRequest& request)\n \n     submitblock_StateCatcher sc(block.GetHash());\n     RegisterValidationInterface(&sc);\n-    bool fAccepted = ProcessNewBlock(Params(), blockptr, true, nullptr);\n+    ProcessNewBlock(Params(), blockptr, true, nullptr);\n     UnregisterValidationInterface(&sc);\n-    if (fBlockPresent) {\n-        if (fAccepted && !sc.found) {\n-            return \"duplicate-inconclusive\";\n-        }\n-        return \"duplicate\";\n-    }\n     if (!sc.found) {\n         return \"inconclusive\";\n     }\n     return BIP22ValidationResult(sc.state);\n }\n \n+static UniValue submitheader(const JSONRPCRequest& request)\n+{\n+    if (request.fHelp || request.params.size() != 1) {\n+        throw std::runtime_error(\n+            \"submitheader \\\"hexdata\\\"\\n\"\n+            \"\\nDecode the given hexdata as a header and submit it as a candidate chain tip if valid.\"\n+            \"\\nThrows when the header is invalid.\\n\"\n+            \"\\nArguments\\n\"\n+            \"1. \\\"hexdata\\\"        (string, required) the hex-encoded block header data\\n\"\n+            \"\\nResult:\\n\"\n+            \"None\"\n+            \"\\nExamples:\\n\" +\n+            HelpExampleCli(\"submitheader\", \"\\\"aabbcc\\\"\") +\n+            HelpExampleRpc(\"submitheader\", \"\\\"aabbcc\\\"\"));\n+    }\n+\n+    CBlockHeader h;\n+    if (!DecodeHexBlockHeader(h, request.params[0].get_str())) {\n+        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"Block header decode failed\");\n+    }\n+    {\n+        LOCK(cs_main);\n+        if (LookupBlockIndex(h.GetHash())) return NullUniValue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13399#discussion_r194455315",
      "id" : 194455315,
      "in_reply_to_id" : 194442961,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE5NDQ1NTMxNQ==",
      "original_commit_id" : "2595028d97fc08ea0d27c3133c44d63f3e8bbc0f",
      "original_position" : 74,
      "path" : "src/rpc/mining.cpp",
      "position" : null,
      "pull_request_review_id" : 127630941,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13399",
      "updated_at" : "2018-07-11T15:57:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/194455315",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2018-06-15T20:08:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13399#issuecomment-397728858",
      "id" : 397728858,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13399",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDM5NzcyODg1OA==",
      "updated_at" : "2018-06-15T20:08:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/397728858",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "#13439 has been merged. Is this PR ready for rebase and rereview?",
      "created_at" : "2018-06-20T16:31:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13399#issuecomment-398813907",
      "id" : 398813907,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13399",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDM5ODgxMzkwNw==",
      "updated_at" : "2018-06-20T16:31:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/398813907",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2018-07-07T08:37:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13399#issuecomment-403199164",
      "id" : 403199164,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13399",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQwMzE5OTE2NA==",
      "updated_at" : "2018-07-07T08:37:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/403199164",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13399#discussion_r201732451"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13399"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/201732451"
         }
      },
      "author_association" : "MEMBER",
      "body" : "See the docstring above: The result is always `None` and not the return value of PNBH",
      "commit_id" : "fa7d7dd34cbd180ec9587c640078dfb7bf2ead04",
      "created_at" : "2018-07-11T15:20:45Z",
      "diff_hunk" : "@@ -751,20 +748,51 @@ static UniValue submitblock(const JSONRPCRequest& request)\n \n     submitblock_StateCatcher sc(block.GetHash());\n     RegisterValidationInterface(&sc);\n-    bool fAccepted = ProcessNewBlock(Params(), blockptr, true, nullptr);\n+    ProcessNewBlock(Params(), blockptr, true, nullptr);\n     UnregisterValidationInterface(&sc);\n-    if (fBlockPresent) {\n-        if (fAccepted && !sc.found) {\n-            return \"duplicate-inconclusive\";\n-        }\n-        return \"duplicate\";\n-    }\n     if (!sc.found) {\n         return \"inconclusive\";\n     }\n     return BIP22ValidationResult(sc.state);\n }\n \n+static UniValue submitheader(const JSONRPCRequest& request)\n+{\n+    if (request.fHelp || request.params.size() != 1) {\n+        throw std::runtime_error(\n+            \"submitheader \\\"hexdata\\\"\\n\"\n+            \"\\nDecode the given hexdata as a header and submit it as a candidate chain tip if valid.\"\n+            \"\\nThrows when the header is invalid.\\n\"\n+            \"\\nArguments\\n\"\n+            \"1. \\\"hexdata\\\"        (string, required) the hex-encoded block header data\\n\"\n+            \"\\nResult:\\n\"\n+            \"None\"\n+            \"\\nExamples:\\n\" +\n+            HelpExampleCli(\"submitheader\", \"\\\"aabbcc\\\"\") +\n+            HelpExampleRpc(\"submitheader\", \"\\\"aabbcc\\\"\"));\n+    }\n+\n+    CBlockHeader h;\n+    if (!DecodeHexBlockHeader(h, request.params[0].get_str())) {\n+        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"Block header decode failed\");\n+    }\n+    {\n+        LOCK(cs_main);\n+        if (LookupBlockIndex(h.GetHash())) return NullUniValue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13399#discussion_r201732451",
      "id" : 201732451,
      "in_reply_to_id" : 194331921,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIwMTczMjQ1MQ==",
      "original_commit_id" : "2595028d97fc08ea0d27c3133c44d63f3e8bbc0f",
      "original_position" : 74,
      "path" : "src/rpc/mining.cpp",
      "position" : null,
      "pull_request_review_id" : 136291743,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13399",
      "updated_at" : "2018-07-11T15:57:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/201732451",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13399#discussion_r201735402"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13399"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/201735402"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That race shouldn't affect the return value.",
      "commit_id" : "fa7d7dd34cbd180ec9587c640078dfb7bf2ead04",
      "created_at" : "2018-07-11T15:27:16Z",
      "diff_hunk" : "@@ -751,20 +748,51 @@ static UniValue submitblock(const JSONRPCRequest& request)\n \n     submitblock_StateCatcher sc(block.GetHash());\n     RegisterValidationInterface(&sc);\n-    bool fAccepted = ProcessNewBlock(Params(), blockptr, true, nullptr);\n+    ProcessNewBlock(Params(), blockptr, true, nullptr);\n     UnregisterValidationInterface(&sc);\n-    if (fBlockPresent) {\n-        if (fAccepted && !sc.found) {\n-            return \"duplicate-inconclusive\";\n-        }\n-        return \"duplicate\";\n-    }\n     if (!sc.found) {\n         return \"inconclusive\";\n     }\n     return BIP22ValidationResult(sc.state);\n }\n \n+static UniValue submitheader(const JSONRPCRequest& request)\n+{\n+    if (request.fHelp || request.params.size() != 1) {\n+        throw std::runtime_error(\n+            \"submitheader \\\"hexdata\\\"\\n\"\n+            \"\\nDecode the given hexdata as a header and submit it as a candidate chain tip if valid.\"\n+            \"\\nThrows when the header is invalid.\\n\"\n+            \"\\nArguments\\n\"\n+            \"1. \\\"hexdata\\\"        (string, required) the hex-encoded block header data\\n\"\n+            \"\\nResult:\\n\"\n+            \"None\"\n+            \"\\nExamples:\\n\" +\n+            HelpExampleCli(\"submitheader\", \"\\\"aabbcc\\\"\") +\n+            HelpExampleRpc(\"submitheader\", \"\\\"aabbcc\\\"\"));\n+    }\n+\n+    CBlockHeader h;\n+    if (!DecodeHexBlockHeader(h, request.params[0].get_str())) {\n+        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"Block header decode failed\");\n+    }\n+    {\n+        LOCK(cs_main);\n+        if (LookupBlockIndex(h.GetHash())) return NullUniValue;\n+        if (!LookupBlockIndex(h.hashPrevBlock)) {\n+            throw JSONRPCError(RPC_VERIFY_ERROR, \"Must submit previous header (\" + h.hashPrevBlock.GetHex() + \") first\");\n+        }\n+    }\n+\n+    CValidationState state;\n+    ProcessNewBlockHeaders({h}, state, Params(), /* ppindex */ nullptr, /* first_invalid */ nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13399#discussion_r201735402",
      "id" : 201735402,
      "in_reply_to_id" : 194332068,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIwMTczNTQwMg==",
      "original_commit_id" : "2595028d97fc08ea0d27c3133c44d63f3e8bbc0f",
      "original_position" : 81,
      "path" : "src/rpc/mining.cpp",
      "position" : 48,
      "pull_request_review_id" : 136295134,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13399",
      "updated_at" : "2018-07-11T15:57:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/201735402",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13399#discussion_r201748049"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13399"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/201748049"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done at the end of this function",
      "commit_id" : "fa7d7dd34cbd180ec9587c640078dfb7bf2ead04",
      "created_at" : "2018-07-11T15:56:45Z",
      "diff_hunk" : "@@ -131,5 +141,61 @@ def run_test(self):\n         bad_block.hashPrevBlock = 123\n         assert_template(node, bad_block, 'inconclusive-not-best-prevblk')\n \n+        self.log.info('submitheader tests')\n+        assert_raises_rpc_error(-22, 'Block header decode failed', lambda: node.submitheader(hexdata='xx' * 80))\n+        assert_raises_rpc_error(-22, 'Block header decode failed', lambda: node.submitheader(hexdata='ff' * 78))\n+        assert_raises_rpc_error(-25, 'Must submit previous header', lambda: node.submitheader(hexdata='ff' * 80))\n+\n+        block.solve()\n+\n+        def chain_tip(b_hash, *, status='headers-only', branchlen=1):\n+            return {'hash': b_hash, 'height': 202, 'branchlen': branchlen, 'status': status}\n+\n+        assert chain_tip(block.hash) not in node.getchaintips()\n+        node.submitheader(hexdata=b2x(block.serialize()))\n+        assert chain_tip(block.hash) in node.getchaintips()\n+        node.submitheader(hexdata=b2x(CBlockHeader(block).serialize()))  # Noop\n+        assert chain_tip(block.hash) in node.getchaintips()\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13399#discussion_r201748049",
      "id" : 201748049,
      "in_reply_to_id" : 194446317,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIwMTc0ODA0OQ==",
      "original_commit_id" : "2595028d97fc08ea0d27c3133c44d63f3e8bbc0f",
      "original_position" : 51,
      "path" : "test/functional/mining_basic.py",
      "position" : 48,
      "pull_request_review_id" : 136309759,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13399",
      "updated_at" : "2018-07-11T15:57:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/201748049",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK fa7d7dd34cbd180ec9587c640078dfb7bf2ead04.\r\n\r\nHaving this functionality can't hurt, as it available with identical semantics via P2P anyway.\r\n\r\nI have no opinion about the test code style.",
      "created_at" : "2018-07-13T22:12:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13399#issuecomment-404966770",
      "id" : 404966770,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13399",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQwNDk2Njc3MA==",
      "updated_at" : "2018-07-13T22:12:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/404966770",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   }
]
